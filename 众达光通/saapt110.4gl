# Prog. Version..: '5.10.27-12.09.05(00000)'     #

# Descriptions...: 帳款維護
# Date & Author..: 92/11/25 By Roger
# Memo...........: 開窗輸入多發票時,稅額可為零& 須update 單頭原幣金額
#                  1.確認還原增加判斷付款方式 2.差異處理之4.將單頭金額分攤至單身公式修改
#                  出現分錄已產生之問句,未判斷是新增或修改之狀況
#                  輸入多發票後未update apa31f,apa32f,apa34f,aapt110_d.per增加問句,問是否update
#                  輸入多發票後,如稅額為0,無法跳出
#                  1.差異調整本幣合計金額未設小數位數  2.V.分錄產生增加判斷折讓性質為1者不產生
#                  預付產生待抵改為在確認時產生,取消確認時刪除
#                  產生分錄改在確認產生,取消確認刪除,差異處理為'1'者,不產生分錄
#                  幣別未default廠商,人員輸入default部門,輸入後更改會有錯誤
#                  預付更改或刪除時不須判斷待抵是否存在, 2.單身輸完後不update單頭金額
# Modify.........: 97/03/12 By Danny 1.取消確認時, 判斷若有折讓單, 則將折讓單刪除, 並將apa59更新為null
# Modify.........: 97/05/08 By Danny 1.判斷立帳日期不可小於關帳日期
#                                    2.確認, 取消確認時立帳日期不可小於關帳日期
#                                    3.推算付款日時, 須考慮結帳日
# Modify.........: 00/02/17 By Carol 單頭add專案代號輸入,專案代號有輸入時,單身apb21須輸入費用代號
# Modify.........: 01/05/15 By plum  立暫估由aapp115(apa08='UNAP',零稅率不申報)
#                                    產生,不允許手動輸入
# Modify.........: No.5954 02/10/01 By Kammy 多發票檔增加"稅別"、"幣別"、
#                                            "原幣未稅"、"原幣稅額"、"原幣總額"
#                                            等欄位。(稅率記錄在apk29欄位)
# Modify.........: No.7875 03/08/21 By Kammy 呼叫自動取單號時應在 Transction中
# Modify.........: No.8014 03/09/02 By Wiky  t110_compute_apa33設的變數寫死為dec(12,0),故後面取位也無效
# Modify.........: No.8150 03/09/09 Kammy 1.add apa99 多角序號
#                                         2.若多角序號not null則不可取消確認
# Modify.........: No.8394 03/10/01 Kitty t110_apz08修改稅額未出現問題
# Modify.........: No.8511 03/10/20 Kitty t110_ddd apk03若為NULL則存入空白
# Modify.........: No.8593 03/10/30 Kitty t110_ddd 小窗的稅額要先顯示
# Modify.......... No.8620 03/10/31 Kitty t110_aph_upd 與oob_file的串連改為判斷aph03='0'
# Modify.........: No.8625 03/11/03 Kitty 連續display二個apa32,一個改為31
# Modify.........: No.8654 03/11/05 Kitty 多發票畫面的發票日期應要先輸入否則check
#                                         發票字軌會無日期可判斷
# Modify.........: No.8901 03/12/16 ching apz07='Y'時,apa08 key 'AAA'時系統未檢查
# Modify.........: No.A105 04/01/12 Danny 修改大陸版運輸發票的算法
# Modify.........: No.9383 04/03/31 kitty 增加判斷t110_show_ref若aapt210本身
#                                         沒有拋轉傳票才 show aapt330所拋的傳票
# Modify.........: No.9599 04/05/28 kitty t110_ddd加LET INT_FLAG=0,相關INT_FL
# Modify.......... No.9615 04/06/02 kitty INSERT nme_file時，將nme14現金變動
# Modify.......... No.9695 04/06/29 Kitty t110_aph_upd UPDATE apa_file WHERE條件錯誤
# Modify.........: No.9770 04/07/19 Nicola aapt120寫入一筆帳款編號空白之資料
# Modify.........: No:MOD-470041 04/07/16 Nicola 修改INSERT INTO 語法
# Modify.........: No.MOD-480131 Kitty run完沖暫估時出現-255 open t110_cl
# Modify.........: No.MOD-480387 Kammy aapt210在補單身發票時，資料未回寫 apk
# Modify.........: No.MOD-480441 Kammy 多發票時，廠商統一編號須控管要輸入
# Modify.........: No.MOD-480608 04/09/02 ching 按 "留置" 按放棄無法離開
# Modify.........: No.MOD-490018 04/09/03 ching apz59='N'僅DISPLAY單身
# Modify.........: No.MOD-490217 04/09/10 yiting 料件欄位放大
# Modify.........: No:MOD-490344 04/09/21 By Kitty Controlp 未加display
# Modify.........: No:MOD-440608 04/09/24 ching 不限制在其欄位始可action
# Modify.........: No:MOD-4A0193 04/10/14 ching 稅額欄位輸入修改
# Modify.........: No:MOD-4A0253 04/10/19 echo 新增簽核流程
# Modify.........: No:MOD-490323 04/10/21 ching 詢問異動金額修改
# Modify.........: No:MOD-4A0288 04/10/21 ching 沖帳功能錯誤修改
# Modify.........: No:MOD-4B0002 04/11/01 echo  單據無法確認,出現無單身資料無法確認
# Modify.........: No:MOD-4B0015 04/11/01 By kitty 12及15的單子無法存入單身
# Modify.........: No:FUN-4B0009 04/11/02 By ching add '轉Excel檔' action
# Modify.........: No:MOD-4B0124 04/11/12 By ching t110_apa05檢查修改
# Modify.........: No:FUN-4B0054 04/11/23 By ching add 匯率開窗 call s_rate
# Modify.........: No:MOD-4B0243 04/11/24 By ching 多發票INPUT修改
# Modify.........: No:MOD-4B0269 04/11/26 By ching apz13='Y' 科目預設
# Modify.........: No:MOD-4B0277 04/11/30 By echo 在確認時程式會檢查無單身不能確認,但是雜項請款本來就允許可以無單身
# Modify.........: No:MOD-4B0308 04/11/30 By ching apa58='3' ins apk
# Modify ........: No.FUN-4B0079 04/11/30 By ching 單價,金額改成 DEC(20,6)
# Modify ........: No.FUN-4C0008 04/12/01 By kitty firm1UPDATEapa73的apa35加上()
# Modify.........: No:FUN-4C0047 04/12/08 By Nicola 權限控管修改
# Modify.........: No:MOD-4C0041 04/12/14 By Echo  查看"簽核狀況"的button
# Modify.........: No:MOD-4C0093 04/12/16 By Nicola apk06f,apk07f,apk08f update時漏掉
# Modify.........: No:FUN-4C0073 04/12/17 By pengu  匯率幣別欄位修改，與aoos010的aza17做判斷，
#                                                   如果二個幣別相同時，匯率強制為 1
# Modify.........: No:MOD-4C0113 04/12/17 By Nicola aapt210,aapt220 列印串aapr129
# Modify.........: No:FUN-4C0091 04/12/27 By Kitty apa17,apk17,扣抵區分增加可輸入3,4
# Modify.........: No:MOD-510014 05/01/07 By Kitty 控制這些欄位可不可以輸入是參考apz16(進貨發票請款時可否修改進貨單價),22的應該不用參考
# Modify.........: No:MOD-510036 05/01/14 By Kitty 判斷發票長度時先看是否為2聯或3聯發票(用gec05判斷)
# Modify.........: No:MOD-510035 05/01/14 By Kitty 多借方的部門要配合科目決定是否要entry
# Modify.........: No.MOD-4C0154 05/01/17 By Kitty 在aapt210修改單頭匯率,金額未更新發票金額apk_file
# Modify.........: No:MOD-510106 05/01/18 By Kitty FUNCTION t110_sum_apa 未判斷幣別的小數位數(本幣稅額)
# Modify.........: No:MOD-510148 05/01/24 By Kitty FUNCTION t110_k多一個g_success='Y'
# Modify.........: No:MOD-510184 05/02/01 By Kitty 如果直接付款, 選擇[6,7,8,9]完全沒有回寫原本待抵已付金額
# Modify.........: No:MOD-510180 05/02/02 By Kitty t110_apa17增加判斷apa41='Y'才可Input 否則只能 display
# Modify.........: No:MOD-510140 05/03/01 By Kitty check折讓與發票的部份修改
# Modify.........: No:FUN-530015 05/03/15 By Nicola 匯率自由格式設定
# Modify.........: No:MOD-530274 05/03/25 By Nicola 1.付款方式上方有一欄位無欄位名稱
#                                                   2.單身科目沒有做部門拒絕/接受檢查
#                                                   3.單頭科目沒有做部門拒絕/接受檢查
#                                                   4.單身金額與單頭有差異時,出現差異處理視窗,選:繼續處理單身,但系統沒有處理
#                                                   6.稅額輸入值和系統計算值不合時,欄位應停留在稅額欄位
#                                                   7.有稅率時,其稅額科目應要必須輸入
#                                                   8.匯率,原幣,本幣金額依幣別沒有做小數取位
# Modify.........: No.MOD-530687 05/03/26 Elva  修改大陸版運輸發票的算法,將DATA TYPE VAR CHAR改成CHAR
# Modify.........: No:MOD-530296 05/03/30 By Nicola 在多發票原來無稅額的稅別改為有稅額的稅別無重計算稅額
# Modify.........: No:MOD-530422 05/03/30 By Nicola 單身輸入科目，該科目需做部門管理，但單身部門欄位可空白
# Modify.........: No:MOD-530527 05/03/31 By Nicola 發票維護功能若為UNAP時,應不可做資料異動
# Modify.........: No:MOD-530494 05/03/31 By Nicola 多借方時，作部門管理及異動碼管理
# Modify.........: No:MOD-530047 05/03/31 By Nicola 若是沖暫估時,目前系統無法同時處理'直接付款',應必須開放此功能
# Modify.........: No:MOD-530307 05/03/31 By Nicola 4.無稅率時,其稅額科目應不可輸入
#                                                   5.直接付款視窗:單頭原幣,本幣未做小數取位
#                                                   7.應付未稅本幣金額輸入與原幣金額不符時(NTD),按ENTER,畫面會重新計算,但應付金額卻與未稅不符(無稅)
#                                                   8.若資料已確認,若有直接付款:2 銀行存款時,應不可做'日期修正'功能
# Modify.........: No:MOD-530439 05/04/04 By Nicola 3.單頭單身金額不平時自動留置處理，但做完差異處理後留置碼不會自動消失，需要手動處理取消留置
#                                                   2.差異處理自動產生請款折讓時，aapt210沒有帶到aapt110的匯率
# Modify.........: No:FUN-540041 05/04/20 By Smapmin  TIPTOP & EasyFlow整合程式修改方式
# Modify.........: No:FUN-550063 05/05/09 By ching  fix單身loop問題
# Modify.........: No.FUN-550030 05/05/16 By wujie  單據編號加大
# Modify.........: No:MOD-540018 05/05/23 By ching  disable _apa54()
# Modify.........: No:MOD-550108 05/06/01 By ching  預設預付aapr111列印品名
# Modify.........: No:FUN-530041 05/06/01 By Smapmin 只詢問一次"是否重新產生分錄"
# Modify.........: No:FUN-560002 05/06/03 By Will 單據編號修改
# Modify.........: No:FUN-550042 05/06/11 By Echo 確認段與整合段拆開。 aapt150,aapt210,aapt220 新增 TIPTOP 與 EasyFlow 整合
# Modify.........: No:MOD-560007 05/06/11 By Echo 重新定義整合FUN名稱
# Modify ........: No.FUN-560060 05/06/15 By vivien 單據編號加大返工				
# Modify.........: No:FUN-560070 05/06/18 By Smapmin 單位數量改抓計價單位計價數量
# Modify.........: NO:FUN-560099 05/06/20 By Smapmin 查詢時, 單身採購單號查詢程式會當出來, p_qry 無 q_pmm
# Modify.........: No:MOD-560102 05/07/01 By ching fix 部門拒絕允許
# Modify.........: No:MOD-560111 05/07/04 By ching fix ddd_c 變數清空
# Modify.........: No:FUN-570042 05/07/05 By ching default 折讓付款日=帳款日
# Modify.........: No:MOD-560236 05/07/26 By Nicola 幣別取位修正Q
# Modify.........: No:MOD-560240 05/08/02 By Smapmin 離開多借方的畫面後，借方科目會被清為空白
# Modify.........: No:MOD-540169 05/07/26 By ice 修改發票資料的顯示格式與單身資料一致,修正單身做完發票維護后顯示的問題
# Modify.........: No:MOD-580043 05/08/11 By Smapmin 在 after insert 時未call t110_ins_apk
# Modify.........: No.FUN-580006 05/08/16 By ice 是否使用進項防偽稅控接口.有稅控時,發票代碼Required
# Modify.........: No:FUN-570158 05/08/22 By Sarah 在複製裡增加set_entry段
# Modify.........: No:MOD-580079 05/08/25 By Smapmin 維護單張發票時,其格式輸入後按取消或離開後,apk171格式資料會消失.
#                                                    沖帳時應check該待抵帳帳款的付款廠商是否=aapt120請款作業上的付款廠商.
#                                                    CALL t110_compute_apa33()時判斷是不是預付情況
# Modify.........: No:FUN-580114 05/08/25 By Dido 以EF為backend engine,由TIPTOP處理前端簽核動作
# Modify.........: No:FUN-580012 05/09/12 By Elva 新增紅衝功能
# Modify.........: No:MOD-580365 05/08/31 By Carrier 調整匯差位置,考慮月底重評價
# Modify.........: No:MOD-590342 05/09/23 By Dido FUNCTION t110_apb07() 取消 FUN-560070 的修改
# Modify.........: No:MOD-580051 05/09/26 By Smapmin 修改"下QBE條件時不能正常列印"等問題
# Modify.........: No:FUN-590124 05/10/04 By Dido aag02 放寬
# Modify.........: No:MOD-590301 05/10/21 By Smapmin 確認功能做部份調整,以及其他修改.
# Modify.........: No.CHI-5A0001 05/10/27 By day  大陸版加稅控時aapt210進單身應可修改發票號碼
# Modify.........: No:MOD-590460 05/10/24 By Smapmin 按更改修改原幣金額,重新產生分錄後,單身合計沒有改變,出現本幣差異.
# Modify.........: No:MOD-5B0255 05/11/24 By Smapmin 匯率已有資料,不可再重新產生一次.
#                                                    借方科目清除,即會出現18字元.....的錯誤訊息
#                                                    本幣金額要預設為原幣金額*匯率.
#                                                    發票號碼開窗只能帶該廠商的可折讓資料.
#                                                    差異處理選3時,當我數量為0,開窗出來的視窗,原幣和本幣金額會被重算變成0;底下的原幣折讓金額也算錯了.
#                                                    將g_errno的值先清空
#                                                    帳款類別欄位不可空白的限制要在after field & after input的地方都要擋
# Modify.........: No.FUN-5A0131 05/11/28 By ice 應收帳款發票查詢可查看其詳細帳款信息
# Modify.........: No.MOD-5B0053 05/11/28 By ice 依月底重評價對AP未付金額調整,修正未付金額apa73的計算方法
# Modify.........: No:FUN-5B0135 05/12/02 By Sarah 修改單身後單頭的資料更改者,最近修改日應update
# Modify.........: No:MOD-5B0338 05/12/06 By Smapmin aapt210 增加"發票明細"Action
# Modify.........: No:MOD-5B0340 05/12/07 By Smapmin 修改MOD-560111
# Modify.........: No:TQC-5C0002 05/12/07 By Smapmin 新增單據時,簽核欄位有誤
# Modify.........: No:MOD-5B0005 05/12/07 By Smapmin 專案代號為空時,單身專案費用代號可以不用輸入
# Modify.........: No:FUN-5B0081 05/12/08 By wujie 退貨立暫估相關修改
# Modify.........: No:TQC-5B0016 05/12/15 By Smapmin apb25按 apa51='STOCK'的邏輯重新抓取科目資料
#                                                    若為進貨發票時,發票欄位'UNAP',應不可做直接付款作業.
#                                                    稅額變動後未重新UPDATE
#                                                    確認時, 選擇完確認範圍, 詢問確認否時, 若選擇'否', 則會跳出整個作業
# Modify.........: No:MOD-5C0088 05/12/15 By Smapmin LET g_errno = ''
# Modify.........: NO:MOD-5C0080 05/12/19 By Smapmin 修改稅率 * 未稅金額 依多發票檢核(+-2元)一致是稅額允許的範圍
# Modify.........: No:MOD-5B0111 05/12/20 By Smapmin 多發票功能,若輸入格式為22之發票,應可不輸入廠商統編.
# Modify.........: No:FUN-5C0015 051229 BY GILL 多借方新增異動碼欄位(共7個)
# Modify.........: NO.MOD-5B0135 06/01/05 BY yiting 選列印時,多發票參數請傳'Y'
# Modify.........: NO.MOD-5B0083 05/12/15 BY yiting 單身會科,部門沒有控制科目拒絕/允許部門.
# MOdify.........: No:MOD-610120 06/01/19 By Smapmin 條件修改
# Modify.........: No:MOD-610023 06/01/19 By Smapmin aapt120本幣差異計算有誤
# Modify.........: No:MOD-610011 06/01/19 By Smapmin aapt110取消複製功能
# Modify.........: No.MOD-5B0040 06/01/03 By smapmin 折讓發票維護後,INSERT INTO 至apk_file時,
#                                                    apk17(扣抵區分)應該取原發票的扣抵區分,而非單頭default的apa17
# Modify.........: No:MOD-5B0132 06/01/20 By Smapmin 沖帳:輸入原幣金額沒有即時判斷不可超過未沖金額
# Modify.........: NO.FUN-5C0031 06/01/23 BY yiting 複製時, 應包含多借方檔案之複製,便於習慣使用 多借方之客戶使用
# Modify.........: NO:MOD-610143 06/01/25 By Smapmin 發票號碼為UNAP時,該欄位不可修改
# Modify.........: No:MOD-620004 06/02/07 By Smapmin 單身有資料且本幣金額不為零，但是"本幣單身合計金額"卻為零
# Modify.........: No:MOD-620008 06/02/08 By Smapmin 已有沖帳之資料不可取消確認或作廢
# Modify.........: No:TQC-610135 06/02/08 By Smapmin 僅aapt110發票編號為UNAP時,不可直接付款
# Modify.........: No:MOD-620048 06/02/20 By Smapmin 發票編號無法由MISC改為其他發票編號
# Modify.........: No:TQC-620018 06/02/22 By Smapmin 單身按CONTROLO時,項次要累加1
# Modify.........: No:TQC-630032 06/03/06 l_arr1變數型態應改為char(16)
# Modify.........: No:TQC-630044 06/03/07 By Pengu 單身無法產生料號
# Modify.........: No:TQC-620113 06/02/23 By Smapmin 當 apk171 為 28,29 時, apk12,13 則不可異動
# Modify.........: No:FUN-630010 06/03/09 By saki 流程訊息通知功能
# Modify.........: No:TQC-630082 06/03/17 By Smapmin 當稅別的格式為 XX(不申報) 與 22(載有憑證) 時，不應該控管發票長度為10碥
#                                                    當稅別的格式為 28,29 時，碼數為 14 碼 
# Modify.........: No:TQC-630173 06/03/17 By Smapmin aapt150確認時,預付單號抓取有誤
# Modify.........: NO:FUN-630043 06/03/14 By Melody 多工廠帳務中心功能修改
# Modify.........: No:TQC-630134 06/03/30 By Smapmin 拿掉apz24的判斷
# Modify.........: No:MOD-630070 06/03/30 By Smapmin 採購單單別抓取有誤
# Modify.........: No:MOD-630089 06/03/31 By Smapmin 修正FUNCTION t110_apa34f()幣別取位問題
# Modify.........: No:TQC-620052 06/03/31 By Smapmin 雜項廠商的Action於新增時才出現
# Modify.........: No:FUN-630081 06/03/31 By Smapmin 拿掉單頭的CONTROLO
# Modify.........: No:TQC-630285 06/03/31 By Smapmin aapt210單身金額之稅額未自動SUM到單頭
# Modify.........: No:FUN-630068 06/04/04 By Ray 修改‘A’性質稅種的稅額計算方法，同‘T’性質稅種
# Modify.........: No:TQC-630164 06/04/09 By Smapmin 付款廠商為MISC時,統一編號不可為空白,且輸入的統編必須回饋到apa07
# Modify.........: No:TQC-630188 06/04/09 By Smapmin 11類別,單身金額可以輸入負數
# Modify.........: No:MOD-630131 06/04/09 By Smapmin 12or15類別,未輸入單身時,單身合計金額等於單頭金額
# Modify.........: No:TQC-630088 06/04/09 By Smapmin 直接付款金額回寫到apa35f,apa35
# Modify.........: No:MOD-640140 06/04/09 By Smapmin aapt210無法列印
# Modify.........: No:FUN-640022 06/04/10 By kim GP3.0 匯率參數功能改善
# Modify.........: No:MOD-640111 06/04/10 By Smapmin 單身合計金額有誤
# Modify.........: No:MOD-640225 06/04/10 By Smapmin 取消確認時,要將相對應的折讓單刪除
# Modify.........: No:FUN-640124 06/04/13 By Smapmin aapt210列印報表改串aapr220
# Modify.........: No:MOD-640473 06/04/14 By Smapmin 匯率變動後,單頭本幣要跟著改變
# Modify.........: No:MOD-640457 06/04/17 By Smapmin 多發票的本幣總額有誤
# Modify.........: No.MOD-640446 06/04/17 By Smapmin 確定新增成功後才insert into apk_file
# Modify.........: No:MOD-640458 06/04/17 By Smapmin 重新讀取目前傳票資料
# Modify.........: No:TQC-5C0093 06/04/19 By wujie   更新退貨立暫估已衝金額正負相反
# Modify.........: No:MOD-640329 06/04/19 By Smapmin 可分批沖暫估
# Modify.........: No:MOD-640518 06/04/20 By Smapmin 輸入多發票時,若格式不為'XX',則扣抵欄位不可空白
# Modify.........: No.FUN-640231 06/04/24 By Smapmin 確認段時,重新SELECT apa_file
# Modify.........: No:MOD-640549 06/04/24 By Smapmin aapt120不做差異處理
# Modify.........: No:FUN-640035 06/04/25 By kim 調整per畫面及輸入順序
# Modify.........: No:MOD-640537 06/04/25 By Carrier t110_k()中將更新衝帳款的重評后本幣未付變量修改為l_apa.apa73,不要與當前帳款的變量衝突
# Modify.........: No:MOD-650048 06/05/15 By Smapmin 修改查詢狀態變數值傳遞
# Modify.........: No:MOD-650061 06/05/16 By pengu限控制有問題,若主單身沒有刪除權限,則子功能之單身有刪除權限卻無法使用
# Modify.........: No:FUN-640240 06/05/16 By Echo 自動執行確認功能
# Modify.........: No:MOD-650063 06/05/22 By Nicola 直接付款問題:
#                                                   直接付款後未付欄位(apa35_uf)未重新計算
#                                                   執行確認 action 後原本已付金額被清空(apa35f)
# Modify.........: No:FUN-650068 06/05/23 By Smapmin 發票資料視窗多一個
# Modify.........: NO:MOD-650085 06/05/23 By Smapmin 修改變數定義
# Modify.........: No:FUN-630055 06/06/01 By rainy   apb另外開一個欄位apb31將專案代號由apb21中拉出來另外儲存
# Modify.........: No:MOD-650127 06/06/09 By Nicola aapt220的請款廠商可修改
# Modify.........: No:FUN-660122 06/06/16 By Hellen cl_err --> cl_err3
# Modify.........: No:FUN-660117 06/06/21 By Rainy Char改為 Like
# Modify.........: No:FUN-5C0106 06/06/22 By Rainy 將輸入順序改為稅別->稅率->發票號碼
# Modify.........: No:FUN-5C0023 06/06/22 By rainy 新增Action 費用分攤
# Modify.........: No:MOD-660093 06/06/22 By Smapmin 21類多判斷折讓類別為2
# Modify.........: No:MOD-660095 06/06/23 By Smapmin 沖帳金額做幣別取位
# Modify.........: No:MOD-660104 06/06/27 By Smapmin 修改依變動比率分攤的方式
# Modify.........: No:MOD-660111 06/06/28 By Smapmin aapt110 檢查多發票t110_invoice_chk 是否重複時,應該排除其 apk171 格式為'23''24'
# Modify.........: No:MOD-660132 06/06/30 By Smapmin 只有在11類時才會重算單頭差異金額
# Modify.........: No:MOD-660142 06/06/30 By Sarah 按"沖帳查詢"未出現其沖帳資料
# Modify.........: No:TQC-670008 06/07/04 By rainy 權限修正
# Modify.........: No:MOD-660086 06/07/05 By Sarah 查詢一筆未確認的單號後按新增再放棄,再按作廢,之前查詢的那筆會被作廢掉
# Modify.........: No:MOD-670016 06/07/05 By Smapmin 21類的作業不新增單頭的發票資料
# Modify.........: No:FUN-660216 06/07/10 By Rainy CALL cl_cmdrun()中的程式如果是"p"或"t"，則改成CALL cl_cmdrun_wait()
# Modify.........: No:MOD-670056 06/07/13 By Nicola g_apa.apa44 IS NOT NULL 改為 NOT cl_null(g_apa.apa44)
# Modify.........: No:FUN-670064 06/07/17 By kim GP3.5 利潤中心
# Modify.........: No:MOD-670075 06/07/17 By Smapmin 修改串接到aapr111的參數
# Modify.........: No:MOD-670131 06/07/28 By Smapmin 已沖暫估查詢action只有aapt110有使用,其他支皆需隱藏
# Modify.........: No:FUN-670060 06/07/28 By Rayven 新增"直接拋轉總帳"功能 
# Modify.........: No:FUN-680027 06/08/14 By wujie  多帳期修改
# Modify.........: No:FUN-680029 06/08/28 By wujie  兩套帳修改
# Modify.........: No:FUN-680110 06/09/05 By Sarah 增加aapt116,aapt260,畫面增加顯示rvv40(沖暫估否),apb01_unap(暫估帳款單號)
# Modify.........: No:FUN-690028 06/09/12 By flowld 欄位型態用LIKE定義
# Modify.........: No:FUN-690022 06/09/21 By jamie 判斷imaacti
# Modify.........: No:FUN-690024 06/09/21 By jamie 判斷pmcacti
# Modify.........: No:FUN-690025 06/09/21 By jamie 改判斷狀況碼pmc05
# Modify.........: No:FUN-690080 06/09/23 By ice 零用金管理
# Modify.........: No.FUN-680064 06/10/18 By johnray 在新增函數_a()中單身函數_b()前初始化g_rec_b
# Modify.........: No.CHI-6A0004 06/10/31 By bnlent g_azixx(本幣取位)與t_azixx(原幣取位)變數定義問題修改
# Modify.........: No:MOD-6A0073 06/11/01 By cl      修正衝待扺帳款時，本幣可為0的情況。
# Modify.........: No:FUN-690090 06/11/06 By Rayven 新增欄位apa992
# Modify.........: No:MOD-680012 06/11/15 By Smapmin aapt120單身確認後,不應再去update單頭金額
# Modify.........: No:MOD-680029 06/11/15 By Smapmin 沖帳時,DIFF本幣金額未依幣別取位
# Modify.........: No.MOD-680036 06/11/15 By Smapmin 除了非沖暫估且不直接付款外,其餘皆要insert into apf_file
# Modify.........: No:MOD-680082 06/11/15 By Smapmin 有直接沖帳金額存在時,不可以作廢
# Modify.........: No:MOD-690025 06/11/15 By Smapmin aapt120帳款單身要秀出入庫單號
# Modify.........: No:MOD-690134 06/11/15 By Smapmin aapt110單身料號品名不可輸入
# Modify.........: No:MOD-6A0025 06/11/15 By Smapmin 應將入庫與退貨一併產生到aapt110的單身
# Modify.........: No:MOD-6B0034 06/11/15 By Smapmin 費用分攤總金額為空
# Modify.........: No:MOD-6B0035 06/11/15 By Smapmin 離開多發票視窗後,INT_FLAG要還原
# Modify.........: No:MOD-6B0067 06/11/15 By Smapmin 修改分攤的原幣金額
# Modify.........: No:FUN-6A0016 06/11/15 By jamie 1.FUNCTION _q() 一開始應清空key值
#                                                  2.新增action"相關文件"
# Modify.........: No:FUN-690090 06/11/20 By cl    當apa992(集團代付單號)不為空才可取消審核
# Modify.........: No:FUN-680110 06/11/20 By Sarah "費用分攤"功能只有aapt120能用,其他程式須隱藏此Action
# Modify.........: No:TQC-6B0066 06/11/24 By wujie  多帳期二次修改
# Modify.........: No:FUN-6B0033 06/11/27 By hellen 新增單頭折疊功能
# Modify.........: No:MOD-6C0031 06/12/07 By Smapmin 預付款時,採購單位與數量應抓取計價單位與計價數量
# Modify.........: No:MOD-6B0156 06/12/07 By Smapmin aapq230沖帳查詢時也要能夠查到由aapt900做成本分攤的資料
# Modify.........: No.FUN-680003 06/12/07 By Smapmin 期初時,輸入aapt210的單身發票編號時,可不存在apk_file,改判斷是否存在amd_file
# Modify.........: No:MOD-6B0051 06/12/07 By Smapmin 折讓(t110_21_ins2)應判斷,'21'轉'23','28'轉'29','XX'轉'XX',其於轉'24'
# Modify.........: No:TQC-6B0118 06/12/07 By Smapmin 除了類別12,15,13,17不顯示apb21之外,其餘皆顯示apb21與apb31
# Modify.........: No:MOD-6B0088 06/12/07 By Smapmin aapt120輸入料號後,應可以自動帶入料件之會計科目
# Modify.........: No:MOD-6B0066 06/12/07 By Smapmin 稅額幣別取位問題
# Modify.........: No:MOD-6A0124 06/12/07 By Smapmin 折讓類別應可查詢
# Modify.........: No:TQC-6C0074 06/12/13 By douzh   aapt121作業還款銀行和還款異動碼開窗時check支付方式，銀行類別等信息 
# Modify.........: No:FUN-6C0037 06/12/18 By Smapmin 修改應稅內含金額計算方式
# Modify.........: No:MOD-6C0122 06/12/19 By Smapmin 已沖暫估之資料不可取消確認
# Modify.........: No:TQC-6C0044 06/12/22 By Smapmin 修改回寫待抵已付金額
# Modify.........: No:MOD-6C0164 06/12/26 By Smapmin 列印多發票資料
# Modify.........: No:MOD-710006 07/01/02 By Smapmin 待沖暫估金額有誤
# Modify.........: No:MOD-710040 07/01/05 By Smapmin 確認後不可再執行直接付款
# Modify.........: No:MOD-6C0178 07/01/11 By Smapmin 修改稅額計算方式
# Modify.........: No:MOD-720023 07/02/06 By Smapmin aapt120沖暫估,若帳款編號為DIFF則不需執行UPDATE aapt110的已付金額
# Modify.........: No:MOD-720062 07/02/08 By Smapmin 改變 g_sql,g_wc等定義為STRING
# Modify.........: No:MOD-720104 07/02/14 By Smapmin 作廢後不可再產生分錄
# Modify.........: No:TQC-720043 07/02/27 By Rayven 付款廠商輸入EMPL選取員工編號后不能帶出名稱
# Modify.........: No:TQC-720045 07/02/27 By Rayven aza46判斷錯誤
# Modify.........: No:TQC-710097 07/02/27 By Rayven AFTER FIELD apa31f稅前金額及稅額反推錯誤
# Modify.........: No:MOD-720064 07/02/28 By Smapmin 走防偽稅控且暫估時,不可輸入多發票
# Modify.........: No.TQC-6B0105 07/03/06 By carrier 連續兩次查詢,第二次查不到資料,做修改等操作會將當前筆停在上次查詢到的資料上
# Modify.........: No:TQC-730027 07/03/07 By Rayven aapt210大陸版使用aapr129,其他情況使用aapr220
# Modify.........: No.FUN-730032 07/03/22 By wujie   網銀功能相關修改，nme新增欄位
# Modify.........: No:MOD-730092 07/03/22 By Smapmin 單身輸入異常
# Modify.........: No:MOD-730141 07/03/30 By Smapmin s_chkdept已mark掉,之後的錯誤訊息判斷也要mark
# Modify.........: No:FUN-730064 07/04/04 By Lynn    會計科目加帳套
# Modify ........: No.TQC-740042 07/04/09 By johnray s_get_bookno和s_get_bookno1參數應先取出年份
# Modify ........: No.TQC-740030 07/04/10 By Rayven aapp115拋轉的帳款刪除后無法重新拋轉
# Modify.........: No:MOD-740030 07/04/11 By Smapmin 多角貿易拋轉至此,未產生傳票者仍可修改分錄
# Modify.........: No:TQC-740050 07/04/11 By Judy 單身品號未控管
# Modify.........: No:TQC-740067 07/04/13 By Rayven aapt110測試bug統一修改
# Modify.........: No:TQC-740080 07/04/13 By Rayven aap測試bug統一修改
# Modify.........: No.MOD-730098 07/04/16 By Smapmin 修改UPDATE apa_file 的錯誤訊息判斷
# Modify.........: No.TQC-740093 07/04/17 By Lynn    會計科目加帳套
# Modify.........: No.MOD-740057 07/04/19 By Smapmin 比照aapt330 insert/delete nme_file的做法
# Modify.........: No:TQC-740159 07/04/21 By wujie   子帳期每一期的原幣和本幣金額計算時應在計算完后再和應付原幣和本幣檢核一次，把尾差調至最后一筆子帳期上。現在沒有！
#                                                    按“多帳期維護”進去維護時，退出時必須檢核子帳期原幣合計和本幣合計是否與應付單頭的原幣應付和本幣應付一致，如不一致則繼續維護多帳期資料。
# Modify.........: No:TQC-740168 07/04/22 By Rayven aap-921報錯信息彈出顯示，以免被忽視
# Modify.........: No:TQC-740167 07/04/22 By Rayven 單身輸入金額后,系統會回寫單頭未稅金額欄位,但未計算稅額
# Modify.........: No:MOD-740070 07/04/22 By 原幣金額不可為0或null
# Modify.........: No.MOD-740346 07/04/23 By Rayven 不使用網銀時不去判斷是否未轉
# Modify.........: No.MOD-740369 07/04/24 By wujie  多帳期錯誤修改
# Modify.........: No.TQC-740281 07/04/24 By Echo 從ERP簽核時，「拋轉傳票」、「傳票拋轉還原」、「多帳期維護」、「費用分攤」action應隱藏
# Modify.........: No.TQC-740315 07/04/25 By Rayven 在應付單別設置為”自動拋轉總賬”時，撤銷審核時應把該單據從總帳拋轉還原的時間點前提到執行撤銷審核的作業前
# Modify.........: No.TQC-740314 07/04/26 By wujie 衝帳時衝帳金額與子帳期合計，已付金額的比較的修改
# Modify.........: No:MOD-750002 07/05/08 By Smapmin 修正MOD-610143
# Modify.........: No:MOD-750014 07/05/08 By Smapmin aapt210發票明細資料有誤
# Modify.........: No:CHI-750003 07/05/08 By kim aapt210,aapt260 單身 "報銷明細說明(apb33)" "員工編號(apb32)" 應隱藏!  ,未使用多帳別(aza63='N') 科目二應隱藏
# Modify.........: No:MOD-740500 07/05/09 By Jackho aapt121衝賬及分錄修正
# Modify.........: No:CHI-750011 07/05/09 By kim aapt260(暫估退貨) 應 hide "Restore Info"
# Modify.........: No:CHI-750015 07/05/11 By Smapmin 手動於aapt210新增一個折讓類別為2.退貨折讓時,確認時也要可以新增發票檔
# Modify.........: No:MOD-750056 07/05/14 By Smapmin 將q_apa3改為使用CONSTRUCT功能
# Modify.........: No:MOD-750050 07/05/14 By Smapmin 沖帳時,金額依幣別取位後再比較原幣金額與本幣金額是否有差異
# Modify.........: No:MOD-750048 07/05/14 By Smapmin 修正TQC-5C0093
# Modify.........: No:MOD-750064 07/05/15 By Smapmin 修改單身欄位名稱
# Modify.........: No:TQC-750041 07/05/16 By sherry  點日期修正，先彈到付款方式欄位上
# Modify.........: No:CHI-750020 07/05/17 By Smapmin aapt210單身發票編號空白否的控管與折讓類別3.一致
# Modify.........: No:TQC-750104 07/05/21 By rainy 採購單項次未檢查
# Modify.........: No:TQC-750121 07/05/21 By rainy 1.MISC發票 會檢查 amd-010 此類發票為10碼...    但 非MISC ,於apa08(發票號碼) 輸入確無相同處理!
#                                                  2.直接付款  轉帳時,卻仍需輸入子帳期項次  控制點應與 aapt330 付款單身處理一致"
#                                                  3.多借方維護時,科目設定部門管理(aag05='Y')未維護部門確可離開,所有欄位處理應檢查是否與s_fsgl一致!
#                                                  4.多借方維護時,執行 action ""分攤"" 出現 -284 error
#                                                  5.單身輸入 MISC1 確警告 aap-924
#                                                  6.多借方維護時ok, 再次維護多借方,卻未抓出先前維護資料! 
#                                                  7.分兩次成本分攤    ""費用分攤"" action 卻只可查出一筆 aapt900
# Modify.........: No:FUN-750051 07/05/22 By johnray 連續二次查詢key值時,若第二次查詢不到key值時,會顯示錯誤key值
# Modify.........: No.TQC-750139 07/05/23 By rainy 單身 ""原發票號碼"" 應可開窗查詢 apk_file在相同 稅別(apk11)下
#                                                  aapt151(員工借支) 若沖帳 程式 應call t110_k_2() 抓  待抵資料(apa00='25') 
# Modify.........: No:TQC-750140 07/05/23 By rainy aapt210/aapt220/aapt260 還款資料應隱藏，apa37f/apa37隱藏
# Modify.........: No:TQC-750140 07/05/24 By rainy aapt121沖帳時，待抵開窗資料應只能查出待抵借支款資料
# Modify.........: No:TQC-750129 07/05/24 By wujie 差異處理選留置時，未更新子帳期留置金額
# Modify.........: No:TQC-750177 07/05/25 By rainy 1.aapt210,aapt220 (折讓,DM) apa08是 ""參考號碼""不必check ""發票號碼""
#                                                  2.aapt121(報銷還款) ""直接付款"" 時   若選 8.借款待抵 應該只可查 aapq231(員工借支待抵資料)當 apa00='13' ,'17' 時,其它情況不可影響到 
# Modify.........: No:TQC-750181 07/05/28 By Rayven 暫估并且衝暫估時重復減了rvv23
# Modify.........: No:TQC-750244 07/05/30 By Smapmin 修改ora檔
# Modify.........: No:FUN-710078 07/05/30 By jamie 單頭及單身增加部門名稱及科目名稱
# Modify.........: No.MOD-750143 07/06/06 By Smapmin 將del nme_file放到foreach外,並判斷nme_file是否存在
# Modify.........: No:MOD-760089 07/06/22 By Smapmin 沖帳功能匯差計算方式要先將金額取位後再做相減
# Modify.........: No:MOD-770005 07/07/03 By Smapmin 已有產生折讓發票,不可取消確認
# Modify.........: No:MOD-770001 07/07/03 By Smapmin 刪除整張單據時,連apg/aph也要刪除
# Modify.........: No:TQC-770027 07/07/04 By Judy 單頭或單身金額有變動時對多帳期的處理
# Modify.........: No:TQC-770056 07/07/11 By chenl  1.若單頭項目編號為空，則單身項目費用代碼欄位不可輸入。
# Modify.........:                                  2.判別預算時，增加帳別條件。
# Modify.........:                                  3.科目抓取時增加帳套條件。
# Modify.........:                                  4.增加對入庫單及退貨單的控管。
# Modify.........: No:MOD-770041 07/07/18 By Smapmin 帳款幣別與採購單幣別不符時,要卡死
# Modify.........: No:MOD-770044 07/07/18 By Smapmin 單據無法作廢
# Modify.........: No:MOD-770066 07/07/18 By Smapmin 差異處理狀態為待處理時,不可執行確認
# Modify.........: No:MOD-770050 07/07/18 By Smapmin 大陸版必須將發票明細中的格式加以隱藏
# Modify.........: No:MOD-770081 07/07/19 By Smampin 修改產生折讓單後的相關卡關動作
# Modify.........: No:MOD-770121 07/07/26 By Smapmin 發票號碼不應影響申報格式
# Modify.........: No:MOD-770138 07/07/30 By Smapmin 發票字軌檢查
# Modify.........: No:MOD-780009 07/08/02 By Smapmin 只有付款類別為2*且折讓類別為'1'的,才會經由單身資料update發票資料
# Modify.........: No.MOD-780028 07/08/07 By wujie   eapc_file -->apc_file
# Modify.........: No:MOD-780042 07/08/08 By Smapmin AFTER INSERT 已經有 set rvv40 = 'Y',因此相對的 BEFORE DELETE 亦需增加此調整
# Modify.........: No:FUN-770043 07/08/17 By Smapmin 確認後仍需要看直接沖帳的資料
# Modify.........: No:MOD-780129 07/08/21 By kim 確認自動拋傳票後,單頭傳票號碼未顯示,須重新Q才會出來
# Modify.........: No:TQC-780065 07/08/22 By Smapmin 留置金額以原幣角度維護,故依原幣取位方式.
# Modify.........: No:MOD-780152 07/08/30 By wujie 多帳期留置功能修改
# Modify.........: No:MOD-780123 07/08/31 By wujie aapt121應付-已付=0時也不能還款
# Modify.........: No:MOD-780281 07/09/03 By Smapmin 差異處理選擇4.將單頭金額分攤到單身時,金額有誤
# Modify.........: No:MOD-780274 07/09/03 By Smapmin 沖暫估/直接付款新增到付款的類別應為11/16
# Modify.........: No.CHI-780046 07/09/10 By sherry  新增時，請款人員帶不到資料，把cpf_file換成gen_file
# Modify.........: NO:MOD-790042 07/09/17 By Smapmin 帳款日期與幣別有更改時,應同時update匯率與金額
# Modify.........: No:MOD-790086 07/09/17 By Smapmin 取消確認時判斷是否已有沖帳資料,應過濾apf00='11' AND apf00='16'
# Modify.........: No:MOD-790038 07/09/17 By Smapmin nme02指定貸方到期日;若無再指定為付款日
# Modify.........: No.MOD-790010 07/09/17 By Smapmin 當取消確認時,api26 為 DIFF 者,無須更新 apa_file 原始應付立帳
# Modify.........: No:MOD-790046 07/09/17 By Smapmin 修改請款單取消確認時,對請款折讓單的處理
#                                                    以apk_file的角度查詢請款折讓單
# Modify.........: No:MOD-790057 07/09/20 By Smapmin 21類帳款取消多發票功能
# Modify.........: No:TQC-790128 07/09/24 By Judy 直接付款資料已更改，未更新到子帳期
# Modify.........: No:TQC-790133 07/09/26 By Smapmin 將q_aag改為q_aag02
# Modify.........: No:MOD-790124 07/09/26 By Smapmin 輸入發票明細後回到主畫面,付款廠商說明就會變空白
# Modify.........: No:TQC-790158 07/09/27 By xufeng  大陸版時,從aapp111拋轉到aapp210的資料,審核時會報
#                                                    折讓發票金額大于原發票金額的錯誤
# Modify.........: No:TQC-790167 07/09/29 By Judy 單頭apa08為MISC時，執行多發金額調整后更新單頭，無法審核
# Modify.........: No:MOD-7A0006 07/10/04 By Dido aapp400 拋轉參數修改
# Modify.........: No:MOD-7A0015 07/10/05 By Smapmin 發票格式為XX時,發票編號可以不打
# Modify.........: No:MOD-7A0040 07/10/09 By Smapmin 雜項暫估流程應在aapt120執行
# Modify.........: No:MOD-7A0049 07/10/11 By Smapmin apc16留置金額未同步update 
# Modify.........: No:FUN-7B0024 07/10/12 By Sarah 當單頭的apa51是UNAP時，表示此單為沖暫估，單身才需要show沖暫估否與暫估帳款單號
# Modify.........: No:MOD-7A0069 07/10/15 By Sarah 當單身有沖暫估倉退時,沖暫估選項未打勾且暫估帳款單號未出現
# Modify.........: No:CHI-7A0030 07/10/16 By Smapmin 13類的多發票視窗,不能看到稅額攔位
# Modify.........: No:CHI-7A0024 07/10/16 By Smapmin 由於歐美客戶沒有發票機制,所使用的 invoice 是採廠商自行編碼原則,因此會有可能不同廠商會有相同之 invoice
#                                                    請增加若系統參數為歐美(aza26='1')時則採廠商+invoice檢核 invoice 是否重複的問題
# Modify.........: No:MOD-7A0082 07/10/18 By Smapmin 修改單頭金額時,未同步update多帳期金額
# Modify.........: No:TQC-7A0041 07/10/18 By Smapmin 留置金額無法輸入
# Modify.........: No:MOD-7A0116 07/10/22 By Smapmin 12類,除借方科目為UNAP外,其餘皆可更改請款廠商
# Modify.........: No:FUN-7A0050 07/10/23 By Sarah 1.aapt160增加可輸入"費用暫估"資料,此時單身"入庫單號","入庫項次"可不輸入,"料號"(apb12),"品名"(apb27)可輸入MISC
#                                                  2.aapt120單身增加輸入"暫估單號"(apb21),"暫估項次"(apb22),可空白,可開窗查aapt160費用暫估資料,並檢查是否為aapt160費用暫估資料
# Modify.........: No:MOD-7A0143 07/10/25 By Smapmin 修改變數定義大小
# Modify.........: No:MOD-7A0124 07/10/25 By Smapmin 整張單據刪除時,無法update rvb06
# Modify.........: No:TQC-7A0095 07/10/25 By chenl   1.原：當apa31>0時對apa51進行字段判斷，現：apa31>=0，進行判斷。
# Modify.........:                                   2.當apa00='15'時，即產生預付款時，不需要考慮多帳期的情況。
# Modify.........:                                   3.衝賬時，原先對原幣金額的判斷作mark處理
# Modify.........:                                   4.修正：當借方第二科目為"MISC"時，無法保存記錄的錯誤。
# Modify.........:                                   5.開啟多借方時，按不同帳套取科目名稱。
# Modify.........: No:CHI-7A0039 07/11/01 By Sarah 單身部門控管問題:
#                                                  1.不走多帳別時,此科目有做部門控管卻會被第二套帳的條件導致無法輸入
#                                                  2.若走多帳別時,若主財務帳有部門管理,另一帳別不做部門管理時,此欄位的就應不做部門管理
# Modify.........: No:FUN-7B0012 07/11/07 By Carrier db分隔符,call s_dbstring()處理
# Modify.........: No:MOD-7B0096 07/11/12 By Xufeng 付款條件為自定義的時候,沒有更新apc13字段的值,導致后續使用這個欄位時出現問題
# Modify.........: No.MOD-7B0033 07/11/12 By Smapmin 發票編號為空時,不可insert apk_file
# Modify.........: No:MOD-7B0009 07/11/12 By Xufeng  1.修正"當批次自動產生請款單時，單頭科目二的名稱都未被帶出顯示"
# Modify.........:                        By chenl   2.取消審核時，刪除直接付款資料。
# Modify.........: No:MOD-7B0091 07/11/13 By Smapmin aapt160不可有複製功能
# Modify.........: No:MOD-7B0101 07/11/13 By Smapmin 付款條件不可為NULL
# Modify.........: No:TQC-7B0051 07/11/13 By Smapmin 單別不產生分錄則不需執行傳票拋轉還原動作
# Modify.........: No:MOD-7B0128 07/11/13 By xufeng  發票非台灣版時不需要控制為10碼
# Modify.........: No:FUN-7B0055 07/11/14 By Carrier CALL _oox()時考慮多帳期
# Modify.........: No:TQC-7B0098 07/11/16 By Rayven copy的資料不能更改，upd apc報錯，應該是復制時未復制apc資料
# Modify.........: No:TQC-7B0063 07/11/16 By chenl   修正單價，數量，金額正負錯誤。
# Modify.........: No:TQC-7B0100 07/11/16 By wujie   有直接付款時，不能更改資料  
#                                                    付款方式為多帳期，作直接付款后審核，再取消審核時，單頭已付金額會把直接付款的金額還原，多帳期資料亦會如此。建議：取消審核，直接付款資料不做任何異動。
# Modify.........: No:TQC-7B0063 07/11/19 By chenl   修改單價金額的正負問題。
# Modify.........: No:TQC-7B0109 07/11/19 By Rayven 單身中無法錄入無收貨單的倉退單
# Modify.........: No:MOD-7B0159 07/11/20 By Smapmin 拋轉傳票時,user要帶g_apa.apauser
# Modify.........: No:TQC-7B0117 07/11/20 By Smapmin 已沖暫估查詢應由aapt110移至aapt160
# Modify.........: No:TQC-7B0122 07/11/21 By chenl   修改科目和科目二的查詢，現在查詢要求為，根據帳套，且屬于獨立科目或明細科目，科目性質為帳戶。
# Modify.........: No:TQC-7B0123 07/11/21 By wujie   做完直接付款后，再次進入直接付款，將剛才做的直接付款資料刪除，但是子帳期對應的金額沒有更新，apc10，apc11應該為0，apc13=apc09。
#                                                    取消審核后不應清除已付金額
# Modify.........: No:TQC-7B0083 07/11/22 By Carrier 1.單身字段rvv40改為apb34
#                                                    2.計算rvv23/rvv88邏輯(正常請款/立暫估/衝暫估)
#                                                    3.衝暫估時,入庫單年月可以和立帳年月不同
#                                                    4.衝暫估action功能修正
#                                                    5.判斷單身總額非負
# Modify.........: No:MOD-7C0020 07/12/05 By Smapmin 修改還款查詢視窗title/field name
# Modify.........: No:MOD-7B0258 07/12/05 By Smapmin 少了WHERE 條件
# Modify.........: No:MOD-7B0209 07/12/05 By Smapmin 改以cl_cmdrun_wait來執行aapp400
# Modify.........: No:TQC-7C0049 07/12/06 By Carrier 差異處理后,apa33有被重新計算,但是apa33f沒有做計算,造成兩者不一致
# Modify.........: No:TQC-7C0039 07/12/06 By Smapmin SQL語法錯誤
# Modify.........: No:MOD-7B0257 07/12/06 By Smapmin 若不使用多帳別功能時,科目二不可輸入
# Modify.........: No:MOD-7B0180 07/12/07 By Smapmin 單頭金額為0,自動計算單身合計金額到單頭,包含稅額的部份
#                                                    直接付款針對aapq230的已沖金額回寫部份,已於輸入直接付款資料時就回寫,不需再確認/取消確認段做
# Modify.........: No:MOD-7C0053 07/12/07 By Smapmin 多發票視窗依含稅的稅別自動計算金額
# Modify.........: No:TQC-7C0094 07/12/08 By chenl   1.對還款功能進行修正
# Modify.........:                                   2.增加未還金額的顯示.
# Modify.........:                                   3.衝賬時,對apc14,apc15進行更新.
# Modify.........:                                   4.修正TQC-7A0095，關于待扺帳款子帳期的錯誤，原：apa00=15時產生一筆，現為apa00=
# Modify.........: No:TQC-7C0134 07/12/12 By Rayven  去除還款按鈕
# Modify.........: No.TQC-7C0140 07/12/12 By carrier 期初衝暫估時,單身可能沒有資料,但應該也可以做審核
# Modify.........: No:MOD-7C0139 07/12/20 By Smapmin 確認時,aapt210折讓類別為2/3,單身發票編號不可空白
# Modify.........: No:MOD-7C0201 07/12/26 By Smapmin 傳至aapr111的參數有誤
# Modify.........: No:MOD-7C0203 07/12/27 By Smapmin 輸入付款廠商後,也要default匯率
# Modify.........: No:MOD-810013 08/01/07 By Smapmin 更改單頭匯率時,單頭本幣金額未同步更改
# Modify.........: No:MOD-810050 08/01/07 By Smapmin 已存在沖暫估資料時,借方科目不可更改(一定要為UNAP)
# Modify.........: No.MOD-810064 08/01/09 By Sarah   aapt220新增單據出現更新到應付系統多帳期明細檔(apc_file)的失敗錯誤訊息
# Modify.........: No.TQC-810047 08/01/15 By carrier 期初衝暫估時,單身可能沒有資料,但應該也可以做審核
# Modify.........: No:MOD-810111 08/01/16 By Smapmin 檢查輸入之沖帳帳款編號+子帳期是否已有沖帳記錄時應該使用apv[i].apv03之帳款編號,而不是使用g_apa.apa01之帳款編號
# Modify.........: No:MOD-810104 08/01/16 By Smapmin 新增時,單頭金額為0,由單身update單頭金額時,多帳期資料未update 
# Modify.........: No:FUN-810046 08/01/15 By Johnray 增加串查段
# Modify.........: No:MOD-810156 08/01/21 By Smapmin 未設定多帳期時,多帳期資料應自動Insert 
# Modify.........: No:MOD-810168 08/01/21 By Smapmin 改善SQL語法,增加效率
# Modify.........: No:MOD-810244 08/01/31 By Smapmin 由於可以部份沖暫估,故將MOD-810050的功能拿掉
# Modify.........: No.MOD-810242 08/01/31 By Smapmin 借方科目為NULL,不應insert api_file
# Modify.........: No:MOD-810207 08/01/31 By Smapmin 多借方資料存在時,不可改變為MISC的借方科目,必須先將多借方資料刪除
# Modify.........: No:TQC-810091 08/01/31 By chenl   對api05,api05f進行截位。
# Modify.........: No:FUN-810045 08/01/31 By rainy   項目管理，單身子劃面aapt110_5取消,新增項目編號(apb35)WBS編號(apb36)費用原因(apb31)預算編號(apb30)
# Modify.........: No:MOD-830040 08/03/06 By Smapmin 以s_ahe_qry取代q_aee
# Modify.........: No:TQC-830007 08/03/07 By claire 中斷點的AR應允許可以取消確認
# Modify.........: No:MOD-830018 08/03/07 By Smapmin 傳票編號顯示有誤
# Modify.........: No:MOD-820103 08/03/07 By Smapmin 原幣本幣金額相反
# Modify.........: No:CHI-810018 08/03/07 By Smapmin 票據系統立帳資料不可取消確認
# Modify.........: No:MOD-830075 08/03/10 By Smapmin 多發票視窗的匯率修改後,應自動計算本幣金額
# Modify.........: No.MOD-830059 08/03/11 By Smapmin 直接付款insert into apg_file 的動作移到update apc_file當下再處理
# Modify.........: No:MOD-830089 08/03/12 By Smapmin 修正FUN-680027
# Modify.........: No:MOD-820129 08/03/12 By Smapmin 為暫估帳款不能進行沖帳
# Modify.........: No:MOD-820002 08/03/12 By Smapmin 僅抓取同一付款廠商的資料
# Modify.........: No:MOD-820050 08/03/12 By Smapmin 費用類暫估(16)也要可以做費用分攤
# Modify.........: No:MOD-820008 08/03/17 By Smapmin 修改待抵沖帳時,回寫單身應付帳款單號所屬的金額
# Modify.........: No:MOD-830121 08/03/18 By Smapmin 退貨折讓更改單頭金額時,不可影響發票金額
# Modify.........: No:CHI-820015 08/03/19 By Smapmin 修正沖帳後多帳期金額update部份
# Modify.........: No:MOD-810269 08/03/19 By Smapmin 取消FUN-6C0037所修改的程式段(含稅時未稅金額自動計算)
# Modify.........: No:MOD-830213 08/03/27 By Smapmin 調整多發票金額時,若有update單頭金額,則應重算差異的金額
# Modify.........: No.MOD-830234 08/03/31 By Smapmin 沖帳資料中,DIFF的資料不需update apa_file的資料
# Modify.........: No:FUN-830091 08/03/31 By Smapmin 增加多角分錄底稿
# Modify.........: No:FUN-830161 08/03/31 By Carrier 去掉預算編號apb30/api25/apa71
# Modify.........: No:MOD-830244 08/04/01 By Smapmin 複製時,apc的欄位應依照apa的欄位給預設值
# Modify.........: No:MOD-840040 08/04/07 By Smapmin 單據已確認,多借方視窗按X無法離開
# Modify.........: No.MOD-840046 08/04/09 By chenl   對apk_file金額字段檢查并增加取位處理。
# Modify.........: No:MOD-840087 08/04/14 By Smapmin 執行沖帳後仍要可以開多帳期的窗
# Modify.........: No:MOD-840079 08/04/14 By Smapmin 輸入多發票時,未同步處理apa57的變數
# Modify.........: No:MOD-840119 08/04/15 By Smapmin 單身科目為空時,部門也不可以輸入
# Modify.........: No:MOD-840134 08/04/17 By Smapmin 修正MOD-830213
# Modify.........: No:MOD-840203 08/04/20 By Dido    產生至 aapq230 時 apa54 與 aapt150 一致
# Modify.........: No:MOD-840531 08/04/22 By hellen  增加功能：差異處理后詢問分錄底稿是否重新產生
# Modify.........: No:MOD-840535 08/04/23 By Smapmin aapt150單身可不打採購單
# Modify.........: No:MOD-840611 08/04/23 By Carrier 單別不做預算時,費用代號應該可以為空白
# Modify.........: No:CHI-840046 08/04/23 By Smapmin 修正MOD-840119
# Modify.........: No:MOD-840179 08/04/23 By hellen  單身采購單號改成開窗q_pmm9,選出與單頭請款廠商及幣別一致的資料
# Modify.........: No.MOD-840381 08/04/24 By Carrier 取消審核時,檢查暫估單是否已在api_file(衝暫估單)中存在
# Modify.........: No.MOD-840385 08/04/24 By Carrier 審核時,檢查api_file中的衝暫估資料是否被取消審核了,若是,則不得做資料審核
# Modify.........: No:MOD-840449 08/04/24 By douzh 1. 若單身入庫單/項次尚未確認或找不到資料，不應show aap-316錯誤訊息。
# Modify.........:                                    應提示該單據尚未確認或是無此筆資料，不應show入庫年月與立帳年月不同，易誤導user
# Modify.........:                                    因為立帳年月跟null比，當然是不一致。
# Modify.........:                                 2. 若單身費用原因空白且不做專案管理時，費用原因應提示必填，非(aap-301) 無此專案+費用代號的資料,請查核..!
# Modify.........: NO:FUN-840132 08/04/24 By lilingyu aapt210 aapt220列印時增加一個選擇串aapr111的憑証報表
# Modify.........: No:MOD-840649 08/04/24 By Smapmin 抓取會科資料時,要加上帳別條件
# Modify.........: No:MOD-840668 08/04/28 By Smapmin 輸入完多發票後,若無差異金額,將差異狀態更改為'0'
# Modify.........: No:MOD-840701 08/04/30 By Smapmin 入庫單+項次對應到的收貨單+項次,若未補登發票,不可輸入於aapt110單身
# Modify.........: No:TQC-850001 08/05/01 By Carrier 追單 CHI-840018
# Modify.........: No:FUN-850038 08/05/19 By TSD.lucasyeh 自定欄位功能修改
# Modify.........: No:MOD-850206 08/05/20 By Smapmin 取消MOD-840701
# Modify.........: No:MOD-850155 08/05/20 By Smapmin 抓取沖帳金額應加上api02='2'的條件 
# Modify.........: No:CHI-840021 08/05/20 By Smapmin 沖帳時,若全額沖銷,將自行調整本幣未稅金額的差異也視為匯差
# Modify.........: No:MOD-840632 08/05/21 By Smapmin 修改本幣金額計算方式
# Modify.........: No:MOD-850081 08/05/23 By Sarah 沖暫估話畫面單頭的金額不需扣到折讓金額(apa60,apa60f)
# Modify.........: No.MOD-850114 08/05/15 By Sarah aapt210單身輸入發票(apb11)時,需檢核apa00=1*的apk_file對應的帳款已確認才可輸入
# Modify.........: No:MOD-850100 08/05/23 By Sarah 檢核借方科目(apa51)若有預算控管時(aag21='Y'),須提示卡關請輸入在單身的訊息
# Modify.........: No:FUN-850027 08/05/23 By douzh WBS編碼錄入時要求時尾階并且為成本對象的WBS編碼
# Modify.........: No:MOD-850205 08/05/26 By Sarah 錯誤訊息aap-779抓取條件WHERE apc01=g_apa.apa01改為WHERE apc01=g_apv[i].apv03
# Modify.........: No.MOD-850245 08/05/26 By Sarah 將t110_r()裡,刪除aph_file段落搬到t110_r_cur3之後,因為t110_r_cur3會去抓aph_file
# Modify.........: No:MOD-850251 08/06/06 By Sarah t110_apb22_11(),判斷當執行aapt160時,rvv87-rvv88<=0表示此入庫單+項次已立暫估,不可重覆輸入
# Modify.........: No.MOD-850268 08/06/06 By Sarah t110_ins_nme_1(),有段依單身產生nme_file,修正為只產生一筆nme_file
# Modify.........: No.CHI-850032 08/06/06 By Sarah 在確認段寫入apk_file前,先檢核apk_file是否存在,若是則先刪除再新增
# Modify.........: No:MOD-850283 08/06/06 By Sarah 當輸入的稅別類型是運輸發票(T)時,在多發票頁籤中計算出來的稅額(apk07f,apk07)是錯的
# Modify.........: No:MOD-850301 08/06/06 By Sarah 回寫待抵帳款的已付金額的時機,改於確認段再回寫
# Modify.........: No:MOD-850316 08/06/06 By Sarah aapt210單身apb21改為"退貨單號/費用類暫估單號",當單頭折讓類別為3時,apb21開放輸入aapt260的暫估單號
# Modify.........: No:MOD-850302 08/06/06 By Sarah 1.aapt160若有入庫單號時,單身金額不可修改(apz16='N'=>除apb25會計科目、apb251會計科目二、apb26部門可改外,其餘皆不可修改,apz16='Y',維持原控制)
#                                                  2.aapt110單身輸入沖暫估時,金額直接抓取
# Modify.........: No:MOD-850320 08/06/06 By Sarah t110_21_ins2()段,增加l_apa.apa171 WHEN '23' LET toapk.apk171 = '23'
# Modify.........: No:CHI-850025 08/06/07 By Sarah 當匯率為1時,需檢核原幣與本幣的稅額、金額需相同
# Modify.........: No:MOD-860075 08/06/10 By Carrier 直接拋轉總帳時，aba07(來源單號)沒有取得值
# Modify.........: No:TQC-860021 08/06/10 By Sarah INPUT,PROMPT,MENU段漏了ON IDLE控制
# Modify.........: No:MOD-860148 08/06/16 By Sarah aapt110若更改時,單身無資料應可開放apa05(請款廠商)調整
# Modify.........: No:FUN-850027 08/06/18 By douzh 計算并檢核預算耗用時考慮是以部門還是以營運中心傳入計算耗用
# Modify.........: No:MOD-860179 08/06/26 By Sarah 增加判斷,若l_apa.apa171為25時,toapk.apk171應為23
# Modify.........: No:MOD-860203 08/06/27 By Sarah apa11計算apa12,apa64段,增加計算apa00 = 21,22,26類別
# Modify.........: No.MOD-860245 08/06/27 By Sarah FUNCTION t110_apc_check寫入apg_file段取消,因為後續確認段會再寫一次
# Modify.........: No:MOD-860221 08/06/27 By Sarah apb10應統一為apb24*apa14
# Modify.........: No:MOD-860251 08/06/27 By Sarah 匯率改變時,需重新計算沖帳視窗中的匯差
# Modify.........: No:MOD-860267 08/07/01 By Sarah t110_firm1_c_apv,t110_firm2_c_apv增加過濾條件apv03!='DIFF'
# Modify.........: No.MOD-860272 08/07/02 By Sarah 抓apf_file資料的SQL出現了AND aph04=g_apv[i].apv05條件,需改為AND apv05=g_apv[i].apv05
# Modify.........: No:FUN-860004 08/07/02 By xiaofeizhu aapt160 增加復制功能(只復制abp21為空的單身)
# Modify.........: No:MOD-870011 08/07/08 By Sarah 沖暫估做DIFF時，金額合計不等同此筆帳款金額時，卻仍可存檔
# Modify.........: No:MOD-870022 08/07/08 By Sarah 稅別格式若為22時,提示警訊即可,不控卡
# Modify.........: No:MOD-870029 08/07/08 By Sarah 多發票時,增加更新apkacti='Y',apkgrup=g_grup,apkuser=g_user,apkdate=g_today
# Modify.........: No:MOD-860303 08/07/08 By Sarah 單身若有採購單時,單頭金額不可大於單身金額
# Modify.........: No:MOD-860332 08/07/09 By Sarah 當使用大陸版且apa08='UNAP'時,不可執行待抵沖帳(offset_contra)action
# Modify.........: No.MOD-870109 08/07/11 By Sarah 單身無入庫單時,無須更新rvv_file
# Modify.........: No:MOD-830006 08/07/16 By jan   增加暫估資料金額的取位處理。
# Modify.........: No:MOD-870194 08/07/16 By Smapmin ora檔未轉換到
# Modify.........: No:MOD-870215 08/07/22 By Sarah 無單身時(期初暫估)應可修改單頭未稅金額
# Modify.........: No:MOD-870264 08/07/22 By Sarah mfg-043訊息前,增加判斷輸入的發票號碼是否存在amdi100且已確認,若沒有才顯示mfg-043
# Modify.........: No:FUN-860107 08/07/24 By sherry 當其單據性質之【傳票單別】非空白者,即可有ACTION 【拋轉總帳】及【傳票拋轉還原】功能
# Modify.........: No:TQC-870040 08/07/29 By chenyu g_ape數組超過48行時程序會出錯，現將數組改成DYNAMIC ARRAY
# Modify.........: No:MOD-870232 08/07/29 By Sarah 當發票格式為'XX'(不申報)時,統一編號可無須輸入
# Modify.........: No:MOD-880017 08/08/05 By Sarah 還原MOD-790038所改,l_nme.nme02還是帶入m_apa.apa02
# Modify.........: No.CHI-880003 08/08/06 By Sarah 抓azr_file的地方改抓azp_file
# Modify.........: No:MOD-880041 08/08/06 By Sarah CHI-850025只判斷匯率=1就檢核,增加判斷幣別也等於aza17才檢核
# Modify.........: No:MOD-880044 08/08/08 By Sarah 修改MOD-870232,判斷式改為IF g_apa.apa06='MISC' AND g_apk[i].apk171!='XX' THEN
# Modify.........: No:MOD-880101 08/08/13 By Sarah aapq230,aapq240查詢時,不需過濾傳票編號欄位(apa44)
# Modify.........: No.MOD-880103 08/08/18 By Sarah 當apa08不為MISC且apa06為MISC時,維護完apl_file資料後請回寫apa07
# Modify.........: No:MOD-880080 08/08/18 By Sarah 1.若為直接付款,應可修改非金額欄位
#                                                  2.直接付款先不更新apa35f,apa35,於確認後再更新
#                                                  3.將之前MOD-860245所MARK掉部分還原
# Modify.........: No:MOD-880144 08/08/22 By Sarah 檢查aap-779訊息,改用SUM(apc10)與apv04f比較,SUM(apc11)與apv04比較
# Modify.........: No:MOD-880181 08/08/22 By Sarah aapt210判斷單身有輸入暫估單(apb21)時才需檢核aapt260的資料
# Modify.........: No:MOD-880173 08/08/22 By Sarah 申報格式28時,統一編碼不應卡一定要輸入
# Modify.........: No:MOD-880146 08/08/26 By Sarah aapt121輸入多發票後,不管選擇何稅別,都不計算稅額(apk07/apk07f)
# Modify.........: No.MOD-880222 08/08/27 By Sarah 1.直接付款應在未確認時更新apa_file,MOD-880080增加之確認段更新apa35,apa35f做法需mark
#                                                  2.修正MOD-880017,l_nme.nme02應帶入m_apa.apa12
# Modify.........: No:FUN-880095 08/08/28 By xiaofeizhu apmq520呼叫aapt150時查詢單身是否有存在此張采購單號有存在時自動帶出
# Modify.........: No:FUN-880094 08/08/28 By sherry AP加參數 : 預付金額是否與采購單勾稽[1/2/3]Yes/No/依廠商
# Modify.........: No:MOD-880212 08/09/09 By Sarah 沖暫估視窗內的立帳本幣金額若已有重評價應取api05*apa72金額
# Modify.........: No:MOD-880231 08/09/09 By Sarah 沖帳資料依全額比較,sum相關沖帳金額與apc08,apc09比較,沖帳金額若大於時則提示錯誤訊息
# Modify.........: No:TQC-890010 08/09/09 By Sarah 由於沖暫估與直接付款不可同時做,故確認段CALL t110_ins_apg()段,只需處理UNAP的部分,t110_ins_apg()段l_apg.apg02給值方式還原成原作法
# Modify.........: No:MOD-890038 08/09/09 By Sarah 取消AFTER FIELD api26 DIFF多筆檢核判斷,但仍須控管帳款金額與沖暫估金額合計值需一致問題
# Modify.........: No:MOD-890084 08/09/09 By Sarah 沖暫估視窗在做科目允許/不允許部門的檢查時,應以api07,而非單頭的apa22
# Modify.........: No:MOD-890007 08/09/01 By chenl 若有衝暫估資料，則不可直接付款。
# Modify.........: No:MOD-890177 08/09/24 By Sarah aapt110若單身空白時需進入差異處理
# Modify.........: No:MOD-890227 08/09/25 By chenl 將MOD-860303功能切分成僅限台灣地區版本，大陸版本不使用該功能。
# Modify.........: No:MOD-890220 08/10/01 By Sarah 多借方視窗增加檢核,api04,api041(aza63='Y'時)不可為空值
# Modify.........: No:MOD-890281 08/10/01 By Sarah t110_ccc()與t110_ppp()段,檢查單號是否為NULL改寫成cl_null(s_get_serial_no(g_apa.apa01))
# Modify.........: No:MOD-890282 08/10/01 By Sarah aapt120單身apb21開窗的資料,應過濾單頭的付款廠商
# Modify.........: No:MOD-890213 08/10/01 By Sarah t110_chk()檢查只適用於台灣版,非台灣版就直接回傳1
# Modify.........: No:MOD-8A0004 08/10/01 By Smapmin 直接付款產生付款單單頭資料時,金額應抓取已沖金額
# Modify.........: No:MOD-8A0016 08/10/03 By Sarah 當借方科目二不是設定MISC時,在輸入部門時不需檢核api041不可為NULL
# Modify.........: NO.FUN-870037 08/10/06 by yiting  add nme26
# Modify.........: NO:FUN-890128 08/10/06 By Vicky 確認段_chk()與異動資料_upd()若只需顯示提示訊息不可用cl_err()寫法,應改為cl_getmsg()
# Modify.........: No:MOD-8A0051 08/10/06 By clover 單身輸入採溝單時,採購單項次只可為"2.轉成採購單"
# Modify.........: No:MOD-8A0079 08/10/08 By clover 修改本幣之後,不再回推原幣
# Modify.........: No:MOD-8A0129 08/10/16 By Sarah 確認時,判斷aap-030的判斷式不需扣除折讓金額(apa60)
# Modify.........: No:MOD-8A0139 08/10/17 By Sarah q_pmm902回傳值增加apb07
# Modify.........: No:MOD-8A0177 08/10/20 By Sarah 4933行判斷式增加()
# Modify.........: No:MOD-8A0188 08/10/21 By Sarah inv_no欄位開窗CALL q_apk02,需傳入g_qryparam.arg1 = g_apa.apa01,default1應為g_apa.apa08
# Modify.........: No:MOD-8A0220 08/10/24 By chenl 帶出對衝暫估金額時，應判斷該暫估單尚有余額是否滿足所要對衝的金額。
# Modify.........: No:TQC-860014 08/08/08 By chenl 1.增加手動分攤差異金額功能。
# Modify.........:                                 2.若無帳款單號，則不可使用差異處理功能按鈕。
# Modify.........: No:MOD-8A0212 08/10/29 By Sarah 檢核單別之apydmy3是否為'N',若為'N'才需要show_ref_c3帶出aapt330的傳票資料
# Modify.........: No:MOD-8A0213 08/10/29 By Sarah 若稅別為為不申報(gec05='X')時,無須檢核sub-005訊息
# Modify.........: No:FUN-8A0108 08/10/29 By xiaofeizhu aapq720呼叫aapt210時，管控某些action不顯示
# Modify.........: No:MOD-8A0266 08/10/30 By Sarah 當稅率改變時,若有發票資料需逐筆更新稅額與含稅金額
# Modify.........: No:FUN-8A0075 08/10/30 By jan   apa63 = 'S'，可再修改以下指定 位：
#                                                  單頭：apa51、apa511，apa54、apa541，apa52、apa521
#                                                  單身：apb26，apb25,apb251,apb27 
#                                                  可執行以下function:多發票，衝帳，衝暫估，直接付款，分錄底稿產生，分錄底稿
# Modify.........: No:MOD-8B0090 08/11/07 By chenl 直接付款退出時，應判斷單據是否已審核，若未審核再更新分錄底稿。
# Modify.........: No:MOD-8B0034 08/11/10 By Sarah aapt160也要增加判斷aap-328訊息
# Modify.........: No:TQC-8A0079 08/11/11 By Sarah 單價含稅時,含稅金額=含稅單價*計價數量
#                                                             未稅金額=含稅金額/(1+稅額)/100
#                                                  單價未稅時,未稅金額=未稅單價*計價數量
#                                                             含稅金額=未稅金額*(1+稅額)/100
# Modify.........: No:MOD-8B0149 08/11/14 By Sarah api05計算邏輯改為api05=api05f*apa14
# Modify.........: No:MOD-8B0164 08/11/20 By Sarah MOD-8A0212微調,當l_apydmy3!='N'時,LET g_apa.apa44=f_apa.apa44
# Modify.........: No:MOD-8B0170 08/11/20 By Sarah aapt210應同進貨發票,開放可以修改單頭稅額,且彈性2元差異
# Modify.........: No.MOD-8B0183 08/11/20 By Sarah 若此帳款為直接付款時,無須執行FOREACH zp_curs1,直接抓取apf_file,apg_file資料
# Modify.........: No.MOD-8B0224 08/11/21 By Sarah 若帳款類別為21,22,23,25時,無須執行FOREACH zp_curs2,直接抓取apf_file,apg_file資料
# Modify.........: No:MOD-8B0231 08/11/21 By wujie aapt150產生aapq230資料時借貸科目抓反了
# Modify.........: No:CHI-890017 08/11/24 By Sarah 回寫apa35時也需一併回寫apa73=apa34-apa35+g_net
# Modify.........: No:MOD-8B0266 08/11/25 By Sarah aapt150單身原幣單價、原幣金額欄位需做取位
# Modify.........: No:CHI-8B0055 08/11/27 By claire 取消確認時不需判斷來源單據pmm906='Y',因有可能是代採買
# Modify.........: No:MOD-8C0005 08/12/03 By sherry 在aapt210里面對折讓性質是‘2退貨折讓’的退貨立賬單應該需要檢查立賬日期apa02和單據日期rvv09是否在相同年月
# Modify.........: No:MOD-8C0009 08/12/03 By Sarah t110_show()段除了21,22類要顯示apa58外,26類也需顯示
# Modify.........: No:MOD-8C0016 08/12/03 By Sarah 沖暫估的本幣金額(api05),應以原幣金額(api05f)*暫估立帳匯率,若分次沖暫估,最後一次的本幣金額應以倒扣方式計算
# Modify.........: No:MOD-8C0020 08/12/04 By sherry 在aapt160里面立暫估的時候，金額與入庫單的金額不一致
# Modify.........: No:CHI-8C0005 08/12/09 By Sarah 當使用利潤中心時(aaz90=Y),CALL s_chkdept()允許/拒絕部門的判斷請改用成本中心
# Modify.........: No:MOD-8C0011 08/12/09 By Sarah 原先沖帳已輸入待抵帳款A01,單身修改為待抵帳款A02,卻沒將A01的已衝金額扣回
# Modify.........: No.MOD-8C0082 08/12/12 By Sarah t110_k()與t110_k_2()段對apc_file的寫入應一致
# Modify.........: No:MOD-8C0067 08/12/15 By Sarah 單據確認後,不會回寫到aapt160的已付金額(差異處理:5:沖期初開帳的暫估)
# Modify.........: No.TQC-8C0031 08/12/16 By sherry 由於共用問題判斷稅別問題,請增加 apb06 <> '' 時才需要抓取 pmm_file 
# Modify.........: No:MOD-8C0221 08/12/23 By Sarah t110_diff_rtn()段需判斷apydmy3='Y'才問axr-309
# Modify.........: No:MOD-8C0224 08/12/23 By Sarah t110_set_no_entry_b()段,將CALL cl_set_comp_entry("apb12,apb27,apb09,apb28,apb25,apb251,apb26",FALSE)這行mark掉
# Modify.........: No:MOD-8C0272 08/12/26 By clover 改 IF g_smy.smy59 <> 'Y' =>IF cl_null(g_smy.smy59) or g_smy.smy59 = 'N'  
# Modify.........: No:FUN-8C0106 09/01/05 By jamie 依參數控管,檢查會科/部門/成本中心 AFTER FIELD 
# Modify.........: No:MOD-910014 09/01/05 By Nicola 數量為0 時，api05/api05f直接帶暫估金額
# Modify.........: No:MOD-910044 09/01/06 By Nicola 加上cl_null的判斷
# Modify.........: No:MOD-910021 09/01/08 By chenl  t110_bud()抓取apy檔。
# Modify.........: No:MOD-910020 09/01/08 By chenl 增加SQL條件,apg03=g_plant.
# Modify.........: No:TQC-8C0076 09/01/09 By clover mark #ATTRIBUTE(YELLOW)
# Modify.........: No:MOD-910094 09/01/09 By Nicola AFTER FIELD apb09 的 IF l_gec07='Y' THEN 修改為 IF l_gec07='Y' AND (g_aptype = '11' OR g_aptype = '16' ) THEN
# Modify.........: No:MOD-910069 09/01/09 By Nicola AFTER FIELD api05f 計算 l_apa34f 並未分辨若為 aapt260 的暫估(apa00 = '26')應需在 * -1
# Modify.........: No:MOD-910086 09/01/12 By wujie 更改單身入庫單時，檢查rvv87-rvv23-rvv88 >0
# Modify.........: No:MOD-910098 09/01/13 By Sarah t110_apb22_21()段,應增加判斷g_aptype='26'
# Modify.........: No:MOD-910109 09/01/13 By Sarah 單身的成本中心需不需要輸入的檢查點,應與部門一致
# Modify.........: No:FUN-880113 09/01/15 By jan 如為多帳期才能維護"多帳期"功能鍵帶出畫面的資料，否則只能DISPLAY 不能MODIFY
# Modify.........: No:MOD-910161 09/01/15 By Sarah aapt150單身帶入採購單資料時，並未帶出專案編號欄位
# Modify.........: No:MOD-910170 09/01/15 By Sarah 將aap-344判斷段取消
# Modify.........: No:MOD-910181 09/01/16 By Sarah aapt160存檔後,再變更幣別時,本幣金額會全為零,原幣稅額也會為零
# Modify.........: No:MOD-910062 09/01/20 By Nicola 倉退單 數量若為 0 時不需要與已請款數量比較
# Modify.........: No.MOD-910197 09/01/22 By Sarah 將t110_r()段INSERT azo_file移到COMMIT前
# Modify.........: No:MOD-910249 09/01/22 By Sarah 新增時不需default傳票日期(apa43)
# Modify.........: No:MOD-920013 09/02/02 By sherry 如果單價含稅，算未稅單價時先取位再除于稅率 
# Modify.........: No:MOD-920034 09/02/03 By Sarah 當pmb05為NULL時default值應給予100
# Modify.........: No:MOD-920052 09/02/03 By wujie 判斷a56！=0時才會在差異處理后詢問是否產生分錄底稿
# Modify.........: No:MOD-920102 09/02/07 By Sarah 按"直接付款"時,當單據確認碼不為Y時,CALL t110_apc_check需傳w,確認碼為Y時傳''
# Modify.........: No:FUN-920077 09/02/10 By sabrina 當aaps100參數設定為apz59='N'時，
#                                                    單身b25、b26、apb930、gem02c、apb21、apb22的欄位名稱要能正常的顯示
# Modify.........: No:MOD-920170 09/02/16 By Sarah 當執行aapt150時,單身科目apb25應default成單頭的借方科目,當單頭借方科目為NULL時,應開放單身科目輸入
# Modify.........: No:MOD-920182 09/02/16 By Smapmin 維護完多發票金額後,詢問是否重新產生分錄
# Modify.........: No:MOD-920252 09/02/20 By Sarah rvv87-rvv23<=0才卡aap-782訊息
# Modify.........: No:MOD-920352 09/02/26 By Sarah t110_b()段結束前,CALL t110_sum_apa()這行拿掉
# Modify.........: No:MOD-920359 09/02/26 By Smapmin 傳票編號顯示有誤
# Modify.........: No.MOD-920381 09/03/02 By Sarah 當刪除單身沖暫估資料時,應一併刪除api_file資料
# Modify.........: No:MOD-920382 09/03/02 By Sarah 為避免誤按沖暫估視窗維護,增加判斷,若無單身資料時,不可開啟沖暫估視窗
# Modify.........: No:CHI-930001 09/03/04 By Sarah 差異處理選擇5.沖期初開帳暫估時,不論單頭借方科目是否為UNAP、單身是否有資料,只要有差異都應可選則開帳暫估資料
# Modify.........: No:CHI-930014 09/03/05 By Sarah 取消MOD-860203增加計算21,22,26類的apa12,apa64功能
# Modify.........: No:MOD-930072 09/03/06 By shiwuying 沖暫估單身不應納入一起分攤
# Modify.........: No:MOD-930030 09/03/10 By Sarah 當暫估數量已全數沖完時,api05f金額直接default暫估的金額
# Modify.........: No:TQC-930073 09/03/11 By chenl aapt160/aapt260稅種開窗只顯示不申報的稅種.
# Modify.........: No:MOD-930169 09/03/18 By Sarah t110_api_unap()計算api05時應比照t110_ppp(),應抓取暫估單aapt160的重評價匯率apa72來計算
# Modify.........: No:MOD-930266 09/03/25 By chenl 匯率*原幣應取小數位后再與本幣進行比較。
# Modify.........: No:MOD-930245 09/03/26 By Sarah 預付請款檢查時採購單單價*計價數量所計算出來的金額未依幣別取位
# Modify.........: No:MOD-940008 09/04/02 By Sarah p_zz有勾選可修改key,aapt110修改完單據編號,存檔失敗
# Modify.........: No:MOD-940069 09/03/07 By lilingyu 當是否直接拋磚總帳='Y'時,才可調用s_chknpq 
# Modify.........: No:MOD-940079 09/03/07 By lilingyu 確認時,aapt210折讓類別為2/3,單身發票編號不可空白,如單頭稅別apa15的發票聯數='X',不需檢查
# Modify.........: No:MOD-940090 09/04/08 By lilingyu 未異動apc13
# Modify.........: No:MOD-940158 09/04/11 By Sarah t110_copy()段,當aapt160複製時,不需清空apa08 
# Modify.........: No.MOD-940178 09/04/13 By Sarah t110_b()結束後,CALL t110_ddd1()重寫apk_file
# Modify.........: No:MOD-940213 09/04/15 By lilingyu 將MOD-8B0183的修改段增加條件apz26
# Modify.........: No:CHI-940018 09/04/15 By lilingyu 修改多輸入發票資料時,單身寫法改成逐筆存入資料庫
# Modify.........: No:MOD-940223 09/04/15 By lilingyu 將TQC-630164這張單修改要回寫apa07段mark掉
# Modify.........: No:MOD-940239 09/04/21 By lilingyu 單頭匯率調整后,詢問是否更新單身金額時,應一并重算衝暫估的DIFF
# Modify.........: No:MOD-940358 09/04/27 By Sarah SQL裡少個","
# Modify.........: No:MOD-940297 09/04/23 By chenl    若為aapt260和aapt160時，稅率應為零稅率。
# Modify.........: No.TQC-940171 09/04/28 By Sarah 當不走重評價時,沖暫估(api_file)裡的本幣金額應該用暫估單的匯率算出,目前會用立帳的匯率來算本幣金額
# Modify.........: No:MOD-940381 09/04/28 By lilingyu 延續MOD-910094修改,增加g_aptype的條件
# Modify.........: No.MOD-940392 09/04/30 By Sarah t110_firm2()段,刪除apc_file的語法在IFX環境有誤
# Modify.........: No:MOD-940411 09/05/04 By Sarah 修改單價(apb23)時,若單身有輸入採購單(apb06,apb07),則需判斷修改的單價不可高於採購單價(pmn31)
# Modify.........: No:MOD-940326 09/05/04 By Sarah t110_b()段,檢核科目+部門為允許/拒絕部門控制寫法修改
# Modify.........: No:TQC-950004 09/05/05 By wujie 多借方界面中，換不同的分攤方式會報錯
# Modify.........: No:MOD-940416 09/05/05 By lilingyu 當aapt160仍有未衝余額時,在衝暫估未確認前,aaot120可以輸入一筆以上的資料(其總額>aapt160可衝余額) 
#                                                    凡是在aapt120能新增的資料,就可以確認,導致aapt120衝暫估金額大于apt160可衝暫估余額
# Modify.........: No:MOD-950045 09/05/06 By lilingyu CALL t110_apa05(p_cmd),若l_pmc05='0'時,LET g_errno='aap-032' 
# Modify.........: No:TQC-940178 09/04/29 By Cockroach 跨庫SQL一律改為調用s_dbstring() 
# Modify.........: No:MOD-950058 09/05/07 By Sarah 修正MOD-940411,應只針對26類卡修改單價不可超過採購單價
# Modify.........: No:TQC-910032 09/05/07 By Sarah 當apz59=N時,aapt120單身的apb12欄位的抬頭應顯示"品號"
# Modify.........: No:MOD-950138 09/05/13 By lilingyu 檢核mfg-011訊息前,判斷當稅別不為不申報時才檢核
# Modify.........: No:MOD-950112 09/05/13 By Sarah 需判斷是從什麼地方進入t110_ddd(),若是修改段CALL過來,則BEFORE ROW不需再做LOCK單頭Table,若不是則要LOCK單頭Table
# Modify.........: No:MOD-950158 09/05/15 By lilingyu t110_apb22_11(),t110_apb22_12(),t110_apb22_21()三段一開始都需要增加檢核輸入的入庫/倉退單是否有立暫估,
# ...................................................若有暫估資料但該資料未確認,則需提示訊息aap-118
# Modify.........: No:FUN-930165 09/05/15 By jan MISC料件改抓請購單單頭的部門(pmk13)
# Modify.........: No:MOD-950177 09/05/18 By lilingyu 調整只要為MISC開頭的料件,單身部門就捉取請購部門
# Modify.........: No:TQC-950113 09/05/19 By wujie   衝帳后apv04和apv04f為0的資料都刪除
#                                                    衝帳時帳款編號開窗可開出待扺借支款資料
# Modify.........: No.MOD-950226 09/05/21 By Sarah 多發票刪除單身某一筆發票後再輸入一次,應該是新增,卻變成UPDATE,造成錯誤,畫面增加顯示項次,處理apk_file的SQL條件增加apk02
# Modify.........: No:MOD-950284 09/05/27 By Smapmin 使用利潤中心功能又做預算控管時,會一直卡在會計科目的欄位
#                                                    確認段的預算控管沒有功用
# Modify.........: No:FUN-950053 09/05/26 BY ve007 廠商基本資料的關系人設定搭配異動碼彈性設定
# Modify.........: No:MOD-960026 09/06/03 By baofei 原判斷IF g_aptype = '15' AND g_aza.aza26 != '2' THEN改為IF g_aptype = '15' AND g_aza.aza26 != '2' AND (g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y')) THEN
# Modify.........: No:TQC-960012 09/06/03 By xiaofeizhu 3.立應付時,若發票種類為'T'或'A'時,應該由含稅金額推算未稅金額.未稅金額=含稅金額*(1-稅率)
# Modify.........: No.MOD-960010 09/06/03 By Sarah 修改單頭稅別後會重新寫入apc_file,但最後放棄修改時,卻沒將apc_file重新產生
# Modify.........: No:TQC-960021 09/06/04 By xiaofeizhu 修改aapt120錄入“借方科目二”后，沒能帶出“借方科目二名稱”的問題
# Modify.........: No:MOD-960059 09/06/04 By baofei g_aptype=12時apa08不可為空
# Modify.........: No:MOD-960095 09/06/06 By Sarah AFTER FIELD apb23段計算單價含稅金額時,應增加判斷11,16,21,26類別才抓rvv38t重算
# Modify.........: No:MOD-940329 09/06/08 By Carrier 倉退數量判斷修改
# Modify.........: No.MOD-960119 09/06/09 By Sarah 修正MOD-960010,當新增放棄時不需重新產生apc_file
# Modify.........: No:MOD-960128 09/06/10 By Sarah 修正MOD-950226,t110_inv()段改用g_apk1
# Modify.........: No:MOD-960106 09/06/12 By baofei修改t100_ddd()段CALL t110_apz08()的條件                                          
# Modify.........: No:MOD-960121 09/06/12 By baofei 付款廠商apa06開窗由 q_pmc1改成a_pmc 
# Modify.........: No:MOD-960152 09/06/11 By xiaofeizhu 衝暫估時部門錄入的管控修改
# Modify.........: No:FUN-950094 09/06/11 BY yiting g_aptype= '13'時將稅額相關欄位加回畫面
# Modify.........: No:FUN-960117 09/06/16 By Duke GP5.1 EBO整合追版
# Modify.........: No:MOD-960264 09/06/24 By Sarah 當單頭輸入稅別(apa15)之發票聯數(gec05)為4或X時,aapt120的發票欄位(apa08)允許不輸入
# Modify.........: No:MOD-960266 09/06/24 By Sarah t110_api_unap()段在計算暫估未沖金額時,應抓暫估單單身金額才對
# Modify.........: No:MOD-960280 09/06/24 By Sarah 沖帳檢查錯誤訊息aap-779，本幣金額應以重估後的金額apc13做判斷才合理
# Modify.........: No:CHI-960074 09/06/24 By Sarah 新增完aapt160單頭要進入單身前,增加提示aap-166訊息
# Modify.........: No:MOD-960302 09/06/25 By Sarah 需檢查12/13/16/22/23/25類帳款是否存在成本分攤單據中,若有不允許取消確認
# Modify.........: No:MOD-960328 09/06/26 By Sarah 當輸入單身帶出暫估單資料時,本幣單價與本幣金額應以單頭匯率重算
# Modify.........: No:TQC-960424 09/06/30 By cockroach aapt220等按查詢后再按修改后馬上按放棄，會報錯
# Modify.........: No.MOD-960329 09/06/30 By Sarah 在INSERT INTO apg_file前,先檢查pag05/apg05f是否為Null,若是則default為0
# Modify.........: No:CHI-910035 09/06/30 By Sarah 一張採購單可能預付多次,aapt150需增加檢核預付是否已經超過採購單金額
# Modify.........: No:MOD-970040 09/07/06 By Sabrina 當aza26=2時，單身的發票號碼在輸入完退貨單號和項次後要自動帶出
# Modify.........: No:MOD-970049 09/07/06 By Sabrina 預付時，以pmn31t來做卡關 
# Modify.........: No:MOD-970065 09/07/08 By wujie   更改時，運輸發票的稅別應輸入含稅金額自動轉為未稅金額+稅額
# Modify.........: No:MOD-970061 09/07/09 By Sarah 檢查入庫/倉退單對應的收貨單若已有發票,就不可再產生暫估/退貨暫估
# Modify.........: No:CHI-910036 09/07/13 By baofei修改api06先抓ahb04,若ahb04為NULL，再抓apa25                                      
# Modify.........: No.CHI-910032 09/07/13 By baofei 修改若單頭不為MISC(表示為單一發票)，先將apk_file刪除，再重新產生                
#                                                   修改單身單頭金額不一致時單身累加回寫單頭                                        
# Modify.........: No:MOD-970101 09/07/13 By wujie  廠商DM審核時不需要檢查待扺衝帳
# Modify.........: No:MOD-970111 09/07/13 By baofei apa08為‘MISC’時修改單頭稅別和稅率后，不要重算單頭的金額欄位
# Modify.........: No:MOD-970115 09/07/14 By baofei 1.t110_api_diff()搬至 apa56為5的判斷之后
#                                                   2.t110_firm1_chk()段，arm-034的判斷條件增加apa56<>'5'                      
# Modify.........: No:FUN-970008 09/07/13 By douzh  大陸版列印需要兩個ACTION明細表(aapr129)和應付憑証(aapr111)
# Modify.........: No:MOD-970145 09/07/16 By baofei 1.t110_ddd_c()段拿掉ORDER BY 
#                                                    2.修改ON ROW CHANGE UPDATE apb_file改為apk_file
#                                                    3.t110_ddd()拿掉ORDER BY  
# Modify.........: No:TQC-970144 09/07/17 By baofei  修改MOD-970145
# Modify.........: No:MOD-970173 09/07/20 By sabrina aapt160單身異動類別若為空白時，應仍可算出合計金額
# Modify.........: No:MOD-970179 09/07/20 By sabrina (1)異動帳款日期或付款廠商後，apc04的應付款日並沒有被更新到
#                                                    (2)apa02異動後還未按確定前又在異動一次時，apa12並不會依最新的apa02日期來做異動
# Modify.........: No:TQC-970195 09/07/21 By Carrier '15'單據時,單身科目二default方式同單身科目一
# Modify.........: No:MOD-970197 09/07/22 By mike 請款單在axrt400衝帳后,在aapt120右邊衝帳查詢點開后目前是查不到資料的,
#                                                 應該要可以查詢的到axrt400衝銷的資料.
# Modify.........: No:MOD-970213 09/07/23 By mike 點選[留置]出現詢問視窗后,無輸入選擇直接點選[放棄],應不可進入輸入留置原因碼. 
# Modify.........: No:MOD-970220 09/07/23 By mike aapt160與aapp115稅別開窗邏輯仍不一致,
#                                                 aapt160 after field稅別欄位的控管邏輯應與aapp115一致,
#                                                 加控管aap-977與aap-008
# Modify.........: No:MOD-970221 09/07/23 By mike FUNCTION t110_copy()段,在清空apa08時,也應一并清空apa09
# Modify.........: No.FUN-950056 09/07/27 By chenmoyan 去掉ima920
# Modify.........: No:TQC-970296 09/07/28 By xiaofeizhu 單別未設定拋轉憑証時,點擊“會計分錄生成”功能鈕,系統無反應,增加相關的提示信息.
# Modify.........: No.FUN-960038 09/07/30 By chenmoyan 專案加上'結案'的判斷
# Modify.........: No.MOD-980002 09/08/03 By mike FUNCTION t110_account_period()段,l_apc13/l_apc14/l_apc15請改成用ARRAY
# Modify.........: No.MOD-980029 09/08/04 By mike FUNCTION t110_ins_nme(),改成LET l_nme.nme02=m_apa.apa02
# Modify.........: No:MOD-980030 09/08/05 By Sarah 詢問aap-336前,增加判斷單身是否有沖暫估資料,若有則不更新單頭金額
# Modify.........: No:MOD-980032 09/08/05 By Sarah 修正CHI-910035,比較預付金額有沒有超過原採購單金額,應該以aapt150單頭金額來比較
# Modify.........: No:MOD-970278 09/08/06 By Sarah 檢核aap-210時,應考量沖帳的單據,若原先預付時有稅額應扣除
# Modify.........: No:CHI-930020 09/08/13 By hongmei增加1.發票輸入時檢查字軌;2.發票為2/3聯檢查
# Modify.........: No:TQC-980068 09/08/12 By xiaofeizhu 隱藏aapq231會計資料頁簽中的貸方科目欄位
# Modify.........: No:MOD-980141 09/08/18 By Sarah 當apz27='N'時,輸入完發票號碼(apa08)欄位程式會當掉
# Modify.........: No:MOD-980148 09/08/18 By sabrina 當付款日期apa12有變動時，允許票期及票到期日也要跟著變動 
# Modify.........: No:MOD-980218 09/08/27 By mike 取消確認前請先重新讀取單頭檔
# Modify.........: No:FUN-970108 09/08/21 By hongmei add apa77申報統編
# Modify.........: No:CHI-990015 09/09/07 By Sarah aapt120當單身料號為MISC*時,帶出料件主檔的會科到單身的科目(apb25),當科目要做部門管理時,自動帶單頭的部門到單身部門(apb26)
# Modify.........: No:FUN-990017 09/09/08 By Carrier 去掉 "待扺衝帳"功能
# Modify.........: No:MOD-990058 09/09/10 By sabrina 單頭匯率(apa14)取出後不需取位
# Modify.........: No:FUN-990014 09/09/08 By hongmei先抓apyvcode申報統編，若無則將apz63的值寫入apa77/apk32
# Modify.........: No.MOD-990125 09/09/14 By mike 若已做直接付款,后續有再調整單頭資料時,會將apc_file已付金額又歸零
# Modify.........: No:MOD-990130 09/09/14 By mike 一待扺預付132-09090001分兩次衝帳,若衝帳方式不同,會檢查錯誤.
# Modify.........: No:FUN-990053 09/09/16 By hongmei s_chkban前先檢查aza21 = 'Y'
# Modify.........: No:MOD-990132 09/09/16 By mike  aapt160  查詢　時,在稅別　^p 居查到銷項的稅別．請控制，僅能查到進項　且　不申報,的稅別．
# Modify.........: No:MOD-990155 09/09/16 By mike aapt151 借支單維護作業，在修改單頭時，AFTER FIELD apa31f后，會卡在 原幣 借款 的欄位上，
#                                                 錯誤訊息為aap-937 不可超過原采購單金額
# Modify.........: No:FUN-990025 09/09/16 By hongmei add b32
# Modify.........: No:MOD-990174 09/09/18 By mike FUNCTION t110_u()段,CALL t110_i()后,當放棄后應該不用UPDATE單身
# Modify.........: No:MOD-990177 09/09/21 By mike FUNCTION t110_ddd()段最后,加上 OR g_apz.apz08='2'
# Modify.........: No:MOD-990188 09/09/21 By aapt160作廢時不考慮有發票號碼UNAP 
# Modify.........: No:MOD-990200 09/09/22 By mike 1.使用多帳期時,於多帳期維護輸入留置金額,單頭無留置原因碼
#                                                 2.點選留置,若無輸入123選項按確定,應視為放棄return
# Modify.........: No.MOD-990239 09/09/25 By mike 當FUNCTION t110_apz08(),要回寫帳款單頭檔apa_file時,判斷若稅額l_apa32不為0,
#                                                 需以apa15到稅別檔(gec_file)抓取稅額科目gec03,將gec03寫入到稅額科目apa52
# Modify.........: No:CHI-990056 09/09/27 By hongmei 修改BEFORE FIELD apa77
# Modify.........: No:MOD-990248 09/09/28 By mike FUNCTION t110_k()的AFTER INPUT段,l_amt的計算修改
# Modify.........: No:MOD-990250 09/09/28 By mike FUNCTION t110_cs(),apb25與apb251的開窗,請改成用q_aag
# Modify.........: No:MOD-9A0032 09/10/08 By sabrina 系統沒檢查預付請款總額是否超過採購單總額 
# Modify.........: No:MOD-9A0051 09/10/08 By sabrina 多發票視窗匯率修改後，要將重算後的金額顯示到畫面上 
# Modify.........: No:TQC-9A0015 09/10/08 By sabrina 第二套帳分錄產生有問題 
# Modify.........: No:TQC-9A0017 09/10/09 By Sarah CALL s_chkban()應傳入統一編號
# Modify.........: No:MOD-9A0070 09/10/09 By Sarah 發票號碼輸入MISC,進入多發票維護完資料回到單頭時,發票號碼欄位會變回舊值
# Modify.........: No.MOD-9A0075 09/10/12 By mike FUNCTION t110_pay_record(),IF g_aptype MATCHES '2*' THEN段,增加抓取apg_file資料
# Modify.........: No:MOD-9A0085 09/10/14 By mike FUNCTION t110_apb22_21(),當g_aptype = '21'且g_apa.apa58 = '3'時,會檢查資料是否存在aapt260,
#                                                 若在aapt260找不到,請再到倉退單找,若倉退單也沒有,才顯示aap-091并RETURN
# Modify.........: No:MOD-9A0093 09/10/14 By mike 當aapt1210確認時,當稅別是不申報時,且無對應采購單時,即不check發票資料,即不應出現aap-052的錯誤訊息!
# Modify.........: No.MOD-9A0100 09/10/15 By mike aapt110差異處理選擇折讓時,aapt210產生的apc_file,已付金額均為0
# Modify.........: No:TQC-9A0086 09/10/15 By liuxqa 控管匯率不可小于零。
# Modify.........: No:TQC-9A0087 09/10/15 By xiaofeizhu 稅率控管為不可小于零.
# Modify.........: No:MOD-9A0109 09/10/16 By mike 系預付費用之請款，根本沒有采購單，怎麼還要控管不能超過采購單
# Modify.........: No:MOD-9A0113 09/10/16 By mike FUNCTION t110_b(),AFTER FIELD apb24,
#                                                 當單身有輸入apb07(采購單項次),請先抓取apb06+apb07在aapt150已預付過多少金額,這次可預付的金額不可>采購單項次金額-已預付金額
#                                                 當單身沒輸入apb07(采購單項次),請先抓取apb06在aapt150已預付過多少金額,這次可預付的金額不可>采購單總金額-已預付金額
# Modify.........: No:MOD-9A0135 09/10/21 By mike FUNCTION t110_b(),AFTER FIELD apb24與AFTER INPUT段,會檢核apb24<=0的話需卡關,
# Modify.........: No:TQC-9A0119 09/10/23 By Sarah 應判斷apz14或g_aza.aza21為Y再搭配CALL s_chkban()判斷統一編號的正確性
# Modify.........: No:MOD-9A0143 09/10/23 By mike 在aapt110維護單身資料時，單身采購單的幣別必須與單頭的幣別相同，                   
#                                                 在輸入完入庫單號項次后，如果不管aap-041的錯誤訊息，直接按確定的話，可以避過幣別的>
#                                                 造成單頭幣別與單身采購單據幣別不符的情況。 
# Modify.........: No:MOD-9A0145 09/10/23 By mike 產中12區DS1單號121-09100005，點選發票資料，在廠商統一編號欄位后，程式會當掉。     
# Modify.........: No:MOD-9A0147 09/10/23 By mike 暫估產生api時, FUNCTION t110_api_unap(), 撈取aapt110/aapt120已確認衝暫估金額應加條
# Modify.........: No.MOD-9A0155 09/10/26 By sabrina 多發票, lock cursor串apl_file導致FETCH不到資料,  t110_ddd_c()
# Modify.........: No:MOD-9A0188 09/10/29 By Sarah t110_ddd_c()段算完l_tot1f,l_tot2f,l_tot3f後請增加將之顯示出來
# Modify.........: No:MOD-9A0201 09/11/02 By Sarah aapt120雜項輸入時,稅別若為內含,輸入原幣單價後應為含稅單價,需回推為未稅單價
# Modify.........: No:MOD-9B0001 09/11/03 By Sarah aapt210/aapt220列印時,報表apa08說明應顯示參考單號,明細應顯示退貨單號而非入庫單號
# Modify.........: No:MOD-9B0048 09/11/09 By Sarah 若同一張採購單在單身輸入多筆(可能是輸入不同的項次)時,應該只能SUM一次單頭金額,否則會重複
# Modify.........: No:MOD-9B0050 09/11/09 By sabrina 修改MOD-990130的調整 
# Modify.........: No:MOD-9B0054 09/11/10 By sabrina 單身若有修改金額，沖暫估的金額也要一併變更 
# Modify.........: No:MOD-9B0089 09/11/13 By Sarah 輸入完apa06後,若非MISC需重帶apa07
# Modify.........: No:MOD-9B0150 09/11/24 By wujie 衝帳時若原幣衝完，應直接帶出本幣
#                                                  匯差的計算方式調整，若衝帳原幣=立賬原幣，則取兩者本幣的差異 
# Modify.........: No:MOD-9B0168 09/11/25 By Sarah aapt220應可同aapt120微調單頭的稅額
# Modify.........: No:MOD-9B0190 09/11/30 By Sarah aapt150輸入發票號碼後應檢查是否有重覆輸入
# Modify.........: No:MOD-9B0200 09/11/30 By Sarah 大陸版輸入多發票時，無法按確定離開
# Modify.........: No:MOD-9B0202 09/11/30 By Sarah 大陸版輸入多發票應是以原幣*匯率算出本幣,離開前不需再以本幣/匯率回算原幣
# Modify.........: No:MOD-9B0203 09/11/30 By Sarah 大陸版輸入完多發票金額欄位後應取位
# Modify.........: No:MOD-9C0012 09/12/02 By sabrina apa08新增判斷條件：apa08是MISC且為1*類帳款才不可入單頭金額 
# Modify.........: No:MOD-9C0085 09/12/08 By Sarah FUNCTION t110_j(),算完apb14與apb14f後需取位
# Modify.........: No:CHI-9C0015 09/12/15 By Sarah 當參數設定預付金額輸入需與採購單勾稽時,控管輸入金額不可超過採購單的含稅金額
# Modify.........: No:MOD-9C0145 09/12/16 By Sarah 計算預付金額時,需先清空變數值
# Modify.........: No:MOD-9C0148 09/12/16 By Sarah 修改完發票日期後,也應該CALL s_paydate()重算付款日與票到期日
# Modify.........: No:MOD-9C0252 09/12/19 By sherry  l_api03_a[i]改為l_api03_a[i].api03
# Modify.........: No:MOD-9C0416 09/12/28 By Sarah 大陸版做aap-151檢核時,不需過濾apk171條件
# Modify.........: No:MOD-9C0437 09/12/28 By sabrina aapt210新增"發票資料"按鈕 
# Modify.........: No:MOD-9C0342 09/12/29 By Sarah t110_ddd()的BEFORE FIELD apk02,寫到DISPLAY g_apk[i].apk02 TO apk02與DISPLAY g_apk[i].apk03 TO apk03,請mark掉
# Modify.........: No:MOD-9C0356 09/12/29 By Sarah CALL s_apkchk()前,請先將g_msg變數清空
# Modify.........: No:MOD-9C0444 09/12/30 By Sarah 修正當aza26<>'2'時才做CHI-930020的發票檢核
# Modify.........: No:MOD-9C0457 09/12/31 By Sarah 預付單身輸入金額判斷是超過原採購單金額時,應判斷有輸入採購單者才需檢查
# Modify.........: No:MOD-9C0454 09/12/31 By Sarah 大陸版做aap-037檢核時,apk171增加XX條件
# Modify.........: No:MOD-9C0264 10/01/05 By sabrina 單身的"部門"欄位應依"科目"欄位判斷是否需做控卡
# Modify.........: No:MOD-9C0267 10/01/05 By sabrina 若aza63<>'Y'則不需判斷apa511的條件 
# Modify.........: No:MOD-9C0334 10/01/06 By sabrina 若單身apb06有值則串回採購單抓取pmm22(幣別)，若與apa13不同則不可確認 
# Modify.........: No:MOD-A10055 10/01/11 By liuxqa 多帳期衝賬時，衝賬資料重復。
# Modify.........: No:TQC-A10146 10/01/21 By Sarah 將MOD-9A0201修改段移除
# Modify.........: No:MOD-A10127 10/01/22 By sabrina 營運中心是台灣時才判斷稅籍 
# Modify.........: No:MOD-A10129 10/01/22 By sabrina 更改apa31f，確認後值並沒有被更新 
# Modify.........: No:MOD-A10133 10/01/25 By Sarah 修改完單身後應將金額累加至單頭
# Modify.........: No:MOD-A20009 10/02/02 By wujie 大陸版時，不同年月未立暫估單的入庫單不能使用
# Modify.........: No:MOD-A20091 10/02/23 By sabrina 若已有設定留置金額，再去做日期修正後，會將apc16留置金額歸零 
# Modify.........: No.FUN-9B0098 10/02/24 by tommas delete cl_doc
# Modify.........: No:MOD-A20108 10/02/26 By sabrina 在雜項應付使用直接付款，選"8"預付，帳款單號選aapq230單據
#                                                    之後aapt120將單據刪除，aapq230多帳期金額並沒扣回 
# Modify.........: No:MOD-A20113 10/03/01 By sabrina 倉退單不可存在於別張帳款中 
# Modify.........: No:TQC-A30003 10/03/01 By sabrina 修改MOD-A20091的錯誤
# Modify.........: No:MOD-A30008 10/03/02 By sabrina "FOR UPDATE NOWAIT"只能串一個table，兩個table時會有錯 
# Modify.........: No:MOD-A30045 10/03/09 By sabrina 當apz61=2時，單身的單價及金額要可維護 
# Modify.........: No:MOD-A30046 10/03/09 By sabrina 修改A20113
# Modify.........: No:MOD-A30059 10/03/12 By sabrina 將apb06_cs的IF g_apa.apa31f > l_pmm40t - l_apa31f THEN判斷式移到foreach外判斷
# Modify.........: No:TQC-A30072 10/03/15 By Carrier 申報統編apa77 若用戶修改,則以用戶修改為准,不得再將默認設定值賦值
# Modify.........: No:TQC-A30076 10/03/16 By Carrier "多發票"后,若apz59 = 'N'時,要即時將多發票資料顯示于單身中
# Modify.........: No:TQC-A30079 10/03/16 By Carrier 1.多發票錄入完后更新帳款金額 設定為 3.不更新 時,要開放單頭未稅/稅額字段
#                                                    2.多發票錄入完后更新帳款金額 設定為 2.詢問&詢問為不更新/3.不更新,則不做update 單頭apa各金額的動作
#                                                    3.大陸版時,MOD-9B0200修改的緣故,導致無法對發票做更新,更新會失敗
# Modify.........: No:MOD-A30113 10/03/16 By sabrina 抓取預算(aglt600)時應以期別角度抓取，不應以當年度年月抓取預算
# Modify.........: No:MOD-A30084 10/03/17 By sabrina 原先有設定留置，執行差異處理後在按確認會出現aap-129錯誤訊息
# Modify.........: No:MOD-A30142 10/03/19 By sabrina 當差異折讓時寫入apk175應改為NULL 
# Modify.........: No:MOD-A30140 10/03/23 By sabrina 大陸版多發票apk03可以不需輸入
# Modify.........: No:TQC-A30133 10/03/25 By Carrier '多借方'action時,若借方科目非'MISC'時,給提示信息
# Modify.........: No:MOD-A30208 10/03/26 By sabrina 單頭留置金額變更後，子帳期apc16也要變更
# Modify.........: No:MOD-A30209 10/03/26 By sabrina FUNCTION t110_ins_apc中，若l_apa20為null，就給予0 
# Modify.........: No:FUN-A30106 10/03/29 By wujie   增加憑証聯查功能
# Modify.........: No:MOD-A30230 10/03/29 By sabrina 無論apz61的值為何，單身的單價與金額都要可以修改
# Modify.........: No:CHI-A30023 10/03/31 By sabrina aapt260單身可不需輸入退貨單+項次 
# Modify.........: No:MOD-A30248 10/03/31 By sabrina (1)當apz61='1'或apz61='3'單身清空時，單頭金額也要清空
#                                                    (2)單身採購單金額檢核應扣除其他筆單筆資料
# Modify.........: No:CHI-A40005 10/04/06 By Summer  1.重新開放多發票視窗,僅修改稅額(apk07/apk07f),不可新增與刪除
#                                                    2.此多發票視窗需檢核稅額金額須等於單頭原幣稅額與本幣稅額  
# Modify.........: No:TQC-A40058 10/04/12 By lilingyu 先進入"原幣金額 原幣稅額"未給值,然后再次進入,給值后,稅額科目apa52未帶出值
# Modify.........: No:MOD-A40078 10/04/15 By Smapmin 多角貿易帳款必須要由批次整批產生,不能由各站自已登打(中斷點除外)
# Modify.........: No.FUN-A40041 10/04/19 By wujie     g_sys->AAP 
# Modify.........: No.CHI-A10006 10/04/19 By Summer 寫入api_file段,若原幣金額加總為剩餘未沖原幣金額,
#                                                   則本幣金額也應全數沖完,將尾差調在金額最大的一筆上
# Modify.........: No:MOD-A40103 10/04/20 By sabrina 帳款金額<>發票金額時，差異處理apa56並未顯示為1:待處理
# Modify.........: No:MOD-A40102 10/04/20 By sabrina (1)FUNCTION t110_apb07(p_cmd)增加判斷
# Modify.........: No:TQC-A40102 10/04/21 By xiaofeizhu 錄入時幣別自動帶本位幣
# Modify.........: No:TQC-A40106 10/04/22 By xiaofeizhu aaps100中的"雜項請款單身錄入MISC資料"之參數,只針對aapt120進行控管,不應該對aapt121也進行控管
# Modify.........: No:TQC-A40107 10/04/22 By xiaofeizhu aapt151增加判斷單頭和單身金額是否一致
# Modify.........: No:CHI-A30035 10/04/28 By sabrina 沖帳畫面按確定後，單頭沖帳金額有誤
# Modify.........: No:MOD-A50005 10/05/03 By sabrina aapt120執行多發票，若無資料存在或是新增狀況下按"放棄"後 ，程式會整個關掉
# Modify.........: No:MOD-A40184 10/05/04 By sabrina 變更單頭日期，單頭匯率變動時，單身本幣金額沒有跟著變動 
# Modify.........: No:MOD-A50011 10/05/06 By sabrina MOD-A20108多增加三個條件，aph03='6'、'7'、'9'
# Modify.........: No:MOD-A50086 10/05/13 By sabrina FUNCTION t110_copy()中l_apa.apainpd應等於g_today 
# Modify.........: No:MOD-A50098 10/05/17 By Dido 1.複製時,日期調整應重算付款日與票到期日 2.計數單身有誤 
# Modify.........: No:MOD-A50152 10/05/24 By sabrina 大陸版在更新狀態下-調整單頭發票欄位(apa08)為MISC -->維護多發票資料--> 
#                                                    回主畫面--> 按放棄
#                                                    此時多發票資料已寫入,但aapt110發票資料欄位不是MISC的 
# Modify.........: No:MOD-A50180 10/05/26 By Dido 發票號碼檢核問題調整 
# Modify.........: No:MOD-A50183 10/05/27 By wujie  判斷aap-918前更新apa相關欄位數值
# Modify.........: No:CHI-A50042 10/05/28 By Summer 開放可調整多帳期中有多筆資料的日期修正
# Modify.........: No:FUN-A40036 10/06/01 By xiaofeizhu aapt120中的apa07欄位管控的調整 
# Modify.........: No:MOD-A60004 10/06/07 By Dido 預收單身控制問題
# Modify.........: No:MOD-A60078 10/06/10 By Dido aapt120 單身不可輸入有入庫單的暫估單
# Modify.........: No:MOD-A60095 10/06/14 By Dido aapt120 員工簡稱應符合 10 位輸入原則 
# Modify.........: No:MOD-A60115 10/06/18 By Dido 單身放棄控制調整 
# Modify.........: No:CHI-A50028 10/06/18 By Summer 程式增加 aqaconf <> 'X' 判斷
# Modify.........: No:MOD-A70003 10/07/02 By Dido 若單身部門已有值不可再被覆蓋 
# Modify.........: No:MOD-A70006 10/07/05 By Dido aapt150 單頭 apa58 無須顯示 
# Modify.........: No:MOD-A70037 10/07/05 By Dido 新增待抵時 apc16 應為 0 
# Modify.........: No:MOD-A70048 10/07/06 By Dido 當 MISC* 抓取不到時再用 MISC 資料 
# Modify.........: No:MOD-A70095 10/07/13 By Dido 沖帳的 DIFF 改用差異數更新方式 
# Modify.........: No:MOD-A70116 10/07/15 By sabrina 單頭留置金額(apa20)為0時，多帳期留置金額應要為0 
# Modify.........: No.MOD-A70122 10/07/19 By sabrina 暫估資料api_file若存在apb_file，則不可修改金額
# Modify.........: No:MOD-A70153 10/07/20 By Dido 差異處理增加 tansation 架構 
# Modify.........: No:MOD-A70158 10/07/21 By sabrina 從aapt150轉到aapq230時，apa19應給空白，apa20應該0 
# Modify.........: No:MOD-A70214 10/07/29 By Dido aapt120 單身若有對應暫估,則 apa57 會被清空 
# Modify.........: No:TQC-A70123 10/07/29 By xiaofeizhu 修改點擊"直接付款"退出界面BUG
# Modify.........: No:MOD-A70229 10/07/30 By Dido 自動請款折讓產生時如為不申報抓取其他折讓應過濾屬於 apa00 = '2*',發票輸入時應增加不申報狀態 
# Modify.........: No:MOD-A80051 10/08/06 By Dido 單身限制應依循整體參數為主 
# Modify.........: No:MOD-A80052 10/08/09 By Dido 若為運輸發票(gec05='T')時,稅額與未稅金額邏輯調整 
# Modify.........: No:CHI-A80008 10/08/10 By Summer 作廢時刪除發票資料,單身資料,單頭金額清為0 
# Modify.........: No:MOD-A80069 10/08/10 By Dido 差異處理應維持原處理狀態 
# Modify.........: No:MOD-A80093 10/08/11 By Dido 大陸版由於apb24/apb10金額已依入庫項次維護在gapi140中,因此不可再重算 
# Modify.........: No:MOD-A80103 10/08/12 By wujie apb25/apb251預設ima39的判斷去除12的限制
# Modify.........: No:MOD-A80123 10/08/16 By wujie aapq231還款查詢不到
# Modify.........: No:TQC-A80101 10/08/19 By xiaofeizhu apb21處的判斷增加apa00=26的情況
# Modify.........: No:MOD-A80159 10/08/23 By Dido aapt210 apa15稅別異動後應更新apk11
# Modify.........: No:MOD-A80204 10/08/25 By Dido aapt110 單頭異動日期應檢核單身入庫單月份 
# Modify.........: No:MOD-A80208 10/08/26 By Dido aapt210 作廢;拋轉傳票;傳票拋轉還原增加權限控管 
# Modify.........: No:MOD-A80217 10/08/27 By Dido 沖帳差異改用一致的 FUNCTION 處理 
# Modify.........: No:TQC-A80186 10/08/31 By Dido 沖帳預設 apv04 邏輯調整
# Modify.........: No:MOD-A90022 10/09/06 By Dido aapt210 單身品號無法預設帶出問題改善
# Modify.........: No:MOD-A90089 10/09/13 By Dido 還款頁簽僅限於 aapt121 使用 
# Modify.........: No:MOD-A90094 10/09/14 By Dido apb25會預設apb26,在檢核預算時如有錯誤需跳至apb26 
# Modify.........: No:CHI-A80031 10/09/20 By Summer 整批確認時,其他單號的資料也需檢查
# Modify.........: No:MOD-A90146 10/09/23 By Dido aapt120 單身暫估金額需檢核是否有超額問題 
# Modify.........: No:MOD-A90181 10/09/29 By Dido apz61 為否時,單身為 memo 性質不檢核採購資訊 
# Modify.........: No:MOD-AA0027 10/10/06 By Dido 沖帳單據不可為原單據 
# Modify.........: No:MOD-AA0035 10/10/08 By Dido 不申報則不檢核發票編號重複問題 
# Modify.........: No:CHI-A90037 10/10/11 By Summer 增加apa00='26'的資料 
# Modify.........: No:MOD-AA0061 10/10/12 By Dido aap-816 檢核應排除 '22' 資料 
# Modify.........: No:MOD-AA0105 10/10/18 By Dido 廠商異動後,apa15舊值需清空 
# Modify.........: No:MOD-AA0116 10/10/20 By Dido aapt210 折讓類別'3'時,倉退單只維護計價數量,刪除帳款時無法回寫 rvv23  
# Modify.........: No:MOD-AA0120 10/10/20 By Dido 1.差異處理時,判斷原狀態為 '1' 則改變為 '0',其他狀態維持不變 
#                                                 2.沖暫估抓取匯率異常 
# Modify.........: No:MOD-AA0187 10/10/28 By Dido apa20與sum(apc16)不同時才需重算apc16;確認後若為留置應可維護apc16
# Modify.........: No:MOD-AB0038 10/11/04 By Dido 複製時匯率問題
# Modify.........: No:CHI-AA0028 10/11/04 By Summer 原先有卡apydmy5='Y'時apb31(費用原因)不可為Null,請將此卡關拿掉
# Modify.........: No:MOD-AB0069 10/11/08 By Dido 複製後匯率異動重新計算單頭與單身本幣金額
# Modify.........: No:MOD-AB0117 10/11/12 By Dido aapt121 當無未付金額時不可修改日期 
# Modify.........: No:MOD-AB0132 10/11/15 By Dido 預算計算函式進入前需判斷會科是否有預算控管
# Modify.........: No:MOD-AB0133 10/11/15 By Dido apa58 只須於 aapt210/220 顯示 
# Modify.........: No:CHI-AB0017 10/11/16 By Summer 允許票期為負數時加提示訊息
# Modify.........: No:MOD-AB0162 10/11/16 By Dido 多帳期視窗若 g_hold 為 null 則為 DISPLAY 
# Modify.........: No:MOD-AB0167 10/11/17 By Dido 進入 t110_chkapb24 僅限 g_aptype為12時檢核 
# Modify.........: No:MOD-AB0201 10/11/24 By Dido 倉退單檢核排除自身帳款 
# Modify.........: No:TQC-AB0084 10/11/26 By Summer 修正CHI-A80031,26471行訊息誤寫成aap-087,應改回aap-807 
# Modify.........: No:MOD-AB0256 10/11/30 By Dido 若自定義修改 apc08/apc09 後應更新 apc13
# Modify.........: No:MOD-AC0034 10/12/03 By wujie 原幣衝完暫估后，剩余的本幣都歸入最后一筆
# Modify.........: No:MOD-AC0066 10/12/09 By Dido 若已確認時,提示詢問並自動重新產生 
# Modify.........: No:MOD-AC0101 10/12/13 By Dido 當輸入稅別(apk11)之發票聯數(gec05)為4或X時,aapt120的發票欄位(apk03)允許不輸入
# Modify.........: No:MOD-AC0116 10/12/14 By Dido set entry 控制調整 
# Modify.........: No:MOD-AC0130 10/12/15 By wujie 單身call b_fill()參數調整
# Modify.........: No.MOD-AC0124 10/12/16 By Dido 折讓產生發票時,若 apk_file 不存在再抓取 amd_file 
# Modify.........: No:MOD-AC0128 10/12/16 By Dido 產生折讓時 apa171 需轉換
# Modify.........: No:MOD-AC0237 10/12/20 By Dido apa37/apa37f/page5 僅 aapt121 使用,其他不可顯示 
# Modify.........: No:MOD-AC0268 10/12/23 By Dido aapt210 確認時再增加檢核稅額與多發票稅額是否相同 
# Modify.........: No.MOD-AC0328 10/12/27 By Dido 寫入 azo_file 應以實際程式代號為宜 
# Modify.........: No:TQC-AC0367 10/12/28 By yinhy 點選"審核"按鈕程序down出
# Modify.........: No:MOD-B10013 11/01/03 By Dido 調整 luck cursor 位置 
# Modify.........: No:MOD-B10011 11/01/04 By Dido control + o 帶出後無法直接儲存 
# Modify.........: No:MOD-B10016 11/01/04 By Dido 會科尚未輸入直接 RETURN 
# Modify.........: No:MOD-B10041 11/01/06 By Dido aapp400 增加參數 gl_summary = 'Y' 
# Modify.........: No:MOD-B10061 11/01/07 By Summer FUNCTION t110_ddd(),BEFORE ROW的BEGIN WORK請還原 
# Modify.........: No:CHI-B10017 11/01/10 By Summer 將大陸版的稅別欄位開放 
# Modify.........: No:MOD-B10070 11/01/11 By Dido 發票若已有輸入則不需再清空 
# Modify.........: No:TQC-B10096 11/01/12 By Dido 調整大陸版多發票 luck cursor 位置 
# Modify.........: No:MOD-B10093 11/01/13 By Dido 多借方 api35/api36 欄位控制調整 
# Modify.........: No:MOD-B10104 11/01/14 By Dido 大陸版稅別選擇後需預設稅率 
# Modify.........: No:MOD-B10191 11/01/24 By Dido 統一編號增加訊息提示 
# Modify.........: No:MOD-B10211 11/01/26 By Dido 費用暫估無須更新入庫資料 
# Modify.........: No:CHI-B10042 11/01/28 By Summer 將upd()段判斷狀況碼要為1.已核准才可以確認的段落往上搬到chk()段 
# Modify.........: No:MOD-B10239 11/01/28 By Dido 調整確認段顯示應付金額問題 
# Modify.........: No:MOD-B20017 11/02/09 By Dido 產生折讓時,發票日期抓取調整 
# Modify.........: No:CHI-B20007 11/02/11 By Summer 修正CHI-A80008
#                                                   aapt121與aapt151因為單身沒有前端單據的問題,故不需將單身刪除
#                                                   aapt120單身若apb21有值的話,就需要刪除單身,若apb21為空值時就不需將單身刪除
# Modify.........: No.MOD-B20046 11/02/15 By Dido 取消確認時若為預付帳款則檢核aqb_file應以待抵帳款檢核
# Modify.........: No:MOD-B20082 11/02/18 By Dido axr-065 應僅限11/16/21/26檢核 
# Modify.........: No:TQC-B20109 11/02/23 By Dido 相關使用 FOREACH 給 g_apb 部分都少了自訂欄位 
# Modify.........: No:MOD-B20137 11/02/24 By Dido 費用數量不做倒扣,直接給予 1 
# Modify.........: No:MOD-B20152 11/02/25 By Dido 確認段預算檢核邏輯調整 
# Modify.........: No:CHI-B30009 11/03/07 By Sarah CALL t110_bu()前需確保先抓到g_apb04/g_apb05/g_apb04_t/g_apb05_t等變數值
# Modify.........: No:MOD-B30233 11/03/16 By Dido g_apa.apa19為空時才重新賦予值apz12
# Modify.........: No:MOD-B30179 11/03/18 By Sarah aapt150輸入時若挑選有稅率的稅別,需卡發票號碼不可空白
# Modify.........: No:MOD-B30183 11/03/18 By Sarah 金額不可為0的卡關改為提示就好,不然從aapp110拋過來單價為0的資料都會被卡住
# Modify.........: No:MOD-B30578 11/03/18 By Sarah 當執行aapt160然後跑到FUNCTION t110_apb22_11()的話,大陸版apb24與apb10的值會是Null
# Modify.........: No:MOD-B30622 11/03/21 By Dido t110_duplicate 無須再檢核發票合理性,因已在t110_invoice_chk檢核 
# Modify.........: No:MOD-B30663 11/03/24 By Dido 訊息 app-053 改為 aap-053 
# Modify.........: No:MOD-B30214 11/03/24 By abby 當apk171(格式)<>'XX'時,apk03與apk04不可空白
# Modify.........: No:MOD-B30691 11/03/29 By Sarah 台灣當發票格式為零稅不申報時發票號碼可以不輸入,大陸版也應如此處理
# Modify.........: No:MOD-B40050 11/04/08 By Sarah FUNCTION t110_21_ins2()裡apa171的CASE判斷式請調整的跟MOD-AC0128其他修改段一樣
# Modify.........: No:MOD-B40036 11/04/11 By Dido 若 transaction 失敗時,變數也需還原回原資料  
# Modify.........: No:MOD-B40070 11/04/12 By Sarah apb21的開窗需判斷apb29,故改為用q_rvv2
# Modify.........: No:MOD-B40086 11/04/14 By Dido 檢核多發票稅額移至輸入後檢核 
# Modify.........: No:MOD-B40108 11/04/14 By Dido apa00 = '13' 多發票時不申報可不用輸入發票 
# Modify.........: No:MOD-B40087 11/04/18 By Dido 沖暫估DIFF預設科目為匯兌損益科目 
# Modify.........: No:MOD-B40115 11/04/19 By Sarah 當apa171=28或29時,不做t110_chk()的檢查
# Modify.........: No:MOD-B40117 11/04/20 By Sarah 確認段預算檢查(t110_budchk->t110_bud_s)耗用金額重複計算
# Modify.........: No:MOD-B40183 11/04/21 By wujie 多發票維護時，原幣稅前金額沒有按幣種截位
#                                                  更改帳款類型，科目名稱沒有刷新
# Modify.........: No:MOD-B40252 11/04/27 By Sarah 當apa171<>'XX'時,應控卡apa18不可空白
# Modify.........: No:MOD-B40261 11/04/28 By wujie apz61 =1時，aapt150單身采購單號必輸
# Modify.........: No:MOD-B50017 11/05/04 By Dido 沖帳查詢資料需刪除空白行資料 
# Modify.........: No:CHI-B50012 11/05/06 By Sarah 單身加入可查詢apb12與apb27
# Modify.........: No:MOD-B50143 11/05/17 By Dido t110_apz08 增加 apa37 
# Modify.........: No:MOD-B50183 11/05/20 By Dido apa18/apk04 空白控卡應排除格式為 28/29 
# Modify.........: No:MOD-B50190 11/05/21 By Dido 取消確認段若格式為22且發票聯數為收據者不控管 aap-666  
# Modify.........: No:MOD-B50218 11/05/25 By Dido 新舊值邏輯調整 
# Modify.........: No:MOD-B50228 11/05/26 By Dido 抓取第一筆傳遞參數有誤 
# Modify.........: No.MOD-B50235 11/05/27 By Dido aapt210 異動 apa08 時不可刪除 apk_file 
# Modify.........: No:MOD-B50242 11/05/27 By Dido aapt121 有直接付款時無法取消確認
# Modify.........: No:MOD-B50255 11/05/30 By Dido 沖暫估單身部分應帶立暫估部門資料 
# Modify.........: No:FUN-B50105 11/05/23 By zhangweib 講aaz88的範圍修改成0~4 添加aaz125設定5~8的異動碼數
# Modify.........: No:CHI-820005 11/06/03 By zhangweib 檢查發票號碼是否有重複時,應多判斷已存在的發票資料其發票日期年度是否為今年,若是的話才卡住.
# Modify.........: No:MOD-B60016 11/06/03 By Dido 大陸版無須檢核 aap-212  
# Modify.........: No.MOD-B60066 11/06/09 By Dido 沖帳後 apc_file 相關金額調整  
# Modify.........: No:TQC-B60206 11/06/20 By Dido FUNCTION ins_apc 調整 apc08/apc09 需含沖帳金額 
# Modify.........: No:MOD-B60156 11/06/20 By Dido apa05 在單身無參考單號時開放允許修改 
# Modify.........: No:TQC-B60291 11/06/22 By Sarah 修正MOD-B60066
# Modify.........: No:MOD-B60218 11/06/24 By Sarah aapt121規還借款的計算有誤
# Modify.........: No:MOD-B60221 11/06/25 By Sarah 修正MOD-B60066,FUNCTION t110_ins_prepaid()計算apa31f,apa31,apa34f,apa34等值不需要扣掉apa65f,apa65
# Modify.........: No.CHI-B60066 11/06/30 By Sarah 刪除nme_file的SQL增加nme22的條件
# Modify.........: No:MOD-B70053 11/07/07 By JoHung 修改MOD-B50190，將格式為'XX'的也不納入判斷
# Modify.........: No:MOD-B70047 11/07/07 By Dido 多帳期視窗增加 apc14/apc15 顯示
# Modify.........: No:CHI-B70013 11/07/13 By Sarah 預付輸入單身資料時,開放數量欄位可以做調整
# Modify.........: No:MOD-B70119 11/07/14 By Dido 差異分攤若分攤比率金額太小時,差異金額調整在最大筆或依筆數平均分攤 
# Modify.........: No:MOD-B70180 11/07/19 By Sarah 沖帳DIFF的算法,應該是(apa31+apa32)-apv04
# Modify.........: No:MOD-B70202 11/07/22 By Polly 當異動立帳日期(afa02)時,在 t110_apa13 會重新給予匯率(apa14),增加判斷若與原匯率不同時,重新計算本幣金額
# Modify.........: No:CHI-B60063 11/07/27 By Sarah 確認時若碰到應付金額=0的資料,增加詢問"應付金額為0,是否確定執行確認(Y/N)?"
# Modify.........: No:TQC-B80049 11/08/03 By Sarah 修正MOD-B70202,應該判斷單身資料筆數>0才以單身金額回寫單頭
# Modify.......... No.MOD-B70280 11/07/29 By Polly 相關使用到 aag_file 部分，增加 aagacti = 'Y' 條件
# Modify.........: No.MOD-B80015 11/08/02 By Polly 將IF l_gec05 != 'X' THEN 改為 IF l_gec05 NOT MATCHES '[4X]' THEN
# Modify.........: No.TQC-B70131 11/08/05 By Dido aapt160 刪除時若單身無入庫單則不需更新 rvv_file 
# Modify.........: No:MOD-B80127 11/08/16 By johung 修正刪除項次後直接輸入採購單號無法帶出資料
# Modify.........: No:MOD-B80165 11/08/16 By johung 修正單頭借貸方科目為NULL時未清空說明
# Modify.........: No.MOD-B80053 11/08/04 By Polly 當aapt210單身有異動(新增、修改、刪除)時就要CALL t110_21_ins2()重新產生apk_file的資料
# Modify.........: No:MOD-B80193 11/08/22 By Dido 單身異動確認單頭更新有誤 
# Modify.........: No:MOD-B80300 11/08/27 By Dido 多發票視窗回寫需對留置金額再重新檢核 
# Modify.........: No.MOD-B80345 11/08/31 By Polly after FIELD apb22提示錯誤訊息aec-009後應NEXT FIELD apb22
# Modify.........: No:MOD-B80140 11/08/16 By polly 增加判斷，如果入庫未稅金額小於預付未稅金額，則不用做稅額計算
# Modify.........: No:MOD-B80060 11/09/05 By Vampire 修正l_dbs_new所組出來的字串會為「dsds.」造成-206錯誤
# Modify.........: No.MOD-B90002 11/09/02 By Polly 修正apc14與apc15沒有寫入沖帳金額
# Modify.......... No.MOD-B90020 11/09/05 By Polly aapt160多帳期應維持一筆，調整判斷apc_file不可修改
# Modify.........: No.MOD-B90056 11/09/08 By Dido aapt120 沖暫估應只能有一筆
# Modify.........: No.MOD-B90115 11/09/15 By Polly 錯誤訊息aap-945增加檢核判斷
# Modify.........: No.MOD-B90110 11/09/15 By Polly 複製前給予 apa173/aoa174/apa175 為 null
# Modify.........: No.MOD-B90164 11/09/23 By Polly 1.增加檢核axr-177，無發票不可手動立應收
#                                                  2.調整api05f、回寫aapt260已沖金額計算
# Modify.........: No.MOD-B90194 11/09/26 By Polly 增加FUNCTION t110_apb07的l_apb24條件apa00 = '15'
# Modify.........: No.CHI-B80054 11/09/28 By Polly 新增時，CALL s_paydate前面判斷，此欄位的舊值是否為 NULL OR 新舊值不同，才需要重算的方式處理
# Modify.........: No.CHI-B80023 11/09/28 By Polly 取消採購單必要欄位控制
# Modify.........: No.MOD-BA0132 11/10/19 By Polly aap-273錯誤訊息條件調整
# Modify.........: No.MOD-BA0173 11/10/25 By Polly 判斷apa12為NULL時，才抓取g_apa.apa02
# Modify.........: No.MOD-BA0189 11/10/30 By Dido 新增輸入段給予帳別改在 BEFORE INPUT 
# Modify.........: No.MOD-BB0099 11/11/08 By jt_chen 修改AFTER INPUT中的aap-761錯誤訊息
# Modify.........: No.MOD-BB0106 11/11/10 By Polly 增加傳票還原失敗錯誤訊息aap-929
# Modify.........: No.MOD-BB0121 11/11/14 By Polly 大陸地區調整統一編號(apk04)為不必填欄位
# Modify.........: No.MOD-BC0102 11/12/15 By Polly 增加控管，aapt150不可使用多借方資料
# Modify.........: No.MOD-BC0140 11/12/15 By Polly  修正新增時無法放棄，無法跳出迴圈
# Modify.........: No:MOD-C10214 12/02/02 By Polly 調整順序，先show出錯誤訊息後再RETURN
# Modify.........: No:MOD-C20048 12/02/08 By Polly 修正進入多發票段lock cursor但未close cursor
# Modify.........: No.MOD-C20104 12/02/10 By Dido 沖暫估時,重評價金額比較差異,金額調整在最大筆中 
# Modify.........: No:CHI-C20003 12/02/21 By Polly 將確認後為自動拋轉傳票移至FOREACH t110_firm1_c3迴圈處理
# Modify.........: No:CHI-C10043 12/02/24 By Polly 週六週日遇到上班日，需增加詢問是否要移至非假日
# Modify.........: No.MOD-C20206 12/02/24 By Polly 修正單頭匯率時需重寫api_file的值
# Modify.........: No:MOD-C30063 12/03/08 By Polly 單別設定為不拋轉傳票時，直接付款後不需產生分錄底稿
# Modify.........: No:MOD-C30896 12/03/29 By Polly 調整aec-009判斷式，原則上21類與26類別都只能存在一筆
# Modify.........: No:MOD-C30916 12/04/02 By Polly 單頭調整匯率時，多發票也需一併調整
# Modify.........: No:MOD-C40158 12/04/20 By Elise 點選【日期修改】鈕修改【付款日】無法同時修改「多帳期維護」內的【應付款日】欄位資訊
# Modify.........: No.MOD-C40155 12/04/24 By Polly 多借方分攤時，增加帳別條件；aglt1101畫面增加aba00欄位
# Modify.........: No.MOD-C40225 12/05/07 By Elise 並未再次判斷發票聯數，只檢查了採購單號
# Modify.........: No.TQC-C50047 12/05/14 By xuxz 修改l_sql中字段順序
# Modify.........: No:MOD-C50093 12/05/17 By Polly 1.呼叫 aapp400 動作,移到 COMMIT WORK 後處理
#                                                  2.呼叫aap400所產生的傳票編號改用匯總訊息顯示
# Modify.........: No.MOD-C50035 12/05/24 By Elise 單身與多發票總金額一致
# Modify.........: No.CHI-C30002 12/05/31 By yangtt 離開單身時若單身無資料提示是否刪除單頭資料
# Modify.........: No.MOD-C50228 12/05/31 By Polly 調整沖暫估，修改單頭匯率後，產生的DIFF金額異常
# Modify.........: No.MOD-C50242 12/05/31 By Polly 發票已補滿金額，需將留置金額清空
# Modify.........: No.MOD-C50243 12/06/01 By Polly g_success = 'Y'時，才做拋轉；取消清訊息功能
# Modify.........: No.MOD-C40218 12/06/11 By Elise 回追MOD-C20206，FUNCTION t110_ppp 中,AFTER FIELD api26 取消更新 api05f/api05 動作,應以單身為計算為主
# Modify.........: No.MOD-C60060 12/06/11 By Elise 新增aapt120，取消確認apc13欄位值無回寫為0
# Modify.........: No.CHI-C30107 12/06/21 By yuhuabao  整批修改將確認的詢問窗口放到chk段的前面
# Modify.........: No.MOD-C70161 12.07/16 By Polly 差異處理方式調整如不選擇，將它預設為1待處理狀態
# Modify.........: No.TQC-C70079 12/07/25 By lujh aapt120沖帳時,回寫apa和apc表時要一致
# Modify.........: No.MOD-C70268 12/07/27 By Polly aapt110_n 呼叫子畫面，改用cl_ui_locale()
# Modify.........: No.TQC-C70027 12/07/30 By lujh 錄入apa06廠商為MISC雜項類的單據，apa07的開窗查詢的內容不對，
#                                                 應該開窗查詢所有未衝銷完畢的待抵預付/待抵溢付的MISC廠商的簡稱，目前系統查詢員工檔q_gen
# Modify.........: No.TQC-C60241 12/07/31 By lujh 暫估退貨單aapt260單身料件的數量比退貨單apmt722料件的數量多
# Modify.........: No.TQC-C60104 12/07/31 By lujh 當廠商簡稱更改后，要提示與分錄底稿中的不一致
# Modify.........: No.TQC-C80061 12/08/09 By lujh FUNCTION t110_ins_apc(m_apa)內所有用到g_apa的變數,應改用m_apa較為合理
# Modify.........: No.MOD-C60170 12/08/09 By Polly 開窗選沖暫估單時，同廠商才可互沖 
# Modify.........: No.FUN-C80078 12/09/03 By Abby  Service CALL FUNCTION t110_c()調整
# Modify.........: No.TQC-C90065 12/09/12 By lujh "aap-227"報錯信息有誤
# Modify.........: No.TQC-C90078 12/09/17 By lujh 自動產生分錄時加上apa58=1的判斷
# Modify.........: No.MOD-C90206 12/09/24 By Polly 調整是否可執行「差異處理」的功能條件
# Modify.......... No.TQC-B90062 12/10/31 By Elise 在aapp110拋轉時會因為判斷發票金額為 0 時不寫入apk_file建議將此部分開放寫入
# Modify.........: No:MOD-CA0049 12/10/08 By Polly after field apb24段增加處理，若屬於沖暫估且匯率為1時更新api05
# Modify.........: No:MOD-CA0106 12/10/18 By Polly 1.單據複製時，若單別未設定自動編碼，需檢核單據編碼
#                                                  2.調整複製時，選完日期後才取號存入
# Modify.........: No:MOD-CA0147 12/10/23 By Polly 增加控卡，單據類別為15時，科目不可使用STOCK
# Modify.........: No.TQC-CB0071 12/11/21 By xuxz mod 17--》20
# Modify.........: No.TQC-CC0035 12/12/07 By zhangweib by zhangweib:修改saapt110.4gl中1.AFTER FIELD apk172報錯後的NEXT FIELD
#                                                                                     2.修改AFTER FIELD apk172、apk07的l_tax小數取位
# Modify.........: No.TQC-D10016 13/01/05 By yangtt 錄入時，【稅率】不可以修改
# Modify.........: No.FUN-CC0142 13/01/11 By Nina 來源類型(apa79)原本3:HRM新流程;4:HRM舊流程，調整為N:HRM新流程;O:HRM舊流程
# Modify.........: No.TQC-D10065 13/01/16 By Polly 調整s_chknpq控卡條件 
# Modify.........: No.MOD-CC0238 13/01/17 By Polly 增加控卡廠商/員工資料檢核；調整apa06若為MISC則開啟雜項廠商，EMPL則開啟員工編號
# Modify.........: No.MOD-D10165 13/01/07 By Polly 付款方式非與發票日有關者，不需再重算apa12/apa64值
# Modify.........: No.MOD-D10210 13/01/23 By Polly 多發票本幣金額調整後需DISPLAY，以致可跑AFTER ROW存入資料
# Modify.........: No.CHI-D10057 13/01031 By Lori 將MOD-CC0238 修改處 控卡的pmc14 = '2' 條件移除
# Modify.........: No.MOD-D20103 13/02/20 By Polly 調整沖帳本幣金額、原幣金幣顯示
# Modify.........: No.TQC-CB0066 13/02/25 By zhangweib t110_invoice_chk 增加傳遞 apk28 參數
#                                                      於 t110_invoice_chk 函式中如 aza26 為 2 時,l_n1/l_n2 增加 apk28 條件
# Modify.......... No.MOD-D20174 13/03/01 By Polly 取消針對MISC雜項廠商需存在pmc_file控卡
# Modify.........: No.MOD-D30078 13/03/11 By Polly 調整16/26類沖暫估apb24金額抓取條件
# Modify.........: No.MOD-D40014 13/04/02 By Lori 補充多發票資料稅別修改時記錄舊值
# Modify.........: No:FUN-D70132 13/08/07 BY Elise 屬於HRM產生的AP資料，需控卡不允許重新產生分錄，若User需異動，可至分錄底稿手動維護
# Modify.........: No:MOD-D90164 13/09/29 By yinhy 增加判斷0：開立時才可調整多賬期
# Modify.........: NO.MOD-DA0157 13/10/23 By lutingting 拋轉憑證段應有提示可列印
# Modify.........: No:FUN-E30020 14/03/18 By Rayhu 來源類型為'N'為HR拋入之資料於刪除段加入控卡"apa79=N 單據來源為HRM,不可由TIPTOP直接刪除!"(aws-457)
# Modify.........: No:FUN-D30066 14/07/30 By yihsuan 1.增加撤銷簽核/會科修改 action
#                                                    2.已簽核未確認時,控卡不可執行更改/刪除/作廢功能
#                                                    3.多發票/多借方/直接付款 action 不要更新 apa63=已核准 狀態
#                                                    4.執行撤銷簽核時, 還原狀況碼為0.開立
#                                                    5.執行會科修改時,開啟新視窗,預設帶主畫面與科目有關的資料,異動後再更新主畫面並重新詢問產生分錄
# Modify.........: No.FUN-G10012 16/01/27 By yihsuan 25 格式 + BB 開頭時, 則不做第1到8碼檢查
# Modify.........: No.FUN-G70013 16/08/19 By Yixiong 當g_aptype='12'且有跟HRM整合時且為HR拋轉過來的AP資料,則不允許修改本幣未稅(apa31)、原幣未稅(apa31f)欄位

DATABASE ds

GLOBALS "../../config/top.global"
GLOBALS "../4gl/saapt110.global"   #FUN-C80078

#FUN-C80078 mark str---
#將變數挪至saapt110.global
#DEFINE
##   g_azi           RECORD LIKE azi_file.*,       #原幣幣別 record   #MOD-6B0066  #FUN-870037 
##   t_azi           RECORD LIKE azi_file.*,       #本幣幣別 record   #MOD-6B0066
#   g_aps           RECORD LIKE aps_file.*,
#   g_apa           RECORD LIKE apa_file.*,       #
#   g_apv           RECORD LIKE apv_file.*,       #
#   g_apv_t         RECORD LIKE apv_file.*,       #
#   g_apx           RECORD LIKE apx_file.*,       #No.FUN-690080
#   g_apx_t         RECORD LIKE apx_file.*,       #No.FUN-690080
#   m_apa           RECORD LIKE apa_file.*,       #
#   m_aph           RECORD LIKE aph_file.*,
#   g_apa_t         RECORD LIKE apa_file.*,       #
#   g_apa_o         RECORD LIKE apa_file.*,       #
#   g_apa01_t       LIKE apa_file.apa01,   #AP #     (舊值)
#   g_apa_rowid     LIKE type_file.chr18,     #ROWID  #No.FUN-690028 INT # saki 20070821 rowid chr18 -> num10 
#   g_apb_sarrno    LIKE type_file.num5,      # No:FUN-690028 SMALLINT,              #螢幕變數的個數
#   g_apb           DYNAMIC ARRAY OF RECORD   #程式變數(Program Variables)
#              apb02      LIKE apb_file.apb02,
#              apb33      LIKE apb_file.apb33, #No.FUN-690080
#              apb11      LIKE apb_file.apb11,
#              apb29      LIKE apb_file.apb29,
#              apb21      LIKE apb_file.apb21,
#             #FUN-810045 移至apb36後
#              #apb31      LIKE apb_file.apb31, #FUN-630055
#              #apb30      LIKE apb_file.apb30, #No.FUN-690080
#             #FUN-810045 end
#              apb22      LIKE apb_file.apb22,
#            # rvv40      LIKE rvv_file.rvv40,   #FUN-680110 add  #No.TQC-7B0083
#              apb34      LIKE apb_file.apb34,   #FUN-680110 add  #No.TQC-7B0083
#              apb01_unap LIKE apb_file.apb01,   #FUN-680110 add
#              apb06      LIKE apb_file.apb06,
#              apb07      LIKE apb_file.apb07,
#              apb12      LIKE apb_file.apb12,
#              apb27      LIKE apb_file.apb27,
#              apb09      LIKE apb_file.apb09,
#              apb28      LIKE apb_file.apb28,
#            #FUN-810045 begin
#              apb35      LIKE apb_file.apb35, 
#              apb36      LIKE apb_file.apb36, 
#              apb31      LIKE apb_file.apb31, 
#            # apb30      LIKE apb_file.apb30,  #No.FUN-830161
#            #FUN-810045 end
#              apb32      LIKE apb_file.apb32, #No.FUN-690080
#              b32        LIKE gen_file.gen02, #FUN-990025
#              apb25      LIKE apb_file.apb25,
#              b25        LIKE aag_file.aag02,  #FUN-710078 add
#              apb251     LIKE apb_file.apb251, #FUN-680029
#              b251       LIKE aag_file.aag02,  #FUN-710078 add
#              apb26      LIKE apb_file.apb26,
#              b26        LIKE gem_file.gem02,  #FUN-710078 add
#              apb930     LIKE apb_file.apb930, #FUN-670064
#              gem02c     LIKE gem_file.gem02,  #FUN-670064
#              apb23      LIKE apb_file.apb23,
#              apb24      LIKE apb_file.apb24,
#              apb08      LIKE apb_file.apb08,
#              apb10      LIKE apb_file.apb10,
#              #FUN-850038 --start---
#              apbud01    LIKE apb_file.apbud01,
#              apbud02    LIKE apb_file.apbud02,
#              apbud03    LIKE apb_file.apbud03,
#              apbud04    LIKE apb_file.apbud04,
#              apbud05    LIKE apb_file.apbud05,
#              apbud06    LIKE apb_file.apbud06,
#              apbud07    LIKE apb_file.apbud07,
#              apbud08    LIKE apb_file.apbud08,
#              apbud09    LIKE apb_file.apbud09,
#              apbud10    LIKE apb_file.apbud10,
#              apbud11    LIKE apb_file.apbud11,
#              apbud12    LIKE apb_file.apbud12,
#              apbud13    LIKE apb_file.apbud13,
#              apbud14    LIKE apb_file.apbud14,
#              apbud15    LIKE apb_file.apbud15
#              #FUN-850038 --end--
#                   END RECORD,
#   g_apb_t         RECORD                 #程式變數 (舊值)
#              apb02      LIKE apb_file.apb02,
#              apb33      LIKE apb_file.apb33, #No.FUN-690080
#              apb11      LIKE apb_file.apb11,
#              apb29      LIKE apb_file.apb29,
#              apb21      LIKE apb_file.apb21,
#             #FUN-810045 begin
#              #apb31      LIKE apb_file.apb31, #FUN-630055
#              #apb30      LIKE apb_file.apb30, #No.FUN-690080
#             #FUN-810045 end
#              apb22      LIKE apb_file.apb22,
#             #rvv40      LIKE rvv_file.rvv40,   #FUN-680110 add  #No.TQC-7B0083
#              apb34      LIKE apb_file.apb34,   #FUN-680110 add  #No.TQC-7B0083
#              apb01_unap LIKE apb_file.apb01,   #FUN-680110 add
#              apb06      LIKE apb_file.apb06,
#              apb07      LIKE apb_file.apb07,
#              apb12      LIKE apb_file.apb12,
#              apb27      LIKE apb_file.apb27,
#              apb09      LIKE apb_file.apb09,
#              apb28      LIKE apb_file.apb28,
#            #FUN-810045 begin
#              apb35      LIKE apb_file.apb35, 
#              apb36      LIKE apb_file.apb36, 
#              apb31      LIKE apb_file.apb31, 
#            # apb30      LIKE apb_file.apb30,  #No.FUN-830161
#            #FUN-810045 end
#              apb32      LIKE apb_file.apb32, #No.FUN-690080
#              b32        LIKE gen_file.gen02, #FUN-990025
#              apb25      LIKE apb_file.apb25,
#              b25        LIKE aag_file.aag02,  #FUN-710078 add
#              apb251     LIKE apb_file.apb251, #FUN-680029
#              b251       LIKE aag_file.aag02,  #FUN-710078 add
#              apb26      LIKE apb_file.apb26,
#              b26        LIKE gem_file.gem02,  #FUN-710078 add
#              apb930     LIKE apb_file.apb930, #FUN-670064
#              gem02c     LIKE gem_file.gem02,  #FUN-670064
#              apb23      LIKE apb_file.apb23,
#              apb24      LIKE apb_file.apb24,
#              apb08      LIKE apb_file.apb08,
#              apb10      LIKE apb_file.apb10,
#              #FUN-850038 --start---
#              apbud01    LIKE apb_file.apbud01,
#              apbud02    LIKE apb_file.apbud02,
#              apbud03    LIKE apb_file.apbud03,
#              apbud04    LIKE apb_file.apbud04,
#              apbud05    LIKE apb_file.apbud05,
#              apbud06    LIKE apb_file.apbud06,
#              apbud07    LIKE apb_file.apbud07,
#              apbud08    LIKE apb_file.apbud08,
#              apbud09    LIKE apb_file.apbud09,
#              apbud10    LIKE apb_file.apbud10,
#              apbud11    LIKE apb_file.apbud11,
#              apbud12    LIKE apb_file.apbud12,
#              apbud13    LIKE apb_file.apbud13,
#              apbud14    LIKE apb_file.apbud14,
#              apbud15    LIKE apb_file.apbud15
#              #FUN-850038 --end--
#                   END RECORD,
#   g_apk1    DYNAMIC ARRAY OF RECORD   #MOD-960128 add
#                    apk11          LIKE apk_file.apk11,
#                    apk171         LIKE apk_file.apk171,
#                    apk17          LIKE apk_file.apk17,
#                    apk172         LIKE apk_file.apk172,
#                    apk05          LIKE apk_file.apk05,     #No:8511 No:8654
#                    apk03          LIKE apk_file.apk03,
#                    apk04          LIKE apk_file.apk04,
#                    apk12          LIKE apk_file.apk12,
#                    apk13          LIKE apk_file.apk13,
#                    apk08f         LIKE apk_file.apk08f,
#                    apk07f         LIKE apk_file.apk07f,
#                    apk06f         LIKE apk_file.apk06f,
#                    apk08          LIKE apk_file.apk08,
#                    apk07          LIKE apk_file.apk07,
#                    apk06          LIKE apk_file.apk06,
#                    apk32          LIKE apk_file.apk32    #FUN-970108 add
#                    END RECORD,
#   g_apk     DYNAMIC ARRAY OF RECORD
#                    apk02          LIKE apk_file.apk02,     #MOD-950226 add
#                    apk11          LIKE apk_file.apk11,
#                    apk171         LIKE apk_file.apk171,
#                    apk17          LIKE apk_file.apk17,
#                    apk172         LIKE apk_file.apk172,
#                    apk05          LIKE apk_file.apk05,     #No:8511 No:8654
#                    apk03          LIKE apk_file.apk03,
#                    apk04          LIKE apk_file.apk04,
#                    apk12          LIKE apk_file.apk12,
#                    apk13          LIKE apk_file.apk13,
#                    apk08f         LIKE apk_file.apk08f,
#                    apk07f         LIKE apk_file.apk07f,
#                    apk06f         LIKE apk_file.apk06f,
#                    apk08          LIKE apk_file.apk08,
#                    apk07          LIKE apk_file.apk07,
#                    apk06          LIKE apk_file.apk06,
#                    apk32          LIKE apk_file.apk32    #FUN-970108 add
#                    END RECORD,
##CHI-940018 add begin--
#    g_apk_t      RECORD
#                    apk02          LIKE apk_file.apk02,     #MOD-950226 add
#                    apk11          LIKE apk_file.apk11,
#                    apk171         LIKE apk_file.apk171,
#                    apk17          LIKE apk_file.apk17,
#                    apk172         LIKE apk_file.apk172,
#                    apk05          LIKE apk_file.apk05,    
#                    apk03          LIKE apk_file.apk03,
#                    apk04          LIKE apk_file.apk04,
#                    apk12          LIKE apk_file.apk12,
#                    apk13          LIKE apk_file.apk13,
#                    apk08f         LIKE apk_file.apk08f,
#                    apk07f         LIKE apk_file.apk07f,
#                    apk06f         LIKE apk_file.apk06f,
#                    apk08          LIKE apk_file.apk08,
#                    apk07          LIKE apk_file.apk07,
#                    apk06          LIKE apk_file.apk06,
#                    apk32          LIKE apk_file.apk32    #FUN-970108 add
#                    END RECORD,
##CHI-940018 add end---                                        
#   g_apk_c   DYNAMIC ARRAY OF RECORD
#                    apk02          LIKE apk_file.apk02,
#                    apk11          LIKE apk_file.apk11, #CHI-B10017 add
#                    apk172         LIKE apk_file.apk172,#CHI-B10017 add
#                    apk28          LIKE apk_file.apk28,
#                    apk03          LIKE apk_file.apk03,
#                    apk04          LIKE apk_file.apk04,
#                    apl02          LIKE apl_file.apl02,
#                    apk05          LIKE apk_file.apk05,
#                    apk29          LIKE apk_file.apk29,
#                    #No.MOD-580365  --begin
#                    apk08f         LIKE apk_file.apk08f,
#                    apk08          LIKE apk_file.apk08,
#                    apk07f         LIKE apk_file.apk07f,
#                    apk07          LIKE apk_file.apk07,
#                    apk06f         LIKE apk_file.apk06f,
#                    apk06          LIKE apk_file.apk06,
#                    #No.MOD-580365  --end
#                    apk171         LIKE apk_file.apk171,
#                   #apk172         LIKE apk_file.apk172, #CHI-B10017 mark
#                    apk30          LIKE apk_file.apk30,
#                    apk32          LIKE apk_file.apk32    #FUN-970108 add
#                    END RECORD,
##CHI-940018 add begin--
#    g_apk_c_t    RECORD
#                    apk02          LIKE apk_file.apk02,
#                    apk11          LIKE apk_file.apk11, #CHI-B10017 add
#                    apk172         LIKE apk_file.apk172,#CHI-B10017 add
#                    apk28          LIKE apk_file.apk28,
#                    apk03          LIKE apk_file.apk03,
#                    apk04          LIKE apk_file.apk04,
#                    apl02          LIKE apl_file.apl02,
#                    apk05          LIKE apk_file.apk05,
#                    apk29          LIKE apk_file.apk29,               
#                    apk08f         LIKE apk_file.apk08f,
#                    apk08          LIKE apk_file.apk08,
#                    apk07f         LIKE apk_file.apk07f,
#                    apk07          LIKE apk_file.apk07,
#                    apk06f         LIKE apk_file.apk06f,
#                    apk06          LIKE apk_file.apk06,                  
#                    apk171         LIKE apk_file.apk171,
#                   #apk172         LIKE apk_file.apk172, #CHI-B10017 mark
#                    apk30          LIKE apk_file.apk30,
#                    apk32          LIKE apk_file.apk32    #FUN-970108 add
#                    END RECORD,
##CHI-940018 add end---                                          
#   g_apb04          LIKE apb_file.apb04,
#   g_apb05          LIKE apb_file.apb05,
#   g_apb30          LIKE apb_file.apb30,
#   g_apb04_t        LIKE apb_file.apb04,
#   g_apb05_t        LIKE apb_file.apb05,
#   g_apb09          LIKE apb_file.apb09,                  #MOD-A90146
#   g_apb10          LIKE apb_file.apb10,
#   g_apb24          LIKE apb_file.apb24,                  #MOD-A90146
#   g_aba RECORD
#              aba13 LIKE aba_file.aba13,  #FUN-4B0079
#              aba14 LIKE aba_file.aba14,  #FUN-4B0079
#              aba15 LIKE aba_file.aba15,  #FUN-4B0079
#              aba00 LIKE aba_file.aba00   #MOD-C40155 add
#            END RECORD,
#   g_api     DYNAMIC ARRAY OF RECORD
#                   api04          LIKE api_file.api04,
##FUN-590124
#                   aag02          LIKE aag_file.aag02,
##                  aag02          VARCHAR(30),
##FUN-590124 End
#                   api041         LIKE api_file.api041,     #No.FUN-680029
#                   aag021         LIKE aag_file.aag02,      #No.FUN-680029
#                   api07          LIKE api_file.api07,
#                   api930         LIKE api_file.api930,     #CHI-8C0005 add
#                   api06          LIKE api_file.api06,
#                   api05f         LIKE api_file.api05f,
#                   api05          LIKE api_file.api05,
#                   api21          LIKE api_file.api21,
#                   api22          LIKE api_file.api22,
#                   api23          LIKE api_file.api23,
#                   api24          LIKE api_file.api24,
#
#                   #FUN-5C0015 BY GILL --START
#                   api31     LIKE api_file.api31,  #異動碼5
#                   api32     LIKE api_file.api32,  #異動碼6
#                   api33     LIKE api_file.api33,  #異動碼7
#                   api34     LIKE api_file.api34,  #異動碼8
#                 #FUN-810045 35/36移至26 後
#                  # api35     LIKE api_file.api35,  #異動碼9
#                  # api36     LIKE api_file.api36,  #異動碼10
#                   api37     LIKE api_file.api37,  #關係人異動碼
#                   #FUN-5C0015 BY GILL --END
#
#                  #api25          LIKE api_file.api25,  #No.FUN-830161
#                   api26          LIKE api_file.api26,
#                  #FUN-810045 begin
#                   api35     LIKE api_file.api35,  #異動碼9(WBS)
#                   api36     LIKE api_file.api36   #異動碼10(費用原因)
#                  #FUN-810045 end
#                   END RECORD,
#    g_wc,g_wc2,g_sql    string,  #No:FUN-580092 HCN
#   g_rec_b         LIKE type_file.num5,                #單身筆數  #No.FUN-690028 SMALLINT
#   g_buf           LIKE type_file.chr1000,             #  #No.FUN-690028 VARCHAR(78)
#   #g_aptype        VARCHAR(2),            #帳款種類  #FUN-660117 remark
#   g_aptype        LIKE apa_file.apa00, #帳款種類  #FUN-660117
#   g_cal_code      LIKE type_file.chr2,        # No:FUN-690028 VARCHAR(2),               #Calendar code
#   g_qty1,g_qty2,g_qty3     LIKE ima_file.ima26,      # No:FUN-690028 DEC(15,3),  #FUN-4B0079
#   g_qty5          LIKE ima_file.ima26,        #No.TQC-7B0083
#   #-----TQC-6C0044---------
#   #g_amt1f,g_amt2f,g_amt3f  LIKE type_file.num20_6,     # No:FUN-690028 DEC(20,6),  #FUN-4B0079
#   #g_amt1,g_amt2,g_amt3     LIKE type_file.num20_6,     # No:FUN-690028 DEC(20,6),  #FUN-4B0079
#   #g_amt1f,g_amt2f,g_amt3f,g_amt4f  LIKE type_file.num20_6,     #MOD-820008
#   #g_amt1,g_amt2,g_amt3,g_amt4      LIKE type_file.num20_6,     #MOD-820008
#   g_amt1f,g_amt2f,g_amt3f,g_amt4f,g_amt5f  LIKE type_file.num20_6,    #MOD-820008
#   g_amt1,g_amt2,g_amt3,g_amt4,g_amt5      LIKE type_file.num20_6,     #MOD-820008
#   #-----END TQC-6C0044-----
#   g_tax                    LIKE type_file.num20_6,     # No:FUN-690028 DEC(20,6),  #FUN-4B0079
#    g_gec05             LIKE gec_file.gec05,      #No.MOD-530687
#   g_pma11         LIKE pma_file.pma11,
#   g_rvb10         LIKE rvb_file.rvb10,
#   g_statu         LIKE type_file.chr1,        # No:FUN-690028 VARCHAR(01),              #是否從新賦予等級
#   g_flag          LIKE type_file.chr1,        #控制請款折讓是否要重新刪除再產生  #No.FUN-690028 VARCHAR(1)
#   g_n             LIKE type_file.num10,       # No:FUN-690028 INTEGER,
#   g_no            LIKE apb_file.apb12,
#   g_dbs_nm        LIKE type_file.chr21,       # No:FUN-690028 VARCHAR(21),
#   g_dbs_gl        LIKE type_file.chr21,       # No:FUN-690028 VARCHAR(21),
##  g_argv1         VARCHAR(80),              #No:FUN-630010
#   l_ac            LIKE type_file.num5,                #目前處理的ARRAY CNT  #No.FUN-690028 SMALLINT
#   g_rvv38_n       LIKE rvv_file.rvv38,
#   g_chr2          LIKE type_file.chr1,    #No.FUN-690028 VARCHAR(1)
#   g_chr3          LIKE type_file.chr1                  #FUN-580114  #No.FUN-690028 VARCHAR(1)
#
#DEFINE g_gem02     LIKE gem_file.gem02    #FUN-710078 add
#DEFINE g_a51       LIKE aag_file.aag02    #FUN-710078 add
#DEFINE g_a52       LIKE aag_file.aag02    #FUN-710078 add
#DEFINE g_a54       LIKE aag_file.aag02    #FUN-710078 add
#DEFINE g_a511      LIKE aag_file.aag02    #FUN-710078 add
#DEFINE g_a521      LIKE aag_file.aag02    #FUN-710078 add
#DEFINE g_a541      LIKE aag_file.aag02    #FUN-710078 add
#
#DEFINE g_net       LIKE apv_file.apv04    #MOD-590312
#DEFINE g_laststage LIKE type_file.chr1    # No:FUN-690028 VARCHAR(1)                #FUN-580114
#DEFINE g_cmd    LIKE type_file.chr1000    #No.FUN-690028 VARCHAR(500)
##DEFINE g_ape     ARRAY [48] of RECORD    #No:TQC-870040 mark
#DEFINE g_ape    DYNAMIC ARRAY OF RECORD   #No:TQC-870040 add
#                    no       LIKE apv_file.apv01,        # No:FUN-690028 VARCHAR(16),  #FUN-580012
#                    sq       LIKE type_file.num5,        # No:FUN-690028 SMALLINT,
#                    amtf     LIKE type_file.num20_6,     # No:FUN-690028 DEC(20,6),  #FUN-4B0079
#                    amt      LIKE type_file.num20_6,     # No:FUN-690028 DEC(20,6),  #FUN-4B0079
#                    nmd02    LIKE nmd_file.nmd02,        # No:FUN-690028 VARCHAR(10),
#                    nmd05    LIKE type_file.dat,         # No:FUN-690028 DATE,
#                    nmd04    LIKE type_file.num10        # No:FUN-690028 INTEGER
#                    END RECORD
#DEFINE g_hold    LIKE type_file.chr1       #用來標記是單頭留置還是子帳期單筆留置，當g_hlod='2'時為子帳期單筆留置   #No.MOD-780152
#DEFINE g_forupd_sql STRING   #SELECT ... FOR UPDATE NOWAIT SQL
#DEFINE g_before_input_done  LIKE type_file.num5    #No.FUN-690028 SMALLINT
#DEFINE   g_chr           LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
#DEFINE   g_cnt           LIKE type_file.num10   #No.FUN-690028 INTEGER
#DEFINE   g_i             LIKE type_file.num5     #count/index for any purpose  #No.FUN-690028 SMALLINT
#DEFINE   g_msg           LIKE type_file.chr1000 #No.FUN-690028 VARCHAR(72)
#DEFINE   g_str           STRING     #No.FUN-670060
#DEFINE   g_wc_gl         STRING     #No.FUN-670060
#DEFINE   g_sn            LIKE type_file.chr1    #TQC-770027
#DEFINE   g_row_count    LIKE type_file.num10   #No.FUN-690028 INTEGER
#DEFINE   g_curs_index   LIKE type_file.num10   #No.FUN-690028 INTEGER
#DEFINE   g_jump         LIKE type_file.num10   #No.FUN-690028 INTEGER
#DEFINE   g_no_ask       LIKE type_file.num5    #No.FUN-690028 SMALLINT
#DEFINE   g_argv1        LIKE apa_file.apa01   # No:FUN-690028 VARCHAR(16)         #No:FUN-630010
#DEFINE   g_argv2        STRING           #No:FUN-630010
#DEFINE   g_argv3        STRING           #MOD-650085
#DEFINE   g_argv4        STRING           #FUN-880095 
##No.FUN-680027--begin
#   DEFINE   i           LIKE type_file.num5      #No.FUN-690028 SMALLINT
#   DEFINE g_apc     DYNAMIC ARRAY OF RECORD
#                    apc02     LIKE apc_file.apc02,
#                    apc03     LIKE apc_file.apc03,
#                    apc03_pma02 LIKE pma_file.pma02,
#                    apc04     LIKE apc_file.apc04,
#                    apc05     LIKE apc_file.apc05,
#                    apc06     LIKE apc_file.apc06,
#                    apc07     LIKE apc_file.apc07,
#                    apc08     LIKE apc_file.apc08,
#                    apc09     LIKE apc_file.apc09,
#                    apc10     LIKE apc_file.apc10,
#                    apc11     LIKE apc_file.apc11,
#                    apc16     LIKE apc_file.apc16,
#                    apc12     LIKE apc_file.apc12, 
#                    apc14     LIKE apc_file.apc14,    #MOD-B70047  
#                    apc15     LIKE apc_file.apc15     #MOD-B70047 
#                    END RECORD
#   DEFINE g_apc_t   RECORD
#                    apc02     LIKE apc_file.apc02,
#                    apc03     LIKE apc_file.apc03,
#                    apc03_pma02 LIKE pma_file.pma02,
#                    apc04     LIKE apc_file.apc04,
#                    apc05     LIKE apc_file.apc05,
#                    apc06     LIKE apc_file.apc06,
#                    apc07     LIKE apc_file.apc07,
#                    apc08     LIKE apc_file.apc08,
#                    apc09     LIKE apc_file.apc09,
#                    apc10     LIKE apc_file.apc10,
#                    apc11     LIKE apc_file.apc11,
#                    apc16     LIKE apc_file.apc16,
#                    apc12     LIKE apc_file.apc12, 
#                    apc14     LIKE apc_file.apc14,    #MOD-B70047  
#                    apc15     LIKE apc_file.apc15     #MOD-B70047 
#                    END RECORD
##No.FUN-680027--end   
#DEFINE g_azp03             LIKE azp_file.azp03    #No.FUN-730064                                                                    
#DEFINE g_bookno1           LIKE aza_file.aza81    #No.FUN-730064                                                                    
#DEFINE g_bookno2           LIKE aza_file.aza82    #No.FUN-730064                                                                    
#DEFINE g_bookno            LIKE aag_file.aag00    #No.FUN-730064                                                                    
#DEFINE g_dbsm              LIKE type_file.chr21   #No.FUN-730064                                                                    
#DEFINE g_db_type           LIKE type_file.chr3    #No.FUN-730064
#DEFINE g_db1               LIKE type_file.chr21   #No.FUN-730064
#DEFINE g_flag1             LIKE type_file.chr1    #No.FUN-730064
#DEFINE g_fac_type          STRING                 #No.MOD-840179 add 傳入q_pmm9的參數
#
##No:FUN-960117 add --start--
# DEFINE l_ebostep    VARCHAR(1)  #eB-Online階段碼回傳值
# DEFINE l_eboresp    VARCHAR(1)  #eB-Online回覆碼回傳值
# DEFINE l_ebocode    VARCHAR(2)  #eB-Online異動狀態碼
# DEFINE l_ebomsg1    STRING   #eB-Online階段碼中文
# DEFINE l_ebomsg2    STRING   #eB-Online回覆碼中文
# DEFINE l_ebostr     STRING   #訊息
# DEFINE l_maxkey2    VARCHAR(20) #eB-Online最大版次 key2
##No:FUN-960117 add --end--
#DEFINE g_sn1           LIKE type_file.chr1    #FUN-880113
#DEFINE g_chr_1         LIKE type_file.chr1    #MOD-950158          
#DEFINE g_chr_2         LIKE type_file.chr1    #MOD-950158          
#DEFINE g_chr_3         LIKE type_file.chr1    #MOD-950158     
#DEFINE g_pmc903        LIKE pmc_file.pmc903   #No.FUN-950053  
#DEFINE l_apz59         LIKE apz_file.apz59    #TQC-A40106
#DEFINE g_modify_date   LIKE type_file.chr1    #用來標記是否由日期修改進入多帳期維護 #CHI-A50042 add
#DEFINE g_flag2         LIKE type_file.chr1    #CHI-B60063 add
#FUN-C80078 mark end---
DEFINE g_apa_rowid     LIKE type_file.chr18

#FUN-C80078 add str---
#
#作用:lock cursor
#回傳值:無
#
FUNCTION t110_lock_cl()
   DEFINE l_forupd_sql STRING

   LET g_forupd_sql = "SELECT * FROM apa_file WHERE ROWID = ? FOR UPDATE NOWAIT"
   DECLARE t110_cl CURSOR FROM g_forupd_sql

END FUNCTION
#FUN-C80078 add end---

FUNCTION t110(p_aptype,p_argv1,p_argv2,p_argv3,p_argv4)  #No:FUN-630010   #FUN-880095 Add p_argv3,p_argv4  
   DEFINE p_aptype       LIKE apa_file.apa00    #No:FUN-690028  VARCHAR(2)
   DEFINE p_argv1        LIKE apa_file.apa01    #No:FUN-690028  VARCHAR(16)         #No:FUN-630010
   DEFINE p_argv2        STRING                 #No:FUN-630010
   DEFINE p_argv3        STRING                 #No.FUN-880095  
   DEFINE p_argv4        STRING                 #No.FUN-880095

   WHENEVER ERROR CALL cl_err_msg_log


   LET g_sn = 'n'       #TQC-770027
   LET g_sn1 = 'N'      #FUN-880113
#  LET g_argv1= ARG_VAL(1)             #No:FUN-630010
   LET g_argv1_apa01= p_argv1          #No:FUN-630010  #FUN-C80078 g_argv1-->g_argv1_apa01
   LET g_argv2_str= p_argv2                #No:FUN-630010  #FUN-C80078 g_argv2-->g_argv2_str
   LET g_argv3 = ARG_VAL(3)   #MOD-650085
   LET g_argv4= p_argv4                #No:FUN-880095
   LET l_apz59 = g_apz.apz59           #TQC-A40106

 #FUN-580114
   IF fgl_getenv('EASYFLOW') = "1" THEN
      LET g_argv1_apa01 = aws_efapp_wsk(1)   #參數:key-1  #FUN-C80078 g_argv1-->g_argv1_apa01
   END IF
 #FUN-580114 End
   #No.FUN-5A0131 --start--
   IF cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
      LET g_argv1_apa01=g_dash CLIPPED  #FUN-C80078 g_argv1-->g_argv1_apa01
      LET g_dash = NULL
   END IF
   #No.FUN-5A0131 --end--

   LET g_plant_new=g_apz.apz04p
   CALL s_getdbs()
   LET g_dbs_nm=g_dbs_new
   IF cl_null(g_dbs_nm) THEN
      LET g_dbs_nm = NULL
   END IF

   LET g_plant_new=g_apz.apz02p
   CALL s_getdbs()
   LET g_dbs_gl=g_dbs_new
   IF cl_null(g_dbs_gl) THEN
      LET g_dbs_gl = NULL
   END IF
   
    #MOD-560102
   LET g_sql = "SELECT aaz72  FROM ",g_dbs_gl CLIPPED,"aaz_file ",
               " WHERE aaz00 = '0' "
	CALL cl_replace_sqldb(g_sql) RETURNING g_sql		#FUN-920032
   PREPARE t110_get_aaz72_p FROM g_sql
   DECLARE t110_get_aaz72_c CURSOR FOR t110_get_aaz72_p
   OPEN t110_get_aaz72_c
   FETCH t110_get_aaz72_c INTO g_aaz.aaz72
   #--
   LET g_wc=' 1=1'

  #FUN-C80078 mark str---
  #LET g_forupd_sql = "SELECT * FROM apa_file WHERE ROWID = ? FOR UPDATE NOWAIT"
  #DECLARE t110_cl CURSOR FROM g_forupd_sql
  #FUN-C80078 mark end---
#   SELECT * INTO t_azi.* FROM azi_file WHERE azi01=g_aza.aza17   #MOD-6B0066
   LET g_aptype = p_aptype

   CASE
      WHEN g_aptype = '11'
         LET g_apb_sarrno = 2
         LET g_prog = 'aapt110'
      WHEN g_aptype = '12'
         IF l_apz59='N' THEN        #TQC-A40106 change g_apz.apz59->l_apz59
            LET g_apb_sarrno = 0
         ELSE
            LET g_apb_sarrno = 2
         END IF
         LET g_prog = 'aapt120'
      WHEN g_aptype = '15'
         LET g_apb_sarrno = 2
         LET g_prog = 'aapt150'
     #start FUN-680110 add
      WHEN g_aptype = '16'
         LET g_apb_sarrno = 2
         LET g_prog = 'aapt160'
     #end FUN-680110 add
      WHEN g_aptype = '21'
         LET g_apb_sarrno = 2
      WHEN g_aptype = '22'
         LET g_apb_sarrno = 2
      WHEN g_aptype = '23'
         LET g_apb_sarrno = 0
      WHEN g_aptype = '24'
         LET g_apb_sarrno = 0
     #start FUN-680110 add
      WHEN g_aptype = '26'
         LET g_apb_sarrno = 2
         LET g_prog = 'aapt260'
     #end FUN-680110 add
     #No.FUN-690080 --Begin
      WHEN g_aptype = '13'          #報銷/還款維護作業
         IF l_apz59='N' THEN        #TQC-A40106 Add 
            LET l_apz59= 'Y'        #TQC-A40106 Add 
         END IF                     #TQC-A40106 Add      
         IF l_apz59='N' THEN        #TQC-A40106 change g_apz.apz59->l_apz59
            LET g_apb_sarrno = 0
         ELSE
            LET g_apb_sarrno = 2
         END IF
         LET g_prog = 'aapt121'
      WHEN g_aptype = '17'          #借支單維護作業
         LET g_apb_sarrno = 2
         LET g_prog = 'aapt151'
      WHEN g_aptype = '25'
         LET g_apb_sarrno = 0
     #No.FUN-690080 --End
   END CASE

   CASE
      WHEN g_aptype = '11' OR g_aptype = '16'   #FUN-680110 add g_aptype = '16'
         #FUN-640240
         IF g_bgjob='N' OR cl_null(g_bgjob) THEN

            OPEN WINDOW t110_w11 WITH FORM "aap/42f/aapt110"
               ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
            CALL cl_ui_init()

            IF g_aptype='11' THEN   #MOD-820050
               CALL cl_set_act_visible("appor_expense",FALSE)   #FUN-680110 add
            END IF   #MOD-820050
            CALL cl_set_comp_visible("apa992",FALSE)  #No.FUN-690090 
            CALL t110_set_form_default() #FUN-670064
            #-----TQC-7B0117---------
            IF NOT cl_null(g_argv3) THEN
               CALL t110_q()
            END IF
            #-----END TQC-7B0117-----
         END IF
         #END FUN-640240

         #-----#No:FUN-960117 EBO add start -----
         IF g_aza.aza75 MATCHES '[Nn]' AND g_prog = 'aapt110' THEN
            CALL cl_set_comp_visible("sendtype",FALSE)
         END IF
         IF g_aza.aza75 MATCHES '[Yy]' AND g_prog = 'aapt110' THEN
           CALL aws_ebocli_toolbar()
           CALL cl_set_act_visible("ebo_status_query", TRUE)
           CALL cl_set_comp_visible("sendtype", TRUE) 
           IF g_aza.aza77 MATCHES '[Yy]' THEN
              CALL cl_set_act_visible("ebo_transfer", TRUE)
           ELSE
              CALL cl_set_act_visible("ebo_transfer",FALSE)
           END IF
         ELSE
           CALL cl_set_act_visible("ebo_status_query",FALSE)
           CALL cl_set_act_visible("ebo_transfer",FALSE)
           CALL cl_set_comp_visible("sendtype", FALSE)
         END IF
         #-----#No:FUN-960117 EBO add end -----


#FUN-580114
         #如果由表單追蹤區觸發程式, 此參數指定為何種資料匣
         #當為 EasyFlow 簽核時, 加入 EasyFlow 簽核 toolbar icon
         CALL aws_efapp_toolbar()    #FUN-580114

         IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
            #No:FUN-630010 --start--
            CASE g_argv2_str  #FUN-C80078 g_argv2-->g_argv2_str
               WHEN "query"
                  LET g_action_choice = "query"
                  IF cl_chk_act_auth() THEN
                     CALL t110_q()
                  END IF
               WHEN "insert"
                  LET g_action_choice = "insert"
                  IF cl_chk_act_auth() THEN
                     CALL t110_a()
                  END IF
               #FUN-640240
               WHEN "efconfirm"
                  CALL t110_q()
                  CALL s_showmsg_init() #CHI-A80031 add
                  CALL t110_firm1_chk()          #CALL 原確認的 check 段
                  IF g_success = "Y" THEN
                     CALL t110_firm1_upd()       #CALL 原確認的 update 段
                  END IF
                  CALL s_showmsg()  #CHI-A80031 add
                  EXIT PROGRAM
               #END FUN-640240
               OTHERWISE
                  CALL t110_q()
            END CASE
            #No:FUN-630010 ---end---
         END IF

         #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
         #CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
         CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
              RETURNING g_laststage
#FUN-580114 End

         CALL t110_menu()
         CLOSE WINDOW t110_w11
      WHEN g_aptype = '12'
        #FUN-640240
         IF g_bgjob='N' OR cl_null(g_bgjob) THEN
         
            OPEN WINDOW t110_w12 WITH FORM "aap/42f/aapt120"
               ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
            CALL cl_ui_init()

            CALL t110_set_form_default() #FUN-670064
            #-----TQC-7B0117---------
            ##-----MOD-650085---------
            #IF NOT cl_null(g_argv3) THEN
            #   CALL t110_q()
            #END IF
            ##-----END MOD-650085-----
            #-----END TQC-7B0117-----
         END IF
         #END FUN-640240

         #-----#No:FUN-960117 EBO add start -----
         IF g_aza.aza75 MATCHES '[Nn]' AND g_prog = 'aapt120' THEN
            CALL cl_set_comp_visible("sendtype",FALSE)
         END IF
         IF g_aza.aza75 MATCHES '[Yy]' AND g_prog = 'aapt120' THEN
            CALL aws_ebocli_toolbar()
            CALL cl_set_act_visible("ebo_status_query", TRUE)
            CALL cl_set_comp_visible("sendtype", TRUE)
            IF g_aza.aza77 MATCHES '[Yy]' THEN
               CALL cl_set_act_visible("ebo_transfer", TRUE)
            ELSE
               CALL cl_set_act_visible("ebo_transfer",FALSE)
            END IF
         ELSE
            CALL cl_set_act_visible("ebo_status_query",FALSE)
            CALL cl_set_act_visible("ebo_transfer",FALSE)
            CALL cl_set_comp_visible("sendtype", FALSE)
         END IF
         #-----#No:FUN-960117 EBO add end -----

#FUN-580114
         #如果由表單追蹤區觸發程式, 此參數指定為何種資料匣
         #當為 EasyFlow 簽核時, 加入 EasyFlow 簽核 toolbar icon
         CALL aws_efapp_toolbar()    #FUN-580114

         CALL t110_misc_clear()
         IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
            #No:FUN-630010 --start--
            CASE g_argv2_str  #FUN-C80078 g_argv2-->g_argv2_str
               WHEN "query"
                  LET g_action_choice = "query"
                  IF cl_chk_act_auth() THEN
                     CALL t110_q()
                  END IF
               WHEN "insert"
                  LET g_action_choice = "insert"
                  IF cl_chk_act_auth() THEN
                     CALL t110_a()
                  END IF
               #FUN-640240
               WHEN "efconfirm"
                  CALL t110_q()
                  CALL s_showmsg_init() #CHI-A80031 add
                  CALL t110_firm1_chk()          #CALL 原確認的 check 段
                  IF g_success = "Y" THEN
                     CALL t110_firm1_upd()       #CALL 原確認的 update 段
                  END IF
                  CALL s_showmsg()  #CHI-A80031 add
                  EXIT PROGRAM
               #END FUN-640240
               OTHERWISE
                  CALL t110_q()
            END CASE
            #No:FUN-630010 ---end---
         END IF

         #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
         #CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
         CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
              RETURNING g_laststage
#FUN-580114 End

         CALL t110_menu()
         CLOSE WINDOW t110_w12
      WHEN g_aptype = '15'
         #FUN-640240
         IF g_bgjob='N' OR cl_null(g_bgjob) THEN

            OPEN WINDOW t110_w15 WITH FORM "aap/42f/aapt150"
               ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
            CALL cl_ui_init()

            CALL cl_set_act_visible("appor_expense",FALSE)   #FUN-680110 add
            CALL cl_set_comp_visible("apa992",FALSE)  #No.FUN-690090 
#No.MOD-B40261 --begin #CHI-B80023 mark
           #IF g_apz.apz61='1' THEN
           #   CALL cl_set_comp_required("apb06,apb07",TRUE)
           #END IF
#No.MOD-B40261 --end #CHI-B80023 mark
            CALL t110_set_form_default() #FUN-670064 
            #-----FUN-880095---------
            IF NOT cl_null(g_argv4) THEN
               CALL t110_q()
            END IF
            #-----END FUN-880095-----                                 
         END IF
         #END FUN-640240

         #-----#No:FUN-960117 EBO add start -----
         IF g_aza.aza75 MATCHES '[Nn]' AND g_prog = 'aapt120' THEN
            CALL cl_set_comp_visible("sendtype",FALSE)
         END IF
         IF g_aza.aza75 MATCHES '[Yy]' AND g_prog = 'aapt120' THEN
            CALL aws_ebocli_toolbar()
            CALL cl_set_act_visible("ebo_status_query", TRUE)
            CALL cl_set_comp_visible("sendtype", TRUE)
            IF g_aza.aza77 MATCHES '[Yy]' THEN
               CALL cl_set_act_visible("ebo_transfer", TRUE)
            ELSE
               CALL cl_set_act_visible("ebo_transfer",FALSE)
            END IF
         ELSE
            CALL cl_set_act_visible("ebo_status_query",FALSE)
            CALL cl_set_act_visible("ebo_transfer",FALSE)
            CALL cl_set_comp_visible("sendtype", FALSE)
         END IF
         #-----#No:FUN-960117 EBO add end -----

#FUN-580114
         #如果由表單追蹤區觸發程式, 此參數指定為何種資料匣
         #當為 EasyFlow 簽核時, 加入 EasyFlow 簽核 toolbar icon
         CALL aws_efapp_toolbar()    #FUN-580114

         IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
            #No:FUN-630010 --start--
            CASE g_argv2_str  #FUN-C80078 g_argv2-->g_argv2_str
               WHEN "query"
                  LET g_action_choice = "query"
                  IF cl_chk_act_auth() THEN
                     CALL t110_q()
                  END IF
               WHEN "insert"
                  LET g_action_choice = "insert"
                  IF cl_chk_act_auth() THEN
                     CALL t110_a()
                  END IF
               #FUN-640240
               WHEN "efconfirm"
                  CALL t110_q()
                  CALL s_showmsg_init() #CHI-A80031 add
                  CALL t110_firm1_chk()          #CALL 原確認的 check 段
                  IF g_success = "Y" THEN
                     CALL t110_firm1_upd()       #CALL 原確認的 update 段
                  END IF
                  CALL s_showmsg()  #CHI-A80031 add
                  EXIT PROGRAM
               #END FUN-640240
               OTHERWISE
                  CALL t110_q()
            END CASE
            #No:FUN-630010 ---end---
         END IF

         #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
         #CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
         CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
              RETURNING g_laststage
#FUN-580114 End
 
         CALL t110_menu()
         CLOSE WINDOW t110_w15
      WHEN g_aptype = '21' OR g_aptype = '26'   #FUN-680110 add g_aptype = '26'
         #FUN-640240
         IF g_bgjob='N' OR cl_null(g_bgjob) THEN

            OPEN WINDOW t110_w21 WITH FORM "aap/42f/aapt210"
               ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
            CALL cl_ui_init()

            CALL cl_set_act_visible("appor_expense",FALSE)   #FUN-680110 add
            CALL cl_set_comp_visible("apa992",FALSE)  #No.FUN-690090
            IF g_argv2_str = 'aapq720' THEN                                          #FUN-8A0108  #FUN-C80078 g_argv2-->g_argv2_str                                  
               CALL cl_set_act_visible("insert,delete,modify,query,detail",FALSE)    #FUN-8A0108                                    
            END IF                                                                   #FUN-8A0108 
          #TQC-750140 begin
            CALL cl_set_comp_visible("apa37,apa37f,page05",FALSE)
          #TQC-750140 end
            CALL t110_set_form_default() #FUN-670064
            #-----MOD-770081---------
            IF NOT cl_null(g_argv3) THEN
               CALL t110_q()
            END IF
            #-----END MOD-770081-----
         END IF
         #END FUN-640240

         #-----#No:FUN-960117 EBO add start -----
         IF g_aza.aza75 MATCHES '[Nn]' AND g_prog = 'aapt120' THEN
            CALL cl_set_comp_visible("sendtype",FALSE)
         END IF
         IF g_aza.aza75 MATCHES '[Yy]' AND g_prog = 'aapt120' THEN
            CALL aws_ebocli_toolbar()
            CALL cl_set_act_visible("ebo_status_query", TRUE)
            CALL cl_set_comp_visible("sendtype", TRUE)
            IF g_aza.aza77 MATCHES '[Yy]' THEN
               CALL cl_set_act_visible("ebo_transfer", TRUE)
            ELSE
               CALL cl_set_act_visible("ebo_transfer",FALSE)
            END IF
         ELSE
            CALL cl_set_act_visible("ebo_status_query",FALSE)
            CALL cl_set_act_visible("ebo_transfer",FALSE)
            CALL cl_set_comp_visible("sendtype", FALSE)
         END IF
         #-----#No:FUN-960117 EBO add end -----

#FUN-580114
         #如果由表單追蹤區觸發程式, 此參數指定為何種資料匣
         #當為 EasyFlow 簽核時, 加入 EasyFlow 簽核 toolbar icon
         CALL aws_efapp_toolbar()    #FUN-580114

         IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
            #No:FUN-630010 --start--
            CASE g_argv2_str  #FUN-C80078 g_argv2-->g_argv2_str
               WHEN "query"
                  LET g_action_choice = "query"
                  IF cl_chk_act_auth() THEN
                     CALL t110_q()
                  END IF
               WHEN "insert"
                  LET g_action_choice = "insert"
                  IF cl_chk_act_auth() THEN
                     CALL t110_a()
                  END IF
               #FUN-640240
               WHEN "efconfirm"
                  CALL t110_q()
                  CALL s_showmsg_init() #CHI-A80031 add
                  CALL t110_firm1_chk()          #CALL 原確認的 check 段
                  IF g_success = "Y" THEN
                     CALL t110_firm1_upd()       #CALL 原確認的 update 段
                  END IF
                  CALL s_showmsg()  #CHI-A80031 add
                  EXIT PROGRAM
               #END FUN-640240
               OTHERWISE
                  CALL t110_q()
            END CASE
            #No:FUN-630010 ---end---
         END IF

         #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
         #CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
         CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
              RETURNING g_laststage
#FUN-580114 End
 
         CALL t210_menu()
         CLOSE WINDOW t110_w21
      WHEN g_aptype = '22'

         #FUN-640240
         IF g_bgjob='N' OR cl_null(g_bgjob) THEN

            OPEN WINDOW t110_w22 WITH FORM "aap/42f/aapt220"
               ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
            CALL cl_ui_init()

            CALL cl_set_act_visible("appor_expense",FALSE)   #FUN-680110 add
          #TQC-750140 begin
            CALL cl_set_comp_visible("apa37,apa37f,page05",FALSE)
          #TQC-750140 end
            CALL t110_set_form_default() #FUN-670064
         END IF
         #END FUN-640240

         #-----#No:FUN-960117 EBO add start -----
         IF g_aza.aza75 MATCHES '[Nn]' AND g_prog = 'aapt120' THEN
            CALL cl_set_comp_visible("sendtype",FALSE)
         END IF
         IF g_aza.aza75 MATCHES '[Yy]' AND g_prog = 'aapt120' THEN
            CALL aws_ebocli_toolbar()
            CALL cl_set_act_visible("ebo_status_query", TRUE)
            CALL cl_set_comp_visible("sendtype", TRUE)
            IF g_aza.aza77 MATCHES '[Yy]' THEN
               CALL cl_set_act_visible("ebo_transfer", TRUE)
            ELSE
               CALL cl_set_act_visible("ebo_transfer",FALSE)
            END IF
         ELSE
            CALL cl_set_act_visible("ebo_status_query",FALSE)
            CALL cl_set_act_visible("ebo_transfer",FALSE)
            CALL cl_set_comp_visible("sendtype", FALSE)
         END IF
         #-----#No:FUN-960117 EBO add end -----

#FUN-580114
         #如果由表單追蹤區觸發程式, 此參數指定為何種資料匣
         #當為 EasyFlow 簽核時, 加入 EasyFlow 簽核 toolbar icon
         CALL aws_efapp_toolbar()    #FUN-580114

         IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
            #No:FUN-630010 --start--
            CASE g_argv2_str  #FUN-C80078 g_argv2-->g_argv2_str
               WHEN "query"
                  LET g_action_choice = "query"
                  IF cl_chk_act_auth() THEN
                     CALL t110_q()
                  END IF
               WHEN "insert"
                  LET g_action_choice = "insert"
                  IF cl_chk_act_auth() THEN
                     CALL t110_a()
                  END IF
               #FUN-640240
               WHEN "efconfirm"
                  CALL t110_q()
                  CALL s_showmsg_init() #CHI-A80031 add
                  CALL t110_firm1_chk()          #CALL 原確認的 check 段
                  IF g_success = "Y" THEN
                     CALL t110_firm1_upd()       #CALL 原確認的 update 段
                  END IF
                  CALL s_showmsg()  #CHI-A80031 add
                  EXIT PROGRAM
               #END FUN-640240
               OTHERWISE
                  CALL t110_q()
            END CASE
            #No:FUN-630010 ---end---
         END IF

         #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
         #CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
         CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
              RETURNING g_laststage
#FUN-580114 End
 
         CALL t210_menu()
         CLOSE WINDOW t110_w22
      WHEN g_aptype = '23'

         OPEN WINDOW t110_w23 WITH FORM "aap/42f/aapq230"
             ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
         CALL cl_ui_init()

         CALL cl_set_act_visible("appor_expense",FALSE)   #FUN-680110 add
         CALL t110_set_form_default() #FUN-670064
         IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
            #No:FUN-630010 --start--
            CASE g_argv2_str  #FUN-C80078 g_argv2-->g_argv2_str
               WHEN "query"
                  LET g_action_choice = "query"
                  IF cl_chk_act_auth() THEN
                     CALL t110_q()
                  END IF
               WHEN "insert"
                  LET g_action_choice = "insert"
                  IF cl_chk_act_auth() THEN
                     CALL t110_a()
                  END IF
               OTHERWISE
                  CALL t110_q()
            END CASE
            #No:FUN-630010 ---end---
         END IF

         WHILE TRUE
           LET g_action_choice=""
           CALL t230_menu()
           IF g_action_choice="exit" THEN EXIT WHILE END IF
         END WHILE
 
         CLOSE WINDOW t110_w23

      WHEN g_aptype = '24'
 
         OPEN WINDOW t110_w24 WITH FORM "aap/42f/aapq240"
             ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
         CALL cl_ui_init()

         CALL cl_set_act_visible("appor_expense",FALSE)   #FUN-680110 add
         CALL t110_set_form_default() #FUN-670064
         IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
            #No:FUN-630010 --start--
            CASE g_argv2_str  #FUN-C80078 g_argv2-->g_argv2_str
               WHEN "query"
                  LET g_action_choice = "query"
                  IF cl_chk_act_auth() THEN
                     CALL t110_q()
                  END IF
               WHEN "insert"
                  LET g_action_choice = "insert"
                  IF cl_chk_act_auth() THEN
                     CALL t110_a()
                  END IF
               OTHERWISE
                  CALL t110_q()
            END CASE
            #No:FUN-630010 ---end---
         END IF
         WHILE TRUE
           LET g_action_choice=""
           CALL t230_menu()
           IF g_action_choice="exit" THEN EXIT WHILE END IF
         END WHILE
         CLOSE WINDOW t110_w24
      #No.FUN-690080 --Begin
      WHEN g_aptype = '13'          #報銷/還款維護作業
         IF g_bgjob='N' OR cl_null(g_bgjob) THEN

            OPEN WINDOW t110_w13 WITH FORM "aap/42f/aapt121"
               ATTRIBUTE (STYLE = g_win_style CLIPPED)
            CALL cl_ui_init()

            CALL cl_set_act_visible("appor_expense",FALSE)   #FUN-680110 add
            CALL cl_set_comp_visible("apa992",FALSE)  #No.FUN-690090 
            CALL t110_set_form_default()
            IF NOT cl_null(g_argv3) THEN
               CALL t110_q()
            END IF
         END IF

         #-----#No:FUN-960117 EBO add start -----
         IF g_aza.aza75 MATCHES '[Nn]' AND g_prog = 'aapt120' THEN
            CALL cl_set_comp_visible("sendtype",FALSE)
         END IF
         IF g_aza.aza75 MATCHES '[Yy]' AND g_prog = 'aapt120' THEN
            CALL aws_ebocli_toolbar()
            CALL cl_set_act_visible("ebo_status_query", TRUE)
            CALL cl_set_comp_visible("sendtype", TRUE)
            IF g_aza.aza77 MATCHES '[Yy]' THEN
               CALL cl_set_act_visible("ebo_transfer", TRUE)
            ELSE
               CALL cl_set_act_visible("ebo_transfer",FALSE)
            END IF
         ELSE
            CALL cl_set_act_visible("ebo_status_query",FALSE)
            CALL cl_set_act_visible("ebo_transfer",FALSE)
            CALL cl_set_comp_visible("sendtype", FALSE)
         END IF
         #-----#No:FUN-960117 EBO add end -----

         #如果由表單追蹤區觸發程式, 此參數指定為何種資料匣
         #當為 EasyFlow 簽核時, 加入 EasyFlow 簽核 toolbar icon
         CALL aws_efapp_toolbar()
         CALL t110_misc_clear()
         IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
            CASE g_argv2_str  #FUN-C80078 g_argv2-->g_argv2_str
               WHEN "query"
                  LET g_action_choice = "query"
                  IF cl_chk_act_auth() THEN
                     CALL t110_q()
                  END IF
               WHEN "insert"
                  LET g_action_choice = "insert"
                  IF cl_chk_act_auth() THEN
                     CALL t110_a()
                  END IF
               WHEN "efconfirm"
                  CALL t110_q()
                  CALL s_showmsg_init() #CHI-A80031 add
                  CALL t110_firm1_chk()
                  IF g_success = "Y" THEN
                     CALL t110_firm1_upd()
                  END IF
                  CALL s_showmsg()  #CHI-A80031 add
                  EXIT PROGRAM
               OTHERWISE
                  CALL t110_q()
            END CASE
         END IF
         #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
         #CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
         CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
            RETURNING g_laststage
         CALL t110_menu()
         CLOSE WINDOW t110_w13
      WHEN g_aptype = '17'          #借支單維護作業
         IF g_bgjob='N' OR cl_null(g_bgjob) THEN

            OPEN WINDOW t110_w17 WITH FORM "aap/42f/aapt151"
               ATTRIBUTE (STYLE = g_win_style CLIPPED)
            CALL cl_ui_init()

            CALL cl_set_act_visible("appor_expense",FALSE)   #FUN-680110 add
            CALL cl_set_comp_visible("apa992",FALSE)  #No.FUN-690090 
            CALL t110_set_form_default()
         END IF

         #-----#No:FUN-960117 EBO add start -----
         IF g_aza.aza75 MATCHES '[Nn]' AND g_prog = 'aapt120' THEN
            CALL cl_set_comp_visible("sendtype",FALSE)
         END IF
         IF g_aza.aza75 MATCHES '[Yy]' AND g_prog = 'aapt120' THEN
            CALL aws_ebocli_toolbar()
            CALL cl_set_act_visible("ebo_status_query", TRUE)
            CALL cl_set_comp_visible("sendtype", TRUE)
            IF g_aza.aza77 MATCHES '[Yy]' THEN
               CALL cl_set_act_visible("ebo_transfer", TRUE)
           ELSE
                CALL cl_set_act_visible("ebo_transfer",FALSE)
            END IF
         ELSE
            CALL cl_set_act_visible("ebo_status_query",FALSE)
            CALL cl_set_act_visible("ebo_transfer",FALSE)
            CALL cl_set_comp_visible("sendtype", FALSE)
         END IF
         #-----#No:FUN-960117 EBO add end -----

         #如果由表單追蹤區觸發程式, 此參數指定為何種資料匣
         #當為 EasyFlow 簽核時, 加入 EasyFlow 簽核 toolbar icon
         CALL aws_efapp_toolbar()

         IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
            CASE g_argv2_str  #FUN-C80078 g_argv2-->g_argv2_str
               WHEN "query"
                  LET g_action_choice = "query"
                  IF cl_chk_act_auth() THEN
                     CALL t110_q()
                  END IF
               WHEN "insert"
                  LET g_action_choice = "insert"
                  IF cl_chk_act_auth() THEN
                     CALL t110_a()
                  END IF
               WHEN "efconfirm"
                  CALL t110_q()
                  CALL s_showmsg_init() #CHI-A80031 add
                  CALL t110_firm1_chk()          #CALL 原確認的 check 段
                  IF g_success = "Y" THEN
                     CALL t110_firm1_upd()       #CALL 原確認的 update 段
                  END IF
                  CALL s_showmsg()  #CHI-A80031 add
                  EXIT PROGRAM
               OTHERWISE
                  CALL t110_q()
            END CASE
         END IF
         #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
         #CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
         CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
              RETURNING g_laststage
         CALL t110_menu()
         CLOSE WINDOW t110_w17
      WHEN g_aptype = '25'

         OPEN WINDOW t110_w25 WITH FORM "aap/42f/aapq231"
            ATTRIBUTE (STYLE = g_win_style CLIPPED)
         CALL cl_ui_init()

         CALL cl_set_act_visible("appor_expense",FALSE)   #FUN-680110 add
         CALL cl_set_comp_visible("apa992",FALSE)  #No.FUN-690090 
         CALL cl_set_comp_visible("apa54,a54",FALSE)  #No.TQC-980068
         CALL t110_set_form_default()
         IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
            CASE g_argv2_str  #FUN-C80078 g_argv2-->g_argv2_str
               WHEN "query"
                  LET g_action_choice = "query"
                  IF cl_chk_act_auth() THEN
                     CALL t110_q()
                  END IF
               WHEN "insert"
                  LET g_action_choice = "insert"
                  IF cl_chk_act_auth() THEN
                     CALL t110_a()
                  END IF
               OTHERWISE
                  CALL t110_q()
            END CASE
         END IF
         WHILE TRUE
           LET g_action_choice=""
           CALL t230_menu()
           IF g_action_choice="exit" THEN EXIT WHILE END IF
         END WHILE
 
         CLOSE WINDOW t110_w25
      #No.FUN-690080 --End
   END CASE

END FUNCTION

FUNCTION t110_cs()
DEFINE  lc_qbe_sn       LIKE    gbm_file.gbm01    #No:FUN-580031  HCN
   DEFINE g_t1                           LIKE oay_file.oayslip                  #No.FUN-550030  #No.FUN-690028 VARCHAR(05)
   DEFINE  l_apa15_wc   LIKE type_file.chr1000  #TQC-750139
   CLEAR FORM                             #清除畫面
   CALL t110_misc_clear()
   #-----MOD-650085---------
   DISPLAY "g_argv3=",g_argv3
   IF NOT cl_null(g_argv3) THEN
      LET g_wc2 = " 1=1"
      DISPLAY "LENGTH(g_argv3)=",LENGTH(g_argv3)
      IF LENGTH(g_argv3) > 11 THEN
         LET g_wc = " apa01 IN ",g_argv3 CLIPPED," "
      ELSE
        LET g_wc = " apa01 = '",g_argv3 CLIPPED,"'"
      END IF
   ELSE
   DISPLAY "g_wc=",g_wc
   #-----END MOD-650085-----

 ## MOD-4A0253
   IF NOT cl_null(g_argv1_apa01) THEN     #FUN-C80078 g_argv1-->g_argv1_apa01
     #IF LENGTH(g_argv1_apa01) > 17 THEN     #No:FUN-560196  #FUN-C80078 g_argv1-->g_argv1_apa01#TQC-CB0071 mark
      IF LENGTH(g_argv1_apa01) > 20 THEN #TQC-CB0071 add
         LET g_wc=" apa01 IN ",g_argv1_apa01 CLIPPED," "  #FUN-C80078 g_argv1-->g_argv1_apa01
      ELSE
         LET g_wc=" apa01='",g_argv1_apa01 CLIPPED,"'"  #FUN-C80078 g_argv1-->g_argv1_apa01
      END IF
   ELSE                                                  #FUN-880095
   IF NOT cl_null(g_argv4) THEN                          #FUN-880095
      LET g_wc = " 1=1"                                  #FUN-880095
   ELSE                                                           	
      CALL cl_set_head_visible("","YES")     #No.FUN-6B0033

      INITIALIZE g_apa.* TO NULL    #No.FUN-750051
      IF NOT (g_aptype='23' OR g_aptype='24' OR g_aptype='25') THEN   #MOD-880101 add
         CONSTRUCT BY NAME g_wc ON
                apa01,apa02,apa05,apa06,apa07,apa21,
                apa22,apa930,apa44,apa992,apa63,apamksg,apa42,apa41, #FUN-670064  #No.FUN-690090 add apa992
                #apa36,apa13,apa14,apa08,apa15,apa16,  #FUN-5C0106
                #apa36,apa13,apa14,apa15,apa16,apa08,   #FUN-5C0106 apa08在apa15,16之後    #MOD-6A0124
                apa36,apa13,apa14,apa15,apa16,apa08,apa77,apa58,   #FUN-5C0106 apa08在apa15,16之後 #MOD-6A0124 #FUN-970108 add apa77
                apa11,apa12,apa24,apa64,apa55,
               #apa31f,apa32f,apa65f,apa34f,apa35f,apa60f,apa61f, #FUN-640035
                apa31f,apa32f,apa60f,apa61f,apa65f,apa37f,apa34f,apa35f, #FUN-640035 #No.FUN-690080
               #apa31,apa32,apa65,apa34,apa35,apa60,apa61, #FUN-640035
                apa31,apa32,apa60,apa61,apa65,apa37,apa34,apa35,         #FUN-640035 #No.FUN-690080
#               apa51,apa52,apa54,apa19,apa20,
                apa19,apa20,       #No.FUN-680029
                apa56,apa33,apa66,apa25,apa100,
                apainpd,apa99,apa51,apa52,apa54,apa511,apa521,apa541,    #No.FUN-680029
                apa101,apa102,                                           #No.FUN-690080
                apauser,apagrup,apamodu,apadate,apaacti,
               #FUN-850038   ---start---
                apaud01,apaud02,apaud03,apaud04,apaud05,
                apaud06,apaud07,apaud08,apaud09,apaud10,
                apaud11,apaud12,apaud13,apaud14,apaud15
               #FUN-850038    ----end----

            #No:FUN-580031 --start--     HCN
            BEFORE CONSTRUCT
               CALL cl_qbe_init()
               CALL cl_set_act_visible("qbe_save",FALSE)
            #No:FUN-580031 --end--       HCN

          #TQC-750139
            AFTER FIELD apa15
               CALL GET_FLDBUF(apa15) RETURNING l_apa15_wc
               LET l_apa15_wc = cl_replace_str(l_apa15_wc,"|","','")
               LET l_apa15_wc = "'",l_apa15_wc CLIPPED,"'"
          #TQC-750139
 
            ON ACTION CONTROLP
               CASE
                  WHEN INFIELD(apa01) #查詢單据
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_apa"
                     LET g_qryparam.arg1 = g_aptype
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa01
                     NEXT FIELD apa01
                  WHEN INFIELD(apa05) #PAY TO VENDOR
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_pmc1"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa05
                     NEXT FIELD apa05
                  WHEN INFIELD(apa06) #PAY TO VENDOR
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     #No.FUN-690080 --Begin
                     IF g_aptype = '13' OR g_aptype = '17' OR g_aptype = '25' THEN
                        #LET g_qryparam.form ="q_cpf4"         #No:CHI-780046
                        LET g_qryparam.form ="q_gen"          #No:CHI-780046   
                     ELSE
              #          LET g_qryparam.form ="q_pmc1"  #MOD-960121 
                        LET g_qryparam.form ="q_pmc"  #MOD-960121
                     END IF
                     #No.FUN-690080 --End
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa06
                  WHEN INFIELD(apa11) # PAY TERM
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_pma"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa11
                  WHEN INFIELD(apa13) # CURRENCY
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_azi"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa13
                  WHEN INFIELD(apa15) # TAX CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_gec8" #MOD-990132 q_gec-->q_gec8
                     LET g_qryparam.arg1 = '1' #MOD-990132 
                    #No.TQC-930073--begin--
                     IF g_prog = 'aapt160' OR g_prog = 'aapt260' THEN
                        LET g_qryparam.where = " gec05 = 'X' AND gec06 = '2' "  #No.MOD-940297 add gec06 
                     END IF
                    #No.TQC-930073---end--- 
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa15
                  #FUN-970108--Begin
                  WHEN INFIELD(apa77)
                     CALL cl_init_qry_var()
                     LET g_qryparam.state= "c"
                     LET g_qryparam.form = "q_ama02"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa77
                  #FUN-970108---End
                  WHEN INFIELD(apa19) # HOLD CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_apo"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa19
                  WHEN INFIELD(apa07) # Employee CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                    #LET g_qryparam.form ="q_gen"                  #TQC-C70027    mark
                    #LET g_qryparam.form ="q_apa11"                #TQC-C70027 add #MOD-CC0238 mark
                    #------------MOD-CC0238------------(S)
                     IF g_aptype = '12'  THEN
                        LET g_qryparam.form ="q_pmc"
                     ELSE
                        LET g_qryparam.form ="q_gen"
                     END IF
                    #------------MOD-CC0238------------(E)
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa07
                  WHEN INFIELD(apa21) # Employee CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_gen"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa21
                  WHEN INFIELD(apa22) # Dept CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_gem"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa22
                  WHEN INFIELD(apa36) # Class
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_apr"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa36
                  WHEN INFIELD(apa51) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa51
                  WHEN INFIELD(apa52) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa52
                  WHEN INFIELD(apa54) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa54
#No.FUN-680029--begin
                  WHEN INFIELD(apa511) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa511
                  WHEN INFIELD(apa521) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa521
                  WHEN INFIELD(apa541) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa541
#No.FUN-680029--end
                  #No.FUN-690080 --Begin
                  WHEN INFIELD(apa101)   #還款銀行
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_nma"
          #No.TQC-6C0074--begin
                     IF g_aptype='13' THEN
                         LET g_qryparam.where ="nma28 !=1 and nma37 !=0 and nma10='",g_apa.apa13,"'" 
                     END IF
          #No.TQC-6C0074--end
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa101
                  WHEN INFIELD(apa102)   #還款異動碼
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_nma"
          #No.TQC-6C0074--begin
                     IF g_aptype='13' THEN
                        LET g_qryparam.where =" nmc03=1"
                     END IF
          #No.TQC-6C0074--end
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa102
                  #No.FUN-690080 --End
                  WHEN INFIELD(apa66) #專案代號
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     #LET g_qryparam.form ="q_pja"    #FUN-810045
                     LET g_qryparam.form ="q_pja2"    #FUN-810045 
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa66
                  #FUN-670064...............begin
                  WHEN INFIELD(apa930)
                     CALL cl_init_qry_var()
                     LET g_qryparam.form  = "q_gem4"
                     LET g_qryparam.state = "c"   #多選
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa930
                     NEXT FIELD apa930
                  #FUN-670064...............end
                  OTHERWISE EXIT CASE
               END CASE

            ON IDLE g_idle_seconds
               CALL cl_on_idle()
               CONTINUE CONSTRUCT
 
            ON ACTION about         #MOD-4C0121
               CALL cl_about()      #MOD-4C0121
 
            ON ACTION help          #MOD-4C0121
               CALL cl_show_help()  #MOD-4C0121
 
            ON ACTION controlg      #MOD-4C0121
               CALL cl_cmdask()     #MOD-4C0121
 
            #No:FUN-580031 --start--     HCN
            ON ACTION qbe_select
               CALL cl_qbe_list() RETURNING lc_qbe_sn
               CALL cl_qbe_display_condition(lc_qbe_sn)
 
         END CONSTRUCT
         #NO:FUN-580031 --start--
         CALL cl_set_act_visible("qbe_save",TRUE)
         #No:FUN-580031 ---end---
     #str MOD-880101 add
      ELSE
         CONSTRUCT BY NAME g_wc ON
                apa01,apa02,apa05,apa06,apa07,apa21,
                apa22,apa930,apa992,apa63,apamksg,apa42,apa41, #FUN-670064  #No.FUN-690090 add apa992
                #apa36,apa13,apa14,apa08,apa15,apa16,  #FUN-5C0106
                #apa36,apa13,apa14,apa15,apa16,apa08,   #FUN-5C0106 apa08在apa15,16之後    #MOD-6A0124
                apa36,apa13,apa14,apa15,apa16,apa08,apa77,apa58,   #FUN-5C0106 apa08在apa15,16之後 #MOD-6A0124 #FUN-970108 add apa77
                apa11,apa12,apa24,apa64,apa55,
               #apa31f,apa32f,apa65f,apa34f,apa35f,apa60f,apa61f, #FUN-640035
                apa31f,apa32f,apa60f,apa61f,apa65f,apa37f,apa34f,apa35f, #FUN-640035 #No.FUN-690080
               #apa31,apa32,apa65,apa34,apa35,apa60,apa61, #FUN-640035
                apa31,apa32,apa60,apa61,apa65,apa37,apa34,apa35,         #FUN-640035 #No.FUN-690080
#               apa51,apa52,apa54,apa19,apa20,
                apa19,apa20,       #No.FUN-680029
                apa56,apa33,apa66,apa25,apa100,
                apainpd,apa99,apa51,apa52,apa54,apa511,apa521,apa541,    #No.FUN-680029
                apa101,apa102,                                           #No.FUN-690080
                apauser,apagrup,apamodu,apadate,apaacti,
               #FUN-850038   ---start---
                apaud01,apaud02,apaud03,apaud04,apaud05,
                apaud06,apaud07,apaud08,apaud09,apaud10,
                apaud11,apaud12,apaud13,apaud14,apaud15
               #FUN-850038    ----end----

            #No:FUN-580031 --start--     HCN
            BEFORE CONSTRUCT
               CALL cl_qbe_init()
            #No:FUN-580031 --end--       HCN

          #TQC-750139
            AFTER FIELD apa15
               CALL GET_FLDBUF(apa15) RETURNING l_apa15_wc
               LET l_apa15_wc = cl_replace_str(l_apa15_wc,"|","','")
               LET l_apa15_wc = "'",l_apa15_wc CLIPPED,"'"
          #TQC-750139
 
            ON ACTION CONTROLP
               CASE
                  WHEN INFIELD(apa01) #查詢單据
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_apa"
                     LET g_qryparam.arg1 = g_aptype
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa01
                     NEXT FIELD apa01
                  WHEN INFIELD(apa05) #PAY TO VENDOR
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_pmc1"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa05
                     NEXT FIELD apa05
                  WHEN INFIELD(apa06) #PAY TO VENDOR
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     #No.FUN-690080 --Begin
                     IF g_aptype = '13' OR g_aptype = '17' OR g_aptype = '25' THEN
                        #LET g_qryparam.form ="q_cpf4"         #No:CHI-780046
                        LET g_qryparam.form ="q_gen"          #No:CHI-780046   
                     ELSE
                     #   LET g_qryparam.form ="q_pmc1"   #MOD-960121
                        LET g_qryparam.form ="q_pmc"  #MOD-960121
                     END IF
                     #No.FUN-690080 --End
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa06
                  WHEN INFIELD(apa11) # PAY TERM
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_pma"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa11
                  WHEN INFIELD(apa13) # CURRENCY
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_azi"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa13
                  WHEN INFIELD(apa15) # TAX CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_gec8" #MOD-990132 q_gec-->q_gec8
                     LET g_qryparam.arg1 = '1' #MOD-990132
                    #No.TQC-930073--begin--
                     IF g_prog = 'aapt160' OR g_prog = 'aapt260' THEN
                        LET g_qryparam.where = " gec05 = 'X' AND gec06 = '2' "  #No.MOD-940297 add gec06 
                     END IF
                    #No.TQC-930073---end--- 
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa15
                  #FUN-970108--Begin
                  WHEN INFIELD(apa77)
                     CALL cl_init_qry_var()
                     LET g_qryparam.state= "c"
                     LET g_qryparam.form = "q_ama02"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa77
                  #FUN-970108---End
                  WHEN INFIELD(apa19) # HOLD CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_apo"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa19
                  WHEN INFIELD(apa07) # Employee CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                    #LET g_qryparam.form ="q_gen"                   #TQC-C70027 mark
                    #LET g_qryparam.form ="q_apa11"                 #TQC-C70027 add #MOD-CC0238 mark
                    #------------MOD-CC0238------------(S)
                     IF g_aptype = '12'  THEN
                        LET g_qryparam.form ="q_pmc"
                     ELSE
                        LET g_qryparam.form ="q_gen"
                     END IF
                    #------------MOD-CC0238------------(E)
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa07
                  WHEN INFIELD(apa21) # Employee CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_gen"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa21
                  WHEN INFIELD(apa22) # Dept CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_gem"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa22
                  WHEN INFIELD(apa36) # Class
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_apr"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa36
                  WHEN INFIELD(apa51) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa51
                  WHEN INFIELD(apa52) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa52
                  WHEN INFIELD(apa54) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa54
#No.FUN-680029--begin
                  WHEN INFIELD(apa511) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa511
                  WHEN INFIELD(apa521) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa521
                  WHEN INFIELD(apa541) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa541
#No.FUN-680029--end
                  #No.FUN-690080 --Begin
                  WHEN INFIELD(apa101)   #還款銀行
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_nma"
          #No.TQC-6C0074--begin
                     IF g_aptype='13' THEN
                         LET g_qryparam.where ="nma28 !=1 and nma37 !=0 and nma10='",g_apa.apa13,"'" 
                     END IF
          #No.TQC-6C0074--end
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa101
                  WHEN INFIELD(apa102)   #還款異動碼
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_nma"
          #No.TQC-6C0074--begin
                     IF g_aptype='13' THEN
                        LET g_qryparam.where =" nmc03=1"
                     END IF
          #No.TQC-6C0074--end
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa102
                  #No.FUN-690080 --End
                  WHEN INFIELD(apa66) #專案代號
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     #LET g_qryparam.form ="q_pja"    #FUN-810045
                     LET g_qryparam.form ="q_pja2"    #FUN-810045 
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa66
                  #FUN-670064...............begin
                  WHEN INFIELD(apa930)
                     CALL cl_init_qry_var()
                     LET g_qryparam.form  = "q_gem4"
                     LET g_qryparam.state = "c"   #多選
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa930
                     NEXT FIELD apa930
                  #FUN-670064...............end
                  OTHERWISE EXIT CASE
               END CASE

            ON IDLE g_idle_seconds
               CALL cl_on_idle()
               CONTINUE CONSTRUCT
 
            ON ACTION about         #MOD-4C0121
               CALL cl_about()      #MOD-4C0121
 
            ON ACTION help          #MOD-4C0121
               CALL cl_show_help()  #MOD-4C0121
 
            ON ACTION controlg      #MOD-4C0121
               CALL cl_cmdask()     #MOD-4C0121
 
            #No:FUN-580031 --start--     HCN
            ON ACTION qbe_select
               CALL cl_qbe_select()
 
            ON ACTION qbe_save
               CALL cl_qbe_save()

         END CONSTRUCT
         #NO:FUN-580031 --start--
         CALL cl_set_act_visible("qbe_save",TRUE)
         #No:FUN-580031 ---end---
      END IF
     #end MOD-880101 add
      IF INT_FLAG THEN
         #LET INT_FLAG=0          #No:9599 #No.FUN-690080
         LET g_apa.apa01 = NULL   #MOD-660086 add
         LET g_apa_rowid = NULL   #MOD-660086 add
         RETURN
      END IF
   END IF
   END IF                         #FUN-880095

   #資料權限的檢查
   IF g_priv2='4' THEN                           #只能使用自己的資料
      LET g_wc = g_wc clipped," AND apauser = '",g_user,"'"
   END IF

   IF g_priv3='4' THEN                           #只能使用相同群的資料
      LET g_wc = g_wc clipped," AND apagrup MATCHES '",g_grup CLIPPED,"*'"
   END IF

   IF g_priv3 MATCHES "[5678]" THEN    #TQC-5C0134群組權限
      LET g_wc = g_wc clipped," AND apagrup IN ",cl_chk_tgrup_list()
   END IF


   LET g_wc2 = " 1=1"
   IF NOT cl_null(g_argv4) THEN                          #FUN-880095
      IF LENGTH(g_argv4) > 17 THEN                       #FUN-880095
         LET g_wc2=" apb06 IN ",g_argv4 CLIPPED," "      #FUN-880095
      ELSE                                               #FUN-880095
         LET g_wc2=" apb06='",g_argv4 CLIPPED,"'"        #FUN-880095
      END IF                                             #FUN-880095
   ELSE                                                  #FUN-880095
   IF g_apb_sarrno > 0 AND cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
      CONSTRUCT g_wc2 ON apb02,apb33,apb11,apb21,apb22,apb34,apb06,apb07,  #No.TQC-7B0083   #FUN-810045 30/31移至36後
                         apb12,apb27,   #CHI-B50012 add
                        #apb09,apb35,apb36,apb31,apb30,apb32,apb25,apb251,apb26,          #FUN-650033 add apb31  #No.FUN-680029 #No.FUN-690080   #TQC-750139 add apb11  #FUN-810045 add apb35/36  #No.FUN-830161 remove apb30
                         apb09,apb35,apb36,apb31,apb32,apb25,apb251,apb26,          #FUN-650033 add apb31  #No.FUN-680029 #No.FUN-690080   #TQC-750139 add apb11  #FUN-810045 add apb35/36  #No.FUN-830161 remove apb30
                         apb930,apb23,apb24,apb08,apb10,apb29     #FUN-670064
                        #No:FUN-850038 --start--
                        ,apbud01,apbud02,apbud03,apbud04,apbud05
                        ,apbud06,apbud07,apbud08,apbud09,apbud10
                        ,apbud11,apbud12,apbud13,apbud14,apbud15
                        #No:FUN-850038 ---end---
             FROM s_apb[1].apb02,s_apb[1].apb33,s_apb[1].apb11, 
                  s_apb[1].apb21,s_apb[1].apb22,  #FUN-650033 add apb31 #No.FUN-690080     #TQC-750139 add apb11
                  s_apb[1].apb34,   #No.TQC-7B0083
                  s_apb[1].apb06,s_apb[1].apb07,
                  s_apb[1].apb12,s_apb[1].apb27,   #CHI-B50012 add
                  s_apb[1].apb09,
                # s_apb[1].apb35,s_apb[1].apb36,s_apb[1].apb31,s_apb[1].apb30,  #FUN-810045  #No.FUN-830161 remove apb30
                  s_apb[1].apb35,s_apb[1].apb36,s_apb[1].apb31,                 #FUN-810045  #No.FUN-830161 remove apb30
                  s_apb[1].apb32,  #No.FUN-690080
                  s_apb[1].apb25,s_apb[1].apb251,s_apb[1].apb26,
                  s_apb[1].apb930,s_apb[1].apb23,                  #FUN-670064  #No.FUN-680029
                  s_apb[1].apb24,s_apb[1].apb08,s_apb[1].apb10,
                  s_apb[1].apb29
                 #No:FUN-850038 --start--
                 ,s_apb[1].apbud01,s_apb[1].apbud02,s_apb[1].apbud03
		 ,s_apb[1].apbud04,s_apb[1].apbud05,s_apb[1].apbud06
                 ,s_apb[1].apbud07,s_apb[1].apbud08,s_apb[1].apbud09
		 ,s_apb[1].apbud10,s_apb[1].apbud11,s_apb[1].apbud12
                 ,s_apb[1].apbud13,s_apb[1].apbud14,s_apb[1].apbud15
                 #No:FUN-850038 ---end---

	#No:FUN-580031 --start--     HCN
	BEFORE CONSTRUCT
	   CALL cl_qbe_display_condition(lc_qbe_sn)
	#No:FUN-580031 --end--       HCN

         ON ACTION CONTROLP
            CASE
               #TQC-750139 begin
	        WHEN INFIELD(apb11)
                      CALL cl_init_qry_var()
                      LET g_qryparam.state = "c"
                      LET g_qryparam.form ="q_apk03"
                      IF cl_null(l_apa15_wc) THEN
                        LET g_qryparam.arg1 = "'%'"
                        LET g_qryparam.arg2 = "%"
                      ELSE
                        LET g_qryparam.arg1 = l_apa15_wc
                        LET g_qryparam.arg2 = "**"
                      END IF
                      CALL cl_create_qry() RETURNING g_qryparam.multiret
                      DISPLAY g_qryparam.multiret TO apb11
               #TQC-750139 end
               #FUN-930055 --start--
	       WHEN INFIELD(apb31)
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                   #FUN-810045 beign
                     #LET g_qryparam.form ="q_pjd"
                     LET g_qryparam.form ="q_azf"
                     LET g_qryparam.arg1 = '2'
                   #FUN-810045 end
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apb31
               #FUN-930055 --end ---


               WHEN INFIELD(apb21) OR INFIELD(apb22)
                  #FUN-630055 remark --start
                  #IF g_aptype='12' OR g_aptype='15' THEN
#                 #   CALL q_pjd(0,0,g_apa.apa66) RETURNING g_apb[1].apb21
                  #   CALL cl_init_qry_var()
                  #   LET g_qryparam.state = "c"
                  #   LET g_qryparam.form ="q_pjd"
                  #   CALL cl_create_qry() RETURNING g_qryparam.multiret
                  #ELSE
                  #FUN-630055 remark --end
                     IF g_aptype MATCHES '1*' THEN
                       #str FUN-7A0050 add
                       #aapt120單身apb21(暫估單號),apb22(暫估項次)開窗查aapt160費用暫估資料
                        IF g_aptype = '12' THEN
                           CALL cl_init_qry_var()
                           LET g_qryparam.state = "c"
                           LET g_qryparam.form ="q_apb"   
                           CALL cl_create_qry() RETURNING g_qryparam.multiret
                        ELSE
                       #end FUN-7A0050 add
                          #str MOD-B40070 mod
                          #CALL q_rvv(TRUE,TRUE,g_apa.apa05,g_apb[1].apb21,
                          #           g_apb[1].apb22)
                          #RETURNING g_qryparam.multiret
                           CALL q_rvv2(TRUE,TRUE,g_apa.apa05,
                                       g_apb[1].apb21,g_apb[1].apb22,g_apb[1].apb29)
                           RETURNING g_qryparam.multiret
                          #end MOD-B40070 mod
                        END IF   #FUN-7A0050 add
                        DISPLAY g_qryparam.multiret TO apb21
                       #CALL cl_init_qry_var()
                       #LET g_qryparam.state = "c"
                       #LET g_qryparam.form ="q_rvv"
                       #LET g_qryparam.arg1 = g_apa.apa05
                       #CALL cl_create_qry() RETURNING g_qryparam.multiret
                     ELSE
                       #str MOD-850316 add
                       #aapt210單身apb21(暫估單號),apb22(暫估項次)開窗查aapt260扣款折讓暫估資料
                        IF g_aptype = '21' THEN
                           CALL cl_init_qry_var()
                           LET g_qryparam.state = "c"
                           LET g_qryparam.form ="q_apb1"   
                           LET g_qryparam.where ="apa01 ='",g_apa.apa05,"'"       #MOD-C60170 add 
                           CALL cl_create_qry() RETURNING g_qryparam.multiret
                        ELSE
                       #end MOD-850316 add
                           CALL q_rvv2(TRUE,TRUE,g_apa.apa05,
                                       g_apb[1].apb21,g_apb[1].apb22,'3')
                           RETURNING g_qryparam.multiret
                        END IF   #MOD-850316 add
                        DISPLAY g_qryparam.multiret TO apb21
                       #CALL cl_init_qry_var()
                       #LET g_qryparam.state = "c"
                       #LET g_qryparam.form ="q_rvv2"
                       #LET g_qryparam.arg1 = g_apa.apa05
                       #LET g_qryparam.arg2 = '3'
                       #CALL cl_create_qry() RETURNING g_qryparam.multiret
                     END IF
                  #END IF  #FUN-630055 remark
                  IF INFIELD(apb21) THEN
                     DISPLAY g_qryparam.multiret TO apb21
                  END IF
                  IF INFIELD(apb22) THEN
                     DISPLAY g_qryparam.multiret TO apb22
                  END IF
               WHEN INFIELD(apb25) # Account number
#                 CALL q_aag(0,0,g_apb[1].apb25,'','','')
#                      RETURNING g_apb[1].apb25
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
                 #LET g_qryparam.form ="q_aag02"   #TQC-790133    #No.TQC-7B0122 mark
                 #LET g_qryparam.arg1 = g_bookno1  #No.TQC-7B0122 #MOD-990250
                  LET g_qryparam.form ="q_aag"   #No.TQC-7B0122  #MOD-990250 q_aag10-->q_aag
                  LET g_qryparam.where = " aag07 IN ('2','3') AND aag03 IN ('2')" #MOD-990250
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apb25
#No.FUN-680029--begin
               WHEN INFIELD(apb251) # Account number
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
                 #LET g_qryparam.form ="q_aag02"   #TQC-790133    #No.TQC-7B0122 mark
                  LET g_qryparam.form ="q_aag"   #No.TQC-7B0122   #MOD-990250 q_aag10-->q_aag
                  LET g_qryparam.where = " aag07 IN ('2','3') AND aag03 IN ('2')" #MOD-990250
                 #LET g_qryparam.arg1 = g_bookno2  #No.TQC-7B0122 #MOD-990250
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apb251
#No.FUN-680029--end
               WHEN INFIELD(apb26) # Dept CODE
#                 CALL q_gem(0,0,g_apb[1].apb26)
#                      RETURNING g_apb[1].apb26
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
                  LET g_qryparam.form ="q_gem"
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apb26
               WHEN INFIELD(apb06)
#                 CALL q_pmm(6,3,g_apb[1].apb06)
#                      RETURNING g_apb[1].apb06
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
                  LET g_qryparam.form ="q_pmm"
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apb06
               WHEN INFIELD(apb12) #料件編號
#                 CALL q_ima(0,0,g_apb[1].apb12)
#                            RETURNING g_apb[1].apb12
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
                  LET g_qryparam.form ="q_ima"
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apb12
                  NEXT FIELD apb12
               WHEN INFIELD(apb28) #採購單位
#                 CALL q_gfe(10,3,g_apb[1].apb28)
#                            RETURNING g_apb[1].apb28
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
                  LET g_qryparam.form ="q_gfe"
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apb28
                  NEXT FIELD apb28
               #FUN-670064...............begin
               #No.FUN-690080 --Begin
               WHEN INFIELD(apb32) #人員編號
                  CALL cl_init_qry_var()
                  #LET g_qryparam.form  = "q_cpf4"       #No:CHI-780046
                  LET g_qryparam.form  = "q_gen"        #No:CHI-780046   
                  LET g_qryparam.state = "c"   #多選
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apb32
                  NEXT FIELD apb32
             #FUN-810045 begin
                WHEN INFIELD(apb35)   #專案
                  CALL cl_init_qry_var()
                  LET g_qryparam.form ="q_pja2"  
                  LET g_qryparam.state = "c"   #多選
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apb35
                  NEXT FIELD apb35
                WHEN INFIELD(apb36)  #WBS
                  CALL cl_init_qry_var()
                  LET g_qryparam.form ="q_pjb4"
                  LET g_qryparam.state = "c"   #多選
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apb36
                  NEXT FIELD apb36
             #FUN-810045 end
               #No.FUN-830161  --Begin remove apb30
               #WHEN INFIELD(apb30) #預算編號
               #   CALL cl_init_qry_var()
               #   LET g_qryparam.form  = "q_afa"
               #   LET g_qryparam.state = "c"   #多選
               #   CALL cl_create_qry() RETURNING g_qryparam.multiret
               #   DISPLAY g_qryparam.multiret TO apb30
               #   NEXT FIELD apb30
               #No.FUN-830161  --End   remove apb30
               #No.FUN-690080 --End
               WHEN INFIELD(apb930)
                  CALL cl_init_qry_var()
                  LET g_qryparam.form  = "q_gem4"
                  LET g_qryparam.state = "c"   #多選
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apb930
                  NEXT FIELD apb930
               #FUN-670064...............end
               OTHERWISE
                  EXIT CASE
            END CASE

         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE CONSTRUCT
 
          ON ACTION about         #MOD-4C0121
             CALL cl_about()      #MOD-4C0121
 
          ON ACTION help          #MOD-4C0121
             CALL cl_show_help()  #MOD-4C0121
 
          ON ACTION controlg      #MOD-4C0121
             CALL cl_cmdask()     #MOD-4C0121
 
		#No:FUN-580031 --start--     HCN
                    ON ACTION qbe_save
		       CALL cl_qbe_save()
		#No:FUN-580031 --end--       HCN
      END CONSTRUCT
 
      IF INT_FLAG THEN
         #LET INT_FLAG=0          #No.FUN-690080
         LET g_apa.apa01 = NULL   #MOD-660086 add
         LET g_apa_rowid = NULL   #MOD-660086 add
         RETURN
      END IF
   END IF
   END IF   #FUN-880095   
   END IF   #MOD-650085
   

   IF g_wc2 = " 1=1" THEN               # 若單身未輸入條件
      LET g_sql = "SELECT ROWID, apa01 FROM apa_file ",
                  " WHERE ", g_wc CLIPPED,
                  "   AND apa00 = '",g_aptype,"'",
                  " ORDER BY apa01"
   ELSE                         # 若單身有輸入條件
      LET g_sql = "SELECT UNIQUE apa_file.ROWID, apa01 ",
                  "  FROM apa_file, apb_file ",
                  " WHERE apa01 = apb01",
                  "   AND ", g_wc CLIPPED, " AND ",g_wc2 CLIPPED,
                  "   AND apa00 = '",g_aptype,"'",
                  " ORDER BY apa01"
   END IF

   PREPARE t110_prepare FROM g_sql
   DECLARE t110_cs                         #SCROLL CURSOR
       SCROLL CURSOR WITH HOLD FOR t110_prepare

   IF g_wc2 = " 1=1" THEN               # 取合乎條件筆數
      LET g_sql="SELECT COUNT(*) FROM apa_file WHERE ",g_wc CLIPPED,
                "   AND apa00 = '",g_aptype,"'"
   ELSE
      LET g_sql="SELECT COUNT(DISTINCT apa01) FROM apa_file,apb_file WHERE ",
                "apb01=apa01 AND ",g_wc CLIPPED," AND ",g_wc2 CLIPPED,
                "   AND apa00 = '",g_aptype,"'"
   END IF

   PREPARE t110_precount FROM g_sql
   DECLARE t110_count CURSOR FOR t110_precount

END FUNCTION

FUNCTION t110_menu()
   DEFINE l_creator    LIKE type_file.chr1        # No:FUN-690028 VARCHAR(1)
   DEFINe l_flowuser   LIKE type_file.chr1        # No:FUN-690028 VARCHAR(1)         # 是否有指定加簽人員      #FUN-580011
   DEFINE l_azp03      LIKE azp_file.azp03  # FUN-630043
   DEFINE l_pmb02      LIKE pmb_file.pmb02  #TQC-770027
   DEFINE l_cnt        LIKE type_file.num5  #No.MOD-890007  

   LET l_flowuser = "N"

   WHILE TRUE
      CALL t110_bp("G")
      CASE g_action_choice

      WHEN "insert"
         IF cl_chk_act_auth() THEN
            CALL t110_a()
         END IF
      WHEN "delete"
         IF cl_chk_act_auth() THEN
            CALL t110_r()
         END IF
      WHEN "modify"
         IF cl_chk_act_auth() THEN
            CALL t110_u()
         END IF
      WHEN "query"
         IF cl_chk_act_auth() THEN
            CALL t110_q()
         END IF
      WHEN "first"
         CALL t110_fetch('F')
      WHEN "previous"
         CALL t110_fetch('P')
      WHEN "jump"
         CALL t110_fetch('/')
      WHEN "next"
         CALL t110_fetch('N')
      WHEN "last"
         CALL t110_fetch('L')
      WHEN "reproduce"
         IF cl_chk_act_auth() THEN
            CALL t110_copy()
         END IF
      WHEN "detail"
         IF cl_chk_act_auth() THEN
            #FUN-630043
            IF g_aza.aza53='Y' THEN
               SELECT azp03 INTO l_azp03 FROM azp_file WHERE azp01=g_apa.apa100
               IF STATUS THEN LET l_azp03=g_dbs END IF
               IF g_dbs!=l_azp03 AND (g_apa.apa100='11' OR g_apa.apa100='12' OR g_apa.apa100='15' OR g_apa.apa100='21' OR g_apa.apa100='22') THEN  
                  DATABASE l_azp03    
                  CALL t110_b('b')
                  DATABASE g_dbs  
               ELSE
                  CALL t110_b('b')
               END IF
            ELSE
               CALL t110_b('b')
            END IF
            #FUN-630043
         ELSE
            LET g_action_choice = NULL
         END IF
      WHEN "help"
         CALL cl_show_help()
      WHEN "exit"
         EXIT WHILE
      WHEN "controlg"
         CALL cl_cmdask()

      #FUN-4B0009
      WHEN "exporttoexcel"
          IF cl_chk_act_auth() THEN
             CALL cl_export_to_excel
             (ui.Interface.getRootNode(),base.TypeInfo.create(g_apb),'','')
          END IF
      #--

#No.FUN-680027--begin
      WHEN "account_period"
         IF cl_chk_act_auth() THEN
            CALL t110_account_period()
         END IF
#No.FUN-680027--end   
      WHEN "on_hold"
         IF cl_chk_act_auth() THEN
            CALL t110_hold()
         END IF
      WHEN "undo_on_hold"
         IF cl_chk_act_auth() THEN
            CALL t110_unhold()
         END IF
      WHEN "mul_invoice"
         CALL t110_ddd('2')   #MOD-950112 add參數
         DISPLAY BY NAME g_apa.apa07      #TQC-630164   
         CALL t110_diff_rtn('0')          #MOD-B80300
         CALL t110_show_multi_invoice()   #No.TQC-A30076
      WHEN "mul_debit"
         IF g_apa.apa51='MISC' OR g_apa.apa511 ='MISC' THEN         #No.FUN-680029
            CALL t110_ccc('1')
         #No.TQC-A30133  --Begin
         ELSE
            CALL cl_err(g_apa.apa51,'aap-704',0)
         #No.TQC-A30133  --End  
         END IF
      WHEN "contra_tmp_est"
        #IF g_apa.apa51='UNAP' THEN  #No.TQC-7B0083
            CALL t110_ppp('2')
        #END IF                      #No.TQC-7B0083
      WHEN "qry_contra"
         CALL t110_pay_record()
      WHEN "memo"
         CALL t110_m()
      WHEN "var_process"
         IF cl_chk_act_auth() THEN
            IF NOT cl_null(g_apa.apa01) THEN   #No.TQC-860014
               CALL t110_diff_rtn('0')  #TQC-750140
               CALL t110_api_diff()     #No.TQC-7B0083
            END IF                             #No.TQC-860014
         END IF
      WHEN "output"
         IF cl_chk_act_auth() THEN
            CALL t110_out('o')
         END IF
      WHEN "contra"
         #No.TQC-740080 --start--
         CASE
            WHEN g_aptype = '16' OR g_aptype = '26'
               CALL cl_err(g_apa.apa01,'aap-926',0)
            WHEN g_apa.apa42 = 'Y'
               CALL cl_err(g_apa.apa01,'aap-927',0)
            OTHERWISE
         #No.TQC-740080 --end--
               #No.FUN-690080 --Begin
               #IF g_aptype = '13' THEN                    #TQC-750139
               IF g_aptype = '13' OR g_aptype = '17' THEN  #TQC-750139
                  CALL t110_k_2()
                  CALL t110_apc_check2()   #MOD-8C0082 add
               ELSE
                  CALL t110_k()
                  CALL t110_apc_check2()   #CHI-820015
               END IF
               #No.FUN-690080 --End
         END CASE
      #No.FUN-690080 --Begin
      WHEN "revert" #還款
         IF cl_chk_act_auth() THEN
            CALL t110_k_1()
         END IF
      WHEN "revert_query" #還款查詢
         IF cl_chk_act_auth() THEN
            CALL t110_pay_record_1()
         END IF
      #No.FUN-690080 --End
      WHEN "modify_date"
         IF cl_chk_act_auth() THEN
            CALL t110_date()
         END IF
      WHEN "pay_direct"
         IF cl_chk_act_auth() THEN
           #No.MOD-890007--begin-- 
            IF cl_null(g_apa.apa01) THEN 
#              RETURN                                    #TQC-A70123 Mark                                                           
               CALL cl_err('','axr-072',1)               #TQC-A70123 Add                                                            
               LET g_action_choice = NULL                #TQC-A70123 Add                                                            
               CONTINUE WHILE                            #TQC-A70123 Add 
            END IF 
            LET l_cnt = 0 
            SELECT COUNT(*) INTO l_cnt FROM apb_file 
             WHERE apb01=g_apa.apa01 AND apb34='Y'
           #No.MOD-890007---end--- 
            CASE
              # WHEN g_apa.apa51 ='UNAP'                 #No:MOD-530047 Mark
              #    CALL cl_err(g_apa.apa51,'aap-029',0)  #No:MOD-530047 Mark
               #WHEN g_apa.apa08 = 'UNAP'     #TQC-5B0016   #TQC-610135
              #WHEN g_apa.apa08 = 'UNAP' AND g_apa.apa00='11'    #TQC-610135  #No.MOD-890007
               WHEN (g_apa.apa51 = 'UNAP' OR l_cnt > 0 ) #No.MOD-890007 
                 #CALL cl_err(g_apa.apa08,'aap-029',0)   #TQC-5B0016  #No.MOD-890007
                  CALL cl_err(g_apa.apa51,'aap-029',0)   #No.MOD-890007 
               WHEN g_apa.apa42 = 'Y' #已作廢
                  CALL cl_err(g_apa.apa01,'aap-165',0)
               #WHEN g_apa.apa41 = 'Y' #MOD-710040   #FUN-770043
               #   CALL cl_err(g_apa.apa01,'aap-086',0)   #MOD-710040   #FUN-770043
               #No.TQC-740080 --start--
               WHEN g_aptype = '16' OR g_aptype = '26'
                  CALL cl_err(g_apa.apa01,'aap-926',0)
               #No.TQC-740080 --end--
               OTHERWISE
                  CALL t110_w(g_apa.apa01)
                  SELECT * INTO g_apa.* FROM apa_file WHERE apa01=g_apa.apa01
                  CALL t110_unpay()     #No:MOD-650063
                  DISPLAY BY NAME g_apa.apa55,g_apa.apa35f,g_apa.apa35   #TQC-630088
#TQC-770027.....begin
                 #str MOD-880080 mark
                 #IF g_apa.apa31 <> g_apa_t.apa31  OR g_apa.apa32 <> g_apa_t.apa32  OR
                 #   g_apa.apa34 <> g_apa_t.apa34  OR g_apa.apa57 <> g_apa_t.apa57  OR
                 #   g_apa.apa57 <> g_apa_t.apa57  OR g_apa.apa73 <> g_apa_t.apa73  OR
                 #   g_apa.apa31f<> g_apa_t.apa31f OR g_apa.apa32f<> g_apa_t.apa32f OR
                 #   g_apa.apa34f<> g_apa_t.apa34f OR g_apa.apa57f<> g_apa_t.apa57f THEN
                 #end MOD-880080 mark
#No.TQC-7B0123 --begin
#                    SELECT DISTINCT(pmb02) INTO l_pmb02 FROM pmb_file
#                     WHERE pmb01 = g_apa.apa11
                     LET g_apa_t.apa31 =g_apa.apa31
                     LET g_apa_t.apa32 =g_apa.apa32
                     LET g_apa_t.apa34 =g_apa.apa34
                     LET g_apa_t.apa57 =g_apa.apa57
                     LET g_apa_t.apa73 =g_apa.apa73
                     LET g_apa_t.apa31f =g_apa.apa31f
                     LET g_apa_t.apa32f =g_apa.apa32f
                     LET g_apa_t.apa34f =g_apa.apa34f
                     LET g_apa_t.apa57f =g_apa.apa57f
#No.TQC-7B0123 --end
                    #No.MOD-7B0009  --Begin
                    #IF l_pmb02 = 1 THEN
                    #   DELETE FROM apc_file WHERE apc01 = g_apa.apa01
                    #   CALL t110_ins_apc(g_apa.*)
                    #ELSE
                       IF g_apa.apa35 <> g_apa_t.apa35 OR g_apa.apa35f <> g_apa_t.apa35f THEN
                          LET g_sn = 'y'
                       END IF
                      #CALL t110_account_period()  #TQC-790128
                       #CALL t110_apc_check()  #TQC-790128   #MOD-830059
                      #str MOD-920102 mod
                      #CALL t110_apc_check('w')  #TQC-790128   #MOD-830059
                       IF g_apa.apa41 != 'Y' THEN
                          CALL t110_apc_check('w')
                       ELSE
                          CALL t110_apc_check('')
                       END IF
                      #end MOD-920102 mod
                       LET g_sn = 'n'
                    #END IF
                    #No.MOD-7B0009  --End  
                    #IF g_apa.apa41 <> 'Y' THEN                            #No.MOD-8B0090 #MOD-C30063 mark
                     IF g_apa.apa41 <> 'Y' AND g_apy.apydmy3 = 'Y' THEN    #MOD-C30063 add
                       #No.TQC-7C0094--begin--
                        CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'0')  
                        IF g_aza.aza63 ='Y' THEN

                           CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'1')  
                        END IF
                       #No.TQC-7C0094---end---
                     END IF    #No.MOD-8B0090
                 #END IF   #MOD-880080 mark
#TQC-770027.....end
            END CASE
         END IF
      WHEN "gen_entry"
         IF cl_chk_act_auth() THEN
            #CALL t110_v()   #MOD-740030
            CALL t110_v0()   #MOD-740030
         END IF
      WHEN "entry_sheet"
         IF cl_chk_act_auth() THEN
            #-----FUN-830091---------
            ##-----MOD-740030---------
            ##CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02b,1,g_apa.apa41,'0',g_apz.apz02p)    #No.FUN-680029
            #IF NOT cl_null(g_apa.apa99) AND cl_null(g_apa.apa44) THEN  
            #   CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02b,1,'N','0',g_apz.apz02p)    #No.FUN-680029
            #ELSE
            #   CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02b,1,g_apa.apa41,'0',g_apz.apz02p)    #No.FUN-680029
            #END IF
            ##-----END MOD-740030-----
            CALL t110_sheet('0')
            #-----END FUN-830091-----
            CALL t110_npp02('0')             #No.FUN-680029
         END IF
   
#No.FUN-680029--begin
      WHEN "entry_sheet2"
         IF cl_chk_act_auth() THEN
            #-----FUN-830091---------
            ##-----MOD-740030---------
            ##CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02c,1,g_apa.apa41,'1',g_apz.apz02p) 
            #IF NOT cl_null(g_apa.apa99) AND cl_null(g_apa.apa44) THEN  
            #   CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02c,1,'N','1',g_apz.apz02p) 
            #ELSE
            #   CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02c,1,g_apa.apa41,'1',g_apz.apz02p) 
            #END IF
            ##-----END MOD-740030-----
            CALL t110_sheet('1')
            #-----END FUN-830091-----
            CALL t110_npp02('1')
         END IF
#No.FUN-680029--end

      #-----FUN-830091---------
      WHEN "T_T_entry_sheet"
         IF cl_chk_act_auth() THEN
            CALL t110_sheet('0')
            CALL t110_npp02('0')
         END IF

      WHEN "T_T_entry_sheet2"
         IF cl_chk_act_auth() THEN
            CALL t110_sheet('1')
            CALL t110_npp02('1')
         END IF
      #-----END FUN-830091-----

      #No.FUN-670060 --start--
      WHEN "carry_voucher" 
         IF cl_chk_act_auth() THEN
            IF g_apa.apa41 = 'Y' THEN  
               CALL t110_carry_voucher() 
            ELSE 
               CALL cl_err('','atm-402',1)
            END IF 
            
         END IF 
      WHEN "undo_carry_voucher" 
         IF cl_chk_act_auth() THEN
            IF g_apa.apa41 = 'Y' THEN 
               CALL t110_undo_carry_voucher()
            ELSE 
               CALL cl_err('','atm-403',1)
            END IF
         END IF 
      #No.FUN-670060 --end--

      #FUN-5C0011 add--start
      WHEN "appor_expense"
         IF cl_chk_act_auth() THEN
            CALL t110_appor_expense()
         END IF
         
      #FUN-5C0011 add--end

      WHEN "void"
         IF cl_chk_act_auth() THEN
            CALL t110_c()
            IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
            CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,"")   #FUN-540041
         END IF
      #from t110_s()
      WHEN "single_invoice"
         CALL t110_apa17('u')
         DISPLAY BY NAME g_apa.apa07   #TQC-630164 
         DISPLAY BY NAME g_apa.apa24,g_apa.apa12,g_apa.apa64  #MOD-9C0148 add

      WHEN "qry_contra_tmp_est"
         #IF g_aptype = '11' THEN   #TQC-7B0117
         IF g_aptype = '16' THEN   #TQC-7B0117
            CALL t110_5()
         END IF

       #MOD-540018
      #WHEN "entry_detail"
      #   CALL t110_apa54()

      WHEN "qry_bill_allowance"
         CALL t110_21()
     #t110_s() end

      WHEN "confirm"
         IF cl_chk_act_auth() THEN
#FUN-580114
            #CALL t110_firm1()
            CALL s_showmsg_init() #CHI-A80031 add
            CALL t110_firm1_chk()          #CALL 原確認的 check 段
            IF g_success = "Y" THEN
               CALL t110_firm1_upd()       #CALL 原確認的 update 段
            END IF
            CALL s_showmsg()  #CHI-A80031 add
            CALL t110_show()               #No.FUN-670060
#FUN-580114 End
         END IF
      WHEN "undo_confirm"
         IF cl_chk_act_auth() THEN
            SELECT * INTO g_apa.* FROM apa_file WHERE apa01=g_apa.apa01 #MOD-980218
            IF cl_null(g_apa.apa992) THEN                      #No.FUN-690090      
               CALL t110_firm2()    
            ELSE                                      #No.FUN-690090  
               CALL cl_err(g_apa.apa992,"aap-066",0)  #No.FUN-690090   
               CONTINUE WHILE                         #No.FUN-690090  
            END IF                                    #No.FUN-690090  
            IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
            CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti)
         END IF

#FUN-580114
      #@WHEN "准"
      WHEN "agree"
         IF g_laststage = "Y" AND l_flowuser = "N" THEN  #最後一關並且沒有加簽人員
            CALL t110_firm1_upd()      #CALL 原確認的 update 段
         ELSE
            LET g_success = "Y"
            IF NOT aws_efapp_formapproval() THEN
               LET g_success = "N"
            END IF
         END IF
         IF g_success = 'Y' THEN
            IF cl_confirm('aws-081') THEN  #詢問是否繼續下一筆資料的簽核
              IF aws_efapp_getnextforminfo() THEN #取得下一筆簽核單號
                 LET l_flowuser = "N"
                 LET g_argv1_apa01 = aws_efapp_wsk(1)   #取得單號  #FUN-C80078 g_argv1-->g_argv1_apa01
                 IF NOT cl_null(g_argv1_apa01) THEN     #自動 query 帶出資料  #FUN-C80078 g_argv1-->g_argv1_apa01
                   CALL t110_q()
                  #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
                   #CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
                   CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
                        RETURNING g_laststage
                 ELSE
                     EXIT WHILE
                 END IF
               ELSE
                 EXIT WHILE
               END IF
            ELSE
               EXIT WHILE
            END IF
         END IF

      #@WHEN "不准"
       WHEN "deny"
       IF (l_creator := aws_efapp_backflow()) IS NOT NULL THEN
            IF aws_efapp_formapproval() THEN
               IF l_creator = "Y" THEN
                  LET g_apa.apa63= 'R'
                  DISPLAY BY NAME g_apa.apa63
               END IF
               IF cl_confirm('aws-081') THEN     #詢問是否繼續下一筆資料的簽核
                  IF aws_efapp_getnextforminfo() THEN #取得下一筆簽核單號
                    LET l_flowuser = "N"
                    LET g_argv1_apa01 = aws_efapp_wsk(1)    #取得單號  #FUN-C80078 g_argv1-->g_argv1_apa01
                    IF NOT cl_null(g_argv1_apa01) THEN      #自動 query 帶出資料  #FUN-C80078 g_argv1-->g_argv1_apa01
                       CALL t110_q()
                     #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
                       #CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
                       CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
                           RETURNING g_laststage
                    ELSE
                          EXIT WHILE
                    END IF
                  ELSE
                     EXIT WHILE
                  END IF
               ELSE
                  EXIT WHILE
               END IF
            END IF
         END IF

      #@WHEN "加簽"
      WHEN "modify_flow"
           IF aws_efapp_flowuser() THEN   #選擇欲加簽人員
              LET l_flowuser = 'Y'
           ELSE
              LET l_flowuser = 'N'
           END IF

      #@WHEN "撤簽"
      WHEN "withdraw"
           IF cl_confirm("aws-080") THEN
              IF aws_efapp_formapproval() THEN
                 EXIT WHILE
              END IF
           END IF

      #@WHEN "抽單"
      WHEN "org_withdraw"
           IF cl_confirm("aws-079") THEN
              IF aws_efapp_formapproval() THEN
                 EXIT WHILE
                 END IF
           END IF

      #@WHEN "簽核意見"
      WHEN "phrase"
           CALL aws_efapp_phrase()
#FUN-580114 End

     #@WHEN "簽核狀況"
      WHEN "approval_status"               # MOD-4C0041
          IF cl_chk_act_auth() THEN        #DISPLAY ONLY
             IF aws_condition2() THEN                #FUN-550042
                  CALL aws_efstat2()                  #MOD-560007
             END IF
          END IF

       WHEN "easyflow_approval"     #FUN-550042
          IF cl_chk_act_auth() THEN
               CALL t110_ef()
          END IF

      #--------#No:FUN-960117 EBO add start --------
      #@WHEN EBO狀態查詢
       WHEN "ebo_status_query"
          #-----抓取eB-Online底稿區狀態資料
          IF g_aza.aza75 MATCHES '[Yy]' AND (g_prog='aapt110' OR g_prog='aapt120') THEN
             IF g_apa.apa00='11' OR g_apa.apa00='12' THEN
                CALL aws_ebocli(g_dbs,g_apa.apa01,'*','*','*','*','EBO-120','M010','qry_maxver') RETURNING l_maxkey2
                CALL aws_ebocli(g_dbs,g_apa.apa01,l_maxkey2,'*','*','*','EBO-120','M010','query') RETURNING l_ebocode
                IF l_ebocode = "Y" OR l_ebocode = "N" THEN
                   CALL aws_ebocli_status_query(g_dbs,g_apa.apa01,l_maxkey2,'*','*','*')
                        RETURNING l_ebostep,l_eboresp
                   LET l_ebostr = ''
                   IF l_ebostep IS NULL AND l_eboresp IS NULL THEN
                      LET l_ebostr = 'aws-513'
                      CALL cl_err('',l_ebostr,1)
                   ELSE
                      LET l_ebomsg1 = ''
                      LET l_ebomsg2 = ''
                      CASE l_ebostep
                        WHEN '1'
                          CALL cl_getmsg('aws-502',g_lang) RETURNING l_ebomsg1 
                        WHEN '2'
                          CALL cl_getmsg('aws-503',g_lang) RETURNING l_ebomsg1
                        WHEN '3'
                          CALL cl_getmsg('aws-504',g_lang) RETURNING l_ebomsg1
                        WHEN '4'
                          CALL cl_getmsg('aws-505',g_lang) RETURNING l_ebomsg1
                      END CASE
                      CASE l_eboresp
                        WHEN 'A'
                          CALL cl_getmsg('aws-509',g_lang) RETURNING l_ebomsg2
                        WHEN 'R'
                          CALL cl_getmsg('aws-510',g_lang) RETURNING l_ebomsg2
                        WHEN 'C'
                          CALL cl_getmsg('aws-511',g_lang) RETURNING l_ebomsg2
                        OTHERWISE
                          CALL cl_getmsg('aws-512',g_lang) RETURNING l_ebomsg2
                      END CASE
                      LET l_ebostr = l_ebomsg1,'\n','\n',l_ebomsg2
                      CALL cl_err(l_ebostr,'!',1)
                   END IF
                END IF
             END IF
          END IF
 
       #@WHEN EBO拋轉
       WHEN "ebo_transfer"
          #-----將eB-Online底稿區拋轉碼由"n"-->"N"
          IF g_aza.aza75 MATCHES '[Yy]' AND g_aza.aza77 MATCHES '[Yy]' AND (g_prog='aapt110' OR g_prog='aapt120') THEN
             IF g_apa.apa00='11' OR g_apa.apa00='12' THEN
                CALL aws_ebocli(g_dbs,g_apa.apa01,'*','*','*','*','EBO-120','M010','qry_maxver') RETURNING l_maxkey2
                CALL aws_ebocli(g_dbs,g_apa.apa01,l_maxkey2,'*','*','*','EBO-120','M010','transfer') RETURNING l_ebocode
                LET l_ebostr = ''
                CASE l_ebocode
                  WHEN '1'
                    LET l_ebostr = 'aws-517'    #TQC-8B0031 ADD
                  WHEN '2'
                    LET l_ebostr = 'aws-506'
                  WHEN '3'
                    LET l_ebostr = 'aws-507'
                  WHEN '4'
                    LET l_ebostr = 'aws-508'
                END CASE
                CALL cl_err('',l_ebostr,1)
                CALL aws_ebocli(g_dbs,g_apa.apa01,l_maxkey2,'*','*','*','EBO-120'
                                                 ,'M010','show_transfer')
             END IF
          END IF
       #--------#No:FUN-960117 EBO add end   ---------
#No.FUN-A30106 --begin
       WHEN "drill_down"
          IF cl_chk_act_auth() THEN
             CALL t110_drill_down()
          END IF
#No.FUN-A30106 --end
       #No:FUN-6A0016-------add--------str----
       WHEN "related_document"  #相關文件
            IF cl_chk_act_auth() THEN
               IF g_apa.apa01 IS NOT NULL THEN
               LET g_doc.column1 = "apa01"
               LET g_doc.value1 = g_apa.apa01
               CALL cl_doc()
             END IF
       END IF
       #No:FUN-6A0016-------add--------end----
      END CASE
   END WHILE
END FUNCTION

FUNCTION t210_menu()
   DEFINE l_creator    LIKE type_file.chr1        # No:FUN-690028 VARCHAR(1)
   DEFINe l_flowuser   LIKE type_file.chr1        # No:FUN-690028 VARCHAR(1)         # 是否有指定加簽人員      #FUN-580011
   DEFINE l_azp03      LIKE azp_file.azp03  # FUN-630043

   LET l_flowuser = "N"

   WHILE TRUE
      CALL t210_bp("G")
      CASE g_action_choice

      WHEN "insert"
         IF cl_chk_act_auth() THEN
            CALL t110_a()
         END IF
      WHEN "query"
         IF cl_chk_act_auth() THEN
            CALL t110_q()
         END IF
     #MOD-9C0437---add---start---
      WHEN "single_invoice"
         CALL t110_apa17('u')
         DISPLAY BY NAME g_apa.apa07  
         DISPLAY BY NAME g_apa.apa24,g_apa.apa12,g_apa.apa64 
     #MOD-9C0437---add---end---
      WHEN "first"
         CALL t110_fetch('F')
      WHEN "previous"
         CALL t110_fetch('P')
      WHEN "jump"
         CALL t110_fetch('/')
      WHEN "next"
         CALL t110_fetch('N')
      WHEN "last"
         CALL t110_fetch('L')
      WHEN "modify"
         IF cl_chk_act_auth() THEN
            CALL t110_u()
         END IF
      WHEN "delete"
         IF cl_chk_act_auth() THEN
            CALL t110_r()
         END IF
      WHEN "detail"
         IF cl_chk_act_auth() THEN
            #FUN-630043
            IF g_aza.aza53='Y' THEN
               SELECT azp03 INTO l_azp03 FROM azp_file WHERE azp01=g_apa.apa100
               IF STATUS THEN LET l_azp03=g_dbs END IF
               IF g_dbs!=l_azp03 AND (g_apa.apa100='11' OR g_apa.apa100='12' OR g_apa.apa100='15' OR g_apa.apa100='21' OR g_apa.apa100='22') THEN  
                  DATABASE l_azp03    
                  CALL t110_b('b')
                  DATABASE g_dbs  
               ELSE
                  CALL t110_b('b')
               END IF
            ELSE
               CALL t110_b('b')
            END IF
            #FUN-630043
         ELSE
            LET g_action_choice = NULL
         END IF
#No.FUN-680027--begin
      WHEN "account_period"
         IF cl_chk_act_auth() THEN
            CALL t110_account_period()
         END IF
#No.FUN-680027--end   
      #No.TQC-7B0083  --Begin
      WHEN "contra_tmp_est"
        #IF g_apa.apa51='UNAP' THEN
            CALL t110_ppp('2')
        #END IF                   
      #No.TQC-7B0083  --End  
      WHEN "help"
         CALL cl_show_help()
       #-----No:MOD-4C0113-----
      WHEN "output"
         IF cl_chk_act_auth() THEN
            #-----FUN-640124---------
            #IF cl_null(g_wc) THEN
            #   LET g_wc = ' apa00 = "',g_aptype,'"'
            #ELSE
            #   LET g_wc = g_wc CLIPPED ," AND apa00 = '",g_aptype,"'"
            #END IF
            LET g_wc = 'apa01="',g_apa.apa01,'"'           # "新增"則印單張
            #-----END FUN-640124-----
#            LET g_cmd = "aapr129 '' '' '",g_lang,"' 'Y' '' '' "," '",g_wc,"' '12 ' '   ' '   '" CLIPPED   #MOD-580051 下查詢條件時,不能正常列印
            #LET g_cmd = "aapr129 '' '' '",g_lang,"' 'Y' '' '' "," "",g_wc CLIPPED,"" '12 ' '   ' '   '" CLIPPED   #MOD-580051   #MOD-640140
            #LET g_cmd = "aapr129 '' '' '",g_lang,"' 'Y' '' '' "," \"",g_wc CLIPPED,"\" '12 ' '   ' '   '" CLIPPED      #MOD-640140   #FUN-640124
            #No.TQC-730027 --start--
            IF g_aza.aza26 = '2' THEN
#FUN-970008--begin
#              LET g_cmd = "aapr129 '' '' '",g_lang,"' 'Y' '' '' "," '",g_wc CLIPPED,"' '12 ' '   ' '   '" CLIPPED
#              CALL cl_cmdrun(g_cmd)  #NO.FUN-840132
               CALL t210_out1()        
#FUN-970008--end
            ELSE
            #No.TQC-730027 --end--
               CALL t210_out()          #NO.FUN-840132
            END IF
          #  DISPLAY "g_cmd: ",g_cmd   #NO.FUN-840132
          #  CALL cl_cmdrun(g_cmd)     #NO.FUN-840132
         END IF
       #-----No:MOD-4C0113 END-----
      WHEN "exit"
         EXIT WHILE
      WHEN "controlg"
         CALL cl_cmdask()
      WHEN "gen_entry"
         IF cl_chk_act_auth() THEN
            #CALL t110_v()   #MOD-740030
            CALL t110_v0()   #MOD-740030
         END IF
      WHEN "entry_sheet"
         IF cl_chk_act_auth() THEN
            #-----FUN-830091---------
            ##-----MOD-740030---------
            ##CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02b,1,g_apa.apa41,'0',g_apz.apz02p)    #No.FUN-680029
            #IF NOT cl_null(g_apa.apa99) AND cl_null(g_apa.apa44) THEN  
            #   CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02b,1,'N','0',g_apz.apz02p)    #No.FUN-680029
            #ELSE
            #   CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02b,1,g_apa.apa41,'0',g_apz.apz02p)    #No.FUN-680029
            #END IF
            ##-----END MOD-740030-----
            CALL t110_sheet('0') 
            #-----END FUN-830091-----
            CALL t110_npp02('0')       #No.FUN-680029
         END IF

#No.FUN-680029--begin
      WHEN "entry_sheet2"
         IF cl_chk_act_auth() THEN
            #-----FUN-830091---------
            ##-----MOD-740030---------
            ##CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02c,1,g_apa.apa41,'1',g_apz.apz02p) 
            #IF NOT cl_null(g_apa.apa99) AND cl_null(g_apa.apa44) THEN  
            #   CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02c,1,'N','1',g_apz.apz02p) 
            #ELSE
            #   CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02c,1,g_apa.apa41,'1',g_apz.apz02p) 
            #END IF
            ##-----END MOD-740030-----
            CALL t110_sheet('1') 
            #-----END FUN-830091-----
            CALL t110_npp02('1')
         END IF
#No.FUN-680029--end

      #-----FUN-830091---------
      WHEN "T_T_entry_sheet"
         IF cl_chk_act_auth() THEN
            CALL t110_sheet('0')
            CALL t110_npp02('0')           
         END IF

      WHEN "T_T_entry_sheet2"
         IF cl_chk_act_auth() THEN
            CALL t110_sheet('1')
            CALL t110_npp02('1')           
         END IF
      #-----END FUN-830091-----

      #No.FUN-670060 --start--
      WHEN "carry_voucher" 
         IF cl_chk_act_auth() THEN                 #MOD-A80208
            IF g_apa.apa41 = 'Y' THEN  
               CALL t110_carry_voucher() 
            ELSE 
               CALL cl_err('','atm-402',1)
            END IF 
         END IF                                    #MOD-A80208
        	     
      WHEN "undo_carry_voucher" 
         IF cl_chk_act_auth() THEN                 #MOD-A80208
            IF g_apa.apa41 = 'Y' THEN 
               CALL t110_undo_carry_voucher()
            ELSE 
               CALL cl_err('','atm-403',1)
            END IF
         END IF                                    #MOD-A80208
      #No.FUN-670060 --end--

      WHEN "void"
         IF cl_chk_act_auth() THEN                 #MOD-A80208
            CALL t110_c()
            IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF   #FUN-540041
            CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,"")   #FUN-540041
         END IF                                    #MOD-A80208
      WHEN "on_hold"
         IF cl_chk_act_auth() THEN
            CALL t110_hold()
         END IF
      WHEN "undo_on_hold"
         IF cl_chk_act_auth() THEN
            CALL t110_unhold()
         END IF
      WHEN "mul_invoice"
         CALL t110_ddd('2')   #MOD-950112 add參數
         DISPLAY BY NAME g_apa.apa07      #TQC-630164 
         CALL t110_show_multi_invoice()   #No.TQC-A30076
#MOD-5B0338
     WHEN "invoice_detail"
        CALL t110_inv()
#END MOD-5B0338
      #No.FUN-990017  --Begin
      ##FUN-580012  --begin
      #WHEN "offset_contra"
      #   CALL t110_k2()
      ##FUN-580012  --end
      #No.FUN-990017  --End  
      #FUN-580012  --begin
      WHEN "qry_contra"
         CALL t110_pay_record()
      WHEN "memo"
         IF cl_chk_act_auth() THEN
            CALL t110_m()
         END IF
      WHEN "confirm"
         IF cl_chk_act_auth() THEN
#FUN-580114
            #CALL t110_firm1()
            CALL s_showmsg_init() #CHI-A80031 add
            CALL t110_firm1_chk()          #CALL 原確認的 check 段
            IF g_success = "Y" THEN
               CALL t110_firm1_upd()       #CALL 原確認的 update 段
            END IF
            CALL s_showmsg()  #CHI-A80031 add
#FUN-580114 End
         END IF
      WHEN "undo_confirm"
         IF cl_chk_act_auth() THEN
            SELECT * INTO g_apa.* FROM apa_file WHERE apa01=g_apa.apa01 #MOD-980218   
            IF cl_null(g_apa.apa992) THEN              #No.FUN-690090            
               CALL t110_firm2()
            ELSE                                       #No.FUN-690090   
               CALL cl_err(g_apa.apa992,"aap-066",0)   #No.FUN-690090   
               CONTINUE WHILE                          #No.FUN-690090     
            END IF                                     #No.FUN-690090 
            IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
            CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti)
         END IF

      #FUN-4B0009
      WHEN "exporttoexcel"
          IF cl_chk_act_auth() THEN
             CALL cl_export_to_excel
             (ui.Interface.getRootNode(),base.TypeInfo.create(g_apb),'','')
          END IF
      #--
#FUN-580114
      #@WHEN "准"
      WHEN "agree"
         IF g_laststage = "Y" AND l_flowuser = "N" THEN  #最後一關並且沒有加簽人員
            CALL t110_firm1_upd()      #CALL 原確認的 update 段
         ELSE
            LET g_success = "Y"
            IF NOT aws_efapp_formapproval() THEN
               LET g_success = "N"
            END IF
         END IF
         IF g_success = 'Y' THEN
            IF cl_confirm('aws-081') THEN  #詢問是否繼續下一筆資料的簽核
              IF aws_efapp_getnextforminfo() THEN #取得下一筆簽核單號
                 LET l_flowuser = "N"
                 LET g_argv1_apa01 = aws_efapp_wsk(1)   #取得單號  #FUN-C80078 g_argv1-->g_argv1_apa01
                 IF NOT cl_null(g_argv1_apa01) THEN     #自動 query 帶出資料  #FUN-C80078 g_argv1-->g_argv1_apa01
                   CALL t110_q()
                  #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
                   #CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
                   CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
                        RETURNING g_laststage
                 ELSE
                     EXIT WHILE
                 END IF
               ELSE
                 EXIT WHILE
               END IF
            ELSE
               EXIT WHILE
            END IF
         END IF

      #@WHEN "不准"
      WHEN "deny"
         IF (l_creator := aws_efapp_backflow()) IS NOT NULL THEN
            IF aws_efapp_formapproval() THEN
               IF l_creator = "Y" THEN
                  LET g_apa.apa63 = 'R'
                  DISPLAY BY NAME g_apa.apa63
               END IF
               IF cl_confirm('aws-081') THEN     #詢問是否繼續下一筆資料的簽核
                  IF aws_efapp_getnextforminfo() THEN #取得下一筆簽核單號
                    LET l_flowuser = "N"
                    LET g_argv1_apa01 = aws_efapp_wsk(1)    #取得單號  #FUN-C80078 g_argv1-->g_argv1_apa01
                    IF NOT cl_null(g_argv1_apa01) THEN      #自動 query 帶出資料  #FUN-C80078 g_argv1-->g_argv1_apa01
                       CALL t110_q()
                     #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
                       #CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
                       CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
                           RETURNING g_laststage
                    ELSE
                          EXIT WHILE
                    END IF
                  ELSE
                     EXIT WHILE
                  END IF
               ELSE
                  EXIT WHILE
               END IF
            END IF
         END IF

      #@WHEN "加簽"
      WHEN "modify_flow"
           IF aws_efapp_flowuser() THEN   #選擇欲加簽人員
              LET l_flowuser = 'Y'
           ELSE
              LET l_flowuser = 'N'
           END IF

      #@WHEN "撤簽"
      WHEN "withdraw"
           IF cl_confirm("aws-080") THEN
              IF aws_efapp_formapproval() THEN
                 EXIT WHILE
              END IF
           END IF

      #@WHEN "抽單"
      WHEN "org_withdraw"
           IF cl_confirm("aws-079") THEN
              IF aws_efapp_formapproval() THEN
                 EXIT WHILE
                 END IF
           END IF

      #@WHEN "簽核意見"
      WHEN "phrase"
           CALL aws_efapp_phrase()
#FUN-580114 End

    #@WHN "簽核狀況"
     WHEN "approval_status"               # MOD-4C0041
         IF cl_chk_act_auth() THEN        #DISPLAY ONLY
            IF aws_condition2() THEN                #FUN-550042
                 CALL aws_efstat2()                  #MOD-560007
            END IF
         END IF

      WHEN "easyflow_approval"     #FUN-550042
         IF cl_chk_act_auth() THEN
              CALL t110_ef()
         END IF

#No.FUN-A30106 --begin
       WHEN "drill_down"
          IF cl_chk_act_auth() THEN
             CALL t110_drill_down()
          END IF
#No.FUN-A30106 --end

      #No:FUN-6A0016-------add--------str----
      WHEN "related_document"  #相關文件
           IF cl_chk_act_auth() THEN
              IF g_apa.apa01 IS NOT NULL THEN
              LET g_doc.column1 = "apa01"
              LET g_doc.value1 = g_apa.apa01
              CALL cl_doc()
            END IF
      END IF
      #No:FUN-6A0016-------add--------end----
      END CASE
   END WHILE
END FUNCTION

FUNCTION t230_menu()
    MENU ""

        BEFORE MENU
            CALL cl_navigator_setting( g_curs_index, g_row_count )
            #No.FUN-690080 --Begin
            IF g_aptype <> '25' THEN
               CALL cl_set_act_visible("revert_query",FALSE)
            END IF
            #No.FUN-690080 --End

         ON ACTION query
            LET g_action_choice="query"
            IF cl_chk_act_auth() THEN
               CALL t110_q()
            END IF
         ON ACTION first
            CALL t110_fetch('F')         #MOD-B50228 mod P -> F
         ON ACTION jump
            CALL t110_fetch('/')
         ON ACTION previous
            CALL t110_fetch('P')
         ON ACTION next
            CALL t110_fetch('N')
         ON ACTION last
            CALL t110_fetch('L')
         ON ACTION help
            CALL cl_show_help()
         ON ACTION exit
            LET g_action_choice = "exit"
            EXIT MENU
         ON ACTION controlg
            CALL cl_cmdask()
         ON ACTION qry_contra
            CALL t110_pay_record()
         #No.FUN-690080 --Begin
         ON ACTION revert_query
            CALL t110_pay_record_1()
         #No.FUN-690080 --End
#No.FUN-680027--begin
         ON ACTION account_period
               CALL t110_account_period()
#No.FUN-680027--end   
         ON ACTION locale
            CALL cl_dynamic_locale()
            CALL cl_show_fld_cont()   #FUN-550037(smin)
           # IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
            LET g_chr2= 'N'
            CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti)
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
 
         ON ACTION about         #MOD-4C0121
            CALL cl_about()      #MOD-4C0121
#No.FUN-A30106 --begin 
         ON ACTION drill_down
            CALL t110_drill_down()
#No.FUN-A30106 --end
         #No:FUN-6A0016-------add--------str----
         ON ACTION related_document       #相關文件
            LET g_action_choice="related_document"
              IF cl_chk_act_auth() THEN
                 IF g_apa.apa01 IS NOT NULL THEN
                 LET g_doc.column1 = "apa01"
                 LET g_doc.value1 = g_apa.apa01
                 CALL cl_doc()
               END IF
            END IF
         #No:FUN-6A0016-------add--------end----
            LET g_action_choice = "exit"
            CONTINUE MENU

         -- for Windows close event trapped
         COMMAND KEY(INTERRUPT)
             LET INT_FLAG=FALSE 		#MOD-570244	mars
             LET g_action_choice = "exit"
             EXIT MENU

   END MENU
END FUNCTION

FUNCTION t110_npp02(p_npptype)                       #No.FUN-680029
DEFINE   p_npptype       LIKE npp_file.npptype       #No.FUN-680029
   UPDATE npp_file SET npp02=g_apa.apa02
    WHERE npp01=g_apa.apa01
      AND npp011=1
      AND nppsys = 'AP'
      AND npptype=p_npptype                          #No.FUN-680029
   IF STATUS THEN
#     CALL cl_err('upd npp02:',STATUS,1)   #No.FUN-660122
      CALL cl_err3("upd","npp_file",g_apa.apa01,"",STATUS,"","upd npp02:",1)  #No.FUN-660122
   END IF

END FUNCTION

FUNCTION t110_a()
   DEFINE g_t1     LIKE oay_file.oayslip                  #No.FUN-550030  #No.FUN-690028 VARCHAR(05)
   DEFINE li_result   LIKE type_file.num5    #No.FUN-690028 SMALLINT
   IF s_aapshut(0) THEN
      RETURN
   END IF
 
   MESSAGE ""
   CLEAR FORM
   CALL g_apb.clear()
   CALL t110_misc_clear()
   INITIALIZE g_apa.* LIKE apa_file.*             #DEFAULT 設定
   LET g_apa_t.*=g_apa.*
   LET g_apa01_t = NULL
   #預設值及將數值類變數清成零
   LET g_apa.apa00=g_aptype
  #start FUN-680110 add
   IF g_apa.apa00='16' OR g_apa.apa00='26' THEN
      LET g_apa.apa08='UNAP'
   END IF
  #end FUN-680110 add
   IF g_apa.apa02 IS NULL THEN
      LET g_apa.apa02=g_today
   ELSE
      LET g_apa.apa02=g_apa_t.apa02
   END IF
   LET g_apa.apa14=1
   LET g_apa.apa16=0
   LET g_apa.apa17='1'
   LET g_apa.apa13=g_aza.aza17        #TQC-A40102 Add

   CASE
      WHEN g_aptype = '11'
         LET g_apa.apa171='21'
      WHEN g_aptype = '12'
         LET g_apa.apa171='21'
      WHEN g_aptype = '13'
         LET g_apa.apa171='22'
      WHEN g_aptype = '21'
         LET g_apa.apa171='23'
   END CASE

   LET g_apa.apa172='1'
   LET g_apa.apa20=0

   IF cl_null(g_apa_t.apa21) THEN
      LET g_apa.apa21=g_user
   ELSE
      LET g_apa.apa21=g_apa_t.apa21
   END IF

   IF cl_null(g_apa_t.apa22) THEN
      SELECT gen03 INTO g_apa.apa22 FROM gen_file
       WHERE gen01=g_apa.apa21
   ELSE
      LET g_apa.apa22=g_apa_t.apa22
   END IF

#  IF g_aza.aza22='Y' AND cl_null(g_apa.apa21) THEN
   IF cl_null(g_apa.apa21) THEN
      LET g_apa.apa21=g_user
   END IF

   LET g_apa.apa31f= 0
   LET g_apa.apa31 = 0
   LET g_apa.apa32f= 0
   LET g_apa.apa32 = 0
   LET g_apa.apa65f= 0
   LET g_apa.apa65 = 0
   LET g_apa.apa34f= 0
   LET g_apa.apa34 = 0
   LET g_apa.apa35f= 0
   LET g_apa.apa35 = 0
   LET g_apa.apa33f= 0
   LET g_apa.apa37f= 0   #No.FUN-690080
   LET g_apa.apa37 = 0   #No.FUN-690080
   LET g_apa.apa33 = 0
   LET g_apa.apa36 = g_apa_t.apa36
   LET g_apa.apa60f= 0
   LET g_apa.apa60 = 0
   LET g_apa.apa61f= 0
   LET g_apa.apa61 = 0
   LET g_apa.apa41 = 'N'
   LET g_apa.apa42 = 'N'
  #LET g_apa.apa43 = g_apa.apa02   #MOD-910249 mark
   LET g_apa.apa55 = '1'
   LET g_apa.apa56 = '0'
   LET g_apa.apa57f= 0
   LET g_apa.apa57 = 0
   LET g_apa.apa74 =  'N'
   LET g_apa.apa75 =  'N'
 ### MOD-4A0253
     LET g_apa.apa63 = '0'
 ### END MOD-4A0253

   IF g_aptype='21' THEN
      LET g_apa.apa58='3'
   END IF

   IF g_aptype='22' THEN
      LET g_apa.apa58='3'
   END IF

   INITIALIZE g_apa_o.* TO NULL
   LET g_apa.apaprno=0
   LET g_apa.apainpd=g_today
   LET g_apa.apauser=g_user
   LET g_apa.apagrup=g_grup
   LET g_apa.apadate=g_today
   LET g_apa.apaacti='Y'              #資料有效
   LET g_apa.apa100= g_plant   #No.FUN-630043
   LET g_apa.apa930=s_costcenter(g_apa.apa22)  #FUN-670064
   CALL cl_opmsg('a')

   WHILE TRUE
      CALL t110_i("a")                #輸入單頭
      IF INT_FLAG THEN                   #使用者不玩了
         LET INT_FLAG = 0
         INITIALIZE g_apa.* TO NULL
         CALL cl_err('',9001,0)
         EXIT WHILE
      END IF

      IF g_apa.apa01 IS NULL THEN                # KEY 不可空白
         CONTINUE WHILE
      END IF

      BEGIN WORK
#No.FUN-550030--begin
       CALL s_auto_assign_no("aap",g_apa.apa01,g_apa.apa02,g_apa.apa00,"apa_file","apa01","","","")
       RETURNING li_result,g_apa.apa01
      IF (NOT li_result) THEN
         CONTINUE WHILE
      END IF
      DISPLAY BY NAME g_apa.apa01
#     IF g_apy.apyauno='Y' THEN
#        CALL s_apyauno(g_apa.apa01,g_apa.apa02,g_apa.apa00)
#          RETURNING g_i,g_apa.apa01
#        IF g_i THEN
#           CONTINUE WHILE
#        END IF
#        DISPLAY BY NAME g_apa.apa01
#     END IF
#No.FUN-550030--end
      IF g_apa.apa08 IS NULL THEN
         LET g_apa.apa08 = g_apa.apa01
         DISPLAY BY NAME g_apa.apa08
      END IF

      LET g_apa.apa72 = g_apa.apa14
      #No.MOD-590312  --begin
      CALL t110_comp_oox(g_apa.apa01) RETURNING g_net
      LET g_apa.apa73 = g_apa.apa34 - g_apa.apa35 + g_net
      #No.MOD-590312  --end

   ### MOD-4A0253 ###
      MESSAGE ''
      IF cl_null(g_apa.apamksg) THEN
          LET  g_apa.apamksg = 'N'
      END IF
   ### END MOD-4A0253 ###

      #FUN-570042
      IF g_apa.apa00[1,1]='2' THEN
         IF cl_null(g_apa.apa12) THEN    #MOD-BA0173 ADD
            LET g_apa.apa12=g_apa.apa02
         END IF                          #MOD-BA0173 ADD
      END IF
      #--
      
      #No.TQC-A30072  --Begin
      ##FUN-990014--Begin
      #CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1
      #SELECT apyvcode INTO g_apa.apa77  FROM apy_file WHERE apyslip = g_t1   
      #  IF cl_null(g_apa.apa77) THEN 
      #     LET g_apa.apa77 = g_apz.apz63 
      #  END IF     
      ##FUN-990014---End
      #No.TQC-A30072  --End  
      INSERT INTO apa_file VALUES (g_apa.*)
      IF SQLCA.sqlcode THEN        #置入資料庫不成功
         ROLLBACK WORK
#        CALL cl_err(g_apa.apa01,SQLCA.sqlcode,1)   #No.FUN-660122
         CALL cl_err3("ins","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","",1)  #No.FUN-660122
         CONTINUE WHILE
      ELSE
         COMMIT WORK
         CALL cl_flow_notify(g_apa.apa01,'I')
      END IF

      LET g_apa_t.* = g_apa.*
      SELECT ROWID INTO g_apa_rowid FROM apa_file
       WHERE apa01 = g_apa.apa01

      SELECT * INTO g_apa.* FROM apa_file WHERE apa01 = g_apa.apa01

      IF g_apa.apa08 ='UNAP' AND g_apa.apa00 MATCHES '1[1-2]' THEN
         DELETE FROM apk_file WHERE apk01=g_apa.apa01
      END IF

      #使用稅控系統且多發票時, 需先輸入單身資料
      IF g_apa.apa08 = 'MISC' THEN
         IF g_aza.aza26 != '2' AND g_apa.apa00[1,1] !='2'  THEN
            CALL t110_ddd('2')   #MOD-950112 add參數
            DISPLAY BY NAME g_apa.apa07      #TQC-630164 
            CALL t110_show_multi_invoice()   #No.TQC-A30076
         END IF
      ELSE
         IF g_apa.apa08 != g_apa.apa01 AND NOT cl_null(g_apa.apa08) AND
            #g_apa.apa08 !='UNAP' THEN   #MOD-670016
            g_apa.apa08 != 'MISC' AND                        #MOD-990188 add
            g_apa.apa08 !='UNAP' AND g_apa.apa00 != '21' THEN   #MOD-670016
            CALL t110_ddd1('a')
         END IF
      END IF

      IF g_apa.apa51='MISC' OR g_apa.apa511 ='MISC' THEN         #No.FUN-680029
         CALL t110_ccc('1')
      END IF

      IF g_apa.apa51 = 'UNAP' THEN
         CALL t110_ppp('2')
      END IF

      CALL t110_ins_apc(g_apa.*)   #MOD-7A0049
      IF g_apb_sarrno > 0 THEN
         CALL g_apb.clear()
         LET g_rec_b = 0                    #No.FUN-680064
        #str CHI-960074 add
         IF g_aptype="16" THEN
            CALL cl_err('','aap-166',1)
         END IF
        #end CHI-960074 add
         CALL t110_b('a')              #輸入單身
      END IF

      LET g_apa01_t = g_apa.apa01     #保留舊值
  
      #-----MOD-670016--------- 
      #IF g_apa.apa08 != 'MISC' AND g_apa.apa08 != g_apa.apa01 AND
      #   NOT cl_null(g_apa.apa08) AND g_apa.apa08 !='UNAP' THEN
      #   CALL t110_ddd1('b')
      #END IF
      #-----END MOD-670016-----

#No.FUN-680027--begin
      DELETE FROM apc_file WHERE apc01=g_apa.apa01   #MOD-810104 
      CALL t110_ins_apc(g_apa.*)   #MOD-810104 取消MOD-7A0049的mark
#No.FUN-680027--end

      CASE
         WHEN g_apa.apa00 = '11' AND g_apz.apz31 = 'N'
            EXIT WHILE
         WHEN (g_apa.apa00 = '12' OR g_apa.apa00 = '13') AND g_apz.apz32 = 'N'   #No.FUN-690080
            EXIT WHILE
      END CASE
#No.FUN-550030--begin
      CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1
#No.FUN-550030--end

      IF NOT cl_null(g_apa_rowid) AND g_apy.apyprint='Y' THEN  #是否馬上列印
         IF cl_confirm('mfg3242') THEN
            CALL t110_out('a')
         END IF
      END IF

       #MOD-490323
      IF (g_apa.apa00 = '12' OR g_apa.apa00 = '13') AND g_apz.apz32 = 'Y' AND l_apz59='N' THEN  #No.FUN-690080 #TQC-A40106 change g_apz.apz59->l_apz59
         CALL t110_gen_gl()
      END IF
      #--

       #MOD-490490
      IF (g_aptype = '12' OR g_aptype = '13') AND l_apz59='N' THEN  #No.FUN-690080 #TQC-A40106 change g_apz.apz59->l_apz59
         CALL t110_misc_display() RETURN
      END IF
      #--
      display "apyapr:",g_apy.apyapr
      IF NOT cl_null(g_apa_rowid) AND g_apy.apydmy1='Y'  #確認
      AND g_apy.apyapr <> 'Y'                                      #FUN-640240
      THEN
          LET g_action_choice = "insert"      #FUN-640240
#FUN-580114
         #CALL t110_firm1()
          CALL s_showmsg_init() #CHI-A80031 add
          CALL t110_firm1_chk()          #CALL 原確認的 check 段
          IF g_success = "Y" THEN
             CALL t110_firm1_upd()       #CALL 原確認的 update 段
          END IF
          CALL s_showmsg()  #CHI-A80031 add
#FUN-580114 End
      END IF

      EXIT WHILE
   END WHILE
   #-----FUN-830091---------
   CALL cl_set_act_visible("entry_sheet,entry_sheet2,
                            T_T_entry_sheet,T_T_entry_sheet2",TRUE)
   IF cl_null(g_apa.apa99) THEN
      CALL cl_set_act_visible("T_T_entry_sheet,T_T_entry_sheet2",FALSE)
      IF g_aza.aza63 = 'N' THEN
         CALL cl_set_act_visible("entry_sheet2",FALSE)
      END IF
   ELSE
      CALL cl_set_act_visible("entry_sheet,entry_sheet2",FALSE)
      IF g_aza.aza63 = 'N' THEN
         CALL cl_set_act_visible("T_T_entry_sheet2",FALSE)
      END IF
   END IF
   #-----END FUN-830091-----

END FUNCTION

FUNCTION t110_ddd1(p_cmd)
 DEFINE l_azi04 LIKE azi_file.azi04
 DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
 DEFINE g_apk   RECORD LIKE apk_file.*
 DEFINE g_t1    LIKE oay_file.oayslip  #FUN-990014 add

   INITIALIZE g_apk.* TO NULL
   IF p_cmd!='a' THEN
      DELETE FROM apk_file WHERE apk01=g_apa.apa01
   END IF

   LET g_apk.apk01=g_apa.apa01
   LET g_apk.apk02=1
   LET g_apk.apk28=g_apa.apa46   #FUN-650068
   LET g_apk.apk03=g_apa.apa08
   LET g_apk.apk04=g_apa.apa18
   LET g_apk.apk05=g_apa.apa09
   LET g_apk.apk06=g_apa.apa31+g_apa.apa32
   LET g_apk.apk07=g_apa.apa32
   LET g_apk.apk08=g_apa.apa31
   LET g_apk.apk06 = cl_digcut(g_apk.apk06,g_azi04)
   LET g_apk.apk07 = cl_digcut(g_apk.apk07,g_azi04)
   LET g_apk.apk08 = cl_digcut(g_apk.apk08,g_azi04)
   LET g_apk.apk11  = g_apa.apa15
   LET g_apk.apk29  = g_apa.apa16
   LET g_apk.apk12  = g_apa.apa13
   LET g_apk.apk13  = g_apa.apa14
   LET g_apk.apk06f = g_apa.apa31f+g_apa.apa32f
   LET g_apk.apk07f = g_apa.apa32f
   LET g_apk.apk08f = g_apa.apa31f
   SELECT azi04 INTO l_azi04 FROM azi_file WHERE azi01 = g_apk.apk12
   LET g_apk.apk06f = cl_digcut(g_apk.apk06f,l_azi04)
   LET g_apk.apk07f = cl_digcut(g_apk.apk07f,l_azi04)
   LET g_apk.apk08f = cl_digcut(g_apk.apk08f,l_azi04)
   LET g_apk.apk17=g_apa.apa17
   LET g_apk.apk171=g_apa.apa171
   LET g_apk.apk172=g_apa.apa172
   LET g_apk.apkacti='Y'
   LET g_apk.apkgrup=g_grup
   LET g_apk.apkuser=g_user
   LET g_apk.apkdate=g_today
  #FUN-990014--Begin
   #FUN-970108---Begin
   IF NOT cl_null(g_apa.apa77) THEN 
      LET g_apk.apk32 = g_apa.apa77
   ELSE
      CALL s_get_doc_no(g_apk.apk01) RETURNING g_t1
      SELECT apyvcode INTO g_apk.apk32  FROM apy_file WHERE apyslip = g_t1   
       IF cl_null(g_apk.apk32) THEN 
          LET g_apk.apk32 = g_apz.apz63  
       END IF
   END IF
   #FUN-970108---End
   #FUN-990014 end--------
   #大陸版且不使用稅控系統

   IF g_aza.aza26 = '2' THEN
      SELECT gec05 INTO g_apk.apk172 FROM gec_file WHERE gec01 = g_apa.apa15  AND gec011='1'    #No:8511 加上gec011
      LET g_apk.apk29 = g_apa.apa16
      LET g_apk.apk30 = 0
   END IF
   
   IF NOT cl_null(g_apa.apa08) THEN   #MOD-7B0033 
      INSERT INTO apk_file VALUES (g_apk.*)
   END IF   #MOD-7B0033

END FUNCTION

FUNCTION t110_ins_prepaid()
 DEFINE l_apa  RECORD LIKE apa_file.*,
        l_dmy  LIKE apb_file.apb03,      # No:FUN-690028 VARCHAR(5) ,         #No.FUN-550030
        l_msg  LIKE type_file.chr1000    # No:FUN-690028 VARCHAR(60)
 DEFINE g_t1   LIKE oay_file.oayslip     #FUN-990014 add
 
   LET l_apa.*  = m_apa.*
   #LET l_dmy    = m_apa.apa01   #TQC-630173
   LET l_dmy    = s_get_doc_no(m_apa.apa01)   #TQC-630173
   SELECT * INTO g_apy.* FROM apy_file
    WHERE apyslip = l_dmy
#MOD-590460
   IF cl_null(g_apy.apydmy4) THEN
      CALL cl_err('','aap-068',1)
      LET g_success='N'
      RETURN
   END IF
#END MOD-590460
   #No.FUN-690080 --Begin
   IF g_aptype = '17' THEN
      LET l_apa.apa00 = '25'
   ELSE
      LET l_apa.apa00 = '23'
   END IF
   #No.FUN-690080 --End
   #--->依據相對應單別
#No.FUN-550030--begin
#  LET l_apa.apa01[1,3] = g_apy.apydmy4
   LET l_apa.apa01[1,g_doc_len] = g_apy.apydmy4
#No.FUN-550030--end
   LET l_apa.apa08 = m_apa.apa01
   LET l_apa.apa09 = m_apa.apa02
#  LET l_apa.apa11 = ''              #No.MOD-780123
  #LET l_apa.apa12 = NULL            #No.TQC-7A0095 mark
   LET l_apa.apa12 = m_apa.apa12     #No.TQC-7A0095
   LET l_apa.apa19 = NULL            #MOD-A70158 add
   LET l_apa.apa20 = 0               #MOD-A70158 add
   LET l_apa.apa24 = 0
  #LET l_apa.apa64 = NULL            #No.TQC-7A0095 mark
   LET l_apa.apa64 = m_apa.apa64     #No.TQC-7A0095
   LET l_apa.apa15 = m_apa.apa15
   LET l_apa.apa16 = 0            
   LET l_apa.apa32f= 0            
   LET l_apa.apa33f= 0
   LET l_apa.apa65f= 0
   LET l_apa.apa35f= 0
   LET l_apa.apa32 = 0  
   LET l_apa.apa33 = 0
   LET l_apa.apa65 = 0
   LET l_apa.apa35 = 0
   LET l_apa.apa31f= l_apa.apa31f                 #MOD-B60066 mark  #MOD-B60221 remark
  #LET l_apa.apa31f= m_apa.apa31f - m_apa.apa65f  #MOD-B60066       #MOD-B60221 mark
   LET l_apa.apa34f= l_apa.apa31f                 #MOD-B60066 mark  #MOD-B60221 remark   #(不包含稅額)
  #LET l_apa.apa34f= m_apa.apa31f - m_apa.apa65f  #MOD-B60066       #MOD-B60221 mark
   LET l_apa.apa31 = l_apa.apa31                  #MOD-B60066 mark  #MOD-B60221 remark
  #LET l_apa.apa31 = m_apa.apa31  - m_apa.apa65   #MOD-B60066       #MOD-B60221 mark
   LET l_apa.apa34 = l_apa.apa31                  #MOD-B60066 mark  #MOD-B60221 remark   #(不包含稅額)
  #LET l_apa.apa34 = m_apa.apa31  - m_apa.apa65   #MOD-B60066       #MOD-B60221 mark
   LET l_apa.apa41 = 'Y'                   # 視同已確認
   LET l_apa.apa42 = 'N'
  #LET l_apa.apa54 = l_apa.apa51                     #MOD-840203 mark
  #LET l_apa.apa541= l_apa.apa511     #No.FUN-680029 #MOD-840203 mark
#No.MOD-8B0231 --begin
   LET l_apa.apa54 = l_apa.apa51                     #MOD-840203 mark
   LET l_apa.apa541= l_apa.apa511     #No.FUN-680029 #MOD-840203 mark
#No.MOD-8B0231 --end
   LET l_apa.apa55 = '1'
   LET l_apa.apa60f= 0
   LET l_apa.apa60 = 0
   LET l_apa.apa61f= 0
   LET l_apa.apa61 = 0
   LET l_apa.apa67 = m_apa.apa67
   LET l_apa.apa68 = m_apa.apa68
   LET l_apa.apa69 = m_apa.apa69
   LET l_apa.apa70 = m_apa.apa70
 # LET l_apa.apa71 = m_apa.apa71  #No.FUN-830161
   LET l_apa.apa66 = m_apa.apa66
   LET l_apa.apa74 = 'N'
   LET l_apa.apa75 = 'N'
   LET l_apa.apainpd = g_today
   LET l_apa.apaprno = 0
   LET l_apa.apa72=l_apa.apa14
   LET l_apa.apa73=l_apa.apa34-l_apa.apa35
   LET l_apa.apa930=m_apa.apa930 #FUN-670064
   #FUN-990014--Begin
   CALL s_get_doc_no(l_apa.apa01) RETURNING g_t1
   SELECT apyvcode INTO l_apa.apa77  FROM apy_file WHERE apyslip = g_t1   
     IF cl_null(l_apa.apa77) THEN 
        LET l_apa.apa77 = g_apz.apz63  #FUN-970108 add
     END IF     
   #FUN-990014---End
   INSERT INTO apa_file VALUES(l_apa.*)
   IF SQLCA.sqlcode THEN
#     CALL cl_err('ins apa(type 23):',SQLCA.sqlcode,1)   #No.FUN-660122
      CALL cl_err3("ins","apa_file",l_apa.apa01,"",SQLCA.sqlcode,"","ins apa(type 23):",1)  #No.FUN-660122
      LET g_success = 'N'
   ELSE
      CALL cl_getmsg('aap-083',g_lang) RETURNING l_msg
            LET INT_FLAG = 0  ######add for prompt bug
       #MOD-4A0172
     #FUN-640240
      LET l_msg=l_msg CLIPPED,l_apa.apa01,"!"
#      #CALL cl_err(l_msg,'!',1)   #No.FUN-660122
#      #CALL cl_err(l_msg,'!',1)   
      CALL cl_msgany(1,1,l_msg)
     #END FUN-640240
      #--
#No.FUN-680027--begin
     CALL t110_ins_apc(l_apa.*)
#No.FUN-680027--end
   END IF

END FUNCTION

FUNCTION t110_u()
 DEFINE l_apa35  LIKE apa_file.apa35,
        l_apa41  LIKE apa_file.apa41,
        l_apb02  LIKE apb_file.apb02,
        l_apb08  LIKE apb_file.apb08,
        l_apb081 LIKE apb_file.apb081,
        l_apb09  LIKE apb_file.apb09,
        l_apb23  LIKE apb_file.apb23,
        l_apb24  LIKE apb_file.apb24,    #MOD-860221 add
        l_apb10  LIKE apb_file.apb10,
        l_apb101 LIKE apb_file.apb101,
        l_n      LIKE type_file.num5,    #No.FUN-690028 SMALLINT
        g_apk    RECORD LIKE apk_file.*
#MOD-940239 --begin--        
 DEFINE l_apa13         LIKE apa_file.apa13
 DEFINE l_apa14         LIKE apa_file.apa14
 DEFINE l_apa72         LIKE apa_file.apa72    
 DEFINE l_api05         LIKE api_file.api05   
 DEFINE l_api05f        LIKE api_file.api05f   
 DEFINE l_apb21         LIKE apb_file.apb21    
 DEFINE l_sum           LIKE type_file.num20_6  
#MOD-940239  --end--
 DEFINE l_pmc913        LIKE pmc_file.pmc913  #No:MOD-960026

    IF s_aapshut(0) THEN
       RETURN
    END IF

    IF g_apa.apa01 IS NULL THEN
       CALL cl_err('apa01 null',-400,0)
       RETURN
    END IF

#FUN-540041
#   IF g_apa.apa63 <> '0' THEN                 #FUN-550042
#      CALL cl_err('','aap-059',1)
#      RETURN
#   END IF
#END FUN-540041

#No:FUN-8A0075--END-- 
#    IF g_apa.apa63 matches '[Ss]' THEN          #FUN-550042
#       CALL cl_err('','apm-030',0)
#       RETURN
#    END IF
#No:FUN-8A0075--END--

   #str MOD-880080 mark
   #若為直接付款,應可修改非金額欄位
   ##No.TQC-7B0100 --begin
   #SELECT COUNT(*) INTO l_n FROM aph_file WHERE aph01 =g_apa.apa01
   #IF l_n >0 THEN
   #   CALL cl_err('','aap-767',0)
   #   RETURN
   #END IF
   ##No.TQC-7B0100 --end
   #end MOD-880080 mark

    SELECT * INTO g_apa.* FROM apa_file
     WHERE apa01=g_apa.apa01

    IF g_apa.apaacti ='N' THEN
       CALL cl_err('acti=N',9027,0)
       RETURN
    END IF

    IF g_apa.apa41 = 'Y' THEN
       CALL cl_err("apa41=Y",'aap-086',0)
       RETURN
    END IF

    IF g_apa.apa42 = 'Y' THEN
       CALL cl_err("apa42=Y",'aap-165',0)
       RETURN
    END IF

    IF g_apa.apa74 = 'Y' THEN
       CALL cl_err('apa74=Y','aap-334',0)
       RETURN
    END IF

    IF NOT cl_null(g_apa.apa44) THEN   #No:MOD-670056
       IF NOT s_chkpost(g_apa.apa44,g_apa.apa01) THEN
          RETURN
       END IF
    END IF

    IF g_apa.apa00='21' THEN
       IF NOT cl_null(g_apa.apa08) THEN
          SELECT COUNT(*) INTO l_n FROM apb_file
           WHERE apb01=g_apa.apa08 AND apb16='Y'
          IF l_n > 0 THEN
             CALL cl_err('','aap-289',0)
             RETURN
          END IF
       END IF
    END IF

    #--FUN-D30066 add start--
    IF g_apa.apa63 MATCHES '[Ss1]' THEN 
       CALL cl_err(g_apa.apa63,'apm-030',0)
       RETURN
    END IF
    #--FUN-D30066 add end--

    MESSAGE ""
    CALL cl_opmsg('u')
    LET g_apa01_t = g_apa.apa01
    LET g_apa_t.* = g_apa.*       #BACKUP  #MOD-B40036 mod g_apa_o -> g_apa_t 
    LET g_success = 'Y'
    BEGIN WORK

    CALL t110_lock_cl()  #FUN-C80078 add
    OPEN t110_cl USING g_apa_rowid
    IF STATUS THEN
       CALL cl_err("OPEN t110_cl u:", STATUS, 1)
       CLOSE t110_cl
       ROLLBACK WORK
       RETURN
    END IF

    FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
    IF SQLCA.sqlcode THEN
        CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
        CLOSE t110_cl
        ROLLBACK WORK
        RETURN
    END IF

    CALL t110_show()

    WHILE TRUE
       LET g_apa01_t = g_apa.apa01
       LET g_apa.apamodu=g_user
       LET g_apa.apadate=g_today
       CALL t110_i("u")                      #欄位更改
       IF INT_FLAG THEN
          LET INT_FLAG = 0
          IF g_apa.apa14 <> g_apa_t.apa14 THEN
             SELECT COUNT(*) INTO g_cnt FROM apb_file
              WHERE apb01=g_apa.apa01

             IF g_cnt > 0 THEN
                DECLARE upd_apb_cs2 CURSOR FOR
                 SELECT apb23,apb09,apb02,apb24   #MOD-860221 add apb24
                   FROM apb_file WHERE apb01=g_apa.apa01

                FOREACH upd_apb_cs2 INTO l_apb23,l_apb09,l_apb02,l_apb24   #MOD-860221 add l_apb24
                   LET l_apb08 = l_apb23 * g_apa_t.apa14 #MOD-990174
                  #LET l_apb08 = cl_digcut(l_apb08,t_azi.azi03)   #MOD-6B0066
                   LET l_apb08 = cl_digcut(l_apb08,g_azi03)   #MOD-6B0066
                   LET l_apb081= l_apb08
                  #LET l_apb10 = l_apb09 * l_apb08       #MOD-860221 mark
                   LET l_apb10 = l_apb24 * g_apa_t.apa14   #MOD-860221 #MOD-990174
                  #LET l_apb10 = cl_digcut(l_apb10,t_azi.azi04)   #MOD-6B0066
                   LET l_apb10 = cl_digcut(l_apb10,g_azi04)   #MOD-6B0066
                   LET l_apb101= l_apb10
 
                   UPDATE apb_file SET apb08  = l_apb08,
                                       apb081 = l_apb081,
                                       apb10  = l_apb10,
                                       apb101 = l_apb101
                    WHERE apb01=g_apa.apa01 AND apb02=l_apb02
                   IF STATUS OR SQLCA.SQLCODE THEN
#                     CALL cl_err('upd apb:',SQLCA.SQLCODE,0)   #No.FUN-660122
                      CALL cl_err3("upd","apb_file",g_apa_t.apa01,l_apb02,SQLCA.sqlcode,"","upd apb:",1)  #No.FUN-660122
                      LET g_success='N'
                      EXIT FOREACH
                   END IF

                END FOREACH

                IF g_success='N' THEN
                   ROLLBACK WORK
                   LET g_apa.* = g_apa_t.*       #MOD-B40036
                   RETURN
                END IF
         
                CALL t110_b_fill(' 1=1')
          
             END IF
          END IF
          LET g_apa.*=g_apa_t.*
          CALL t110_show()
          CALL cl_err('','9001',0)
          EXIT WHILE
#MOD-940239 --begin--
       ELSE
         #-MOD-C20206-mark-
         ##單頭匯率調整後,應重算沖暫估的DIFF金額
         #DECLARE upd_apb_t120 CURSOR FOR
         #   SELECT apb24,apb21 FROM apb_file WHERE apb01=g_apa.apa01
         #LET l_sum = 0            
         #LET l_api05f = 0         
         #FOREACH upd_apb_t120 INTO l_apb24,l_apb21   
         #   SELECT apa13,apa14,apa72 INTO l_apa13,l_apa14,l_apa72
         #     FROM apa_file
         #    WHERE apa01 = l_apb21 AND apa41 = 'Y' AND apa42 = 'N'
         #   IF g_apz.apz27 = 'Y' AND g_aza.aza17 != l_apa13 THEN 
         #      LET l_api05 = l_apb24 * l_apa72                    
         #   ELSE
         #  	LET l_api05 = l_apb24 * l_apa14
         #   END IF    
         #   LET l_api05 = cl_digcut(l_api05,g_azi04)
         #                                      
         #   LET l_sum = l_sum + l_api05    
         #   SELECT azi04 INTO t_azi04 FROM azi_file WHERE azi01 = l_apa13 
         #   LET l_api05f = l_api05f + l_apb24
         #   LET l_api05f = cl_digcut(l_api05f,t_azi04)                                 
         #END FOREACH
         ##No.CHI-A10006 mod --start--
         ##LET l_api05 = g_apa.apa31 - l_sum
         #IF g_apa.apa34f - g_apa.apa35f = l_api05f THEN
         #   LET l_api05 = g_apa.apa34 - g_apa.apa35
         #ELSE
         #   LET l_api05 = g_apa.apa31 - l_sum
         #END IF
         ##No.CHI-A10006 mod --end--
         #LET l_api05f= g_apa.apa31f- l_api05f
         #
         #UPDATE api_file SET api05 = l_api05,
         #                    api05f= l_api05f   
         # WHERE api01 = g_apa.apa01
         #   AND api02 = '2'
         #   AND api26 = 'DIFF'
         #IF STATUS THEN 
         #   CALL cl_err3("upd","api_file","","",STATUS,"","api",1)                     
         #   ROLLBACK WORK
         #   LET g_apa.* = g_apa_t.*       #MOD-B40036
         #   RETURN 
         #END IF                
         #-MOD-C20206-end- 
#MOD-940239  --END--          
       END IF

       IF g_apa.apa01 != g_apa01_t THEN            # 更改單號
          UPDATE apb_file SET apb01 = g_apa.apa01 WHERE apb01 = g_apa01_t
          IF STATUS THEN
#            CALL cl_err('apb',STATUS,0)   #No.FUN-660122
             CALL cl_err3("upd","apb_file",g_apa01_t,"",STATUS,"","apb",1)  #No.FUN-660122
             ROLLBACK WORK
             LET g_apa.* = g_apa_t.*       #MOD-B40036
             RETURN
          END IF

         #str MOD-940008 add
          UPDATE apc_file SET apc01 = g_apa.apa01 WHERE apc01 = g_apa01_t
          IF STATUS THEN
             CALL cl_err3("upd","apc_file",g_apa01_t,"",STATUS,"","apc",1)
             ROLLBACK WORK
             LET g_apa.* = g_apa_t.*       #MOD-B40036
             RETURN
          END IF
         #end MOD-940008 add

          UPDATE npp_file SET npp01 = g_apa.apa01
           WHERE npp01 = g_apa01_t
             AND nppsys = 'AP'
             AND npp00 = 1
             AND npp011 = 1
          IF STATUS THEN
#            CALL cl_err('npp',STATUS,0)   #No.FUN-660122
             CALL cl_err3("upd","npp_file",g_apa01_t,"",STATUS,"","npp",1)  #No.FUN-660122
             ROLLBACK WORK
             LET g_apa.* = g_apa_t.*       #MOD-B40036
             RETURN
          END IF

          UPDATE npq_file SET npq01 = g_apa.apa01
           WHERE npq01 = g_apa01_t
             AND npqsys = 'AP'
             AND npq00 = 1
             AND npq011 = 1
          IF STATUS THEN
#            CALL cl_err('npq',STATUS,0)   #No.FUN-660122
             CALL cl_err3("upd","npq_file",g_apa01_t,"",STATUS,"","npq",1)  #No.FUN-660122
             ROLLBACK WORK
             LET g_apa.* = g_apa_t.*       #MOD-B40036
             RETURN
          END IF

          UPDATE apd_file SET apd01 = g_apa.apa01 WHERE apd01 = g_apa01_t
          IF STATUS THEN
#            CALL cl_err('apd',STATUS,0)   #No.FUN-660122
             CALL cl_err3("upd","apd_file",g_apa01_t,"",STATUS,"","apd",1)  #No.FUN-660122
             ROLLBACK WORK
             LET g_apa.* = g_apa_t.*       #MOD-B40036
             RETURN
          END IF

          UPDATE api_file SET api01 = g_apa.apa01 WHERE api01 = g_apa01_t
          IF STATUS THEN
#            CALL cl_err('api',STATUS,0)   #No.FUN-660122
             CALL cl_err3("upd","api_file",g_apa01_t,"",STATUS,"","api",1)  #No.FUN-660122
             ROLLBACK WORK
             LET g_apa.* = g_apa_t.*       #MOD-B40036
             RETURN
          END IF

          UPDATE apk_file SET apk01 = g_apa.apa01 WHERE apk01 = g_apa01_t
          IF STATUS THEN
#            CALL cl_err('apk',STATUS,0)   #No.FUN-660122
             CALL cl_err3("upd","apk_file",g_apa01_t,"",STATUS,"","apk",1)  #No.FUN-660122
             ROLLBACK WORK
             LET g_apa.* = g_apa_t.*       #MOD-B40036
             RETURN
          END IF

          UPDATE apv_file SET apv01 = g_apa.apa01 WHERE apv01 = g_apa01_t
          IF STATUS THEN
#            CALL cl_err('apv',STATUS,0)   #No.FUN-660122
             CALL cl_err3("upd","apv_file",g_apa01_t,"",STATUS,"","apv",1)  #No.FUN-660122
             ROLLBACK WORK
             LET g_apa.* = g_apa_t.*       #MOD-B40036
             RETURN
          END IF
       END IF

      #str MOD-860303 add
      #單身若有採購單時,單頭金額不可大於單身金額
#MOD-960026---begin
#       IF g_aptype = '15' AND g_aza.aza26 != '2' THEN  #No.MOD-890227 add aza26
        SELECT pmc913 INTO l_pmc913 FROM pmc_file                        
         WHERE pmc01 = g_apa.apa05
        IF g_aptype = '15' AND g_aza.aza26 != '2' AND 
           (g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y')) THEN
#MOD-960026---end
          LET l_n = 0
          SELECT COUNT(*) INTO l_n FROM apb_file WHERE apb06 IS NOT NULL
                                                   AND apb01=g_apa.apa01
          IF l_n > 0 THEN
              SELECT SUM(apb10),SUM(apb24) INTO l_apb10,l_apb24     
                FROM apb_file                                     
               WHERE apb01=g_apa.apa01                         
             IF cl_null(l_apb24) THEN LET l_apb24 = 0 END IF
             IF cl_null(l_apb10) THEN LET l_apb10 = 0 END IF
             IF g_apa.apa31f > l_apb24 OR g_apa.apa31 > l_apb10 THEN
                #單頭金額大於單身合計金額, (1)修改單頭 (2)修改單身:
                CALL cl_getmsg('aap-117',g_lang) RETURNING g_msg
                WHILE TRUE
                   LET g_chr=' '
                   LET INT_FLAG = 0  ######add for prompt bug
                   PROMPT g_msg CLIPPED FOR CHAR g_chr
                      ON IDLE g_idle_seconds
                         CALL cl_on_idle()

                      ON ACTION about         #MOD-4C0121
                         CALL cl_about()      #MOD-4C0121

                      ON ACTION help          #MOD-4C0121
                         CALL cl_show_help()  #MOD-4C0121

                      ON ACTION controlg      #MOD-4C0121
                         CALL cl_cmdask()     #MOD-4C0121
                   END PROMPT
                   IF INT_FLAG THEN LET INT_FLAG = 0 END IF
                   IF g_chr MATCHES "[12]" THEN EXIT WHILE END IF
                END WHILE
                IF g_chr = '2' THEN CALL t110_b("") END IF
                IF g_chr = '1' THEN CONTINUE WHILE END IF
             END IF
          END IF
       END IF
      #end MOD-860303 add

       IF g_apa.apa14 <> g_apa_t.apa14 THEN
         #str MOD-910181 add
          LET g_cnt = 0
          SELECT COUNT(*) INTO g_cnt FROM apb_file
            WHERE apb01 = g_apa.apa01
          IF g_cnt > 0 THEN
         #end MOD-910181 add
             SELECT SUM(apb10) INTO g_apa.apa57 FROM apb_file
              WHERE apb01=g_apa.apa01
             IF cl_null(g_apa.apa57) THEN
                LET g_apa.apa57 = 0
             END IF
             DISPLAY BY NAME g_apa.apa57
          END IF   #MOD-910181 add
       END IF

       LET g_apa.apa72=g_apa.apa14
       CALL t110_comp_oox(g_apa.apa01) RETURNING g_net  #CHI-890017 add
      #LET g_apa.apa73=g_apa.apa34-g_apa.apa35          #CHI-890017 mark
       LET g_apa.apa73=g_apa.apa34-g_apa.apa35+g_net    #CHI-890017
       IF g_apa.apa63 NOT matches '[Ss]' THEN  #FUN-8A0075 
          LET g_apa.apa63 = '0'             #FUN-550042
       END IF                                  #FUN-8A0075

      #UPDATE apa_file set * = g_apa.* WHERE apa01 = g_apa.apa01  #MOD-940008 mark
       UPDATE apa_file set * = g_apa.* WHERE apa01 = g_apa01_t    #MOD-940008
      #IF STATUS OR SQLCA.SQLCODE THEN   #MOD-730098
       IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
#         CALL cl_err('upd apa:',SQLCA.SQLCODE,1)   #No.FUN-660122
          CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa:",1)  #No.FUN-660122
          ROLLBACK WORK
          LET g_apa.* = g_apa_t.*       #MOD-B40036
          RETURN
       END IF
    #MOD-970179---modify---start---
       DELETE FROM apc_file WHERE apc01 = g_apa.apa01
       CALL t110_ins_apc(g_apa.*)
       CALL t110_apc_check('w') #MOD-990125
      ##-----MOD-7A0082---------
      #LET l_n = 0  
      #SELECT COUNT(*) INTO l_n FROM pmb_file
      # WHERE pmb01 =g_apa.apa11
      #IF l_n =0 THEN
      #   UPDATE apc_file SET apc08 = g_apa.apa34f,apc09 = g_apa.apa34
      #     WHERE apc01 = g_apa.apa01
      #   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   
      #      CALL cl_err3("upd","apc_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apc:",1) 
      #      ROLLBACK WORK
      #      RETURN
      #   END IF
      #END IF
      ##-----END MOD-7A0082-----
    #MOD-970179---modify---end---

       IF g_apa.apa58 != '1' AND g_apa.apa00[1,1] = '2' THEN
         #IF g_apa.apa16 != g_apa_t.apa16 OR g_apa.apa14!= g_apa_t.apa14 THEN       #MOD-A80159 mark
          IF g_apa.apa16 != g_apa_t.apa16 OR g_apa.apa14!= g_apa_t.apa14            #MOD-A80159
              OR g_apa.apa15!= g_apa_t.apa15 THEN                                   #MOD-A80159
             #OR g_apa.apa31!= g_apa_t.apa31 OR g_apa.apa32!=g_apa_t.apa32 THEN     #No:MOD-4C0154   #MOD-830121
             DECLARE curr_apk_21 CURSOR FOR
              SELECT * FROM apk_file WHERE apk01 = g_apa.apa01

             FOREACH curr_apk_21 INTO g_apk.*
                 #No:MOD-4C0154 匯率變更
                IF g_apa.apa14 != g_apa_t.apa14 THEN
                   LET g_apk.apk13 = g_apa.apa14
                   LET g_apk.apk08 = g_apk.apk08f * g_apk.apk13
                  #LET g_apk.apk08 = cl_digcut(g_apk.apk08,g_azi04)   #No.MOD-840046 mark
                   LET g_apk.apk07 = g_apk.apk07f * g_apk.apk13
                  #LET g_apk.apk07 = cl_digcut(g_apk.apk07,g_azi04)   #No.MOD-840046 mark
                   LET g_apk.apk06 = g_apk.apk07 + g_apk.apk08        #含稅金額
                END IF
                #-----MOD-830121---------
                ##No:MOD-4C0154 金額變更
                #IF g_apa.apa31 != g_apa_t.apa31 OR g_apa.apa32 != g_apa_t.apa32 THEN
                #   LET g_apk.apk08f = g_apa.apa31f
                #   LET g_apk.apk08 = g_apa.apa31
                #   LET g_apk.apk08 = cl_digcut(g_apk.apk08,g_azi04)
                #   LET g_apk.apk07f = g_apa.apa32f
                #   LET g_apk.apk07 = g_apa.apa32
                #   LET g_apk.apk06 = g_apk.apk07 + g_apk.apk08        #含稅金額
                #END IF
                #-----END MOD-830121-----
                IF g_apa.apa16 != g_apa_t.apa16 THEN       #稅率變更
                   LET g_apk.apk07 = g_apk.apk08 * g_apa.apa16 / 100  #稅額
                  #LET g_apk.apk07 = cl_digcut(g_apk.apk07,g_azi04)   #No.MOD-840046 mark
                   LET g_apk.apk08 = g_apk.apk08                      #未稅金額
                   LET g_apk.apk06 = g_apk.apk07 + g_apk.apk08        #含稅金額
                  #LET g_apk.apk06 = cl_digcut(g_apk.apk06,g_azi04)   #No.MOD-840046 mark 
                  #LET g_apk.apk08 = cl_digcut(g_apk.apk08,g_azi04)   #No.MOD-840046 mark 
                  #str MOD-8A0266 add
                   LET g_apk.apk07f= g_apk.apk08f* g_apa.apa16 / 100  #稅額
                   LET g_apk.apk08f= g_apk.apk08f                     #未稅金額
                   LET g_apk.apk06f= g_apk.apk07f+ g_apk.apk08f       #含稅金額
                  #end MOD-8A0266 add
                   LET g_apk.apk29 = g_apa.apa16                      #MOD-A80159
                END IF
               #-MOD-A80159-add-
                IF g_apa.apa15 != g_apa_t.apa15 THEN       #稅別變更
                   LET g_apk.apk11 = g_apa.apa15    
                   SELECT gec06
                     INTO g_apk.apk172
                     FROM gec_file
                    WHERE gec01 = g_apk.apk11 AND gec011='1'  #進項
                      AND gecacti = 'Y'
                END IF
               #-MOD-A80159-end-
                 #No.MOD-840046--begin--
                  LET g_apk.apk06 = cl_digcut(g_apk.apk06,g_azi04)
                  LET g_apk.apk07 = cl_digcut(g_apk.apk07,g_azi04)
                  LET g_apk.apk08 = cl_digcut(g_apk.apk08,g_azi04)
                 #No.MOD-840046---end---
                 #str MOD-8A0266 add
                  LET g_apk.apk06f= cl_digcut(g_apk.apk06f,t_azi04) 
                  LET g_apk.apk07f= cl_digcut(g_apk.apk07f,t_azi04)
                  LET g_apk.apk08f= cl_digcut(g_apk.apk08f,t_azi04)
                 #end MOD-8A0266 add

                UPDATE apk_file SET apk13 = g_apa.apa14,       #No:MOD-4C0154
                                    apk06 = g_apk.apk06,
                                    apk07 = g_apk.apk07,
                                    apk08 = g_apk.apk08,
                                    apk06f= g_apk.apk06f,   #MOD-8A0266 add
                                    apk07f= g_apk.apk07f,   #MOD-8A0266 add
                                    apk08f= g_apk.apk08f,   #MOD-8A0266 add
                                    apk11 = g_apk.apk11,    #MOD-A80159
                                    apk172= g_apk.apk172,   #MOD-A80159
                                    apk29 = g_apk.apk29,    #MOD-A80159
                                    apk32 = g_apk.apk32     #FUN-970108 add
                 WHERE apk01 = g_apk.apk01
                   AND apk02 = g_apk.apk02
                   AND apk03 = g_apk.apk03
                IF STATUS OR SQLCA.SQLCODE THEN
#                  CALL cl_err('upd apk',SQLCA.SQLCODE,0)   #No.FUN-660122
                   CALL cl_err3("upd","apk_file",g_apk.apk01,g_apk.apk02,SQLCA.sqlcode,"","upd apk",1)  #No.FUN-660122
                   ROLLBACK WORK
                   LET g_apa.* = g_apa_t.*       #MOD-B40036
                   RETURN
                END IF
             END FOREACH
          END IF
       END IF

       IF g_apa.apa08 ='UNAP' AND g_apa.apa00 MATCHES '1[1-2]' THEN
          DELETE FROM apk_file WHERE apk01=g_apa.apa01
       END IF

       IF g_apa.apa08 != 'MISC' AND g_apa.apa08 != g_apa_t.apa08 AND
         #cl_null(g_apa.apa08) THEN                          #MOD-B50235 mark
          cl_null(g_apa.apa08) AND g_apa.apa00 != '21' THEN  #MOD-B50235
          DELETE FROM apk_file WHERE apk01=g_apa.apa01
       END IF

       IF g_apa.apa08 != 'MISC' AND g_apa.apa08 != g_apa.apa01 AND
          NOT cl_null(g_apa.apa08) AND g_apa.apa08 !='UNAP' AND
          g_apa.apa00 != '21' THEN   #MOD-670016
          CALL t110_ddd1('u')
       END IF

       CALL t110_diff_rtn('0')  ##TQC-750140

#No.FUN-680027--begin
      CALL t110_ins_apc(g_apa.*)
#No.FUN-680027--end
       CASE
          WHEN g_apa.apa00 = '11' AND g_apz.apz31 = 'N'
             EXIT WHILE
          WHEN (g_apa.apa00 = '12' OR g_apa.apa00 = '13') AND g_apz.apz32 = 'N'   #No.FUN-690080
             EXIT WHILE
       END CASE

       CALL t110_up_gl()
       EXIT WHILE
    END WHILE

    CLOSE t110_cl

    IF g_success = 'Y' THEN
       IF g_apa.apa18 IS NOT NULL AND
          (g_apa.apa18 != g_apa_t.apa18 OR g_apa_t.apa18 IS NULL) THEN
          SELECT COUNT(*) INTO g_cnt FROM apk_file
           WHERE apk01 = g_apa.apa01
          IF g_cnt > 0 THEN
             UPDATE apk_file SET apk04 = g_apa.apa18
              WHERE apk01 = g_apa.apa01
             IF SQLCA.sqlcode OR SQLCA.sqlerrd[3]=0 THEN
#               CALL cl_err('upd apk',SQLCA.sqlcode,0)   #No.FUN-660122
                CALL cl_err3("upd","apk_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apk",1)  #No.FUN-660122
                ROLLBACK WORK
                LET g_apa.* = g_apa_t.*       #MOD-B40036
             ELSE
                COMMIT WORK
                CALL cl_flow_notify(g_apa.apa01,'U')
             END IF
          ELSE
             COMMIT WORK
             CALL cl_flow_notify(g_apa.apa01,'U')
          END IF
       ELSE
          COMMIT WORK
          CALL cl_flow_notify(g_apa.apa01,'U')
       END IF
    ELSE
       ROLLBACK WORK
       LET g_apa.* = g_apa_t.*       #MOD-B40036
    END IF

    IF g_apa.apa51='UNAP' AND (g_apa_t.apa51<>'UNAP' OR g_apa_t.apa51 IS NULL) THEN
       CALL t110_ppp('2')
    END IF
   #FUN-550042
   DISPLAY BY NAME g_apa.apa63
   IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
   CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti)
   ## END FUN-550042 ##

END FUNCTION

#處理INPUT
FUNCTION t110_i(p_cmd)
   DEFINE li_result       LIKE type_file.num5,   #No.FUN-690028 SMALLINT
          l_aag09         LIKE aag_file.aag09,   #No.FUN-690080
          l_aag21         LIKE aag_file.aag21,   #MOD-850100 add  
          l_flag          LIKE type_file.chr1,   #判斷必要欄位是否有輸入  #No.FUN-690028 VARCHAR(1)
          p_cmd           LIKE type_file.chr1,   #a:輸入 u:更改  #No.FUN-690028 VARCHAR(1)
          g_t1            LIKE oay_file.oayslip, #No.FUN-550030  #No.FUN-690028 VARCHAR(5)
          l_amb01,l_amb02 LIKE type_file.num5,   # No:FUN-690028 SMALLINT,
          l_amb03         LIKE amb_file.amb03,   # No:FUN-690028 VARCHAR(2),
          l_apa32f        LIKE apa_file.apa32f,  #MOD-4A0193
          l_apa32         LIKE apa_file.apa32 ,  #MOD-4A0193
          t_apa31f        LIKE apa_file.apa31f,  #MOD-B80140
          t_apa31         LIKE apa_file.apa31,   #MOD-B80140
          t_apa32f        LIKE apa_file.apa32f,  #MOD-970278 add
          t_apa32         LIKE apa_file.apa32 ,  #MOD-970278 add
          l_apb02         LIKE apb_file.apb02,
          l_apb08         LIKE apb_file.apb08,
          l_apb081        LIKE apb_file.apb081,
          l_apb09         LIKE apb_file.apb09,
          l_apb21         LIKE apb_file.apb21,   #MOD-A80204
          l_apb23         LIKE apb_file.apb23,
          l_apb24         LIKE apb_file.apb24,   #MOD-860221 add
          l_apb10         LIKE apb_file.apb10,
          l_apb101        LIKE apb_file.apb101,
          l_apa31f_t      LIKE apa_file.apa31f,  #No.MOD-530687
          l_apa31f_o      LIKE apa_file.apa31f,  #No.MOD-530687
          l_paydate       LIKE type_file.dat,    #No.FUN-690028 DATE
          l_aag05         LIKE aag_file.aag05,   #MOD-580051
          l_pmc30         LIKE pmc_file.pmc30,   #MOD-590301
          l_pmc913        LIKE pmc_file.pmc913,  #MOD-A90181
          l_gen01         LIKE gen_file.gen01    #FUN-5B0081
   DEFINE l_nochk         LIKE type_file.num5    #TQC-750121
   DEFINE l_pmb02         LIKE pmb_file.pmb02    #TQC-770027
   DEFINE l_cnt           SMALLINT   #MOD-810050   #MOD-810244  #MOD-810207
   DEFINE l_gec05         LIKE gec_file.gec05    #MOD-8A0213 add
   DEFINE l_apa02         LIKE apa_file.apa02    #MOD-970179 add
   DEFINE l_apb06         LIKE apb_file.apb06    #MOD-980032 add
   DEFINE l_apa31f        LIKE apa_file.apa31f   #MOD-980032 add 
   DEFINE l_pmm40         LIKE pmm_file.pmm40    #MOD-980032 add 
   DEFINE l_pmm40t        LIKE pmm_file.pmm40t   #CHI-9C0015 add 
   DEFINE l_apb01         LIKE apb_file.apb01    #MOD-9B0048 add
   DEFINE l_apa31f0       LIKE apa_file.apa31f   #MOD-9B0048 add 
   DEFINE l_pmm40t_tot    LIKE pmm_file.pmm40t   #MOD-A30059 add
   DEFINE l_rvu03         LIKE rvu_file.rvu03    #MOD-A80204
   DEFINE l_n             LIKE type_file.num5    #TQC-C70027
   DEFINE l_npq22         LIKE npq_file.npq22    #TQC-C60104  add
   DEFINE l_w             LIKE type_file.num5    #CHI-C10043 add
   DEFINE l_pma11         LIKE pma_file.pma11    #CHI-C10043 add
   DEFINE l_sme02         LIKE sme_file.sme02    #CHI-C10043 add
   DEFINE l_apa64         LIKE apa_file.apa64    #CHI-C10043 add

   CALL cl_set_head_visible("","YES")            #No.FUN-6B0033

   INPUT BY NAME g_apa.apa01,g_apa.apa02,g_apa.apa05,g_apa.apa06,g_apa.apa07,
                 g_apa.apa21,g_apa.apa22,g_apa.apa930,g_apa.apamksg,g_apa.apa42,g_apa.apa41,  #FUN-670064
                 g_apa.apa44,g_apa.apa992,g_apa.apa63,g_apa.apa36,g_apa.apa13,g_apa.apa14,  #No.FUN-690090 add apa992
                 #g_apa.apa08,g_apa.apa15,g_apa.apa16,g_apa.apa58,g_apa.apa11,#FUN-5C0106 remark
                 g_apa.apa15,g_apa.apa16,g_apa.apa08,g_apa.apa77,g_apa.apa58,g_apa.apa11, #FUN-5C0106 #FUN-970108 add apa77
                 g_apa.apa12,g_apa.apa24,g_apa.apa64,g_apa.apa55,g_apa.apa31f,
                 g_apa.apa32f,g_apa.apa60f,g_apa.apa61f,g_apa.apa65f,g_apa.apa37f,g_apa.apa34f,g_apa.apa35f, #No.FUN-690080
                 g_apa.apa31,g_apa.apa32,g_apa.apa60,g_apa.apa61,g_apa.apa65,
#No.FUN-680029--begin
#                g_apa.apa34,g_apa.apa35,g_apa.apa51,
#                g_apa.apa52,g_apa.apa54,g_apa.apa56,g_apa.apa33,g_apa.apa66,
                 g_apa.apa37,g_apa.apa34,g_apa.apa35,                               #No.FUN-690080
                 g_apa.apa56,g_apa.apa33,g_apa.apa66,
                 g_apa.apa25,g_apa.apa100,g_apa.apainpd,g_apa.apa99,g_apa.apa51,g_apa.apa52,g_apa.apa54,g_apa.apa511,g_apa.apa521,g_apa.apa541,   #No:8150 add #FUN-630043 #No.FUN-690080
#No.FUN-680029--end
                 g_apa.apa101,g_apa.apa102,                                   #No.FUN-690080
                 g_apa.apauser,g_apa.apagrup,g_apa.apamodu,g_apa.apadate,g_apa.apaacti,  #No.FUN-690080
                #FUN-850038     ---start---
                 g_apa.apaud01,g_apa.apaud02,g_apa.apaud03,g_apa.apaud04,
                 g_apa.apaud05,g_apa.apaud06,g_apa.apaud07,g_apa.apaud08,
                 g_apa.apaud09,g_apa.apaud10,g_apa.apaud11,g_apa.apaud12,
                 g_apa.apaud13,g_apa.apaud14,g_apa.apaud15
                #FUN-850038     ----end----
                 WITHOUT DEFAULTS

      BEFORE INPUT
         LET g_before_input_done = FALSE
         IF NOT cl_null(g_apa.apa02) THEN  #MOD-BA0189
            CALL t110_bookno()             #MOD-BA0189
         END IF                            #MOD-BA0189
         CALL t110_set_entry(p_cmd)
         CALL t110_set_entry_1()     #No:FUN-8A0075  
         CALL t110_set_no_entry(p_cmd)
         CALL t110_set_no_entry_1()  #No:FUN-8A0075 
         LET g_before_input_done = TRUE
         #-----TQC-620052---------
         CALL cl_set_act_visible("maintain_misc_vender",TRUE)
         #-----END TQC-620052-----
#No.FUN-550030--begin
         CALL cl_set_docno_format("apa01")
#No.FUN-550030--end
         CALL t110_set_no_apa_required()  #FUN-970108 
         CALL t110_set_apa_required()     #FUN-970108
         LET l_apa02 = g_apa_t.apa02           #MOD-970179 add 
      
      AFTER FIELD apa01                  #帳款編號

         IF NOT cl_null(g_apa.apa01) THEN   #No.FUN-690080
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa01 != g_apa01_t) THEN
               CALL s_check_no("aap",g_apa.apa01,g_apa01_t,g_aptype,"apa_file","apa01","")
               RETURNING li_result,g_apa.apa01
               DISPLAY BY NAME g_apa.apa01
               IF (NOT li_result) THEN
                  LET g_apa.apa01=g_apa_t.apa01       #MOD-B50218 mod g_apa_o -> g_apa_t
                  NEXT FIELD apa01
               END IF
               IF NOT cl_null(g_apa.apa01[1,1]) THEN
#                 LET g_apa.apa01[4,4]='-'
#                 DISPLAY BY NAME g_apa.apa01
#                 IF g_apa.apa01 = '   -' THEN
#                    LET g_apa.apa01=''
#                 END IF

#                 LET g_t1=g_apa.apa01[1,3]
#                 CALL s_apyslip(g_t1,g_aptype,g_sys)     #檢查單別
#                 IF NOT cl_null(g_errno) THEN
#                    CALL cl_err(g_t1,g_errno,0)
#                    NEXT FIELD apa01
#                 END IF
#TQC-5C0002
                  CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1
                  SELECT * INTO g_apy.* FROM apy_file
                     WHERE apyslip=g_t1 AND apyacti = 'Y'
                                        AND apykind=g_apa.apa00
#END TQC-5C0002
                   ### MOD-4A0253 ###
                     IF g_apa_t.apa01 IS NULL OR (g_apa.apa01 != g_apa_t.apa01 ) THEN
                        LET  g_apa.apamksg = g_apy.apyapr
                        DISPLAY BY NAME g_apa.apamksg   #簽核否
                     END IF
                   ### END MOD-4A0253 ###

#                 SELECT * INTO g_apy.* FROM apy_file WHERE apyslip=g_t1
#                 IF g_apy.apyauno = 'Y' AND
#                    NOT cl_chk_data_continue(g_apa.apa01[5,10]) THEN
#                    CALL cl_err('auno=Y ','9056',0)
#                    NEXT FIELD apa01
#                 END IF
#
#                 IF g_apy.apyauno MATCHES '[nN]' THEN
#                    IF cl_null(g_apa.apa01[5,10]) THEN
#                       CALL cl_err(g_apa.apa01,'aap-011',0)
#                       NEXT FIELD apa01
#                    END IF
#                 END IF

#                 IF g_apa.apa01 != g_apa01_t OR g_apa01_t IS NULL THEN
#                    SELECT count(*) INTO g_cnt FROM apa_file
#                     WHERE apa01 = g_apa.apa01
#                    IF g_cnt > 0 THEN   #資料重複
#                       CALL cl_err(g_apa.apa01,-239,0)
#                       LET g_apa.apa01 = g_apa01_t
#                       DISPLAY BY NAME g_apa.apa01
#                       NEXT FIELD apa01
#                    END IF
#                 END IF
               END IF
            END IF
         END IF   #No.FUN-690080

         #FUN-990014--Begin
         SELECT apyvcode INTO g_apa.apa77  FROM apy_file WHERE apyslip = g_t1   
         IF cl_null(g_apa.apa77) THEN 
            LET g_apa.apa77 = g_apz.apz63 
         END IF     
         #FUN-990014---End
 
      AFTER FIELD apa02
         IF NOT cl_null(g_apa.apa02) THEN
            CALL t110_bookno()                #No.FUN-730064
            IF g_apa.apa02 <= g_apz.apz57 THEN   #立帳日期不可小於關帳日期
               CALL cl_err(g_apa.apa01,'aap-176',1)
               NEXT FIELD apa02
            END IF

            IF cl_null(g_apa.apa09) THEN
               LET g_apa.apa09=g_apa.apa02
            END IF

            IF g_aptype[1,1] = '1' AND   #MOD-860203 mark  #CHI-930014 mark回復
           #IF (g_aptype[1,1] = '1' OR   #MOD-860203       #CHI-930014 mark
           #    g_aptype='21' OR g_aptype='22' OR g_aptype='26') AND   #MOD-860203 add  #CHI-930014 mark
                g_apa.apa11 IS NOT NULL AND
               #g_apa.apa02 != g_apa_t.apa02 AND g_apa_t.apa02 IS NOT NULL THEN     #MOD-970179 mark
                g_apa.apa02 != l_apa02 AND l_apa02 IS NOT NULL THEN                 #MOD-970179 add
               #No.FUN-690080 --Begin
               IF g_apa_t.apa02 IS NULL OR g_apa_t.apa02<>g_apa.apa02 THEN           #CHI-B80054 add
                  IF g_aptype = '13' OR g_aptype = '17' THEN
                     CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apa.apa11,'EMPL')
                          RETURNING l_paydate,g_apa.apa64,g_apa.apa24
                  ELSE
                     CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apa.apa11,g_apa.apa06)
                          RETURNING l_paydate,g_apa.apa64,g_apa.apa24
                  END IF
                END IF                                                               #CHI-B80054 add
               #No.FUN-690080 --End
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa01,g_errno,0)
                  LET g_apa.apa64 = g_apa_t.apa64
                  LET g_apa.apa24 = g_apa_t.apa24
               ELSE
                  LET g_apa.apa12 = l_paydate
               END IF
               DISPLAY BY NAME g_apa.apa24,g_apa.apa12,g_apa.apa64
               #CHI-AB0017 add --start--
               IF g_apa.apa24 < 0 THEN
                  IF NOT cl_confirm('aap-142') THEN NEXT FIELD apa02 END IF
               END IF
               #CHI-AB0017 add --end--
            END IF
            #-----MOD-790042---------
           #IF g_apa.apa02 != g_apa_t.apa02 THEN    #MOD-970179 mark
            IF g_apa.apa02 != l_apa02 THEN          #MOD-970179 add
               CALL t110_apa13('u')
#---------------------------No.MOD-B70202-------------------------------------------------start
               IF (NOT cl_null(g_apa.apa14) AND g_apa.apa14 != g_apa_t.apa14) OR cl_null(g_apa.apa14) THEN
                  IF NOT t110_apa14(g_apa.apa01) THEN
                     NEXT FIELD apa02
                  END IF
               END IF
#----------------------------No.MOD-B70202-------------------------------------------------end
              #-MOD-A80204-add-
               LET l_cnt = 0
               SELECT COUNT(*) INTO l_cnt
                 FROM apb_file
                WHERE apb01 = g_apa.apa01 AND apb34 = 'N'
                  AND apb21 IS NOT NULL     #MOD-B20082
              #IF l_cnt > 0 THEN                                                                                 #MOD-B20082 mark 
               IF l_cnt > 0 AND (g_aptype = '11' OR g_aptype = '16' OR g_aptype = '21' OR g_aptype = '26') THEN  #MOD-B20082
                  DECLARE chk_rvu_cs CURSOR FOR
                     SELECT DISTINCT apb21  
                       FROM apb_file
                      WHERE apb01=g_apa.apa01 AND apb34 = 'N'
                        AND apb21 IS NOT NULL     #MOD-B20082
                  FOREACH chk_rvu_cs INTO l_apb21
                     SELECT rvu03 INTO l_rvu03
                       FROM rvu_file 
                      WHERE rvu01 = l_apb21
                     IF g_aza.aza26 = '2' THEN
                        IF (YEAR(l_rvu03) > YEAR(g_apa.apa02) OR (YEAR(l_rvu03) = YEAR(g_apa.apa02)
                           AND MONTH(l_rvu03) > MONTH(g_apa.apa02))) THEN 
                           CALL cl_err('','axr-065',1)
                           NEXT FIELD apa02
                           EXIT FOREACH
                        END IF   
                     ELSE        
                        IF (YEAR(l_rvu03) != YEAR(g_apa.apa02) OR (YEAR(l_rvu03) = YEAR(g_apa.apa02)
                           AND MONTH(l_rvu03) != MONTH(g_apa.apa02))) THEN
                           CALL cl_err('','axr-065',1)
                           NEXT FIELD apa02
                           EXIT FOREACH
                        END IF  
                     END IF     
                  END FOREACH                  
               END IF           
              #-MOD-A80204-end- 
            END IF              
            #-----END MOD-790042-----
         END IF                 
         LET l_apa02 = g_apa.apa02                   #MOD-970179 add
                                
      AFTER FIELD apa05         
         IF NOT cl_null(g_apa.apa05) THEN
           #IF g_apa_o.apa05 IS NULL OR g_apa.apa05 != g_apa_o.apa05 THEN         #MOD-B50218 mark
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa05 != g_apa_t.apa05) THEN #MOD-B50218
               CALL t110_apa05('a')
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa05,g_errno,0)
                  LET g_apa.apa05 = g_apa_t.apa05     #MOD-B50218 mod g_apa_o -> g_apa_t
                  DISPLAY BY NAME g_apa.apa05
                  NEXT FIELD apa05
               END IF
               DISPLAY BY NAME g_apa.apa05
            END IF
            LET g_apa_t.apa05 = g_apa.apa05           #MOD-B50218 mod g_apa_o -> g_apa_t
            #No.FUN-950053 --begin--
            SELECT pmc903 INTO g_pmc903  FROM pmc_file
              WHERE pmc01 = g_apa.apa05
            #No.FUN-950053 --end--
         END IF

      BEFORE FIELD apa06
         CALL t110_set_entry(p_cmd)

      AFTER FIELD apa06
         IF NOT cl_null(g_apa.apa06) THEN
            #No.FUN-690080 --Begin
            IF NOT (g_aptype = '13' OR g_aptype = '17') THEN
               #MOD-590301 付款廠商的廠商性質應為 2 or 3
               SELECT pmc30 INTO l_pmc30 FROM pmc_file
                WHERE pmc01=g_apa.apa06
               IF l_pmc30 NOT MATCHES "[23]" THEN
                  CALL cl_err('','aap-050',0)
                  NEXT FIELD apa06
               END IF
               #END MOD-590301
            END IF
           #IF g_apa_o.apa06 IS NULL OR g_apa.apa06 != g_apa_o.apa06 THEN         #MOD-B50218 mark
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa06 != g_apa_t.apa06) THEN #MOD-B50218
               IF g_aptype = '13' OR g_aptype = '17' THEN
                  #CALL t110_cpf(g_apa.apa06,'0')       #No:CHI-780046
                  CALL t110_gen(g_apa.apa06,'0')        #No:CHI-780046
               ELSE
                  SELECT pmc01 INTO g_apa.apa06 FROM pmc_file
                  #No.TQC-7B0083  --Begin  蔡曉峰提的
                  #WHERE pmc24=g_apa.apa06
                   WHERE pmc01=g_apa.apa06
                  #No.TQC-7B0083  --End    蔡曉峰提的
                  DISPLAY BY NAME g_apa.apa06
                  CALL t110_apa06('a')
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa06,g_errno,0)
                  LET g_apa.apa06 = g_apa_t.apa06       #MOD-B50218 mod g_apa_o -> g_apa_t
                  DISPLAY BY NAME g_apa.apa06
                  NEXT FIELD apa06
               END IF

               #MOD-4A0172
               IF g_aptype[1,1] = '1' AND   #MOD-860203 mark  #CHI-930014 mark回復
              #IF (g_aptype[1,1] = '1' OR   #MOD-860203       #CHI-930014 mark
              #    g_aptype='21' OR g_aptype='22' OR g_aptype='26') AND   #MOD-860203 add  #CHI-930014 mark
                   g_apa.apa11 IS NOT NULL THEN
                  SELECT pma11 INTO g_pma11 FROM pma_file
                   WHERE pma01=g_apa.apa11
                  DISPLAY g_pma11 TO pma11

                 #IF g_apa_o.apa11 IS NULL OR g_apa_o.apa11<>g_apa.apa11 THEN           #MOD-B50218 mark
                 #IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa11 != g_apa_t.apa11) THEN #MOD-B50218 #CHI-B80054
                  IF g_apa_t.apa06 IS NULL OR g_apa_t.apa06<>g_apa.apa06 THEN           #CHI-B80054 add
                     IF g_aptype = '13' OR g_aptype = '17' THEN
                        CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apa.apa11,'EMPL')
                             RETURNING l_paydate,g_apa.apa64,g_apa.apa24   #No.+106
                     ELSE
                        CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apa.apa11,
                                       g_apa.apa06)
                             RETURNING l_paydate,g_apa.apa64,g_apa.apa24   #No.+106
                     END IF
                     DISPLAY BY NAME g_apa.apa24
                     LET g_apa.apa12 = l_paydate
                     DISPLAY BY NAME g_apa.apa12
                     DISPLAY BY NAME g_apa.apa64
                     #CHI-AB0017 add --start--
                     IF g_apa.apa24 < 0 THEN
                        IF NOT cl_confirm('aap-142') THEN NEXT FIELD apa06 END IF
                     END IF
                     #CHI-AB0017 add --end--
                  END IF
               END IF
               #--
            END IF
           #LET g_apa_o.apa06 = g_apa.apa06   #MOD-9B0089 mark
            IF g_aptype = '13' OR g_aptype = '17' THEN
               LET g_apa.apa21 = g_apa.apa06    #請款人員
               LET g_apa.apa05 = g_apa.apa06    #請款人員
            END IF
            #No.FUN-690080 --End
         END IF
         LET g_apa_t.apa06 = g_apa.apa06   #MOD-9B0089 add   #MOD-B50218 mod g_apa_o -> g_apa_t
         CALL t110_set_no_entry(p_cmd)

      AFTER FIELD apa07
         IF NOT cl_null(g_apa.apa07) THEN
           #TQC-C70027--mark--str--
           #IF g_apa.apa07[1,1]='.' THEN
           #  #LET g_msg = g_apa.apa07[2,9]     #MOD-A60095 mark
           #   LET g_msg = g_apa.apa07[2,11]    #MOD-A60095
           #   LET g_msg = g_msg CLIPPED   #No.TQC-720043
           #   SELECT gen02 INTO g_apa.apa07 FROM gen_file WHERE gen01=g_msg
           #   DISPLAY BY NAME g_apa.apa07
           #   IF STATUS THEN
           #      NEXT FIELD apa07
           #   END IF
           #END IF
           #TQC-C70027--mark--end--
           #TQC-C70027--add--str--
          #-------------------MOD-CC0238-----------------(S)
           #--MOD-CC0238--mark
           #SELECT COUNT(*) INTO l_n FROM apa_file
           # WHERE apa07 = g_apa.apa07
           #   AND apa00 in ('11','12','15')
           #   AND apa34f != apa35f
           #   AND apa34 != apa35
           #   AND apa06 = 'MISC'
           #IF l_n = 0 THEN
           #   CALL cl_err('','aap-356',0)
           #   NEXT FIELD apa07
           #END IF
           ##TQC-C70027--add--str-- 
           #--MOD-CC0238--mark
            IF g_apa.apa07[1,1]='.' THEN
               LET g_msg = g_apa.apa07[2,11]
               LET g_msg = g_msg CLIPPED
               IF g_aptype = '12' AND g_apa.apa06 = 'MISC' THEN
                  SELECT pmc03 INTO g_apa.apa07
                    FROM pmc_file WHERE pmc01=g_msg
               ELSE
                  SELECT gen02 INTO g_apa.apa07
                    FROM gen_file WHERE gen01=g_msg
               END IF
               DISPLAY BY NAME g_apa.apa07
               IF STATUS THEN
                  NEXT FIELD apa07
               END IF
            END IF
           #----------------MOD-D20174-----------mark          
           #IF g_apa.apa06 = 'MISC' THEN
           #   LET l_cnt = 0
           #   SELECT COUNT(*) INTO l_cnt FROM pmc_file
           #    WHERE pmc03 = g_apa.apa07
           #     #AND pmc14 = '2'              #CHI-D10057 mark
           #      AND pmcacti = 'Y'
           #   IF l_cnt = 0 THEN
           #      CALL cl_err('','aap-356',0)
           #      NEXT FIELD apa07
           #   END IF
           #END IF
           #----------------MOD-D20174-----------mark          
            IF g_apa.apa06 = 'EMPL' THEN
               LET l_cnt = 0
               SELECT COUNT(*) INTO l_cnt FROM gen_file
                WHERE gen02 = g_apa.apa07
                  AND genacti = 'Y'
               IF l_cnt = 0 THEN
                  CALL cl_err('','aoo-070',0)
                  NEXT FIELD apa07
               END IF
            END IF
          #-------------------MOD-CC0238-----------------(E)
           #TQC-C60104--add--str--
            IF g_apa_t.apa07 != g_apa.apa07 THEN
               LET g_apa_t.apa07 = g_apa.apa07
               DISPLAY BY NAME g_apa.apa07
               UPDATE apa_file SET apa07 = g_apa.apa07
                WHERE apa01 = g_apa01_t
               IF cl_confirm('aap-943') THEN
                  CALL t110_v0()
               END IF
            END IF
           #TQC-C60104--add--end--
         END IF

      BEFORE FIELD apa08
         CALL t110_set_entry(p_cmd)

      AFTER FIELD apa08
        #start FUN-680110 add
         #IF (g_apa.apa00!='16' AND g_apa.apa00!='26') AND g_apa.apa08='UNAP' THEN   #MOD-7A0040
         IF (g_apa.apa00!='16' AND g_apa.apa00!='26' AND g_apa.apa00!='12') AND g_apa.apa08='UNAP' THEN   #MOD-7A0040
            CALL cl_err_msg('','aap-923','aapt160,aapt260',1)   #非aapt160,aapt260此欄位不可輸入UNAP
            NEXT FIELD apa08
         END IF
        #end FUN-680110 add

         IF g_aptype ='11' THEN                     #MOD-960059  #MOD-960264 mark回復
        #IF g_aptype ='11' OR g_aptype = '12' THEN  #MOD-960059  #MOD-960264 mark
            IF cl_null(g_apa.apa08) THEN
               CALL cl_err('apa08 is null: ','aap-099',0)
               NEXT FIELD apa08
            END IF
         END IF
        #str MOD-960264 add
        #當發票聯數(gec05)不為4或X時,aapt120的發票欄位(apa08)為必輸
         IF g_aptype ='12' OR g_aptype ='13' OR g_aptype ='15' THEN   #MOD-B30179 add 15 #MOD-B40108 add 13
            LET l_gec05 = ''
            SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01=g_apa.apa15
            IF l_gec05 NOT MATCHES '[4X]' AND cl_null(g_apa.apa08) THEN
               CALL cl_err('apa08 is null: ','aap-099',0)
               NEXT FIELD apa08
            END IF
         END IF
        #end MOD-960264 add

         IF g_apa.apa08 IS NULL THEN
            LET g_apa.apa08 = ' '
            #LET g_apa.apa171 = NULL   #MOD-770121
            #DISPLAY BY NAME g_apa.apa171   #MOD-770121
         END IF

         IF g_apa_t.apa08  ='UNAP' AND g_apa.apa08 !='UNAP' AND
            g_apa.apa00 !='12' AND g_apa.apa00 !='13' THEN   #No.FUN-690080
            LET g_apa.apa08=g_apa_t.apa08
            DISPLAY BY NAME g_apa.apa08
            CALL cl_err(g_apa.apa08,'aap-015',0)
            NEXT FIELD apa08
         END IF

         IF (g_apa_t.apa08 !='UNAP' OR g_apa_t.apa08 IS NULL) AND
             g_apa.apa08    ='UNAP' AND g_apa.apa00 !='12' AND g_apa.apa00 !='13' THEN   #No.FUN-690080
             LET g_apa.apa08=g_apa_t.apa08
             DISPLAY BY NAME g_apa.apa08
             CALL cl_err(g_apa.apa08,'aap-001',0)
             NEXT FIELD apa08
         END IF
     #TQC-750121 begin
         IF g_aptype !='21' AND g_aptype!='22' THEN   #TQC-750177
           IF g_apa.apa08 != 'MISC' AND NOT cl_null(g_apa.apa08) AND
              g_apa.apa08 != 'UNAP' THEN
              LET l_nochk = LENGTH(g_apa.apa08)
              IF g_apa.apa171 = '28' OR g_apa.apa171 = '29' THEN
                 IF l_nochk != 14 THEN
                    CALL cl_err(g_apa.apa08,'amd-009',0)
                    NEXT FIELD apa08
                 END IF
              ELSE
                 IF NOT cl_null(g_apa.apa08) THEN
                    IF g_aza.aza26<>'2' THEN   #No.MOD-7B0128
                       IF g_apa.apa171 != 'XX' AND g_apa.apa171 != '22' THEN  
                          IF l_nochk != 10 THEN
                             CALL cl_err(g_apa.apa08,'amd-010',0)
                             NEXT FIELD apa08
                          END IF
                       #str MOD-870022 add
                        ELSE
                          #稅別格式若為22時,提示警訊即可,不控卡
                           IF g_apa.apa171='22' THEN
                              CALL cl_err(g_apa.apa08,'amd-010',0)
                           END IF
                       #end MOD-870022 add
                       END IF
                    END IF
                 END IF
              END IF
           END IF    #TQC-750177
         END IF
     #TQC-750121 end 

         IF g_apa.apa08 != 'MISC' AND NOT cl_null(g_apa.apa08) AND
            g_apa.apa08 != 'UNAP' AND
            ((g_apa_t.apa08 IS NOT NULL AND g_apa.apa08!=g_apa.apa01) OR
           #str MOD-890213 mod
           # (g_apa_t.apa08 IS NULL AND t110_chk(g_apa.apa08))) THEN
             (g_apa_t.apa08 IS NULL)) THEN
           #end MOD-890213 mod
           #str MOD-8A0213 add
            LET l_gec05 = ''
            SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01=g_apa.apa15
           #IF l_gec05 != 'X' THEN                   #No.MOD-B80015 mark
            IF l_gec05 NOT MATCHES '[4X]' THEN       #No.MOD-B80015 add
           #end MOD-8A0213 add
              #str MOD-890213 add
              #IF g_apa_t.apa08 IS NULL AND NOT t110_chk(g_apa.apa08) THEN     #MOD-A50180 mark
               IF NOT t110_chk(g_apa.apa08) THEN                               #MOD-A50180
                  CALL cl_err(g_apa.apa08,'sub-005',0)
                  NEXT FIELD apa08
               END IF
              #end MOD-890213 add
            END IF   #MOD-8A0213 add
            LET l_amb03=g_apa.apa08[1,2]
            IF g_apa.apa02 != g_apa.apa09 THEN
               LET l_amb01=YEAR(g_apa.apa09)
               LET l_amb02=MONTH(g_apa.apa09)
            ELSE
               LET l_amb01=YEAR(g_apa.apa02)
               LET l_amb02=MONTH(g_apa.apa02)
            END IF
            LET g_msg = ""   #MOD-9C0356 add
            #CHI-930020--Begin
            SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01 = g_apa.apa15
            IF g_apz.apz07 = 'Y' AND (l_gec05 = '2' OR l_gec05 = '3') AND 
               g_aza.aza26!= '2' THEN   #MOD-9C0444 add
               CALL s_apkchk(l_amb01,l_amb02,l_amb03,g_apa.apa171)
                    RETURNING g_errno,g_msg
            END IF 
            #CHI-930020---End
            IF NOT cl_null(g_msg) THEN
               CALL cl_getmsg(g_msg,g_lang) RETURNING g_msg
               ERROR g_msg clipped,' invoice =',g_apa.apa08,' SQLCODE=',g_errno
                IF cl_confirm('aap-766') THEN  #No.MOD-480431
                  IF NOT cl_null(g_errno) THEN
                     NEXT FIELD apa08
                  END IF
               END IF
            END IF

#-----MOD-620048---------
         IF g_apa_t.apa08 IS NOT NULL AND g_apa_t.apa08 = 'MISC' THEN  #原本是多發票
            SELECT COUNT(*) INTO g_cnt FROM apk_file
             WHERE apk01 = g_apa.apa01
            IF g_cnt > 0 AND g_apa_t.apa08 != g_apa.apa08 THEN
               CALL cl_err(g_apa.apa08,'aap-761',0)
               LET g_apa.apa08 = g_apa_t.apa08
               DISPLAY BY NAME g_apa.apa08
               NEXT FIELD apa08
            END IF
         END IF
#-----END MOD-620048-----

            #No:8901 add
            IF g_apa.apa08 != 'MISC' AND g_apa.apa08 != 'UNAP' AND
               NOT cl_null(g_apa.apa08) THEN
               IF g_aptype='11' OR g_aptype='12' OR 
                  g_aptype='13' OR g_aptype='15' THEN  #No.FUN-690080  #MOD-9B0190 add 15
                  IF g_apa.apa08 IS NOT NULL AND (g_apa_t.apa08 IS NULL OR
                     g_apa.apa08 != g_apa_t.apa08) THEN
                     #CALL t110_invoice_chk(g_apa.apa08)   #MOD-770138
                     #CALL t110_invoice_chk(g_apa.apa08,'')   #MOD-770138
                    #CALL t110_invoice_chk(g_apa.apa08,'',g_apa.apa09)   #CHI-820005   #No.TQC-CB0066   Mark
                     CALL t110_invoice_chk(g_apa.apa08,'',g_apa.apa09,g_apa.apa46)     #No.TQC-CB0066   Add
                     IF NOT cl_null(g_errno) THEN
                        CALL cl_err(g_apa.apa08,g_errno,0)
                        NEXT FIELD apa08
                     END IF
                  END IF
               END IF
               IF g_apa.apa18 IS NULL THEN
                  CALL t110_apa17('a')
                  DISPLAY BY NAME g_apa.apa07   #TQC-630164 
                  DISPLAY BY NAME g_apa.apa24,g_apa.apa12,g_apa.apa64  #MOD-9C0148 add
               END IF
            END IF
         END IF

         IF p_cmd='u' AND g_apa.apa08='MISC' AND
            (g_apa_t.apa08<>'MISC' OR g_apa_t.apa08 IS NULL)
            AND g_apa.apa00[1,1] !='2' THEN
            CALL t110_ddd('1')   #MOD-950112 add參數
            DISPLAY BY NAME g_apa.apa07      #TQC-630164 
            CALL t110_show_multi_invoice()   #No.TQC-A30076
         END IF
#-----MOD-620048---------
#        IF g_apa_t.apa08 IS NOT NULL AND g_apa_t.apa08 = 'MISC' THEN  #原本是多發票
#           SELECT COUNT(*) INTO g_cnt FROM apk_file
#            WHERE apk01 = g_apa.apa01
#           IF g_cnt > 0 AND g_apa_t.apa08 != g_apa.apa08 THEN
#              CALL cl_err(g_apa.apa08,'aap-761',0)
#              LET g_apa.apa08 = g_apa_t.apa08
#              DISPLAY BY NAME g_apa.apa08
#              NEXT FIELD apa08
#           END IF
#        END IF
#-----END MOD-620048-----
#No.FUN-680027--begin
         UPDATE apc_file SET apc12 =g_apa.apa08
          WHERE apc01 =g_apa.apa01
#No.FUN-680027--end
         CALL t110_set_no_entry(p_cmd)

      #FUN-970108---Begin
      BEFORE FIELD apa77
        IF g_apa.apa77 IS NULL THEN #No.TQC-A30072
           #CHI-990056---Begin
           # SELECT apz63 INTO g_apa.apa77 FROM apz_file
           # DISPLAY BY NAME g_apa.apa77
             LET g_t1=s_get_doc_no(g_apa.apa01)
             SELECT apyvcode INTO g_apa.apa77 FROM apy_file WHERE apyslip = g_t1
             IF cl_null(g_apa.apa77) THEN
                LET g_apa.apa77 = g_apz.apz63  
             END IF
             DISPLAY BY NAME g_apa.apa77   #No.TQC-A30072
        END IF       #No.TQC-A30072
        #CHI-990056---End

      AFTER FIELD apa77
          IF NOT cl_null(g_apa.apa77) THEN   
             SELECT COUNT(*) INTO l_cnt FROM ama_file
              WHERE ama02 = g_apa.apa77
             IF l_cnt = 0 THEN 
                IF g_aza.aza26 = '0' THEN              #MOD-A10127 add
                   CALL cl_err("","amd-028",1) 
                END IF                                 #MOD-A10127 add
             END IF
            #IF g_aza.aza21 = 'Y' OR NOT s_chkban(g_apa.apa63) THEN #FUN-990053 mod  #TQC-9A0017 mark
             IF g_aza.aza21 = 'Y' AND NOT s_chkban(g_apa.apa77) THEN #FUN-990053 mod  #TQC-9A0017
                CALL cl_err("","mfg7015",1)
                NEXT FIELD apa77
             END IF
          ELSE
             IF g_aza.aza94 = 'Y' THEN
                CALL cl_err('apa77 is null: ','aap-099',0)
                NEXT FIELD apa77 
             END IF            
          END IF
      #FUN-970108---End
      
      AFTER FIELD apa11
          IF g_aptype[1,1] = '1' AND cl_null(g_apa.apa11) THEN
             NEXT FIELD apa11
          END IF

          IF g_aptype[1,1] = '1' AND   #MOD-860203 mark  #CHI-930014 mark回復
         #IF (g_aptype[1,1] = '1' OR   #MOD-860203       #CHI-930014 mark
         #    g_aptype='21' OR g_aptype='22' OR g_aptype='26') AND   #MOD-860203 add  #CHI-930014 mark
              g_apa.apa11 IS NOT NULL THEN
            SELECT pma11 INTO g_pma11 FROM pma_file
             WHERE pma01 = g_apa.apa11
            IF STATUS THEN
#              CALL cl_err('sel pma:',STATUS,0)   #No.FUN-660122
               CALL cl_err3("sel","pma_file",g_apa.apa11,"",STATUS,"","sel pma:",1)  #No.FUN-660122
               NEXT FIELD apa11
            END IF

            IF g_apa.apa00 = '11' THEN
               IF g_pma11 MATCHES '[3-8]' THEN
                  CALL cl_err('pma11=3-8 ','aap-273',0)
                  NEXT FIELD apa11
               END IF
            END IF

            DISPLAY g_pma11 TO pma11

           #IF g_apa_o.apa11 IS NULL OR g_apa_o.apa11<>g_apa.apa11 THEN           #MOD-B50218 mark
           #IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa11 != g_apa_t.apa11) THEN #MOD-B50218 #CHI-B80054 mark
            IF g_apa_t.apa11 IS NULL OR g_apa_t.apa11<>g_apa.apa11 THEN           #CHI-B80054 add 
               LET g_errno=''
               #No.FUN-690080 --Begin
               IF g_aptype = '13' OR g_aptype = '17' THEN
                  CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apa.apa11,'EMPL')
                       RETURNING l_paydate,g_apa.apa64,g_apa.apa24   #No.+106
               ELSE
                  CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apa.apa11,
                                 g_apa.apa06)
                       RETURNING l_paydate,g_apa.apa64,g_apa.apa24   #No.+106
               END IF
               #No.FUN-690080 --End
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa11,g_errno,0)
                  LET g_apa.apa11 = g_apa_t.apa11       #MOD-B50218 mod g_apa_o -> g_apa_t
                  DISPLAY BY NAME g_apa.apa11
               END IF
               DISPLAY BY NAME g_apa.apa24
               LET g_apa.apa12 = l_paydate
               DISPLAY BY NAME g_apa.apa12
               DISPLAY BY NAME g_apa.apa64
               #CHI-AB0017 add --start--
               IF g_apa.apa24 < 0 THEN
                  IF NOT cl_confirm('aap-142') THEN NEXT FIELD apa11 END IF
               END IF
               #CHI-AB0017 add --end--
#No.FUN-680027--begin
             IF p_cmd='u' THEN
               DELETE FROM apc_file WHERE apc01 =g_apa.apa01
               CALL t110_ins_apc(g_apa.*)
             END IF
#No.FUN-680027--end
            END IF
         END IF
         IF g_apa.apa11 IS NULL THEN LET g_apa.apa11 = ' ' END IF   #MOD-7B0101
         LET g_apa_t.apa11 = g_apa.apa11           #MOD-B50218 mod g_apa_o -> g_apa_t

      AFTER FIELD apa12
         IF g_aptype[1,1] = '1' AND   #MOD-860203 mark  #CHI-930014 mark回復
        #IF (g_aptype[1,1] = '1' OR   #MOD-860203       #CHI-930014 mark
        #    g_aptype='21' OR g_aptype='22' OR g_aptype='26') AND   #MOD-860203 add  #CHI-930014 mark
             g_apa.apa12 IS NOT NULL THEN
           #IF g_apa_o.apa12 IS NULL OR g_apa_o.apa12<>g_apa.apa12 THEN           #MOD-B50218 mark
           #IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa12 != g_apa_t.apa12) THEN #MOD-B50218 #CHI-B80054 mark
            IF g_apa_t.apa12 IS NULL OR g_apa_t.apa12<>g_apa.apa12 THEN           #CHI-B80054 add
               #No.FUN-690080 --Begin
               IF g_aptype = '13' OR g_aptype = '17' THEN
                 #CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apa.apa11,'EMPL')              #MOD-980148 mark
                  CALL s_paydate('a',g_apa.apa12,g_apa.apa09,g_apa.apa02,g_apa.apa11,'EMPL')     #MOD-980148 add
                     RETURNING l_paydate,g_apa.apa64,g_apa.apa24   #No.+106
               ELSE
                 #CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apa.apa11,                 #MOD-980148 mark
                  CALL s_paydate('a',g_apa.apa12,g_apa.apa09,g_apa.apa02,g_apa.apa11,        #MOD-980148 add
                                 g_apa.apa06)
                     RETURNING l_paydate,g_apa.apa64,g_apa.apa24   #No.+106
               END IF
               #No.FUN-690080 --End
               DISPLAY BY NAME g_apa.apa24,g_apa.apa64
               #CHI-AB0017 add --start--
               IF g_apa.apa24 < 0 THEN
                  IF NOT cl_confirm('aap-142') THEN NEXT FIELD apa12 END IF
               END IF
               #CHI-AB0017 add --end--
               CALL t110_upd_apc_date()     #MOD-B50218 
            END IF
#No.FUN-6800270--begin
           #-MOD-B50218-mark-
           #IF g_apa_o.apa12 IS NULL OR g_apa_o.apa12<>g_apa.apa12 THEN
           #   CALL t110_upd_apc_date()   
           #END IF
           #-MOD-B50218-end-
#No.FUN-6800270--end
         END IF
         LET g_apa_t.apa12 = g_apa.apa12    #MOD-B50218 mod g_apa_o -> g_apa_t

#No.FUN-6800270--begin
      AFTER FIELD apa64
         IF g_apa.apa64 IS NOT NULL THEN
           #IF g_apa_o.apa64 IS NULL OR g_apa_o.apa64<>g_apa.apa64 THEN           #MOD-B50218 mark
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa64 != g_apa_t.apa64) THEN #MOD-B50218
               CALL t110_upd_apc_date()   
            END IF
           #-----------------------CHI-C10043-----------------------------start
           #僅限於類別為轉帳(2)和電匯(C)時才需要檢核假日問題
            SELECT pma11 INTO l_pma11 FROM pma_file
             WHERE pma01 = g_apa.apa11
            IF l_pma11 = '2' OR l_pma11 = 'c' THEN
              #若為假日,找尋下一個工作日
               SELECT nph02 INTO g_buf1 FROM nph_file
                WHERE nph01 = g_apa.apa64
               IF STATUS = 0 THEN
                  SELECT MIN(sme01) INTO l_apa64 FROM sme_file
                   WHERE sme01 > g_apa.apa64 AND sme02 = 'Y'
                  IF STATUS = 100 THEN
                     CALL cl_err3("sel","sme_file","","","amr-533","","",1)
                  ELSE
                     CALL cl_err3("sel","sme_file","","","aap-803","","",1)
                     LET g_apa.apa64 = l_apa64
                  END IF
               END IF
               LET l_w = WEEKDAY(g_apa.apa64)
              #若為週日
               IF l_w = 0 THEN
                  SELECT sme02 INTO l_sme02 FROM sme_file
                   WHERE sme01 = g_apa.apa64
                  IF cl_null(l_sme02) THEN LET l_sme02 = 'N' END IF
                  IF l_sme02 = 'N' THEN
                     LET g_apa.apa64 = g_apa.apa64 + 1
                     CALL cl_err(g_apa.apa64,'aap-803',0)
                  ELSE
                     IF cl_confirm('aap-353') THEN
                        LET g_apa.apa64 = g_apa.apa64 + 1
                     END IF
                  END IF
                END IF
              #若為週六
               IF l_w = 6 THEN
                  LET l_sme02='N'
                  SELECT sme02 INTO l_sme02 FROM sme_file
                   WHERE sme01 = g_apa.apa64
                  IF cl_null(l_sme02) THEN LET l_sme02 = 'N' END IF
                  IF l_sme02 = 'N' THEN
                     LET g_apa.apa64 = g_apa.apa64 + 2
                     CALL cl_err(g_apa.apa64,'aap-803',0)
                  ELSE
                     IF cl_confirm('aap-353') THEN
                        LET g_apa.apa64 = g_apa.apa64 + 2
                     END IF
                  END IF
               END IF
            END IF
            DISPLAY BY NAME g_apa.apa64
           #-----------------------CHI-C10043-------------------------------end
         END IF
#No.FUN-6800270--end

      AFTER FIELD apa24
         IF g_aptype[1,1] = '1' AND   #MOD-860203 mark  #CHI-930014 mark回復
        #IF (g_aptype[1,1] = '1' OR   #MOD-860203       #CHI-930014 mark
        #    g_aptype='21' OR g_aptype='22' OR g_aptype='26') AND   #MOD-860203 add  #CHI-930014 mark
             g_apa.apa24 IS NOT NULL THEN
           #IF g_apa_o.apa24 IS NULL OR g_apa_o.apa24<>g_apa.apa24 THEN           #MOD-B50218 mark
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa24 != g_apa_t.apa24) THEN #MOD-B50218
               #CHI-AB0017 add --start--
               IF g_apa.apa24 < 0 THEN
                  IF NOT cl_confirm('aap-142') THEN NEXT FIELD apa24 END IF
               END IF
               #CHI-AB0017 add --end--
               CALL s_duedate(g_apa.apa06,g_apa.apa12,g_apa.apa24)
                    RETURNING g_apa.apa64
               DISPLAY BY NAME g_apa.apa64
               CALL t110_upd_apc_date()      #No.FUN-680027
            END IF
         END IF
         LET g_apa_t.apa24 = g_apa.apa24     #MOD-B50218 mod g_apa_o -> g_apa_t

      AFTER FIELD apa13
         IF NOT cl_null(g_apa.apa13) THEN
            IF g_apa_t.apa13 IS NULL OR g_apa.apa13 != g_apa_t.apa13 THEN
               CALL t110_apa13('a')
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa13,g_errno,0)
                  NEXT FIELD apa13
               END IF
               LET g_apa.apa72 = g_apa.apa14   #No.TQC-7C0094  
            END IF
            LET g_apa_t.apa13 = g_apa.apa13  #MOD-B50218 mod g_apa_o -> g_apa_t
         END IF
         LET g_apa_t.apa13 = g_apa.apa13   #MOD-5B0255

      AFTER FIELD apa14
         #FUN-4C0073
         IF g_apa.apa13 =g_aza.aza17 THEN
            LET g_apa.apa14=1
            DISPLAY BY NAME g_apa.apa14
         END IF
         #--END
        #LET g_apa.apa14 = cl_digcut(g_apa.apa14,g_azi.azi07)   #No:MOD-530274   #MOD-6B0066
        #LET g_apa.apa14 = cl_digcut(g_apa.apa14,t_azi07)   #No:MOD-530274   #MOD-6B0066     #MOD-990058 mark
         DISPLAY BY NAME g_apa.apa14   #No:MOD-530247
         IF NOT cl_null(g_apa.apa14) THEN
         #No.TQC-9A0086 add --begin
            IF g_apa.apa14 < 0 THEN
               CALL cl_err('','aec-020',0)
               NEXT FIELD apa14
            END IF
         #No.TQC-9A0086 add --end
            IF g_apa.apa14 = 0 THEN
               CALL cl_err('apa14 is null ','aap-099',0)
               NEXT FIELD apa14
            END IF
           #IF g_apa.apa14 <> g_apa_o.apa14 THEN                                  #MOD-B50218 mark
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa14 != g_apa_t.apa14) THEN #MOD-B50218
               SELECT COUNT(*) INTO g_cnt FROM apb_file
                WHERE apb01=g_apa.apa01
#----------------No.MOD-B70202-------------------------------------------------start
               IF NOT t110_apa14(g_apa.apa01) THEN
                  NEXT FIELD apa14
               END IF
              #IF g_cnt > 0 THEN
              #   IF NOT cl_confirm('aap-331') THEN
              #      #-----MOD-640473---------
              #      #NEXT FIELD NEXT
              #      CALL cl_err('','aap-888',1)
              #      LET g_apa.apa14 = g_apa_t.apa14
              #      DISPLAY BY NAME g_apa.apa14
              #      NEXT FIELD apa14
              #      #-----END MOD-640473-----
              #   END IF
 
              #   DECLARE upd_apb_cs CURSOR FOR
              #      SELECT apb23,apb09,apb02,apb24   #MOD-860221 add apb24  
              #        FROM apb_file
              #       WHERE apb01=g_apa.apa01
              #   FOREACH upd_apb_cs INTO l_apb23,l_apb09,l_apb02,l_apb24  #MOD-860221 add l_apb24 
              #      LET l_apb08 = l_apb23 * g_apa.apa14
              #     #LET l_apb08 = cl_digcut(l_apb08,t_azi.azi03)   #MOD-6B0066
              #      LET l_apb08 = cl_digcut(l_apb08,g_azi03)   #MOD-6B0066
              #     #LET l_apb10 = l_apb09 * l_apb08       #MOD-860221 mark
              #      LET l_apb10 = l_apb24 * g_apa.apa14   #MOD-860221
              #     #LET l_apb10 = cl_digcut(l_apb10,t_azi.azi04)   #MOD-6B0066
              #      LET l_apb10 = cl_digcut(l_apb10,g_azi04)   #MOD-6B0066
              #      LET l_apb081= l_apb08
              #      LET l_apb101= l_apb10     

              #      UPDATE apb_file SET apb08 = l_apb08,
              #                          apb081= l_apb081,
              #                          apb10 = l_apb10,
              #                          apb101= l_apb101
              #       WHERE apb01 = g_apa.apa01
              #         AND apb02 = l_apb02
              #      IF STATUS OR SQLCA.SQLCODE THEN
#             #         CALL cl_err('upd apb:',SQLCA.SQLCODE,0)   #No.FUN-660122
              #         CALL cl_err3("upd","apb_file",g_apa.apa11,l_apb02,SQLCA.sqlcode,"","upd apb:",1)  #No.FUN-660122
              #         LET g_apa.apa14 = g_apa_t.apa14
              #         DISPLAY BY NAME g_apa.apa14
              #         NEXT FIELD apa14
              #         EXIT FOREACH
              #      END IF
              #   END FOREACH                  
              #   CALL t110_b_fill(' 1=1')
              #   CALL t110_sum_apa()
              #ELSE
              #   #雜項帳款有可能沒有單身資料
#             #   IF g_apa.apa00='12' THEN   #MOD-590460
              #  #IF g_apa.apa00='12' OR g_apa.apa00='15' THEN   #MOD-590460   #MOD-640473
              #   IF g_apa.apa00='12' OR g_apa.apa00='15' OR g_apa.apa00='16' OR  #MOD-640473  #MOD-870215 add 16
              #      g_apa.apa00='21' OR g_apa.apa00='13' OR g_apa.apa00='17' OR  #MOD-590460  #MOD-640473  #No.FUN-690080
              #      g_apa.apa00='22' THEN   #MOD-9B0168 add
              #      LET g_apa.apa31 = g_apa.apa31f * g_apa.apa14
              #     #LET g_apa.apa31 = cl_digcut(g_apa.apa31,t_azi.azi04)   #MOD-6B0066
              #      LET g_apa.apa31 = cl_digcut(g_apa.apa31,g_azi04)   #MOD-6B0066
              #      LET g_apa.apa32 = g_apa.apa31 * g_apa.apa16 / 100
              #     #LET g_apa.apa32 = cl_digcut(g_apa.apa32,t_azi.azi04)   #MOD-6B0066
              #      LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)   #MOD-6B0066
              #      DISPLAY BY NAME g_apa.apa31
              #      DISPLAY BY NAME g_apa.apa32
              #      CALL t110_apa34f('0')   #TQC-750140
              #      CALL t110_unpay()
              #   END IF
              #END IF
#----------------No.MOD-B70202-----------------------------------------------------end
               CALL t110_apv_diff()    #MOD-A80217
               CALL t110_api_diff()    #MOD-C20206 add
            END IF
            LET g_apa_t.apa14 = g_apa.apa14  #MOD-B50218 mod g_apa_o -> g_apa_t
         END IF
 
      AFTER FIELD apa15
         IF NOT cl_null(g_apa.apa15) THEN
           #IF g_apa_o.apa15 IS NULL OR g_apa.apa15 != g_apa_o.apa15 THEN         #MOD-B50218 mark
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa15 != g_apa_t.apa15) THEN #MOD-B50218
               CALL t110_apa15('a')
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa15,g_errno,0)
                  NEXT FIELD apa15
               END IF
            END IF

            LET g_apa_t.apa15 = g_apa.apa15  #MOD-B50218 mod g_apa_o -> g_apa_t
            IF g_apa.apa08 <> 'MISC' THEN    #MOD-970111
               IF g_apa.apa16 != g_apa_t.apa16 AND g_apa.apa16 IS NOT NULL AND   #MOD-B50218 mod g_apa_o -> g_apa_t
                  g_apa.apa31f > 0 AND g_gec05 != 'T'AND g_gec05 != 'A' THEN     #No.MOD-530687 #FUN-630068
                  LET g_apa.apa32f = g_apa.apa31f * g_apa.apa16 / 100
                  CALL t110_apa32f() RETURNING l_apa32f                          #No.MOD-B80140 add
                  LET g_apa.apa32f = l_apa32f                                    #No.MOD-B80140 add
                 #LET g_apa.apa32f = cl_digcut(g_apa.apa32f,g_azi.azi04)   #MOD-6B0066
                  LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)   #MOD-6B0066
                  LET g_apa.apa31 = g_apa.apa31f * g_apa.apa14
                 #LET g_apa.apa31 = cl_digcut(g_apa.apa31,t_azi.azi04)   #MOD-6B0066
                  LET g_apa.apa31 = cl_digcut(g_apa.apa31,g_azi04)   #MOD-6B0066
                  LET g_apa.apa32 = g_apa.apa31 * g_apa.apa16 / 100
                  CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
                  LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
                 #LET g_apa.apa32 = cl_digcut(g_apa.apa32,t_azi.azi04)   #MOD-6B0066
                  LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)   #MOD-6B0066
                  DISPLAY BY NAME g_apa.apa31f,g_apa.apa32f,g_apa.apa31,g_apa.apa32     #No:8625
                  CALL t110_apa34f('0')   #TQC-750140
               END IF              
            END IF                           #MOD-970111  
            LET g_apa_t.apa16 = g_apa.apa16   #TQC-5B0016 #MOD-B50218 mod g_apa_o -> g_apa_t`
         END IF

       #-----No:MOD-530307-----
      BEFORE FIELD apa16
         CALL t110_set_entry(p_cmd)
       #-----No:MOD-530307 END-----

      AFTER FIELD apa16
         IF NOT cl_null(g_apa.apa16) THEN
         #No.TQC-9A0087 add --begin                                                         `                                        
            IF g_apa.apa16 < 0 THEN                                                                                                 
               CALL cl_err('','aec-020',0)                                                                                          
               NEXT FIELD apa16                                                                                                     
            END IF                                                                                                                  
         #No.TQC-9A0087 add --end
            IF g_apa.apa08 <> 'MISC'  THEN   #MOD-970111
               IF g_apa.apa16 != g_apa_t.apa16 AND g_apa.apa16 IS NOT NULL AND    #MOD-B50218 mod g_apa_o -> g_apa_t`
                  g_apa.apa31f >0 AND g_gec05 != 'T' AND g_gec05 != 'A' THEN  #NO.
                  LET g_apa.apa32f = g_apa.apa31f * g_apa.apa16 / 100
                  CALL t110_apa32f() RETURNING l_apa32f                   #No.MOD-B80140 add
                  LET g_apa.apa32f = l_apa32f                             #No.MOD-B80140 add
                 #LET g_apa.apa32f = cl_digcut(g_apa.apa32f,g_azi.azi04)   #MOD-6B0066
                  LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)   #MOD-6B0066
                  LET g_apa.apa31 = g_apa.apa31f * g_apa.apa14
                 #LET g_apa.apa31 = cl_digcut(g_apa.apa31,t_azi.azi04)   #MOD-6B0066
                  LET g_apa.apa31 = cl_digcut(g_apa.apa31,g_azi04)   #MOD-6B0066
                  LET g_apa.apa32 = g_apa.apa31 * g_apa.apa16 / 100
                  CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
                  LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
                 #LET g_apa.apa32 = cl_digcut(g_apa.apa32,t_azi.azi04)   #MOD-6B0066
                  LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)   #MOD-6B0066
                  DISPLAY BY NAME g_apa.apa31f,g_apa.apa32f,
                                  g_apa.apa31,g_apa.apa32     #No:8625
                  CALL t110_apa34f('0')    #TQC-750140
               END IF
            END IF                #MOD-970111
         END IF
         CALL t110_set_no_entry(p_cmd)   #No:MOD-530307

      AFTER FIELD apa21
         IF NOT cl_null(g_apa.apa21) THEN
           #IF g_apa_o.apa21 IS NULL OR g_apa.apa21 != g_apa_o.apa21 THEN         #MOD-B50218 mark
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa21 != g_apa_t.apa21) THEN #MOD-B50218
               CALL t110_apa21('a')
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa21,g_errno,0)
                  NEXT FIELD apa21
               END IF
            END IF
            LET g_apa_t.apa21 = g_apa.apa21  #MOD-B50218 mod g_apa_o -> g_apa_t
         END IF

      AFTER FIELD apa22
         IF NOT cl_null(g_apa.apa22) THEN
           #IF g_apa_o.apa22 IS NULL OR g_apa.apa22 != g_apa_o.apa22 THEN         #MOD-B50218 mark
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa22 != g_apa_t.apa22) THEN #MOD-B50218
               CALL t110_apa22('a')
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa22,g_errno,0)
                  NEXT FIELD apa22
               ELSE
                  LET g_apa.apa930=s_costcenter(g_apa.apa22)
                  DISPLAY BY NAME g_apa.apa930
                  DISPLAY s_costcenter_desc(g_apa.apa930) TO FORMONLY.gem02b               
               END IF
            END IF
            LET g_apa_t.apa22 = g_apa.apa22  #MOD-B50218 mod g_apa_o -> g_apa_t

           #FUN-8C0106---add---str---
           #防止User只修改部門欄位時,未再次檢查會科與允許/拒絕部門關係
           #apa51
            LET l_aag05=''   
            SELECT aag05 INTO l_aag05 
              FROM aag_file
             WHERE aag01 = g_apa.apa51
               AND aag00 = g_bookno1   
               AND aagacti = 'Y'                         #No.MOD-B70280 add

            LET g_errno = ' '  
            IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa51) THEN
              #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
               IF g_aaz.aaz90 !='Y' THEN
                  CALL s_chkdept(g_aaz.aaz72,g_apa.apa51,g_apa.apa22,g_bookno1)                
                                RETURNING g_errno
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,0)
                  NEXT FIELD apa22
               END IF
            END IF
           #apa52
            LET l_aag05=''   
            SELECT aag05 INTO l_aag05
              FROM aag_file
             WHERE aag01 = g_apa.apa52
               AND aag00 = g_bookno1   
               AND aagacti = 'Y'                         #No.MOD-B70280 add

            LET g_errno = ' '  
            IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa52) THEN
              #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
               IF g_aaz.aaz90 !='Y' THEN
                  CALL s_chkdept(g_aaz.aaz72,g_apa.apa52,g_apa.apa22,g_bookno1)                
                                RETURNING g_errno
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,0)
                  NEXT FIELD apa22
               END IF
            END IF
           #apa54
            LET l_aag05=''   
            SELECT aag05 INTO l_aag05
              FROM aag_file
             WHERE aag01 = g_apa.apa54
               AND aag00 = g_bookno1   
               AND aagacti = 'Y'                         #No.MOD-B70280 add

            LET g_errno = ' '  
            IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa54) THEN
              #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
               IF g_aaz.aaz90 !='Y' THEN
                  CALL s_chkdept(g_aaz.aaz72,g_apa.apa54,g_apa.apa22,g_bookno1)                
                                RETURNING g_errno
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,0)
                  NEXT FIELD apa22
               END IF
            END IF

           ###會科二###
            IF g_aza.aza63='Y' THEN 
              #apa511
               LET l_aag05=''   
               SELECT aag05 INTO l_aag05
                 FROM aag_file
                WHERE aag01 = g_apa.apa511
                  AND aag00 = g_bookno2   
                  AND aagacti = 'Y'                         #No.MOD-B70280 add
              
               LET g_errno = ' '  
               IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa511) THEN
                 #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                  IF g_aaz.aaz90 !='Y' THEN
                     CALL s_chkdept(g_aaz.aaz72,g_apa.apa511,g_apa.apa22,g_bookno2)                
                                   RETURNING g_errno
                  END IF
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err('',g_errno,0)
                     NEXT FIELD apa22
                  END IF
               END IF
              #apa521
               LET l_aag05=''   
               SELECT aag05 INTO l_aag05
                 FROM aag_file
                WHERE aag01 = g_apa.apa521
                  AND aag00 = g_bookno2   
                  AND aagacti = 'Y'                         #No.MOD-B70280 add             
 
               LET g_errno = ' '  
               IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa521) THEN
                 #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                  IF g_aaz.aaz90 !='Y' THEN
                     CALL s_chkdept(g_aaz.aaz72,g_apa.apa521,g_apa.apa22,g_bookno2)                
                                   RETURNING g_errno
                  END IF
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err('',g_errno,0)
                     NEXT FIELD apa22
                  END IF
               END IF
              #apa54
               LET l_aag05=''   
               SELECT aag05 INTO l_aag05
                 FROM aag_file
                WHERE aag01 = g_apa.apa541
                  AND aag00 = g_bookno2   
                  AND aagacti = 'Y'                         #No.MOD-B70280 add
                 
               LET g_errno = ' '  
               IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa541) THEN
                 #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                  IF g_aaz.aaz90 !='Y' THEN
                     CALL s_chkdept(g_aaz.aaz72,g_apa.apa541,g_apa.apa22,g_bookno2)                
                                   RETURNING g_errno
                  END IF
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err('',g_errno,0)
                     NEXT FIELD apa22
                  END IF
               END IF
            END IF  
           #FUN-8C0106---add---end---
         END IF

      AFTER FIELD apa36
         IF NOT cl_null(g_apa.apa36) THEN
            IF p_cmd = 'a' THEN
               CALL t110_apa36('a')
            ELSE
               CALL t110_apa36('u')
            END IF
            IF NOT cl_null(g_errno) THEN
               CALL cl_err(g_apa.apa36,g_errno,0)
               NEXT FIELD apa36
            END IF
           #------------------MOD-CA0147--------------(S)
            IF NOT cl_null(g_apa.apa51) THEN
               IF g_apa.apa00 = '15' AND g_apa.apa51 = 'STOCK' THEN
                  CALL cl_err(g_apa.apa36,'aap-182',0)
                  NEXT FIELD apa36
               END IF
            END IF
           #------------------MOD-CA0147--------------(E)
            LET g_apa_t.apa36 = g_apa.apa36  #MOD-B50218 mod g_apa_o -> g_apa_t
#MOD-5B0255
         ELSE
           CALL cl_err('apa36 is null: ','aap-099',0)
           NEXT FIELD apa36
#END MOD-5B0255
         END IF

      AFTER FIELD apa31f
        #LET g_apa.apa31f = cl_digcut(g_apa.apa31f,g_azi.azi04)   #No:MOD-530274   #MOD-6B0066
         LET g_apa.apa31f = cl_digcut(g_apa.apa31f,t_azi04)   #No:MOD-530274   #MOD-6B0066
         DISPLAY BY NAME g_apa.apa31f   #No:MOD-530247
         IF g_apa.apa08 != 'MISC' AND cl_null(g_apa.apa31f) THEN
            CALL cl_err('apa31f is null ','aap-099',0)
            NEXT FIELD apa31f
         END IF
         LET l_pmm40t_tot = 0        #MOD-A30059 add
        #-MOD-A90181-add-
         SELECT pmc913 INTO l_pmc913 FROM pmc_file 
          WHERE pmc01 = g_apa.apa05
        #-MOD-A90181-end-
        #str MOD-980032 add
        #IF g_aptype = '15' OR g_aptype = '17' THEN #MOD-990155
        #IF g_aptype = '15' THEN #MOD-990155                                                       #MOD-A90181       
         IF g_aptype = '15' AND (g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y')) THEN  #MOD-A90181
            DECLARE apb06_cs CURSOR FOR
               SELECT DISTINCT apb06 FROM apb_file WHERE apb01=g_apa.apa01
            FOREACH apb06_cs INTO l_apb06
               IF NOT cl_null(l_apb06) THEN #MOD-9A0109 
                 #已立預付原幣金額
                 #LET l_apa31f = 0   #MOD-A30059 mark
                  LET l_apa31f0= 0   #MOD-9B0048 add
               #str MOD-9B0048 mod
               #  SELECT SUM(apa31f) INTO l_apa31f FROM apb_file,apa_file
               #   WHERE apa01 =apb01
               #     AND apa00 ='15'
               #     AND apb06 =l_apb06
               #     AND apb01!=g_apa.apa01
                  DECLARE apa_cs0 CURSOR FOR
                     SELECT DISTINCT apb01 FROM apb_file
                      WHERE apb06 =l_apb06 
                        AND apb01!=g_apa.apa01
                  FOREACH apa_cs0 INTO l_apb01
                     LET l_apa31f0 = 0   #MOD-9C0145 add
                     SELECT apa31f INTO l_apa31f0 FROM apa_file
                      WHERE apa01 =l_apb01
                        AND apa00 ='15'
                     IF cl_null(l_apa31f0) THEN LET l_apa31f0 = 0 END IF
                     LET l_apa31f = l_apa31f + l_apa31f0
                  END FOREACH
               #end MOD-9B0048 mod
                  IF cl_null(l_apa31f) THEN LET l_apa31f = 0 END IF
                #str CHI-9C0015 mod
                # #採購單原幣未稅金額
                # LET l_pmm40 = 0
                # SELECT pmm40 INTO l_pmm40 FROM pmm_file
                #  WHERE pmm01=l_apb06
                # IF cl_null(l_pmm40) THEN LET l_pmm40 = 0 END IF
                # IF g_apa.apa31f > l_pmm40 - l_apa31f THEN
                  #採購單原幣含稅金額
                  LET l_pmm40t = 0
                  SELECT pmm40t INTO l_pmm40t FROM pmm_file
                   WHERE pmm01=l_apb06
                  IF cl_null(l_pmm40t) THEN LET l_pmm40t = 0 END IF
                  LET l_pmm40t_tot = l_pmm40t_tot + l_pmm40t          #MODA30059 add
              #MOD-A30059---mark---start---
              #   IF g_apa.apa31f > l_pmm40t - l_apa31f THEN
              # #end CHI-9C0015 mod
              #      CALL cl_err(g_apa.apa31f,'aap-937',0) 
              #      NEXT FIELD apa31f
              #   END IF
              #MOD-A30059---mark---end---
               END IF #MOD-9A0109
            END FOREACH
           #MOD-A30059---add---start---
            IF g_apa.apa31f > l_pmm40t_tot - l_apa31f THEN
               CALL cl_err(g_apa.apa31f,'aap-937',0) 
               NEXT FIELD apa31f
            END IF
           #MOD-A30059---add---end---
         END IF
        #end MOD-980032 add

        #IF g_apa.apa08 != 'MISC' OR g_apa.apa08 IS NULL THEN   #No.TQC-A30079
         IF g_apa.apa08 != 'MISC' OR g_apa.apa08 IS NULL OR
            g_apa.apa08 = 'MISC' AND g_apz.apz08 = '3'   THEN   #No.TQC-A30079
            IF g_apa.apa31f<>g_apa_t.apa31f OR cl_null(g_apa_t.apa31f) THEN
                #NO.MOD-530687-begin
#No.MOD-970065 --begin
               SELECT gec05 INTO g_gec05 FROM gec_file
                WHERE gec01=g_apa.apa15 AND gec011='1'
#No.MOD-970065 --end
               IF g_gec05 = 'T' OR g_gec05 = 'A' THEN     #FUN-630068
                  IF cl_null(l_apa31f_o) THEN
                     LET l_apa31f_o = 0
                  END IF
                  IF l_apa31f_o != g_apa.apa31f THEN
                     LET l_apa31f_t = g_apa.apa31f
                    #LET g_apa.apa31f = g_apa.apa31f * (1-g_apa.apa16/100)     #No.TQC-710097 mark
                    #LET g_apa.apa31f = g_apa.apa31f / (1+g_apa.apa16/100)     #No.TQC-710097 #TQC-960012 Mark
                     LET g_apa.apa31f = g_apa.apa31f * (1-g_apa.apa16/100)                    #TQC-960012 Add
                    #LET g_apa.apa31f = cl_digcut(g_apa.apa31f,g_azi.azi04)   #MOD-6B0066
                     LET g_apa.apa31f = cl_digcut(g_apa.apa31f,t_azi04)   #MOD-6B0066
                    #LET g_apa.apa32f = l_apa31f_t  * g_apa.apa16 / 100        #No.TQC-710097 mark
                    #LET g_apa.apa32f = g_apa.apa31f * g_apa.apa16 / 100       #No.TQC-710097 #TQC-960012 Mark  
                     LET g_apa.apa32f = l_apa31f_t  * g_apa.apa16 / 100                       #TQC-960012 Add
                     CALL t110_apa32f() RETURNING l_apa32f                   #No.MOD-B80140 add
                     LET g_apa.apa32f = l_apa32f                             #No.MOD-B80140 add
                    #LET g_apa.apa32f = cl_digcut(g_apa.apa32f,g_azi.azi04)   #MOD-6B0066
                     LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)   #MOD-6B0066
                     LET g_apa.apa31 = g_apa.apa31f * g_apa.apa14
                    #LET g_apa.apa31 = cl_digcut(g_apa.apa31,t_azi.azi04)   #MOD-6B0066
                     LET g_apa.apa31 = cl_digcut(g_apa.apa31,g_azi04)   #MOD-6B0066
                    #LET g_apa.apa32 = (l_apa31f_t*g_apa.apa14)*g_apa.apa16/100   #MOD-6C0178
                    #LET g_apa.apa32 = g_apa.apa31 * g_apa.apa16/100   #MOD-6C0178            #TQC-960012 Mark 
                     LET g_apa.apa32 = (l_apa31f_t*g_apa.apa14)*g_apa.apa16/100               #TQC-960012 Add
                     CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
                     LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add 
                    #LET g_apa.apa32 = cl_digcut(g_apa.apa32,t_azi.azi04)   #MOD-6B0066
                     LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)   #MOD-6B0066
                  END IF
               ELSE
                  LET g_apa.apa32f = g_apa.apa31f * g_apa.apa16 / 100
                  CALL t110_apa32f() RETURNING l_apa32f                   #No.MOD-B80140 add
                  LET g_apa.apa32f = l_apa32f                             #No.MOD-B80140 add
                 #LET g_apa.apa32f = cl_digcut(g_apa.apa32f,g_azi.azi04)   #MOD-6B0066
                  LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)   #MOD-6B0066
                  LET g_apa.apa31 = g_apa.apa31f * g_apa.apa14
                 #LET g_apa.apa31 = cl_digcut(g_apa.apa31,t_azi.azi04)   #MOD-6B0066
                  LET g_apa.apa31 = cl_digcut(g_apa.apa31,g_azi04)   #MOD-6B0066
                 #LET g_apa.apa32 = (g_apa.apa31f*g_apa.apa14)*g_apa.apa16/100  #No:MOD-530307   #MOD-6C0178
                  LET g_apa.apa32 = g_apa.apa31 * g_apa.apa16/100  #No:MOD-530307   #MOD-6C0178
                  CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
                  LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
                 #LET g_apa.apa32 = cl_digcut(g_apa.apa32,t_azi.azi04)          #No:MOD-530307   #MOD-6B0066
                  LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)          #No:MOD-530307   #MOD-6B0066
               END IF
               DISPLAY BY NAME g_apa.apa31f,g_apa.apa32f,g_apa.apa31,g_apa.apa32
               LET l_apa31f_o = g_apa.apa31f
               #end
               #No.TQC-740167 --start--
               IF g_apa.apa32f = 0 THEN
                  LET g_apa.apa52 = ''
                  DISPLAY BY NAME g_apa.apa52
               END IF
               IF g_apa.apa32 = 0 THEN
                  LET g_apa.apa521 = ''
                  DISPLAY BY NAME g_apa.apa521
               END IF
               #No.TQC-740617 --end--
               CALL t110_apa15('')     #TQC-A40058
               CALL t110_apa34f('0')   #TQC-750140
            END IF
         END IF

      AFTER FIELD apa31
        #LET g_apa.apa31 = cl_digcut(g_apa.apa31,t_azi.azi04)   #No:MOD-530274   #MOD-6B0066
         LET g_apa.apa31 = cl_digcut(g_apa.apa31,g_azi04)   #No:MOD-530274   #MOD-6B0066
         DISPLAY BY NAME g_apa.apa31   #No:MOD-530247
         IF g_apa.apa08 != 'MISC' AND cl_null(g_apa.apa31) THEN
            CALL cl_err('apa31 is null ','aap-099',0)
            NEXT FIELD apa31
         END IF
        #IF g_apa.apa08 != 'MISC' OR g_apa.apa08 IS NULL THEN  #No.TQC-A30079
         IF g_apa.apa08 != 'MISC' OR g_apa.apa08 IS NULL OR
            g_apa.apa08 = 'MISC' AND g_apz.apz08 = '3'   THEN  #No.TQC-A30079
            IF (g_apa.apa31 <>g_apa_t.apa31  OR cl_null(g_apa_t.apa31)) AND   #MOD-8A0177 mod
               g_gec05 != 'T' AND g_gec05 != 'A' THEN     #NO.MOD-530687 #FUN-
               LET g_apa.apa32 = g_apa.apa31 * g_apa.apa16 / 100
               CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
               LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
               #LET g_apa.apa32 = cl_digcut(g_apa.apa32,t_azi.azi04)   #MOD-6B0066
               LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)   #MOD-6B0066
               DISPLAY BY NAME g_apa.apa32
               CALL t110_apa34f('0')    #TQC-750140
            END IF
         END IF

      AFTER FIELD apa32f
        #LET g_apa.apa32f = cl_digcut(g_apa.apa32f,g_azi.azi04)   #No:MOD-530274   #MOD-6B0066
         LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)   #No:MOD-530274   #MOD-6B0066
         DISPLAY BY NAME g_apa.apa32f   #No:MOD-530247
         IF g_apa.apa08 != 'MISC' AND cl_null(g_apa.apa32f) THEN
            CALL cl_err('apa32f is null ','aap-099',0)
            NEXT FIELD apa32f
         END IF
         #no.6053 若為零稅率，稅額不可大於零
         IF g_apa.apa32f > 0 AND g_apa.apa16 = 0 THEN
            CALL cl_err('','aap-902',1)
            NEXT FIELD apa32f
         END IF
 #MOD-560240 稅額值=0時,將稅額會科清除
         IF g_apa.apa32f = 0 THEN
            LET g_apa.apa52 = ''
            DISPLAY BY NAME g_apa.apa52
         END IF
 #END MOD-560240
         #No.TQC-740167 --start--
         IF g_apa.apa32 = 0 THEN
            LET g_apa.apa521 = ''
            DISPLAY BY NAME g_apa.apa521
         END IF
         #No.TQC-740617 --end--
         CALL t110_apa15('')      #TQC-A40058
         CALL t110_apa34f('0')    #TQC-750140

          #MOD-4A0193
         IF g_apa.apa08 != 'MISC' OR g_apa.apa08 IS NULL THEN
            IF g_apa.apa32f<>g_apa_t.apa32f OR cl_null(g_apa_t.apa32f) THEN
               IF g_gec05 NOT MATCHES '[TA]'  THEN   #TQC-960012
                 #LET g_apa.apa32 = g_apa.apa32f * g_apa.apa14   #MOD-6C0178
                  LET g_apa.apa32 = g_apa.apa31 * g_apa.apa16/100   #MOD-6C0178
                  CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
                  LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
                 #LET g_apa.apa32 = cl_digcut(g_apa.apa32,t_azi.azi04)   #MOD-6B0066
                  LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)   #MOD-6B0066
                  DISPLAY BY NAME g_apa.apa32
               END IF   #TQC-960012
               CALL t110_apa34f('0')   #TQC-750140
               CALL t110_unpay()
            END IF
         END IF
#---------------------------------No.MOD-B80140--------------------------start
     #   LET l_apa32f = g_apa.apa31f * g_apa.apa16 / 100
     #  #LET l_apa32f = cl_digcut(l_apa32f,g_azi.azi04)   #MOD-6B0066
     #   LET l_apa32f = cl_digcut(l_apa32f,t_azi04)       #MOD-6B0066
     #  #str MOD-970278 add
     #  #從沖帳資料(aapq230)串回aapt150,看當初立預付是否有稅額,
     #  #若有的話,l_apa32f應再扣掉aapt150的稅額
     #   LET t_apa32f= 0
     #   SELECT SUM(apa32f) INTO t_apa32f
     #     FROM apa_file WHERE apa01 IN (
     #   SELECT apa08 FROM apv_file,apa_file
     #    WHERE apv01 = g_apa.apa01 AND apa01 = apv03)
     #   IF cl_null(t_apa32f) THEN LET t_apa32f= 0 END IF
     #   LET l_apa32f= l_apa32f- t_apa32f
     #   LET l_apa32f = cl_digcut(l_apa32f,t_azi04)
     #  #end MOD-970278 add
#MOD-5C0080
         CALL t110_apa32f() RETURNING l_apa32f                  

         SELECT COUNT(*) INTO l_cnt
           FROM apa_file WHERE apa01 IN (
         SELECT apa08 FROM apv_file,apa_file
          WHERE apv01 = g_apa.apa01 AND apa01 = apv03) 

         IF l_cnt > 0 THEN                                       
            LET t_apa31 = 0
            SELECT SUM(apa31f) INTO t_apa31f
              FROM apa_file WHERE apa01 IN (
            SELECT apa08 FROM apv_file,apa_file
             WHERE apv01 = g_apa.apa01 AND apa01 = apv03)
            IF cl_null(t_apa31f)  THEN LET t_apa31f = 0 END IF
            IF g_apa.apa31f >= t_apa31f THEN                    
#----------------------------------No.MOD-B80140---------------------------------end
               SELECT gec05 INTO g_gec05 FROM gec_file
                WHERE gec01=g_apa.apa15 AND gec011='1'
               IF cl_null(g_gec05) THEN LET g_gec05=' ' END IF   #MOD-8B0170 add
#END MOD-5C0080
               IF g_apa.apa32f <> l_apa32f AND g_gec05 <> 'T' AND g_gec05 <> 'A' THEN  #NO.MOD-530687 #FUN-630068
                  IF g_apa.apa32f < l_apa32f - 2 OR    #MOD-5C0080
                     g_apa.apa32f > l_apa32f + 2 THEN   #MOD-5C0080
                     CALL cl_err('','aap-210',0)
                     NEXT FIELD apa32f   #No:MOD-530274
                  END IF   #MOD-5C0080
               END IF
        #---------------------------No.MOD-B80140-----------------------start
            ELSE
                IF g_apa.apa32f != 0  AND g_gec05 <> 'T' AND g_gec05 <> 'A' THEN
                   CALL cl_err('','aap-210',0)
                   NEXT FIELD apa32f
                END IF
            END IF
        #---------------------------No.MOD-B80140-------------------------end
            LET g_apa_t.apa32f = g_apa.apa32f   #MOD-5C0080
         END IF                                                            #No.MOD-B80140 add

       #MOD-4A0193
      AFTER FIELD apa32
         #LET g_apa.apa32 = cl_digcut(g_apa.apa32,t_azi.azi04)   #No:MOD-530274   #MOD-6B0066
          LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)   #No:MOD-530274   #MOD-6B0066
          DISPLAY BY NAME g_apa.apa32   #No:MOD-530247
#--------------------------------No.MOD-B80140----------------------------start
      #   LET l_apa32 = g_apa.apa31 * g_apa.apa16 / 100
      #  #LET l_apa32 = cl_digcut(l_apa32,g_azi.azi04)   #MOD-6B0066
      #   LET l_apa32 = cl_digcut(l_apa32,g_azi04)       #MOD-6B0066
      #  #str MOD-970278 add
      #  #從沖帳資料(aapq230)串回aapt150,看當初立預付是否有稅額,
      #  #若有的話,l_apa32應再扣掉aapt150的稅額
      #   LET t_apa32 = 0
      #   SELECT SUM(apa32) INTO t_apa32
      #     FROM apa_file WHERE apa01 IN (
      #   SELECT apa08 FROM apv_file,apa_file
      #    WHERE apv01 = g_apa.apa01 AND apa01 = apv03)
      #   IF cl_null(t_apa32)  THEN LET t_apa32 = 0 END IF
      #   LET l_apa32 = l_apa32 - t_apa32
      #   LET l_apa32 = cl_digcut(l_apa32,g_azi04)
      #  #end MOD-970278 add
#MOD-5C0080
          CALL t110_apa32() RETURNING l_apa32
          SELECT COUNT(*) INTO l_cnt
            FROM apa_file WHERE apa01 IN (
          SELECT apa08 FROM apv_file,apa_file
           WHERE apv01 = g_apa.apa01 AND apa01 = apv03)
          IF l_cnt > 0 THEN                              #No.MOD-B80140 add
             LET t_apa31 = 0
             SELECT SUM(apa31) INTO t_apa31
               FROM apa_file WHERE apa01 IN (
             SELECT apa08 FROM apv_file,apa_file
              WHERE apv01 = g_apa.apa01 AND apa01 = apv03)
             IF cl_null(t_apa31)  THEN LET t_apa31 = 0 END IF
             IF g_apa.apa31 >= t_apa31  THEN             #No.MOD-B80140 add
#---------------------------------No.MOD-B80140-------------------------------end
                SELECT gec05 INTO g_gec05 FROM gec_file
                 WHERE gec01=g_apa.apa15 AND gec011='1'
                IF cl_null(g_gec05) THEN LET g_gec05=' ' END IF   #MOD-8B0170 add
#END MOD-5C0080
                IF g_apa.apa32 <> l_apa32 AND g_gec05 <> 'T' AND g_gec05 <> 'A' THEN #NO.MOD-530687 #FUN-630068
                   IF g_apa.apa32 < l_apa32 - 2 OR   #MOD-5C0080
                      g_apa.apa32 > l_apa32 + 2 THEN   #MOD-5C0080
                      CALL cl_err('','aap-210',0)
                      NEXT FIELD apa32
                   END IF        #MOD-5C0080
               END IF
         #---------------------------No.MOD-B80140-------------------------start
             ELSE
                IF g_apa.apa32 != 0 AND g_gec05 <> 'T' AND g_gec05 <> 'A' THEN
                   CALL cl_err('','aap-210',0)
                   NEXT FIELD apa32
                END IF
             END IF
          END IF
         #---------------------------No.MOD-B80140-------------------------end
          CALL t110_apa34f('0')    #TQC-750140
          CALL t110_unpay()
      #--

      AFTER FIELD apa51
        #start FUN-680110 add
         #IF (g_apa.apa00!='11' AND g_apa.apa00!='21') AND g_apa.apa51='UNAP' THEN   #MOD-7A0040
         IF (g_apa.apa00!='11' AND g_apa.apa00!='21' AND g_apa.apa00!='12') AND g_apa.apa51='UNAP' THEN   #MOD-7A0040
            #CALL cl_err_msg('','aap-923','aapt110,aapt210',1)   #非aapt110,aapt210此欄位不可輸入UNAP   #MOD-7A0040
            CALL cl_err_msg('','aap-934','aapt110,aapt210',1)   #非aapt110,aapt210此欄位不可輸入UNAP   #MOD-7A0040
            NEXT FIELD apa51
         END IF
        #end FUN-680110 add

        #---------------------------------MOD-BC0102--------------------------------add
         IF g_apa.apa00='15' AND g_apa.apa51 = 'MISC' THEN
            CALL cl_err('','aap-158',0)
            LET g_apa.apa51=g_apa_t.apa51
            DISPLAY BY NAME g_apa.apa51
            NEXT FIELD apa51
         END IF
        #---------------------------------MOD-BC0102--------------------------------end
        #------------------MOD-CA0147--------------(S)
         IF g_apa.apa00 = '15'AND g_apa.apa51 = 'STOCK' THEN
            CALL cl_err('','aap-182',0)
            LET g_apa.apa51 = g_apa_t.apa51
            DISPLAY BY NAME g_apa.apa51
            NEXT FIELD apa51
         END IF
        #------------------MOD-CA0147--------------(E)

         #No.FUN-690080 --Begin
         #報銷/還款時借方科目不可為'STOCK'
         IF (g_aptype = '13' OR g_aptype = '17') AND g_apa.apa51 = 'STOCK' THEN
            LET g_apa.apa51=g_apa_t.apa51
            DISPLAY BY NAME g_apa.apa51
            NEXT FIELD apa51
         END IF
         #No.FUN-690080 --End

         #No.B473 010516 by plum 沖暫估和W.直接付款只能擇其一
         IF g_apa.apa51 ='UNAP' AND g_apa.apa55='2' THEN
            CALL cl_err(g_apa.apa51,'aap-029',0)
            LET g_apa.apa51=g_apa_t.apa51
            DISPLAY BY NAME g_apa.apa51
            NEXT FIELD apa51
         END IF

         IF g_apa.apa51 != 'MISC' AND g_apa.apa51 != 'STOCK'
            AND g_apa.apa51 != 'UNAP' AND NOT cl_null(g_apa.apa51) THEN
            IF g_apa.apa31 >=0 AND g_apz.apz02 = 'Y' THEN     #No.TQC-7A0095 modify by chenl add '='
               CALL s_aapact(g_apz.apz11,g_bookno1,g_apa.apa51) RETURNING g_msg     #No.FUN-730064
               #No.FUN-690080 --Begin
               #不可取料件科目
               IF (g_aptype = '13' OR g_aptype = '17') AND cl_null(g_errno) THEN
                  SELECT aag09 INTO l_aag09
                    FROM aag_file
                   WHERE aag01 = g_apa.apa51
                     AND aag00 = g_bookno1         #No.FUN-730064
                     AND aagacti = 'Y'             #No.MOD-B70280 add
                  IF l_aag09 = 'N' THEN
                     CALL cl_err(g_apa.apa51,'agl-214',0)
                     NEXT FIELD apa51
                  END IF
               END IF
               #No.FUN-690080 --End
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('s_aapact',g_errno,0)
                  NEXT FIELD apa51
               END IF
            END IF
         END IF

         IF p_cmd='u' AND g_apa.apa51='MISC' AND
            (g_apa_t.apa51<>'MISC' OR g_apa_t.apa51 IS NULL) THEN
            CALL t110_ccc('1')
         END IF

         #No.B437 010427 by plum 改在修改後再call t110_ppp
          #-----No:MOD-530274-----
#MOD-580051   科目有做科目部門管理的才CALL s_chkdept
         
        #FUN-710078---mark---str---
        #SELECT aag02 INTO g_a51 FROM aag_file                 
        # WHERE aag01=g_apa.apa51                              
        #   AND aag00=g_bookno1                 #TQC-770056 add
        #DISPLAY g_a51 TO FORMONLY.a51          
        #FUN-710078---mark---end---

         SELECT aag05,aag02,aag21 INTO l_aag05,g_a51,l_aag21   #FUN-710078 add aag02,g_a51   #MOD-850100 add aag21 
           FROM aag_file
          WHERE aag01 = g_apa.apa51
            AND aag00 = g_bookno1     #No.FUN-730064
            AND aagacti = 'Y'         #No.MOD-B70280 add
#MOD-B80165 -- begin -- 
         IF cl_null(g_apa.apa51) THEN
            LET g_a51 = NULL
         END IF
#MOD-B80165 -- end --
         DISPLAY g_a51 TO FORMONLY.a51          #FUN-710078 add
         IF STATUS OR SQLCA.SQLCODE THEN
            LET l_aag05=''
         END IF
         LET g_errno = ' '   #MOD-5B0255
         IF l_aag05 = 'Y' THEN
           #str CHI-8C0005 mod
           #CALL s_chkdept(g_aaz.aaz72,g_apa.apa51,g_apa.apa22,g_bookno1) RETURNING g_errno      #No.FUN-730064
           #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
            IF g_aaz.aaz90 ='Y' THEN
               IF NOT cl_null(g_apa.apa930) THEN   #FUN-8C0106 add 
                  CALL s_chkdept(g_aaz.aaz72,g_apa.apa51,g_apa.apa930,g_bookno1) RETURNING g_errno      #No.FUN-730064
               END IF                              #FUN-8C0106 add 
            ELSE
               IF NOT cl_null(g_apa.apa22) THEN    #FUN-8C0106 add 
                  CALL s_chkdept(g_aaz.aaz72,g_apa.apa51,g_apa.apa22,g_bookno1) RETURNING g_errno      #No.FUN-730064
               END IF                              #FUN-8C0106 add 
            END IF
           #end CHI-8C0005 mod
         END IF
        #str MOD-850100 add
        #科目有做預算控管,須提示卡關請輸入在單身的訊息
         IF l_aag21 = 'Y' THEN       
            CALL cl_err('','aap-116',1)
         END IF
        #end MOD-850100 add
#         CALL s_chkdept(g_aaz.aaz72,g_apa.apa51,g_apa.apa22,g_bookno1) RETURNING g_errno      #No.FUN-730064
#END MOD-580051
         IF NOT cl_null(g_errno) THEN
            CALL cl_err('',g_errno,0)
            NEXT FIELD apa51
         END IF
          #-----No:MOD-530274 END-----

      #-----MOD-810244---------
      ##-----MOD-810050---------
      #ON CHANGE apa51
      #   LET l_cnt = 0 
      #   SELECT COUNT(*) INTO l_cnt FROM api_file
      #     WHERE api01 = g_apa.apa01 AND 
      #           api02 = '2'  
      #   IF (g_apa.apa51 <> 'UNAP' OR g_apa.apa51 IS NULL) AND l_cnt > 0 THEN 
      #      CALL cl_err('','aap-115',0)
      #      LET g_apa.apa51 = 'UNAP'
      #      NEXT FIELD apa51
      #   END IF
      ##-----END MOD-810050-----
      #-----END MOD-810244-----

      #-----MOD-810207---------
      ON CHANGE apa51
         LET l_cnt = 0
         SELECT COUNT(*) INTO l_cnt FROM api_file
           WHERE api01 = g_apa.apa01 AND
                 api02 = '1'
         IF (g_apa.apa51 <> 'MISC' OR g_apa.apa51 IS NULL) AND l_cnt > 0 THEN
            CALL cl_err('','aap-903',0)
            LET g_apa.apa51 = 'MISC'
            NEXT FIELD apa51
         END IF
      #-----END MOD-810207-----

      AFTER FIELD apa52
          #-----No:MOD-530274-----
         IF g_apa.apa16 > 0 THEN
            IF cl_null(g_apa.apa52) THEN
               CALL cl_err(g_apa.apa52,'aap-099',0)
               NEXT FIELD apa52
            END IF
         END IF
          #-----No:MOD-530274 END-----

         IF g_apa.apa32 > 0 AND g_apz.apz02 = 'Y' THEN
            CALL s_aapact(g_apz.apz11,g_bookno1,g_apa.apa52) RETURNING g_msg    #No.FUN-730064
            IF NOT cl_null(g_errno) THEN
               CALL cl_err(g_apa.apa52,g_errno,0)
               NEXT FIELD apa52
            END IF
         END IF

         IF NOT cl_null(g_apa.apa52)  THEN
            CALL s_aapact(g_apz.apz11,g_bookno1,g_apa.apa52) RETURNING g_msg     #No.FUN-730064
            IF NOT cl_null(g_errno) THEN
               CALL cl_err(g_apa.apa52,g_errno,0)
               NEXT FIELD apa52
            END IF
             #-----No:MOD-530274-----
#MOD-580051   科目有做科目部門管理的才CALL s_chkdept

            SELECT aag05,aag02 INTO l_aag05,g_a52 FROM aag_file   #FUN-710078 add aag02,g_a52
               WHERE aag01 = g_apa.apa52
                 AND aag00 = g_bookno1         #No.FUN-730064
                 AND aagacti = 'Y'             #No.MOD-B70280 add
            DISPLAY g_a52 TO FORMONLY.a52      #FUN-710078 add

            IF STATUS OR SQLCA.SQLCODE THEN
               LET l_aag05=''
            END IF
            LET g_errno = ' '   #MOD-5B0255
            IF l_aag05 = 'Y' THEN
              #str CHI-8C0005 mod
              #CALL s_chkdept(g_aaz.aaz72,g_apa.apa52,g_apa.apa22,g_bookno1) RETURNING g_errno      #No.FUN-730064
              #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
               IF g_aaz.aaz90 ='Y' THEN
                  IF NOT cl_null(g_apa.apa930) THEN   #FUN-8C0106 add 
                     CALL s_chkdept(g_aaz.aaz72,g_apa.apa52,g_apa.apa930,g_bookno1) RETURNING g_errno      #No.FUN-730064
                  END IF                              #FUN-8C0106 add 
               ELSE
                  IF NOT cl_null(g_apa.apa22) THEN    #FUN-8C0106 add 
                     CALL s_chkdept(g_aaz.aaz72,g_apa.apa52,g_apa.apa22,g_bookno1) RETURNING g_errno      #No.FUN-730064
                  END IF                              #FUN-8C0106 add 
               END IF
              #end CHI-8C0005 mod
            END IF
#            CALL s_chkdept(g_aaz.aaz72,g_apa.apa52,g_apa.apa22,g_bookno1) RETURNING g_errno   #No.FUN-730064
#END MOD-580051
            IF NOT cl_null(g_errno) THEN
               CALL cl_err('',g_errno,0)
               NEXT FIELD apa52
            END IF
             #-----No:MOD-530274 END-----
         END IF

        #FUN-710078---mark---str---
        #SELECT aag02 INTO g_a52 FROM aag_file   
        # WHERE aag01=g_apa.apa52                
        #   AND aag00=g_bookno1                  #TQC-770056 add
        #DISPLAY g_a52 TO FORMONLY.a52           
        #FUN-710078---mark---end---
 
      AFTER FIELD apa54
         IF NOT cl_null(g_apa.apa54) AND g_apz.apz02 = 'Y' THEN
            CALL s_aapact(g_apz.apz11,g_bookno1,g_apa.apa54) RETURNING g_msg    #No.FUN-730064
            IF NOT cl_null(g_errno) THEN
               CALL cl_err(g_apa.apa54,g_errno,0)
               NEXT FIELD apa54
            END IF
             #-----No:MOD-530274-----
#MOD-580051   科目有做科目部門管理的才CALL s_chkdept
            SELECT aag05 INTO l_aag05 FROM aag_file
               WHERE aag01 = g_apa.apa54
                 AND aag00 = g_bookno1    #No.FUN-730064
                 AND aagacti = 'Y'        #No.MOD-B70280 add
            IF STATUS OR SQLCA.SQLCODE THEN
               LET l_aag05=''
            END IF
            LET g_errno = ' '   #MOD-5B0255
            IF l_aag05 = 'Y' THEN
              #str CHI-8C0005 mod
              #CALL s_chkdept(g_aaz.aaz72,g_apa.apa54,g_apa.apa22,g_bookno1) RETURNING g_errno      #No.FUN-730064
              #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
               IF g_aaz.aaz90 ='Y' THEN
                  IF NOT cl_null(g_apa.apa930) THEN         #FUN-8C0106 add
                     CALL s_chkdept(g_aaz.aaz72,g_apa.apa54,g_apa.apa930,g_bookno1) RETURNING g_errno      #No.FUN-730064
                  END IF                                    #FUN-8C0106 add
               ELSE
                  IF NOT cl_null(g_apa.apa22) THEN          #FUN-8C0106 add
                     CALL s_chkdept(g_aaz.aaz72,g_apa.apa54,g_apa.apa22,g_bookno1) RETURNING g_errno      #No.FUN-730064
                  END IF                                    #FUN-8C0106 add
               END IF
              #end CHI-8C0005 mod
            END IF
#            CALL s_chkdept(g_aaz.aaz72,g_apa.apa54,g_apa.apa22,g_bookno1) RETURNING g_errno   #No.FUN-730064
#END MOD-580051
            IF NOT cl_null(g_errno) THEN
               CALL cl_err('',g_errno,0)
               NEXT FIELD apa54
            END IF
             #-----No:MOD-530274 END-----
            #No.TQC-770056--begin--
            SELECT aag02 INTO g_a54 FROM aag_file  
             WHERE aag01=g_apa.apa54              
               AND aag00=g_bookno1       
               AND aagacti = 'Y'                         #No.MOD-B70280 add        
            DISPLAY g_a54 TO FORMONLY.a54       
            #TQC-770056--end--
#MOD-B80165 -- begin --
         ELSE
            IF cl_null(g_apa.apa54) THEN
               LET g_a54 = NULL
            END IF
            DISPLAY g_a54 TO FORMONLY.a54
#MOD-B80165 -- end --
         END IF

#No.FUN-680029--begin
      AFTER FIELD apa511
         #No.B473 010516 by plum 沖暫估和W.直接付款只能擇其一
         IF g_apa.apa511 ='UNAP' AND g_apa.apa55='2' THEN
            CALL cl_err(g_apa.apa511,'aap-029',0)
            LET g_apa.apa511=g_apa_t.apa511
            DISPLAY BY NAME g_apa.apa511
            NEXT FIELD apa511
         END IF

         IF g_apa.apa511 != 'MISC' AND g_apa.apa511 != 'STOCK'
            AND g_apa.apa511 != 'UNAP' AND NOT cl_null(g_apa.apa511) THEN
            IF g_apa.apa31 >=0 AND g_apz.apz02 = 'Y' THEN    #No.TQC-7A0095 modify by chenl add '='
               CALL s_aapact(g_apz.apz11,g_bookno2,g_apa.apa511) RETURNING g_msg    #No.FUN-730064
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('s_aapact',g_errno,0)
                  NEXT FIELD apa511
               END IF
            END IF
         END IF

         IF p_cmd='u' AND g_apa.apa511='MISC' AND
            (g_apa_t.apa511<>'MISC' OR g_apa_t.apa511 IS NULL) THEN
            CALL t110_ccc('1')
         END IF

         #No.B437 010427 by plum 改在修改後再call t110_ppp
          #-----No:MOD-530274-----
#MOD-580051   科目有做科目部門管理的才CALL s_chkdept

#        SELECT aag05,aag02,aag21 INTO l_aag05,g_a51,l_aag21  #FUN-710078 add aag02,g_a51   #MOD-850100 add aag21 #TQC-960021 Mark
         SELECT aag05,aag02,aag21 INTO l_aag05,g_a511,l_aag21 #TQC-960021 
           FROM aag_file
          WHERE aag01 = g_apa.apa511
            AND aag00 = g_bookno2        #No.FUN-730064
            AND aagacti = 'Y'            #No.MOD-B70280 add
#MOD-B80165 -- begin --
         IF cl_null(g_apa.apa511) THEN
            LET g_a511 = NULL
         END IF
#MOD-B80165 -- end --
         DISPLAY g_a511 TO FORMONLY.a511   #FUN-710078 add        
         IF STATUS OR SQLCA.SQLCODE THEN
            LET l_aag05=''
         END IF
         LET g_errno = ' '   #MOD-5B0255
         IF l_aag05 = 'Y' THEN
           #str CHI-8C0005 mod
           #CALL s_chkdept(g_aaz.aaz72,g_apa.apa511,g_apa.apa22,g_bookno2) RETURNING g_errno      #No.FUN-730064
           #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
            IF g_aaz.aaz90 ='Y' THEN
               IF NOT cl_null(g_apa.apa930) THEN    #FUN-8C0106 add
                  CALL s_chkdept(g_aaz.aaz72,g_apa.apa511,g_apa.apa930,g_bookno2) RETURNING g_errno      #No.FUN-730064
               END IF                               #FUN-8C0106 add                   
            ELSE
               IF NOT cl_null(g_apa.apa22) THEN     #FUN-8C0106 add
                  CALL s_chkdept(g_aaz.aaz72,g_apa.apa511,g_apa.apa22,g_bookno2) RETURNING g_errno      #No.FUN-730064
               END IF                               #FUN-8C0106 add                   
            END IF
           #end CHI-8C0005 mod
         END IF
        #str MOD-850100 add
        #科目有做預算控管,須提示卡關請輸入在單身的訊息
         IF l_aag21 = 'Y' THEN       
            CALL cl_err('','aap-116',1)
         END IF
        #end MOD-850100 add
#         CALL s_chkdept(g_aaz.aaz72,g_apa.apa511,g_apa.apa22,g_bookno2) RETURNING g_errno    #No.FUN-730064
#END MOD-580051
         IF NOT cl_null(g_errno) THEN
            CALL cl_err('',g_errno,0)
            NEXT FIELD apa511
         END IF
          #-----No:MOD-530274 END-----

      #-----MOD-810244---------
      ##-----MOD-810050---------
      #ON CHANGE apa511
      #   LET l_cnt = 0 
      #   SELECT COUNT(*) INTO l_cnt FROM api_file
      #     WHERE api01 = g_apa.apa01 AND 
      #           api02 = '2'  
      #   IF (g_apa.apa511 <> 'UNAP' OR g_apa.apa511 IS NULL) AND l_cnt > 0 THEN 
      #      CALL cl_err('','aap-115',0)
      #      LET g_apa.apa511 = 'UNAP'
      #      NEXT FIELD apa511
      #   END IF
      ##-----END MOD-810050-----
      #-----END MOD-810244-----

      #-----MOD-810207---------
      ON CHANGE apa511
         LET l_cnt = 0
         SELECT COUNT(*) INTO l_cnt FROM api_file
           WHERE api01 = g_apa.apa01 AND
                 api02 = '1'
         IF (g_apa.apa511 <> 'MISC' OR g_apa.apa511 IS NULL) AND l_cnt > 0 THEN
            CALL cl_err('','aap-903',0)
            LET g_apa.apa511 = 'MISC'
            NEXT FIELD apa511
         END IF
      #-----END MOD-810207-----

      AFTER FIELD apa521
          #-----No:MOD-530274-----
         IF g_apa.apa16 > 0 THEN
            IF cl_null(g_apa.apa521) THEN
               CALL cl_err(g_apa.apa521,'aap-099',0)
               NEXT FIELD apa521
            END IF
         END IF
          #-----No:MOD-530274 END-----

         IF g_apa.apa32 > 0 AND g_apz.apz02 = 'Y' THEN
            CALL s_aapact(g_apz.apz11,g_bookno2,g_apa.apa521) RETURNING g_msg    #No.FUN-730064
            IF NOT cl_null(g_errno) THEN
               CALL cl_err(g_apa.apa521,g_errno,0)
               NEXT FIELD apa521
            END IF
         END IF

         IF NOT cl_null(g_apa.apa521)  THEN
            CALL s_aapact(g_apz.apz11,g_bookno2,g_apa.apa521) RETURNING g_msg    #No.FUN-730064
            IF NOT cl_null(g_errno) THEN
               CALL cl_err(g_apa.apa521,g_errno,0)
               NEXT FIELD apa521
            END IF
             #-----No:MOD-530274-----
#MOD-580051   科目有做科目部門管理的才CALL s_chkdept

            SELECT aag05,aag02 INTO l_aag05,g_a521 FROM aag_file  #FUN-710078 add aag02,g_521
               WHERE aag01 = g_apa.apa521
                 AND aag00 = g_bookno2              #No.FUN-730064
                 AND aagacti = 'Y'                  #No.MOD-B70280 add
            DISPLAY g_a521 TO FORMONLY.a521         #FUN-710078 add
            IF STATUS OR SQLCA.SQLCODE THEN
               LET l_aag05=''
            END IF
            LET g_errno = ' '   #MOD-5B0255
            IF l_aag05 = 'Y' THEN
              #str CHI-8C0005 mod
              #CALL s_chkdept(g_aaz.aaz72,g_apa.apa521,g_apa.apa22,g_bookno2) RETURNING g_errno      #No.FUN-730064
              #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
               IF g_aaz.aaz90 ='Y' THEN
                  IF NOT cl_null(g_apa.apa930) THEN     #FUN-8C0106 add
                     CALL s_chkdept(g_aaz.aaz72,g_apa.apa521,g_apa.apa930,g_bookno2) RETURNING g_errno      #No.FUN-730064
                  END IF                                #FUN-8C0106 add
               ELSE
                  IF NOT cl_null(g_apa.apa22) THEN      #FUN-8C0106 add
                     CALL s_chkdept(g_aaz.aaz72,g_apa.apa521,g_apa.apa22,g_bookno2) RETURNING g_errno      #No.FUN-730064
                  END IF                                #FUN-8C0106 add
               END IF
              #end CHI-8C0005 mod
            END IF
#            CALL s_chkdept(g_aaz.aaz72,g_apa.apa521,g_apa.apa22,g_bookno2) RETURNING g_errno    #No.FUN-730064
#END MOD-580051
            IF NOT cl_null(g_errno) THEN
               CALL cl_err('',g_errno,0)
               NEXT FIELD apa521
            END IF
             #-----No:MOD-530274 END-----
         END IF
 
      AFTER FIELD apa541
         IF NOT cl_null(g_apa.apa541) AND g_apz.apz02 = 'Y' THEN
            CALL s_aapact(g_apz.apz11,g_bookno2,g_apa.apa541) RETURNING g_msg    #No.FUN-730064
            IF NOT cl_null(g_errno) THEN
               CALL cl_err(g_apa.apa541,g_errno,0)
               NEXT FIELD apa541
            END IF
             #-----No:MOD-530274-----
#MOD-580051   科目有做科目部門管理的才CALL s_chkdept
            SELECT aag05,aag02 INTO l_aag05,g_a541 FROM aag_file  #FUN-710078 add aag02,g_a541
               WHERE aag01 = g_apa.apa541
                 AND aag00 = g_bookno2              #No.FUN-730064
                 AND aagacti = 'Y'                  #No.MOD-B70280 add
            DISPLAY g_a541 TO FORMONLY.a541         #FUN-710078 add
            IF STATUS OR SQLCA.SQLCODE THEN
               LET l_aag05=''
            END IF
            LET g_errno = ' '   #MOD-5B0255
            IF l_aag05 = 'Y' THEN
              #str CHI-8C0005 mod
              #CALL s_chkdept(g_aaz.aaz72,g_apa.apa541,g_apa.apa22,g_bookno2) RETURNING g_errno      #No.FUN-730064
              #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
               IF g_aaz.aaz90 ='Y' THEN
                  IF NOT cl_null(g_apa.apa930) THEN     #FUN-8C0106 add
                     CALL s_chkdept(g_aaz.aaz72,g_apa.apa541,g_apa.apa930,g_bookno2) RETURNING g_errno      #No.FUN-730064
                  END IF                               #FUN-8C0106 add
               ELSE
                  IF NOT cl_null(g_apa.apa22) THEN     #FUN-8C0106 add
                     CALL s_chkdept(g_aaz.aaz72,g_apa.apa541,g_apa.apa22,g_bookno2) RETURNING g_errno      #No.FUN-730064
                  END IF                               #FUN-8C0106 add
               END IF
              #end CHI-8C0005 mod
            END IF
#            CALL s_chkdept(g_aaz.aaz72,g_apa.apa541,g_apa.apa22,g_bookno2) RETURNING g_errno #No.FUN-730064
#END MOD-580051
            IF NOT cl_null(g_errno) THEN
               CALL cl_err('',g_errno,0)
               NEXT FIELD apa541
            END IF
             #-----No:MOD-530274 END-----
#MOD-B80165 -- begin --
         ELSE
            IF cl_null(g_apa.apa541) THEN
               LET g_a541 = NULL
            END IF
            DISPLAY g_a541 TO FORMONLY.a541
#MOD-B80165 -- end --
         END IF
#No.FUN-680029--end

      #No.FUN-690080 --Begin
      AFTER FIELD apa101       #還款銀行
         IF NOT cl_null(g_apa.apa101) THEN
           #IF g_apa_o.apa101 IS NULL OR g_apa.apa101 != g_apa_o.apa101 THEN        #MOD-B50218 mark
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa101 != g_apa_t.apa101) THEN #MOD-B50218
               CALL t110_apa101('a')
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa101,g_errno,0)
                  NEXT FIELD apa101
               END IF
            END IF
            LET g_apa_t.apa101 = g_apa.apa101 #MOD-B50218 mod g_apa_o -> g_apa_t
         END IF

      AFTER FIELD apa102       #還款異動碼
         IF NOT cl_null(g_apa.apa102) THEN
           #IF g_apa_o.apa102 IS NULL OR g_apa.apa102 != g_apa_o.apa102 THEN        #MOD-B50218 mark
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa102 != g_apa_t.apa102) THEN #MOD-B50218
               CALL t110_apa102('a')
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa102,g_errno,0)
                  NEXT FIELD apa102
               END IF
            END IF
            LET g_apa_t.apa102 = g_apa.apa102 #MOD-B50218 mod g_apa_o -> g_apa_t
         END IF
      #No.FUN-690080 --End

      AFTER FIELD apa58
         IF (g_aptype='21' AND g_apa.apa58 NOT MATCHES "[23]") OR
            (g_aptype='22' AND g_apa.apa58 NOT MATCHES "[3]") THEN
            CALL cl_err('','aap-315',0)
            NEXT FIELD apa58
         END IF
 
      AFTER FIELD apa66
         IF NOT cl_null(g_apa.apa66) AND g_aza.aza08='Y' THEN
            CALL t110_apa66()
            IF NOT cl_null(g_errno)  THEN
               CALL cl_err(g_apa.apa66,'apj-005',1)
               NEXT FIELD apa66
            END IF
         END IF

       #NO.MOD-530687-BEGIN
      BEFORE FIELD apa31f
         IF g_gec05 = 'T' OR g_gec05 = 'A' THEN     #FUN-630068
            CALL cl_err('','aoo-009',0)
         END IF
      #END

       #FUN-630043
       AFTER FIELD apa100
          SELECT azp02 INTO g_buf1 FROM azp_file  #FUN-C80078 g_buf-->g_buf1
             WHERE azp01=g_apa.apa100
          IF STATUS THEN
#            CALL cl_err('select azp','100',0)   #No.FUN-660122
             CALL cl_err3("sel","azp_file",g_apa.apa100,"","100","","select azp",1)  #No.FUN-660122
             NEXT FIELD apa100
          END IF
       #FUN-630043
      #FUN-670064...............begin
      AFTER FIELD apa930 
         IF NOT s_costcenter_chk(g_apa.apa930) THEN
            LET g_apa.apa930=NULL
            DISPLAY BY NAME g_apa.apa930
            DISPLAY NULL TO FORMONLY.gem02b
            NEXT FIELD apa930
         ELSE
            DISPLAY s_costcenter_desc(g_apa.apa930) TO FORMONLY.gem02b
         END IF

         #FUN-8C0106---add---str---
         #防止User只修改部門欄位時,未再次檢查會科與允許/拒絕部門關係
         #apa51
          LET l_aag05=''   
          SELECT aag05 INTO l_aag05
            FROM aag_file
           WHERE aag01 = g_apa.apa51
             AND aag00 = g_bookno1   
             AND aagacti = 'Y'                         #No.MOD-B70280 add

          LET g_errno = ' '  
          IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa51) THEN
            #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
             IF g_aaz.aaz90 ='Y' THEN
                CALL s_chkdept(g_aaz.aaz72,g_apa.apa51,g_apa.apa930,g_bookno1)                
                              RETURNING g_errno
             END IF
             IF NOT cl_null(g_errno) THEN
                CALL cl_err('',g_errno,0)
                NEXT FIELD apa930
             END IF
          END IF
         #apa52
          LET l_aag05=''   
          SELECT aag05 INTO l_aag05
            FROM aag_file
           WHERE aag01 = g_apa.apa52
             AND aag00 = g_bookno1  
             AND aagacti = 'Y'                         #No.MOD-B70280 add 

          LET g_errno = ' '  
          IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa52) THEN
            #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
             IF g_aaz.aaz90 ='Y' THEN
                CALL s_chkdept(g_aaz.aaz72,g_apa.apa52,g_apa.apa930,g_bookno1)                
                              RETURNING g_errno
             END IF
             IF NOT cl_null(g_errno) THEN
                CALL cl_err('',g_errno,0)
                NEXT FIELD apa930
             END IF
          END IF
         #apa54
          LET l_aag05=''   
          SELECT aag05 INTO l_aag05
            FROM aag_file
           WHERE aag01 = g_apa.apa54
             AND aag00 = g_bookno1  
             AND aagacti = 'Y'                         #No.MOD-B70280 add 

          LET g_errno = ' '  
          IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa54) THEN
            #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
             IF g_aaz.aaz90 ='Y' THEN
                CALL s_chkdept(g_aaz.aaz72,g_apa.apa54,g_apa.apa930,g_bookno1)                
                              RETURNING g_errno
             END IF
             IF NOT cl_null(g_errno) THEN
                CALL cl_err('',g_errno,0)
                NEXT FIELD apa930
             END IF
          END IF

         ###會科二###
          IF g_aza.aza63='Y' THEN 
            #apa511
             LET l_aag05=''   
             SELECT aag05 INTO l_aag05
               FROM aag_file
              WHERE aag01 = g_apa.apa511
                AND aag00 = g_bookno2   
                AND aagacti = 'Y'                         #No.MOD-B70280 add
            
             LET g_errno = ' '  
             IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa511) THEN
               #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                IF g_aaz.aaz90 ='Y' THEN
                   CALL s_chkdept(g_aaz.aaz72,g_apa.apa511,g_apa.apa930,g_bookno2)                
                                 RETURNING g_errno
                END IF
                IF NOT cl_null(g_errno) THEN
                   CALL cl_err('',g_errno,0)
                   NEXT FIELD apa930
                END IF
             END IF
            #apa521
             LET l_aag05=''   
             SELECT aag05 INTO l_aag05
               FROM aag_file
              WHERE aag01 = g_apa.apa521
                AND aag00 = g_bookno2  
                AND aagacti = 'Y'                         #No.MOD-B70280 add 
            
             LET g_errno = ' '  
             IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa521) THEN
               #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                IF g_aaz.aaz90 ='Y' THEN
                   CALL s_chkdept(g_aaz.aaz72,g_apa.apa521,g_apa.apa930,g_bookno2)                
                                 RETURNING g_errno
                END IF
                IF NOT cl_null(g_errno) THEN
                   CALL cl_err('',g_errno,0)
                   NEXT FIELD apa930
                END IF
             END IF
            #apa54
             LET l_aag05=''   
             SELECT aag05 INTO l_aag05
               FROM aag_file
              WHERE aag01 = g_apa.apa541
                AND aag00 = g_bookno2 
                AND aagacti = 'Y'                         #No.MOD-B70280 add  
            
             LET g_errno = ' '  
             IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa541) THEN
               #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                IF g_aaz.aaz90 ='Y' THEN
                   CALL s_chkdept(g_aaz.aaz72,g_apa.apa541,g_apa.apa930,g_bookno2)                
                                 RETURNING g_errno
                END IF
                IF NOT cl_null(g_errno) THEN
                   CALL cl_err('',g_errno,0)
                   NEXT FIELD apa930
                END IF
             END IF
          END IF  
         #FUN-8C0106---add-end---
      #FUN-670064...............end

      #FUN-850038     ---start---
      AFTER FIELD apaud01
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apaud02
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apaud03
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apaud04
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apaud05
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apaud06
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apaud07
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apaud08
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apaud09
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apaud10
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apaud11
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apaud12
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apaud13
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apaud14
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apaud15
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
      #FUN-850038     ----end----

      AFTER INPUT  #判斷必要欄位之值是否有值,若無則反白顯示,並要求重新輸入
         LET l_flag='N'
         IF INT_FLAG THEN
           #LET INT_FLAG = 0   #MOD-BB0099 add           #MOD-BC0140 mark
           #MOD-A50152---add---start---
            LET l_cnt = 0
            SELECT COUNT(*) INTO l_cnt FROM apk_file
             WHERE apk01 = g_apa.apa01
            IF g_apa_t.apa08 <> 'MISC' AND l_cnt > 1 THEN
              #-----------------MOD-BC0140-------------start
              #CALL cl_err('','aap-761',1)
              #LET g_apa.apa08 = 'MISC'
              #DISPLAY g_apa.apa08
              #NEXT FIELD apa08
               UPDATE apa_file SET apa08 = 'MISC'
                WHERE apa01 = g_apa.apa01
               LET g_apa_t.apa08 = 'MISC'
              #-----------------MOD-BC0140----------------end
            END IF
           #MOD-A50152---add---end
         #TQC-960424 MARK BEGIN---------------------------
         # #str MOD-960010 add
         #  SELECT DISTINCT(pmb02) INTO l_pmb02 FROM pmb_file
         #   WHERE pmb01 = g_apa.apa11
         #  IF l_pmb02 = 1 OR cl_null(l_pmb02) THEN
         #     IF p_cmd = 'u' THEN   #MOD-960119 add
         #        DELETE FROM apc_file WHERE apc01 = g_apa.apa01
         #        CALL t110_ins_apc(g_apa_t.*)
         #     END IF                #MOD-960119 add
         #  ELSE
         #     IF g_apa.apa35 <> g_apa_t.apa35 OR g_apa.apa35f <> g_apa_t.apa35f THEN
         #        LET g_sn = 'y'
         #     END IF
         #     CALL t110_account_period()
         #     LET g_sn = 'n'
         #  END IF
         # #end MOD-960010 add
         #TQC-960424 MARK END--------------------------------- 
            EXIT INPUT
         END IF

         IF g_apa.apa08 != 'MISC' AND NOT cl_null(g_apa.apa08) AND
            g_apa.apa08 != 'UNAP' AND
           ((g_apa_t.apa08 IS NOT NULL AND g_apa.apa08!=g_apa.apa01) OR
          #str MOD-890213 mod
          # (g_apa_t.apa08 IS NULL AND t110_chk(g_apa.apa08))) THEN
            (g_apa_t.apa08 IS NULL)) THEN
          #end MOD-890213 mod
           #str MOD-8A0213 add
            LET l_gec05 = ''
            SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01=g_apa.apa15
           #IF l_gec05 != 'X' THEN                   #No.MOD-B80015 mark
            IF l_gec05 NOT MATCHES '[4X]' THEN       #No.MOD-B80015 add
           #end MOD-8A0213 add
              #str MOD-890213 add
              #IF g_apa_t.apa08 IS NULL AND NOT t110_chk(g_apa.apa08) THEN     #MOD-A50180 mark
               IF NOT t110_chk(g_apa.apa08) THEN                               #MOD-A50180
                  CALL cl_err(g_apa.apa08,'sub-005',0)
                  NEXT FIELD apa08
               END IF
              #end MOD-890213 add
            END IF   #MOD-8A0213 add
            IF g_apa.apa02 != g_apa.apa09 THEN   #modi by canny(980714)
               LET l_amb01=YEAR(g_apa.apa09)
               LET l_amb02=MONTH(g_apa.apa09)
            ELSE
               LET l_amb01=YEAR(g_apa.apa02)
               LET l_amb02=MONTH(g_apa.apa02)
            END IF

            LET l_amb03=g_apa.apa08[1,2]
            LET g_msg = ""   #MOD-9C0356 add
            #CHI-930020--Begin
            SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01 = g_apa.apa15
            IF g_apz.apz07 = 'Y' AND (l_gec05 = '2' OR l_gec05 = '3') AND 
               g_aza.aza26!= '2' THEN   #MOD-9C0444 add
               CALL s_apkchk(l_amb01,l_amb02,l_amb03,g_apa.apa171)
                    RETURNING g_errno,g_msg
            END IF 
            #CHI-930020---End
            IF NOT cl_null(g_msg) THEN
               CALL cl_getmsg(g_msg,g_lang) RETURNING g_msg
               ERROR g_msg,' invoice =',g_apa.apa08,' SQLCODE=',g_errno
                IF cl_confirm('aap-766') THEN  #No.MOD-480431
                  IF NOT cl_null(g_errno) THEN
                     NEXT FIELD apa08
                  END IF
               END IF
            END IF
         END IF
#TQC-770027.....begin
         IF g_apa.apa31 <>g_apa_t.apa31 OR g_apa.apa32 <> g_apa_t.apa32
            OR g_apa.apa34 <> g_apa_t.apa34 OR g_apa.apa57 <> g_apa_t.apa57
            OR g_apa.apa57 <> g_apa_t.apa57 OR g_apa.apa73 <> g_apa_t.apa73
            OR g_apa.apa31f <> g_apa_t.apa31f OR g_apa.apa32f <> g_apa_t.apa32f
            OR g_apa.apa34f <> g_apa_t.apa34f OR g_apa.apa57f <> g_apa_t.apa57f THEN
           SELECT DISTINCT(pmb02) INTO l_pmb02 FROM pmb_file
            WHERE pmb01 = g_apa.apa11
           #IF l_pmb02 = 1 THEN   #MOD-810156
           IF l_pmb02 = 1 OR cl_null(l_pmb02) THEN   #MOD-810156
              DELETE FROM apc_file WHERE apc01 = g_apa.apa01
              CALL t110_ins_apc(g_apa.*)
           ELSE
              IF g_apa.apa35 <> g_apa_t.apa35 OR g_apa.apa35f <> g_apa_t.apa35f THEN
                 LET g_sn = 'y'
              END IF
              CALL t110_account_period()
              LET g_sn = 'n'
           END IF
          END IF
#TQC-770027.....end
         #str CHI-850025 add
         #當匯率為1時,需檢核原幣與本幣的稅額、金額需相同
         #IF g_apa.apa14 = 1 THEN                                 #MOD-880041 mark
          IF g_apa.apa14 = 1 AND g_aza.aza17 = g_apa.apa13 THEN   #MOD-880041
             IF g_apa.apa31f!=g_apa.apa31 OR g_apa.apa32f!=g_apa.apa32 OR
                g_apa.apa34f!=g_apa.apa34 THEN
                CALL cl_err('','apm-988',1)
                NEXT FIELD apa31f
             END IF
          END IF
         #end CHI-850025 add
         #-----MOD-810244---------
         ##-----MOD-810050---------
         #LET l_cnt = 0 
         #SELECT COUNT(*) INTO l_cnt FROM api_file
         #  WHERE api01 = g_apa.apa01 AND 
         #        api02 = '2'  
         #IF (g_apa.apa51 <> 'UNAP' OR g_apa.apa51 IS NULL OR 
         #    g_apa.apa511 <> 'UNAP' OR g_apa.apa511 IS NULL ) AND l_cnt > 0 THEN 
         #   CALL cl_err('','aap-115',0)
         #   LET g_apa.apa51 = 'UNAP'
         #   LET g_apa.apa511 = 'UNAP'
         #   DISPLAY BY NAME g_apa.apa51,g_apa.apa511
         #   NEXT FIELD apa51
         #END IF
         ##-----END MOD-810050-----
         #-----END MOD-810244-----

         #-----MOD-810207---------
         LET l_cnt = 0
         SELECT COUNT(*) INTO l_cnt FROM api_file
           WHERE api01 = g_apa.apa01 AND
                 api02 = '1'
        #MOD-9C0267---modify---start---
        #IF (g_apa.apa51 <> 'MISC' OR g_apa.apa51 IS NULL OR
        #    g_apa.apa511 <> 'MISC' OR g_apa.apa511 IS NULL ) AND l_cnt > 0 THEN
         IF (( g_apa.apa51 <>'MISC' OR g_apa.apa51 IS NULL) OR
             ((g_apa.apa511<>'MISC' OR g_apa.apa511 IS NULL) AND g_aza.aza63='Y'))
            AND l_cnt > 0 THEN
        #MOD-9C0267---modify---end---
            CALL cl_err('','aap-903',0)
            LET g_apa.apa51 = 'MISC'
            LET g_apa.apa511 = 'MISC'
            DISPLAY BY NAME g_apa.apa51,g_apa.apa511
            NEXT FIELD apa51
         END IF
         #-----END MOD-810207-----

      ON ACTION CONTROLP
         CASE
            WHEN INFIELD(apa01) #查詢單据
#No.FUN-550030--begin
               LET g_t1=s_get_doc_no(g_apa.apa01)
#No.FUN-550030--end
               #CALL q_apy(FALSE,FALSE,g_t1,g_aptype,g_sys) RETURNING g_t1  #TQC-670008
               CALL q_apy(FALSE,FALSE,g_t1,g_aptype,'AAP') RETURNING g_t1   #TQC-670008
               LET g_apa.apa01=g_t1            #No.FUN-550030
               DISPLAY BY NAME g_apa.apa01
               NEXT FIELD apa01
            WHEN INFIELD(apa05) #PAY TO VENDOR
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_pmc1"
               LET g_qryparam.default1 = g_apa.apa05
               CALL cl_create_qry() RETURNING g_apa.apa05
               DISPLAY BY NAME g_apa.apa05
               NEXT FIELD apa05
            WHEN INFIELD(apa06) #PAY TO VENDOR
               CALL cl_init_qry_var()
               #No.FUN-690080 --Begin
               IF g_aptype = '13' OR g_aptype = '17' OR g_aptype = '25' THEN
                  #LET g_qryparam.form ="q_cpf4"     #No:CHI-780046
                  LET g_qryparam.form ="q_gen"      #No:CHI-780046
               ELSE
           #       LET g_qryparam.form ="q_pmc1"  #MOD-960121
                   LET g_qryparam.form ="q_pmc"  #MOD-960121
               END IF
               #No.FUN-690080 --End
               LET g_qryparam.default1 = g_apa.apa06
               CALL cl_create_qry() RETURNING g_apa.apa06
               DISPLAY BY NAME g_apa.apa06
               CALL t110_apa06('d')
            WHEN INFIELD(apa11) # PAY TERM
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_pma"
               LET g_qryparam.default1 = g_apa.apa11
               CALL cl_create_qry() RETURNING g_apa.apa11
               DISPLAY BY NAME g_apa.apa11
            WHEN INFIELD(apa13) # CURRENCY
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_azi"
               LET g_qryparam.default1 = g_apa.apa13
               CALL cl_create_qry() RETURNING g_apa.apa13
               DISPLAY BY NAME g_apa.apa13
            WHEN INFIELD(apa15) # TAX CODE
               CALL cl_init_qry_var()
               IF g_prog = 'aapt160' THEN            #MOD-970220
                  LET g_qryparam.form = "q_gec7"     #MOD-970220
               ELSE                                  #MOD-970220
                  LET g_qryparam.form ="q_gec8"      #MOD-990132 q_gec-->q_gec8
               END IF                                #MOD-970220
               LET g_qryparam.default1 = g_apa.apa15
               LET g_qryparam.arg1 = '1'
              #No.TQC-930073--begin--
              #IF g_prog = 'aapt160' OR g_prog = 'aapt260' THEN #MOD-970220   
               IF g_prog = 'aapt260' THEN #MOD-970220  
                  LET g_qryparam.where = " gec05 = 'X' AND gec06 = '2' "  #No.MOD-940297 add gec06
               END IF
              #No.TQC-930073---end--- 
               CALL cl_create_qry() RETURNING g_apa.apa15
               DISPLAY BY NAME g_apa.apa15
            #FUN-970108--Begin
            WHEN INFIELD(apa77)
               CALL cl_init_qry_var()
               LET g_qryparam.form = "q_ama02"
               LET g_qryparam.default1 = g_apa.apa77
               CALL cl_create_qry() RETURNING g_apa.apa77
               DISPLAY BY NAME g_apa.apa77
            #FUN-970108---End
            WHEN INFIELD(apa19) # HOLD CODE
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_apo"
               LET g_qryparam.default1 = g_apa.apa19
               CALL cl_create_qry() RETURNING g_apa.apa19
               DISPLAY BY NAME g_apa.apa19
            WHEN INFIELD(apa07) # Employee CODE
              #CALL cl_init_qry_var()                       #MOD-CC0238 mark
              #LET g_qryparam.form ="q_gen"        #TQC-C70027  mark
              #LET g_qryparam.form ="q_apa11"               #TQC-C70027 add #MOD-CC0238 mark
              #LET g_qryparam.default1 = g_apa.apa07        #MOD-CC0238 mark
              #CALL cl_create_qry() RETURNING g_apa.apa07   #MOD-CC0238 mark
              #LET g_apa.apa07[2,9] = g_apa.apa07           #MOD-A60095 mark
              #LET g_apa.apa07[2,11] = g_apa.apa07         #MOD-A60095      #TQC-C70027  mark
              #LET g_apa.apa07[1,1] = '.'                  #TQC-C70027  mark   
              #------------MOD-CC0238------------(S)
               CALL cl_init_qry_var()
               IF g_aptype = '12' AND g_apa.apa06='MISC' THEN
                  LET g_qryparam.form ="q_pmc"
                 #LET g_qryparam.where=" pmc14='2'"        #CHI-D10057 mark
               ELSE
                  LET g_qryparam.form ="q_gen"
               END IF
               LET g_qryparam.default1 = g_apa.apa07
               CALL cl_create_qry() RETURNING g_apa.apa07
               LET g_apa.apa07[2,11] = g_apa.apa07
               LET g_apa.apa07[1,1] = '.'
              #------------MOD-CC0238------------(E)
               DISPLAY BY NAME g_apa.apa07
            WHEN INFIELD(apa21) # Employee CODE
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_gen"
               LET g_qryparam.default1 = g_apa.apa21
               CALL cl_create_qry() RETURNING g_apa.apa21
               DISPLAY BY NAME g_apa.apa21
            WHEN INFIELD(apa22) # Dept CODE
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_gem"
               LET g_qryparam.default1 = g_apa.apa22
               CALL cl_create_qry() RETURNING g_apa.apa22
               DISPLAY BY NAME g_apa.apa22
            WHEN INFIELD(apa36) # Class
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_apr"
               LET g_qryparam.default1 = g_apa.apa36
               CALL cl_create_qry() RETURNING g_apa.apa36
               DISPLAY BY NAME g_apa.apa36
            WHEN INFIELD(apa51) # Account number
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"   #TQC-790133
               LET g_qryparam.default1 = g_apa.apa51
               LET g_qryparam.arg1 = g_bookno1    #No.FUN-730064
               CALL cl_create_qry() RETURNING g_apa.apa51
               DISPLAY BY NAME g_apa.apa51
            WHEN INFIELD(apa52) # Account number
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"   #TQC-790133
               LET g_qryparam.default1 = g_apa.apa52
               LET g_qryparam.arg1 = g_bookno1      #No.FUN-730064
               CALL cl_create_qry() RETURNING g_apa.apa52
               DISPLAY BY NAME g_apa.apa52
            WHEN INFIELD(apa54) # Account number
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"   #TQC-790133
               LET g_qryparam.default1 = g_apa.apa54
               LET g_qryparam.arg1 = g_bookno1      #No.FUN-730064
               CALL cl_create_qry() RETURNING g_apa.apa54
               DISPLAY BY NAME g_apa.apa54
#No.FUN-680029--begin
            WHEN INFIELD(apa511) # Account number
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"   #TQC-790133
               LET g_qryparam.default1 = g_apa.apa511
               LET g_qryparam.arg1 = g_bookno2     #No.FUN-730064
               CALL cl_create_qry() RETURNING g_apa.apa511
               DISPLAY BY NAME g_apa.apa511
            WHEN INFIELD(apa521) # Account number
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"   #TQC-790133
               LET g_qryparam.default1 = g_apa.apa521
               LET g_qryparam.arg1 = g_bookno2     #No.FUN-730064
               CALL cl_create_qry() RETURNING g_apa.apa521
               DISPLAY BY NAME g_apa.apa521
            WHEN INFIELD(apa541) # Account number
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"   #TQC-790133
               LET g_qryparam.default1 = g_apa.apa541
               LET g_qryparam.arg1 = g_bookno2       #No.FUN-730064
               CALL cl_create_qry() RETURNING g_apa.apa541
               DISPLAY BY NAME g_apa.apa541
#No.FUN-680029--end
            #No.FUN-690080 --Begin
            WHEN INFIELD(apa101)   #還款銀行
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_nma"
         #No.TQC-6C0074--begin
               IF g_aptype='13' THEN
                  LET g_qryparam.where ="nma28 !=1 and nma37 !=0 and nma10='",g_apa.apa13,"'" 
               END IF
         #No.TQC-6C0074--end
               CALL cl_create_qry() RETURNING g_apa.apa101
               DISPLAY BY NAME g_apa.apa101
            WHEN INFIELD(apa102)   #還款異動碼
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_nmc"
         #No.TQC-6C0074--begin
               IF g_aptype='13' THEN
                  LET g_qryparam.where =" nmc03=1"
               END IF
         #No.TQC-6C0074--end
               LET g_qryparam.default1 = g_apa.apa102
               CALL cl_create_qry() RETURNING g_apa.apa102
               DISPLAY BY NAME g_apa.apa102
            #No.FUN-690080 --End
            WHEN INFIELD(apa66) #專案代號
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_pja"
               LET g_qryparam.default1 = g_apa.apa66
               CALL cl_create_qry() RETURNING g_apa.apa66
               DISPLAY BY NAME g_apa.apa66
             #FUN-4B0054
             WHEN INFIELD(apa14)
                CALL s_rate(g_apa.apa13,g_apa.apa14) RETURNING g_apa.apa14
                DISPLAY BY NAME g_apa.apa14
                NEXT FIELD apa14
             #--
              #FUN-630043
               WHEN INFIELD(apa100)
                    CALL cl_init_qry_var()
                    LET g_qryparam.form = "q_azp"
                    LET g_qryparam.default1 = g_apa.apa100
                    CALL cl_create_qry() RETURNING g_apa.apa100
                    DISPLAY BY NAME g_apa.apa100
                    NEXT FIELD apa100
              #FUN-630043
               #FUN-670064...............begin
               WHEN INFIELD(apa930)
                  CALL cl_init_qry_var()
                  LET g_qryparam.form ="q_gem4"
                  CALL cl_create_qry() RETURNING g_apa.apa930
                  DISPLAY BY NAME g_apa.apa930
                  NEXT FIELD apa930
               #FUN-670064...............end
            OTHERWISE EXIT CASE
         END CASE

      #--FUN-D30066 add start--
      ON ACTION undoapprove
         CALL t110_undoapprove()

      ON ACTION mod_account
         CALL t110_modaccount()
      #--FUN-D30066 add end--


       #MOD-440608
      ON ACTION mul_invoice
         IF g_apa.apa08='MISC' THEN
            IF p_cmd != 'a' THEN
               CALL t110_ddd('1')   #MOD-950112 add參數
               DISPLAY BY NAME g_apa.apa07      #TQC-630164  
               CALL t110_show_multi_invoice()   #No.TQC-A30076
            END IF
         END IF

      ON ACTION single_invoice
         #單一發票且使用稅控系統, 發票資料來自單身
         IF g_apa.apa08 !='MISC' AND g_aza.aza26 != '2' THEN
            CALL t110_apa17('a')
            DISPLAY BY NAME g_apa.apa07   #TQC-630164 
            DISPLAY BY NAME g_apa.apa24,g_apa.apa12,g_apa.apa64  #MOD-9C0148 add
         END IF

      ON ACTION maintain_misc_vender
         CALL cl_cmdrun('aapi600')

      ON ACTION mul_debit
         IF g_apa.apa51='MISC' OR g_apa.apa511 ='MISC' THEN    #No.FUN-680029
            CALL t110_ccc('1')
         #No.TQC-A30133  --Begin
         ELSE
            CALL cl_err(g_apa.apa51,'aap-704',0)
         #No.TQC-A30133  --End  
         END IF

      ON ACTION contra_tmp_est
        #IF g_apa.apa51='UNAP' THEN   #No.TQC-7B0083
            CALL t110_ppp('2')
        #END IF                       #No.TQC-7B0083

       #MOD-540018
      #ON ACTION entry_detail
      #      CALL t110_apa54()
      #--

      ON ACTION controlf                  #欄位說明
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name #Add on 040913
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang) #Add on 040913


      #-----FUN-630081---------
      #ON ACTION controlo                        # 沿用所有欄位
      #   IF INFIELD(apa01) THEN
      #      LET g_apa.* = g_apa_t.*
      #      LET g_apa.apa65f= 0
      #      LET g_apa.apa65 = 0
      #      LET g_apa.apa35f= 0
      #      LET g_apa.apa35 = 0
      #      LET g_apa.apa41 = 'N'
      #      LET g_apa.apa44 = NULL
      #      LET g_apa.apainpd = g_today
      #      LET g_apa.apauser = g_user
      #      LET g_apa.apamodu = NULL
      #      LET g_apa.apadate = NULL
      #      LET g_apa.apasseq = 0
      #      CALL t110_show()
      #      NEXT FIELD apa01
      #   END IF
      #-----END FUN-630081-----

      ON ACTION CONTROLZ
         CALL cl_show_req_fields()

      ON ACTION controlg
         CALL cl_cmdask()

      ON IDLE g_idle_seconds   #TQC-860021
         CALL cl_on_idle()     #TQC-860021
         CONTINUE INPUT        #TQC-860021

      ON ACTION about          #TQC-860021
         CALL cl_about()       #TQC-860021

      ON ACTION help           #TQC-860021
         CALL cl_show_help()   #TQC-860021
   END INPUT

END FUNCTION

FUNCTION t110_chk(p_apa08)
   DEFINE p_apa08 LIKE apa_file.apa08
   DEFINE l_gec05 LIKE gec_file.gec05  #CHI-930020
   DEFINE l_gec08 LIKE gec_file.gec08  #FUN-G10012 add   

   #大陸版發票輸入時不需檢查字軌
   IF g_aza.aza26 = '2' THEN RETURN 1 END IF  #MOD-9C0444 add

   #CHI-930020---Begin
   IF g_apz.apz07 = 'N' THEN RETURN 1 END IF   #發票輸入時檢查字軌  #MOD-980141 mod
   #發票為2/3聯時檢查
  #SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01 = g_apa.apa15   #FUN-G10012 mark
  #--FUN-G10012 add start--
   SELECT gec05,gec08 INTO l_gec05,l_gec08
     FROM gec_file 
    WHERE gec01 = g_apa.apa15
  #--FUN-G10012 add end-- 
  #IF (l_gec05 !='2' OR l_gec05 !='3') THEN     #MOD-A50180 mark
   IF (l_gec05 !='2' AND l_gec05 !='3') THEN    #MOD-A50180
      RETURN 1   #MOD-980141 mod
   END IF
   #CHI-930020---End

   #--FUN-G10012 add start--
   IF l_gec08 = '25' AND p_apa08[1,2] = 'BB' THEN
      RETURN 1
   END IF 
   #--FUN-G10012 add end--
   
   #台灣版才做下面的檢查
   IF g_aza.aza26 = '0' THEN   #MOD-890213 add
      IF g_apa.apa171!=28 AND g_apa.apa171!=29 THEN   #MOD-B40115 add
         IF p_apa08[1,1] MATCHES '[A-Z]' AND p_apa08[2,2] MATCHES '[A-Z]' AND
            p_apa08[3,3] MATCHES '[0-9]' AND p_apa08[4,4] MATCHES '[0-9]' AND
            p_apa08[5,5] MATCHES '[0-9]' AND p_apa08[6,6] MATCHES '[0-9]' AND
            p_apa08[7,7] MATCHES '[0-9]' AND p_apa08[8,8] MATCHES '[0-9]' AND
            p_apa08[9,9] MATCHES '[0-9]' AND p_apa08[10,10] MATCHES '[0-9]' THEN
            RETURN 1
         ELSE
            RETURN 0
         END IF
     #str MOD-B40115 add
      ELSE
         RETURN 1
      END IF
     #end MOD-B40115 add
  #str MOD-890213 add
   ELSE
      RETURN 1
   END IF
  #end MOD-890213 add

END FUNCTION

FUNCTION t110_apa66()
   #DEFINE l_gjaacti   LIKE gja_file.gjaacti #FUN-810045
   DEFINE l_pjaacti   LIKE pja_file.pjaacti  #FUN-810045 gjaacti->pjaacti

   LET g_errno=''
   #SELECT gjaacti INTO l_gjaacti FROM gja_file WHERE gja01=g_apa.apa66  #FUN-810045
   SELECT pjaacti INTO l_pjaacti FROM pja_file WHERE pja01=g_apa.apa66   #FUN-810045

   CASE
      WHEN SQLCA.SQLCODE = 100
         LET g_errno = 'apj-005'
      #WHEN l_gjaacti = 'N'
      WHEN l_pjaacti = 'N'
         LET g_errno = '9028'
      WHEN SQLCA.SQLCODE != 0
         LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE
 
END FUNCTION

FUNCTION t110_apa05(p_cmd)
   DEFINE p_cmd     LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_pmc03   LIKE pmc_file.pmc03
   DEFINE l_pmc04   LIKE pmc_file.pmc04
   DEFINE l_pmc05   LIKE pmc_file.pmc05
   DEFINE l_pmcacti LIKE pmc_file.pmcacti
   DEFINE l_pmc24   LIKE pmc_file.pmc24

   SELECT pmc03,pmc04,pmc05,pmcacti,pmc24
     INTO l_pmc03,l_pmc04,l_pmc05,l_pmcacti,l_pmc24
     FROM pmc_file WHERE pmc01 = g_apa.apa05

   LET g_errno = ' '

   CASE
      WHEN l_pmcacti = 'N'            LET g_errno = '9028'
      WHEN l_pmcacti MATCHES '[PH]'   LET g_errno = '9038'    #No.FUN-690024
     
     #No.FUN-690025-------str-------
     #WHEN l_pmc05   = '1'            LET g_errno = '1'       
     #WHEN l_pmc05   = '2'            LET g_errno = 'aap-033' 
     #WHEN l_pmc05   = '0'            LET g_errno = '1'         #MOD-950045      
      WHEN l_pmc05   = '0'            LET g_errno = 'aap-032'   #MOD-950045         
      WHEN l_pmc05   = '3'            LET g_errno = 'aap-033' 
     #No.FUN-690025-------end-------
 
       WHEN STATUS=100 LET g_errno = '100'  #MOD-4B0124
      WHEN SQLCA.SQLCODE != 0
         LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE

   DISPLAY l_pmc03 TO pmc03

   IF NOT cl_null(g_errno) THEN
      RETURN
   END IF

   IF p_cmd='d' THEN
      RETURN
   END IF

   LET g_apa.apa06 = l_pmc04
   LET g_apa.apa18 = l_pmc24
   DISPLAY BY NAME g_apa.apa06

END FUNCTION

FUNCTION t110_apa06(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_pmc03 LIKE pmc_file.pmc03
   DEFINE l_pmc04   LIKE pmc_file.pmc04
   DEFINE l_pmc05   LIKE pmc_file.pmc05
   DEFINE l_pmc17   LIKE pmc_file.pmc17
   DEFINE l_pmc22   LIKE pmc_file.pmc22
   DEFINE l_pmc24   LIKE pmc_file.pmc24
   DEFINE l_pmc26   LIKE pmc_file.pmc26
   DEFINE l_pmc47   LIKE pmc_file.pmc47
   DEFINE l_pmc54   LIKE pmc_file.pmc54
   DEFINE l_pmcacti LIKE pmc_file.pmcacti

   LET l_pmc03 = ''

   SELECT pmc03,pmc04,pmc05,pmc17,pmc22,pmc24,pmc26,pmc47,pmc54,pmcacti
     INTO l_pmc03,l_pmc04,l_pmc05,l_pmc17,l_pmc22,l_pmc24,
          l_pmc26,l_pmc47,l_pmc54,l_pmcacti
     FROM pmc_file
    WHERE pmc01 = g_apa.apa06

   LET g_errno = ' '

   CASE
      WHEN SQLCA.SQLCODE = 100        LET g_errno = 'aap-031'
      WHEN l_pmcacti = 'N'            LET g_errno = '9028' 
      WHEN l_pmcacti MATCHES '[PH]'   LET g_errno = '9038'       #FUN-690024 

     #No.FUN-690025----str-----
     #WHEN l_pmc05   = '1'            LET g_errno = 'aap-032' 
     #WHEN l_pmc05   = '2'            LET g_errno = 'aap-033'
      WHEN l_pmc05   = '0'            LET g_errno = 'aap-032'
      WHEN l_pmc05   = '3'            LET g_errno = 'aap-033'
     #No.FUN-690025----end----
      WHEN SQLCA.SQLCODE != 0
         LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE
 
   IF NOT cl_null(g_errno) THEN
      RETURN
   END IF

   IF p_cmd = 'd' THEN
      RETURN
   END IF

   LET g_apa.apa07 = l_pmc03

   #IF g_aptype[1,1] = '1' THEN   #MOD-7B0101
   IF g_aptype[1,1] = '1' OR g_aptype='21' OR g_aptype='22' OR g_aptype='26' THEN   #MOD-7B0101
      LET g_apa.apa11 = l_pmc17
   END IF

   LET g_apa.apa15 = l_pmc47
   LET g_apa_o.apa15 = NULL   #MOD-AA0105 

   SELECT gec04 INTO g_apa.apa16 FROM gec_file WHERE gec01=g_apa.apa15 AND gec011='1'  #No:8511 加上gec011

   LET g_apa.apa13 = l_pmc22

   CALL t110_apa13(p_cmd)   #MOD-7C0203 
   DISPLAY BY NAME g_apa.apa07,g_apa.apa11,g_apa.apa13,
                   g_apa.apa15,g_apa.apa16,g_apa.apa13  

END FUNCTION

#FUNCTION t110_invoice_chk(p_no)   #MOD-770138
#FUNCTION t110_invoice_chk(p_no,p_tax)   #MOD-770138
#FUNCTION t110_invoice_chk(p_no,p_tax,p_date)    #CHI-820005 #No.TQC-CB0066   Mark
FUNCTION t110_invoice_chk(p_no,p_tax,p_date,p_code)          #No.TQC-CB0066   Add
   DEFINE p_no      LIKE apk_file.apk03 #No:7127
   DEFINE p_tax     LIKE gec_file.gec01 #MOD-770138
   DEFINE l_gec08   LIKE gec_file.gec08 #MOD-770138
   DEFINE l_gec05   LIKE gec_file.gec05 #No:MOD-510036
   DEFINE l_n1,l_n2 LIKE type_file.num5,    #No.FUN-690028 SMALLINT
          l_idx     LIKE type_file.num5     # No:FUN-690028 SMALLINT
         ,l_year    LIKE type_file.num5     #CHI-820005   Add
   DEFINE p_date    LIKE apa_file.apa09     #CHI-820005 add
   DEFINE p_code    LIKE apa_file.apa46     #No.TQC-CB0066   Add

   LET g_errno = ''
   LET l_year = YEAR(p_date) USING '&&&&'    #CHI-820005   Add

   IF p_no IS NULL THEN                 
      LET g_errno = 'aap-099'
      RETURN
   END IF
  #-MOD-AA0035-add-
   IF g_apa.apa08 != 'MISC' AND g_apa.apa08 != 'UNAP' THEN
      SELECT gec05,gec08 INTO l_gec05,l_gec08 FROM gec_file
       WHERE gec01 = g_apa.apa15 AND gec011 = '1'
      IF status THEN LET l_gec05='' LET l_gec08='' END IF
   ELSE
      SELECT gec05,gec08 INTO l_gec05,l_gec08 FROM gec_file
       WHERE gec01 = p_tax AND gec011 = '1'
      IF status THEN LET l_gec05='' LET l_gec08='' END IF
   END IF
   IF l_gec08 = 'XX' THEN RETURN END IF
   IF l_gec08 = '22' THEN RETURN END IF   #MOD-870022 add
   IF l_gec05='2' OR l_gec05='3' THEN
      FOR l_idx = 3 TO 10
         IF cl_null(p_no[l_idx,l_idx]) THEN
            LET g_errno='aap-760'
            EXIT FOR
         END IF
      END FOR
   END IF
  #-MOD-AA0035-end-
   #-----CHI-7A0024---------
   IF g_aza.aza26 = '1' THEN 
      SELECT COUNT(*) INTO l_n1 FROM apa_file WHERE apa08 = p_no  
             AND apa05 = g_apa.apa05                      
             AND YEAR(apa09) = l_year  #CHI-820005
      SELECT COUNT(*) INTO l_n2 FROM apk_file,apa_file WHERE apk03 = p_no
              AND apk171 !='23' AND apk171 != '24'  
              AND apk01 = apa01 AND apa05 = g_apa.apa05     
              AND YEAR(apk05) = l_year                         #CHI-820005   Add
   ELSE
   #-----END CHI-7A0024-----
      SELECT COUNT(*) INTO l_n1 FROM apa_file WHERE apa08 = p_no
         AND YEAR(apa09) = l_year  #CHI-820005
             AND apk28 = p_code        #No.TQC-CB0066   Add
      SELECT COUNT(*) INTO l_n2 FROM apk_file WHERE apk03 = p_no
              AND apk171 !='23' AND apk171 != '24'   #MOD-660111
              AND YEAR(apk05) = l_year                         #CHI-820005   Add
             AND apk28 = p_code        #No.TQC-CB0066   Add
   END IF   #CHI-7A0024

   IF (l_n1+l_n2) > 0 THEN
      LET g_errno = 'aap-034'
      RETURN
   END IF

   #MOD-490326
   IF g_apz.apz07 != 'Y' THEN
      RETURN
   END IF
   #--

   #-----MOD-770138---------
  #-MOD-AA0035-mark-
  #IF g_apa.apa08 != 'MISC' AND g_apa.apa08 != 'UNAP' THEN
  #   SELECT gec05,gec08 INTO l_gec05,l_gec08 FROM gec_file
  #    WHERE gec01 = g_apa.apa15
  #   IF status THEN LET l_gec05='' LET l_gec08='' END IF
  #ELSE
  #   SELECT gec05,gec08 INTO l_gec05,l_gec08 FROM gec_file
  #    WHERE gec01 = p_tax
  #   IF status THEN LET l_gec05='' LET l_gec08='' END IF
  #END IF
  #IF l_gec08 = 'XX' THEN RETURN END IF
  #IF l_gec08 = '22' THEN RETURN END IF   #MOD-870022 add
  #IF l_gec05='2' OR l_gec05='3' THEN
  #   FOR l_idx = 3 TO 10
  #      IF cl_null(p_no[l_idx,l_idx]) THEN
  #         LET g_errno='aap-760'
  #         EXIT FOR
  #      END IF
  #   END FOR
  #END IF
  #-MOD-AA0035-end-

   ##No:MOD-510036 add
   #SELECT gec05 INTO l_gec05 FROM gec_file
   # WHERE gec01 = g_apa.apa15
   #IF status THEN LET l_gec05='' END IF
   #IF l_gec05='2' OR l_gec05='3' THEN
   #   FOR l_idx = 3 TO 10
   #      IF cl_null(p_no[l_idx,l_idx]) THEN
   #         LET g_errno='aap-760'
   #         EXIT FOR
   #      END IF
   #   END FOR
   #END IF
   #-----END MOD-770138-----

   RETURN

END FUNCTION

FUNCTION t110_apa13(p_cmd)
   DEFINE p_cmd     LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_aziacti LIKE azi_file.aziacti  #MOD-6B0066
   DEFINE l_apb23   LIKE apb_file.apb23,   #MOD-790042
          l_apb24   LIKE apb_file.apb24,   #MOD-860221 add
          l_apb09   LIKE apb_file.apb09,   #MOD-790042
          l_apb02   LIKE apb_file.apb02,   #MOD-790042
          l_apb08   LIKE apb_file.apb08,   #MOD-790042
          l_apb081  LIKE apb_file.apb081,  #MOD-790042
          l_apb10   LIKE apb_file.apb10,   #MOD-790042
          l_apb101  LIKE apb_file.apb101,  #MOD-790042
          l_apa32   LIKE apa_file.apa32    #No.MOD-B80140 add

#  SELECT * INTO g_azi.* FROM azi_file WHERE azi01 = g_apa.apa13   #MOD-6B0066
   SELECT azi03,azi04,azi07,aziacti INTO t_azi03,t_azi04,t_azi07,l_aziacti  #MOD-6B0066
     FROM azi_file  WHERE azi01 = g_apa.apa13  #MOD-6B0066

   LET g_errno = ' '

   CASE
      WHEN SQLCA.SQLCODE = 100
         LET g_errno = 'aap-002'
      #WHEN g_azi.aziacti = 'N'   #MOD-6B0066
      WHEN l_aziacti = 'N'   #MOD-6B0066
         LET g_errno = '9028'
      WHEN SQLCA.SQLCODE != 0
         LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE

  #CALL s_curr3(g_apa.apa13,g_apa.apa02,'S') RETURNING g_apa.apa14 #FUN-640022
   CALL s_curr3(g_apa.apa13,g_apa.apa02,g_apz.apz33) RETURNING g_apa.apa14 #FUN-640022

   DISPLAY BY NAME g_apa.apa14

   #-----MOD-790042---------
   IF g_apa.apa13 =g_aza.aza17 THEN
      LET g_apa.apa14=1
      DISPLAY BY NAME g_apa.apa14
   END IF
  #LET g_apa.apa14 = cl_digcut(g_apa.apa14,t_azi07)    #MOD-990058 mark 
   DISPLAY BY NAME g_apa.apa14   
   IF g_apa.apa14 <> g_apa_o.apa14 THEN                           
      SELECT COUNT(*) INTO g_cnt FROM apb_file
       WHERE apb01=g_apa.apa01
      IF g_cnt > 0 THEN
         IF NOT cl_confirm('aap-331') THEN
            CALL cl_err('','aap-888',1)
            LET g_apa.apa14 = g_apa_t.apa14
            DISPLAY BY NAME g_apa.apa14
         END IF
         DECLARE upd_apb_cs3 CURSOR FOR
            SELECT apb23,apb09,apb02,apb24   #MOD-860221 add apb24
              FROM apb_file
             WHERE apb01=g_apa.apa01
 
        #FOREACH upd_apb_cs INTO l_apb23,l_apb09,l_apb02,l_apb24   #MOD-860221 add l_apb24    #MOD-A40184 mark
         FOREACH upd_apb_cs3 INTO l_apb23,l_apb09,l_apb02,l_apb24   #MOD-860221 add l_apb24   #MOD-A40184 add
            LET l_apb08 = l_apb23 * g_apa.apa14
            LET l_apb08 = cl_digcut(l_apb08,g_azi03)   
           #LET l_apb10 = l_apb09 * l_apb08       #MOD-860221 mark
            LET l_apb10 = l_apb24 * g_apa.apa14   #MOD-860221
            LET l_apb10 = cl_digcut(l_apb10,g_azi04)   
            LET l_apb081= l_apb08
            LET l_apb101= l_apb10

            UPDATE apb_file SET apb08 = l_apb08,
                                apb081 = l_apb081,
                                apb10  = l_apb10,
                                apb101 = l_apb101
             WHERE apb01 = g_apa.apa01
               AND apb02 = l_apb02
            IF STATUS OR SQLCA.SQLCODE THEN
               CALL cl_err3("upd","apb_file",g_apa.apa11,l_apb02,SQLCA.sqlcode,"","upd apb:",1)
               LET g_apa.apa14 = g_apa_t.apa14
               DISPLAY BY NAME g_apa.apa14
               EXIT FOREACH
            END IF
         END FOREACH
         CALL t110_b_fill(' 1=1')
         CALL t110_sum_apa()
      ELSE
         #雜項帳款有可能沒有單身資料
         IF g_apa.apa00='12' OR g_apa.apa00='15' OR g_apa.apa00='16' OR  #MOD-910181 add 16
            g_apa.apa00='21' OR g_apa.apa00='13' OR g_apa.apa00='17' OR    
            g_apa.apa00='22' THEN   #MOD-9B0168 add
            LET g_apa.apa31 = g_apa.apa31f * g_apa.apa14
            LET g_apa.apa31 = cl_digcut(g_apa.apa31,g_azi04)   
            LET g_apa.apa32 = g_apa.apa31 * g_apa.apa16 / 100
            CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
            LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
            LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)  
            DISPLAY BY NAME g_apa.apa31
            DISPLAY BY NAME g_apa.apa32
            CALL t110_apa34f('0')  
            CALL t110_unpay()
         END IF
      END IF
   END IF
   #-----END MOD-790042-----
END FUNCTION

FUNCTION t110_apa15(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_gec03   LIKE gec_file.gec03
   DEFINE l_gec031  LIKE gec_file.gec031          #No.FUN-680029
   DEFINE l_gec04   LIKE gec_file.gec04
   DEFINE l_gec06   LIKE gec_file.gec06
   DEFINE l_gec08   LIKE gec_file.gec08
   DEFINE l_gecacti LIKE gec_file.gecacti

    #NO.MOD-530687--begin
   SELECT gec03,gec031,gec04,gec05,gec06,gec08,gecacti    #No.FUN-680029
     INTO l_gec03,l_gec031,l_gec04,g_gec05,l_gec06,l_gec08,l_gecacti    #No.FUN-680029
          FROM gec_file WHERE gec01 = g_apa.apa15
                          AND gec011='1'  #進項
   #end

   LET g_errno = ' '
   CASE WHEN SQLCA.SQLCODE = 100 LET g_errno = 'mfg3044'
        WHEN l_gecacti = 'N'     LET g_errno = '9028'
        WHEN SQLCA.SQLCODE != 0  LET g_errno = SQLCA.SQLCODE USING '-----'
       #No.MOD-940297--begin-- 
        OTHERWISE 
          IF (g_prog = 'aapt160' OR g_prog = 'aapt260') AND p_cmd='a' THEN
            #MOD-970220   ---start      
            #IF l_gec06 != '2' THEN 
            #   LET g_errno = 'aap-985'
            #END IF
             CASE
                WHEN l_gec06 !='2'       LET g_errno = 'aap-985' 
                WHEN g_gec05   !='X' OR                                                                                      
                     cl_null(g_gec05)    LET g_errno = 'aap-977'   
                WHEN l_gec08   !='XX'    LET g_errno = 'aap-008'         
             END CASE
            #MOD-970220   ---end
          END IF 
       #No.MOD-940297---end--- 
   END CASE

   IF NOT cl_null(g_errno) THEN
      RETURN
   END IF

   LET g_apa.apa16 = l_gec04
   LET g_apa.apa52 = l_gec03
   LET g_apa.apa521= l_gec031    #No.FUN-680029
   LET g_apa.apa171 = l_gec08
   LET g_apa.apa172 = l_gec06
   DISPLAY BY NAME g_apa.apa16,g_apa.apa52,g_apa.apa521     #TQC-A40058

   IF p_cmd = 'd' THEN
      RETURN
   END IF

   DISPLAY BY NAME g_apa.apa52

END FUNCTION

FUNCTION t110_input_apl(p_no)
   #DEFINE p_no  VARCHAR(10)            #FUN-660117 remark
   DEFINE p_no  LIKE apl_file.apl01  #FUN-660117
   DEFINE l_apl RECORD LIKE apl_file.*

   IF cl_null(p_no) THEN
      RETURN
   END IF

   LET g_errno=' '
   SELECT * INTO l_apl.* FROM apl_file WHERE apl01 = p_no
   LET l_apl.apl01 = p_no

   IF l_apl.apl02 IS NULL THEN
      LET l_apl.apl02 = g_apa.apa07
   END IF
 
   OPEN WINDOW t110_apl WITH FORM "aap/42f/aapt110_b"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
   CALL cl_ui_locale("aapt110_b")

   CALL cl_set_head_visible("","YES")            #No.FUN-6B0033

   INPUT BY NAME l_apl.apl01,l_apl.apl02,l_apl.apl03 WITHOUT DEFAULTS
      ON ACTION controlg       #TQC-860021
         CALL cl_cmdask()      #TQC-860021

      ON IDLE g_idle_seconds   #TQC-860021
         CALL cl_on_idle()     #TQC-860021
         CONTINUE INPUT        #TQC-860021

      ON ACTION about          #TQC-860021
         CALL cl_about()       #TQC-860021

      ON ACTION help           #TQC-860021
         CALL cl_show_help()   #TQC-860021
   END INPUT                   #TQC-860021

   CLOSE WINDOW t110_apl

   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF

   SELECT count(*) INTO g_cnt FROM apl_file WHERE apl01 = p_no

   IF g_cnt > 0 THEN
      UPDATE apl_file SET * = l_apl.* WHERE apl01 = p_no
      IF STATUS OR SQLCA.SQLCODE THEN
#        CALL cl_err('upd apl:',SQLCA.SQLCODE,1)   #No.FUN-660122
         CALL cl_err3("upd","apl_file",p_no,"",SQLCA.sqlcode,"","upd apl:",1)  #No.FUN-660122
      END IF
#      LET g_apa.apa07 = l_apl.apl02   #TQC-630164         #MOD-940223
#      UPDATE apa_file SET apa07 = l_apl.apl02 WHERE apa01 = g_apa.apa01   #TQC-630164 #MOD-940223
   ELSE
      INSERT INTO apl_file VALUES (l_apl.*)
      IF STATUS OR SQLCA.SQLCODE THEN
#        CALL cl_err('ins apl:',SQLCA.SQLCODE,1)   #No.FUN-660122
         CALL cl_err3("ins","apl_file",l_apl.apl01,"",SQLCA.sqlcode,"","ins apl:",1)  #No.FUN-660122
      END IF
#      LET g_apa.apa07 = l_apl.apl02   #TQC-630164    #MOD-940223
#      UPDATE apa_file SET apa07 = l_apl.apl02 WHERE apa01 = g_apa.apa01   #TQC-630164   #MOD-940223
   END IF

END FUNCTION

FUNCTION t110_unhold()

   IF g_apa.apa01 IS NULL THEN
      RETURN
   END IF

   SELECT * INTO g_apa.* FROM apa_file
    WHERE apa01=g_apa.apa01

   IF g_apa.apa42 = 'Y' THEN
      CALL cl_err('apa42=Y ','aap-165',0)
      RETURN
   END IF

   IF g_apa.apa74 = 'Y' THEN
      CALL cl_err('apa74=Y ','aap-334',0)
      RETURN
   END IF

   LET g_apa.apa19 = NULL
   LET g_apa.apa20 = 0

   UPDATE apa_file SET apa19 = g_apa.apa19,
                       apa20 = g_apa.apa20
    WHERE apa01 = g_apa.apa01

   #-----MOD-730098---------
   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
      CALL cl_err3("upd","apa_file",g_apa.apa01,"",STATUS,"","upd apa:",1)
      RETURN
   END IF
   #-----END MOD-730098-----

   LET g_apa_t.apa19 = g_apa.apa19
   LET g_apa_t.apa20 = g_apa.apa20
   DISPLAY '','','0' TO apa19,apo02,apa20
   UPDATE apc_file SET apc16 =0 WHERE apc01 = g_apa.apa01  #No.FUN-680027

   LET g_msg = TIME
#  INSERT INTO azo_file (azo01,azo02,azo03,azo03,azo04,azo05,azo06)   #MOD-590460
   INSERT INTO azo_file (azo01,azo02,azo03,azo04,azo05,azo06)   #MOD-590460
                 #VALUES('aapt110',g_user,g_today,g_msg,g_apa.apa01,'unhold') #MOD-AC0328 mark
                  VALUES(g_prog,g_user,g_today,g_msg,g_apa.apa01,'unhold')    #MOD-AC0328 

END FUNCTION

FUNCTION t110_hold()
DEFINE l_apa20      LIKE apa_file.apa20           #No.FUN-680027
DEFINE l_apc16      LIKE apc_file.apc16           #No.FUN-680027
DEFINE l_apc02      LIKE apc_file.apc02           #No.FUN-680027
DEFINE l_apc08      LIKE apc_file.apc08           #No.FUN-680027
DEFINE l_apc10      LIKE apc_file.apc10           #No.FUN-680027
DEFINE l_pmb05      LIKE pmb_file.pmb05           #No.FUN-680027
DEFINE l_hold_amt   LIKE apa_file.apa20           #No.MOD-780152
DEFINE apc16_tot    LIKE apc_file.apc16           #No.MOD-A30208 add
DEFINE l_flag       LIKE type_file.chr1           #MOD-AA0187

   SELECT * INTO g_apa.* FROM apa_file
    WHERE apa01=g_apa.apa01

   IF g_apa.apa42 = 'Y' THEN
      CALL cl_err('apa42=Y ','aap-165',0)
      RETURN
   END IF

   IF g_apa.apa74 = 'Y' THEN
      CALL cl_err('apa74=Y ','aap-334',0)
      RETURN
   END IF

   IF g_apa.apa01 IS NULL THEN
      RETURN
   END IF

   #No.MOD-5B0053  --begin
   IF g_apz.apz27 = 'N' THEN
      IF g_apa.apa34-g_apa.apa35=0 AND g_apa.apa34f-g_apa.apa35f=0 THEN
         RETURN
      END IF
   ELSE
      IF g_apa.apa73 = 0 AND g_apa.apa34f-g_apa.apa35f=0 THEN
         RETURN
      END IF
   END IF
   #No.MOD-5B0053 --end
#No.MOD-780152 --begin 
   WHILE TRUE
      LET INT_FLAG = 0  
      CALL cl_getmsg('aap-780',g_lang) RETURNING g_msg
      PROMPT g_msg CLIPPED FOR g_chr
         ON IDLE g_idle_seconds  #TQC-860021
            CALL cl_on_idle()    #TQC-860021

         ON ACTION about         #TQC-860021
            CALL cl_about()      #TQC-860021

         ON ACTION help          #TQC-860021
            CALL cl_show_help()  #TQC-860021

         ON ACTION controlg      #TQC-860021
            CALL cl_cmdask()     #TQC-860021
      END PROMPT                 #TQC-860021
      CALL cl_set_comp_entry("apa20",TRUE)   #TQC-7A0041
      CASE
         WHEN g_chr = '1'
            EXIT WHILE
         WHEN g_chr = '2'
            LET g_hold ='2'
            CALL t110_account_period()
            LET g_hold ='1'
            LET l_hold_amt =0
            SELECT SUM(apc16) INTO l_hold_amt FROM apc_file
             WHERE apc01 =g_apa.apa01
            UPDATE apa_file SET apa20 =l_hold_amt
             WHERE apa01 =g_apa.apa01
            DISPLAY BY NAME g_apa.apa20
            CALL cl_set_comp_entry("apa20",FALSE)
            EXIT WHILE
         WHEN g_chr = '3'
            RETURN
         OTHERWISE #MOD-990200
             RETURN #MOD-990200
      END CASE

      EXIT WHILE
   END WHILE
#No.MOD-780152 --end
#MOD-970213   ---START
   IF INT_FLAG THEN
      LET INT_FLAG = 0 RETURN
   END IF 
#MOD-970213   ---END
   WHILE TRUE
      CALL cl_set_head_visible("","YES")     #No.FUN-6B0033
      
      INPUT BY NAME g_apa.apa19,g_apa.apa20 WITHOUT DEFAULTS
      
         AFTER FIELD apa19
            IF NOT cl_null(g_apa.apa19) THEN
               CALL t110_apa19('a')
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa19,g_errno,0)
                  NEXT FIELD apa19
               END IF
            END IF
      
         AFTER FIELD apa20
            IF NOT cl_null(g_apa.apa20) THEN
               IF g_apa.apa20 > (g_apa.apa34f - g_apa.apa35f) THEN
                  CALL cl_err(g_apa.apa20,'aap-150',0)
                  NEXT FIELD apa20
               END IF
               #-----TQC-780065---------
               SELECT azi04 INTO t_azi04 FROM azi_file 
                 WHERE azi01 = g_apa.apa13
               LET g_apa.apa20 = cl_digcut(g_apa.apa20,t_azi04)
               DISPLAY BY NAME g_apa.apa20
               #-----END TQC-780065-----
            END IF
      
         ON ACTION CONTROLP
            CASE
               WHEN INFIELD(apa19) # Hold code
#               CALL q_apo(0,0,g_apa.apa19) RETURNING g_apa.apa19
                CALL cl_init_qry_var()
                LET g_qryparam.form ="q_apo"
                LET g_qryparam.default1 = g_apa.apa19
                CALL cl_create_qry() RETURNING g_apa.apa19
#                CALL FGL_DIALOG_SETBUFFER( g_apa.apa19 )
                  DISPLAY BY NAME g_apa.apa01
                  NEXT FIELD apa19
            END CASE
      
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE INPUT
      
         ON ACTION about         #MOD-4C0121
            CALL cl_about()      #MOD-4C0121
      
         ON ACTION help          #MOD-4C0121
            CALL cl_show_help()  #MOD-4C0121
      
         ON ACTION controlg      #MOD-4C0121
            CALL cl_cmdask()     #MOD-4C0121
      
      END INPUT
      
       #MOD-480608
      IF INT_FLAG THEN
         LET INT_FLAG = 0
         LET g_apa.apa19 = g_apa_t.apa19
         DISPLAY BY NAME g_apa.apa19
         LET g_apa.apa20 = g_apa_t.apa20
         DISPLAY BY NAME g_apa.apa20
         RETURN
      END IF
      #--
      
      IF cl_null(g_apa.apa19) THEN
         CALL cl_err('','aap-099',1) CONTINUE WHILE
      ELSE EXIT WHILE
      END IF
   END WHILE

   LET g_apa_t.apa19 = g_apa.apa19
   LET g_apa_t.apa20 = g_apa.apa20

   UPDATE apa_file SET apa19=g_apa.apa19,apa20 = g_apa.apa20
    WHERE apa01 = g_apa.apa01

   #-----MOD-730098---------
   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
      CALL cl_err3("upd","apa_file",g_apa.apa01,"",STATUS,"","upd apa:",1)
      RETURN
   END IF
   #-----END MOD-730098-----

#No.FUN-680027--begin
   LET l_flag = 'N'            #MOD-AA0187
  #MOD-A30208---add---start---
  #若單頭留置與子帳期留置不相同，將子帳期留置歸零重新計算
   SELECT SUM(apc16) INTO apc16_tot FROM apc_file where apc01 = g_apa.apa01
   IF g_apa.apa20 != apc16_tot THEN
      UPDATE apc_file SET apc16=0 WHERE apc01 = g_apa.apa01
      LET l_flag = 'Y'            #MOD-AA0187
   END IF
   IF l_flag = 'Y' THEN           #MOD-AA0187
     #MOD-A30208---add---end---
      DECLARE t110_apc_hold_cs CURSOR FOR
        SELECT apc02,apc08,apc10,apc16 FROM apc_file WHERE apc01 =g_apa.apa01 ORDER BY apc02
      LET l_apa20 =g_apa.apa20
      FOREACH t110_apc_hold_cs INTO l_apc02,l_apc08,l_apc10,l_apc16
       #MOD-A30208---mark---start-
        #不管apc16有沒有值，一律重新計算
       #IF NOT cl_null(l_apc16) AND l_apc16 !=0 THEN 
       #   CALL cl_err('','aap-920',0)
       #   EXIT FOREACH
       #END IF
       #MOD-A30208---mark---end---
        IF cl_null(l_apc16) THEN 
           LET l_apc16 =0
        END IF
        IF cl_null(g_apa.apa20) THEN 
           LET g_apa.apa20 =0
        END IF
        IF cl_null(g_apa.apa08) THEN 
           LET g_apa.apa08 =0     
        END IF
        IF cl_null(g_apa.apa08) THEN 
           LET g_apa.apa08 =0
        END IF
        IF l_apa20 >=(l_apc08-l_apc10) THEN
           LET l_apc16 =l_apc08-l_apc10
           LET l_apa20 =l_apa20-l_apc16
        ELSE  
           LET l_apc16 =l_apa20
           LET l_apa20 =0
        END IF
        UPDATE apc_file SET apc16 =l_apc16
         WHERE apc01 =g_apa.apa01
           AND apc02 =l_apc02
        IF l_apa20 =0 THEN
           EXIT FOREACH
        END IF           
      END FOREACH
   END IF              #MOD-AA0187
     
#No.FUN-680027--end

   LET g_msg = TIME
#  INSERT INTO azo_file (azo01,azo02,azo03,azo03,azo04,azo05,azo06)   #MOD-590460
   INSERT INTO azo_file (azo01,azo02,azo03,azo04,azo05,azo06)   #MOD-590460
                 #VALUES('aapt110',g_user,g_today,g_msg,g_apa.apa01,'hold') #MOD-AC0328 mark
                  VALUES(g_prog,g_user,g_today,g_msg,g_apa.apa01,'hold')    #MOD-AC0328 

END FUNCTION

FUNCTION t110_apa19(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_apo02   LIKE apo_file.apo02
   DEFINE l_apoacti LIKE apo_file.apoacti

   LET l_apo02 = ''
   SELECT apo02,apoacti INTO l_apo02,l_apoacti
     FROM apo_file WHERE apo01 = g_apa.apa19
   LET g_errno = ' '

   CASE WHEN SQLCA.SQLCODE = 100 LET g_errno = 'aap-003'
        WHEN l_apoacti = 'N'     LET g_errno = '9028'
        WHEN SQLCA.SQLCODE != 0  LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE

   DISPLAY l_apo02 TO apo02

END FUNCTION

FUNCTION t110_apa21(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_gen02   LIKE gen_file.gen02
   DEFINE l_gen03   LIKE gen_file.gen03
   DEFINE l_genacti LIKE gen_file.genacti

   LET g_errno = ' '
   SELECT gen02,gen03,genacti INTO l_gen02,l_gen03,l_genacti
     FROM gen_file WHERE gen01 = g_apa.apa21

   CASE WHEN SQLCA.SQLCODE = 100 LET g_errno = 'aap-038'
        WHEN l_genacti = 'N'     LET g_errno = '9028'
        WHEN SQLCA.SQLCODE != 0  LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE

   DISPLAY l_gen02 TO gen02
   IF p_cmd='d' THEN RETURN END IF
   LET g_apa.apa22 = l_gen03
   DISPLAY BY NAME g_apa.apa22
   IF NOT cl_null(g_errno) THEN RETURN END IF

END FUNCTION

FUNCTION t110_apa22(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_gem05   LIKE gem_file.gem05
   DEFINE l_gemacti LIKE gem_file.gemacti
   #DEFINE l_depno     VARCHAR(6)               #FUN-660117 remark
   DEFINE l_depno     LIKE apa_file.apa22    #FUN-660117
   DEFINE l_t1        LIKE apy_file.apyslip  # No:FUN-690028 VARCHAR(5)  #FUN-580012
   #DEFINE l_d_actno   VARCHAR(24)              #FUN-660117 remark
   #DEFINE l_c_actno   VARCHAR(24)              #FUN-660117 remark
   DEFINE l_d_actno   LIKE apt_file.apt03    #FUN-660117
   DEFINE l_c_actno   LIKE apt_file.apt04    #FUN-660117
   DEFINE l_d_actno1  LIKE apt_file.apt031   #FUN-680029
   DEFINE l_c_actno1  LIKE apt_file.apt041   #FUN-680029
   DEFINE l_gem02     LIKE gem_file.gem02    #FUN-710078 add

  #SELECT gem05,gemacti INTO l_gem05,l_gemacti                #FUN-710078 mark
   SELECT gem05,gemacti,gem02 INTO l_gem05,l_gemacti,l_gem02  #FUN-710078 mod
     FROM gem_file WHERE gem01 = g_apa.apa22

   LET g_errno = ' '

   CASE WHEN SQLCA.SQLCODE = 100 LET g_errno = 'aap-039'
        WHEN l_gemacti = 'N'     LET g_errno = '9028'
        WHEN l_gem05  = 'N'      LET g_errno = 'agl-202'
        WHEN SQLCA.SQLCODE != 0  LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE

   DISPLAY l_gem02 TO gem02  #FUN-710078 add
   IF NOT cl_null(g_errno) THEN
      RETURN
   END IF

   IF g_apz.apz13 = 'Y' THEN
      LET l_depno = g_apa.apa22
   ELSE
      LET l_depno = ' '
   END IF

   SELECT * INTO g_aps.* FROM aps_file WHERE aps01 = l_depno

   IF SQLCA.sqlcode THEN
#     CALL cl_err(g_apa.apa22,'aap-053',1)   #No.FUN-660122
      CALL cl_err3("sel","aps_file",l_depno,"","aap-053","","",1)  #No.FUN-660122
      RETURN
   END IF
   #FUN-580012  --begin
   LET l_t1 = s_get_doc_no(g_apa.apa01)
   SELECT apydmy6 INTO g_apy.apydmy6 FROM apy_file WHERE apyslip = l_t1
   #FUN-580012  --end

   # Genero 修改，若帳款類別還未輸入，先不 default 科目
   IF NOT cl_null(g_apa.apa36) THEN
      SELECT apt03,apt031,apt04,apt041 INTO l_d_actno,l_d_actno1,l_c_actno,l_c_actno1 FROM apt_file          #No.FUN-680029
       WHERE apt01 = g_apa.apa36 AND apt02 = l_depno
      IF SQLCA.sqlcode THEN
         CASE WHEN g_apa.apa00 = '11' LET l_d_actno = g_aps.aps21
                                      LET l_c_actno = g_aps.aps22
                                      LET l_d_actno1= g_aps.aps211          #No.FUN-680029
                                      LET l_c_actno1= g_aps.aps221          #No.FUN-680029
              WHEN g_apa.apa00 = '12' LET l_d_actno = g_aps.aps21
                                      LET l_c_actno = g_aps.aps22
                                      LET l_d_actno1= g_aps.aps211          #No.FUN-680029
                                      LET l_c_actno1= g_aps.aps221          #No.FUN-680029
              WHEN g_apa.apa00 = '15' LET l_d_actno = g_aps.aps12 
                                      LET l_d_actno1= g_aps.aps121          #No.FUN-680029
              #FUN-580012  --begin
              WHEN g_apa.apa00 = '21'
                   IF g_aza.aza26='2' AND g_apy.apydmy6='Y' THEN
                      LET l_d_actno = ''
                      LET l_c_actno = ''
                      LET l_d_actno1= ''       #No.FUN-680029
                      LET l_c_actno1= ''       #No.FUN-680029
                   ELSE
                      LET l_d_actno = g_aps.aps41
                      LET l_c_actno = g_aps.aps40
                      LET l_d_actno1= g_aps.aps411      #No.FUN-680029
                      LET l_c_actno1= g_aps.aps401      #No.FUN-680029
                   END IF
              WHEN g_apa.apa00 = '22'
                   IF g_aza.aza26='2' AND g_apy.apydmy6='Y' THEN
                      LET l_d_actno = ''
                      LET l_c_actno = ''
                      LET l_d_actno1= ''       #No.FUN-680029
                      LET l_c_actno1= ''       #No.FUN-680029
                   ELSE
                      LET l_d_actno = g_aps.aps41
                      LET l_c_actno = g_aps.aps40
                      LET l_d_actno1= g_aps.aps411      #No.FUN-680029
                      LET l_c_actno1= g_aps.aps401      #No.FUN-680029
                   END IF
              #FUN-580012  --end
              #No.FUN-69008 --Begin 
              WHEN g_apa.apa00 = '13' LET l_d_actno = g_aps.aps21
                                      LET l_c_actno = g_aps.aps22
                                      LET l_d_actno1= g_aps.aps211          #No.FUN-680029
                                      LET l_c_actno1= g_aps.aps221          #No.FUN-680029
              WHEN g_apa.apa00 = '17' LET l_d_actno = g_aps.aps12 
                                      LET l_d_actno1= g_aps.aps121          #No.FUN-680029
              #No.FUN-690080 --End              
              OTHERWISE               LET l_d_actno = ''
                                      LET l_c_actno = ''
                                      LET l_d_actno1= ''       #No.FUN-680029
                                      LET l_c_actno1= ''       #No.FUN-680029
         END CASE
      END IF
 
      IF g_aptype[1,1] = '1' OR (g_aza.aza26='2' AND g_apy.apydmy6='Y') THEN  #FUN-580012
         IF g_apa.apa51 IS NULL THEN
            LET g_apa.apa51 = l_d_actno
            LET g_apa.apa511= l_d_actno1         #No.FUN-680029
         END IF
         IF g_apa.apa54 IS NULL THEN
            LET g_apa.apa54 = l_c_actno
            LET g_apa.apa541= l_c_actno1         #No.FUN-680029
         END IF
      ELSE
         IF g_apa.apa51 IS NULL THEN
            LET g_apa.apa51 = l_c_actno
            LET g_apa.apa511= l_c_actno1         #No.FUN-680029
         END IF
         IF g_apa.apa54 IS NULL THEN
            LET g_apa.apa54 = l_d_actno
            LET g_apa.apa541= l_d_actno1         #No.FUN-680029
         END IF
      END IF
 
      #----- 做預算控管則單頭科目空白, 分錄以單身科目為準
      IF g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' THEN
         LET g_apa.apa51=' '
         LET g_apa.apa511=' '         #No.FUN-680029
      END IF
   END IF


   DISPLAY BY NAME g_apa.apa51,g_apa.apa54
#No.FUN-680029--begin
   IF g_aza.aza63 ='Y' THEN
      DISPLAY BY NAME g_apa.apa511,g_apa.apa541
   ELSE
      LET g_apa.apa511 =NULL
      LET g_apa.apa541 =NULL
   END IF
#No.FUN-680029--end

END FUNCTION

FUNCTION t110_apa34f(p_cmd)     #TQC-750140 add p_cmd
   DEFINE p_cmd   LIKE type_file.chr1     #TQC-750140 add
   DEFINE l_cnt   LIKE type_file.num5       #No.FUN-690028 SMALLINT
   DEFINE l_azi04 LIKE azi_file.azi04   #MOD-630089
   DEFINE l_pmb02 LIKE pmb_file.pmb02   #TQC-770027

   SELECT azi04 INTO l_azi04 FROM azi_file WHERE azi01 = g_apa.apa13   #MOD-630089

   IF g_aptype MATCHES '1*' THEN
      IF cl_null(g_apa.apa37f) THEN LET g_apa.apa37f = 0 END IF                #No.FUN-690080
      LET g_apa.apa34f= g_apa.apa31f+g_apa.apa32f-g_apa.apa60f-g_apa.apa61f
                                                 -g_apa.apa65f+g_apa.apa37f    #No.FUN-690080
      LET g_apa.apa34f = cl_digcut(g_apa.apa34f,l_azi04)   #MOD-630089
      IF cl_null(g_apa.apa37) THEN LET g_apa.apa37 = 0 END IF                  #No.FUN-690080
      LET g_apa.apa34 = g_apa.apa31 +g_apa.apa32 -g_apa.apa60 -g_apa.apa61
                                                 -g_apa.apa65 +g_apa.apa37     #No.FUN-690080
      #LET g_apa.apa34 = cl_digcut(g_apa.apa34,t_azi.azi04)   #MOD-630089   #MOD-6B0066
      LET g_apa.apa34 = cl_digcut(g_apa.apa34,g_azi04)   #MOD-630089   #MOD-6B0066

      IF g_apa.apa13 != g_aza.aza17 AND g_apa.apa65 != 0 THEN
         #LET g_apa.apa34 = cl_digcut(g_apa.apa34,t_azi.azi04)   #MOD-630089
         IF cl_null(g_apa.apa37) THEN LET g_apa.apa37 = 0 END IF                  #No.FUN-690080
         LET g_apa.apa31 = g_apa.apa34+g_apa.apa65+g_apa.apa60+g_apa.apa61
                                                  -g_apa.apa32-g_apa.apa37     #No.FUN-690080
         #LET g_apa.apa31 = cl_digcut(g_apa.apa31,t_azi.azi04)   #MOD-630089   #MOD-6B0066
         LET g_apa.apa31 = cl_digcut(g_apa.apa31,g_azi04)   #MOD-630089   #MOD-6B0066
         IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
            DISPLAY BY NAME g_apa.apa31
         END IF  #FUN-C80078 add
      END IF

   END IF

   IF g_aptype MATCHES '2*' THEN
      LET g_apa.apa34f= g_apa.apa31f+g_apa.apa32f
      LET g_apa.apa34f = cl_digcut(g_apa.apa34f,l_azi04)   #MOD-630089
      LET g_apa.apa34 = g_apa.apa31 +g_apa.apa32
      #LET g_apa.apa34 = cl_digcut(g_apa.apa34,t_azi.azi04)   #MOD-630089   #MOD-6B0066
      LET g_apa.apa34 = cl_digcut(g_apa.apa34,g_azi04)   #MOD-630089   #MOD-6B0066
   END IF

   IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
      DISPLAY BY NAME g_apa.apa34f,g_apa.apa34
   END IF  #FUN-C80078 add
#MOD-590460 修改單頭金額,隨即UPDATE本幣單身合計金額(apa57),
#            以免造成本幣差異(apa33)之產生
#-----MOD-630131---------
#  IF g_apa.apa00 = '21' THEN
#     LET g_apa.apa57 = g_apa.apa31
#     DISPLAY BY NAME g_apa.apa57
#  END IF
   IF g_apa.apa00 = '21' OR g_apa.apa00 = '12' OR g_apa.apa00 = '15' OR 
      g_apa.apa00 = '16' OR g_apa.apa00 = '13' OR g_apa.apa00 = '17' OR     #No.FUN-690080   #MOD-870215 add 16
      g_apa.apa00 = '26'  THEN                                              #MOD-A10129 add 
      LET l_cnt = 0
      SELECT COUNT(*) INTO l_cnt FROM apb_file
        WHERE apb01 = g_apa.apa01
      IF l_cnt = 0 THEN
         LET g_apa.apa57 = g_apa.apa31
         LET g_apa.apa57f = g_apa.apa31f
         IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
            DISPLAY BY NAME g_apa.apa57
         END IF  #FUN-C80078 add
      END IF
   END IF
#-----END MOD-630131-----

#END MOD-590460


#   IF g_apa.apa57 > 0 AND (g_apa.apa00 != '15' OR g_apa.apa00 != '23') THEN    #MOD-610120
   #IF g_apa.apa57 > 0 AND (g_apa.apa00 != '15' AND g_apa.apa00 != '23') THEN    #MOD-610120   #MOD-640549
   IF g_apa.apa57 > 0 AND (g_apa.apa00 = '11' OR g_apa.apa00 = '21') THEN   #MOD-640549
      #No.TQC-7B0083  --Begin
      IF g_apa.apa56 IS NULL OR g_apa.apa56 <> '5' THEN
         LET g_apa.apa33 = g_apa.apa31 - g_apa.apa57
         #LET g_apa.apa33 = cl_digcut(g_apa.apa33,t_azi.azi04)   #MOD-630089   #MOD-6B0066
         LET g_apa.apa33f = g_apa.apa31f - g_apa.apa57f          #No.TQC-7C0049
      END IF
      LET g_apa.apa33 = cl_digcut(g_apa.apa33,g_azi04)   #MOD-630089   #MOD-6B0066
      LET g_apa.apa33f= cl_digcut(g_apa.apa33f,l_azi04)  #No.TQC-7C0049
      IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
         DISPLAY BY NAME g_apa.apa33
      END IF  #FUN-C80078 add
      #No.TQC-7B0083  --End  
   END IF
#No.FUN-680027--begin
  #IF g_apa.apa34f <> g_apa_t.apa34f AND g_apa_t.apa34f > 0 THEN  #CHI-B70013 mark
   IF g_apa.apa34f <> g_apa_t.apa34f THEN                         #CHI-B70013
      CALL t110_unpay()  #MOD-780152 add
      #TQC-750140 begin
      IF p_cmd = '1' THEN
        #重算多帳期資料
          DELETE FROM apc_file
           WHERE apc01 = g_apa.apa01 
          IF SQLCA.sqlcode THEN
             CALL cl_err3("del","apc_file",g_apa.apa01,g_apc_t.apc02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
             RETURN
          END IF
          CALL t110_ins_apc(g_apa.*)
      ELSE
      #TQC-750140 end
        #CALL cl_err('','aap-919',0)   #MOD-7A0082
#TQC-770027.....begin
        SELECT DISTINCT(pmb02) INTO l_pmb02 FROM pmb_file
         WHERE pmb01 = g_apa.apa11
        #IF l_pmb02 = 1 THEN   #MOD-810156
        IF l_pmb02 = 1 OR cl_null(l_pmb02) THEN   #MOD-810156
           DELETE FROM apc_file WHERE apc01 = g_apa.apa01
           CALL t110_ins_apc(g_apa.*)
        ELSE
           IF g_apa.apa35 <> g_apa_t.apa35 OR g_apa.apa35f <> g_apa_t.apa35f THEN
              LET g_sn = 'y'
           END IF
           IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
              CALL t110_account_period()
           END IF  #FUN-C80078 add
           LET g_sn = 'n'
        END IF
#TQC-770027.....end
      END IF
   END IF
   LET g_apa_t.apa34f = g_apa.apa34f   #CHI-B70013 add
#No.FUN-680027--end
  #--------------------MOD-C50228-----------------(S)
   UPDATE apa_file SET apa33 = g_apa.apa33,
                       apa33f = g_apa.apa33f
    WHERE apa01 = g_apa.apa01
  #--------------------MOD-C50228-----------------(E)
END FUNCTION

FUNCTION t110_unpay()
   DEFINE l_unpay1,l_unpay2   LIKE type_file.num20_6     # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_net               LIKE type_file.num20_6     # No:FUN-690028 DEC(20,6)  #FUN-4B0079

      LET l_unpay1 = g_apa.apa34f - g_apa.apa35f
      LET l_unpay2 = g_apa.apa34  - g_apa.apa35
      IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
         DISPLAY l_unpay1 TO apa35_uf
         DISPLAY l_unpay2 TO apa35_u
      END IF  #FUN-C80078 add

   IF g_apz.apz27 = 'Y' THEN
      SELECT SUM(oox10) INTO l_net FROM oox_file
       WHERE oox00 = 'AP' AND oox03 = g_apa.apa01
      IF cl_null(l_net) THEN
         LET l_net = 0
      END IF
      IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
         DISPLAY l_net TO net
      END IF  #FUN-C80078 add
   END IF

END FUNCTION

FUNCTION t110_apa36(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_apr02 LIKE apr_file.apr02
   DEFINE l_apracti   LIKE apr_file.apracti
   #DEFINE l_depno     VARCHAR(6)                #FUN-660117 remark
   #DEFINE l_d_actno   VARCHAR(24)               #FUN-660117 remark
   #DEFINE l_c_actno   VARCHAR(24)               #FUN-660117 remark
   DEFINE l_depno     LIKE apa_file.apa22     #FUN-660117
   DEFINE l_d_actno   LIKE apt_file.apt03     #FUN-660117
   DEFINE l_c_actno   LIKE apt_file.apt04     #FUN-660117
   DEFINE l_d_actno1  LIKE apt_file.apt031    #FUN-680029
   DEFINE l_c_actno1  LIKE apt_file.apt041    #FUN-680029

   LET g_errno = ' '
   SELECT apr02,apracti INTO l_apr02,l_apracti
     FROM apr_file WHERE apr01 = g_apa.apa36

   CASE WHEN SQLCA.SQLCODE = 100 LET g_errno = 'aap-044'
        WHEN l_apracti = 'N' LET g_errno = 'ams-106'
        WHEN SQLCA.SQLCODE != 0  LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE

   IF NOT cl_null(g_errno) THEN
      LET l_apr02 = ''
   END IF

   DISPLAY l_apr02 TO apr02

   IF p_cmd = 'd' THEN
      RETURN
   END IF

    #MOD-4B0269
   IF g_apz.apz13 = 'Y' THEN
      LET l_depno = g_apa.apa22
   ELSE
      LET l_depno = ' '
   END IF

   SELECT * INTO g_aps.* FROM aps_file WHERE aps01 = l_depno
   IF SQLCA.sqlcode THEN
#     CALL cl_err(g_apa.apa22,'aap-053',1)   #No.FUN-660122
     #CALL cl_err3("sel","aps_file",l_depno,"","app-053","","",1)  #No.FUN-660122 #MOD-B30663 mark
      CALL cl_err3("sel","aps_file",l_depno,"","aap-053","","",1)                 #MOD-B30663 
      RETURN
   END IF
   #--

   SELECT apt03,apt031,apt04,apt041 INTO l_d_actno,l_d_actno1,l_c_actno,l_c_actno1 FROM apt_file          #No.FUN-680029
    WHERE apt01 = g_apa.apa36 AND apt02 = l_depno
   IF SQLCA.sqlcode THEN
      CASE WHEN g_apa.apa00 = '11' LET l_d_actno = g_aps.aps21
                                   LET l_c_actno = g_aps.aps22
                                   LET l_d_actno1= g_aps.aps211             #No.FUN-680029
                                   LET l_c_actno1= g_aps.aps221             #No.FUN-680029
           WHEN g_apa.apa00 = '12' LET l_d_actno = g_aps.aps21
                                   LET l_c_actno = g_aps.aps22
                                   LET l_d_actno1= g_aps.aps211             #No.FUN-680029      
                                   LET l_c_actno1= g_aps.aps221             #No.FUN-680029
           WHEN g_apa.apa00 = '15' LET l_d_actno = g_aps.aps12
                                   LET l_d_actno1= g_aps.aps121             #No.FUN-680029
           #FUN-580012  --begin
           WHEN g_apa.apa00 = '21'
                IF g_aza.aza26='2' AND g_apy.apydmy6='Y' THEN
                   LET l_d_actno = ''
                   LET l_c_actno = ''
                   LET l_d_actno1= ''             #No.FUN-680029
                   LET l_c_actno1= ''             #No.FUN-680029
                ELSE
                   LET l_d_actno = g_aps.aps41
                   LET l_c_actno = g_aps.aps40
                   LET l_d_actno1= g_aps.aps411             #No.FUN-680029
                   LET l_c_actno1= g_aps.aps401             #No.FUN-680029
                END IF
           WHEN g_apa.apa00 = '22'
                IF g_aza.aza26='2' AND g_apy.apydmy6='Y' THEN
                   LET l_d_actno = ''
                   LET l_c_actno = ''
                   LET l_d_actno1= ''             #No.FUN-680029
                   LET l_c_actno1= ''             #No.FUN-680029
                ELSE
                   LET l_d_actno = g_aps.aps41
                   LET l_c_actno = g_aps.aps40
                   LET l_d_actno1= g_aps.aps411             #No.FUN-680029
                   LET l_c_actno1= g_aps.aps401             #No.FUN-680029
                END IF
           #FUN-580012  --end
           #No.FUN-690080 --Begi
           WHEN g_apa.apa00 = '13' LET l_d_actno = g_aps.aps21
                                   LET l_c_actno = g_aps.aps22
                                   LET l_d_actno1= g_aps.aps211          #No.FUN-680029
                                   LET l_c_actno1= g_aps.aps221          #No.FUN-680029
           WHEN g_apa.apa00 = '17' LET l_d_actno = g_aps.aps12 
                                   LET l_d_actno1= g_aps.aps121          #No.FUN-680029
           #No.FUN-690080 --End              
           OTHERWISE               LET l_d_actno = ''
                                   LET l_c_actno = ''
                                   LET l_d_actno1= ''             #No.FUN-680029
                                   LET l_c_actno1= ''             #No.FUN-680029
      END CASE
   END IF

   #No.+340 010720 by plum 不管是 1*,2* 產生的借貸方均不反轉
   IF g_apa.apa51 IS NULL OR g_apa.apa36 != g_apa_t.apa36
      OR cl_null(g_apa_t.apa36) THEN
      LET g_apa.apa51 = l_d_actno
   END IF

   IF g_apa.apa54 IS NULL OR g_apa.apa36 != g_apa_t.apa36
      OR cl_null(g_apa_t.apa36) THEN
      LET g_apa.apa54 = l_c_actno
   END IF
#No.FUN-680029--begin
   IF g_aza.aza63 ='Y' THEN
      IF g_apa.apa511 IS NULL OR g_apa.apa36 != g_apa_t.apa36
         OR cl_null(g_apa_t.apa36) THEN
         LET g_apa.apa511 = l_d_actno1
      END IF
      IF g_apa.apa541 IS NULL OR g_apa.apa36 != g_apa_t.apa36
         OR cl_null(g_apa_t.apa36) THEN
         LET g_apa.apa541 = l_c_actno1
      END IF
   END IF
#No.FUN-680029--end
   #----- 做預算控管則單頭科目空白, 分錄以單身科目為準
   IF g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' THEN
      LET g_apa.apa51=' '
      LET g_apa.apa511=' '        #No.FUN-680029
   END IF
   DISPLAY BY NAME g_apa.apa51,g_apa.apa54
#No.FUN-680029--begin
   IF g_aza.aza63 ='Y' THEN
      DISPLAY BY NAME g_apa.apa511,g_apa.apa541
   ELSE
      LET g_apa.apa511 =NULL
      LET g_apa.apa541 =NULL
   END IF
#No.FUN-680029--end
   CALL t110_show()   #No.MOD-B40183
END FUNCTION

FUNCTION t110_apa56()
DEFINE l_msg  LIKE ze_file.ze03     # No:FUN-690028 VARCHAR(30)

   IF g_lang != '1' THEN
      CASE WHEN g_apa.apa56 = '0'
              CALL cl_getmsg('aap-282',g_lang) RETURNING l_msg
              DISPLAY l_msg  TO apa56_name
           WHEN g_apa.apa56 = '1'
              CALL cl_getmsg('aap-283',g_lang) RETURNING l_msg
              DISPLAY l_msg  TO apa56_name
           WHEN g_apa.apa56 = '2'
              CALL cl_getmsg('aap-284',g_lang) RETURNING l_msg
              DISPLAY l_msg  TO apa56_name
           WHEN g_apa.apa56 = '3'
              CALL cl_getmsg('aap-285',g_lang) RETURNING l_msg
              DISPLAY l_msg  TO apa56_name
           #No.TQC-7B0083  --Begin
           WHEN g_apa.apa56 = '5'
              CALL cl_getmsg('aap-819',g_lang) RETURNING l_msg
              DISPLAY l_msg  TO apa56_name
           #No.TQC-7B0083  --End  
           OTHERWISE
              DISPLAY '    ' TO apa56_name
      END CASE
   END IF

END FUNCTION

FUNCTION t110_q()

    LET g_row_count = 0
    LET g_curs_index = 0
    CALL cl_navigator_setting( g_curs_index, g_row_count )
    INITIALIZE g_apa.* TO NULL                  #No.FUN-6A0016

  #MESSAGE ""
   CALL cl_msg("")                              #FUN-640240

   CALL cl_opmsg('q')
   CLEAR FORM
   CALL g_apb.clear()
   CALL g_apk.clear()
   CALL g_apk1.clear()   #MOD-960128 add
   CALL g_api.clear()
   DISPLAY '   ' TO FORMONLY.cnt

   CALL t110_cs()

   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF

  #MESSAGE " SEARCHING ! "
   CALL cl_msg(" SEARCHING ! ")                              #FUN-640240


   OPEN t110_cs                            # 從DB產生合乎條件TEMP(0-30秒)
   IF SQLCA.sqlcode THEN
      CALL cl_err('',SQLCA.sqlcode,0)
      INITIALIZE g_apa.* TO NULL
   ELSE
      OPEN t110_count
      FETCH t110_count INTO g_row_count
      DISPLAY g_row_count TO FORMONLY.cnt
      CALL t110_fetch('F')                  # 讀出TEMP第一筆並顯示
   END IF
  #MESSAGE ""
   CALL cl_msg("")                              #FUN-640240


END FUNCTION

#處理資料的讀取
FUNCTION t110_fetch(p_flag)
DEFINE
   g_t1            LIKE oay_file.oayslip,              #No.FUN-550030  #No.FUN-690028 VARCHAR(05)
   p_flag          LIKE type_file.chr1                  #處理方式  #No.FUN-690028 VARCHAR(1)

   CASE p_flag
      WHEN 'N' FETCH NEXT     t110_cs INTO g_apa_rowid,g_apa.apa01
      WHEN 'P' FETCH PREVIOUS t110_cs INTO g_apa_rowid,g_apa.apa01
      WHEN 'F' FETCH FIRST    t110_cs INTO g_apa_rowid,g_apa.apa01
      WHEN 'L' FETCH LAST     t110_cs INTO g_apa_rowid,g_apa.apa01
      WHEN '/'
         IF NOT g_no_ask THEN
            CALL cl_getmsg('fetch',g_lang) RETURNING g_msg
            LET INT_FLAG = 0
            PROMPT g_msg CLIPPED,': ' FOR g_jump
               ON IDLE g_idle_seconds
                  CALL cl_on_idle()
 
               ON ACTION about         #MOD-4C0121
                  CALL cl_about()      #MOD-4C0121
 
               ON ACTION help          #MOD-4C0121
                  CALL cl_show_help()  #MOD-4C0121
 
               ON ACTION controlg      #MOD-4C0121
                  CALL cl_cmdask()     #MOD-4C0121
            END PROMPT
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               EXIT CASE
            END IF
         END IF
         FETCH ABSOLUTE g_jump t110_cs INTO g_apa_rowid,g_apa.apa01
         LET g_no_ask = FALSE
   END CASE

   IF SQLCA.sqlcode THEN
      CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)
      INITIALIZE g_apa.* TO NULL  #TQC-6B0105
      LET g_apa_rowid = NULL      #TQC-6B0105
      RETURN
   ELSE
      CASE p_flag
         WHEN 'F' LET g_curs_index = 1
         WHEN 'P' LET g_curs_index = g_curs_index - 1
         WHEN 'N' LET g_curs_index = g_curs_index + 1
         WHEN 'L' LET g_curs_index = g_row_count
         WHEN '/' LET g_curs_index = g_jump
      END CASE
 
      CALL cl_navigator_setting( g_curs_index, g_row_count )
   END IF

   SELECT * INTO g_apa.* FROM apa_file WHERE ROWID = g_apa_rowid    #TQC-C90078  mark
   #SELECT * INTO g_apa.* FROM apa_file WHERE apa01 = g_apa.apa01     #TQC-C90078  add
   IF SQLCA.sqlcode THEN
#     CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)   #No.FUN-660122
      CALL cl_err3("sel","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","",1)  #No.FUN-660122
      INITIALIZE g_apa.* TO NULL
      RETURN
   ELSE                                    #No:FUN-4C0047
      LET g_data_owner = g_apa.apauser     #No:FUN-4C0047
      LET g_data_group = g_apa.apagrup     #No:FUN-4C0047
   END IF

#No.FUN-550030--begin
   LET g_t1=s_get_doc_no(g_apa.apa01)
#No.FUN-550030--begin

   SELECT * INTO g_apy.* FROM apy_file WHERE apyslip=g_t1
   CALL t110_bookno()     #No.FUN-730064 
   CALL t110_show()

END FUNCTION

#將資料顯示在畫面上
FUNCTION t110_show()

   LET g_apa_t.* = g_apa.*                #保存單頭舊值

   IF g_apa.apa00 matches '2*' THEN
      CALL t110_show_ref()
   END IF
   ###MOD-4A0253
     DISPLAY BY NAME
        g_apa.apa01,g_apa.apa02,g_apa.apa05,g_apa.apa06,g_apa.apa07,
        g_apa.apa21,g_apa.apa22,g_apa.apa930,g_apa.apamksg,g_apa.apa42,g_apa.apa41, #FUN-670064
        g_apa.apa44,g_apa.apa992,g_apa.apa63,g_apa.apa36,g_apa.apa13,g_apa.apa14,  #No.FUN-690090 add apa992
        g_apa.apa08,g_apa.apa77,g_apa.apa15,g_apa.apa16,     #FUN-970108 add apa77
        g_apa.apa11,g_apa.apa12,g_apa.apa24,g_apa.apa64,g_apa.apa55,
        g_apa.apa31f,g_apa.apa32f,g_apa.apa60f,g_apa.apa61f,g_apa.apa65f,g_apa.apa34f,g_apa.apa35f,g_apa.apa37f,   #No.FUN-690080
        g_apa.apa31,g_apa.apa32,g_apa.apa60,g_apa.apa61,g_apa.apa65,g_apa.apa34,g_apa.apa35,g_apa.apa37,   #No.FUN-690080
        g_apa.apa51,g_apa.apa52,g_apa.apa54,g_apa.apa19,g_apa.apa20,
        g_apa.apa56,g_apa.apa33,g_apa.apa66,g_apa.apa25,g_apa.apa100, #FUN-630043
        g_apa.apa101,g_apa.apa102,                                    #No.FUN-690080
        g_apa.apainpd,g_apa.apa99,g_apa.apa57,g_apa.apa511,g_apa.apa521,g_apa.apa541,           #No:8150 add apa99   #No.FUN-680029
        g_apa.apauser,g_apa.apagrup,g_apa.apamodu,g_apa.apadate,g_apa.apaacti,
       #FUN-850038     ---start---
        g_apa.apaud01,g_apa.apaud02,g_apa.apaud03,g_apa.apaud04,
        g_apa.apaud05,g_apa.apaud06,g_apa.apaud07,g_apa.apaud08,
        g_apa.apaud09,g_apa.apaud10,g_apa.apaud11,g_apa.apaud12,
        g_apa.apaud13,g_apa.apaud14,g_apa.apaud15
       #FUN-850038     ----end----
   ###END MOD-4A0253
  #IF g_aptype = '21' OR g_aptype = '22' THEN                     #MOD-8C0009 mark
   IF g_aptype = '21' OR g_aptype = '22' OR g_aptype = '26' THEN  #MOD-8C0009
      DISPLAY BY NAME g_apa.apa58
   END IF

   #SELECT * INTO g_azi.* FROM azi_file WHERE azi01 = g_apa.apa13   #MOD-6B0066
   SELECT azi03,azi04,azi07 INTO t_azi03,t_azi04,t_azi07     #MOD-6B0066
      FROM azi_file WHERE azi01 = g_apa.apa13   #MOD-6B0066
   
   LET g_pma11 = NULL
   SELECT pma11 INTO g_pma11 FROM pma_file WHERE pma01=g_apa.apa11
   DISPLAY g_pma11 TO pma11
   LET g_msg=NULL

   SELECT pmc03 INTO g_msg FROM pmc_file WHERE pmc01 = g_apa.apa05
   DISPLAY g_msg TO pmc03

  #FUN-710078---add---str---
   LET g_gem02=NULL
   SELECT gem02 INTO g_gem02  FROM gem_file WHERE gem01 = g_apa.apa22
   DISPLAY g_gem02 TO gem02

   LET g_a51=NULL
   LET g_a52=NULL
   LET g_a54=NULL
   LET g_a511 = NULL
   LET g_a521 = NULL
   LET g_a541 = NULL
   SELECT aag02 INTO g_a51 FROM aag_file  WHERE aag01 = g_apa.apa51
                                            AND aag00 = g_bookno1         #No.TQC-770056
                                            AND aagacti = 'Y'             #No.MOD-B70280 add
   SELECT aag02 INTO g_a52 FROM aag_file  WHERE aag01 = g_apa.apa52
                                            AND aag00 = g_bookno1         #No.TQC-770056
                                            AND aagacti = 'Y'             #No.MOD-B70280 add
   SELECT aag02 INTO g_a54 FROM aag_file  WHERE aag01 = g_apa.apa54
                                            AND aag00 = g_bookno1         #No.TQC-770056
                                            AND aagacti = 'Y'             #No.MOD-B70280 add
   SELECT aag02 INTO g_a511 FROM aag_file WHERE aag01 = g_apa.apa511      #No.MOD-7B0009
                                            AND aag00 = g_bookno2         #No.TQC-770056
                                            AND aagacti = 'Y'             #No.MOD-B70280 add
   SELECT aag02 INTO g_a521 FROM aag_file WHERE aag01 = g_apa.apa521      #No.MOD-7B0009
                                            AND aag00 = g_bookno2         #No.TQC-770056
                                            AND aagacti = 'Y'             #No.MOD-B70280 add
   SELECT aag02 INTO g_a541 FROM aag_file WHERE aag01 = g_apa.apa541      #No.MOD-7B0009
                                            AND aag00 = g_bookno2         #No.TQC-770056
                                            AND aagacti = 'Y'             #No.MOD-B70280 add
  #DISPLAY g_a51,g_a52,g_a54 TO FORMONLY.a51,FORMONLY.a52,FORMONLY.a54
   DISPLAY g_a51 TO FORMONLY.a51    #No.TQC-770056       
   DISPLAY g_a52 TO FORMONLY.a52    #No.TQC-770056 
   DISPLAY g_a54 TO FORMONLY.a54    #No.TQC-770056 
   DISPLAY g_a511 TO FORMONLY.a511  #No.MOD-7B0009
   DISPLAY g_a521 TO FORMONLY.a521  #No.MOD-7B0009
   DISPLAY g_a541 TO FORMONLY.a541  #No.MOD-7B0009
  #FUN-710078---add---end---

   #--------#No:FUN-960117 EBO add start --------
   IF g_aza.aza75 MATCHES '[Yy]' AND (g_prog='aapt110' OR g_prog='aapt120') THEN
      CALL aws_ebocli(g_dbs,g_apa.apa01,'*','*','*','*','EBO-120','M010','qry_maxver') RETURNING l_maxkey2
      CALL aws_ebocli(g_dbs,g_apa.apa01,l_maxkey2,'*','*','*','EBO-120','M010','show_transfer')
   END IF
   #--------#No:FUN-960117 EBO add end   --------

   CALL t110_apa19('d')
   CALL t110_apa21('d')
   CALL t110_apa36('d')
   CALL t110_apa56()
   CALL t110_unpay()
   CALL t110_b_fill(g_wc2)
   DISPLAY t110_set_apa930(g_apa.apa930) TO FORMONLY.gem02b #FUN-670064
 
   IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
   CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti)
   CALL cl_show_fld_cont()                   #No:FUN-550037 hmf
   #-----FUN-830091---------
   CALL cl_set_act_visible("entry_sheet,entry_sheet2,
                            T_T_entry_sheet,T_T_entry_sheet2",TRUE)
   IF cl_null(g_apa.apa99) THEN
      CALL cl_set_act_visible("T_T_entry_sheet,T_T_entry_sheet2",FALSE)
      IF g_aza.aza63 = 'N' THEN
         CALL cl_set_act_visible("entry_sheet2",FALSE)  
      END IF
   ELSE
      CALL cl_set_act_visible("entry_sheet,entry_sheet2",FALSE)
      IF g_aza.aza63 = 'N' THEN
         CALL cl_set_act_visible("T_T_entry_sheet2",FALSE)  
      END IF
   END IF  
   #-----END FUN-830091-----
END FUNCTION

#--------------------------------------------------------------------#
# Read 相關資料
# modi by canny(980826):apa00 = '2*' 貸抵 ==> 所以就顯示 對應傳票號碼
#                       EX. apa00 = '21' ==> 請款折讓時 apa_file.apa00 = '1*'
#                           折讓單       ==> k.沖帳時   apv_file
#                                        ==> W.抵帳時   apf_file
#                           apa00 = '22' ==> k.沖帳時   apv_file
#                           DM 單        ==> W.抵帳時   apf_file
#                           apa00 = '23' ==> 預付請款時 apa_file.apa00 = '15'
#                           預付單
#                           apa00 = '25' ==> 借款申請時 apa_file.apa00 = '17'     #No.FUN-690080
#                           借款待扺單                                            #No.FUN-690080
#--------------------------------------------------------------------#
FUNCTION t110_show_ref()
   DEFINE f_apa     RECORD LIKE apa_file.*
   DEFINE f_apv     RECORD LIKE apv_file.*
   DEFINE f_apf     RECORD LIKE apf_file.*
   DEFINE f_apg     RECORD LIKE apg_file.*
   DEFINE f_aph     RECORD LIKE aph_file.*
   DEFINE l_sql     STRING                  #MOD-720062  #LIKE type_file.chr1000
   DEFINE l_t1      LIKE apy_file.apyslip   #MOD-8A0212 add
   DEFINE l_apydmy3 LIKE apy_file.apydmy3   #MOD-8A0212 add

   LET l_sql = "SELECT * FROM apa_file WHERE apa01 = ? "
   PREPARE show_ref_p1 FROM l_sql
   DECLARE show_ref_c1 CURSOR FOR show_ref_p1

   LET l_sql = "SELECT apa_file.* ",
               "  FROM apv_file,apa_file ",
               " WHERE apv03 = ? ",
               "   AND apv01 = apa01 "

   PREPARE show_ref_p2   FROM l_sql
   DECLARE show_ref_c2   CURSOR FOR show_ref_p2

   LET l_sql = "SELECT apf_file.* ",
               "  FROM apf_file,aph_file ",
               " WHERE aph04 = ? ",
               "   AND apf01 = aph01 "

   PREPARE show_ref_p3 FROM l_sql
   DECLARE show_ref_c3 CURSOR FOR show_ref_p3

  #str MOD-8A0212 add
   LET l_t1 = ''   LET l_apydmy3 = ''
   LET l_t1 = s_get_doc_no(g_apa.apa01)
   SELECT apydmy3 INTO l_apydmy3 FROM apy_file WHERE apyslip = l_t1
  #end MOD-8A0212 add

   #折讓處理
   IF g_apa.apa00 = '21' THEN
      IF g_apa.apa58 = '1' THEN                   #請款折讓
         OPEN show_ref_c1 USING g_apa.apa08
         FETCH show_ref_c1 INTO f_apa.*
         IF STATUS THEN
            SLEEP 0
         ELSE
            LET g_apa.apa44 = f_apa.apa44
         END IF
         CLOSE show_ref_c1
      ELSE
         OPEN show_ref_c2  USING g_apa.apa01
         FETCH show_ref_c2  INTO  f_apa.*
         IF STATUS THEN
            IF l_apydmy3 = 'N' THEN   #MOD-8A0212 add
               OPEN show_ref_c3  USING g_apa.apa01
               FETCH show_ref_c3  INTO  f_apf.*
               IF STATUS THEN
                  SLEEP 0
               ELSE
                  #no.    若aapt210本身沒有拋轉傳票才 show aapt330所拋的傳票
                  IF cl_null(g_apa.apa44) THEN
                     LET g_apa.apa44 = f_apf.apf44
                  END IF
               END IF
               CLOSE show_ref_c3
            ELSE                               #MOD-8B0164 add
               IF cl_null(g_apa.apa44) THEN    #No:MOD-910044
                  LET g_apa.apa44 = f_apa.apa44   #MOD-8B0164 add
               END IF   #No:MOD-910044
            END IF   #MOD-8A0212 add
         ELSE
            IF cl_null(g_apa.apa44) THEN         #No:9383
               LET g_apa.apa44 = f_apa.apa44
            END IF
         END IF
         CLOSE show_ref_c2
      END IF
   END IF

   IF (g_apa.apa00 = '23' OR g_apa.apa00 = '25') THEN     #SE 單 #No.FUN-690080
      OPEN show_ref_c1 USING g_apa.apa08
      FETCH show_ref_c1 INTO f_apa.*
      IF STATUS THEN
         SLEEP 0
      ELSE
         LET g_apa.apa44 = f_apa.apa44
      END IF
      CLOSE show_ref_c1
   END IF

   IF g_apa.apa00 = '22' THEN                        #DM 單
      OPEN show_ref_c2 USING g_apa.apa01
      FETCH show_ref_c2 INTO f_apa.*
      IF STATUS THEN
         IF l_apydmy3 = 'N' THEN   #MOD-8A0212 add
            OPEN show_ref_c3 USING g_apa.apa01
            FETCH show_ref_c3 INTO f_apf.*
            IF STATUS THEN
               SLEEP 0
            ELSE
               #no.    若aapt220本身沒有拋轉傳票才 show aapt330所拋的傳票
               IF cl_null(g_apa.apa44) THEN
                  LET g_apa.apa44 = f_apf.apf44
               END IF
            END IF
            CLOSE show_ref_c3
         ELSE                               #MOD-8B0164 add
            IF cl_null(g_apa.apa44) THEN  #MOD-920359
               LET g_apa.apa44 = f_apa.apa44   #MOD-8B0164 add
            END IF   #MOD-920359
         END IF   #MOD-8A0212 add
      ELSE 
         IF cl_null(g_apa.apa44) THEN   #MOD-830018
            LET g_apa.apa44 = f_apa.apa44
         END IF   #MOD-830018
      END IF
      CLOSE show_ref_c2
   END IF
   CALL cl_show_fld_cont()                   #No:FUN-550037 hmf

END FUNCTION

FUNCTION t110_r()
DEFINE l_apv02 LIKE apv_file.apv02,
       l_apv03 LIKE apv_file.apv03,
       l_apv04 LIKE apv_file.apv04,
       l_apv05 LIKE apv_file.apv05,           #No.FUN-680027
       l_apa01 LIKE apa_file.apa01,
       l_apa35 LIKE apa_file.apa35,
       l_apa41 LIKE apa_file.apa41,
       l_apk26 LIKE apk_file.apk26,
       l_apk27 LIKE apk_file.apk27,
       l_n          LIKE type_file.num5,   #No.FUN-690028 SMALLINT
       l_apa14 LIKE apa_file.apa14,   #TQC-6C0044
       l_aph04 LIKE aph_file.aph04,   #TQC-6C0044
       l_aph03 LIKE aph_file.aph03,   #MOD-A20108 add
       l_aph05f LIKE aph_file.aph05f,   #MOD-A20108 add
       l_aph05 LIKE aph_file.aph05    #MOD-A20108 add
DEFINE l_rvv40 LIKE rvv_file.rvv40    #No.TQC-750181
 
   IF s_aapshut(0) THEN
      RETURN
   END IF

  #FUN-E30020 add---str------
  #apa79=N 單據來源為HRM,不可由TIPTOP直接刪除!(aws-457)
   IF g_apa.apa79 = 'N' THEN
      CALL cl_err('apa79=N','aws-457',1)
      RETURN
   END IF
  #FUN-E30020 add---end------

   IF g_apa.apa01 IS NULL THEN
      CALL cl_err("",-400,0)
      RETURN
   END IF

   SELECT * INTO g_apa.* FROM apa_file
    WHERE apa01=g_apa.apa01

   IF g_apa.apa41 = 'Y' THEN
      CALL cl_err('apa41=Y','aap-086',0)
      RETURN
   END IF

   IF g_apa.apa63 matches '[Ss1]' THEN          #FUN-550042
       CALL cl_err('','mfg3557',0)
       RETURN
   END IF

   IF g_apa.apa42 = 'Y' THEN
      CALL cl_err('apa42=Y','aap-165',0)
      RETURN
   END IF

   IF g_apa.apa75 = 'Y' THEN
      CALL cl_err('apa75=Y','aap-332',0)
      RETURN
   END IF

   IF g_apa.apa55 = '1' AND g_apa.apa35 > 0 AND (g_apa.apa34<=g_apa.apa35) THEN
      CALL cl_err('unpay<=0','aap-172',0)
      RETURN
   END IF
   #No.MOD-5B0053 --begin
   IF g_apz.apz27 = 'N' THEN
      IF g_apa.apa55 = '1' AND g_apa.apa35 > 0 AND (g_apa.apa34<=g_apa.apa35) THEN
         CALL cl_err('unpay<=0','aap-172',0)
         RETURN
      END IF
   ELSE
      IF g_apa.apa55 = '1' AND g_apa.apa35 > 0 AND (g_apa.apa73<=0) THEN
         CALL cl_err('unpay<=0','aap-172',0)
         RETURN
      END IF
   END IF
   #No.MOD-5B0053 --end

   IF NOT cl_null(g_apa.apa44) THEN   #No:MOD-670056
      IF NOT s_chkpost(g_apa.apa44,g_apa.apa01) THEN
         RETURN
      END IF
   END IF
  #-----TQC-740314--------已有沖暫估資料不可取消確認
   LET l_n=0
   SELECT COUNT(*) INTO l_n FROM api_file
     WHERE api01 = g_apa.apa01 AND api02='2'
    IF l_n > 0 AND g_aptype ='16' THEN
       CALL cl_err(g_apa.apa01,'aap-338',0)
       RETURN
    END IF
  #-----END TQC-7400314----

   LET g_success = 'Y'
   BEGIN WORK
   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa_rowid
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl r:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF

   FETCH t110_cl INTO g_apa.*               # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
       CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)          #資料被他人LOCK
       RETURN
   END IF

   CALL t110_show()

   IF cl_delh(0,0) THEN                   #確認一下
       INITIALIZE g_doc.* TO NULL          #No.FUN-9B0098 10/02/24
       LET g_doc.column1 = "apa01"         #No.FUN-9B0098 10/02/24
       LET g_doc.value1 = g_apa.apa01      #No.FUN-9B0098 10/02/24
       CALL cl_del_doc()                #No.FUN-9B0098 10/02/24
      WHILE TRUE
         MESSAGE 'del apa !'
         IF g_apa.apa00[1,1] = '2' AND g_apa.apa58 = '1' THEN
            DECLARE z10_curs CURSOR FOR
             SELECT apk26,apk27 FROM apk_file
              WHERE apk01 = g_apa.apa01

            FOREACH z10_curs INTO l_apk26,l_apk27
               IF l_apk26 IS NULL OR l_apk27 IS NULL THEN
                  CALL cl_err('del apk26:',STATUS,1)
                  LET g_success = 'N' EXIT WHILE
               END IF
               UPDATE apb_file SET apb16 = 'N'
                WHERE apb01 = l_apk26 AND apb02 = l_apk27
               IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN
#                 CALL cl_err('upd apk16:',SQLCA.SQLCODE,1)   #No.FUN-660122
                  CALL cl_err3("upd","apb_file",l_apk26,l_apk27,SQLCA.sqlcode,"","upd apk16:",1)  #No.FUN-660122
                  LET g_success = 'N' EXIT WHILE
               END IF
            END FOREACH
         END IF
 
         SELECT count(*) into l_n FROM apk_file WHERE apk01 = g_apa.apa01
         IF STATUS THEN
            LET l_n = 0
         END IF

         IF l_n IS NULL THEN
            LET l_n = 0
         END IF

         IF l_n != 0 THEN
            DELETE FROM apk_file WHERE apk01 = g_apa.apa01
            IF STATUS THEN
#              CALL cl_err('del apk:',SQLCA.SQLCODE,1)   #No.FUN-660122
               CALL cl_err3("del","apk_file",g_apa.apa01,"",SQLCA.sqlcode,"","sel apk:",1)  #No.FUN-660122
               LET g_success = 'N'
               EXIT WHILE
            END IF
         END IF

         ##No.2848 modify 1998/11/24若請款單刪除應Check請款折讓單也應刪除
         IF g_apa.apa00[1,1] = '1' THEN
            SELECT COUNT(*) INTO g_cnt FROM apa_file
             WHERE apa08 = g_apa.apa01
               AND apa58 = '1'
            IF g_cnt > 0 THEN
               DECLARE t110_del_21 CURSOR FOR
                SELECT apa01,apa41 FROM apa_file
                 WHERE apa08 = g_apa.apa01
                   AND apa58 = '1'

               FOREACH t110_del_21 INTO l_apa01,l_apa41
                  IF STATUS THEN
                     CALL cl_err('foreach 21',STATUS,0)   
                     EXIT FOREACH
                  END IF

                  DELETE FROM apk_file WHERE apk01 = l_apa01
                  IF STATUS OR SQLCA.sqlerrd[3]=0 THEN
#                    CALL cl_err('del 21apk',SQLCA.SQLCODE,0)   #No.FUN-660122
                     CALL cl_err3("del","apk_file",l_apa01,"",SQLCA.sqlcode,"","del 2lapk",1)  #No.FUN-660122
                     LET g_success = 'N'
                     EXIT FOREACH
                  END IF

                  DELETE FROM apa_file WHERE apa01 = l_apa01
                  IF STATUS OR SQLCA.sqlerrd[3]=0 THEN
#                    CALL cl_err('del 21apa',SQLCA.SQLCODE,0)   #No.FUN-660122
                     CALL cl_err3("del","apa_file",l_apa01,"",SQLCA.sqlcode,"","del 2lapa",1)  #No.FUN-660122
                     LET g_success = 'N'
                     EXIT FOREACH
                  END IF

#No.FUN-680027--begin
                  DELETE FROM apc_file WHERE apc01 = l_apa01
                  IF STATUS OR SQLCA.sqlerrd[3]=0 THEN
                     CALL cl_err3("del","apc_file",l_apa01,"",SQLCA.sqlcode,"","del 2lapc",1)  #No.FUN-660122
                     LET g_success = 'N'
                     EXIT FOREACH
                  END IF
#No.FUN-680027--end

                  DELETE FROM apb_file WHERE apb01 = l_apa01
                  IF STATUS OR SQLCA.sqlerrd[3]=0 THEN
#                    CALL cl_err('del 21apb',SQLCA.SQLCODE,0)   #No.FUN-660122
                     CALL cl_err3("del","apb_file",l_apa01,"",SQLCA.sqlcode,"","del 2lapb",1)  #No.FUN-660122
                     LET g_success = 'N'
                     EXIT FOREACH
                  END IF
               END FOREACH
            END IF
         END IF

         DELETE FROM apa_file WHERE apa01 = g_apa.apa01
         IF STATUS OR SQLCA.SQLCODE THEN
#           CALL cl_err('del apa:',SQLCA.SQLCODE,1)   #No.FUN-660122
            CALL cl_err3("del","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","del apa:",1)  #No.FUN-660122
            LET g_success = 'N'
            EXIT WHILE
         END IF

         MESSAGE 'del npp !'
         DELETE FROM npp_file
          WHERE npp01 = g_apa.apa01
            AND nppsys = 'AP'
            AND npp00 = 1
            AND npp011 = 1
         IF STATUS THEN
#           CALL cl_err('del npp:',STATUS,1)   #No.FUN-660122
            CALL cl_err3("del","npp_file",g_apa.apa01,"",STATUS,"","del npp:",1)  #No.FUN-660122
            LET g_success = 'N'
            EXIT WHILE
         END IF

         MESSAGE 'del npq !'
         DELETE FROM npq_file
          WHERE npq01 = g_apa.apa01
            AND npqsys = 'AP'
            AND npq00 = 1
            AND npq011 = 1
         IF STATUS THEN
#           CALL cl_err('del npq:',STATUS,1)   #No.FUN-660122
            CALL cl_err3("del","npq_file",g_apa.apa01,"",STATUS,"","del npq:",1)  #No.FUN-660122
            LET g_success = 'N'
            EXIT WHILE
         END IF

         MESSAGE 'del apd !'
         DELETE FROM apd_file WHERE apd01 = g_apa.apa01
#No.FUN-680027--begin
         MESSAGE 'del apc !'
         DELETE FROM apc_file WHERE apc01 = g_apa.apa01
#No.FUN-680027--end

         #No.FUN-690080 --Begin
         MESSAGE 'del apx !'
         DELETE FROM apx_file WHERE apx01 = g_apa.apa01
         #No.FUN-690080 --End

         MESSAGE 'del api !'
         DELETE FROM api_file WHERE api01 = g_apa.apa01

         #-----MOD-770001--------- 
         #-----TQC-6C0044---------
        #str MOD-850245 mark
        #搬到t110_r_cur3後刪除,因為t110_r_cur3會抓aph_file
        #MESSAGE 'del aph !'
        #DELETE FROM aph_file WHERE aph01 = g_apa.apa01
        #IF STATUS OR SQLCA.SQLCODE THEN
        #   CALL cl_err('del aph:',SQLCA.SQLCODE,1)
        #   LET g_success = 'N'
        #   EXIT WHILE
        #END IF
        #end MOD-850245 mark
         
         MESSAGE 'del apg !'
         DELETE FROM apg_file WHERE apg01 = g_apa.apa01
         IF STATUS OR SQLCA.SQLCODE THEN
            CALL cl_err('del apg:',SQLCA.SQLCODE,1)
            LET g_success = 'N'
            EXIT WHILE
         END IF
         #-----END TQC-6C0044-----
         #-----END MOD-770001-----

         DECLARE t110_r_cur CURSOR WITH HOLD FOR
        #FUN-810045 begin
          #SELECT apb02,'',apb11,apb29,apb21,apb31,'',apb22,apb34,'',   #FUN-680110 add '',''  #No.TQC-7B0083
          #       apb06,apb07,apb12,apb27, #FUN-630055 add apb31
          #       #apb09,apb28,'',apb25,apb26,apb23,apb24,apb08,apb10  #No.FUN-690080     #MOD-770044
          #       #apb09,apb28,'',apb25,'',apb251,'',apb26,'','','',apb23,apb24,apb08,apb10  #MOD-770044   #MOD-7A0124
          #       apb09,apb28,'',apb25,'',apb251,'',apb26,'','','',apb23,apb24,apb08,apb10,apb04,apb05  #MOD-770044   #MOD-7A0124
          SELECT apb02,'',apb11,apb29,apb21,apb22,apb34,'',   #FUN-680110 add '',''  #No.TQC-7B0083
                 apb06,apb07,apb12,apb27, #FUN-630055 add apb31
                #apb09,apb28,apb35,apb36,apb31,'','',apb25,'',apb251,'',apb26,'','','',apb23,apb24,apb08,apb10,apb04,apb05  #MOD-770044   #MOD-7A0124 #TQC-B20109 mark
                 apb09,apb28,apb35,apb36,apb31,'','',apb25,'',apb251,'',apb26,'','','',apb23,apb24,apb08,apb10,  #MOD-770044   #MOD-7A0124            #TQC-B20109 move apb04,apb05
                 apbud01,apbud02,apbud03,apbud04,apbud05,              #TQC-B20109
                 apbud06,apbud07,apbud08,apbud09,apbud10,              #TQC-B20109
                 apbud11,apbud12,apbud13,apbud14,apbud15,apb04,apb05   #TQC-B20109
        #FUN-810045 end
            FROM apb_file
           WHERE apb01 = g_apa.apa01
           ORDER BY apb02

         LET l_ac = 1
         MESSAGE 'foreach apb !'

         #FOREACH t110_r_cur INTO g_apb[l_ac].*   #MOD-7A0124
         FOREACH t110_r_cur INTO g_apb[l_ac].*,g_apb04_t,g_apb05_t   #MOD-7A0124
            IF STATUS THEN
              CALL cl_err('for apb:',STATUS,1)  
              LET g_success = 'N'
              EXIT FOREACH
            END IF

            #No.TQC-7B0083  --Begin
            ##start FUN-680110 add
            # #沖暫估否
            # LET g_apb[l_ac].rvv40=t110_set_rvv40(g_apb[l_ac].apb21,g_apb[l_ac].apb22)
            # DISPLAY BY NAME g_apb[l_ac].rvv40
            # #暫估帳款單號
            # LET g_apb[l_ac].apb01_unap=t110_set_apb01_unap(g_apb[l_ac].apb21,g_apb[l_ac].apb22)
            # DISPLAY BY NAME g_apb[l_ac].apb01_unap
            ##end FUN-680110 add
            LET g_apb[l_ac].apb01_unap=t110_set_apb01_unap(g_apb[l_ac].apb21,g_apb[l_ac].apb22,g_apb[l_ac].apb34)
            DISPLAY BY NAME g_apb[l_ac].apb01_unap
            #No.TQC-7B0083  --End  

            MESSAGE 'del apb :',l_ac
           #IF g_apa.apa08 = 'UNAP' THEN                                     #TQC-B70131 mark
            IF g_apa.apa08 = 'UNAP' AND NOT cl_null(g_apb[l_ac].apb21) AND NOT cl_null(g_apb[l_ac].apb22) THEN #TQC-B70131
               UPDATE rvv_file SET rvv40 = 'N'
                WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
               IF STATUS THEN
#                 CALL cl_err('upd rvv40',STATUS,1)   #No.FUN-660122
                  CALL cl_err3("upd","rvv_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","upd rvv40",1)  #No.FUN-660122
                  LET g_success='N'
                  EXIT FOREACH
               END IF
            END IF

            #No.TQC-7B0083  --Begin  所有rvv23/rvv88的處理移至t110_bu中
            ##No.TQC-740030 --start--
            ##No.TQC-750181 --start--
            #SELECT rvv40 INTO l_rvv40 FROM rvv_file
            # WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
            #IF l_rvv40 = 'N' THEN
            #   UPDATE rvv_file SET rvv23 = rvv23 - g_apb[l_ac].apb09
            #    WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
            #   IF STATUS THEN
            #      CALL cl_err3("upd","rvv_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","upd rvv23",1)
            #      LET g_success='N'
            #      EXIT FOREACH
            #   END IF
            #ELSE
            #   IF g_apa.apa00 = '16' THEN
            ##No.TQC-750181 --end--
            #      UPDATE rvv_file SET rvv23 = rvv23 - g_apb[l_ac].apb09
            #       WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
            #      IF STATUS THEN
            #         CALL cl_err3("upd","rvv_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","upd rvv23",1)
            #         LET g_success='N'
            #         EXIT FOREACH
            #      END IF
            ##No.TQC-740030 --end--
            #   END IF #No.TQC-750181
            #END IF    #No.TQC-750181
            #No.TQC-7B0083  --End  

            DELETE FROM apb_file
             WHERE apb01 = g_apa.apa01
               AND apb02 = g_apb[l_ac].apb02
            IF STATUS OR SQLCA.SQLCODE THEN
#              CALL cl_err('del apb:',SQLCA.SQLCODE,1)   #No.FUN-660122
               CALL cl_err3("del","apb_file",g_apa.apa01, g_apb[l_ac].apb02,SQLCA.sqlcode,"","del apb:",1)  #No.FUN-660122
               LET g_success = 'N'
               EXIT FOREACH
            END IF
            LET g_apb_t.* = g_apb[l_ac].*

            MESSAGE 'update body !'
            CALL t110_bu(0,1)
            IF g_success = 'N' THEN
               EXIT FOREACH
            END IF
         END FOREACH

         #-----TQC-6C0044---------
         DECLARE t110_r_cur3 CURSOR WITH HOLD FOR
              SELECT aph04,aph03,aph05f,aph05 FROM aph_file WHERE aph01 = g_apa.apa01     #MOD-A20108 add aph03,aph05f,aph05
              AND aph03 IN ('6','7','8','9')   #MOD-740057   #MOD-870194
         MESSAGE 'foreach aph !'
         FOREACH t110_r_cur3 INTO l_aph04,l_aph03,l_aph05f,l_aph05          #MOD-A20108 add l_aph03,l_aph05f,l_aph05
            IF STATUS THEN
               CALL cl_err('for aph:',STATUS,1)
               LET g_success = 'N'
               EXIT FOREACH
            END IF

            #-----MOD-770001--------- 
            #MESSAGE 'del apg !'
            #DELETE FROM apg_file WHERE apg01 = g_apa.apa01
            #
            #IF STATUS OR SQLCA.SQLCODE THEN
            #   CALL cl_err('del apg:',SQLCA.SQLCODE,1)
            #   LET g_success = 'N'
            #   EXIT FOREACH
            #END IF
            #
            #MESSAGE 'del aph !'
            #DELETE FROM aph_file WHERE aph01 = g_apa.apa01
            #
            #IF STATUS OR SQLCA.SQLCODE THEN
            #   CALL cl_err('del aph:',SQLCA.SQLCODE,1)
            #   LET g_success = 'N'
            #   EXIT FOREACH
            #END IF
            #-----END MOD-770001-----
 
            SELECT sum(aph05f),sum(aph05) INTO g_amt1f,g_amt1
              FROM aph_file,apf_file
             WHERE aph04=l_aph04
               AND aph01=apf01
               AND apf41='Y'
               AND aph03 IN ('6','7','8','9')
 
            IF g_amt1f IS NULL THEN
               LET g_amt1f= 0
               LET g_amt1 = 0
            END IF
 
            SELECT sum(apv04f),sum(apv04) INTO g_amt2f,g_amt2
              FROM apv_file WHERE apv03=l_aph04
 
            IF g_amt2f IS NULL THEN
               LET g_amt2f= 0
               LET g_amt2 = 0
            END IF
 
            SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
              FROM oob_file,ooa_file
             WHERE oob01 = ooa01
               AND oob06 = l_aph04
               AND oob03 = '2' AND oob04 = '9'
               AND ooaconf = 'Y' #須為已確認
 
            IF cl_null(g_amt3f) THEN
               LET g_amt3f = 0
               LET g_amt3 = 0
            END IF
 
            SELECT SUM(aqb04) INTO g_amt4 FROM aqa_file,aqb_file
             WHERE aqa01 = aqb01 AND aqa04='Y' AND aqaconf = 'Y'
               AND aqb02=l_aph04
            IF cl_null(g_amt4) THEN
               LET g_amt4=0
               LET g_amt4f=0
            END IF
            SELECT apa14 INTO l_apa14 FROM apa_file WHERE apa01=l_aph04
            LET g_amt4f=g_amt4/l_apa14
 
            LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f
            LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4
 
            CALL t110_comp_oox(l_aph04) RETURNING g_net
 
            UPDATE apa_file SET apa35f=g_amt1f,
                                apa35 =g_amt1,
                                apa73 =apa34 - g_amt1 + g_net
             WHERE apa01 = l_aph04
           #MOD-A20108---add---start---
           #IF l_aph03 = '8' THEN                               #MOD-A50011 mark
            IF l_aph03 = '6' OR l_aph03 = '7' OR l_aph03 = '8' OR l_aph03 = '9' THEN  #MOD-A50011 add
               IF l_aph05f IS NULL THEN
                  LET l_aph05f= 0
                  LET l_aph05 = 0
               END IF
               UPDATE apc_file SET apc10=apc10-l_aph05f,
                                   apc11=apc11-l_aph05,
                                   apc13=apc13+l_aph05         #MOD-A50011 add
                WHERE apc01=l_aph04
            END IF
           #MOD-A20108---add---end---
 
            #IF STATUS OR SQLCA.SQLCODE THEN   #MOD-730098
            IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
               #CALL cl_err('upd apa:',SQLCA.SQLCODE,1)   #MOD-730098
               CALL cl_err3("upd","apa_file",l_aph04,"",STATUS,"","upd apa:",1)   #MOD-730098
               LET g_success = 'N'
               EXIT FOREACH
            END IF
         END FOREACH
         #-----END TQC-6C0044-----
        #str MOD-850245 add
        #搬到t110_r_cur3後刪除,因為t110_r_cur3會抓aph_file
         MESSAGE 'del aph !'
         DELETE FROM aph_file WHERE aph01 = g_apa.apa01
         IF STATUS OR SQLCA.SQLCODE THEN
            CALL cl_err('del aph:',SQLCA.SQLCODE,1)
            LET g_success = 'N'
            EXIT WHILE
         END IF
        #end MOD-850245 add

         DECLARE t110_r_cur2 CURSOR WITH HOLD FOR
              SELECT apv02,apv03,apv04,apv05 FROM apv_file WHERE apv01 = g_apa.apa01    #No.FUN-680027

         MESSAGE 'foreach apv !'
         FOREACH t110_r_cur2 INTO l_apv02,l_apv03,l_apv04,l_apv05      #No.FUN-680027
            IF STATUS THEN
               CALL cl_err('for apv:',STATUS,1)   
               LET g_success = 'N'
               EXIT FOREACH
            END IF

            MESSAGE 'del apv !',l_ac
            DELETE FROM apv_file WHERE apv01 = g_apa.apa01 AND apv02 = l_apv02
            IF STATUS OR SQLCA.SQLCODE THEN
#              CALL cl_err('del apv:',SQLCA.SQLCODE,1)   #No.FUN-660122
               CALL cl_err3("del","apv_file",g_apa.apa01,l_apv02,SQLCA.sqlcode,"","del apv:",1)  #No.FUN-660122
               LET g_success = 'N' EXIT FOREACH
            END IF
            IF l_apv03 <> 'DIFF' THEN   #MOD-830234
               SELECT sum(aph05f),sum(aph05) INTO g_amt1f,g_amt1
                 FROM aph_file,apf_file
                WHERE aph04=l_apv03
                  AND aph01=apf01
                  AND apf41='Y'
                  AND aph03 IN ('6','7','8','9')
               
               IF g_amt1f IS NULL THEN
                  LET g_amt1f= 0
                  LET g_amt1 = 0
               END IF
               
               SELECT sum(apv04f),sum(apv04) INTO g_amt2f,g_amt2
                 FROM apv_file WHERE apv03=l_apv03
               
               IF g_amt2f IS NULL THEN
                  LET g_amt2f= 0
                  LET g_amt2 = 0
               END IF
               
               SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                 FROM oob_file,ooa_file
                WHERE oob01 = ooa01
                  AND oob06 = l_apv03
                  AND oob03 = '2' AND oob04 = '9'
                  AND ooaconf = 'Y' #須為已確認
               
               IF cl_null(g_amt3f) THEN
                  LET g_amt3f = 0
                  LET g_amt3 = 0
               END IF
               
               #-----TQC-6C0044---------
               #成本分攤
               SELECT SUM(aqb04) INTO g_amt4 FROM aqa_file,aqb_file
                WHERE aqa01 = aqb01 AND aqa04='Y' AND aqaconf = 'Y'
                  AND aqb02=l_apv03
               IF cl_null(g_amt4) THEN
                  LET g_amt4=0
                  LET g_amt4f=0
               END IF
               SELECT apa14 INTO l_apa14 FROM apa_file WHERE apa01=l_apv03
               LET g_amt4f=g_amt4/l_apa14
               LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f
               LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4
               
               #-----END TQC-6C0044-----
               
               #No.MOD-590312  --begin
               CALL t110_comp_oox(l_apv03) RETURNING g_net
               UPDATE apa_file SET apa35f=g_amt1f,
                                   apa35 =g_amt1,
                                   apa73 =apa34 - g_amt1 + g_net
                               #    apa65f=g_amt2f,    #No:9468
                               #    apa65 =g_amt2
                WHERE apa01 = l_apv03
               #No.MOD-590312  --end
               
               #IF STATUS OR SQLCA.SQLCODE THEN   #MOD-730098
               IF STATUS OR SQLCA.SQLERRD[3]=0  THEN   #MOD-730098
#                 CALL cl_err('upd apa:',SQLCA.SQLCODE,1)   #No.FUN-660122
                  CALL cl_err3("upd","apa_file",l_apv03,"",SQLCA.sqlcode,"","upd apa:",1)  #No.FUN-660122
                  LET g_success = 'N'
                  EXIT FOREACH
               END IF
               #No.FUN-680027--begin
               SELECT sum(aph05f),sum(aph05) INTO g_amt1f,g_amt1
                 FROM aph_file,apf_file
                WHERE aph04=l_apv03
                  AND aph01=apf01
                  AND apf41='Y'
                  AND aph03 IN ('6','7','8','9')
#                 AND aph17 = l_apv05
                  AND aph17 = 1                  #No.TQC-6B0066
               
               IF g_amt1f IS NULL THEN
                  LET g_amt1f= 0
                  LET g_amt1 = 0
               END IF
               
               SELECT sum(apv04f),sum(apv04) INTO g_amt2f,g_amt2
                 FROM apv_file WHERE apv03=l_apv03
                                 AND apv05 = l_apv05
               
               IF g_amt2f IS NULL THEN
                  LET g_amt2f= 0
                  LET g_amt2 = 0
               END IF
               
               SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                 FROM oob_file,ooa_file
                WHERE oob01 = ooa01
                  AND oob06 = l_apv03
                  AND oob03 = '2' AND oob04 = '9'
                  AND ooaconf = 'Y' #須為已確認
#                 AND oob19 = l_apv05
                  AND oob19 = 1               #No.TQC-6B0066
               
               IF cl_null(g_amt3f) THEN
                  LET g_amt3f = 0
                  LET g_amt3 = 0
               END IF
               
               LET g_amt1f = g_amt1f + g_amt3f + g_amt2f + g_amt4f   #TQC-C70079  add   g_amt4f
               LET g_amt1  = g_amt1  + g_amt3 + g_amt2 + g_amt4      #TQC-C70079  add   g_amt4
               CALL t110_comp_oox(l_apv03) RETURNING g_net
               UPDATE apc_file SET apc10 =g_amt1f,
                                   apc11 =g_amt1,
                                   apc13 =apc09 - g_amt1 + g_net
                WHERE apc01 = l_apv03
#                 AND apc02 = l_apv05
                  AND apc02 = 1              #No.TQC-6B0066
               
               IF STATUS OR SQLCA.SQLCODE THEN
                  CALL cl_err3("upd","apc_file",l_apv03,"",SQLCA.sqlcode,"","upd apc:",1) 
                  LET g_success = 'N'
                  EXIT FOREACH
               END IF
               #No.FUN-680027--end
            END IF   #MOD-830234

            IF g_success = 'N' THEN
               EXIT FOREACH
            END IF

         END FOREACH
         EXIT WHILE
      END WHILE

      IF g_success='Y' THEN
         LET l_apa01=g_apa.apa01   #MOD-910197 add
         INITIALIZE g_apa.* TO NULL
         CLEAR FORM
         CALL g_apb.clear()
         CALL g_apk.clear()
         CALL g_api.clear()
         OPEN t110_count
         FETCH t110_count INTO g_row_count
         DISPLAY g_row_count TO FORMONLY.cnt
         OPEN t110_cs
         IF g_curs_index = g_row_count + 1 THEN
            LET g_jump = g_row_count
            CALL t110_fetch('L')
         ELSE
            LET g_jump = g_curs_index
            LET g_no_ask = TRUE
            CALL t110_fetch('/')
         END IF
      END IF
   END IF

#str MOD-910197 mod  移到COMMIT前
#MOD-590460 aapt110於delete時,也要insert into azo_file
   LET g_msg = TIME
   INSERT INTO azo_file (azo01,azo02,azo03,azo04,azo05,azo06)
      #VALUES('aapt110',g_user,g_today,g_msg,g_apa.apa01,'delete')  #MOD-910197 mark
      #VALUES('aapt110',g_user,g_today,g_msg,l_apa01,'delete')      #MOD-910197      #MOD-AC0328 mark
       VALUES(g_prog,g_user,g_today,g_msg,l_apa01,'delete')         #MOD-910197      #MOD-AC0328
#END MOD-590460
#end MOD-910197 mod  移到COMMIT前

   IF g_success = 'Y' THEN
      COMMIT WORK
      CALL cl_flow_notify(g_apa.apa01,'D')
   ELSE
      ROLLBACK WORK
   END IF

   CLOSE t110_cl

END FUNCTION

FUNCTION t110_b(p_code)
DEFINE p_code          LIKE type_file.chr1,    # No:FUN-690028 VARCHAR(01),
       l_ac_t          LIKE type_file.num5,    #未取消的ARRAY CNT  #No.FUN-690028 SMALLINT
       l_vendor        LIKE rvv_file.rvv06,    #FUN-660117 #CHAR(10)
       l_message       LIKE type_file.chr1000, # No:FUN-690028 VARCHAR(70),
       l_n             LIKE type_file.num5,    #檢查重複用  #No.FUN-690028 SMALLINT
       l_n1            LIKE type_file.num5,    #No:FUN-8A0075
       l_lock_sw       LIKE type_file.chr1,    #單身鎖住否  #No.FUN-690028 VARCHAR(1)
       p_cmd           LIKE type_file.chr1,    #處理狀態  #No.FUN-690028 VARCHAR(1)
       apb10_o         LIKE apb_file.apb10,    #FUN-4B0079
       l_cnt           LIKE type_file.num5,    #No.FUN-690028 SMALLINT
       g_apk           RECORD LIKE apk_file.*,
       g_t1            LIKE oay_file.oayslip,  #No.FUN-550030  #No.FUN-690028 VARCHAR(5)
       l_apa06         LIKE apa_file.apa06,
       l_smy59         LIKE smy_file.smy59,
       l_pmn67         LIKE pmn_file.pmn67,
       l_pmn40         LIKE pmn_file.pmn40,
       l_rvv38         LIKE rvv_file.rvv38,
       l_rvv38t        LIKE rvv_file.rvv38t, #TQC-8A0079 add
       l_allow_insert  LIKE type_file.num5,  #可新增否  #No.FUN-690028 SMALLINT
       l_allow_delete  LIKE type_file.num5,  #可刪除否  #No.FUN-690028 SMALLINT
       l_azi04         LIKE azi_file.azi04,
       l_aag05         LIKE aag_file.aag05,  #No:MOD-530422
       l_apa63         LIKE apa_file.apa63,  #FUN-550042
       l_rvv32         LIKE rvv_file.rvv32,  #TQC-5B0016
       l_rvv33         LIKE rvv_file.rvv33,  #TQC-5B0016
       l_apb10         LIKE apb_file.apb10,  #No.TQC-7B0083
       l_apb24         LIKE apb_file.apb24,  #No.TQC-7B0083
       l_apk01         LIKE apk_file.apk01,  #MOD-850114 add
       l_pjb09         LIKE pjb_file.pjb09,  #No.FUN-850027 
       l_pjb11         LIKE pjb_file.pjb11,  #No.FUN-850027
       l_exit_sw       LIKE type_file.chr1,  #MOD-860303 add
       l_pmc913        LIKE pmc_file.pmc913, #No:FUN-880094
       l_pmn87         LIKE pmn_file.pmn87,  #No:FUN-880094
       l_pmn31         LIKE pmn_file.pmn31,  #No:FUN-880094
       l_gec04         LIKE gec_file.gec04,  #TQC-8A0079 add
       l_gec07         LIKE gec_file.gec07,  #TQC-8A0079 add
       l_apb24t        LIKE apb_file.apb24,  #MOD-920013 add
       l_gec05         LIKE gec_file.gec05,  #MOD-950138
       l_qty1          LIKE apb_file.apb09,  #No.MOD-940329
       l_qty2          LIKE apb_file.apb09,  #No.MOD-940329
       l_pmn31t        LIKE pmn_file.pmn31t, #No:MOD-970049
       l_apa31f        LIKE apa_file.apa31f, #MOD-980032 add 
       l_pmm40         LIKE pmm_file.pmm40,  #MOD-980032 add 
       l_pmm40t        LIKE pmm_file.pmm40t, #CHI-9C0015 add 
       l_pmn87_pmn31t  LIKE pmn_file.pmn31t, #MOD-9A0032 add
       l_apb01         LIKE apb_file.apb01,  #MOD-9B0048 add
       l_apa31f0       LIKE apa_file.apa31f, #MOD-9B0048 add 
       l_sql           STRING,               #MOD-9C0264 add
       l_pmm43         LIKE pmm_file.pmm43,  #CHI-9C0015 add
       l_apb09_15      LIKE apb_file.apb09,  #CHI-B70013 add
       l_apa32         LIKE apa_file.apa32   #No.MOD-B80140 add
#No.MOD-A20009 --begin
DEFINE l_year    LIKE type_file.num5
DEFINE l_month   LIKE type_file.num5
DEFINE l_apa32f  LIKE apa_file.apa32f        #MOD-A80052   
#No.MOD-A20009 --end
DEFINE l_err          STRING,       #MOD-A20113 add
       #-----MOD-A40078---------
       l_rvu99    LIKE rvu_file.rvu99,
       l_rvu99_1  STRING,
       i,j        INTEGER,
       l_poz19    LIKE poz_file.poz19,
       l_poz18    LIKE poz_file.poz18 
       #-----END MOD-A40078-----
DEFINE l_change    LIKE type_file.chr1     #No.MOD-B80053 add 是否有新增、修改、刪除的動作
DEFINE l_diffamt   LIKE api_file.api05     #MOD-C20104
DEFINE l_chkamt    LIKE apa_file.apa34f    #MOD-C20104
DEFINE l_apa73     LIKE apa_file.apa73     #MOD-C20104
DEFINE l_api03     LIKE api_file.api03     #MOD-C20104
DEFINE l_api26     LIKE api_file.api26     #MOD-C20104
DEFINE l_sumapi05f LIKE api_file.api05f    #MOD-C20104
DEFINE l_sumapi05  LIKE api_file.api05     #MOD-C20104
DEFINE l_apk06     LIKE apk_file.apk06     #MOD-C50035 add
DEFINE l_apk08     LIKE apk_file.apk08     #MOD-C50035 add
DEFINE l_sum_rvv87 LIKE rvv_file.rvv87     #TQC-C60241  add
DEFINE l_sum_apb09 LIKE apb_file.apb09     #TQC-C60241  add
DEFINE l_apb09     LIKE apb_file.apb09     #TQC-C60241  add
 
    LET g_action_choice = ""
    IF s_aapshut(0) THEN
       RETURN
    END IF

    IF g_apb_sarrno = 0 THEN
       RETURN
    ELSE
#       CALL t110_b_fill(' 1=1')
       CALL t110_b_fill(g_wc2)    #No.MOD-AC0130
    END IF

    IF g_apa.apa01 IS NULL THEN
       RETURN
    END IF
 
    #No:FUN-8A0075--BEGIN-- 
    IF g_apa.apa63 matches '[Ss]' THEN
       SELECT count(*) INTO l_n1 FROM apb_file WHERE apb01=g_apa.apa01
       IF l_n1 = 0 THEN
          RETURN
       END IF
    END IF
    #No:FUN-8A0075--END--

    SELECT * INTO g_apa.* FROM apa_file WHERE apa01=g_apa.apa01
    LET l_apa63 = g_apa.apa63              #FUN-550042

    IF g_apa.apa41 = 'Y' THEN
       CALL cl_err('apa41=Y','aap-086',0)
       RETURN
    END IF
    #No:FUN-8A0075--EBGIN--
    #IF g_apa.apa63 matches '[Ss]' THEN       #FUN-550042
    #   CALL cl_err('','apm-030',0)
    #   RETURN
    #END IF
    #No:FUN-8A0075--END
    IF g_apa.apa42 = 'Y' THEN
       CALL cl_err('apa42=Y','aap-165',0)
       RETURN
    END IF

    IF g_apa.apa75 = 'Y' THEN
       CALL cl_err('apa75=Y','aap-333',0)
       RETURN
    END IF

    #No.MOD-5B0053 --begin
    IF g_apz.apz27 = 'N' THEN
       IF g_apa.apa55='1' AND g_apa.apa35>0 AND (g_apa.apa34<=g_apa.apa35) THEN
          CALL cl_err('unpay<=0','aap-172',0)
          RETURN
       END IF
    ELSE
       IF g_apa.apa55='1' AND g_apa.apa35>0 AND (g_apa.apa73<=0) THEN
          CALL cl_err('unpay<=0','aap-172',0)
          RETURN
       END IF
    END IF
    #No.MOD-5B0053 --end

    IF NOT cl_null(g_apa.apa44) THEN   #No:MOD-670056
       IF NOT s_chkpost(g_apa.apa44,g_apa.apa01) THEN
          RETURN
       END IF
    END IF

    IF g_apa.apa00='21' THEN
       IF NOT cl_null(g_apa.apa08) THEN
          SELECT COUNT(*) INTO l_n FROM apb_file
           WHERE apb01=g_apa.apa08 AND apb16='Y'
          IF l_n > 0 THEN
             CALL cl_err(g_apa.apa08,'aap-289',0)
             RETURN
          END IF
       END IF
    END IF
   #-MOD-A90181-add-
    SELECT pmc913 INTO l_pmc913 FROM pmc_file 
     WHERE pmc01 = g_apa.apa05
   #-MOD-A90181-end-

    CALL cl_opmsg('b')
   
   #FUN-810045
    #LET g_forupd_sql = "SELECT apb02,apb33,apb11,apb29,apb21,apb31,apb30,apb22,apb34,'',apb06,apb07,",           #FUN-630055 add apb31 #No.FUN-690080  #No.TQC-7B0083
    #                   "       apb12,apb27,apb09,apb28,apb32,apb25,'',apb251,'',apb26,'',apb930,'',apb23, ",  #FUN-710078 '','',''  #FUN-670064           #No.FUN-680029 #No.FUN-690080
    LET g_forupd_sql = "SELECT apb02,apb33,apb11,apb29,apb21,apb22,apb34,'',apb06,apb07,",           #FUN-630055 add apb31 #No.FUN-690080  #No.TQC-7B0083
                     # "       apb12,apb27,apb09,apb28,apb35,apb36,apb31,apb30,apb32,apb25,'',apb251,'',apb26,'',apb930,'',apb23, ",  #FUN-710078 '','',''  #FUN-670064           #No.FUN-680029 #No.FUN-690080  #No.FUN-830161 remove apb30
                       "       apb12,apb27,apb09,apb28,apb35,apb36,apb31,apb32,'',apb25,'',apb251,'',apb26,'',apb930,'',apb23, ",  #FUN-710078 '','',''  #FUN-670064           #No.FUN-680029 #No.FUN-690080  #No.FUN-830161 remove apb30 #FUN-990025 ''
   #FUN-810045 end
                       "       apb24,apb08,apb10,",
                       #No:FUN-850038 --start--
                       "       apbud01,apbud02,apbud03,apbud04,apbud05,",
                       "       apbud06,apbud07,apbud08,apbud09,apbud10,",
                       "       apbud11,apbud12,apbud13,apbud14,apbud15 ",
                       #No:FUN-850038 ---end---
                       "      ,apb04,apb05",   #MOD-940358 mod
                       "  FROM apb_file",                  
                       " WHERE apb01=? AND apb02=? FOR UPDATE NOWAIT"                                

    DECLARE t110_bcl CURSOR FROM g_forupd_sql      # LOCK CURSOR            

    LET g_apa.apamodu=g_user
    LET g_apa.apadate=g_today
    DISPLAY BY NAME g_apa.apamodu,g_apa.apadate
    IF g_apa.apa63 NOT matches '[Ss]' THEN   #No:FUN-8A0075 
       LET l_allow_insert = cl_detail_input_auth("insert")
       LET l_allow_delete = cl_detail_input_auth("delete")
    ELSE
       LET l_allow_insert = FALSE            #No:FUN-8A0075
       LET l_allow_delete = FALSE            #No;FUN-8A0075
    END IF 
    LET l_change = 'N'                       #No.MOD-B80053 add

  WHILE TRUE                                       #MOD-550063
    LET l_exit_sw = 'y'   #MOD-860303 add
    INPUT ARRAY g_apb WITHOUT DEFAULTS FROM s_apb.*
          ATTRIBUTE(COUNT=g_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                    INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)

        BEFORE INPUT
           IF g_rec_b != 0 THEN
              CALL fgl_set_arr_curr(l_ac)
           END IF

            #MOD-4A0207
#          IF NOT (g_aza.aza26 = '2' AND g_aza.aza25 = 'Y') THEN
           IF NOT (g_aza.aza26 = '2' AND g_aza.aza46 = 'Y') THEN   #No.FUN-580006
              CALL cl_set_act_visible("enter_invoice",FALSE)
           END IF
           #--

        BEFORE ROW
           LET p_cmd=''
           LET l_ac = ARR_CURR()
           LET l_lock_sw = 'N'            #DEFAULT
           LET l_n  = ARR_COUNT()
           LET g_success = 'Y'
           BEGIN WORK
           CALL t110_lock_cl()  #FUN-C80078 add
           OPEN t110_cl USING g_apa_rowid
           IF STATUS THEN
              CALL cl_err("OPEN t110_cl b:", STATUS, 1)
              CLOSE t110_cl
              ROLLBACK WORK
              RETURN
           END IF
           FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
           IF SQLCA.sqlcode THEN
              CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
              CLOSE t110_cl
              ROLLBACK WORK
              RETURN
           END IF
           IF g_rec_b >= l_ac THEN
              LET p_cmd='u'
              LET g_apb_t.* = g_apb[l_ac].*  #BACKUP
              OPEN t110_bcl USING g_apa.apa01,g_apb_t.apb02
              IF STATUS THEN
                 CALL cl_err("OPEN t110_bcl:", STATUS, 1)
                 LET l_lock_sw = "Y"
              END IF
              FETCH t110_bcl INTO g_apb[l_ac].*,g_apb04,g_apb05
              IF SQLCA.sqlcode THEN
                 CALL cl_err(g_apb_t.apb02,SQLCA.sqlcode,1)
                 LET l_lock_sw = "Y"
              END IF

             #FUN-710078---add---str--- 
              SELECT aag02 INTO g_apb[l_ac].b25 
                FROM aag_file 
               WHERE aag01=g_apb[l_ac].apb25 
                 AND aag00=g_bookno1   #MOD-840649
                 AND aagacti = 'Y'     #No.MOD-B70280 add


              SELECT aag02 INTO g_apb[l_ac].b251 
                FROM aag_file 
               WHERE aag01=g_apb[l_ac].apb251 
                 AND aag00=g_bookno2   #MOD-840649
                 AND aagacti = 'Y'     #No.MOD-B70280 add

        
              SELECT gem02 INTO g_apb[l_ac].b26 
                FROM gem_file 
               WHERE gem01=g_apb[l_ac].apb26 
             #FUN-710078---add---end--- 
             
             #FUN-990025---Begin
              SELECT gen02 INTO g_apb[l_ac].b32
                FROM gen_file 
               WHERE gen01=g_apb[l_ac].apb32

             #start FUN-680110 add
              #沖暫估否
              #LET g_apb[l_ac].rvv40=t110_set_rvv40(g_apb[l_ac].apb21,g_apb[l_ac].apb22)  #No.TQC-7B0083
              #暫估帳款單號
              LET g_apb[l_ac].apb01_unap=t110_set_apb01_unap(g_apb[l_ac].apb21,g_apb[l_ac].apb22,g_apb[l_ac].apb34)  #No.TQC-7B0083
             #end FUN-680110 add
              LET g_apb[l_ac].gem02c=t110_set_apa930(g_apb[l_ac].apb930) #FUN-670064
              LET g_before_input_done = FALSE
              CALL t110_set_entry_b(p_cmd)
              CALL t110_set_entry_b_1()  #No:FUN-8A0075
              CALL t110_set_no_entry_b(p_cmd)
              CALL t110_set_no_entry_b_1()  #No:FUN-8A0075
              LET g_before_input_done = TRUE
              LET g_apb04_t = g_apb04
              LET g_apb05_t = g_apb05
#             CALL cl_show_rate_comment()   #No:FUN-530015
              CALL cl_show_fld_cont()     #FUN-550037(smin)
           END IF

        BEFORE INSERT
           LET l_n = ARR_COUNT()
           LET p_cmd='a'
           INITIALIZE g_apb[l_ac].* TO NULL      #900423
           LET g_apb[l_ac].apb08 = 0
           LET g_apb[l_ac].apb09 = 0
           LET g_apb[l_ac].apb10 = 0
           LET g_apb[l_ac].apb23 = 0
           LET g_apb[l_ac].apb24 = 0
           LET g_apb[l_ac].apb34 = 'N'  #No.TQC-7B0083
           IF g_aptype MATCHES '1*' THEN
              LET g_apb[l_ac].apb29 = '1'
           ELSE
              LET g_apb[l_ac].apb29 = '3'
           END IF
           IF l_ac>1 AND g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' THEN
              LET g_apb[l_ac].apb25 = g_apb[l_ac-1].apb25
              LET g_apb[l_ac].apb251= g_apb[l_ac-1].apb251             #No.FUN-680029
              LET g_apb[l_ac].apb26 = g_apb[l_ac-1].apb26
           END IF
           LET g_apb[l_ac].apb930=g_apa.apa930 #FUN-670064
           LET g_apb[l_ac].gem02c=s_costcenter_desc(g_apb[l_ac].apb930) #FUN-670064

         #FUN-810045 begin
           IF NOT cl_null(g_apa.apa66) THEN
             LET g_apb[l_ac].apb35 = g_apa.apa66
           END IF
         #FUN-810045 end

           LET g_apb_t.* = g_apb[l_ac].*         #新輸入資料
           LET g_apb04_t = g_apb04
           LET g_apb05_t = g_apb05
           LET g_before_input_done = FALSE
           CALL t110_set_entry_b(p_cmd)
           CALL t110_set_entry_b_1()  #No:FUN-8A0075
           CALL t110_set_no_entry_b(p_cmd)
           CALL t110_set_no_entry_b_1()  #No:FUN-8A0075
           LET g_before_input_done = TRUE
           CALL cl_show_fld_cont()     #FUN-550037(smin)
           NEXT FIELD apb02

        AFTER INSERT
           IF INT_FLAG THEN
              CALL cl_err('',9001,0)
              LET INT_FLAG = 0
              CANCEL INSERT
           END IF
           #TQC-C60241--add--str--
            IF g_apa.apa00 = '26' THEN
               IF g_apb[l_ac].apb29 = '3' THEN
                  SELECT SUM(rvv87) INTO l_sum_rvv87
                    FROM rvv_file
                   WHERE rvv01 = g_apb[l_ac].apb21
                     AND rvv02 = g_apb[l_ac].apb22
                  SELECT SUM(apb09) INTO l_sum_apb09
                    FROM apb_file,apa_file
                   WHERE apb21 = g_apb[l_ac].apb21
                     AND apb22 = g_apb[l_ac].apb22
                     AND apa00 = '26'
                     AND apa01 = apb01
                  SELECT apb09 INTO l_apb09
                    FROM apb_file,apa_file
                   WHERE apb21 = g_apb[l_ac].apb21
                     AND apb02 = g_apb[l_ac].apb02
                     AND apa00 = '26'
                     AND apa01 = apb01
                     AND apa01 = g_apa.apa01
                  IF cl_null(l_sum_rvv87) THEN
                     LET l_sum_rvv87 = 0
                  END IF
                  IF cl_null(l_apb09) THEN
                     LET l_apb09 = 0
                  END IF
                  IF cl_null(l_sum_apb09) THEN
                     LET l_sum_apb09 = 0
                  END IF
                  IF l_sum_apb09 + g_apb[l_ac].apb09 - l_apb09 > l_sum_rvv87 THEN
                     CALL cl_err('','aap-240',1)
                     CANCEL INSERT
                  END IF
               END IF
            END IF
            #TQC-C60241--add--end-- 
#MOD-590460   insert apk的部份重複,故將該段mark起來
##MOD-580043
#           IF g_apa.apa00[1,1]='2' AND g_apa.apa58 <> '1' THEN
#              IF t110_ins_apk() THEN  #新增失敗
#                 CALL cl_err(g_apb[l_ac].apb02,'aap-012',0)
#                 DISPLAY g_apb[l_ac].* TO s_apb[l_ac].*
#                 NEXT FIELD apb02
#              END IF
#           END IF
##END MOD-580043
#END MOD-590460
           IF g_apb[l_ac].apb06 IS NULL AND
              g_apb[l_ac].apb12 IS NULL AND
              g_apb[l_ac].apb09 = 0 AND
              g_apb[l_ac].apb24 = 0 THEN
              IF g_apb[l_ac].apb29 <> '3' THEN   #No:MOD-910062
                 CALL g_apb.deleteElement(l_ac)
                 NEXT FIELD apb02
                 CANCEL INSERT
              END IF
           END IF

#FUN-810045 remark 移至各欄位check
#           IF g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' AND
#              g_apb[l_ac].apb09 != 0 THEN
#              #CALL t110_b_more1(p_cmd)   #FUN-810045 remark
##No.FUN-680029--begin
#              IF g_aza.aza63 ='Y' THEN
#                 SELECT COUNT(*) INTO g_cnt FROM pnr_file
#                  #WHERE pnr01=g_apb30             #FUN-810045
#                  WHERE pnr01=g_apb[l_ac].apb30    #FUN-810045
#                    AND pnr02=g_apb[l_ac].apb251
#                    AND pnr03=g_apb[l_ac].apb26
#                 IF g_cnt=0 THEN
#                    #CALL cl_err(g_apb30,'apm-313',0)           #FUN-810045
#                    CALL cl_err(g_apb[l_ac].apb30,'apm-313',0)  #FUN-810045
#                    NEXT FIELD apb251
#                 END IF
#              END IF
##No.FUN-680029--end
#              SELECT COUNT(*) INTO g_cnt FROM pnr_file
#               #WHERE pnr01=g_apb30            #FUN-810045
#               WHERE pnr01=g_apb[l_ac].apb30   #FUN-810045
#                 AND pnr02=g_apb[l_ac].apb25
#                 AND pnr03=g_apb[l_ac].apb26
#              IF g_cnt=0 THEN
#                 #CALL cl_err(g_apb30,'apm-313',0)           #FUN-810045
#                 CALL cl_err(g_apb[l_ac].apb30,'apm-313',0)  #FUN-810045
#                 NEXT FIELD apb25
#              END IF
#           END IF
#FUN-810045 end
          #str MOD-940326 add
           LET l_aag05=''
           SELECT aag05 INTO l_aag05 FROM aag_file
            WHERE aag01 = g_apb[l_ac].apb25
              AND aag00 = g_bookno1
              AND aagacti = 'Y'     #No.MOD-B70280 add
           #防止User只修改科目或部門欄位時,未再次檢查會科與允許/拒絕部門關係
           LET g_errno = ' '   
           IF l_aag05 = 'Y' THEN
             #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
              IF g_aaz.aaz90 ='Y' THEN
                 IF NOT cl_null(g_apb[l_ac].apb930) THEN 
                    CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb25,g_apb[l_ac].apb930,g_bookno1)  
                                  RETURNING g_errno
                 END IF
              ELSE
                 IF NOT cl_null(g_apb[l_ac].apb26) THEN 
                    CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb25,g_apb[l_ac].apb26,g_bookno1)  
                                  RETURNING g_errno
                 END IF 
              END IF
              IF NOT cl_null(g_errno) THEN
                 CALL cl_err('',g_errno,0)
                 NEXT FIELD apb25
              END IF
           END IF
           IF g_aza.aza63='Y' THEN 
              LET l_aag05=''
              SELECT aag05 INTO l_aag05 FROM aag_file
               WHERE aag01 = g_apb[l_ac].apb251
                 AND aag00 = g_bookno2
                 AND aagacti = 'Y'     #No.MOD-B70280 add
              #防止User只修改科目或部門欄位時,未再次檢查會科與允許/拒絕部門關係
              LET g_errno = ' '   
              IF l_aag05 = 'Y' AND NOT cl_null(g_apb[l_ac].apb251) THEN
                 IF g_aaz.aaz90 ='Y' THEN
                    IF NOT cl_null(g_apb[l_ac].apb930) THEN
                       CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb251,g_apb[l_ac].apb930,g_bookno2)                
                                     RETURNING g_errno
                    END IF 
                 ELSE
                    IF NOT cl_null(g_apb[l_ac].apb26) THEN
                       CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb251,g_apb[l_ac].apb26,g_bookno2)                
                                     RETURNING g_errno
                    END IF
                 END IF
                 IF NOT cl_null(g_errno) THEN
                    CALL cl_err('',g_errno,0)
                    NEXT FIELD apb251
                 END IF
              END IF
           END IF
          #end MOD-940326 add
           INSERT INTO apb_file(apb01,apb02,apb11,apb21,apb31,apb22,apb06,apb07, #FUN-630055 add apb31
                                apb12,apb09,apb25,apb251,apb26,apb930,apb23,apb24,apb08,  #FUN-670064  No.FUN-680029
                                apb10,apb081,apb101,apb27,apb28,apb29,apb04,
                               #apb05,apb30,apb33,apb32,apb34,apb35,apb36)  #FUN-810045 add apb35/36                                  #No.FUN-690080  #No.TQC-7B0083  #No.FUN-830161  remove apb30
                                apb05,apb33,apb32,apb34,apb35,apb36,  #FUN-810045 add apb35/36                                  #No.FUN-690080  #No.TQC-7B0083  #No.FUN-830161  remove apb30
                               #FUN-850038 --start--
                                apbud01,apbud02,apbud03,
                                apbud04,apbud05,apbud06,
                                apbud07,apbud08,apbud09,
                                apbud10,apbud11,apbud12,
                                apbud13,apbud14,apbud15)
                               #FUN-850038 --end--
            VALUES(g_apa.apa01,g_apb[l_ac].apb02,g_apb[l_ac].apb11,
                   g_apb[l_ac].apb21,g_apb[l_ac].apb31,g_apb[l_ac].apb22,g_apb[l_ac].apb06, #FUN-630055 add apb31
                   g_apb[l_ac].apb07,g_apb[l_ac].apb12,g_apb[l_ac].apb09,
                   g_apb[l_ac].apb25,g_apb[l_ac].apb251,g_apb[l_ac].apb26,g_apb[l_ac].apb930,g_apb[l_ac].apb23, #FUN-670064   No.FUN-680029
                   g_apb[l_ac].apb24,g_apb[l_ac].apb08,g_apb[l_ac].apb10,
                   g_apb[l_ac].apb08,g_apb[l_ac].apb10,g_apb[l_ac].apb27,
                  #g_apb[l_ac].apb28,g_apb[l_ac].apb29,g_apb04,g_apb05,g_apb[l_ac].apb30,g_apb[l_ac].apb33,g_apb[l_ac].apb32,   #No.FUN-690080  #FUN-810045 g_apb30->g_apb[l_ac].apb30  #No.FUN-830161  remove apb30
                   g_apb[l_ac].apb28,g_apb[l_ac].apb29,g_apb04,g_apb05,g_apb[l_ac].apb33,g_apb[l_ac].apb32,   #No.FUN-690080  #FUN-810045 g_apb30->g_apb[l_ac].apb30  #No.FUN-830161  remove apb30
                   g_apb[l_ac].apb34,g_apb[l_ac].apb35,g_apb[l_ac].apb36,  #No.TQC-7B0083   #FUN-810045
                  #FUN-850038 --start--
                   g_apb[l_ac].apbud01,g_apb[l_ac].apbud02,
                   g_apb[l_ac].apbud03,g_apb[l_ac].apbud04,
                   g_apb[l_ac].apbud05,g_apb[l_ac].apbud06,
                   g_apb[l_ac].apbud07,g_apb[l_ac].apbud08,
                   g_apb[l_ac].apbud09,g_apb[l_ac].apbud10,
                   g_apb[l_ac].apbud11,g_apb[l_ac].apbud12,
                   g_apb[l_ac].apbud13,g_apb[l_ac].apbud14,
                   g_apb[l_ac].apbud15)
                  #FUN-850038 --end--
           IF SQLCA.sqlcode THEN
#             CALL cl_err(g_apb[l_ac].apb02,SQLCA.sqlcode,0)   #No.FUN-660122
              CALL cl_err3("ins","apb_file",g_apa.apa01,g_apb[l_ac].apb02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
              CANCEL INSERT
           ELSE
 #MOD-560240
              IF g_apa.apa08 = 'UNAP' THEN
                 UPDATE rvv_file SET rvv40 = 'Y'
                    WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
                 IF STATUS THEN
#                   CALL cl_err('upd rvv40',STATUS,1)   #No.FUN-660122
                    CALL cl_err3("upd","rvv_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","upd rvv40",1)  #No.FUN-660122
                    LET g_success='N'
                 END IF
              END IF
 #END MOD-560240
             #No.TQC-7B0083  --Begin
             ##str FUN-7A0050 add
             ##若輸入是沖費用暫估資料,則自動產生"沖暫估資料檔(api_file)"
             # IF g_aptype = '12' THEN
             #    LET l_cnt = 0
             #    SELECT COUNT(*) INTO l_cnt FROM apb_file
             #     WHERE apb01 = g_apb[l_ac].apb21
             #       AND apb02 = g_apb[l_ac].apb22
             #       AND apb21 IS NULL
             #       AND apb22 IS NULL
             #       AND apb01 IN (SELECT apa01 FROM apa_file WHERE apa00='16')
             #    IF l_cnt > 0 THEN
             #       CALL t110_ins_api_12()
             #    END IF
             # END IF 
             ##end FUN-7A0050 add
             #No.TQC-7B0083  --End  

              MESSAGE 'INSERT O.K'
              LET l_apa63 = '0'          #FUN-550042
              LET g_rec_b=g_rec_b+1
              DISPLAY g_rec_b TO FORMONLY.n2
              #No.TQC-7B0083  --Begin
              #若是衝暫估,則自動產生api資料
              IF g_apb[l_ac].apb34 = 'Y' THEN
                 CALL t110_api_unap('a')
              END IF
              #No.TQC-7B0083  --End  
             #str CHI-B30009 add
              LET g_apb04=''
              LET g_apb05=''
              SELECT apb04,apb05 INTO g_apb04,g_apb05 FROM apb_file
               WHERE apb01=g_apa.apa01 AND apb02=g_apb[l_ac].apb02
             #end CHI-B30009 add
              CALL t110_bu(1,0)
              #使用稅控系統, 可由單身輸入發票資料
#             IF g_aza.aza26 = '2' AND g_aza.aza25 = 'Y' THEN
              IF g_aza.aza26 = '2' AND g_aza.aza46 = 'Y' THEN   #No.FUN-580006
                 CALL t110_ddd_c(g_apb[l_ac].apb02)
                 DISPLAY BY NAME g_apa.apa07      #TQC-630164 
                 CALL t110_show_multi_invoice()   #No.TQC-A30076
              END IF
              IF g_success='Y' THEN
                 LET l_change = 'Y'  #No.MOD-B80053 add
                 COMMIT WORK
              ELSE
                 ROLLBACK WORK
              END IF
           END IF

        BEFORE FIELD apb02                        #default 序號
           IF g_apb[l_ac].apb02 IS NULL OR g_apb[l_ac].apb02 = 0 THEN
              SELECT max(apb02)+1 INTO g_apb[l_ac].apb02 FROM apb_file
               WHERE apb01 = g_apa.apa01
              IF g_apb[l_ac].apb02 IS NULL THEN
                 LET g_apb[l_ac].apb02 = 1
              END IF
           END IF

        AFTER FIELD apb02                        #check 序號是否重複
           LET l_ac = ARR_CURR()  #No.TQC-740067  
           IF NOT cl_null(g_apb[l_ac].apb02) THEN
              IF g_apb[l_ac].apb02 != g_apb_t.apb02 OR
                 g_apb_t.apb02 IS NULL THEN
                 SELECT count(*) INTO l_n FROM apb_file
                  WHERE apb01 = g_apa.apa01 AND apb02 = g_apb[l_ac].apb02
                 IF l_n > 0 THEN
                    CALL cl_err('',-239,0)
                    LET g_apb[l_ac].apb02 = g_apb_t.apb02
                    NEXT FIELD apb02
                 END IF
              END IF
           END IF

        BEFORE FIELD apb21
           CALL t110_set_entry_b(p_cmd)
           CALL t110_set_no_entry_b(p_cmd)  #MOD-5B0005
           IF g_apb[l_ac].apb21 IS NULL AND l_ac > 1 THEN
              LET g_apb[l_ac].apb21 = g_apb[l_ac-1].apb21
           END IF

     #FUN-810045 begin
        AFTER FIELD apb35
          IF NOT cl_null(g_apb[l_ac].apb35) THEN
             SELECT COUNT(*) INTO g_cnt FROM pja_file
              WHERE pja01 = g_apb[l_ac].apb35
                AND pjaacti = 'Y'    
                AND pjaclose = 'N'       #No.FUN-960038
             IF g_cnt = 0 THEN
                CALL cl_err(g_apb[l_ac].apb35,'asf-984',0)
                NEXT FIELD apb35
             END IF
             CALL t110_set_entry_b(p_cmd)
             CALL t110_set_no_entry_b(p_cmd)
          ELSE 
             NEXT FIELD apb31    #IF 專案沒輸入資料，直接跳到費用原因
          END IF
          #No.FUN-830161  --Begin
          IF g_aptype[1,1] = '1' THEN
             CALL t110_bud(p_cmd,'3')
             IF NOT cl_null(g_errno) THEN
                NEXT FIELD apb26 
             END IF
          END IF
          #No.FUN-830161  --End
         
       BEFORE FIELD apb36
         IF cl_null(g_apb[l_ac].apb35) THEN
            NEXT FIELD apb35
         END IF

       AFTER FIELD apb36
          IF NOT cl_null(g_apb[l_ac].apb36) THEN
             SELECT COUNT(*) INTO g_cnt FROM pjb_file
              WHERE pjb01 = g_apb[l_ac].apb35
                AND pjb02 = g_apb[l_ac].apb36
                AND pjbacti = 'Y'    
             IF g_cnt = 0 THEN
                CALL cl_err(g_apb[l_ac].apb35,'apj-051',0)
                LET g_apb[l_ac].apb36 = g_apb_t.apb36
                NEXT FIELD apb36
#No.FUN-850027--begin
             ELSE
                SELECT pjb09,pjb11 INTO l_pjb09,l_pjb11 
                 FROM pjb_file WHERE pjb01 =g_apb[l_ac].apb35
                  AND pjb02 = g_apb[l_ac].apb36 
                  AND pjbacti = 'Y'            
                IF l_pjb09 != 'Y' OR l_pjb11 != 'Y' THEN
                   CALL cl_err(g_apb[l_ac].apb35,'apj-090',0)
                   LET g_apb[l_ac].apb36 = g_apb_t.apb36
                   NEXT FIELD apb36
                END IF
#No.FUN-850027--begin
             END IF
          END IF
          #No.FUN-830161  --Begin
          IF g_aptype[1,1] = '1' THEN
             CALL t110_bud(p_cmd,'3')
             IF NOT cl_null(g_errno) THEN
                NEXT FIELD apb31
             END IF
          END IF
          #No.FUN-830161  --End
     #FUN-810045 end

        #TQC-630055--start--
        AFTER FIELD apb31
          #FUN-810045
           #IF (g_aptype='12' OR g_aptype='15' OR g_aptype='13' OR g_aptype='17' OR g_aptype='21' OR g_aptype='22' OR g_aptype='16' ) AND    #MOD-5B0005  #No.FUN-690080  #No.TQC-770056 add type='21','22','16'
           #    NOT cl_null(g_apa.apa66)  THEN  #by專案費用代號輸入   #MOD-5B0005
           IF (g_aptype='12' OR g_aptype='15' OR g_aptype='13' OR g_aptype='17' 
               OR g_aptype='21' OR g_aptype='22' OR g_aptype='16' ) THEN 
          #FUN-810045 END
              #str MOD-910170 mark
              ##No:MOD-840449--begin
              #IF g_aza.aza08 = 'N' THEN
              #   IF g_apb[l_ac].apb31 IS NULL THEN
              #      CALL cl_err(g_apb[l_ac].apb31,'aap-344',0)
              #      NEXT FIELD apb31
              #   END IF
              #END IF
              ##No:MOD-840449--end
              #end MOD-910170 mark
               CALL t110_apb31()
               IF NOT cl_null(g_errno)  THEN
                  CALL cl_err(g_apb[l_ac].apb31,g_errno,1)
                  NEXT FIELD apb31
               END IF
           END IF
           #No.FUN-830161  --Begin
           IF g_aptype[1,1] = '1' THEN
              CALL t110_bud(p_cmd,'3')
              IF NOT cl_null(g_errno) THEN
                 NEXT FIELD apb31
              END IF
           END IF
           #No.FUN-830161  --End
        #TQC-630055--end ---

        AFTER FIELD apb21
            IF g_aptype='11' AND cl_null(g_apb[l_ac].apb21) THEN
               NEXT FIELD apb21
            END IF
#            IF g_aptype='12' OR g_aptype='15' THEN  #by專案費用代號輸入  #MOD-5B0005
        
            #FUN-630055 remark --start --
            #IF (g_aptype='12' OR g_aptype='15') AND    #MOD-5B0005
            #   NOT cl_null(g_apa.apa66)  THEN  #by專案費用代號輸入   #MOD-5B0005
            #   CALL t110_apb21()
            #   IF NOT cl_null(g_errno)  THEN
            #      CALL cl_err(g_apb[l_ac].apb21,g_errno,1)
            #      NEXT FIELD apb21
            #   END IF
            #END IF
            #FUN-630055 remark --end---

            IF g_aptype='21' AND g_apa.apa58='2' AND g_apb[l_ac].apb21 IS NULL THEN
               NEXT FIELD apb21
            END IF
           #No:MOD-480131
          # IF FGL_LASTKEY() = 2001 OR FGL_LASTKEY() = 2016 THEN
          #    NEXT FIELD apb09
          # END IF
           #str MOD-890282 add
            IF g_aptype='12' AND g_apb[l_ac].apb21 IS NOT NULL THEN
               LET l_cnt = 0
               SELECT COUNT(*) INTO l_cnt FROM apa_file
                WHERE apa01=g_apb[l_ac].apb21
                  AND apa06=g_apa.apa06
                  AND apa07=g_apa.apa07
               IF l_cnt = 0 THEN
                  CALL cl_err('','aap-024',0)   #付款廠商+簡稱和立暫估不同,請留意!
                  NEXT FIELD apb21
               END IF
              #-MOD-A60078-add-
               LET l_cnt = 0
               SELECT COUNT(*) INTO l_cnt 
                 FROM apa_file,apb_file
                WHERE apa00 = '16' AND apa01 = apb01 AND apa41 = 'Y' AND apa42 = 'N'
                  AND apa01=g_apb[l_ac].apb21 AND apb21 IS NOT NULL
               IF l_cnt > 0 THEN
                  CALL cl_err('','aap-610',0)  
                  NEXT FIELD apb21
               END IF
              #-MOD-A60078-add-
            END IF
           #end MOD-890282 add
            DISPLAY BY NAME g_apb[l_ac].apb21   #FUN-7A0050 add
            CALL t110_set_no_entry_b(p_cmd)
            IF g_apb[l_ac].apb21 !=g_apb_t.apb21 THEN    #No.MOD-910086
               NEXT FIELD apb22                          #No.MOD-910086
            END IF    #No.MOD-910086
            #-----MOD-A40078---------
            IF NOT cl_null(g_apb[l_ac].apb21) THEN
               SELECT rvu99 INTO l_rvu99 FROM rvu_file
                 WHERE rvu01=g_apb[l_ac].apb21
               LET l_rvu99_1 = l_rvu99
               LET i = l_rvu99_1.getIndexOf('-',1)
               LET j = l_rvu99_1.getIndexOf(' ',1)
               IF i > j THEN 
                  LET l_rvu99 = l_rvu99_1.subString(1,j-1)
               ELSE
                  LET l_rvu99 = l_rvu99_1.subString(1,i-1)
               END IF
              
               SELECT poz19,poz18 INTO l_poz19,l_poz18 FROM poz_file
                 WHERE poz01=l_rvu99
               IF NOT STATUS THEN 
                 IF l_poz19 = 'N' OR (l_poz19 = 'Y' AND g_plant <> l_poz18) THEN
                    CALL cl_err(g_apb[l_ac].apb21,'axr-080',1)
                    NEXT FIELD apb21
                 END IF
               END IF
            END IF
            #-----END MOD-A40078-----
#No.MOD-A20009 --begin
            IF (p_cmd ='a' OR p_cmd ='u' AND g_apb[l_ac].apb21 <> g_apb_t.apb21)
               AND g_aptype ='11' AND g_aza.aza26 ='2' THEN
                   SELECT YEAR(rvu03),MONTH(rvu03) INTO l_year,l_month
                     FROM rvu_file
                    WHERE rvu01 = g_apb[l_ac].apb21
                   IF l_year <> YEAR(g_apa.apa02) OR
                      l_month <> MONTH(g_apa.apa02) THEN
                      LET l_n = 0
                      SELECT COUNT(apa01) INTO l_n FROM apb_file,apa_file
                       WHERE apb21 = g_apb[l_ac].apb21
                         AND apb01 = apa01
#                        AND apa00 ='16'                      #TQC-A80101 Mark
                         AND (apa00 ='16' OR apa00 ='26')     #TQC-A80101 Add  
                         AND YEAR(apa02) = l_year
                         AND MONTH(apa02) = l_month
                      IF l_n = 0 THEN
                         CALL cl_err('','gap-145',0)   
                         LET g_apb[l_ac].apb21 = g_apb_t.apb21
                         NEXT FIELD apb21
                      END IF
                   END IF
            END IF
#No.MOD-A20009 --end

        AFTER FIELD apb22
#           IF g_aptype='11' AND g_apb[l_ac].apb22 IS NULL THEN    #No.TQC-740067 mark
            IF g_aptype='11' AND g_apb[l_ac].apb22 IS NULL AND NOT cl_null(g_apb[l_ac].apb21) THEN  #No.TQC-740067
               NEXT FIELD apb22
            END IF
#           IF g_aptype='21' AND g_apa.apa58='2' AND g_apb[l_ac].apb22 IS NULL THEN    #No.TQC-740067 mark
            IF g_aptype='21' AND g_apa.apa58='2' AND g_apb[l_ac].apb22 IS NULL AND NOT cl_null(g_apb[l_ac].apb21) THEN  #No.TQC-740067
               NEXT FIELD apb22
            END IF
            IF g_apb_t.apb21 IS NULL OR
               (g_apb[l_ac].apb21 != g_apb_t.apb21 OR
                g_apb[l_ac].apb22 != g_apb_t.apb22) THEN
                LET g_errno = ' '
                IF g_aptype = '11' OR g_aptype='16' THEN     #No.TQC-770056 add 16
                   CALL t110_apb22_11('a')
#MOD-950158 --begin--
                   IF g_chr_1 = 'N' THEN 
                      NEXT FIELD apb22 
                   END IF 
#MOD-950158 --end--                   
                END IF
               #str FUN-7A0050 add
               #檢查是否為 aapt160 費用暫估資料
                IF g_aptype = '12' THEN
                   CALL t110_apb22_12()
#MOD-950158 --begin--
                   IF g_chr_2 = 'N' THEN 
                      NEXT FIELD apb22 
                   END IF 
#MOD-950158 --end--                           
                END IF
               #end FUN-7A0050 add
               #IF g_aptype = '21' AND g_apa.apa58 = '2' THEN        #No.TQC-770056 mark
               #str MOD-850316 mod
               #IF (g_aptype = '21' OR g_aptype='26') AND g_apa.apa58 = '2' THEN   #No.TQC-770056
                IF (g_aptype = '21' AND (g_apa.apa58 = '2' OR g_apa.apa58 = '3')) OR
                    g_aptype = '26' THEN
               #end MOD-850316 mod
                   CALL t110_apb22_21('a')
#MOD-950158 --begin--
                   IF g_chr_3 = 'N' THEN 
                      NEXT FIELD apb22 
                   END IF 
#MOD-950158 --end--                     
                END IF
                IF g_errno = 'aap-041' OR g_errno = 'aap-042' OR
                   g_errno = 'aap-043' OR g_errno = 'aap-152' THEN   #MOD-970061 mod
                  #NEXT FIELD NEXT    #MOD-770041
                   NEXT FIELD apb21   #MOD-770041
                END IF
                IF NOT cl_null(g_errno) THEN
                    CALL cl_err('',g_errno,0)
                    LET g_apb[l_ac].apb21=g_apb_t.apb21
                    LET g_apb[l_ac].apb22=g_apb_t.apb22
                    NEXT FIELD apb22
                END IF
                CALL t110_proj()  #FUN-810045
                CALL t110_set_no_entry_b(p_cmd)  #FUN-810045 add
            END IF
           #MOD-A20113---add---start---
            LET l_cnt = 0
           #--------------------------MOD-C30896------------------(S)
            IF g_apa.apa00 = '26' THEN
               SELECT COUNT(*) INTO l_cnt FROM apa_file,apb_file
                WHERE apb21 = g_apb[l_ac].apb21
                  AND apb22 = g_apb[l_ac].apb22
                  AND apa01 = apb01
                  AND apa42 = 'N'
                  AND apa00 <> '21'
                  AND apb29 = '3'
                  AND apb09 = 0
                  AND apb01 != g_apa.apa01
            ELSE
           #--------------------------MOD-C30896------------------(E)
               SELECT COUNT(*) INTO l_cnt FROM apa_file,apb_file
                WHERE apb21 = g_apb[l_ac].apb21
                  AND apb22 = g_apb[l_ac].apb22
                  AND apa01 = apb01
                  AND apa42 = 'N'
                  AND apa00 <> '26'
                  AND apb29 = '3'          #MOD-A30046 add
                  AND apb09 = 0            #MOD-A30046 add
                  AND apb01 != g_apa.apa01 #MOD-AB0201
            END IF                             #MOD-C30896 add
            IF l_cnt > 0 THEN
               LET l_err = g_apb[l_ac].apb21,"/",g_apb[l_ac].apb22
               CALL cl_err(l_err,'aec-009',0)
              #NEXT FIELD apb21    #No.MOD-B80345 mark
               NEXT FIELD apb22    #No.MOD-B80345 add
            END IF
           #MOD-A20113---add---end---
            IF g_aptype = '11' THEN
#No.TQC-7B0109 --start--
#              CALL t110_read_rvv_rvb10(g_apb[l_ac].apb21,g_apb[l_ac].apb22)
#                   RETURNING g_rvb10
               SELECT rvv38 INTO l_rvv38 FROM rvv_file
                WHERE rvv01 = g_apb[l_ac].apb21
                  AND rvv02 = g_apb[l_ac].apb22
#No.TQC-7B0109 --end--
            END IF
          # #No.TQC-770056--begin--
          # IF g_aptype = '16' THEN
          #    IF p_cmd='a' OR (p_cmd='u' 
          #                     AND (g_apb[l_ac].apb21 != g_apb_t.apb21 
          #                     OR g_apb[l_ac].apb22 != g_apb_t.apb22)) THEN
          #       CALL t110_apb22_chk16(g_apb[l_ac].apb21,g_apb[l_ac].apb22)

          #     END IF 
          # END IF
            #No.TQC-770056--end--
            #No:MOD-480131
           #IF FGL_LASTKEY() = 2001 OR FGL_LASTKEY() = 2016 THEN
           #   NEXT FIELD apb09
           #END IF
           #start FUN-680110 add
            #No.TQC-7B0083  --Begin
            IF cl_null(g_apa.apa58) OR                                 #MOD-850316 add
              (NOT cl_null(g_apa.apa58) AND g_apa.apa58 != '3') THEN   #MOD-850316 add
               #沖暫估否
               LET g_apb[l_ac].apb34=t110_set_rvv34(g_apb[l_ac].apb21,g_apb[l_ac].apb22)
               DISPLAY BY NAME g_apb[l_ac].apb34
               #暫估帳款單號
               LET g_apb[l_ac].apb01_unap=t110_set_apb01_unap(g_apb[l_ac].apb21,g_apb[l_ac].apb22,g_apb[l_ac].apb34)
               DISPLAY BY NAME g_apb[l_ac].apb01_unap
            END IF    #MOD-850316 add
            #No.TQC-7B0083  --End  
           #end FUN-680110 add
 
        BEFORE FIELD apb06
            CALL t110_set_entry_b(p_cmd)

        AFTER FIELD apb06
            IF NOT cl_null(g_apb[l_ac].apb06) AND 
               (g_aptype = '15' OR g_aptype = '17') THEN  #No.FUN-690080
               SELECT COUNT(*) INTO g_cnt FROM pmm_file
                WHERE pmm01=g_apb[l_ac].apb06
                  AND pmm09=g_apa.apa05 AND pmm18='Y'
               IF g_cnt = 0 THEN
                  CALL cl_err('','aap-006',0)
                  NEXT FIELD apb06
               END IF
             # CALL t110_apb30(p_cmd)  #FUN-810045  #No.FUN-830161 remove apb30
               IF cl_null(g_apb_t.apb06) THEN
                  CALL t110_apb06()
               END IF
              #MOD-A30248---mark---start---
              #不管要不要勾稽，皆不做金額控卡
              #IF g_aptype='15' THEN #MOD-990155
              #  #str MOD-980032 add
              #   #已立預付原幣金額
              #   LET l_apa31f = 0
              #   LET l_apa31f0= 0   #MOD-9B0048 add
              ##str MOD-9B0048 mod
              ##  SELECT SUM(apa31f) INTO l_apa31f FROM apb_file,apa_file
              ##   WHERE apa01 =apb01
              ##     AND apa00 ='15'
              ##     AND apb06 =g_apb[l_ac].apb06
              ##     AND apb01!=g_apa.apa01
              #   DECLARE apa_cs1 CURSOR FOR
              #      SELECT DISTINCT apb01 FROM apb_file
              #       WHERE apb06 =g_apb[l_ac].apb06
              #         AND apb01!=g_apa.apa01
              #   FOREACH apa_cs1 INTO l_apb01
              #      LET l_apa31f0 = 0   #MOD-9C0145 add
              #      SELECT apa31f INTO l_apa31f0 FROM apa_file
              #       WHERE apa01 =l_apb01
              #         AND apa00 ='15'
              #      IF cl_null(l_apa31f0) THEN LET l_apa31f0 = 0 END IF
              #      LET l_apa31f = l_apa31f + l_apa31f0
              #   END FOREACH
              ##end MOD-9B0048 mod
              #   IF cl_null(l_apa31f) THEN LET l_apa31f = 0 END IF
              # #str CHI-9C0015 mod
              # # #採購單原幣未稅金額
              # # LET l_pmm40 = 0
              # # SELECT pmm40 INTO l_pmm40 FROM pmm_file
              # #  WHERE pmm01=g_apb[l_ac].apb06
              # # IF cl_null(l_pmm40) THEN LET l_pmm40 = 0 END IF
              # # IF g_apa.apa31f > l_pmm40 - l_apa31f THEN
              #      #採購單原幣含稅金額
              #      LET l_pmm40t = 0
              #      SELECT pmm40t INTO l_pmm40t FROM pmm_file
              #       WHERE pmm01=g_apb[l_ac].apb06
              #      IF cl_null(l_pmm40t) THEN LET l_pmm40t = 0 END IF
              #      IF g_apa.apa31f > l_pmm40t - l_apa31f THEN      
              #    #end CHI-9C0015 mod
              #         CALL cl_err(g_apa.apa31f,'aap-937',0) 
              #         NEXT FIELD apb06
              #      END IF
              #     #end MOD-980032 add
              #END IF #MOD-990155 
              #MOD-A30248---mark---end---
               CALL t110_set_no_entry_b(p_cmd)
            END IF

        AFTER FIELD apb07
           IF g_aptype = '15' OR g_aptype = '17' THEN   #No.FUN-690080
             #IF NOT cl_null(g_apb[l_ac].apb07) OR     #MOD-840535
              IF NOT cl_null(g_apb[l_ac].apb07) AND    #MOD-840535
                ((g_apb_t.apb07 IS NULL OR g_apb[l_ac].apb07 <> g_apb_t.apb07) OR       #CHI-B80023 add 
                (g_apb_t.apb06 IS NULL OR g_apb[l_ac].apb06 <> g_apb_t.apb06)) THEN
                 CALL t110_apb07('a')
                 #MOD-A30248---add---start---
                 IF g_errno = 'aap-937' THEN
                    CALL cl_err(g_apb[l_ac].apb06,'aap-937',1)
                    NEXT FIELD apb06
                 END IF
                 #MOD-A30248---add---end---
                 #-----MOD-770041---------
                 IF g_errno = 'aap-041' THEN
                    NEXT FIELD apb06
                 END IF
                 #-----END MOD-770041-----
                #TQC-750104 begin
                 IF NOT cl_null(g_errno) THEN
                   CALL cl_err('',g_errno,0)
                   NEXT FIELD apb07
                 END IF
                #TQC-750104 end
               # CALL t110_apb30(p_cmd)  #FUN-810045  #No.FUN-830161 remove apb30
                 CALL t110_proj()        #MOD-910161 add
                 CALL t110_set_entry_b(p_cmd)
                 CALL t110_set_no_entry_b(p_cmd)   #No:FUN-880094
              END IF
           END IF
 
        AFTER FIELD apb11
            #IF g_apa.apa58 = '3' AND g_apa.apa00='21' THEN   #CHI-750020
            IF (g_apa.apa58 = '3' OR g_apa.apa58 = '2') AND g_apa.apa00='21' THEN   #CHI-750020
               IF g_apb[l_ac].apb11 IS NULL OR g_apb[l_ac].apb11=' ' THEN
                  SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01 = g_apa.apa15     #MOD-950138 add  
                  IF l_gec05 != 'X' THEN                                                #MOD-950138 add                              
                     CALL cl_err(g_apa.apa01,'mfg-011',0)
                     NEXT FIELD apb11
                  END IF                    #MOD-950138 add   
               END IF
            END IF
            IF NOT cl_null(g_apb[l_ac].apb11) THEN
               SELECT COUNT(*) INTO l_n FROM apk_file
                WHERE apk03 = g_apb[l_ac].apb11
               IF l_n = 0 THEN
                  #-----FUN-680003---------
                  SELECT COUNT(*) INTO l_n FROM amd_file
                   WHERE amd03 = g_apb[l_ac].apb11
                  IF l_n = 0 THEN
                     CALL cl_err('sel apk: ','aap-151',0)
                     NEXT FIELD apb11
                  END IF
                  #-----END FUN-680003-----
                  #CALL cl_err('sel apk: ','aap-151',0)
                  #NEXT FIELD apb11
               END IF
               #str MOD-850114 add
               #aapt210單身輸入發票(apb11)時,需檢核apa00=1*的apk_file
               #對應的帳款已確認才可輸入
                IF g_apa.apa00='21' THEN
                   LET l_n = 0
                   SELECT COUNT(*) INTO l_n
                     FROM apa_file,apk_file
                    WHERE apa01=apk01
                      AND apk03=g_apb[l_ac].apb11
                      AND apa00 MATCHES '1*'
                      AND apa41='Y'            #已確認
                   IF l_n = 0 THEN
                     #str MOD-870264 add
                     #判斷輸入的發票號碼是否存在amdi100,且已確認
                     #若沒有則顯示mfg-043訊息
                      SELECT COUNT(*) INTO l_n FROM amd_file
                       WHERE amd03=g_apb[l_ac].apb11
                         AND amd30='Y'        #已確認
                      IF l_n = 0 THEN
                     #end MOD-870264 add
                         SELECT apk01 INTO l_apk01
                           FROM apa_file,apk_file
                          WHERE apa01=apk01
                            AND apk03=g_apb[l_ac].apb11
                            AND apa00 MATCHES '1*'
                         SELECT gaq03 INTO l_message FROM gaq_file
                          WHERE gaq01='apa00' and gaq02=g_lang
                         LET l_message=l_message,'=1*,',l_apk01,':'
                         CALL cl_err(l_message,'mfg-043',0)
                         NEXT FIELD apb11
                      END IF   #MOD-870264 add
                   END IF
                END IF
               #end MOD-850114 add
               IF g_apa.apa00 MATCHES '2*' THEN
                  LET l_apa06=''
                  DECLARE chk_c1 CURSOR FOR
                     SELECT apa06
                       FROM apa_file,apk_file
                      WHERE apa01=apk01
                        AND apk03 = g_apb[l_ac].apb11
                        AND apa00 MATCHES '1*'

                  OPEN chk_c1
                  FETCH chk_c1  INTO l_apa06
                  IF l_apa06 <> g_apa.apa06 THEN
                     CALL cl_err(l_apa06,'mfg-024',0)
                     NEXT FIELD apb11
                  END IF
               END IF
            END IF

        AFTER FIELD apb12
#TQC-740050.....begin                                                           
          IF NOT cl_null(g_apb[l_ac].apb12) THEN
             IF g_apb[l_ac].apb12[1,4] != "MISC" THEN   #TQC-750121
               SELECT COUNT(*) INTO l_n FROM ima_file                                
                WHERE ima01 = g_apb[l_ac].apb12                                      
               IF l_n = 0 THEN                                                       
                  CALL cl_err(g_apb[l_ac].apb12,'aap-924',0)                         
                  NEXT FIELD apb12                                                   
               END IF                                   #TQC-750121
             END IF                              
          END IF
#TQC-740050.....end
         #IF g_aptype='15' OR g_aptype='17' OR g_aptype='12' THEN  #No.FUN-690080   #CHI-990015 add 12                   #MOD-A90022 mark
          IF g_aptype='15' OR g_aptype='17' OR g_aptype='12' OR g_aptype='21' THEN  #No.FUN-690080   #CHI-990015 add 12  #MOD-A90022
             IF NOT cl_null(g_apb[l_ac].apb12) THEN
                LET g_no = g_apb[l_ac].apb12[1,4]
                CALL t110_apb12('a',g_no)
                IF NOT cl_null(g_errno) THEN
                   CALL cl_err(g_apb[l_ac].apb12,g_errno,0)
                   NEXT FIELD apb12
                END IF
             END IF
          END IF

        AFTER FIELD apb28    #單位
            IF NOT cl_null(g_apb[l_ac].apb28) THEN
               CALL t110_unit(g_apb[l_ac].apb28)
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apb[l_ac].apb28,g_errno,0)
                  LET g_apb[l_ac].apb28 = g_apb_t.apb28
                  NEXT FIELD apb28
               END IF
            END IF

        #No.FUN-830161  --Begin  remove apb30
        ##No.FUN-690080 --Begin
        #AFTER FIELD apb30    #預算編號
        #  #FUN-810045 begin
        #    IF g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' AND
        #       cl_null(g_apb[l_ac].apb30) THEN
        #       CALL cl_err(g_apb[l_ac].apb30,'mfg0037',0)
        #       NEXT FIELD apb30
        #    END IF
        #  #FUN-810045 end
        #   IF g_aptype = '13' OR g_aptype = '17' OR g_aptype = '25' OR g_aptype='21' OR g_aptype='22' THEN   #No.TQC-770056 add aptype='21','22'
        #      IF NOT cl_null(g_apb[l_ac].apb30) THEN
        #        #IF g_apb[l_ac].apb02 != g_apb_t.apb02 OR    #No.TQC-770056
        #        #   g_apb_t.apb02 IS NULL THEN               #No.TQC-770056
        #            SELECT afa02 FROM afa_file WHERE afa01=g_apb[l_ac].apb30
        #                                         AND afa00=g_bookno1
        #            IF SQLCA.sqlcode THEN
        #               CALL cl_err3("sel","afa_file",g_apb[l_ac].apb30,"",SQLCA.sqlcode,"","",1)
        #               NEXT FIELD apb30
        #            END IF
        #            LET g_apb30 = g_apb[l_ac].apb30
        #        #END IF    #No.TQC-770056
        #       #FUN-810045 begin
        #        CALL t110_apb25()  
        #        IF NOT cl_null(g_errno) THEN
        #           CASE g_errno
        #             WHEN "apb25"
        #               NEXT FIELD apb25
        #             WHEN "apb251"
        #               NEXT FIELD apb251
        #             WHEN "apb26"
        #               NEXT FIELD apb26
        #             WHEN "apb30"
        #               NEXT FIELD apb30
        #            END CASE
        #        END IF
        #       #FUN-810045 end
        #      END IF
        #   END IF
        #No.FUN-830161  --End  

        AFTER FIELD apb32    #人員編號
           IF NOT cl_null(g_apb[l_ac].apb32) THEN
              #CALL t110_cpf(g_apb[l_ac].apb32,'1')      #No:CHI-780046
              CALL t110_gen(g_apb[l_ac].apb32,'1')       #No:FUN-780046
              IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apb[l_ac].apb32,g_errno,0)
                  LET g_apb[l_ac].apb32 = g_apb_t.apb32
                  NEXT FIELD apb32
               END IF
           END IF
        #No.FUN-690080 --End

        AFTER FIELD apb08
           IF NOT cl_null(g_apb[l_ac].apb08) THEN  #No.TQC-7B0063
             #No.TQC-7B0063--begin-- add
              IF g_apb[l_ac].apb08 < 0 THEN
                 CALL cl_err(g_apb[l_ac].apb08,'aap-505',0)
                 LET g_apb[l_ac].apb08 = NULL
                 NEXT FIELD apb08
              END IF
             #No.TQC-7B0063---end--- add
               #LET g_apb[l_ac].apb08 = cl_digcut(g_apb[l_ac].apb08,t_azi.azi03)   #No:BUG-530274   #No:MOD-560236   #MOD-6B0066
               LET g_apb[l_ac].apb08 = cl_digcut(g_apb[l_ac].apb08,g_azi03)   #No:BUG-530274   #No:MOD-560236   #MOD-6B0066
               DISPLAY BY NAME g_apb[l_ac].apb08   #No:MOD-530247
              IF g_apz.apz15 = 'N' AND g_aptype='11' THEN
                 SELECT rvv38 INTO l_rvv38 FROM rvv_file,rvu_file
                   WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
                     AND rvuconf='Y' AND rvv01=rvu01
                 LET g_rvv38_n = l_rvv38 * g_apa.apa14
                  #LET g_rvv38_n = cl_digcut(g_rvv38_n,t_azi.azi03)    #No:MOD-510045   #MOD-6B0066
                  LET g_rvv38_n = cl_digcut(g_rvv38_n,g_azi03)    #No:MOD-510045   #MOD-6B0066
                 IF g_apb[l_ac].apb08 > g_rvv38_n THEN
                    CALL cl_err('','aap-775',0)
                    NEXT FIELD apb08
                 END IF
              END IF
             #No.TQC-7B0063--begin-- add
              IF p_cmd='a' OR (p_cmd='u' AND g_apb[l_ac].apb08 <> g_apb_t.apb08) THEN
                #LET g_apb[l_ac].apb10 = g_apb[l_ac].apb08 * g_apb[l_ac].apb09   #MOD-860221 mark
                 LET g_apb[l_ac].apb10 = g_apb[l_ac].apb24 * g_apa.apa14         #MOD-860221
                 CALL cl_digcut(g_apb[l_ac].apb10,g_azi04) 
                      RETURNING g_apb[l_ac].apb10
              END IF
             #No.TQC-7B0063---end--- add
              #No.FUN-830161  --Begin
              IF g_aptype[1,1] = '1' THEN
                 CALL t110_bud(p_cmd,'3')
                 IF NOT cl_null(g_errno) THEN
                    NEXT FIELD apb08 
                 END IF
              END IF
              #No.FUN-830161  --End
             #str CHI-850025 add
             #當匯率為1時,需檢核原幣與本幣的稅額、金額需相同
             #IF g_apa.apa14 = 1 THEN                                 #MOD-880041 mark
              IF g_apa.apa14 = 1 AND g_aza.aza17 = g_apa.apa13 THEN   #MOD-880041
                 IF g_apb[l_ac].apb23!=g_apb[l_ac].apb08 THEN
                    CALL cl_err('','apm-988',1)
                    NEXT FIELD apb08
                 END IF
              END IF
             #end CHI-850025 add
           END IF 

        BEFORE FIELD apb09   #數量
            #SELECT rvv17,rvv23 INTO g_qty1,g_qty2 FROM rvv_file,rvu_file   #FUN-560070
            SELECT rvv87,rvv23,rvv88 INTO g_qty1,g_qty2,g_qty5  #No.TQC-7B0083 add rvv88
              FROM rvv_file,rvu_file   #FUN-560070
             WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
               AND rvuconf='Y' AND rvv01=rvu01
            IF g_qty1 IS NULL THEN
               LET g_qty1 = 0
            END IF

            IF g_qty2 IS NULL THEN
               LET g_qty2 = 0
            END IF
            IF g_aptype = '11' THEN
               CALL cl_getmsg('aap-049',g_lang) RETURNING g_msg
            END IF
            IF g_aptype = '21' AND g_apa.apa58 = '2' THEN
               CALL cl_getmsg('aap-089',g_lang) RETURNING g_msg
            END IF
            #No.MOD-940329  --Begin
            IF g_aptype = '11' AND g_apb[l_ac].apb29 = '3' AND 
               g_apb[l_ac].apb34 = 'N' THEN
               LET g_msg[10,25] = g_qty1*-1 USING '---,---,---.---'
               LET g_msg[35,50] = g_qty2*-1 USING '---,---,---.---'
               LET g_qty3 = g_qty1 - g_qty2
               IF g_aptype = '11' OR (g_aptype = '21' AND g_apa.apa58 = '2') THEN
                  ERROR g_msg CLIPPED,g_qty3*-1 USING '---,---,---.---'
               END IF
            ELSE
               LET g_msg[10,25] = g_qty1 USING '---,---,---.---'
               LET g_msg[35,50] = g_qty2 USING '---,---,---.---'
               LET g_qty3 = g_qty1 - g_qty2
               IF g_aptype = '11' OR (g_aptype = '21' AND g_apa.apa58 = '2') THEN
                  ERROR g_msg CLIPPED,g_qty3 USING '---,---,---.---'
               END IF
            END IF
            #No.MOD-940329  --End 
           #-MOD-B20137-add-
            IF g_aptype = '16' AND cl_null(g_apb[l_ac].apb21) THEN 
               LET g_apb[l_ac].apb09 = 1 
            END IF
           #-MOD-B20137-end-
            LET g_apb_t.apb09 = g_apb[l_ac].apb09             #MOD-A80093 

        AFTER FIELD apb09
            #TQC-C60241--add--str--
            IF g_apa.apa00 = '26' THEN
               IF g_apb[l_ac].apb29 = '3' THEN
                  SELECT SUM(rvv87) INTO l_sum_rvv87
                    FROM rvv_file
                   WHERE rvv01 = g_apb[l_ac].apb21
                     AND rvv02 = g_apb[l_ac].apb22
                  SELECT SUM(apb09) INTO l_sum_apb09
                    FROM apb_file,apa_file
                   WHERE apb21 = g_apb[l_ac].apb21
                     AND apb22 = g_apb[l_ac].apb22
                     AND apa00 = '26'
                     AND apa01 = apb01
                  SELECT apb09 INTO l_apb09
                    FROM apb_file,apa_file
                   WHERE apb21 = g_apb[l_ac].apb21
                     AND apb02 = g_apb[l_ac].apb02
                     AND apa00 = '26'
                     AND apa01 = apb01
                     AND apa01 = g_apa.apa01
                  IF cl_null(l_sum_rvv87) THEN
                     LET l_sum_rvv87 = 0
                  END IF
                  IF cl_null(l_apb09) THEN
                     LET l_apb09 = 0
                  END IF
                  IF cl_null(l_sum_apb09) THEN
                     LET l_sum_apb09 = 0
                  END IF
                  IF l_sum_apb09 + g_apb[l_ac].apb09 - l_apb09 > l_sum_rvv87 THEN
                     CALL cl_err('','aap-240',1)
                     NEXT FIELD apb09
                  END IF
               END IF
            END IF
            #TQC-C60241--add--end--
            IF g_apa.apa00 MATCHES '1*' AND g_apb[l_ac].apb09 = 0 THEN
               IF g_apb[l_ac].apb29 = '3' AND g_qty1=0 THEN   #No:MOD-910062
               ELSE
                  NEXT FIELD apb09
               END IF
            END IF
            #No.TQC-7B0083  --Begin
            IF g_apb[l_ac].apb34 = 'N' THEN
               IF g_aptype = '11' AND g_apb[l_ac].apb29 = '3' THEN
                  #若是倉退時,是負數,要不同處理
                  #No.MOD-940329 --Begin
                  LET l_qty1 = g_apb[l_ac].apb09 * -1
                  LET l_qty2 = g_apb_t.apb09     * -1
                  #IF (g_qty2+g_apb_t.apb09-g_apb[l_ac].apb09+g_qty5) > g_qty1 THEN  #No.TQC-7B0083  add暫估數量
                  # 已請款數量+本次請款數量-本次請款舊值+暫估數量>計價數量
                  IF g_qty2 + l_qty1 - l_qty2 + g_qty5 > g_qty1 THEN
                  #No.MOD-940329 --End  
                     CALL cl_err(g_qty1,'aap-048',1)
                     NEXT FIELD apb09
                  END IF
               ELSE
                  IF g_aptype = '11' OR g_aptype = '21' OR 
                     g_aptype = '16' OR g_aptype = '26' THEN
                    #(g_qty2-g_apb_t.apb09+g_apb[l_ac].apb09) > g_qty1 THEN         #No.TQC-7B0083
                     IF (g_qty2-g_apb_t.apb09+g_apb[l_ac].apb09+g_qty5) > g_qty1 THEN  #No.TQC-7B0083  add暫估數量
                        CALL cl_err(g_qty1,'aap-048',1)
                        NEXT FIELD apb09
                     END IF
                  END IF
               END IF
            END IF
            IF g_apb[l_ac].apb34 = 'Y' THEN
               IF g_aptype = '11' AND g_apb[l_ac].apb29 = '3' THEN
                  IF g_apb_t.apb09 - g_apb[l_ac].apb09  > g_qty5 THEN
                     CALL cl_err(g_apb[l_ac].apb09,'aap-818',1)
                     NEXT FIELD apb09
                  END IF
               ELSE
                  IF g_apb[l_ac].apb09 - g_apb_t.apb09 > g_qty5 THEN
                     CALL cl_err(g_apb[l_ac].apb09,'aap-818',1)
                     NEXT FIELD apb09
                  END IF
               END IF
            END IF
            #No.TQC-7B0083  --End  
           #str CHI-B70013 add
            IF (g_aptype = '15' OR g_aptype = '17') THEN
               LET l_pmn87=0   LET l_apb09_15=0
               #採購數量
               SELECT pmn87 INTO l_pmn87 FROM pmn_file
                WHERE pmn01=g_apb[l_ac].apb06 AND pmn02=g_apb[l_ac].apb07
               IF cl_null(l_pmn87) THEN LET l_pmn87=0 END IF

               #採購單已立預付數量
               SELECT SUM(apb09) INTO l_apb09_15 FROM apb_file,apa_file
                WHERE apb01=apa01             AND apa00='15'
                  AND apb06=g_apb[l_ac].apb06 AND apb07=g_apb[l_ac].apb07
                  AND apb01!=g_apa.apa01 
               IF cl_null(l_apb09_15) THEN LET l_apb09_15=0 END IF
               
               #當預付數量(之前已經預付+本次預付)>採購數量時,應提示訊息
               IF g_apb[l_ac].apb06 IS NOT NULL AND g_apb[l_ac].apb07 IS NOT NULL THEN   #No.MOD-B90115 add
                  IF l_apb09_15 + g_apb[l_ac].apb09 > l_pmn87 THEN
                     CALL cl_err(g_apb[l_ac].apb09,'aap-945',1)
                     LET g_apb[l_ac].apb09 = l_pmn87 - l_apb09_15
                     LET g_apb[l_ac].apb24 = g_apb[l_ac].apb09 * g_apb[l_ac].apb23
                     LET g_apb[l_ac].apb10 = g_apb[l_ac].apb09 * g_apb[l_ac].apb08
                     LET g_apb[l_ac].apb24 =cl_digcut(g_apb[l_ac].apb24,t_azi04)
                     LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)
                     DISPLAY BY NAME g_apb[l_ac].apb09,g_apb[l_ac].apb09,g_apb[l_ac].apb10
                     NEXT FIELD apb09
                  END IF
               END IF                                                                     #No.MOD-B90115 add
               #數量不可為負數
               IF g_apb[l_ac].apb09 < 0 THEN 
                  CALL cl_err(g_apb[l_ac].apb09,'mfg1322',1)
                  LET g_apb[l_ac].apb09 = l_pmn87 - l_apb09_15
                  LET g_apb[l_ac].apb24 = g_apb[l_ac].apb09 * g_apb[l_ac].apb23
                  LET g_apb[l_ac].apb10 = g_apb[l_ac].apb09 * g_apb[l_ac].apb08
                  LET g_apb[l_ac].apb24 =cl_digcut(g_apb[l_ac].apb24,t_azi04)
                  LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)
                  DISPLAY BY NAME g_apb[l_ac].apb09,g_apb[l_ac].apb09,g_apb[l_ac].apb10
                  NEXT FIELD apb09
               END IF
            END IF 
           #end CHI-B70013 add
           #str TQC-8A0079 mod
           #IF g_apb[l_ac].apb09>0 THEN
           #   LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
           #END IF
            #單價含稅時,不使用單價*數量=金額,改以含稅金額回推稅率,以避免小數位差的問題
            LET l_gec04 = 0   LET l_gec07 = ''
            #No:MOD-8C0020---Begin
            #SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file
            # WHERE gec01 = g_apa.apa15 
            IF g_apb[l_ac].apb06 <> '' OR NOT cl_null(g_apb[l_ac].apb06) THEN   #TQC-8C0031 add 
              #SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file,pmm_file                   #MOD-A80052 mark
               SELECT gec04,gec05,gec07 INTO l_gec04,l_gec05,l_gec07 FROM gec_file,pmm_file     #MOD-A80052
                WHERE gec01 = pmm21 AND pmm01=g_apb[l_ac].apb06  
            #TQC-8C0031---Begin
            ELSE  
              #SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file,pmm_file                   #MOD-A80052 mark
               SELECT gec04,gec05,gec07 INTO l_gec04,l_gec05,l_gec07 FROM gec_file              #MOD-A80052
                WHERE gec01 = g_apa.apa15  
            END IF
            #TQC-8C0031---End
            #No:MOD-8C0020---End   
            IF cl_null(l_gec04) THEN LET l_gec04=0   END IF
            IF cl_null(l_gec07) THEN LET l_gec07='N' END IF
            LET l_rvv38t = 0
            IF g_apb[l_ac].apb09 <> g_apb_t.apb09 THEN    #MOD-A80093 
              #IF l_gec07='Y' THEN
#              IF l_gec07='Y' AND (g_aptype='11' OR g_aptype='16' ) THEN  #No:MOD-910094  #MOD-940381
               IF l_gec07='Y' AND (g_aptype='11' OR g_aptype='16' OR
                                   g_aptype='21' OR g_aptype='26') THEN  #No:MOD-940381
                  SELECT rvv38t INTO l_rvv38t FROM rvv_file           
                   WHERE rvv01 = g_apb[l_ac].apb21
                     AND rvv02 = g_apb[l_ac].apb22
                  IF cl_null(l_rvv38t) THEN LET l_rvv38t=0 END IF
                  #MOD-920013---Begin
                  LET l_apb24t = l_rvv38t*g_apb[l_ac].apb09
                  LET l_apb24t = cl_digcut(l_apb24t,t_azi04)
                 #-MOD-A80052-add-
                  IF l_gec05 = 'T' THEN
                     LET l_apa32f = l_apb24t * (l_gec04/100)
                     LET l_apa32f = cl_digcut(l_apa32f , t_azi04)
                     LET g_apb[l_ac].apb24 = l_apb24t - l_apa32f 
                  ELSE
                     LET g_apb[l_ac].apb24 = l_apb24t/(1+l_gec04/100)
                  END IF  
                 #-MOD-A80052-end-
                 #LET g_apb[l_ac].apb24 = l_apb24t/(1+l_gec04/100)           #MOD-A80052
                  #LET g_apb[l_ac].apb24 = (l_rvv38t*g_apb[l_ac].apb09)/(1+l_gec04/100)
                  #MOD-920013---End
               ELSE
                  IF g_apb[l_ac].apb09>0 THEN
                     LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
                  END IF
               END IF
              #end TQC-8A0079 mod
               #LET g_apb[l_ac].apb24 =cl_digcut(g_apb[l_ac].apb24,g_azi.azi04)   #MOD-6B0066
               LET g_apb[l_ac].apb24 =cl_digcut(g_apb[l_ac].apb24,t_azi04)   #MOD-6B0066
              #-MOD-A90146-add-
               IF g_aptype = '12' THEN     #MOD-AB0167
                  CALL t110_chkapb24()               
                  IF g_apb[l_ac].apb34 = 'Y' AND g_apb[l_ac].apb24 > g_apb24 THEN
                     LET g_apb[l_ac].apb09 = g_apb09
                     CALL cl_err(g_apb[l_ac].apb09,'aap-972',1)
                     NEXT FIELD apb09
                  END IF
               END IF                      #MOD-AB0167
              #-MOD-A90146-end-
               #------No:MOD-5A0095 START-------------------
               DISPLAY BY NAME g_apb[l_ac].apb24
               #------No:MOD-5A0095 END---------------------
               LET g_apb[l_ac].apb08 =g_apb[l_ac].apb23 * g_apa.apa14
              #LET g_apb[l_ac].apb08 =cl_digcut(g_apb[l_ac].apb08,t_azi.azi03)   #No:MOD-510045   #MOD-6B0066
               LET g_apb[l_ac].apb08 =cl_digcut(g_apb[l_ac].apb08,g_azi03)   #No:MOD-510045   #MOD-6B0066
               LET g_apb[l_ac].apb10 =g_apb[l_ac].apb24 * g_apa.apa14        #MOD-840632   #MOD-860221 mark回復
              #LET g_apb[l_ac].apb10 =g_apb[l_ac].apb08 * g_apb[l_ac].apb09  #MOD-840632   #MOD-860221 mark
              #LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,t_azi.azi04)   #MOD-6B0066
               LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)   #MOD-6B0066
               #------No:MOD-5A0095 START-------------------
               DISPLAY BY NAME g_apb[l_ac].apb08
               DISPLAY BY NAME g_apb[l_ac].apb10
               #------No:MOD-5A0095 END---------------------
            END IF                                        #MOD-A80093
            #No.FUN-830161  --Begin
            IF g_aptype[1,1] = '1' THEN
               CALL t110_bud(p_cmd,'3')
               IF NOT cl_null(g_errno) THEN
                  NEXT FIELD apb09 
               END IF
            END IF
            #No.FUN-830161  --End

#TQC-5B0016
      BEFORE FIELD apb25
          IF (g_aptype = '11' OR g_aptype = '21') THEN
             IF g_apa.apa51 = 'STOCK' THEN
                SELECT rvv32,rvv33 INTO l_rvv32,l_rvv33 FROM rvv_file
                   WHERE rvv01 = g_apb[l_ac].apb21 AND
                         rvv02 = g_apb[l_ac].apb22
                CALL t110_stock_act(g_apb[l_ac].apb12,l_rvv32,l_rvv33,'0')    #No.FUN-680029
                     RETURNING g_apb[l_ac].apb25
                DISPLAY BY NAME g_apb[l_ac].apb25
             END IF
          END IF
#END TQC-5B0016
          #-----MOD-6B0088---------
#         IF g_aptype = '12' AND g_apa.apa51 = 'STOCK' THEN
          IF g_apa.apa51 = 'STOCK' THEN     #No.MOD-A80103
             SELECT ima39 INTO g_apb[l_ac].apb25 FROM ima_file
                WHERE ima01=g_apb[l_ac].apb12
          END IF
          #-----END MOD-6B0088-----


        AFTER FIELD apb25
            #NO.MOD-5B0083 START--------
            CALL t110_set_entry_b(p_cmd)
            CALL t110_set_entry_b_1()  #No:FUN-8A0075 
            CALL t110_set_no_entry_b(p_cmd) 
            CALL t110_set_no_entry_b_1()  #No:FUN-8A0075
            #NO.MOD-5B0083 END---------

            IF g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' AND
               cl_null(g_apb[l_ac].apb25) THEN
               CALL cl_err(g_apb[l_ac].apb25,'mfg0037',0)
               NEXT FIELD apb25
            END IF
            IF NOT cl_null(g_apb[l_ac].apb25) THEN
              #SELECT aag02 FROM aag_file            #FUN-710078 mark
              SELECT aag02 INTO g_apb[l_ac].b25      #FUN-710078 mod
                FROM aag_file                        #FUN-710078 mod
                WHERE aag01 = g_apb[l_ac].apb25
                  AND aag00 = g_bookno1     #No.FUN-730064
                  AND aag07 !='1' AND aag03 = '2'
                  AND aagacti = 'Y'     #No.MOD-B70280 add

               DISPLAY g_apb[l_ac].b25 to b25        #FUN-710078 add

               IF SQLCA.sqlcode THEN
#                 CALL cl_err(g_apb[l_ac].apb25,'agl-001',0)   #No.FUN-660122
                  CALL cl_err3("sel","aag_file",g_apb[l_ac].apb25,"","agl-001","","",1)  #No.FUN-660122
                  NEXT FIELD apb25
               END IF
                #-----No:MOD-530422-----
               LET l_aag05=''  #FUN-8C0106 add
               SELECT aag05 INTO l_aag05 FROM aag_file
                WHERE aag01 = g_apb[l_ac].apb25
                  AND aag00 = g_bookno1    #No.FUN-730064
                  AND aagacti = 'Y'        #No.MOD-B70280 add
              #str CHI-990015 add
               #當執行aapt120,若單身科目需做部門管理,單身部門預設帶入單頭部門
               IF g_aptype='12' AND NOT cl_null(g_apb[l_ac].apb25) AND 
                 #l_aag05='Y' THEN                                              #MOD-A70003 mark
                  l_aag05='Y' AND cl_null(g_apb[l_ac].apb26) THEN               #MOD-A70003
                  LET g_apb[l_ac].apb26 = g_apa.apa22
                  DISPLAY g_apb[l_ac].apb26 TO s_apb[l_ac].apb26
               END IF
              #end CHI-990015 add
              #FUN-8C0106---add---str--- 
              #防止User只修改部門欄位時,未再次檢查會科與允許/拒絕部門關係
               LET g_errno = ' '   
               IF l_aag05 = 'Y' THEN
                 #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                  IF g_aaz.aaz90 ='Y' THEN
                     IF NOT cl_null(g_apb[l_ac].apb930) THEN 
                        CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb25,g_apb[l_ac].apb930,g_bookno1)  
                                      RETURNING g_errno
                     END IF
                  ELSE
                     IF NOT cl_null(g_apb[l_ac].apb26) THEN 
                        CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb25,g_apb[l_ac].apb26,g_bookno1)  
                                      RETURNING g_errno
                     END IF 
                  END IF
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err('',g_errno,0)
                     NEXT FIELD apb26   #MOD-940326 mod apb25->apb26
                  END IF
               END IF
              #FUN-8C0106---add---end---

#MOD-590301
##MOD-580051   科目有做科目部門管理的才CALL s_chkdept
#               IF STATUS OR SQLCA.SQLCODE THEN
#                  LET l_aag05=''
#               END IF
#                #-----No:MOD-530422 END-----
#                #-----No:MOD-530274-----

#               IF l_aag05 = 'Y' THEN
#                  CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb25,g_apb[l_ac].apb26) RETURNING g_errno    #No.FUN-730064
#               END IF
##               CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb25,g_apb[l_ac].apb26) RETURNING g_errno     #No.FUN-730064
##END MOD-580051
#END MOD-590301
               #-----MOD-730141---------
               #IF NOT cl_null(g_errno) THEN
               #   CALL cl_err('',g_errno,0)
               #   NEXT FIELD apb25
               #END IF
               #-----END MOD-730141-----
                #-----No:MOD-530274 END-----

               #No.FUN-830161  --Begin
               ##FUN-810045 begin
               # CALL t110_apb25()  
               # IF NOT cl_null(g_errno) THEN
               #   CASE g_errno
               #     WHEN "apb25"
               #       NEXT FIELD apb25
               #     WHEN "apb251"
               #       NEXT FIELD apb251
               #     WHEN "apb26"
               #       NEXT FIELD apb26
               #     #No.FUN-830161  --Begin
               #     #WHEN "apb30"
               #     #  NEXT FIELD apb30
               #     #No.FUN-830161  --End  
               #   END CASE
               # END IF
               ##FUN-810045 end
               #No.FUN-830161  --End  
            END IF
            IF NOT cl_null(g_apb[l_ac].apb06) AND NOT cl_null(g_apb[l_ac].apb07) THEN
               #LET g_t1 = g_apb[l_ac].apb06   #MOD-630070
               LET g_t1 = s_get_doc_no(g_apb[l_ac].apb06)   #MOD-630070
               SELECT smy59 INTO l_smy59 FROM smy_file WHERE smyslip = g_t1
               SELECT COUNT(*) INTO g_cnt FROM pmn_file,pmm_file
                WHERE pmn01=g_apb[l_ac].apb06 AND pmn02=g_apb[l_ac].apb07
                  AND pmn01=pmm01 AND pmm18='Y' AND pmm02 = 'SUB' #委外
               IF g_cnt > 0 THEN    #委外採購
                  IF g_apy.apydmy5 = 'Y' THEN   #預算控管
                     SELECT pmn40 INTO l_pmn40 FROM pmn_file
                      WHERE pmn01=g_apb[l_ac].apb06 AND pmn02=g_apb[l_ac].apb07
                     IF l_pmn40!=g_apb[l_ac].apb25 THEN
                        CALL cl_err(g_apb[l_ac].apb25,'apm-311',0)
                        NEXT FIELD apb25
                     END IF
                  END IF
               ELSE
                  IF g_apy.apydmy5 = 'Y' AND l_smy59 = 'Y' THEN   #作預算控管
                     SELECT pmn40 INTO l_pmn40 FROM pmn_file
                      WHERE pmn01=g_apb[l_ac].apb06 AND pmn02=g_apb[l_ac].apb07
                     IF l_pmn40!=g_apb[l_ac].apb25 THEN
                        CALL cl_err(g_apb[l_ac].apb25,'apm-311',0)
                        NEXT FIELD apb25
                     END IF
                  END IF
               END IF
            END IF
            #No.FUN-830161  --Begin
            IF g_aptype[1,1] = '1' THEN
               CALL t110_bud(p_cmd,'1')
               IF NOT cl_null(g_errno) THEN
                  NEXT FIELD apb26            #MOD-A90094 mod apb25 -> apb26
               END IF
            END IF
            #No.FUN-830161  --End

#No.FUN-680029--begin
      BEFORE FIELD apb251
          IF (g_aptype = '11' OR g_aptype = '21') THEN  
             IF g_apa.apa511 = 'STOCK' THEN
                SELECT rvv32,rvv33 INTO l_rvv32,l_rvv33 FROM rvv_file
                   WHERE rvv01 = g_apb[l_ac].apb21 AND
                         rvv02 = g_apb[l_ac].apb22
                CALL t110_stock_act(g_apb[l_ac].apb12,l_rvv32,l_rvv33,'1')    #No.FUN-680029
                     RETURNING g_apb[l_ac].apb251
                DISPLAY BY NAME g_apb[l_ac].apb251
             END IF
          END IF 

        AFTER FIELD apb251
            #NO.MOD-5B0083 START--------
            CALL t110_set_entry_b(p_cmd)
            CALL t110_set_entry_b_1()  #No:FUN-8A0075
            CALL t110_set_no_entry_b(p_cmd)
            CALL t110_set_no_entry_b_1()  #No:FUN-8A0075
            #NO.MOD-5B0083 END---------

            IF g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' AND
               cl_null(g_apb[l_ac].apb251) THEN
               CALL cl_err(g_apb[l_ac].apb251,'mfg0037',0)
               NEXT FIELD apb251
            END IF
            IF NOT cl_null(g_apb[l_ac].apb251) THEN
              #SELECT aag02 FROM aag_file                       #FUN-710078 mark
               SELECT aag02 INTO g_apb[l_ac].b251 FROM aag_file #FUN-710078 mod
                WHERE aag01 = g_apb[l_ac].apb251
                  AND aag00 = g_bookno2     #No.FUN-730064
                  AND aag07 !='1' AND aag03 = '2'
                  AND aagacti = 'Y'     #No.MOD-B70280 add

               DISPLAY g_apb[l_ac].b251 to b251        #FUN-710078 add

               IF SQLCA.sqlcode THEN
#                 CALL cl_err(g_apb[l_ac].apb251,'agl-001',0)   #No.FUN-660122
                  CALL cl_err3("sel","aag_file",g_apb[l_ac].apb251,"","agl-001","","",1)  #No.FUN-660122
                  NEXT FIELD apb251
               END IF
                #-----No:MOD-530422-----
               LET l_aag05=''   #FUN-8C0106 add
               SELECT aag05 INTO l_aag05 FROM aag_file
                WHERE aag01 = g_apb[l_ac].apb251
                  AND aag00 = g_bookno2      #No.FUN-730064
                  AND aagacti = 'Y'          #No.MOD-B70280 add

           #FUN-8C0106---add---str--- 
           #防止User只修改部門欄位時,未再次檢查會科與允許/拒絕部門關係
            LET g_errno = ' '   
            IF l_aag05 = 'Y' AND NOT cl_null(g_apb[l_ac].apb251) THEN
               IF g_aaz.aaz90 ='Y' THEN
                  IF NOT cl_null(g_apb[l_ac].apb930) THEN
                     CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb251,g_apb[l_ac].apb930,g_bookno2)                
                                   RETURNING g_errno
                  END IF 
               ELSE
                  IF NOT cl_null(g_apb[l_ac].apb26) THEN
                     CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb251,g_apb[l_ac].apb26,g_bookno2)                
                                   RETURNING g_errno
                  END IF
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,0)
                  NEXT FIELD apb26   #MOD-940326 mod apb251->apb26
               END IF
            END IF
           #FUN-8C0106---add---end---

#MOD-590301
##MOD-580051   科目有做科目部門管理的才CALL s_chkdept
#               IF STATUS OR SQLCA.SQLCODE THEN
#                  LET l_aag05=''
#               END IF
#                #-----No:MOD-530422 END-----
#                #-----No:MOD-530274-----

#               IF l_aag05 = 'Y' THEN
#                  CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb251,g_apb[l_ac].apb26) RETURNING g_errno     #No.FUN-730064
#               END IF
##               CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb251,g_apb[l_ac].apb26) RETURNING g_errno     #No.FUN-730064
##END MOD-580051
#END MOD-590301
               #No.TQC-7B0083  --Begin
               #IF NOT cl_null(g_errno) THEN
               #   CALL cl_err('',g_errno,0)
               #   NEXT FIELD apb251
               #END IF
               #No.TQC-7B0083  --End  
                #-----No:MOD-530274 END-----
               #No.FUN-830161  --Begin
               ##FUN-810045 begin
               # CALL t110_apb25()  
               # IF NOT cl_null(g_errno) THEN
               #   CASE g_errno
               #     WHEN "apb25"
               #       NEXT FIELD apb25
               #     WHEN "apb251"
               #       NEXT FIELD apb251
               #     WHEN "apb26"
               #       NEXT FIELD apb26
               #     #No.FUN-830161  --Begin
               #     #WHEN "apb30"
               #     #  NEXT FIELD apb30
               #     #No.FUN-830161  --End  
               #   END CASE
               # END IF
               ##FUN-810045 end
               #No.FUN-830161  --End  

            END IF
            IF NOT cl_null(g_apb[l_ac].apb06) AND NOT cl_null(g_apb[l_ac].apb07) THEN
               #LET g_t1 = g_apb[l_ac].apb06   #MOD-630070
               LET g_t1 = s_get_doc_no(g_apb[l_ac].apb06)   #MOD-630070
               SELECT smy59 INTO l_smy59 FROM smy_file WHERE smyslip = g_t1
               SELECT COUNT(*) INTO g_cnt FROM pmn_file,pmm_file
                WHERE pmn01=g_apb[l_ac].apb06 AND pmn02=g_apb[l_ac].apb07
                  AND pmn01=pmm01 AND pmm18='Y' AND pmm02 = 'SUB' #委外
               IF g_cnt > 0 THEN    #委外採購
                  IF g_apy.apydmy5 = 'Y' THEN   #預算控管
                     SELECT pmn401 INTO l_pmn40 FROM pmn_file  #No.FUN-830161
                      WHERE pmn01=g_apb[l_ac].apb06 AND pmn02=g_apb[l_ac].apb07
                     IF l_pmn40!=g_apb[l_ac].apb251 THEN
                        CALL cl_err(g_apb[l_ac].apb251,'apm-311',0)
                        NEXT FIELD apb251
                     END IF
                  END IF
               ELSE
                  IF g_apy.apydmy5 = 'Y' AND l_smy59 = 'Y' THEN   #作預算控管
                     SELECT pmn401 INTO l_pmn40 FROM pmn_file  #No.FUN-830161
                      WHERE pmn01=g_apb[l_ac].apb06 AND pmn02=g_apb[l_ac].apb07
                     IF l_pmn40!=g_apb[l_ac].apb251 THEN
                        CALL cl_err(g_apb[l_ac].apb251,'apm-311',0)
                        NEXT FIELD apb251
                     END IF
                  END IF
               END IF
            END IF
            #No.FUN-830161  --Begin
            IF g_aptype[1,1] = '1' THEN
               CALL t110_bud(p_cmd,'2')
               IF NOT cl_null(g_errno) THEN
                  NEXT FIELD apb251
               END IF
            END IF
            #No.FUN-830161  --End
#No.FUN-680029--end

        AFTER FIELD apb26
           #MOD-9C0264---add---start---
            IF cl_null(g_apb[l_ac].apb25) THEN
               LET l_aag05 = 'N'
            ELSE
               LET l_sql = "SELECT aag05 FROM aag_file ",
                           " WHERE aag01 = '",g_apb[l_ac].apb25,"' ",
                           "   AND aag00 = '",g_bookno1,"' ",
                           "   AND aagacti = 'Y'"                #No.MOD-B70280 add
               PREPARE aag05_cs2 FROM l_sql
               EXECUTE aag05_cs2 INTO l_aag05
            END IF
           #MOD-9C0264---add---end---
            #No.FUN-830161  --Begin
           #IF (l_aag05 = 'Y' OR g_apy.apydmy5='Y')   #No:MOD-530422
            IF  l_aag05 = 'Y'                         #No:MOD-530422
               AND g_apa.apa00[1,1]='1' AND cl_null(g_apb[l_ac].apb26) THEN
               CALL cl_err(g_apb[l_ac].apb26,'mfg0037',0)
               NEXT FIELD apb26
            END IF
            #No.FUN-830161  --End  
            IF NOT cl_null(g_apb[l_ac].apb26) THEN
              #SELECT gem02 FROM gem_file                         #FUN-710078 mark
               SELECT gem02 INTO g_apb[l_ac].b26 FROM gem_file    #FUN-710078 mod
                WHERE gem01 = g_apb[l_ac].apb26 AND gem05 = 'Y'
                  AND gemacti='Y'   #NO:6950

               IF SQLCA.sqlcode THEN
#                 CALL cl_err(g_apb[l_ac].apb26,'agl-003',0)   #No.FUN-660122
                  CALL cl_err3("sel","gem_file",g_apb[l_ac].apb26,"","agl-003","","",1)  #No.FUN-660122
                  NEXT FIELD apb26
               END IF

               #No.FUN-830161  --Begin
               ##FUN-810045 begin
               # CALL t110_apb25()  
               # IF NOT cl_null(g_errno) THEN
               #   CASE g_errno
               #     WHEN "apb25"
               #       NEXT FIELD apb25
               #     WHEN "apb251"
               #       NEXT FIELD apb251
               #     WHEN "apb26"
               #       NEXT FIELD apb26
               #     #No.FUN-830161  --Begin
               #     #WHEN "apb30"
               #     #  NEXT FIELD apb30
               #     #No.FUN-830161  --End  
               #   END CASE
               # END IF
               ##FUN-810045 end
               #No.FUN-830161  --End  
            END IF

            DISPLAY g_apb[l_ac].b26 to b26         #FUN-710078 mod

            IF NOT cl_null(g_apb[l_ac].apb06) AND
               NOT cl_null(g_apb[l_ac].apb07) THEN
               #LET g_t1 = g_apb[l_ac].apb06   #MOD-630070
               LET g_t1 = s_get_doc_no(g_apb[l_ac].apb06)   #MOD-630070
               SELECT smy59 INTO l_smy59 FROM smy_file WHERE smyslip = g_t1
               SELECT COUNT(*) INTO g_cnt FROM pmn_file,pmm_file
                WHERE pmn01=g_apb[l_ac].apb06 AND pmn02=g_apb[l_ac].apb07
                  AND pmn01=pmm01 AND pmm18='Y' AND pmm02 = 'SUB'  #委外
               IF g_cnt > 0 THEN    #委外採購
                  IF g_apy.apydmy5 = 'Y' THEN   #預算控管
                     SELECT pmn67 INTO l_pmn67 FROM pmn_file
                      WHERE pmn01=g_apb[l_ac].apb06 AND pmn02=g_apb[l_ac].apb07
                     IF l_pmn67!=g_apb[l_ac].apb26 THEN
                        CALL cl_err(g_apb[l_ac].apb26,'apm-311',0)
                        NEXT FIELD apb26
                     END IF
                  END IF
               ELSE
                  IF g_apy.apydmy5 = 'Y' AND l_smy59 = 'Y' THEN   #作預算控管
                     SELECT pmn67 INTO l_pmn67 FROM pmn_file
                      WHERE pmn01=g_apb[l_ac].apb06 AND pmn02=g_apb[l_ac].apb07
                     IF l_pmn67!=g_apb[l_ac].apb26 THEN
                        CALL cl_err(g_apb[l_ac].apb26,'apm-311',0)
                        NEXT FIELD apb26
                     END IF
                  END IF
               END IF
            END IF
#MOD-590301 防止User只修改部門欄位時,未再次檢查會科與允許/拒絕部門關係

           #FUN-8C0106---add---str---
            LET l_aag05=''   
            SELECT aag05 INTO l_aag05 FROM aag_file
             WHERE aag01 = g_apb[l_ac].apb25
               AND aag00 = g_bookno1      
               AND aagacti = 'Y'     #No.MOD-B70280 add
           #FUN-8C0106---add---end---

            LET g_errno = ' '   #MOD-5B0255
            IF l_aag05 = 'Y' AND NOT cl_null(g_apb[l_ac].apb25) THEN
              #str CHI-8C0005 mod
              #CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb25,g_apb[l_ac].apb26,g_bookno1)    #No.FUN-730064
              #              RETURNING g_errno
              #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
              #FUN-8C0106---mark---str---
              #IF g_aaz.aaz90 ='Y' THEN
              #   CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb25,g_apb[l_ac].apb930,g_bookno1)    #No.FUN-730064
              #                 RETURNING g_errno
              #ELSE
              #FUN-8C0106---mark---end---
               IF g_aaz.aaz90 !='Y' THEN    #FUN-8C0106 add
                  CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb25,g_apb[l_ac].apb26,g_bookno1)    #No.FUN-730064
                                RETURNING g_errno
               END IF
              #end CHI-8C0005 mod
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,0)
                  NEXT FIELD apb25   #MOD-940326 mod apb26->apb25
               END IF
            END IF
#No.FUN-680029--begin
           #FUN-8C0106---add---str---
            IF g_aza.aza63='Y' THEN 
               LET l_aag05=''   
               SELECT aag05 INTO l_aag05 FROM aag_file
                WHERE aag01 = g_apb[l_ac].apb251
                  AND aag00 = g_bookno2      
                  AND aagacti = 'Y'     #No.MOD-B70280 add
              #FUN-8C0106---add---end---
               LET g_errno = ' '   #MOD-5B0255
               IF l_aag05 = 'Y' AND NOT cl_null(g_apb[l_ac].apb251) THEN
                 #str CHI-8C0005 mod
                 #CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb251,g_apb[l_ac].apb26,g_bookno2)    #No.FUN-730064
                 #              RETURNING g_errno
                 #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
               
                 #FUN-8C0106---mark---str---
                 #IF g_aaz.aaz90 ='Y' THEN
                 #   CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb251,g_apb[l_ac].apb930,g_bookno2)    #No.FUN-730064
                 #                 RETURNING g_errno
                 #ELSE
                 #FUN-8C0106---mark---end---
                  IF g_aaz.aaz90 !='Y' THEN   #FUN-8C0106 add
                     CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb251,g_apb[l_ac].apb26,g_bookno2)    #No.FUN-730064
                                   RETURNING g_errno
                  END IF
                 #end CHI-8C0005 mod
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err('',g_errno,0)
                     NEXT FIELD apb251  #MOD-940326 mod apb26->apb251
                  END IF
               END IF
            END IF  #FUN-8C0106 add
#No.FUN-680029--end
#END MOD-590301
            #No.FUN-830161  --Begin
            IF g_aptype[1,1] = '1' THEN
               CALL t110_bud(p_cmd,'3')
               IF NOT cl_null(g_errno) THEN
                  NEXT FIELD apb26 
               END IF
            END IF
            #IF g_aza.aza63 = 'Y' THEN NEXT FIELD apb251 END IF
            #No.FUN-830161  --End

        AFTER FIELD apb23
           IF NOT cl_null(g_apb[l_ac].apb23) THEN #No.TQC-7B0063
             #No.TQC-7B0063--begin-- add
              IF g_apb[l_ac].apb23 < 0 THEN
                 CALL cl_err(g_apb[l_ac].apb23,'aap-505',0)
                 LET g_apb[l_ac].apb23 = NULL
                 NEXT FIELD apb23
              END IF
             #No.TQC-7B0063---end--- add
             #LET g_apb[l_ac].apb23 = cl_digcut(g_apb[l_ac].apb23,g_azi.azi03)   #No:BUG-530274   #No:MOD-560236   #MOD-6B0066
              LET g_apb[l_ac].apb23 = cl_digcut(g_apb[l_ac].apb23,t_azi03)   #No:BUG-530274   #No:MOD-560236   #MOD-6B0066
              DISPLAY BY NAME g_apb[l_ac].apb23   #No:MOD-530247
             #str MOD-950058 add
              IF g_aptype = '26' THEN
                #str MOD-940411 mod
                #倉退暫估單apa00='26'
                #若單身有輸入採購單(apb06,apb07),則回採購單抓未稅單價(pmn31)
                 IF NOT cl_null(g_apb[l_ac].apb06) AND
                    NOT cl_null(g_apb[l_ac].apb07) THEN
                    LET l_pmn31=0
                    SELECT pmn31 INTO l_pmn31 FROM pmn_file
                     WHERE pmn01=g_apb[l_ac].apb06 AND pmn02=g_apb[l_ac].apb07
                    IF g_apb[l_ac].apb23 > l_pmn31  THEN
                       CALL cl_err('','aap-939',1)   #單價不可大於採購單價
                       NEXT FIELD apb23
                    END IF
                 END IF
                #end MOD-940411 mod
              END IF
             #end MOD-950058 add
              IF g_aptype = '11' THEN
                #IF g_apb[l_ac].apb23 > g_rvb10  THEN  #判斷原幣單價  #No.TQC-7B0109
                 IF g_apb[l_ac].apb23 > l_rvv38  THEN                 #No.TQC-7B0109
                   #LET l_message = '單價不可大於採購單價(',g_rvb10,') !!!!'   #MOD-560240
                   #CALL cl_err(l_message,'mfg-012',1)   #MOD-560240
                   #CALL cl_err('','aap-908',1)   #MOD-560240 #No.FUN-680029   #No.TQC-7B0109
                    CALL cl_err('','aap-976',1)   #單價不可大於入庫或倉退單價  #No.TQC-7B0109
                    NEXT FIELD apb23
                 END IF
              END IF
              LET g_apb[l_ac].apb08 = g_apb[l_ac].apb23 * g_apa.apa14
             #LET g_apb[l_ac].apb08 =cl_digcut(g_apb[l_ac].apb08,t_azi.azi03)     #No:MOD-510045   #MOD-6B0066
              LET g_apb[l_ac].apb08 =cl_digcut(g_apb[l_ac].apb08,g_azi03)     #No:MOD-510045   #MOD-6B0066
              DISPLAY BY NAME g_apb[l_ac].apb08   #No:MOD-5A0095
             #IF g_apb[l_ac].apb09>0 THEN   #No.TQC-7B0063 mark
                #str TQC-8A0079 mod
                #LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
                 #單價含稅時,不使用單價*數量=金額,改以含稅金額回推稅率,以避免小數位差的問題
                 LET l_gec04 = 0   LET l_gec07 = ''
                 #No:MOD-8C0020---Begin
                 #SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file
                 # WHERE gec01 = g_apa.apa15     
                 IF g_apb[l_ac].apb06 <> '' OR NOT cl_null(g_apb[l_ac].apb06) THEN  #TQC-8C0031 add
                   #SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file,pmm_file                  #MOD-A80052 mark
                    SELECT gec04,gec05,gec07 INTO l_gec04,l_gec05,l_gec07 FROM gec_file,pmm_file    #MOD-A80052
                     WHERE gec01 = pmm21 AND pmm01=g_apb[l_ac].apb06
                 #TQC-8C0031---Begin
                 ELSE
                   #SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file,pmm_file                  #MOD-A80052 mark
                    SELECT gec04,gec05,gec07 INTO l_gec04,l_gec05,l_gec07 FROM gec_file             #MOD-A80052
                     WHERE gec01 = g_apa.apa15
                 END IF 
                 #TQC-8C0031---End
                 #No:MOD-8C0020---End
                 IF cl_null(l_gec04) THEN LET l_gec04=0   END IF
                 IF cl_null(l_gec07) THEN LET l_gec07='N' END IF
                 LET l_rvv38t = 0
                 IF l_gec07='Y' AND
                    (g_aptype='11' OR g_aptype='16' OR     #MOD-960095 add
                     g_aptype='21' OR g_aptype='26') THEN  #MOD-960095 add
                    SELECT rvv38t INTO l_rvv38t FROM rvv_file
                     WHERE rvv01 = g_apb[l_ac].apb21
                       AND rvv02 = g_apb[l_ac].apb22
                    IF cl_null(l_rvv38t) THEN LET l_rvv38t=0 END IF
                    #MOD-920013---Begin
                    LET l_apb24t = l_rvv38t*g_apb[l_ac].apb09
                    LET l_apb24t = cl_digcut(l_apb24t,t_azi04)
                   #-MOD-A80052-add-
                    IF l_gec05 = 'T' THEN
                       LET l_apa32f = l_apb24t * (l_gec04/100)
                       LET l_apa32f = cl_digcut(l_apa32f , t_azi04)
                       LET g_apb[l_ac].apb24 = l_apb24t - l_apa32f 
                    ELSE
                       LET g_apb[l_ac].apb24 = l_apb24t/(1+l_gec04/100)
                    END IF  
                   #-MOD-A80052-end-
                   #LET g_apb[l_ac].apb24 = l_apb24t/(1+l_gec04/100)     #MOD-A80052 mark
                    #LET g_apb[l_ac].apb24 = (l_rvv38t*g_apb[l_ac].apb09)/(1+l_gec04/100)
                    #MOD-920013---End
                 ELSE
                  #str TQC-A10146 mark
                  ##str MOD-9A0201 add
                  ##aapt120雜項輸入時,稅別若為內含,輸入原幣單價後應為含稅單價,
                  ##需回推為未稅單價
                  # IF l_gec07='Y' AND g_aptype = '12' THEN
                  #    IF g_apb[l_ac].apb23 <> g_apb_t.apb23 OR 
                  #       cl_null(g_apb_t.apb23) THEN 
                  #       LET g_apb[l_ac].apb23 = cl_digcut(g_apb[l_ac].apb23/(1+l_gec04/100),t_azi03)
                  #       DISPLAY BY NAME g_apb[l_ac].apb23
                  #    END IF
                  # END IF
                  ##end MOD-9A0201 add
                  #end TQC-A10146 mark
                    LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
                 END IF
                #end TQC-8A0079 mod
                 #LET g_apb[l_ac].apb24 =cl_digcut(g_apb[l_ac].apb24,g_azi.azi04)   #MOD-6B0066
                 LET g_apb[l_ac].apb24 =cl_digcut(g_apb[l_ac].apb24,t_azi04)   #MOD-6B0066
                #-MOD-A90146-add-
                 IF g_aptype = '12' THEN     #MOD-AB0167
                    CALL t110_chkapb24()               
                    IF g_apb[l_ac].apb34 = 'Y' AND g_apb[l_ac].apb24 > g_apb24 THEN
                       LET g_apb[l_ac].apb24 = g_apb24
                       CALL cl_err(g_apb[l_ac].apb23,'aap-972',1)
                       NEXT FIELD apb23
                    END IF
                 END IF                      #MOD-AB0167
                #-MOD-A90146-end-
                 #------No:MOD-5A0095 START-------------------
                 DISPLAY BY NAME g_apb[l_ac].apb24
                 #------No:MOD-5A0095 END---------------------
             #END IF                        #No.TQC-7B0063 mark
              #No.TQC-7B0063---end---
              LET g_apb[l_ac].apb08 = g_apb[l_ac].apb23 * g_apa.apa14        #MOD-9A0201 add
              LET g_apb[l_ac].apb08 =cl_digcut(g_apb[l_ac].apb08,g_azi03)    #MOD-9A0201 add
              LET g_apb[l_ac].apb10 =g_apb[l_ac].apb24 * g_apa.apa14        #MOD-840632   #MOD-860221 mark回復
             #LET g_apb[l_ac].apb10 =g_apb[l_ac].apb08 * g_apb[l_ac].apb09  #MOD-840632   #MOD-860221 mark
             #LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,t_azi.azi04)   #MOD-6B0066
              LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)   #MOD-6B0066
              #------No:MOD-5A0095 START-------------------
              DISPLAY BY NAME g_apb[l_ac].apb08
              DISPLAY BY NAME g_apb[l_ac].apb10
              #------No:MOD-5A0095 END---------------------
              #No.FUN-830161  --Begin
              IF g_aptype[1,1] = '1' THEN
                 CALL t110_bud(p_cmd,'3')
                 IF NOT cl_null(g_errno) THEN
                    NEXT FIELD apb23 
                 END IF
              END IF
              #No.FUN-830161  --End
           END IF    #No.TQC-7B0063

        AFTER FIELD apb24
           #MOD-740070
           IF cl_null(g_apb[l_ac].apb24) OR g_apb[l_ac].apb24 = ' ' THEN
              CALL cl_err('','aap-201',0)
              NEXT FIELD apb24
           END IF

           #MOD-740070
#MOD-580051 金額不可為0
           IF g_aptype <> '11' THEN   #TQC-630188
              IF (g_apa.apa00='15' AND 
                  ( g_apz.apz61='1' OR 
                   (g_apz.apz61='3' AND l_pmc913='Y'))) OR 
                 g_apa.apa00!='15' THEN #MOD-9A0135
                 IF g_apb[l_ac].apb24 <= 0 THEN
                    CALL cl_err('','aap-201',0)
                    NEXT FIELD apb24
                 END IF
              END IF  #MOD-9A0135
           #-----TQC-630188---------
           ELSE
              IF g_apb[l_ac].apb24 = 0 THEN
                 CALL cl_err('','aap-201',0)
                #NEXT FIELD apb24   #MOD-B30183 mark
              END IF
           END IF
           #-----END TQC-630188-----
#END MOD-580051
           #No:FUN-880094---Begin
          #IF g_aptype = '15' THEN                                                                   #MOD-A90181 mark
           IF g_aptype = '15' AND (g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y')) THEN  #MOD-A90181
              IF NOT cl_null(g_apb[l_ac].apb06) THEN   #MOD-9C0457 add
                 IF NOT cl_null(g_apb[l_ac].apb07) THEN   #MOD-9A0032 add
                   #MOD-9A0113   ---start
                   #已預付金額
                    LET l_apb24 = 0
                    SELECT SUM(apb24) INTO l_apb24 FROM apb_file,apa_file
                     WHERE apa01 =apb01 AND apa00 ='15'
                       AND apb06 =g_apb[l_ac].apb06
                       AND apb07 =g_apb[l_ac].apb07  
                       AND (apb01!=g_apa.apa01 OR (apb01=g_apa.apa01 AND apb02!=g_apb[l_ac].apb02))
                    IF cl_null(l_apb24) THEN LET l_apb24 = 0 END IF 
                   #MOD-9A0113   ---end 
                    SELECT pmn87,pmn31,pmn31t         #MOD-970049 add pmn31t
                      INTO l_pmn87,l_pmn31,l_pmn31t   #MOD-970049 add l_pmn31t
                      FROM pmn_file
                     WHERE pmn01=g_apb[l_ac].apb06 AND pmn02=g_apb[l_ac].apb07 
                   #str CHI-9C0015 add
                    #抓取採購單稅率,稅別是否含稅
                    LET l_pmm40t = 0  LET l_pmm43 = 0  LET l_gec07=''
                    SELECT pmm43,gec07 INTO l_pmm43,l_gec07
                      FROM pmm_file,gec_file
                     WHERE pmm01=g_apb[l_ac].apb06
                       AND pmm21=gec01 AND gec011='1'  #進項
                    #若稅別是含稅,則含稅金額=數量*含稅單價
                    #若稅別不含稅,則含稅金額=數量*未稅單價*(1+稅率/100)
                    IF l_gec07 = 'Y' THEN
                       LET l_pmm40t = l_pmn87*l_pmn31t
                    ELSE 
                       LET l_pmm40t = (l_pmn87*l_pmn31)*(1+l_pmm43/100)
                    END IF
                    IF cl_null(l_pmm40t) THEN LET l_pmm40t=0 END IF
                   #end CHI-9C0015 add
                   #IF g_apb[l_ac].apb24 > l_pmn87*l_pmn31 THEN                     #MOD-930245 mark
                   #IF g_apb[l_ac].apb24 > cl_digcut(l_pmn87*l_pmn31,t_azi04) THEN  #MOD-930245    #MOD-970049 mark
                   #IF g_apb[l_ac].apb24 > cl_digcut(l_pmn87*l_pmn31t,t_azi04) THEN         #MOD-970049 add  #MOD-9A0113
                   #IF g_apb[l_ac].apb24 > cl_digcut(l_pmn87*l_pmn31t,t_azi04)-l_apb24 THEN  #MOD-9A0113
                    IF g_apb[l_ac].apb24 > cl_digcut(l_pmm40t,t_azi04)-l_apb24 THEN  #MOD-9A0113
                       CALL cl_err(g_apb[l_ac].apb24,'aap-937',0) 
                       NEXT FIELD apb24
                    END IF
                #MOD-9A0032---add---start---
                 ELSE
                   #MOD-9A0113   ---start
                   #已預付金額
                    LET l_apb24 = 0
                    SELECT SUM(apb24) INTO l_apb24 FROM apb_file,apa_file
                     WHERE apa01 =apb01 AND apa00 ='15'
                       AND apb06 =g_apb[l_ac].apb06
                       AND ( apb01!=g_apa.apa01 OR 
                            (apb01=g_apa.apa01 AND apb02!=g_apb[l_ac].apb02))
                    IF cl_null(l_apb24) THEN LET l_apb24 = 0 END IF 
                    LET l_pmn87_pmn31t = 0   #MOD-9C0145 add
                   #MOD-9A0113   ---end
                   #SELECT SUM(pmn87*pmn31t) INTO l_pmn87_pmn31t   #CHI-9C0015 mark
                    SELECT SUM(pmn88t) INTO l_pmn87_pmn31t         #CHI-9C0015  
                      FROM pmn_file         
                     WHERE pmn01=g_apb[l_ac].apb06
                    IF cl_null(l_pmn87_pmn31t) THEN LET l_pmn87_pmn31t = 0 END IF  #MOD-9C0145 add
                   #IF g_apb[l_ac].apb24 > cl_digcut(l_pmn87_pmn31t,t_azi04) THEN #MOD-9A0113  
                    IF g_apb[l_ac].apb24 > cl_digcut(l_pmn87_pmn31t,t_azi04)-l_apb24 THEN #MOD-9A0113  
                       CALL cl_err(g_apb[l_ac].apb24,'aap-937',0) 
                       NEXT FIELD apb24
                    END IF
                 END IF
                #MOD-9A0032---add---end---
              END IF   #MOD-9C0457 add
           END IF
           #No:FUN-880094---End
           #LET g_apb[l_ac].apb24 = cl_digcut(g_apb[l_ac].apb24,g_azi.azi04)   #No:MOD-530274   #MOD-6B0066
           LET g_apb[l_ac].apb24 = cl_digcut(g_apb[l_ac].apb24,t_azi04)  #No:MOD-530274   #MOD-6B0066
          #-MOD-A90146-add-
           IF g_aptype = '12' THEN     #MOD-AB0167
              CALL t110_chkapb24()               
              IF g_apb[l_ac].apb34 = 'Y' AND g_apb[l_ac].apb24 > g_apb24 THEN
                 LET g_apb[l_ac].apb24 = g_apb24
                 CALL cl_err(g_apb[l_ac].apb24,'aap-972',1)
                 NEXT FIELD apb24
              END IF
           END IF                      #MOD-AB0167
          #-MOD-A90146-end-
           DISPLAY BY NAME g_apb[l_ac].apb24   #No:MOD-530247
           LET g_apb[l_ac].apb10 =g_apb[l_ac].apb24 * g_apa.apa14        #MOD-840632   #MOD-860221 mark回復
          #LET g_apb[l_ac].apb10 =g_apb[l_ac].apb08 * g_apb[l_ac].apb09  #MOD-840632   #MOD-860221 mark
          #LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,t_azi.azi04)   #MOD-6B0066
           LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)   #MOD-6B0066
#          CALL FGL_DIALOG_SETBUFFER(g_apb[l_ac].apb10)
           #------No:MOD-5A0095 START-------------------
           DISPLAY BY NAME g_apb[l_ac].apb10
           #------No:MOD-5A0095 END---------------------
           #No.FUN-830161  --Begin
           IF g_aptype[1,1] = '1' THEN
              CALL t110_bud(p_cmd,'3')
              IF NOT cl_null(g_errno) THEN
                 NEXT FIELD apb24 
              END IF
           END IF
           #No.FUN-830161  --End
          #-MOD-C20104-add-
          #-MOD-C20206-mark-
          #IF g_apb[l_ac].apb34 = 'Y' THEN  
          #   LET l_cnt = 0
          #   SELECT COUNT(*) INTO l_cnt
          #     FROM api_file
          #    WHERE api01 = g_apa.apa01
          #      AND api02 = '2'
          #      AND api03 = g_apb[l_ac].apb02
          #   IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
          #   IF l_cnt > 0 THEN 
          #      UPDATE api_file set api05 = g_apb[l_ac].apb10
          #       WHERE api01 = g_apa.apa01
          #         AND api02 = '2'
          #         AND api03 = g_apb[l_ac].apb02
          #   END IF 
          #END IF 
          #-MOD-C20206-end-
          #-MOD-C20104-end-
          #-------------------MOD-CA0049------------------------(S)
           IF g_apb[l_ac].apb34 = 'Y' AND g_apa.apa14 = 1 THEN
              LET l_cnt = 0
              SELECT COUNT(*) INTO l_cnt
                FROM api_file
               WHERE api01 = g_apa.apa01
                 AND api02 = '2'
                 AND api03 = g_apb[l_ac].apb02
              IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
              IF l_cnt > 0 THEN
                 UPDATE api_file SET api05 = g_apb[l_ac].apb10,
                                     api05f =g_apb[l_ac].apb24
                  WHERE api01 = g_apa.apa01
                    AND api02 = '2'
                    AND api03 = g_apb[l_ac].apb02
              END IF
           END IF
          #-------------------MOD-CA0049------------------------(E)
           
 
        AFTER FIELD apb10
           IF NOT cl_null(g_apb[l_ac].apb10) THEN
              #MOD-580051 金額不可為0
              IF g_aptype <> '11' THEN   #TQC-630188
                 IF g_apb[l_ac].apb10 <= 0 THEN
                    CALL cl_err('','aap-201',0)
                    NEXT FIELD apb10
                 END IF
              #-----TQC-630188---------
              ELSE
                 IF g_apb[l_ac].apb10 = 0 THEN
                    CALL cl_err('','aap-201',0)
                   #NEXT FIELD apb10   #MOD-B30183 mark
                 END IF
              END IF
              #-----END TQC-630188-----
             #str CHI-850025 add
             #當匯率為1時,需檢核原幣與本幣的稅額、金額需相同
             #IF g_apa.apa14 = 1 THEN                                 #MOD-880041 mark
              IF g_apa.apa14 = 1 AND g_aza.aza17 = g_apa.apa13 THEN   #MOD-880041
                 IF g_apb[l_ac].apb24!=g_apb[l_ac].apb10 THEN
                    CALL cl_err('','apm-988',1)
                    NEXT FIELD apb10
                 END IF
              END IF
             #end CHI-850025 add
            #-MOD-A90146-add-
             IF g_aptype = '12' THEN     #MOD-AB0167
                CALL t110_chkapb24()               
                IF g_apb[l_ac].apb34 = 'Y' AND g_apb[l_ac].apb10 > g_apb10 THEN
                   LET g_apb[l_ac].apb10 = g_apb10
                   CALL cl_err(g_apb[l_ac].apb10,'aap-971',1)
                   NEXT FIELD apb10
                END IF
             END IF                      #MOD-AB0167
            #-MOD-A90146-end-
              #END MOD-580051
              #No:FUN-880094---Begin
              IF g_aptype = '15' THEN
                #IF g_apb[l_ac].apb10 > g_apb[l_ac].apb24 * g_apa.apa14 THEN #No.MOD-930266 mark
                 IF g_apb[l_ac].apb10 > cl_digcut(g_apb[l_ac].apb24 * g_apa.apa14,g_azi04) THEN  #No.MOD-930266
                    CALL cl_err(g_apb[l_ac].apb10,'aap-938',0)
                    NEXT FIELD apb10
                 END IF
              END IF
              #No:FUN-880094---End
              #LET g_apb[l_ac].apb10 = cl_digcut(g_apb[l_ac].apb10,t_azi.azi04)   #No:MOD-530274   #MOD-6B0066
               LET g_apb[l_ac].apb10 = cl_digcut(g_apb[l_ac].apb10,g_azi04)   #No:MOD-530274   #MOD-6B0066
               DISPLAY BY NAME g_apb[l_ac].apb10   #No:MOD-530247
               #IF g_apa.apa00 <> '15' THEN   #MOD-580079   #MOD-660132
               IF g_apa.apa00 = '11' THEN   #MOD-660132
                 CALL t110_compute_apa33()
               END IF   #MOD-580079
               #No.FUN-830161  --Begin
               IF g_aptype[1,1] = '1' THEN
                  CALL t110_bud(p_cmd,'3')
                  IF NOT cl_null(g_errno) THEN
                     NEXT FIELD apb26 
                  END IF
               END IF
               #No.FUN-830161  --End
           END IF

        #FUN-670064...............begin
        AFTER FIELD apb930 
          #str MOD-910109 add
           IF g_aaz.aaz90 ='Y' AND
              (l_aag05 = 'Y' OR g_apy.apydmy5='Y')
              AND g_apa.apa00[1,1]='1' AND cl_null(g_apb[l_ac].apb930) THEN
              CALL cl_err(g_apb[l_ac].apb930,'mfg0037',0)
              NEXT FIELD apb930
           END IF
          #end MOD-910109 add
           #-----MOD-950284---------
           IF g_aptype[1,1] = '1' THEN
              CALL t110_bud(p_cmd,'3')
              IF NOT cl_null(g_errno) THEN
                 NEXT FIELD apb930 
              END IF
           END IF
           #-----END MOD-950284-----
           IF NOT s_costcenter_chk(g_apb[l_ac].apb930) THEN
              LET g_apb[l_ac].apb930=g_apb_t.apb930
              LET g_apb[l_ac].gem02c=g_apb_t.gem02c
              DISPLAY BY NAME g_apb[l_ac].apb930,g_apb[l_ac].gem02c
              NEXT FIELD apb930
           ELSE
              LET g_apb[l_ac].gem02c=s_costcenter_desc(g_apb[l_ac].apb930)
              DISPLAY BY NAME g_apb[l_ac].gem02c
           END IF

           #FUN-8C0106---add---str--- 
           #防止User只修改部門欄位時,未再次檢查會科與允許/拒絕部門關係
            LET l_aag05=''   
            SELECT aag05 INTO l_aag05 FROM aag_file
             WHERE aag01 = g_apb[l_ac].apb25
               AND aag00 = g_bookno1      
               AND aagacti = 'Y'     #No.MOD-B70280 add

            LET g_errno = ' '   
            IF l_aag05 = 'Y' AND NOT cl_null(g_apb[l_ac].apb25) THEN
              #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
               IF g_aaz.aaz90 ='Y' THEN
                  CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb25,g_apb[l_ac].apb930,g_bookno1)  
                                RETURNING g_errno
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,0)
                  NEXT FIELD apb25   #MOD-940326 mod apb930->apb25
               END IF
            END IF

           #會科二
            IF g_aza.aza63='Y' THEN
               LET l_aag05=''   
               SELECT aag05 INTO l_aag05 FROM aag_file
                WHERE aag01 = g_apb[l_ac].apb251
                  AND aag00 = g_bookno2     
                  AND aagacti = 'Y'     #No.MOD-B70280 add 
               
               LET g_errno = ' '   
               IF l_aag05 = 'Y' AND NOT cl_null(g_apb[l_ac].apb251) THEN
                  IF g_aaz.aaz90 ='Y' THEN
                     CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb251,g_apb[l_ac].apb930,g_bookno2)                
                                   RETURNING g_errno
                  END IF
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err('',g_errno,0)
                     NEXT FIELD apb251  #MOD-940326 mod apb930->apb251
                  END IF
               END IF
            END IF
           #FUN-8C0106---add---end---

        #FUN-670064...............end

      #FUN-850038     ---start---
      AFTER FIELD apbud01
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apbud02
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apbud03
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apbud04
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apbud05
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apbud06
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apbud07
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apbud08
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apbud09
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apbud10
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apbud11
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apbud12
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apbud13
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apbud14
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

      AFTER FIELD apbud15
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
      #FUN-850038     ----end----

       #MOD-740070 begin
        AFTER INPUT
          IF l_ac <= g_apb.getLength() THEN   #MOD-B80127 add
#No.MOD-B40261 --begin #CHI-B80023 mark
           #IF g_apz.apz61='1' AND g_aptype ='15' THEN
           #   IF cl_null(g_apb[l_ac].apb06) THEN
           #      NEXT FIELD apb06
           #   END IF
           #   IF cl_null(g_apb[l_ac].apb07) THEN
           #      NEXT FIELD apb07
           #   END IF
           #END IF     #CHI-B80023 mark
#No.MOD-B40261 --end
            IF NOT cl_null(g_apb[l_ac].apb02) THEN #CHI-750003
               IF cl_null(g_apb[l_ac].apb24) OR g_apb[l_ac].apb24 = ' ' THEN
                  CALL cl_err('','aap-201',0)
                  NEXT FIELD apb24
               END IF
               IF g_aptype <> '11' THEN   
                  IF (g_apa.apa00='15' AND 
                      ( g_apz.apz61='1' OR 
                       (g_apz.apz61='3' AND l_pmc913='Y'))) OR 
                     g_apa.apa00!='15' THEN #MOD-9A0135
                     IF g_apb[l_ac].apb24 <= 0 THEN
                        CALL cl_err('','aap-201',0)
                        NEXT FIELD apb24
                     END IF
                  END IF #MOD-9A0135
               ELSE
                  IF g_apb[l_ac].apb24 = 0 THEN
                     CALL cl_err('','aap-201',0)
                    #NEXT FIELD apb24   #MOD-B30183 mark
                  END IF
               END IF
              #-MOD-A90146-add-
               IF g_aptype = '12' THEN   
                  CALL t110_chkapb24()               
                  IF g_apb[l_ac].apb34 = 'Y' AND g_apb[l_ac].apb24 > g_apb24 THEN
                     LET g_apb[l_ac].apb24 = g_apb24
                     CALL cl_err(g_apb[l_ac].apb24,'aap-972',1)
                     NEXT FIELD apb24
                  END IF
                  IF g_apb[l_ac].apb34 = 'Y' AND g_apb[l_ac].apb10 > g_apb10 THEN
                     LET g_apb[l_ac].apb10 = g_apb10
                     CALL cl_err(g_apb[l_ac].apb10,'aap-971',1)
                     NEXT FIELD apb10
                  END IF
               END IF
              #-MOD-A90146-end-
            #No.FUN-830161  --Begin
            ##FUN-810045 begin
            # CALL t110_apb25()  
            # IF NOT cl_null(g_errno) THEN
            #   CASE g_errno
            #     WHEN "apb25"
            #       NEXT FIELD apb25
            #     WHEN "apb251"
            #       NEXT FIELD apb251
            #     WHEN "apb26"
            #       NEXT FIELD apb26
            #     #No.FUN-830161  --Begin
            #     #WHEN "apb30"
            #     #  NEXT FIELD apb30
            #     #No.FUN-830161  --End  
            #   END CASE
            # END IF
            ##FUN-810045 end
            #No.FUN-830161  --End  
            END IF
            #MOD-740070 end
          END IF   #MOD-B80127 add
          #No.TQC-7B0083  --Begin
          LET l_apb10 = 0    LET l_apb24 = 0
          SELECT SUM(apb10),SUM(apb24) INTO l_apb10,l_apb24
            FROM apb_file
           WHERE apb01 = g_apa.apa01
          IF cl_null(l_apb10) THEN LET l_apb10 = 0 END IF
          IF cl_null(l_apb24) THEN LET l_apb24 = 0 END IF
          IF l_apb10 < 0 OR l_apb24 < 0 THEN
             CALL cl_err(l_apb10,'axr-029',1)
             NEXT FIELD apb10
          END IF
          #No.TQC-7B0083  --End

        #MOD-C50035---S---
         SELECT SUM(apb10),SUM(apk06),SUM(apk08)             
           INTO l_apb10,l_apk06,l_apk08                    
           FROM apb_file,apk_file
          WHERE apk01 = g_apa.apa01
            AND apb01 = g_apa.apa01
         DISPLAY  l_gec05,l_gec07

         IF l_gec05 = 'T' OR l_gec05 = 'A' OR l_gec07 = 'N' OR
            (l_gec05 = '2' AND l_gec07 = 'Y') THEN
            IF l_apb10 > l_apk08 THEN
               CALL cl_err('','aap-051',1)
　　　　　　   NEXT FIELD apb10
            ELSE
               IF l_apb10 < l_apk08 THEN
                  CALL cl_err('','tis-002',1)
                  NEXT FIELD apb10
               END IF
            END IF
         ELSE

            IF l_apb10 > l_apk06 THEN
               CALL cl_err('','aap-051',1)
　　　   　　　NEXT FIELD apb10
            ELSE
               IF l_apb10 < l_apk06 THEN
                  CALL cl_err('','tis-002',1)
                  NEXT FIELD apb10
               END IF
            END IF                                   
          END IF
        #MOD-C50035---E---
         
          #CHI-A40005 add --start--
          LET l_cnt = 0
          SELECT COUNT(*) INTO l_cnt FROM apk_file WHERE apk01 = g_apa.apa01
          IF (g_apa.apa00= '21' AND  g_apa.apa58 = '3') OR 
             (g_apa.apa00= '21' AND  g_apa.apa58 = '2' AND 
             #g_apa.apa08 <> 'UNAP' AND l_cnt = 0 ) THEN          #No.MOD-B80053 mark
              g_apa.apa08 <> 'UNAP' AND l_change = 'Y' ) THEN     #No.MOD-B80053 add
             SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01 = g_apa.apa15                                                     
             IF l_gec05 != 'X' AND g_aza.aza26 <> '2' THEN     
                CALL t110_21_ins2(g_apa.*)
                IF g_success='N' THEN
                   LET g_success = 'N'
                   CALL cl_err(g_apa.apa01,'aap-013',1)
                   NEXT FIELD apb02
                END IF
             END IF 
          END IF
          #CHI-A40005 add --end--
         #-MOD-B80193-add-
          IF g_aptype = '15' AND   (g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y')) THEN 
             SELECT SUM(apb24),SUM(apb10) INTO g_apa.apa57f,g_apa.apa57
               FROM apb_file 
              WHERE apb01=g_apa.apa01
             IF g_apa.apa57f IS NULL THEN
                LET g_apa.apa57f= 0
             END IF
             IF g_apa.apa57  IS NULL THEN
                LET g_apa.apa57 = 0
             END IF
             LET g_apa.apa57f=cl_digcut(g_apa.apa57f,t_azi04)   
             LET g_apa.apa57=cl_digcut(g_apa.apa57,g_azi04)   
             LET g_apa.apa31f= g_apa.apa57f   
             LET g_apa.apa31 = g_apa.apa57   
             LET g_apa.apa32 = g_apa.apa57*g_apa.apa16/100   
             CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
             LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add 
             LET g_apa.apa32f = g_apa.apa57f*g_apa.apa16/100
             CALL t110_apa32f() RETURNING l_apa32f                   #No.MOD-B80140 add
             LET g_apa.apa32f = l_apa32f                             #No.MOD-B80140 add 
             LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)
             LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)
             UPDATE apa_file SET apa31f = g_apa.apa57f,apa31 = g_apa.apa57,
                                 apa32f = g_apa.apa32f,apa32 = g_apa.apa52,
                                 apa57f = g_apa.apa57f,apa57 = g_apa.apa57
               WHERE apa01=g_apa.apa01
             DISPLAY BY NAME g_apa.apa31,g_apa.apa31f,g_apa.apa32,g_apa.apa32f  
          END IF
         #-MOD-B80193-end-

        BEFORE DELETE                            #是否取消單身
           IF g_apb_t.apb02 > 0 AND g_apb_t.apb02 IS NOT NULL THEN
              IF NOT cl_delb(0,0) THEN
                 CANCEL DELETE
              END IF
              #No.TQC-7B0083  --Begin
              #正常請款,但是對應入庫/倉退單有做過衝暫估,則不能刪除
              IF cl_null(g_apb[l_ac].apb34) OR g_apb[l_ac].apb34 = 'N' THEN
                 IF g_apa.apa00 <> '22' THEN                    #MOD-AA0061
                    LET l_cnt = 0
                    SELECT COUNT(*) INTO l_cnt FROM apb_file
                     WHERE apb21 = g_apb_t.apb21
                       AND apb22 = g_apb_t.apb22
                       AND apb34 = 'Y'
                    IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
                    IF l_cnt > 0 THEN
                       CALL cl_err(g_apb_t.apb21,'aap-816',1)
                       CANCEL DELETE
                    END IF
                 END IF                                        #MOD-AA0061
              END IF
              #No.TQC-7B0083  --End  
              IF (g_apa.apa00[1,1] = '2' AND g_apa.apa58 <> '1') OR
#                (g_aza.aza26 = '2' AND g_aza.aza25 = 'Y') THEN
                 (g_aza.aza26 = '2' AND g_aza.aza46 = 'Y') THEN  #No.FUN-580006
                IF l_lock_sw = "Y" THEN
                   CALL cl_err("", -263, 1)
                   CANCEL DELETE
                END IF
                 DELETE FROM apk_file
                  WHERE apk01 = g_apa.apa01 AND apk02 =g_apb_t.apb02
                 IF SQLCA.sqlcode THEN
#                   CALL cl_err(g_apb_t.apb02,SQLCA.sqlcode,0)   #No.FUN-660122
                    CALL cl_err3("del","apk_file",g_apa.apa01,g_apb_t.apb02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
                    ROLLBACK WORK
                    CANCEL DELETE
                 END IF
              END IF
              DELETE FROM apb_file
               WHERE apb01 = g_apa.apa01 AND apb02 = g_apb_t.apb02
              IF SQLCA.sqlcode THEN
#                CALL cl_err(g_apb_t.apb02,SQLCA.sqlcode,0)   #No.FUN-660122
                 CALL cl_err3("del","apb_file",g_apa.apa01,g_apb_t.apb02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
                 ROLLBACK WORK
                 CANCEL DELETE
              #-----MOD-780042---------
              ELSE
                 IF g_apa.apa08 = 'UNAP' THEN
                    IF NOT cl_null(g_apb_t.apb21) AND    #MOD-870109 add
                       NOT cl_null(g_apb_t.apb22) THEN   #MOD-870109 add
                       UPDATE rvv_file SET rvv40 = 'N'
                          WHERE rvv01 = g_apb_t.apb21 AND rvv02 = g_apb_t.apb22
                       IF STATUS OR SQLCA.SQLERRD[3] = 0 THEN
                          CALL cl_err3("upd","rvv_file",g_apb_t.apb21,g_apb_t.apb22,STATUS,"","upd rvv40",1)  
                          ROLLBACK WORK
                          CANCEL DELETE
                       END IF
                    END IF                               #MOD-870109 add
                 END IF
              #-----END MOD-780042----- 
              END IF
              LET g_rec_b=g_rec_b-1
              DISPLAY g_rec_b TO FORMONLY.n2
              #No.TQC-7B0083  --Begin
              #若是衝暫估,則自動產生api資料
              IF g_apb_t.apb34 = 'Y' THEN
                 CALL t110_api_unap('d')
              END IF
              LET g_apb[l_ac].apb29 = g_apb_t.apb29  #t110_bu中用l_ac在判斷
              #No.TQC-7B0083  --End  
             #str CHI-B30009 add
              LET g_apb04_t=''
              LET g_apb05_t=''
              SELECT apb04,apb05 INTO g_apb04_t,g_apb05_t FROM apb_file
               WHERE apb01=g_apa.apa01 AND apb02=g_apb_t.apb02
             #end CHI-B30009 add
              CALL t110_bu(0,1)
              IF g_success='Y' THEN
                 LET l_apa63 = '0'          #FUN-550042
                 LET l_change = 'Y'         #No.MOD-B80053 add
                 COMMIT WORK
              ELSE
                 ROLLBACK WORK
              END IF
           END IF

        ON ROW CHANGE
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               LET g_apb[l_ac].* = g_apb_t.*
               CLOSE t110_bcl
               ROLLBACK WORK
               EXIT INPUT
            END IF
            #TQC-C60241--add--str--
            IF g_apa.apa00 = '26' THEN
               IF g_apb[l_ac].apb29 = '3' THEN
                  SELECT SUM(rvv87) INTO l_sum_rvv87
                    FROM rvv_file
                   WHERE rvv01 = g_apb[l_ac].apb21
                     AND rvv02 = g_apb[l_ac].apb22
                  SELECT SUM(apb09) INTO l_sum_apb09
                    FROM apb_file,apa_file
                   WHERE apb21 = g_apb[l_ac].apb21
                     AND apb22 = g_apb[l_ac].apb22
                     AND apa00 = '26'
                     AND apa01 = apb01
                  SELECT apb09 INTO l_apb09
                    FROM apb_file,apa_file
                   WHERE apb21 = g_apb[l_ac].apb21
                     AND apb02 = g_apb[l_ac].apb02
                     AND apa00 = '26'
                     AND apa01 = apb01
                     AND apa01 = g_apa.apa01
                  IF cl_null(l_sum_rvv87) THEN
                     LET l_sum_rvv87 = 0
                  END IF
                  IF cl_null(l_apb09) THEN
                     LET l_apb09 = 0
                  END IF
                  IF cl_null(l_sum_apb09) THEN
                     LET l_sum_apb09 = 0
                  END IF
                  IF l_sum_apb09 + g_apb[l_ac].apb09 - l_apb09 > l_sum_rvv87 THEN
                     CALL cl_err('','aap-240',1)
                     NEXT FIELD apb09
                  END IF
               END IF
            END IF
            #TQC-C60241--add--end--
            IF l_lock_sw = 'Y' THEN
               CALL cl_err(g_apb[l_ac].apb02,-263,1)
               LET g_apb[l_ac].* = g_apb_t.*
            ELSE
               IF g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' AND
                  g_apb[l_ac].apb09 != 0 THEN
                  #CALL t110_b_more1(p_cmd)
#No.FUN-680029--begin
                  #No.FUN-830161  --Begin
                  #IF g_aza.aza63 = 'Y' THEN   #MOD-7B0257
                  #   SELECT COUNT(*) INTO g_cnt FROM pnr_file
                  #    #WHERE pnr01=g_apb30           #FUN-810045
                  #    WHERE pnr01=g_apb[l_ac].apb30  #FUN-810045
                  #      AND pnr02=g_apb[l_ac].apb251
                  #      AND pnr03=g_apb[l_ac].apb26
                  #   IF g_cnt=0 THEN
                  #      #CALL cl_err(g_apb30,'apm-313',0)           #FUN-810045
                  #      CALL cl_err(g_apb[l_ac].apb30,'apm-313',0)  #FUN-810045
                  #      NEXT FIELD apb251
                  #   END IF
                  #END IF   #MOD-7B0257
#No.FUN-680029--end
                  #SELECT COUNT(*) INTO g_cnt FROM pnr_file
                  # #WHERE pnr01=g_apb30             #FUN-810045
                  # WHERE pnr01=g_apb[l_ac].apb30    #FUN-810045
                  #   AND pnr02=g_apb[l_ac].apb25
                  #   AND pnr03=g_apb[l_ac].apb26
                  #IF g_cnt=0 THEN
                  #   CALL cl_err(g_apb30,'apm-313',0)
                  #   NEXT FIELD apb25
                  #END IF
                  #No.FUN-830161  --End  
               END IF
              #str MOD-940326 add
               LET l_aag05=''
               SELECT aag05 INTO l_aag05 FROM aag_file
                WHERE aag01 = g_apb[l_ac].apb25
                  AND aag00 = g_bookno1
                  AND aagacti = 'Y'     #No.MOD-B70280 add
               #防止User只修改科目或部門欄位時,未再次檢查會科與允許/拒絕部門關係
               LET g_errno = ' '   
               IF l_aag05 = 'Y' THEN
                 #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                  IF g_aaz.aaz90 ='Y' THEN
                     IF NOT cl_null(g_apb[l_ac].apb930) THEN 
                        CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb25,g_apb[l_ac].apb930,g_bookno1)  
                                      RETURNING g_errno
                     END IF
                  ELSE
                     IF NOT cl_null(g_apb[l_ac].apb26) THEN 
                        CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb25,g_apb[l_ac].apb26,g_bookno1)  
                                      RETURNING g_errno
                     END IF 
                  END IF
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err('',g_errno,0)
                     NEXT FIELD apb25
                  END IF
               END IF
               IF g_aza.aza63='Y' THEN 
                  LET l_aag05=''
                  SELECT aag05 INTO l_aag05 FROM aag_file
                   WHERE aag01 = g_apb[l_ac].apb251
                     AND aag00 = g_bookno2
                     AND aagacti = 'Y'     #No.MOD-B70280 add
                  #防止User只修改科目或部門欄位時,未再次檢查會科與允許/拒絕部門關係
                  LET g_errno = ' '   
                  IF l_aag05 = 'Y' AND NOT cl_null(g_apb[l_ac].apb251) THEN
                     IF g_aaz.aaz90 ='Y' THEN
                        IF NOT cl_null(g_apb[l_ac].apb930) THEN
                           CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb251,g_apb[l_ac].apb930,g_bookno2)                
                                         RETURNING g_errno
                        END IF 
                     ELSE
                        IF NOT cl_null(g_apb[l_ac].apb26) THEN
                           CALL s_chkdept(g_aaz.aaz72,g_apb[l_ac].apb251,g_apb[l_ac].apb26,g_bookno2)                
                                         RETURNING g_errno
                        END IF
                     END IF
                     IF NOT cl_null(g_errno) THEN
                        CALL cl_err('',g_errno,0)
                        NEXT FIELD apb251
                     END IF
                  END IF
               END IF
              #end MOD-940326 add
               UPDATE apb_file SET apb02 = g_apb[l_ac].apb02,
                                   apb11 = g_apb[l_ac].apb11,
                                   apb21 = g_apb[l_ac].apb21,
                                   apb31 = g_apb[l_ac].apb31, #FUN-630055
                                   apb22 = g_apb[l_ac].apb22,
                                   apb06 = g_apb[l_ac].apb06,
                                   apb07 = g_apb[l_ac].apb07,
                                   apb12 = g_apb[l_ac].apb12,
                                   apb09 = g_apb[l_ac].apb09,
                                   apb25 = g_apb[l_ac].apb25,
                                   apb251= g_apb[l_ac].apb251,    #No.FUN-680029
                                   apb26 = g_apb[l_ac].apb26,
                                   apb930= g_apb[l_ac].apb930, #FUN-670064
                                   apb23 = g_apb[l_ac].apb23,
                                   apb24 = g_apb[l_ac].apb24,
                                   apb08 = g_apb[l_ac].apb08,
                                   apb10 = g_apb[l_ac].apb10,
                                   apb081= g_apb[l_ac].apb08,
                                   apb101= g_apb[l_ac].apb10,
                                   apb27 = g_apb[l_ac].apb27,
                                   apb28 = g_apb[l_ac].apb28,
                                   apb35 = g_apb[l_ac].apb35,  #FUN-810045 add
                                   apb36 = g_apb[l_ac].apb36,  #FUN-810045 add
                                   apb29 = g_apb[l_ac].apb29,
                                   apb04 = g_apb04,
                                   apb05 = g_apb05,
                                   #apb30 = g_apb30,            #No.FUN-690080   #FUN-810045
                                 # apb30 = g_apb[l_ac].apb30,  #No.FUN-690080    #FUN-810045  #No.FUN-830161  remove apb30
                                   apb33 = g_apb[l_ac].apb33,  #No.FUN-690080
                                   apb32 = g_apb[l_ac].apb32,  #No.FUN-690080
                                   apb34 = g_apb[l_ac].apb34,  #No.TQC-7B0083
                                #FUN-850038 --start--
                                   apbud01 = g_apb[l_ac].apbud01,
                                   apbud02 = g_apb[l_ac].apbud02,
                                   apbud03 = g_apb[l_ac].apbud03,
                                   apbud04 = g_apb[l_ac].apbud04,
                                   apbud05 = g_apb[l_ac].apbud05,
                                   apbud06 = g_apb[l_ac].apbud06,
                                   apbud07 = g_apb[l_ac].apbud07,
                                   apbud08 = g_apb[l_ac].apbud08,
                                   apbud09 = g_apb[l_ac].apbud09,
                                   apbud10 = g_apb[l_ac].apbud10,
                                   apbud11 = g_apb[l_ac].apbud11,
                                   apbud12 = g_apb[l_ac].apbud12,
                                   apbud13 = g_apb[l_ac].apbud13,
                                   apbud14 = g_apb[l_ac].apbud14,
                                   apbud15 = g_apb[l_ac].apbud15
                                #FUN-850038 --end-- 
                WHERE apb01=g_apa.apa01 AND apb02=g_apb_t.apb02
               IF SQLCA.sqlcode THEN
#                 CALL cl_err(g_apb[l_ac].apb02,SQLCA.sqlcode,0)   #No.FUN-660122
                  CALL cl_err3("upd","apb_file",g_apa.apa01,g_apb_t.apb02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
                  LET g_apb[l_ac].* = g_apb_t.*
               ELSE
                  #-----FUN-680003---------
                  SELECT COUNT(*) INTO l_n FROM apk_file
                   WHERE apk03 = g_apb[l_ac].apb11
                  IF l_n > 0 THEN
                  #-----END FUN-680003-----
                     #因為大陸版同一單身可能對應多張發票
                     IF g_aza.aza26 != '2' AND
                        #g_apa.apa00[1,1] = '2' AND g_apa.apa58 <> '1' THEN   #MOD-780009
                        g_apa.apa00[1,1] = '2' AND g_apa.apa58 = '1' THEN   #MOD-780009
                        #稅額
                        LET g_apk.apk07=g_apb[l_ac].apb10*g_apa.apa16/100
                        LET g_apk.apk08=g_apb[l_ac].apb10  #未稅金額
                        #含稅金額
                        LET g_apk.apk06=g_apk.apk07+g_apk.apk08
                        #no.A010依幣別取位
                        LET g_apk.apk06 = cl_digcut(g_apk.apk06,g_azi04)
                        LET g_apk.apk07 = cl_digcut(g_apk.apk07,g_azi04)
                        LET g_apk.apk08 = cl_digcut(g_apk.apk08,g_azi04)
                         #-----No:MOD-4C0093-----
                        SELECT azi04 INTO l_azi04 FROM azi_file WHERE azi01 = g_apk.apk12
                        LET g_apk.apk07f = g_apb[l_ac].apb24 * g_apk.apk29 / 100
                        LET g_apk.apk08f = g_apb[l_ac].apb24
                        LET g_apk.apk06f = g_apk.apk07f + g_apk.apk08f
                        LET g_apk.apk06f = cl_digcut(g_apk.apk06f,l_azi04)
                        LET g_apk.apk07f = cl_digcut(g_apk.apk07f,l_azi04)
                        LET g_apk.apk08f = cl_digcut(g_apk.apk08f,l_azi04)
                        UPDATE apk_file SET apk06 = g_apk.apk06,
                                            apk07 = g_apk.apk07,
                                            apk08 = g_apk.apk08,
                                            apk06f = g_apk.apk06f,
                                            apk07f = g_apk.apk07f,
                                            apk08f = g_apk.apk08f,
                                            apk32  = g_apk.apk32    #FUN-970108 add
                         WHERE apk01 = g_apa.apa01
                           AND apk02 = g_apb_t.apb02
                         #-----No:MOD-4C0093 END-----
                         IF SQLCA.sqlcode OR SQLCA.SQLERRD[3] = 0 THEN
#                           CALL cl_err('upd apk',SQLCA.sqlcode,0)   #No.FUN-660122
                            #CALL cl_err3("upd","apk_file",g_apa.apa01,g_apb_t.apb02,SQLCA.sqlcode,"","upd apk",1)  #No.FUN-660122   #MOD-6A0124
                            CALL cl_err3("upd","apk_file",g_apa.apa01,g_apb_t.apb02,'aap-810',"","upd apk",1)  #No.FUN-660122   #MOD-6A0124
                            ROLLBACK WORK
                         END IF
                      #No.MOD-540169 --start--
                     ELSE
                       IF g_apb[l_ac].apb02 != g_apb_t.apb02 THEN
                          UPDATE apk_file SET apk02 = g_apb[l_ac].apb02
                           WHERE apk01 = g_apa.apa01
                             AND apk02 = g_apb_t.apb02
                          IF SQLCA.sqlcode THEN
#                            CALL cl_err('upd apk',SQLCA.sqlcode,0)   #No.FUN-660122
                             CALL cl_err3("upd","apk_file",g_apa.apa01,g_apb_t.apb02,SQLCA.sqlcode,"","upd apk",1)  #No.FUN-660122
                             ROLLBACK WORK
                          END IF
                       END IF
                      #No.MOD-540169 --end--
                     END IF
                      IF g_apb_t.apb11 IS NOT NULL OR   #No.MOD-480387
                        g_apb[l_ac].apb11 != g_apb_t.apb11 THEN
                        SELECT COUNT(*) INTO g_cnt
                          FROM apk_file
                         WHERE apk01 = g_apa.apa01
                           AND apk02 = g_apb_t.apb02
                           #AND apk03 = g_apb_t.apb11   #No.MOD-480387
                        IF g_aza.aza26 != '2' AND g_cnt > 0 THEN
                           UPDATE apk_file SET apk03 = g_apb[l_ac].apb11
                            WHERE apk01 = g_apa.apa01
                              AND apk02 = g_apb_t.apb02
                           IF STATUS OR SQLCA.sqlerrd[3] =0 THEN
#                             CALL cl_err('upd apk',SQLCA.sqlcode,0)   #No.FUN-660122
                              CALL cl_err3("upd","apk_file",g_apa.apa01,g_apb_t.apb02,SQLCA.sqlcode,"","upd apk",1)  #No.FUN-660122
                              ROLLBACK WORK
                           END IF
                        END IF
                     END IF
                  END IF   #FUN-680003 
                  MESSAGE 'UPDATE O.K'
                  #No.TQC-7B0083  --Begin
                  #若是衝暫估,則自動產生api資料
                  IF g_apb[l_ac].apb34 = 'Y' OR g_apb_t.apb34 = 'Y' THEN
                     IF g_apb[l_ac].apb21 <> g_apb_t.apb21 OR 
                        g_apb[l_ac].apb22 <> g_apb_t.apb22 OR
                        g_apb[l_ac].apb09 <> g_apb_t.apb09 OR  
                        g_apb[l_ac].apb08 <> g_apb_t.apb08 OR  #單價
                        g_apb[l_ac].apb23 <> g_apb_t.apb23 OR  #單價
                        g_apb[l_ac].apb10 <> g_apb_t.apb10 OR  #金額
                        g_apb[l_ac].apb24 <> g_apb_t.apb24 OR  #金額
                        g_apb[l_ac].apb02 <> g_apb_t.apb02 THEN
                        CALL t110_api_unap('u')
                     END IF
                  END IF
                  #No.TQC-7B0083  --End  
                 #str CHI-B30009 add
                  LET g_apb04=''
                  LET g_apb05=''
                  SELECT apb04,apb05 INTO g_apb04,g_apb05 FROM apb_file
                   WHERE apb01=g_apa.apa01 AND apb02=g_apb[l_ac].apb02

                  LET g_apb04_t=''
                  LET g_apb05_t=''
                  SELECT apb04,apb05 INTO g_apb04_t,g_apb05_t FROM apb_file
                   WHERE apb01=g_apa.apa01 AND apb02=g_apb_t.apb02
                 #end CHI-B30009 add
                  CALL t110_bu(1,1)
                  IF g_success='Y' THEN
                     IF g_apa.apa63 NOT matches '[Ss]' THEN    #No:FUN-8A0075
                        LET l_apa63 = '0'          #FUN-550042
                     END IF                                    #No:FUN-8A0075
                     LET l_change = 'Y'                        #No.MOD-B80053 add
                     COMMIT WORK
                  ELSE
                     ROLLBACK WORK
                  END IF
               END IF
            END IF

        AFTER ROW
            LET l_ac = ARR_CURR()
            LET l_ac_t = l_ac
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               IF p_cmd = 'u' THEN
                  LET g_apb[l_ac].* = g_apb_t.*
               END IF
               CLOSE t110_bcl
               ROLLBACK WORK
               EXIT INPUT
            END IF

            IF l_ac <= g_apb.getLength() THEN   #MOD-B80127 add
#No.MOD-B40261 --begin  #CHI-B80023 mark
              #IF g_apz.apz61='1' AND g_aptype ='15' THEN
              #   IF cl_null(g_apb[l_ac].apb06) THEN
              #      NEXT FIELD apb06
              #   END IF
              #   IF cl_null(g_apb[l_ac].apb07) THEN
              #      NEXT FIELD apb07
              #   END IF
              #END IF
#No.MOD-B40261 --end    #CHI-B80023 mark
               CLOSE t110_bcl
             # COMMIT WORK

               SELECT COUNT(*) INTO l_cnt FROM apb_file
                WHERE apb01=g_apa.apa01
              #IF l_cnt > 0 THEN                                                #MOD-A30248 mark
               IF (l_cnt > 0) OR g_apz.apz61='1' OR (g_apz.apz61='3'AND l_pmc913 ='Y') THEN      #MOD-A30248 add
                  SELECT SUM(apb24),SUM(apb10) INTO g_amt1f,g_amt1 FROM apb_file
                   WHERE apb01 = g_apa.apa01 AND apb29='1'
                  IF g_amt1 IS NULL THEN
                     LET g_amt1f= 0
                     LET g_amt1 = 0
                  END IF
                  SELECT SUM(apb24),SUM(apb10) INTO g_amt2f,g_amt2 FROM apb_file
                   WHERE apb01 = g_apa.apa01 AND apb29='3'
                  IF g_amt2 IS NULL THEN
                     LET g_amt2f= 0
                     LET g_amt2 = 0
                  END IF
                  IF g_aptype MATCHES '1*' AND g_aptype <> '15' AND g_aptype <> '17' THEN  #No.FUN-690080
                     #LET g_apa.apa57f= g_amt1f - g_amt2f   #MOD-6A0025
                     #LET g_apa.apa57 = g_amt1 - g_amt2   #MOD-6A0025
                     LET g_apa.apa57f= g_amt1f + g_amt2f   #MOD-6A0025
                     LET g_apa.apa57 = g_amt1 + g_amt2   #MOD-6A0025
                  END IF
                  IF g_aptype MATCHES '2*' THEN
                     #LET g_apa.apa57f= g_amt2f - g_amt1f   #MOD-6A0025
                     #LET g_apa.apa57 = g_amt2 - g_amt1   #MOD-6A0025
                     LET g_apa.apa57f= g_amt2f + g_amt1f   #MOD-6A0025
                     LET g_apa.apa57 = g_amt2 + g_amt1   #MOD-6A0025
                  END IF
                  #-----MOD-620004---------
                 #IF g_aptype = '15' OR g_aptype = '17' THEN   #No.FUN-690080        #MOD-970173 mark
                  IF g_aptype = '15' OR g_aptype = '17' OR g_aptype = '16' THEN      #MOD-970173 add
                     SELECT SUM(apb24),SUM(apb10) INTO g_apa.apa57f,g_apa.apa57
                      FROM apb_file WHERE apb01=g_apa.apa01
                  END IF
                  #-----END MOD-620004-----
                  IF g_apa.apa57f IS NULL THEN
                     LET g_apa.apa57f= 0
                  END IF
                  IF g_apa.apa57  IS NULL THEN
                     LET g_apa.apa57 = 0
                  END IF
                  LET g_apa.apa57f=cl_digcut(g_apa.apa57f,t_azi04)   #MOD-6B0066
                  LET g_apa.apa57=cl_digcut(g_apa.apa57,g_azi04)   #MOD-6B0066
                  #-----MOD-640111---------
                  UPDATE apa_file SET apa57=g_apa.apa57,apa57f=g_apa.apa57f
                    WHERE apa01=g_apa.apa01
                  #-----END MOD-640111-----
                  #-----MOD-730098---------
                  IF SQLCA.sqlcode OR SQLCA.SQLERRD[3] = 0 THEN
                     CALL cl_err3("upd","apa_file",g_apa.apa01,"",STATUS,"","upd apa:",1)
                     ROLLBACK WORK
                  END IF
                  #-----END MOD-730098-----
                  DISPLAY BY NAME g_apa.apa57
                  #No:FUN-880094---Begin
                  IF g_aptype = '15' THEN
                     SELECT pmc913 INTO l_pmc913 FROM pmc_file 
                      WHERE pmc01 = g_apa.apa05
                     IF g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y') THEN 
                        CALL t110_sum_apa()
                     END IF 
                  END IF
                  #No:FUN-880094---End
 #MOD-560240
               ELSE
                  IF g_aptype !='11' THEN   #MOD-890177 add
                     LET g_apa.apa57 = g_apa.apa31
                     LET g_apa.apa57f = g_apa.apa31f
                     DISPLAY BY NAME g_apa.apa57
                  END IF                    #MOD-890177 add
 #END MOD-560240
               END IF
            END IF   #MOD-B80127 add
 #No:MOD-4B0015 取消掉不可以這樣寫會單身無法存入
 #       #MOD-4A0172
#       ON ACTION accept
#          EXIT INPUT
#       #--

       #No.TQC-7B0083  --Begin
       ##單身金額總和不得為負
       #-MOD-A60004-add-
        ON ACTION cancel
           IF g_aptype = '15' AND   (g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y')) THEN 
              SELECT SUM(apb24),SUM(apb10) INTO g_apa.apa57f,g_apa.apa57
                FROM apb_file 
               WHERE apb01=g_apa.apa01
              IF g_apa.apa57f IS NULL THEN
                 LET g_apa.apa57f= 0
              END IF
              IF g_apa.apa57  IS NULL THEN
                 LET g_apa.apa57 = 0
              END IF
              LET g_apa.apa57f=cl_digcut(g_apa.apa57f,t_azi04)   
              LET g_apa.apa57=cl_digcut(g_apa.apa57,g_azi04)   
              LET g_apa.apa31f= g_apa.apa57f   
              LET g_apa.apa31 = g_apa.apa57   
             #-MOD-B80193-add-
              LET g_apa.apa32 = g_apa.apa57*g_apa.apa16/100    
              CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
              LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
              LET g_apa.apa32f = g_apa.apa57f*g_apa.apa16/100
              CALL t110_apa32f() RETURNING l_apa32f                   #No.MOD-B80140 add
              LET g_apa.apa32f = l_apa32f                             #No.MOD-B80140 add 
              LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)
              LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)
             #-MOD-B80193-end-
              UPDATE apa_file SET apa31f = g_apa.apa57f,apa31 = g_apa.apa57,
                                  apa32f = g_apa.apa32f,apa32 = g_apa.apa52,   #MOD-B80193
                                  apa57f = g_apa.apa57f,apa57 = g_apa.apa57
                WHERE apa01=g_apa.apa01
              DISPLAY BY NAME g_apa.apa31f
              DISPLAY BY NAME g_apa.apa31
              DISPLAY BY NAME g_apa.apa32,g_apa.apa32f  #MOD-B80193
              EXIT INPUT
           ELSE                #MOD-A60115 
              EXIT INPUT       #MOD-A60115
           END IF
       #-MOD-A60004-end-
       #   LET l_apb10 = 0    LET l_apb24 = 0
       #   SELECT SUM(apb10),SUM(apb24) INTO l_apb10,l_apb24
       #     FROM apb_file
       #    WHERE apb01 = g_apa.apa01
       #   IF cl_null(l_apb10) THEN LET l_apb10 = 0 END IF
       #   IF cl_null(l_apb24) THEN LET l_apb24 = 0 END IF
       #   IF l_apb10 < 0 OR l_apb24 < 0 THEN
       #      CALL cl_err(l_apb10,'axr-029',1)
       #      NEXT FIELD apb10
       #      LET INT_FLAG = 0
       #   END IF
       #No.TQC-7B0083  --Begin

        ON ACTION CONTROLP
           CASE
               #TQC-750139 begin
	        WHEN INFIELD(apb11)
                      CALL cl_init_qry_var()
                      LET g_qryparam.form ="q_apk03"
                      LET g_qryparam.arg1 = g_apa.apa15
                      CALL cl_create_qry() RETURNING g_apb[l_ac].apb11
                      DISPLAY g_apb[l_ac].apb11 TO apb11
               #TQC-750139 end
              #FUN-630055 --start--
              WHEN INFIELD(apb31)
                    CALL cl_init_qry_var()
                  #FUN-810045 begin
                    #LET g_qryparam.form ="q_pjd"
                    #LET g_qryparam.arg1 = g_apa.apa66   #MOD-650048
                    LET g_qryparam.form ="q_azf"
                    LET g_qryparam.arg1 = '2'
                  #FUN-810045 end
                    CALL cl_create_qry() RETURNING g_apb[l_ac].apb31
                    DISPLAY g_apb[l_ac].apb31 TO apb31      #No:MOD-490344
 
              #FUN-630055 --end ---
            #FUN-810045 begin
                WHEN INFIELD(apb35) #專案
                  CALL cl_init_qry_var()
                  LET g_qryparam.form ="q_pja2"  
                  CALL cl_create_qry() RETURNING g_apb[l_ac].apb35 
                  DISPLAY BY NAME g_apb[l_ac].apb35
                  NEXT FIELD apb35
                WHEN INFIELD(apb36)  #WBS
                  CALL cl_init_qry_var()
                  LET g_qryparam.form ="q_pjb4"
                  LET g_qryparam.arg1 = g_apb[l_ac].apb35  
                  CALL cl_create_qry() RETURNING g_apb[l_ac].apb36 
                  DISPLAY BY NAME g_apb[l_ac].apb36
                  NEXT FIELD apb36
            #FUN-810045 end
              WHEN INFIELD(apb21) OR INFIELD(apb22)
                 #FUN-6300055 remark --start
                 #IF g_aptype='12' OR g_aptype='15' THEN
                 #   CALL cl_init_qry_var()
                 #   LET g_qryparam.form ="q_pjd"
                 #   #LET g_qryparam.default1 = g_apa.apa66   #MOD-650048
                 #   LET g_qryparam.arg1 = g_apa.apa66   #MOD-650048
                 #   CALL cl_create_qry() RETURNING g_apb[l_ac].apb21
                 #    DISPLAY g_apb[l_ac].apb21 TO apb21      #No:MOD-490344
                 #ELSE
                 #FUN-630055 remark --end 

                    IF g_apa.apa00 MATCHES '1*' THEN
                      #str FUN-7A0050 add
                      #aapt120單身apb21(暫估單號),apb22(暫估項次)開窗查aapt160費用暫估資料
                       IF g_apa.apa00 = '12' THEN
                          CALL cl_init_qry_var()
                          LET g_qryparam.form ="q_apb"   
                          LET g_qryparam.arg1 = g_apa.apa06   #MOD-890282 add
                          LET g_qryparam.arg2 = g_apa.apa07   #MOD-890282 add
                          LET g_qryparam.default1 = g_apb[l_ac].apb21
                          LET g_qryparam.default2 = g_apb[l_ac].apb22
                          CALL cl_create_qry() RETURNING g_apb[l_ac].apb21,g_apb[l_ac].apb22
                       ELSE
                      #end FUN-7A0050 add
                         #str MOD-B40070 mod
                         #CALL q_rvv(FALSE,TRUE,g_apa.apa05,g_apb[l_ac].apb21,
                         #           g_apb[l_ac].apb22)
                         #RETURNING g_apb[l_ac].apb21,g_apb[l_ac].apb22
                          CALL q_rvv2(FALSE,TRUE,g_apa.apa05,
                                      g_apb[l_ac].apb21,g_apb[l_ac].apb22,g_apb[l_ac].apb29)
                          RETURNING g_apb[l_ac].apb21,g_apb[l_ac].apb22
                         #end MOD-B40070 mod
                       END IF   #FUN-7A0050 add
                       DISPLAY g_apb[l_ac].apb22 TO apb22         #No:MOD-490344
                    ELSE
                      #str FUN-7A0050 add
                      #aapt210單身apb21(暫估單號),apb22(暫估項次)開窗查aapt260扣款折讓暫估資料
                       IF g_apa.apa00 = '21' THEN
                          CALL cl_init_qry_var()
                          LET g_qryparam.form ="q_apb1"
                          LET g_qryparam.where ="apa01 ='",g_apa.apa05,"'"       #MOD-C60170 add 
                          LET g_qryparam.default1 = g_apb[l_ac].apb21
                          LET g_qryparam.default2 = g_apb[l_ac].apb22
                          CALL cl_create_qry() RETURNING g_apb[l_ac].apb21,g_apb[l_ac].apb22
                       ELSE
                      #end FUN-7A0050 add
                          CALL q_rvv2(FALSE,TRUE,g_apa.apa05,
                                  g_apb[l_ac].apb21,g_apb[l_ac].apb22,'3')
                            RETURNING g_apb[l_ac].apb21,g_apb[l_ac].apb22
                       END IF   #FUN-7A0050 add
                       DISPLAY g_apb[l_ac].apb21 TO apb21          #No:MOD-490344
                       DISPLAY g_apb[l_ac].apb22 TO apb22          #No:MOD-490344
                    END IF
                #END IF #FUN-630055 remark
              WHEN INFIELD(apb25) # Account number
                #FUN-710078---mod---str---
                 CALL cl_init_qry_var()
                 LET g_qryparam.arg1 = g_bookno1      #No.TQC-7B0122 
                #LET g_qryparam.form ="q_aag06"       #No.TQC-7B0122 mark
                 LET g_qryparam.form ="q_aag10"       #No.TQC-7B0122
                 LET g_qryparam.default1 = g_apb[l_ac].apb25
                 LET g_qryparam.default2 = g_apb[l_ac].b25
                 CALL cl_create_qry() RETURNING g_apb[l_ac].apb25,g_apb[l_ac].b25
                 DISPLAY g_apb[l_ac].apb25 TO apb25
                 DISPLAY g_apb[l_ac].b25 TO b25

                #LET g_qryparam.form ="q_aag"
                #LET g_qryparam.default1 = g_apb[l_ac].apb25
                #LET g_qryparam.arg1 = g_bookno1      #No.FUN-730064
                #CALL cl_create_qry() RETURNING g_apb[l_ac].apb25
                #DISPLAY g_apb[l_ac].apb25 TO apb25
                #FUN-710078---mod---end---
#No.FUN-680029--begin
              WHEN INFIELD(apb251) # Account number
                 CALL cl_init_qry_var()
                #FUN-710078---mod---str---
                 LET g_qryparam.arg1 = g_bookno2       #No.TQC-7B0122 
                 LET g_qryparam.form ="q_aag10"        #No.TQC-7B0122
                #LET g_qryparam.form ="q_aag06"        #No.TQC-7B0122 mark
                 LET g_qryparam.default1 = g_apb[l_ac].apb251
                 LET g_qryparam.default2 = g_apb[l_ac].b251
                 CALL cl_create_qry() RETURNING g_apb[l_ac].apb251,g_apb[l_ac].b251
                 DISPLAY g_apb[l_ac].apb251 TO apb251
                 DISPLAY g_apb[l_ac].b251 TO b251

                #LET g_qryparam.form ="q_aag"
                #LET g_qryparam.default1 = g_apb[l_ac].apb251
                #LET g_qryparam.arg1 = g_bookno2      #No.FUN-730064
                #CALL cl_create_qry() RETURNING g_apb[l_ac].apb251
                #DISPLAY g_apb[l_ac].apb251 TO apb251
                #FUN-710078---mod---end---
#No.FUN-680029--end
              WHEN INFIELD(apb26) # Dept CODE
                 CALL cl_init_qry_var()
                #FUN-710078---mod---str---
                 LET g_qryparam.form ="q_gem5"
                 LET g_qryparam.default1 = g_apb[l_ac].apb26
                 LET g_qryparam.default2 = g_apb[l_ac].b26
                 CALL cl_create_qry() RETURNING g_apb[l_ac].apb26,g_apb[l_ac].b26
                 DISPLAY g_apb[l_ac].apb26 TO apb26
                 DISPLAY g_apb[l_ac].b26 TO b26

                #LET g_qryparam.form ="q_gem"
                #LET g_qryparam.default1 = g_apb[l_ac].apb26
                #CALL cl_create_qry() RETURNING g_apb[l_ac].apb26
                #DISPLAY g_apb[l_ac].apb26 TO apb26
                #FUN-710078---mod---end---

              WHEN INFIELD(apb06)
                 #No.MOD-840179 modify by hellen --begin
#                CALL q_pmm(FALSE,TRUE,g_apb[l_ac].apb06) #mark
                 #add begin
                 LET g_fac_type = "  AND pmm09 = '",g_apa.apa05,"'",
                                  "  AND pmm22 = '",g_apa.apa13,"'"
                 #CALL q_pmm9(FALSE,TRUE,g_apb[l_ac].apb06,g_fac_type)
                 CALL q_pmm902(FALSE,TRUE,g_apb[l_ac].apb06,g_fac_type)  #MOD-8A0051
                 #add end
                 #No.MOD-840179 modify by hellen --end
                 RETURNING g_apb[l_ac].apb06,g_apb[l_ac].apb07   #MOD-8A0139 add apb07
                 DISPLAY g_apb[l_ac].apb06 TO apb06
                 DISPLAY g_apb[l_ac].apb07 TO apb07   #MOD-8A0139 add
              WHEN INFIELD(apb12) #料件編號
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_ima"
                 LET g_qryparam.default1 = g_apb[l_ac].apb12
                 CALL cl_create_qry() RETURNING g_apb[l_ac].apb12
                 DISPLAY g_apb[l_ac].apb12 TO apb12
                 NEXT FIELD apb12
              WHEN INFIELD(apb28) #採購單位
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_gfe"
                 LET g_qryparam.default1 = g_apb[l_ac].apb28
                 CALL cl_create_qry() RETURNING g_apb[l_ac].apb28
                 DISPLAY g_apb[l_ac].apb28 TO apb28
                 NEXT FIELD apb28
              #No.FUN-690080 --Begin
              WHEN INFIELD(apb32) #人員編號
                 CALL cl_init_qry_var()
                 #LET g_qryparam.form ="q_cpf4"     #No:CHI-780046
                 LET g_qryparam.form ="q_gen"      #No:CHI-780046 
                 LET g_qryparam.default1 = g_apb[l_ac].apb32
                 CALL cl_create_qry() RETURNING g_apb[l_ac].apb32
                 DISPLAY g_apb[l_ac].apb32 TO apb32
                 NEXT FIELD apb32
              #No.FUN-830161  --Begin
              #WHEN INFIELD(apb30) #預算編號
              #   CALL cl_init_qry_var()
              #   LET g_qryparam.form ="q_afa"
              #   LET g_qryparam.default1 = g_apb[l_ac].apb30
              #   LET g_qryparam.arg1 = g_bookno1      #No.FUN-810045 
              #   CALL cl_create_qry() RETURNING g_apb[l_ac].apb30
              #   DISPLAY g_apb[l_ac].apb30 TO apb30
              #   NEXT FIELD apb30
              #No.FUN-830161  --End  
               #No.FUN-690080 --End
               #FUN-670064...............begin
               WHEN INFIELD(apb930)
                  CALL cl_init_qry_var()
                  LET g_qryparam.form ="q_gem4"
                  CALL cl_create_qry() RETURNING g_apb[l_ac].apb930
                  DISPLAY BY NAME g_apb[l_ac].apb930
                  NEXT FIELD apb930
               #FUN-670064...............end
              OTHERWISE
                 EXIT CASE
        END CASE
 
        #使用稅控系統, 可由單身維護發票資料
        ON ACTION enter_invoice
           IF INFIELD(apb02) THEN
#             IF g_aza.aza26 = '2' AND g_aza.aza25 = 'Y' THEN
              IF g_aza.aza26 = '2' AND g_aza.aza46 = 'Y' THEN   #No.FUN-580006
                 CALL t110_ddd_c(g_apb[l_ac].apb02)
                 DISPLAY BY NAME g_apa.apa07      #TQC-630164 
                 CALL t110_show_multi_invoice()   #No.TQC-A30076
              END IF
           END IF

#       ON ACTION CONTROLN
#          CALL t110_b_askkey()
#          EXIT INPUT

        ON ACTION CONTROLO                        #沿用所有欄位
           IF INFIELD(apb02) AND l_ac > 1 THEN
              LET g_apb[l_ac].* = g_apb[l_ac-1].*
              LET g_apb[l_ac].apb02 = NULL   #TQC-620018
              DISPLAY g_apb[l_ac].* TO s_apb[l_ac].*           #MOD-B10011
              NEXT FIELD apb02
           END IF

        ON ACTION CONTROLZ
           CALL cl_show_req_fields()

        ON ACTION CONTROLG
           CALL cl_cmdask()

        ON ACTION CONTROLF
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name #Add on 040913
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang) #Add on 040913
 
       ON IDLE g_idle_seconds
          CALL cl_on_idle()
          CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121

      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
 
    END INPUT

    CALL t110_b_fill(' 1=1')   #MOD-B80127 add

   #start FUN-5B0135
    LET g_apa.apamodu = g_user
    LET g_apa.apadate = g_today
   #end FUN-5B0135
    #FUN-550042
    UPDATE apa_file SET apamodu = g_apa.apamodu,
                        apadate = g_apa.apadate,
                        apa63   = l_apa63
     WHERE apa01 = g_apa.apa01
    LET g_apa.apa63 = l_apa63

    DISPLAY BY NAME g_apa.apa63
    DISPLAY BY NAME g_apa.apamodu,g_apa.apadate   #FUN-5B0135
    IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
    CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti)
    ## END FUN-550042 ##

     #MOD-490323
    SELECT COUNT(*) INTO l_cnt FROM apb_file
     WHERE apb01=g_apa.apa01
    IF l_cnt > 0 THEN
      #SELECT SUM(apb24),SUM(apb10) INTO g_amt1f,g_amt1 FROM apb_file     #MOD-A70214 mark
      # WHERE apb01 = g_apa.apa01 AND apb29='1'                           #MOD-A70214 mark
      #-MOD-A70214-add-
       IF g_aptype = '12' THEN
          SELECT SUM(apb24),SUM(apb10) INTO g_amt1f,g_amt1 FROM apb_file
           WHERE apb01 = g_apa.apa01 
       ELSE 
          SELECT SUM(apb24),SUM(apb10) INTO g_amt1f,g_amt1 FROM apb_file
           WHERE apb01 = g_apa.apa01 AND apb29='1'
       END IF
      #-MOD-A70214-end-
       IF g_amt1 IS NULL THEN
          LET g_amt1f= 0
          LET g_amt1 = 0
       END IF
       SELECT SUM(apb24),SUM(apb10) INTO g_amt2f,g_amt2 FROM apb_file
        WHERE apb01 = g_apa.apa01 AND apb29='3'
       IF g_amt2 IS NULL THEN
          LET g_amt2f= 0
          LET g_amt2 = 0
       END IF
      #IF g_aptype MATCHES '1*' AND g_aptype <> '15' AND g_aptype <> '17' THEN  #No.FUN-690080   #MOD-970173 mark
       IF g_aptype MATCHES '1*' AND g_aptype <> '15' AND g_aptype <> '17' AND g_aptype <> '16'THEN  #MOD-970173 add
          #LET g_apa.apa57f= g_amt1f- g_amt2f   #MOD-6A0025
          #LET g_apa.apa57 = g_amt1 - g_amt2   #MOD-6A0025
          LET g_apa.apa57f= g_amt1f + g_amt2f   #MOD-6A0025
          LET g_apa.apa57 = g_amt1 + g_amt2   #MOD-6A0025
       END IF
       IF g_aptype MATCHES '2*' THEN
          #LET g_apa.apa57f= g_amt2f- g_amt1f   #MOD-6A0025
          #LET g_apa.apa57 = g_amt2 - g_amt1   #MOD-6A0025
          LET g_apa.apa57f= g_amt2f + g_amt1f   #MOD-6A0025
          LET g_apa.apa57 = g_amt2 + g_amt1   #MOD-6A0025
       END IF
       IF g_apa.apa57f IS NULL THEN
          LET g_apa.apa57f= 0
       END IF
       IF g_apa.apa57  IS NULL THEN
          LET g_apa.apa57 = 0
       END IF
       LET g_apa.apa57f=cl_digcut(g_apa.apa57f,t_azi04)   #MOD-6B0066
       LET g_apa.apa57=cl_digcut(g_apa.apa57,g_azi04)   #MOD-6B0066
       DISPLAY BY NAME g_apa.apa57
       #-----FUN-6C0037---------
      #IF g_aptype='12' AND g_apa.apa31=0 THEN                     #MOD-9B0168 mark
       IF (g_aptype='12' OR g_aptype='22') AND g_apa.apa31=0 THEN  #MOD-9B0168
          LET g_apa.apa31 = g_apa.apa57
          LET g_apa.apa31f = g_apa.apa57f
          LET g_apa.apa32 = g_apa.apa57*g_apa.apa16/100    #No.TQC-740167
          CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
          LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
          LET g_apa.apa32f = g_apa.apa57f*g_apa.apa16/100  #No.TQC-740167
          CALL t110_apa32f() RETURNING l_apa32f                   #No.MOD-B80140 add
          LET g_apa.apa32f = l_apa32f                             #No.MOD-B80140 add
          #-----MOD-7B0180---------
          LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)
          LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)
          #-----END MOD-7B0180-----
          DISPLAY BY NAME g_apa.apa31,g_apa.apa31f,g_apa.apa32,g_apa.apa32f  #No.TQC-740167 add apa32,apa32f
       END IF
       #-----END FUN-6C0037-----
 #MOD-560240
    ELSE
       IF g_aptype !='11' THEN   #MOD-890177 add
          LET g_apa.apa57 = g_apa.apa31
          LET g_apa.apa57f = g_apa.apa31f
          DISPLAY BY NAME g_apa.apa57
       END IF                    #MOD-890177 add
 #END MOD-560240
    END IF

    #--

    IF g_aptype = '11' AND g_apa.apa57f > g_apa.apa31f AND g_apz.apz15 = 'N' THEN
       CALL cl_err('apa57f >apa31f: ','aap-051',1)
    END IF

     #CALL t110_apz08('')  #MOD-490323
    CALL t110_diff_rtn('0') ##TQC-750140
 
    #No.TQC-7B0083  --Begin
#    CALL t110_api_diff()   #MOD-970115
    IF g_apa.apa56 = '5' THEN
       CALL t110_ppp('2')
    END IF

   #-MOD-C20104-add-
    IF g_apz.apz27 = 'Y' AND g_aza.aza17 != g_apa.apa13 THEN
       LET l_sumapi05f = 0
       LET l_sumapi05 = 0
       LET l_chkamt = 0
       LET l_diffamt = 0
       LET l_apa73 = 0
       LET g_sql = "SELECT api26,SUM(api05f),SUM(api05) ",
                   "  FROM api_file ",
                   " WHERE api01 = '",g_apa.apa01,"'",
                   "   AND api02 = '2'",
                   " GROUP BY api26 ",
                   " ORDER BY api26 "
       PREPARE sel_api_pre FROM g_sql
       DECLARE sel_api_cur CURSOR FOR sel_api_pre
       FOREACH sel_api_cur INTO l_api26,l_sumapi05f,l_sumapi05
          IF cl_null(l_sumapi05f) THEN LET l_sumapi05f = 0 END IF
          IF cl_null(l_sumapi05) THEN LET l_sumapi05 = 0 END IF
          SELECT apa34f-apa35f,apa73 INTO l_chkamt,l_apa73
            FROM apa_file
           WHERE apa01 = l_api26
          IF cl_null(l_chkamt) THEN LET l_chkamt = 0 END IF
          IF cl_null(l_apa73) THEN LET l_apa73 = 0 END IF
          IF l_chkamt = l_sumapi05f AND l_apa73 <> l_sumapi05 THEN
             LET l_diffamt = l_apa73 - l_sumapi05 
             LET g_sql=" SELECT api03 ",
                       "   FROM api_file ",
                       "  WHERE api01 = '",g_apa.apa01,"'",
                       "    AND api26 = '",l_api26,"'",
                       "    AND api02 = '2'",
                       "  ORDER BY api05 DESC "
             PREPARE p110_max_p FROM g_sql
             DECLARE p110_max_c SCROLL CURSOR FOR p110_max_p
             OPEN p110_max_c
             FETCH FIRST p110_max_c INTO l_api03
             UPDATE api_file SET api05 = api05 + l_diffamt
              WHERE api01 = g_apa.apa01
                AND api02 = '2'   
                AND api03 = l_api03
          END IF
       END FOREACH 
    END IF
   #-MOD-C20104-end-

    CALL t110_api_diff()   #MOD-970115 
    #No.TQC-7B0083  --End  
     #MOD-550063
     #IF (g_aptype='11' OR g_aptype = '12') AND g_apa.apa56='0' AND (g_apa.apa31!=g_apa.apa57) THEN   #No:MOD-530274
     #   CALL t110_b('b')  #MOD-490323
    #END IF
    IF g_aptype='11' AND g_apa.apa56='0' AND (g_apa.apa31!=g_apa.apa57)
       THEN CONTINUE WHILE
    END IF
    #--

    #No.+111 010510 by plym add 調整apk折讓單稅額和單頭有無誤差
    IF g_apa.apa00='21' AND g_apa.apa58 <> '1' THEN
       CALL t110_chkapk(g_apa.apa01,g_apa.apa01,'1')
    END IF

   #str MOD-940178 add
    IF g_apa.apa08 != 'MISC' AND g_apa.apa08 != g_apa.apa01 AND
       NOT cl_null(g_apa.apa08) AND g_apa.apa08 !='UNAP' AND
       g_apa.apa00 != '21' THEN
       CALL t110_ddd1('u')
    END IF
   #end MOD-940178 add

   #str MOD-860303 add
   #單身若有採購單時,單頭金額不可大於單身金額
#MOD-960026---begin                                                             
#       IF g_aptype = '15' AND g_aza.aza26 != '2' THEN  #No.MOD-890227 add aza26
        SELECT pmc913 INTO l_pmc913 FROM pmc_file                               
         WHERE pmc01 = g_apa.apa05                                              
        IF g_aptype = '15' AND g_aza.aza26 != '2' AND 
         (g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y')) THEN
#MOD-960026---end 
           LET l_cnt = 0
           SELECT COUNT(*) INTO l_cnt FROM apb_file WHERE apb06 IS NOT NULL
                                                      AND apb01=g_apa.apa01
           IF l_cnt > 0 THEN
              SELECT SUM(apb10),SUM(apb24) INTO l_apb10,l_apb24     
                FROM apb_file                                    
               WHERE apb01=g_apa.apa01                        
              IF cl_null(l_apb24) THEN LET l_apb24 = 0 END IF
              IF cl_null(l_apb10) THEN LET l_apb10 = 0 END IF
              IF g_apa.apa31f > l_apb24 OR g_apa.apa31 > l_apb10 THEN
                 #單頭金額大於單身合計金額, (1)修改單頭 (2)修改單身:
                 CALL cl_getmsg('aap-117',g_lang) RETURNING g_msg
                 WHILE TRUE
                    LET g_chr=' '
                    LET INT_FLAG = 0  ######add for prompt bug
                    PROMPT g_msg CLIPPED FOR CHAR g_chr
                       ON IDLE g_idle_seconds
                          CALL cl_on_idle()
           
                       ON ACTION about         #MOD-4C0121
                          CALL cl_about()      #MOD-4C0121
           
                       ON ACTION help          #MOD-4C0121
                          CALL cl_show_help()  #MOD-4C0121
           
                       ON ACTION controlg      #MOD-4C0121
                          CALL cl_cmdask()     #MOD-4C0121
                    END PROMPT
                    IF INT_FLAG THEN LET INT_FLAG = 0 END IF
                    IF g_chr MATCHES "[12]" THEN EXIT WHILE END IF
                 END WHILE
                 IF g_chr = '2' THEN LET l_exit_sw = 'n' END IF
                 IF g_chr = '1' THEN CALL t110_i("u") END IF
              END IF
           END IF
        END IF
   #end MOD-860303 add

    CALL t110_gen_gl()  #MOD-490323

   #str MOD-860303 mod
   #EXIT WHILE                    #MOD-550063
    IF l_exit_sw = 'y' THEN
       EXIT WHILE
    ELSE
       CONTINUE WHILE
    END IF
   #end MOD-860303 mod
  END WHILE                        #MOD-550063

    CLOSE t110_bcl
    CALL t110_delHeader()     #CHI-C30002 add
    COMMIT WORK
 
   #CALL t110_sum_apa()   #No:MOD-910062   #MOD-920352 mark

END FUNCTION

#CHI-C30002 -------- add -------- begin
FUNCTION t110_delHeader()
   IF g_rec_b = 0 THEN
      IF cl_confirm("9042") THEN
         DELETE FROM apa_file WHERE apa01 = g_apa.apa01
         DELETE FROM apc_file WHERE apc01 = g_apa.apa01 
         DELETE FROM apk_file WHERE apk01 = g_apa.apa01
         DELETE FROM npp_file
          WHERE npp01 = g_apa.apa01
            AND nppsys = 'AP'
            AND npp00 = 1
            AND npp011 = 1
         DELETE FROM npq_file
          WHERE npq01 = g_apa.apa01
            AND npqsys = 'AP'
            AND npq00 = 1
            AND npq011 = 1
         DELETE FROM tic_file WHERE tic04 = g_apa.apa01
         DELETE FROM apd_file WHERE apd01 = g_apa.apa01
         DELETE FROM apx_file WHERE apx01 = g_apa.apa01
         DELETE FROM api_file WHERE api01 = g_apa.apa01
         DELETE FROM apg_file WHERE apg01 = g_apa.apa01
         DELETE FROM aph_file WHERE aph01 = g_apa.apa01
         DELETE FROM apv_file WHERE apv01 = g_apa.apa01
         INITIALIZE g_apa.* TO NULL
         CLEAR FORM
      END IF
   END IF
END FUNCTION
#CHI-C30002 -------- add -------- end

#FUN-810045 begin
#此段原本放在 INPUT ARRAY的AFTER INSERT 及 ON ROW CHANGE
#但放在AFTER INSERT 中下 NEXT FIELD會無效，所以拉出來放到各欄位AFTER FIEL
FUNCTION t110_apb25()
  LET g_errno = '' 
  IF g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' AND
     g_apb[l_ac].apb09 != 0 THEN
     DISPLAY 'INTO t110_apb25'
     #No.FUN-830161  --Begin
     #IF cl_null(g_apb[l_ac].apb30) THEN
     #   LET g_errno = 'apb30'
     #   RETURN
     #END IF
     #No.FUN-830161  --End  
#No.FUN-680029--begin
     IF g_aza.aza63 = 'Y' THEN   #MOD-7B0257
       #IF NOT cl_null(g_apb[l_ac].apb30) AND NOT cl_null(g_apb[l_ac].apb251)
       #   AND NOT cl_null(g_apb[l_ac].apb26) THEN
        IF cl_null(g_apb[l_ac].apb251) THEN
           LET g_errno = 'apb251'
           RETURN
        END IF
        #No.FUN-830161  --Begin
        #SELECT COUNT(*) INTO g_cnt FROM pnr_file
        # WHERE pnr01=g_apb[l_ac].apb30  
        #   AND pnr02=g_apb[l_ac].apb251
        #   AND pnr03=g_apb[l_ac].apb26
        #IF g_cnt=0 THEN
        #   CALL cl_err(g_apb[l_ac].apb30,'apm-313',0)  #FUN-810045
        #   DISPLAY 'RETURN FALSE apb251'
        #   LET g_errno = 'apb251'
        #END IF
        #No.FUN-830161  --End  
       #END IF
     END IF   #MOD-7B0257
#No.FUN-680029--end
     IF cl_null(g_apb[l_ac].apb26) THEN
        LET g_errno = 'apb26'
        RETURN
     END IF
     #IF NOT cl_null(g_apb[l_ac].apb30) AND NOT cl_null(g_apb[l_ac].apb25)
     #   AND NOT cl_null(g_apb[l_ac].apb26) THEN
        IF cl_null(g_apb[l_ac].apb25) THEN
           LET g_errno = 'apb25'
           RETURN
        END IF
       #No.FUN-830161  --Begin
       #SELECT COUNT(*) INTO g_cnt FROM pnr_file
       # WHERE pnr01=g_apb[l_ac].apb30    
       #   AND pnr02=g_apb[l_ac].apb25
       #   AND pnr03=g_apb[l_ac].apb26
       #IF g_cnt=0 THEN
       #   CALL cl_err(g_apb30,'apm-313',0)
       #   DISPLAY 'RETURN FALSE apb25'
       #   LET g_errno = 'apb25'
       #END IF
       #No.FUN-830161  --End  
     #END IF
  END IF
  DISPLAY 'RETURN TRUE'
END FUNCTION

#No.FUN-830161  --Begin
#FUNCTION t110_apb30(p_cmd)
#  DEFINE p_cmd    LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
#  IF g_apy.apydmy5!='Y' THEN RETURN END IF
#
#  IF p_cmd='a' THEN
#      IF NOT cl_null(g_apb[l_ac].apb06) AND NOT cl_null(g_apb[l_ac].apb07) THEN
#         SELECT pmn66 INTO g_apb[l_ac].apb30 FROM pmn_file
#          WHERE pmn01=g_apb[l_ac].apb06 AND pmn02=g_apb[l_ac].apb07
#      ELSE
#         LET g_apb[l_ac].apb30=' '
#      END IF
#
#      IF l_ac>1 THEN
#         SELECT apb30 INTO g_apb[l_ac].apb30 FROM apb_file
#          WHERE apb01=g_apa.apa01 AND apb02=g_apb[l_ac-1].apb02
#         DISPLAY BY NAME g_apb[l_ac].apb30
#      END IF
#  END IF
#END FUNCTION
#No.FUN-830161  --End  
#FUN-810045 end

#No.FUN-830161  --Begin 取消此function
#FUNCTION t110_b_more1(p_cmd)
#   DEFINE p_cmd    LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
#   DEFINE l_afa02  LIKE afa_file.afa02
#   DEFINE l_pmn66  LIKE pmn_file.pmn66
##  DEFINE l_apb30,t_apb30  LIKE apb_file.apb30  #No.FUN-830161
#
#   IF g_apy.apydmy5!='Y' THEN RETURN END IF
#
#   IF p_cmd='a' THEN
#      IF NOT cl_null(g_apb[l_ac].apb06) AND NOT cl_null(g_apb[l_ac].apb07) THEN
#         SELECT pmn66 INTO l_apb30 FROM pmn_file
#          WHERE pmn01=g_apb[l_ac].apb06 AND pmn02=g_apb[l_ac].apb07
#      ELSE
#         LET l_apb30=' '
#      END IF
#
#      IF l_ac>1 THEN
#         SELECT apb30 INTO l_apb30 FROM apb_file
#          WHERE apb01=g_apa.apa01 AND apb02=g_apb[l_ac-1].apb02
#         DISPLAY BY NAME l_apb30
#      END IF
#   ELSE
#      SELECT apb30 INTO l_apb30 FROM apb_file
#       WHERE apb01=g_apa.apa01 AND apb02=g_apb[l_ac].apb02
#   END IF
#
#   OPEN WINDOW t110_5_w WITH FORM "aap/42f/aapt110_5"
#         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
#    CALL cl_ui_locale("aapt110_5")
# 
#   SELECT afa02 INTO l_afa02 FROM afa_file WHERE afa01=l_apb30
#   DISPLAY l_afa02 TO FORMONLY.afa02
#   CALL cl_set_head_visible("","YES")     #No.FUN-6B0033
#
#   INPUT BY NAME l_apb30 WITHOUT DEFAULTS
#
#      BEFORE FIELD l_apb30
#         LET t_apb30=l_apb30
# 
#      AFTER FIELD l_apb30
#         SELECT afa02 INTO l_afa02 FROM afa_file WHERE afa01=l_apb30
#         IF STATUS THEN
#            LET l_apb30=t_apb30
##           CALL cl_err(l_apb30,'apm-005',0)   #No.FUN-660122
#            CALL cl_err3("sel","afa_file",l_apb30,"","apm-005","","",1)  #No.FUN-660122
#            DISPLAY BY NAME l_apb30
#            NEXT FIELD l_apb30
#         END IF
#         DISPLAY l_afa02 TO FORMONLY.afa02
#         IF NOT cl_null(g_apb[l_ac].apb06) AND NOT cl_null(g_apb[l_ac].apb07) THEN
#            SELECT pmn66 INTO l_pmn66 FROM pmn_file
#              WHERE pmn01=g_apb[l_ac].apb06 AND pmn02=g_apb[l_ac].apb07   #MOD-7B0258
#            IF l_pmn66!=l_apb30 THEN
#               LET l_apb30=t_apb30
#               CALL cl_err(l_apb30,'apm-311',0)
#               DISPLAY BY NAME l_apb30
#               NEXT FIELD l_apb30
#            END IF
#         END IF
# 
#      ON ACTION CONTROLZ
#         CALL cl_show_req_fields()
# 
#      ON ACTION CONTROLG
#         CALL cl_cmdask()
# 
#      ON ACTION CONTROLP
#         CASE
#            WHEN INFIELD(l_apb30)
##              CALL q_afa(0,0,l_apb30,' ') RETURNING l_apb30
#               CALL cl_init_qry_var()
#               LET g_qryparam.form ="q_afa"
#               LET g_qryparam.default1 = l_apb30
#               CALL cl_create_qry() RETURNING l_apb30
##               CALL FGL_DIALOG_SETBUFFER( l_apb30 )
#               DISPLAY BY NAME l_apb30
#               NEXT FIELD l_apb30
#            OTHERWISE EXIT CASE
#         END CASE
# 
#      ON ACTION qry_consumed_budget
#         CASE
#            WHEN INFIELD(l_apb30)
#                 LET g_cmd = "apmq650 "," '",l_apb30,"' ",
#                                        " '",g_apb[l_ac].apb25,"' ",
#                                        " '",g_apb[l_ac].apb26,"' ",
#                                        " '",YEAR(g_apa.apa02),"' " ,
#                                        " '",g_apb[l_ac].apb251,"'" CLIPPED
#                 CALL cl_cmdrun(g_cmd)
#            OTHERWISE EXIT CASE
#         END CASE
#
#      AFTER INPUT
#         IF INT_FLAG THEN
#            LET INT_FLAG=0
#            EXIT INPUT
#         END IF
#
#      ON IDLE g_idle_seconds
#         CALL cl_on_idle()
#         CONTINUE INPUT
# 
#      ON ACTION about         #MOD-4C0121
#         CALL cl_about()      #MOD-4C0121
# 
#      ON ACTION help          #MOD-4C0121
#         CALL cl_show_help()  #MOD-4C0121
# 
# 
#   END INPUT
#
#   IF p_cmd='u' THEN
#      UPDATE apb_file SET apb30=l_apb30
#       WHERE apb01=g_apa.apa01
#         AND apb02=g_apb[l_ac].apb02
#   END IF
#
#   LET g_apb30=l_apb30
#   CLOSE WINDOW t110_5_w               #結束畫面
#
#   IF INT_FLAG THEN
#      LET INT_FLAG=0
#      RETURN
#   END IF
#
#END FUNCTION
#No.FUN-830161  --End   取消此function

#----------------------------------------------------------------------#
# 計算差異
#----------------------------------------------------------------------#
FUNCTION t110_compute_apa33()

 DEFINE l_amt        LIKE apb_file.apb10  #No:8014 DECIMAL(12,0)
 DEFINE l_diff_amt   LIKE apa_file.apa33, #No:8014 DECIMAL(12,0),
        i            LIKE type_file.num5    #No.FUN-690028 SMALLINT

    LET l_amt =    0

     FOR i = 1 TO g_apb.getLength()    #No:MOD-480131
       #FUN-630055 add--start
       IF (g_aptype='12' OR g_aptype='15' OR g_aptype='13' OR g_aptype='17') THEN   #No.FUN-690080
         IF g_apb[i].apb31 IS NULL OR g_apb[i].apb31 = ' ' THEN
            CONTINUE FOR END IF
       ELSE
         IF g_apb[i].apb21 IS NULL OR g_apb[i].apb21 = ' ' THEN
            CONTINUE FOR END IF
       END IF
       #FUN-630055 add--end

       #FUN-630055 remark --start--
       #IF g_apb[i].apb21 IS NULL OR g_apb[i].apb21 = ' ' THEN
       #   CONTINUE FOR END IF
       #FUN-630055 remark --end--

       LET l_amt = l_amt + g_apb[i].apb10
    END FOR

    #LET g_apa.apa31 = cl_digcut(g_apa.apa31,t_azi.azi04)   #MOD-6B0066
    LET g_apa.apa31 = cl_digcut(g_apa.apa31,g_azi04)   #MOD-6B0066
    LET l_diff_amt = g_apa.apa31 - l_amt

    LET g_apa.apa33 = l_diff_amt

    DISPLAY BY NAME g_apa.apa33

END FUNCTION
 
FUNCTION t110_diff_rtn(p_cmd) ##TQC-750140
 DEFINE  p_cmd    LIKE type_file.chr1      #TQC-750140
 DEFINE  l_apa01  LIKE apa_file.apa01,
         l_apa    RECORD LIKE apa_file.*,
        #l_sql    LIKE type_file.chr1000   #No.FUN-690028 VARCHAR(200)   #MOD-720062
         l_sql    STRING,   #MOD-720062
         g_t1     LIKE oay_file.oayslip,   #MOD-8C0221 add
         l_cnt    LIKE type_file.num5,     #MOD-980030 add
         l_apa32  LIKE apa_file.apa32,    #No.MOD-B80140 add
         l_apa32f LIKE apa_file.apa32f    #No.MOD-B80140 add

   IF g_apa.apa41 = 'Y' THEN
      CALL cl_err("apa41=Y",'aap-086',0)
      RETURN
   END IF
   IF g_action_choice != "contra" AND g_action_choice != "modify" THEN      #FUN-8A0075
  #IF g_apa.apa63 MATCHES '[Ss1]' THEN      #FUN-540045 #FUN-550042 #MOD-C90206 mark
   IF g_apa.apa63 MATCHES '[Ss]' THEN       #MOD-C90206 add
      CALL cl_err('','mfg3557',0)
      RETURN
   END IF
   END IF                                   #FUN-8A0075

   IF g_apa.apa42 = 'Y' THEN
      CALL cl_err("apa42=Y",'aap-165',0)
      RETURN
   END IF

   IF g_apa.apa74 = 'Y' THEN
      CALL cl_err("apa74=Y",'aap-334',0)
      RETURN
   END IF

   #No.TQC-7B0083  --Begin
   IF g_aptype = '16' OR g_aptype = '26' THEN
      IF g_apa.apa57f <> g_apa.apa31f OR g_apa.apa57 <> g_apa.apa31 THEN
         LET g_apa.apa31f = g_apa.apa57f
         LET g_apa.apa31  = g_apa.apa57 
         LET g_apa.apa32f = 0
         LET g_apa.apa32  = 0
         LET g_apa.apa33f = 0
         LET g_apa.apa33  = 0
         LET g_apa.apa34f = g_apa.apa57f
         LET g_apa.apa34  = g_apa.apa57 
         LET g_apa.apa35f = 0
         LET g_apa.apa35  = 0
         LET g_apa.apa73  = g_apa.apa57
         LET p_cmd = '1'
      END IF
   END IF
   #No.TQC-7B0083  --End  

   #IF g_aptype = '11' OR (g_aptype = '12' AND g_apa.apa57f>0) THEN   #MOD-610023
   #IF g_aptype = '11' OR g_aptype = '12' THEN   #MOD-610023   #MOD-640549
   IF g_aptype = '11' THEN     #MOD-640549
      IF g_apa.apa57f != g_apa.apa31f OR g_apa.apa57 != g_apa.apa31 THEN
        #str CHI-930001 add
         IF g_apa.apa56 = '5' AND g_apa.apa33 = 0 THEN   #5.沖期初開帳的暫估
            RETURN
         END IF
        #end CHI-930001 add
         CALL t110_diff()
         IF g_apa.apa56 = '0' THEN
            RETURN
         END IF
      ELSE
        #-MOD-AA0120-add-
         IF g_apa.apa56 = '1' THEN
            LET g_apa.apa56 = '0'   #差異處理(正常)   
         END IF
        #-MOD-AA0120-end-
        #LET g_apa.apa56 = '0'   #差異處理(正常)     #MOD-A80069
         LET g_apa.apa33f= 0
         LET g_apa.apa33 = 0
         LET g_apa.apa60f= 0
         LET g_apa.apa61f= 0
         LET g_apa.apa60 = 0
         LET g_apa.apa61 = 0
         DISPLAY BY NAME g_apa.apa56,g_apa.apa33,g_apa.apa60f,g_apa.apa60,
                         g_apa.apa61f,g_apa.apa61
         UPDATE apb_file SET apb15 = 0,
                             apb13f= 0,
                             apb13 = 0,
                             apb14f= 0,
                             apb14 = 0
          WHERE apb01=g_apa.apa01
      END IF

      IF g_apa.apa57f=(g_apa.apa31f+g_apa.apa33f) AND g_apa.apa19=g_apz.apz12 THEN
         LET g_apa.apa19 = NULL
         LET g_apa.apa20 = 0
         UPDATE apc_file SET apc16=0 WHERE apc01=g_apa.apa01          #MOD-A70116 add
         DISPLAY BY NAME g_apa.apa19,g_apa.apa20
         DISPLAY '' TO apo02
      END IF
   END IF

   #-----MOD-640549---------
   IF g_aptype='12' OR g_aptype='13' OR g_aptype='21' OR g_aptype='17' THEN  #No.FUN-690080  #MOD-A10133 add 21 #TQC-A40107 add 17
      IF g_apa.apa57f != g_apa.apa31f OR g_apa.apa57 != g_apa.apa31 THEN
        #str MOD-980030 add
        #詢問aap-336前,增加判斷單身是否有沖暫估資料,若有則不更新單頭金額
         LET l_cnt = 0
         SELECT COUNT(*) INTO l_cnt FROM apb_file
          WHERE apb01=g_apa.apa01 AND apb34='Y'
         IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
         IF l_cnt = 0 THEN
        #end MOD-980030 add
            IF cl_confirm('aap-336') THEN
               CALL t110_b('')
            ELSE                          #CHI-910032                                                                                  
               CALL t110_sum_apa()        #CHI-910032   
            END IF
         END IF   #MOD-980030 add
      END IF
   END IF
   #-----END MOD-640549-----

  #str MOD-9B0168 mark
  #IF g_aptype ='21' OR (g_aptype = '22' AND g_apa.apa57f>0) THEN  #MOD-8B0170 mark
  #IF g_aptype = '22' AND g_apa.apa57f>0 THEN                      #MOD-8B0170
  #   CALL t110_sum_apa()
  #
  #   IF g_apa.apa31f<>g_apa_t.apa31f AND g_apa_t.apa31f > 0 THEN
  #      LET g_apa.apa32f = g_apa.apa31f * g_apa.apa16 / 100
  #      #LET g_apa.apa32f = cl_digcut(g_apa.apa32f,g_azi.azi04)   #MOD-6B0066
  #      LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)   #MOD-6B0066
  #   END IF
  #
  #   IF g_apa.apa31 <>g_apa_t.apa31 AND g_apa_t.apa31 > 0 THEN
  #      LET g_apa.apa32  = g_apa.apa31 * g_apa.apa16 / 100
  #      #LET g_apa.apa32  = cl_digcut(g_apa.apa32 ,t_azi.azi04)   #MOD-6B0066
  #      LET g_apa.apa32  = cl_digcut(g_apa.apa32 ,g_azi04)   #MOD-6B0066
  #   END IF
  #
  #   DISPLAY BY NAME g_apa.apa31f,g_apa.apa31,g_apa.apa32f,g_apa.apa32
  #ELSE
  #end MOD-9B0168 mark
     #IF g_aptype <> '12' THEN  #MOD-680012                       #MOD-9B0168 mark
      IF g_aptype <> '12' AND g_aptype <> '22' THEN  #MOD-680012  #MOD-9B0168
         IF g_apa.apa31f<>g_apa_t.apa31f AND g_apa_t.apa31f > 0 THEN
            LET g_apa.apa32f = g_apa.apa31f * g_apa.apa16 / 100
            CALL t110_apa32f() RETURNING l_apa32f                   #No.MOD-B80140 add
            LET g_apa.apa32f = l_apa32f                             #No.MOD-B80140 add
           #LET g_apa.apa32f = cl_digcut(g_apa.apa32f,g_azi.azi04)   #MOD-6B0066
            LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)   #MOD-6B0066
         END IF
         
         IF g_apa.apa31 <>g_apa_t.apa31 AND g_apa_t.apa31 > 0 THEN
            LET g_apa.apa32  = g_apa.apa31 * g_apa.apa16 / 100
            CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
            LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
           #LET g_apa.apa32  = cl_digcut(g_apa.apa32 ,t_azi.azi04)   #MOD-6B0066
            LET g_apa.apa32  = cl_digcut(g_apa.apa32 ,g_azi04)   #MOD-6B0066
         END IF
         
         DISPLAY BY NAME g_apa.apa31f,g_apa.apa31,g_apa.apa32f,g_apa.apa32
      END IF   #MOD-680012
  #END IF   #MOD-9B0168 mark

   CALL t110_apa34f(p_cmd)   #TQC-750140
   CALL t110_unpay()

   LET g_apa.apa72=g_apa.apa14
   CALL t110_comp_oox(g_apa.apa01) RETURNING g_net  #CHI-890017 add
  #LET g_apa.apa73=g_apa.apa34-g_apa.apa35          #CHI-890017 mark
   LET g_apa.apa73=g_apa.apa34-g_apa.apa35+g_net    #CHI-890017

  #UPDATE apa_file set * = g_apa.* WHERE apa01 = g_apa.apa01   #FUN-D30066 mark
   #--FUN-D30066 add start--
          UPDATE apa_file SET(apa00,apa01,apa02,apa05,apa06,
                              apa07,apa08,apa09,apa11,apa12,
                              apa13,apa14,apa15,apa16,apa17,
                              apa171,apa172,apa173,apa174,apa175,
                              apa18,apa19,apa20,apa21,apa22,
                              apa23,apa24,apa25,apa31f,apa32f,
                              apa33f,apa34f,apa35f,apa31,apa32,
                              apa33,apa34,apa35,apa36,apa41,
                              apa42,apa43,apa44,apa45,apa46,
                              apa51,apa52,apa53,apa54,apa55,
                              apa56,apa57f,apa57,apa58,apa59,
                              apa60f,apa61f,apa60,apa61,apa62,
                              apa64,apa65f,apa65,apa66,apa67,
                              apa68,apa69,apa70,apa71,apa72,
                              apa73,apa74,apa75,apa99,apainpd,
                              apamksg,apasign,apadays,apaprit,apasmax,
                              apasseq,apaprno,apaacti,apauser,apagrup,
                              apamodu,apadate,apa100,apa930,apa511,
                              apa521,apa531,apa541,apa37,apa37f,
                              apa101,apa102,apa992,apa26,apaud01,
                              apaud02,apaud03,apaud04,apaud05,apaud06,
                              apaud07,apaud08,apaud09,apaud10,apaud11,
                              apaud12,apaud13,apaud14,apaud15,apalegal,
                              apa76,apa77,apaoriu,apaorig,apa78,
                              apa79,apa80,apa81)=
                             (g_apa.apa00,g_apa.apa01,g_apa.apa02,g_apa.apa05,g_apa.apa06,
                              g_apa.apa07,g_apa.apa08,g_apa.apa09,g_apa.apa11,g_apa.apa12,
                              g_apa.apa13,g_apa.apa14,g_apa.apa15,g_apa.apa16,g_apa.apa17,
                              g_apa.apa171,g_apa.apa172,g_apa.apa173,g_apa.apa174,g_apa.apa175,
                              g_apa.apa18,g_apa.apa19,g_apa.apa20,g_apa.apa21,g_apa.apa22,
                              g_apa.apa23,g_apa.apa24,g_apa.apa25,g_apa.apa31f,g_apa.apa32f,
                              g_apa.apa33f,g_apa.apa34f,g_apa.apa35f,g_apa.apa31,g_apa.apa32,
                              g_apa.apa33,g_apa.apa34,g_apa.apa35,g_apa.apa36,g_apa.apa41,
                              g_apa.apa42,g_apa.apa43,g_apa.apa44,g_apa.apa45,g_apa.apa46,
                              g_apa.apa51,g_apa.apa52,g_apa.apa53,g_apa.apa54,g_apa.apa55,
                              g_apa.apa56,g_apa.apa57f,g_apa.apa57,g_apa.apa58,g_apa.apa59,
                              g_apa.apa60f,g_apa.apa61f,g_apa.apa60,g_apa.apa61,g_apa.apa62,
                              g_apa.apa64,g_apa.apa65f,g_apa.apa65,g_apa.apa66,g_apa.apa67,
                              g_apa.apa68,g_apa.apa69,g_apa.apa70,g_apa.apa71,g_apa.apa72,
                              g_apa.apa73,g_apa.apa74,g_apa.apa75,g_apa.apa99,g_apa.apainpd,
                              g_apa.apamksg,g_apa.apasign,g_apa.apadays,g_apa.apaprit,g_apa.apasmax,
                              g_apa.apasseq,g_apa.apaprno,g_apa.apaacti,g_apa.apauser,g_apa.apagrup,
                              g_apa.apamodu,g_apa.apadate,g_apa.apa100,g_apa.apa930,g_apa.apa511,
                              g_apa.apa521,g_apa.apa531,g_apa.apa541,g_apa.apa37,g_apa.apa37f,
                              g_apa.apa101,g_apa.apa102,g_apa.apa992,g_apa.apa26,g_apa.apaud01,
                              g_apa.apaud02,g_apa.apaud03,g_apa.apaud04,g_apa.apaud05,g_apa.apaud06,
                              g_apa.apaud07,g_apa.apaud08,g_apa.apaud09,g_apa.apaud10,g_apa.apaud11,
                              g_apa.apaud12,g_apa.apaud13,g_apa.apaud14,g_apa.apaud15,g_apa.apalegal,
                              g_apa.apa76,g_apa.apa77,g_apa.apaoriu,g_apa.apaorig,g_apa.apa78,
                              g_apa.apa79,g_apa.apa80,g_apa.apa81)
             WHERE apa01 = g_apa.apa01
          #--FUN-D30066 add end--
   IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
      LET g_success = 'N'
#     CALL cl_err('up_apa',SQLCA.sqlcode,0)   #No.FUN-660122
      CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","up_apa",1)  #No.FUN-660122
      RETURN
   END IF
#CHI-910032---BEGIN   
 #MOD-990188---modify---start---                                                                                                              
  #IF g_apa.apa08 != 'MISC' THEN                                                                                                    
   IF g_apa.apa08 != 'MISC' AND g_apa.apa08 != g_apa.apa01 AND
      NOT cl_null(g_apa.apa08) AND g_apa.apa08 !='UNAP' AND
      g_apa.apa00 != '21' THEN  
      CALL t110_ddd1('u')                                                                                                           
   END IF    
 #MOD-990188---modify---end---                                                                                                                       
#CHI-910032---END 
   CALL t110_apa56()
   DISPLAY BY NAME g_apa.apa56

  #str MOD-8C0221 add
   LET g_t1=g_apa.apa01[1,g_doc_len]
   SELECT apydmy3 INTO g_apy.apydmy3 FROM apy_file WHERE apyslip=g_t1
#  IF g_apy.apydmy3 = 'Y' THEN
   IF g_apy.apydmy3 = 'Y' AND g_apa.apa56 != 0 THEN    #No.MOD-920052
  #end MOD-8C0221 add
     #FUN-D70132 add str---
      SELECT apa79 INTO g_apa.apa79 FROM apa_file WHERE apa01 = g_apa.apa01
      IF g_apa.apa79 = 'N' THEN
         RETURN
      ELSE
     #FUN-D70132 add end---
         #No.MOD-840531 add 080422 --begin
         IF cl_confirm('axr-309') THEN
            CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'0')
            IF g_aza.aza63 ='Y' THEN
               CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'1')  
            END IF
         END IF
         #No.MOD-840531 add 080422 --end
      END IF   #FUN-D70132 add 
   END IF   #MOD-8C0221 add

END FUNCTION

FUNCTION t110_apb12(p_cmd,p_no)  #料件編號
    DEFINE l_ima02 LIKE ima_file.ima02,
           l_ima021 LIKE ima_file.ima021,
           l_ima39 LIKE ima_file.ima39,
           l_ima44 LIKE ima_file.ima44,
           l_imaacti LIKE ima_file.imaacti,
           p_no      LIKE type_file.chr4,        #No:FUN-690028 VARCHAR(04),
           p_cmd     LIKE type_file.chr1,        #No.FUN-690028 VARCHAR(1)
           l_ima01   LIKE ima_file.ima01,        #CHI-990015 add
           l_aag05   LIKE aag_file.aag05,        #CHI-990015 add
           l_cnt     LIKE type_file.num5         #MOD-A70048 
 
   LET g_errno = " "
  #-MOD-A70048-add-
   LET l_cnt = 0
   SELECT count(*) INTO l_cnt
     FROM ima_file
    WHERE ima01 = g_apb[l_ac].apb12
  #-MOD-A70048-add-
  #str CHI-990015 add
  #IF p_no = 'MISC' THEN                   #MOD-A70048 mark
   IF p_no = 'MISC' AND l_cnt = 0 THEN     #MOD-A70048
      LET l_ima01 = p_no
   ELSE
      LET l_ima01 = g_apb[l_ac].apb12
   END IF
  #end CHI-990015 add
   SELECT ima02,ima021,ima39,ima44,imaacti
     INTO l_ima02,l_ima021,l_ima39,l_ima44,l_imaacti
     FROM ima_file
  # WHERE ima01 = g_apb[l_ac].apb12   #CHI-990015 mark
    WHERE ima01 = l_ima01             #CHI-990015 
 
   CASE
      WHEN SQLCA.SQLCODE = 100
         LET g_errno = 'mfg0002'
         LET l_ima02 = NULL
         LET l_imaacti = NULL
         LET l_ima021=NULl
      WHEN l_imaacti='N'
         LET g_errno = '9028'
      WHEN l_imaacti MATCHES '[PH]'       
         LET g_errno = '9038'         #No.FUN-690022
      OTHERWISE
         LET g_errno = SQLCA.SQLCODE USING '-------'
   END CASE

   IF g_apb[l_ac].apb27 IS NULL OR p_no != 'MISC' THEN
      LET g_apb[l_ac].apb27= l_ima02
      #------No:MOD-5A0095 START-------------------
      DISPLAY BY NAME g_apb[l_ac].apb27
      #------No:MOD-5A0095 END---------------------
   END IF

  #str CHI-990015 mod
  #IF g_apb[l_ac].apb12 <> 'MISC' AND g_apb[l_ac].apb25 IS NULL THEN
   IF g_apb[l_ac].apb25 IS NULL AND (
      ((g_aptype='15' OR g_aptype='17') AND g_apb[l_ac].apb12 <> 'MISC') OR
      ( g_aptype='12' AND p_no='MISC')) THEN
  #end CHI-990015 mod
      LET g_apb[l_ac].apb25 = l_ima39
      DISPLAY g_apb[l_ac].apb25 TO s_apb[l_ac].apb25
   END IF

   IF g_apb[l_ac].apb12 <> 'MISC' AND cl_null(g_apb[l_ac].apb28) THEN
      LET g_apb[l_ac].apb28 = l_ima44
      DISPLAY g_apb[l_ac].apb28 TO s_apb[l_ac].apb28
   END IF

  #str CHI-990015 add
   #當執行aapt120,若單身科目需做部門管理,單身部門預設帶入單頭部門
   IF g_aptype='12' AND NOT cl_null(g_apb[l_ac].apb25) THEN
      SELECT aag05 INTO l_aag05 FROM aag_file
      #WHERE aag01=g_apb[l_ac].apb25 AND aag00=g_bookno1                        #No.MOD-B70280 mark
       WHERE aag01=g_apb[l_ac].apb25 AND aag00=g_bookno1  AND aagacti = 'Y'     #No.MOD-B70280 add
     #IF l_aag05='Y' THEN                                     #MOD-A70003 mark
      IF l_aag05='Y' AND cl_null(g_apb[l_ac].apb26) THEN      #MOD-A70003
         LET g_apb[l_ac].apb26 = g_apa.apa22
         DISPLAY g_apb[l_ac].apb26 TO s_apb[l_ac].apb26
      END IF 
   END IF
  #end CHI-990015 add

END FUNCTION

FUNCTION t110_unit(p_unit)  #單位
   DEFINE p_unit    LIKE gfe_file.gfe01,
          l_gfeacti LIKE gfe_file.gfeacti

   LET g_errno = ' '
   SELECT gfeacti INTO l_gfeacti
     FROM gfe_file WHERE gfe01 = p_unit

   CASE
      WHEN SQLCA.SQLCODE = 100
         LET g_errno = 'mfg2605'
         LET l_gfeacti = NULL
      WHEN l_gfeacti='N'
         LET g_errno = '9028'
      OTHERWISE
         LET g_errno = SQLCA.SQLCODE USING '-------'
   END CASE

END FUNCTION

FUNCTION t110_diff()
#FUN-590124
   DEFINE l_aag02     LIKE aag_file.aag02,
#  DEFINE l_aag02     VARCHAR(30),
#FUN-590124 End
          l_cnt       LIKE type_file.num5    #No.FUN-690028 SMALLINT
#No.FUN-680027--begin
   DEFINE l_apa20     LIKE apa_file.apa20
   DEFINE l_apc16     LIKE apc_file.apc16
   DEFINE l_apc02     LIKE apc_file.apc02
#No.FUN-680027--end


   OPEN WINDOW t110_diff_w WITH FORM "aap/42f/aapt110_8"
      ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
   CALL cl_ui_locale("aapt110_8")

#No.FUN-680029--begin 
   IF g_aza.aza63 ='N' THEN
      CALL cl_set_comp_visible("apa531,aag021",FALSE)
   END IF
   SELECT aag02 INTO l_aag02 FROM aag_file WHERE aag01=g_apa.apa531
                                             AND aag00=g_bookno2     #No.FUN-730064
                                             AND aagacti = 'Y'       #No.MOD-B70280 add
   DISPLAY l_aag02 TO aag021
#No.FUN-680029--end

   SELECT aag02 INTO l_aag02 FROM aag_file WHERE aag01=g_apa.apa53
                                             AND aag00=g_bookno1    #No.FUN-730064
                                             AND aagacti = 'Y'      #No.MOD-B70280 add
   DISPLAY l_aag02 TO aag02

   CALL cl_set_act_visible("cancel", FALSE)  #MOD-490323
   CALL cl_set_head_visible("","YES")        #No.FUN-6B0033

   INPUT BY NAME g_apa.apa56,g_apa.apa53,g_apa.apa531 WITHOUT DEFAULTS    #No.FUN-680029

      AFTER FIELD apa56
         IF NOT cl_null(g_apa.apa56) THEN
            IF g_apa.apa56 = '3' AND g_apa.apa57f > g_apa.apa31f THEN
               CALL cl_err('apa57f>apa31f: ','aap-153',0)
               NEXT FIELD apa56
            END IF
            IF g_apa.apa56 NOT MATCHES "[0123456]" THEN  #No.TQC-7B0083   #No.TQC-860014 add 6
               NEXT FIELD apa56
            END IF
            IF g_apa.apa56 MATCHES "[01]" THEN
               EXIT INPUT
            END IF
            INITIALIZE g_aps.* TO NULL
            IF g_apa.apa53 IS NULL THEN
               IF g_apz.apz13 = 'Y' THEN
                  SELECT * INTO g_aps.* FROM aps_file WHERE aps01 = g_apa.apa22
               ELSE
                  SELECT * INTO g_aps.* FROM aps_file WHERE (aps01 = ' ' OR aps01 IS NULL)
               END IF
               IF g_apa.apa56 = '2' THEN
                  LET g_apa.apa53 = g_aps.aps44
                  DISPLAY BY NAME g_apa.apa53
               END IF
            END IF
#No.FUN-680029--begin
            IF g_apa.apa531 IS NULL AND g_aza.aza63 ='Y' THEN
               IF g_apz.apz13 = 'Y' THEN
                  SELECT * INTO g_aps.* FROM aps_file WHERE aps01 = g_apa.apa22
               ELSE
                  SELECT * INTO g_aps.* FROM aps_file WHERE (aps01 = ' ' OR aps01 IS NULL)
               END IF
               IF g_apa.apa56 = '2' THEN
                  LET g_apa.apa531 = g_aps.aps441
                  DISPLAY BY NAME g_apa.apa531
               END IF
            END IF
#No.FUN-680029--end
         END IF

      AFTER FIELD apa53
         IF g_apz.apz02 = 'Y' AND g_apa.apa56 = '2' THEN
            CALL s_aapact(g_apz.apz11,g_bookno1,g_apa.apa53) RETURNING g_msg    #No.FUN-730064
            IF NOT cl_null(g_errno) THEN
               CALL cl_err(g_apa.apa53,g_errno,0)
               NEXT FIELD apa53
            END IF
            DISPLAY g_msg TO l_aag02
         END IF
#No.FUN-680029--begin
      AFTER FIELD apa531
         IF g_apz.apz02 = 'Y' AND g_apa.apa56 = '2' THEN
            CALL s_aapact(g_apz.apz11,g_bookno2,g_apa.apa531) RETURNING g_msg    #No.FUN-730064
            IF NOT cl_null(g_errno) THEN
               CALL cl_err(g_apa.apa531,g_errno,0)
               NEXT FIELD apa531
            END IF
            DISPLAY g_msg TO aag021
         END IF
#No.FUN-680029--end  
 
      ON ACTION CONTROLP
         CASE
            WHEN INFIELD(apa53) # Account number
# hard code    CALL q_aag( FALSE, TRUE, 0,0,g_apa.apa53,'','','')
#                          RETURNING g_apa.apa53
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"   #TQC-790133
               LET g_qryparam.default1 = g_apa.apa53
               LET g_qryparam.arg1 = g_bookno1      #No.FUN-730064
               CALL cl_create_qry() RETURNING g_apa.apa53
#               CALL FGL_DIALOG_SETBUFFER( g_apa.apa53 )
               DISPLAY BY NAME g_apa.apa53
#No.FUN-680029--begin
            WHEN INFIELD(apa531) # Account number
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"   #TQC-790133
               LET g_qryparam.default1 = g_apa.apa531
               LET g_qryparam.arg1 = g_bookno2      #No.FUN-730064
               CALL cl_create_qry() RETURNING g_apa.apa531
               DISPLAY BY NAME g_apa.apa531
#No.FUN-680029--end
         END CASE

      AFTER INPUT
         IF g_apa.apa56 = '3' AND g_apa.apa57f > g_apa.apa31f THEN
            CALL cl_err('apa57f>apa31f: ','aap-153',0)
            LET g_apa.apa56 = '0'
         END IF
        #----------------------MOD-C70161-------------------(S)
         IF cl_null(g_apa.apa56) AND g_apa.apa33 <> 0 THEN
            LET g_apa.apa56 = '1'
         END IF
        #----------------------MOD-C70161-------------------(E)

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
   END INPUT

  #No.TQC-860014--begin-- mark
  #IF INT_FLAG THEN
  #   LET INT_FLAG = 0
  #END IF
  #No.TQC-860014---end--- mark

   CALL cl_set_act_visible("cancel", TRUE)  #MOD-490323

   CLOSE WINDOW t110_diff_w

   #No.TQC-860014--begin--
   IF INT_FLAG THEN 
      LET INT_FLAG = 0
      LET g_apa.apa56 = 1
   END IF
   #No.TQC-860014---end---

   DISPLAY BY NAME g_apa.apa56,g_apa.apa53
#No.FUN-680029--begin
   IF g_aza.aza63 ='Y' THEN
      DISPLAY BY NAME g_apa.apa531
   END IF
#No.FUN-680029--begin

   CALL t110_apa56()

   BEGIN WORK              #MOD-A70153  

   CASE WHEN g_apa.apa56 = '1' #留置
             LET g_apa.apa19 = g_apz.apz12
             LET g_apa.apa20 = g_apa.apa34f
             DISPLAY BY NAME g_apa.apa19,g_apa.apa20
#No.FUN-680027--begin
             DECLARE t110_apc_cs1 CURSOR FOR
             SELECT apc02,apc08-apc10 FROM apc_file WHERE apc01 =g_apa.apa01 ORDER BY apc02   #TQC-750129
            #SELECT apc02,apc16 FROM apc_file WHERE apc01 =g_apa.apa01 ORDER BY apc02         #TQC-750129


             #SELECT count(*) g_cnt FROM apc_file    #MOD-7A0049
             SELECT count(*) INTO g_cnt FROM apc_file    #MOD-7A0049
              WHERE apc01 = g_apa.apa01
             IF g_cnt >0 THEN
                LET l_apa20  =g_apa.apa20
                FOREACH t110_apc_cs1 INTO l_apc02,l_apc16
                  #TQC-750129 begin
                    #IF l_apc16 >=l_apa20 THEN
                    #   LET l_apc16 = l_apc16 - l_apa20
                    #   LET l_apa20 = 0
                    #ELSE 
                    #   LET l_apa20 = l_apa20 - l_apc16
                    #   LET l_apc16 = 0
                    #END IF
                    IF l_apc16 >=l_apa20 THEN
                       LET l_apc16 = l_apa20
                       LET l_apa20 = 0
                    ELSE
                       LET l_apa20 = l_apa20 - l_apc16
                       LET l_apc16 = l_apc16
                    END IF
                   #TQC-750129 end
                    UPDATE apc_file set apc16 =l_apc16
                     WHERE apc01 = g_apa.apa01
                       AND apc02 = l_apc02
                    IF l_apa20 =0 THEN
                       EXIT FOREACH
                    END IF
                END FOREACH
             END IF
#No.FUN-680027--end
             CALL t110_apa19('d')
        WHEN g_apa.apa56 = '2' #價差
             LET g_apa.apa33f= g_apa.apa31f- g_apa.apa57f
             CALL t110_apa34f('0')  #TQC-750140 add 參數0
             CALL t110_unpay()
              #-----No:MOD-530439-----
             LET g_apa.apa19 = ''
             LET g_apa.apa20 = 0
             UPDATE apc_file set apc16 = g_apa.apa20 WHERE apc01 = g_apa.apa01         #MOD-A30084 add
             DISPLAY g_apa.apa19,g_apa.apa20,'' TO apa19,apa20,apo02
              #-----No:MOD-530439 END-----
        WHEN g_apa.apa56 = '3' #折讓扣除帳款
             LET g_apa.apa33f= g_apa.apa31f- g_apa.apa57f
             LET g_apa.apa33 = g_apa.apa31 - g_apa.apa57
             CALL t110_j()
             CALL t110_apa34f('0')      #TQC-750140
             CALL t110_unpay()
              #-----No:MOD-530439-----
             LET g_apa.apa19 = ''
             LET g_apa.apa20 = 0
             UPDATE apc_file set apc16 = g_apa.apa20 WHERE apc01 = g_apa.apa01         #MOD-A30084 add
             DISPLAY g_apa.apa19,g_apa.apa20,'' TO apa19,apa20,apo02
              #-----No:MOD-530439 END-----
        WHEN g_apa.apa56 = '4' #單價分攤
             CALL t110_share()
             LET g_apa.apa33f= g_apa.apa31f- g_apa.apa57f
             LET g_apa.apa33 = g_apa.apa31 - g_apa.apa57
             CALL t110_apa34f('0')   #TQC-750140
             CALL t110_unpay()
              #-----No:MOD-530439-----
             LET g_apa.apa19 = ''
             LET g_apa.apa20 = 0
             UPDATE apc_file set apc16 = g_apa.apa20 WHERE apc01 = g_apa.apa01         #MOD-A30084 add
             DISPLAY g_apa.apa19,g_apa.apa20,'' TO apa19,apa20,apo02
              #-----No:MOD-530439 END-----
        #No.TQC-7B0083  --Begin
        WHEN g_apa.apa56 = '5' #處理暫估開帳
             LET g_apa.apa33 = 0
             LET g_apa.apa33f= 0
        #No.TQC-7B0083  --End  
        #No.TQC-860014--begin--
        WHEN g_apa.apa56 = '6'
             CALL  t110_share2()
             IF INT_FLAG THEN 
                LET INT_FLAG = 0
                LET g_apa.apa56 = 0
                RETURN 
             END IF 
             LET g_apa.apa33f= g_apa.apa31f- g_apa.apa57f
             LET g_apa.apa33 = g_apa.apa31 - g_apa.apa57
             CALL t110_apa34f('0')   
             CALL t110_unpay()
             LET g_apa.apa19 = ''
             LET g_apa.apa20 = 0
             UPDATE apc_file set apc16 = g_apa.apa20 WHERE apc01 = g_apa.apa01         #MOD-A30084 add
             DISPLAY g_apa.apa19,g_apa.apa20,'' TO apa19,apa20,apo02
        #No.TQC-860014---end---
   END CASE
 #MOD-560240
   SELECT COUNT(*) INTO l_cnt FROM apb_file
    WHERE apb01=g_apa.apa01
   IF l_cnt = 0 THEN
      IF g_aptype !='11' THEN   #MOD-890177 add
         LET g_apa.apa57 = g_apa.apa31
         LET g_apa.apa57f = g_apa.apa31f
         DISPLAY BY NAME g_apa.apa57
      END IF                    #MOD-890177 add
   END IF
 #END MOD-560240

   IF g_apa.apa56 != '3' THEN
      UPDATE apb_file SET apb15 = 0,
                          apb13f = 0,
                          apb13 = 0,
                          apb14f = 0,
                          apb14 = 0
       WHERE apb01=g_apa.apa01

      LET g_apa.apa60f= 0
      LET g_apa.apa61f= 0
      LET g_apa.apa60 = 0
      LET g_apa.apa61 = 0
      DISPLAY BY NAME g_apa.apa60f,g_apa.apa60,g_apa.apa61f,g_apa.apa61
   ELSE
      ##No.2784 modify 1998/11/10 針對實際 Hold 金額與差異 才取消 Hold
      IF g_apa.apa60 = g_apa.apa33 AND g_apa.apa20 = g_apa.apa60 THEN
         LET g_apa.apa19 = NULL
         LET g_apa.apa20 = 0

         UPDATE apa_file SET apa19 = g_apa.apa19,
                             apa20 = g_apa.apa20
          WHERE apa01=g_apa.apa01

         DISPLAY BY NAME g_apa.apa19,g_apa.apa20
         DISPLAY '' TO apo02
      END IF
   END IF
 
   COMMIT WORK             #MOD-A70153 

   ##-----No:MOD-530439-----
  #IF cl_null(g_apa.apa19) THEN
  #   LET g_apa.apa56 = '0'
  #   UPDATE apa_file SET apa56 = g_apa.apa56
  #    WHERE apa01 = g_apa.apa01
  #   DISPLAY BY NAME g_apa.apa56
  #   CALL t110_apa56()
  #END IF
   ##-----No:MOD-530439 END-----
 
END FUNCTION

FUNCTION t110_share()
   DEFINE l_amt,l_amt2               LIKE type_file.num20_6     # No:FUN-690028  DEC(20,6)  #FUN-4B0079
   DEFINE l_amtf,l_amt2f,lamt,lamt1  LIKE type_file.num20_6     # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_diffamt                   LIKE type_file.num20_6     #MOD-B70119
   DEFINE apb       RECORD LIKE apb_file.*
   DEFINE l_apb10          LIKE apb_file.apb10
   DEFINE l_apb24          LIKE apb_file.apb24
   DEFINE l_chkamt         LIKE apb_file.apb10     #MOD-B70119
   DEFINE l_apb02          LIKE apb_file.apb02
   DEFINE l_sql            STRING  #No.TQC-7B0083
   DEFINE sum_apb10        LIKE apb_file.apb10     #No.MOD-930072
   DEFINE sum_apb24        LIKE apb_file.apb24     #No.MOD-930072
   DEFINE l_cnt            LIKE apb_file.apb02     #MOD-B70119
   DEFINE l_diff           LIKE type_file.num5     #MOD-B70119
   DEFINE l_chkdiff        LIKE type_file.num5     #MOD-B70119

   LET l_apb02 = 0
   LET l_apb10 = 0
#No.MOD-930072 Begin--------------
#  #No.TQC-7B0083  --Begin
#  IF cl_confirm("aap-825") THEN
#     LET l_sql = "SELECT * FROM apb_file WHERE apb01='",g_apa.apa01,"'",
#                 " ORDER BY apb02"
#  ELSE
#     LET l_sql = "SELECT * FROM apb_file WHERE apb01='",g_apa.apa01,"'",
#                 "   AND (apb34='N' OR apb34 IS NULL) ",
#                 " ORDER BY apb02"
#  END IF
#  PREPARE t110_share_cs_1 FROM l_sql
#  DECLARE t110_share_c CURSOR FOR t110_share_cs_1 
#  ##衝暫估單身資料不可分攤
#  #DECLARE t110_share_c CURSOR FOR
#  #  SELECT * FROM apb_file WHERE apb01=g_apa.apa01
#  #                           AND (apb34='N' OR apb34 IS NULL)  #No.TQC-7B0083
#  #   ORDER BY apb02
#  #No.TQC-7B0083  --End   
   DECLARE t110_share_c CURSOR FOR
    SELECT * FROM apb_file
     WHERE apb01=g_apa.apa01
       AND (apb34='N' OR apb34 IS NULL)
     ORDER BY apb02

   SELECT sum(apb10),sum(apb24) INTO sum_apb10,sum_apb24
     FROM apb_file
    WHERE apb01=g_apa.apa01
      AND (apb34='N' OR apb34 IS NULL)
#No.MOD-930072 End------------------

   FOREACH t110_share_c INTO apb.*
   #  LET apb.apb10 = g_apa.apa31 * apb.apb10/g_apa.apa57                     #No.MOD-930072
      LET apb.apb10 = apb.apb10+(g_apa.apa31-g_apa.apa57)*apb.apb10/sum_apb10 #No.MOD-930072
      #LET apb.apb10 = cl_digcut(apb.apb10,t_azi.azi04)   #MOD-6B0066
      LET apb.apb10 = cl_digcut(apb.apb10,g_azi04)   #MOD-6B0066
   #  LET apb.apb24 = g_apa.apa31f* apb.apb24/g_apa.apa57f                      #No.MOD-930072
      LET apb.apb24 = apb.apb24+(g_apa.apa31f-g_apa.apa57f)*apb.apb24/sum_apb24 #No.MOD-930072
      #LET apb.apb24 = cl_digcut(apb.apb24,g_azi.azi04)   #MOD-6B0066
      LET apb.apb24 = cl_digcut(apb.apb24,t_azi04)   #MOD-6B0066
      LET apb.apb08 = apb.apb10/apb.apb09
      LET apb.apb23 = apb.apb24/apb.apb09
      #LET apb.apb08 = cl_digcut(apb.apb08,t_azi.azi03)   #MOD-6B0066
      #LET apb.apb23 = cl_digcut(apb.apb23,g_azi.azi03)   #MOD-6B0066
      LET apb.apb08 = cl_digcut(apb.apb08,g_azi03)   #MOD-6B0066
      LET apb.apb23 = cl_digcut(apb.apb23,t_azi03)   #MOD-6B0066

      IF l_apb10 < apb.apb10 THEN
         LET l_apb02 = apb.apb02
         LET l_apb10 = apb.apb10
      END IF

      LET apb.apb081 = apb.apb08
      LET apb.apb101 = apb.apb10

      UPDATE apb_file SET apb08  = apb.apb08,
                          apb081 = apb.apb081,
                          apb10  = apb.apb10,
                          apb101 = apb.apb101,
                          apb23  = apb.apb23,
                          apb24  = apb.apb24
       WHERE apb01=apb.apb01 AND apb02=apb.apb02

   END FOREACH

   SELECT SUM(apb10),SUM(apb24) INTO l_amt,l_amtf FROM apb_file
    WHERE apb01 = g_apa.apa01 AND apb29='1'

   IF l_amt IS NULL THEN
      LET l_amt = 0
   END IF

   IF l_amtf IS NULL THEN
      LET l_amtf = 0
   END IF

   SELECT SUM(apb10),SUM(apb24) INTO l_amt2,l_amt2f FROM apb_file
    WHERE apb01 = g_apa.apa01 AND apb29='3'

   IF l_amt2 IS NULL THEN
      LET l_amt2 = 0
   END IF

   IF l_amt2f IS NULL THEN
      LET l_amt2f = 0
   END IF

   IF g_aptype MATCHES '1*' THEN
      #LET g_apa.apa57f= l_amtf- l_amt2f   #MOD-780281
      #LET g_apa.apa57 = l_amt - l_amt2    #MOD-780281
      LET g_apa.apa57f= l_amtf+ l_amt2f   #MOD-780281
      LET g_apa.apa57 = l_amt + l_amt2    #MOD-780281
   ELSE
      LET g_apa.apa57f= l_amt2f- l_amtf
      LET g_apa.apa57 = l_amt2 - l_amt
   END IF

   IF g_apa.apa57 IS NULL THEN
      LET g_apa.apa57=0
   END IF

   LET g_apa.apa57f=cl_digcut(g_apa.apa57f,t_azi04)   #MOD-6B0066
   LET g_apa.apa57=cl_digcut(g_apa.apa57,g_azi04)   #MOD-6B0066

   DISPLAY BY NAME g_apa.apa57

   UPDATE apa_file SET apa57=g_apa.apa57 WHERE apa01=g_apa.apa01

   IF g_apa.apa57 != g_apa.apa31 OR g_apa.apa57f != g_apa.apa31f THEN
      LET lamt = g_apa.apa57 - g_apa.apa31
      LET lamt1= g_apa.apa57f- g_apa.apa31f
      IF lamt != 0 THEN
         LET lamt = lamt * -1

        #-MOD-B70119-mark-
        #UPDATE apb_file SET apb10 = apb10+lamt,
        #                    apb101 = apb101+lamt
        # WHERE apb01=g_apa.apa01 AND apb02=l_apb02
        #-MOD-B70119-add-
         LET l_chkamt = 0
         CALL s_abs(lamt) RETURNING l_diffamt
         #抓取金額最大筆的項次
         SELECT MIN(apb02) INTO l_apb02
           FROM apb_file
          WHERE apb01 = g_apa.apa01 
            AND apb10 = (SELECT MAX(apb10) FROM apb_file WHERE apb01 = g_apa.apa01) 
         SELECT apb10 INTO l_chkamt
           FROM apb_file 
          WHERE apb01 = g_apa.apa01 AND apb02 = l_apb02 
         IF cl_null(l_chkamt) THEN LET l_chkamt = 0 END IF 
         IF l_chkamt > l_diffamt THEN
        #調整至金額最大筆
            UPDATE apb_file SET apb10 = apb10+lamt,
                                apb101 = apb101+lamt
             WHERE apb01=g_apa.apa01 AND apb02=l_apb02
         END IF   
         IF l_chkamt < l_diffamt THEN
           #逐筆分攤1至每筆單身
            LET l_cnt = 0 
            LET l_chkdiff = 0
            IF lamt > 0 THEN LET l_diff = 1 END IF
            IF lamt < 0 THEN LET l_diff = -1 END IF
            DECLARE t110_share_c2 CURSOR FOR
             SELECT apb02 FROM apb_file
              WHERE apb01=g_apa.apa01
                AND (apb34='N' OR apb34 IS NULL) 
              ORDER BY apb02
            FOREACH t110_share_c2 INTO apb.apb02
               LET l_cnt = l_cnt + 1
               IF l_diffamt < l_cnt THEN
                  IF lamt > 0 THEN LET l_diff = l_cnt - l_diffamt END IF
                  IF lamt < 0 THEN LET l_diff = l_diffamt - l_cnt END IF
               END IF 
               UPDATE apb_file SET apb10 = apb10+l_diff,
                                   apb101 = apb101+l_diff
                WHERE apb01=g_apa.apa01 AND apb02=apb.apb02
               CALL s_abs(l_diff) RETURNING l_chkdiff
               IF l_cnt - l_diffamt = 0 OR l_chkdiff <> 1 THEN
                  EXIT FOREACH
               END IF
            END FOREACH
         END IF   
        #-MOD-B70119-end-
    
         UPDATE apa_file SET apa57=g_apa.apa31 WHERE apa01=g_apa.apa01

         LET g_apa.apa57 = g_apa.apa31
      END IF

      IF lamt1 != 0 THEN
         LET lamt1 = lamt1 * -1

        #-MOD-B70119-mark-
        #UPDATE apb_file SET apb24=apb24+lamt1
        # WHERE apb01=g_apa.apa01 AND apb02=l_apb02
        #-MOD-B70119-add-
         LET l_chkamt = 0
         CALL s_abs(lamt1) RETURNING l_diffamt
         SELECT apb24 INTO l_chkamt
           FROM apb_file 
          WHERE apb01 = g_apa.apa01 AND apb02 = l_apb02 
         IF cl_null(l_chkamt) THEN LET l_chkamt = 0 END IF 
         IF l_chkamt > l_diffamt THEN
        #調整至金額最大筆
            UPDATE apb_file SET apb24 = apb24+lamt1
             WHERE apb01=g_apa.apa01 AND apb02=l_apb02
         END IF   
         IF l_chkamt < l_diffamt THEN
           #逐筆分攤1至每筆單身
            LET l_cnt = 0
            LET l_chkdiff = 0
            IF lamt1 > 0 THEN LET l_diff = 1 END IF
            IF lamt1 < 0 THEN LET l_diff = -1 END IF
            DECLARE t110_share_c3 CURSOR FOR
             SELECT apb02 FROM apb_file
              WHERE apb01=g_apa.apa01
                AND (apb34='N' OR apb34 IS NULL)
              ORDER BY apb02
            FOREACH t110_share_c3 INTO apb.apb02
               LET l_cnt = l_cnt + 1
               IF l_diffamt < l_cnt THEN
                  IF lamt > 0 THEN LET l_diff = l_cnt - l_diffamt END IF
                  IF lamt < 0 THEN LET l_diff = l_diffamt - l_cnt END IF
               END IF 
               UPDATE apb_file SET apb24 = apb24+l_diff
                WHERE apb01=g_apa.apa01 AND apb02=apb.apb02
               CALL s_abs(l_diff) RETURNING l_chkdiff
               IF l_cnt - l_diffamt = 0 OR l_chkdiff <> 1 THEN
                  EXIT FOREACH
               END IF
            END FOREACH
         END IF   
        #-MOD-B70119-end-

         UPDATE apa_file SET apa57f=g_apa.apa31f WHERE apa01=g_apa.apa01

         LET g_apa.apa57f=g_apa.apa31f
      END IF
   END IF

   DISPLAY BY NAME g_apa.apa57

   IF g_apb_sarrno > 0 THEN
      CALL t110_b_fill(' 1=1')
   END IF

END FUNCTION

FUNCTION t110_apb21()
   DEFINE l_cnt LIKE type_file.num5    #No.FUN-690028 SMALLINT

   LET l_cnt=0
   LET g_errno=''

  #FUN-810045 begin
   #SELECT COUNT(*) INTO l_cnt  FROM pjd_file
   # WHERE pjd01=g_apa.apa66 AND pjd03=g_apb[l_ac].apb21
   #SELECT COUNT(*) INTO l_cnt  FROM pjd_file
   # WHERE pjd01=g_apb[l_ac].apb35 AND pjd02=g_apb[l_ac].apb31
   SELECT COUNT(*) INTO l_cnt  FROM azf_file
    WHERE azf01=g_apb[l_ac].apb31 AND azf02='2' AND azfacti='Y'
  #FUN-810045 end

   CASE
      WHEN l_cnt=0
         LET g_errno = 'aap-301'
      WHEN SQLCA.SQLCODE != 0
         LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE
END FUNCTION

#FUN-630055 --start --
FUNCTION t110_apb31()
   DEFINE l_cnt LIKE type_file.num5    #No.FUN-690028 SMALLINT
#  DEFINE l_ima920  LIKE ima_file.ima920  #FUN-810045 #No.FUN-950056

   LET l_cnt=0
   LET g_errno=''
 
#CHI-AA0028 mark --start--
#  #FUN-810045 begin
#   IF cl_null(g_apb[l_ac].apb31) THEN
##No.FUN-950056 --Begin
##    SELECT ima920 INTO l_ima920
##      FROM ima_file
##     WHERE ima01 = g_apb[l_ac].apb12
##    IF l_ima920 = 'Y' THEN
##       LET g_errno = 'apj-200'
##       RETURN
##    END IF
##No.FUN-950056 --End
#     IF g_apy.apydmy5 = 'Y' THEN
#       LET g_errno = 'apj-201'
#       RETURN
#     END IF
#   END IF
#  #FUN-810045 end
#CHI-AA0028 mark --end--

  IF cl_null(g_apb[l_ac].apb31) THEN RETURN END IF  #No.MOD-840611
  #FUN-810045 begin
   #SELECT COUNT(*) INTO l_cnt  FROM pjd_file
   # WHERE pjd01=g_apa.apa66 AND pjd03=g_apb[l_ac].apb31
   #SELECT COUNT(*) INTO l_cnt FROM pjd_file
   # WHERE pjd01=g_apb[l_ac].apb35 AND pjd02=g_apb[l_ac].apb31
   SELECT COUNT(*) INTO l_cnt  FROM azf_file
    WHERE azf01=g_apb[l_ac].apb31 AND azf02='2' AND azfacti='Y'
  #FUN-810045 end

   CASE
      WHEN l_cnt=0
#MOD-840449--begin
         IF g_aza.aza08 = 'Y' THEN
            LET g_errno = 'aap-301'
         ELSE
            LET g_errno = 'mfg5108'
         END IF
#MOD-840449--end
      WHEN SQLCA.SQLCODE != 0
         LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE

 #FUN-810045
  IF cl_null(g_errno) THEN
     IF cl_null(g_apb[l_ac].apb25) THEN
        SELECT azf14 INTO g_apb[l_ac].apb25
          FROM azf_file
        WHERE azf01=g_apb[l_ac].apb31 AND azf02='2' AND azfacti='Y'
     END IF
     IF g_aza.aza63='Y' AND cl_null(g_apb[l_ac].apb251) THEN
       LET g_apb[l_ac].apb251 = g_apb[l_ac].apb25
     END IF
     DISPLAY BY NAME g_apb[l_ac].apb25,g_apb[l_ac].apb251
  END IF
 #FUN-810045

END FUNCTION
#FUN-630055 --end--

FUNCTION t110_apb22_11(p_cmd)
   DEFINE p_cmd           LIKE type_file.chr1   #No.FUN-690028 VARCHAR(1)
   DEFINE l_rvv03         LIKE rvv_file.rvv03
   DEFINE l_rvv04         LIKE rvv_file.rvv04
   DEFINE l_rvv05         LIKE rvv_file.rvv05
   DEFINE l_rvv09         LIKE type_file.dat    #No:FUN-690028 DATE
   DEFINE l_vendor        LIKE rvv_file.rvv06   #FUN-660117
   DEFINE l_rvv36         LIKE rvv_file.rvv36
   DEFINE l_rvv37         LIKE rvv_file.rvv37
   DEFINE l_rvv23         LIKE rvv_file.rvv23
   DEFINE l_rvv25         LIKE rvv_file.rvv25
   DEFINE l_rvv17         LIKE rvv_file.rvv17   #FUN-560070
   DEFINE l_rvv87         LIKE rvv_file.rvv87   #FUN-560070
   DEFINE l_pmm02         LIKE pmm_file.pmm02
   DEFINE l_pmn122        LIKE pmn_file.pmn122
   DEFINE l_pmm20         LIKE pmm_file.pmm20
   DEFINE l_pmm21         LIKE pmm_file.pmm21
   DEFINE l_pmm22         LIKE pmm_file.pmm22
   DEFINE l_pmn041        LIKE pmn_file.pmn041
   DEFINE l_pmn07         LIKE pmn_file.pmn07
   DEFINE l_pmn86         LIKE pmn_file.pmn86   #FUN-560070
   DEFINE l_pmn40         LIKE pmn_file.pmn40
   DEFINE l_pmn67         LIKE pmn_file.pmn67
   DEFINE l_rvv31         LIKE rvv_file.rvv31   #NO:MOD-490217
   DEFINE l_rvv38         LIKE rvv_file.rvv38
   DEFINE l_rvv38t        LIKE rvv_file.rvv38t  #TQC-8A0079 add
   DEFINE l_rvv930        LIKE rvv_file.rvv930  #FUN-670064
   DEFINE l_aag02         LIKE aag_file.aag02   #No.TQC-770056
   DEFINE l_gem02         LIKE gem_file.gem02   #No.TQC-770056
   DEFINE l_rvv88         LIKE rvv_file.rvv88   #No.TQC-7B0083
   DEFINE l_gec04         LIKE gec_file.gec04   #TQC-8A0079 add
   DEFINE l_gec05         LIKE gec_file.gec05   #MOD-A80052
   DEFINE l_gec07         LIKE gec_file.gec07   #TQC-8A0079 add
   DEFINE t_gec04         LIKE gec_file.gec04   #MOD-8C0020 add 
   DEFINE l_apb24t        LIKE apb_file.apb24   #MOD-920013 add   
   DEFINE l_apa32f        LIKE apa_file.apa32f  #MOD-A80052   
   DEFINE l_cnt           LIKE type_file.num5   #MOD-950158 
   DEFINE l_pmk13         LIKE pmk_file.pmk13   #FUN-930165 add 
      
   LET g_errno = ' '

  #str FUN-7A0050 add
  #aapt160單身"入庫單號"(apb21),"入庫項次"(apb22)可不輸入
   IF g_aptype='16' AND 
      cl_null(g_apb[l_ac].apb21) AND cl_null(g_apb[l_ac].apb22) THEN 
      RETURN 
   END IF
  #end FUN-7A0050 add
  
#MOD-950158 --begin                                        
   LET l_cnt = 0   
   LET g_chr_1 = 'Y'                                                                                                      
   SELECT COUNT(*) INTO l_cnt FROM apb_file,apa_file                                                                     
    WHERE apb21 = g_apb[l_ac].apb21                                                                                            
      AND apb22 = g_apb[l_ac].apb22                                                                                            
      AND apa01 = apb01                                                                                                  
      AND (apa00 = '16' OR apa00 = '26')
      AND apa41 !='Y'                                                                                
      AND apa42 = 'N'                                                                
   IF l_cnt > 0 THEN   
      LET g_chr_1 = 'N'                                                                                                            
      CALL s_errmsg('','','','aap-118',1)                                                                
      RETURN                                                                                   
   END IF                                                                                        
#MOD-950158 --end
#----------------------------------------MOD-B90164--------------------------------start
   IF g_aptype='11' THEN
      LET l_cnt = 0
      IF g_aza.aza26 = '2' THEN
         SELECT COUNT(*) INTO l_cnt
           FROM rvw_file
          WHERE rvw08 = g_apb[l_ac].apb21 AND rvw09 = g_apb[l_ac].apb22
      ELSE
         SELECT COUNT(*) INTO l_cnt
           FROM rvv_file,rvb_file
          WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
            AND rvv04 = rvb01             AND rvv05 = rvb02
            AND rvb22 IS NOT NULL         AND rvb22 != ' '
      END IF
      IF l_cnt = 0 THEN
         CALL s_errmsg('','','','axr-167',1)
         LET g_errno = 'axr-167'
         RETURN
      END IF
   END IF
#----------------------------------------MOD-B90164-------------------------------end
  #str MOD-970061 add
   #若入庫單對應的收貨單已有發票不可再產生暫估單
   IF g_aptype='16' THEN
      LET l_cnt = 0
      IF g_aza.aza26 = '2' THEN
         SELECT COUNT(*) INTO l_cnt
           FROM rvw_file
          WHERE rvw08 = g_apb[l_ac].apb21 AND rvw09 = g_apb[l_ac].apb22
      ELSE
         SELECT COUNT(*) INTO l_cnt
           FROM rvv_file,rvb_file
          WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
            AND rvv04 = rvb01             AND rvv05 = rvb02
            AND rvb22 IS NOT NULL         AND rvb22 != ' '
      END IF
      IF l_cnt > 0 THEN
         CALL s_errmsg('','','','aap-152',1)
         LET g_errno = 'aap-152'
         RETURN
      END IF
   END IF
  #end MOD-970061 add

#No.TQC-7B0109 --start--
#  #SELECT rvv03,rvv04,rvv05,rvv09,rvv06,rvv36,rvv37,rvv23,rvv17,pmm20,pmm21,   #FUN-560070
#  SELECT rvv03,rvv04,rvv05,rvv09,rvv06,rvv36,rvv37,rvv23,rvv87,pmm20,pmm21,   #FUN-560070
#         #pmm22,rvv38,pmm02,rvv31,pmn041,pmn07,pmn40,rvv25,pmn122,pmn67   #FUN-560070
#         pmm22,rvv38,pmm02,rvv31,pmn041,pmn86,pmn40,rvv25,pmn122,pmn67,  #FUN-560070
#         rvv930  #FUN-670064
#    INTO l_rvv03,l_rvv04,l_rvv05,l_rvv09,l_vendor,l_rvv36,l_rvv37,l_rvv23,
#         #l_rvv17,l_pmm20,l_pmm21,l_pmm22,l_rvv38,l_pmm02,l_rvv31,   #FUN-560070
#         l_rvv87,l_pmm20,l_pmm21,l_pmm22,l_rvv38,l_pmm02,l_rvv31,   #FUN-560070
#         #l_pmn041,l_pmn07,l_pmn40,l_rvv25,l_pmn122,l_pmn67   #FUN-560070
#         l_pmn041,l_pmn86,l_pmn40,l_rvv25,l_pmn122,l_pmn67,  #FUN-560070
#         l_rvv930
#    FROM rvu_file,rvv_file,rvb_file,pmm_file,pmn_file
#   WHERE rvv01 = g_apb[l_ac].apb21
#     AND rvv02 = g_apb[l_ac].apb22
#     AND rvv04 = rvb01
#     AND rvv05 = rvb02
#     AND rvu01=rvv01
#     AND rvv36 = pmm01
#     AND rvuconf='Y'
#     AND rvv36 = pmn01
#     AND rvv37 = pmn02
#     AND (pmm25 = '2' OR pmm25 = '6')
   SELECT rvv03,rvv04,rvv05,rvv09,rvv06,rvv36,rvv37,rvv23,
          rvv87,rvv38,rvv38t,rvv31,   #TQC-8A0079 add rvv38t
          rvv25,rvv930,rvv88          #No.TQC-7B0083
     INTO l_rvv03,l_rvv04,l_rvv05,l_rvv09,l_vendor,l_rvv36,l_rvv37,l_rvv23,
          l_rvv87,l_rvv38,l_rvv38t,           #TQC-8A0079 add l_rvv38t
          l_rvv31,l_rvv25,l_rvv930,l_rvv88    #No.TQC-7B0083   
     FROM rvv_file,rvu_file
    WHERE rvv01 = g_apb[l_ac].apb21
      AND rvv02 = g_apb[l_ac].apb22
      AND rvu01 = rvv01
      AND rvuconf = 'Y'
   IF NOT cl_null(l_rvv04) AND NOT cl_null(l_rvv05) THEN
      SELECT pmm20,pmm21,pmm22,pmm02,pmn041,pmn86,pmn40,pmn122,pmn67
        INTO l_pmm20,l_pmm21,l_pmm22,l_pmm02,l_pmn041,l_pmn86,l_pmn40,
             l_pmn122,l_pmn67
        FROM pmm_file,pmn_file,rvb_file
       WHERE rvb01 = l_rvv04
         AND rvb02 = l_rvv05
         AND rvb04 = pmn01
         AND rvb03 = pmn02
         AND pmm01 = pmn01
         AND (pmm25 = '2' OR pmm25 = '6')
   ELSE
      LET l_pmm20 = g_apa.apa11
      LET l_pmm21 = g_apa.apa15
      LET l_pmm22 = g_apa.apa13
      LET l_pmm02 = NULL
      LET l_pmn122 = NULL
      LET l_pmn67 = NULL
      SELECT ima02,ima39 INTO l_pmn041,l_pmn40 FROM ima_file
       WHERE ima01 = l_rvv31
      SELECT rvv86 INTO l_pmn86 FROM rvv_file
       WHERE rvv01 = g_apb[l_ac].apb21
         AND rvv02 = g_apb[l_ac].apb22
   END IF
#No.TQC-7B0109 --end--

   IF l_pmn122 !=g_apa.apa66 THEN
      LET g_errno='aap-300'
      RETURN
   END IF

   IF l_rvv03 = '2' THEN
      LET g_errno='aap-093'
      RETURN
   END IF

   IF l_rvv03 = '3' THEN
      CALL t110_apb22_21(p_cmd)
      RETURN
   END IF

   IF g_qty1 IS NULL THEN
      LET g_qty1 = 0
   END IF

   IF l_rvv38 IS NULL THEN
      LET l_rvv38 = 0
   END IF

  #str TQC-8A0079 add
   IF l_rvv38t IS NULL THEN
      LET l_rvv38t = 0
   END IF
  #end TQC-8A0079 add

   IF l_rvv23 IS NULL THEN
      LET l_rvv23 = 0
   END IF
#FUN-560070
#   IF l_rvv17 IS NULL THEN
#      LET l_rvv17 = 0
#   END IF
   IF l_rvv87 IS NULL THEN
      LET l_rvv87 = 0
   END IF
   #No.TQC-7B0083  --Begin
   IF l_rvv88 IS NULL THEN
      LET l_rvv88 = 0 
   END IF
   #No.TQC-7B0083  --End  
#No.MOD-910086 --begin
   IF l_rvv03 = '3' AND l_rvv17 = 0 THEN   #No:MOD-910062
   ELSE
     #IF l_rvv87-l_rvv23-l_rvv88 <=0 THEN  #MOD-920252 mark
      IF l_rvv87-l_rvv23 <=0 THEN          #MOD-920252
         LET g_errno='aap-782'
         RETURN
      END IF
   END IF
#No.MOD-910086 --end
#END FUN-560070
   CASE WHEN SQLCA.SQLCODE = 100  LET g_errno = 'aap-091'
        WHEN l_vendor != g_apa.apa05 LET g_errno = 'aap-040'
        WHEN YEAR(l_rvv09)  != YEAR(g_apa.apa02)  OR
             (YEAR(l_rvv09)   = YEAR(g_apa.apa02)  AND
             MONTH(l_rvv09) != MONTH(g_apa.apa02) )
             LET g_errno = 'aap-316'
        WHEN l_rvv09  > g_apa.apa02 LET g_errno = 'aap-317'
        OTHERWISE          LET g_errno = SQLCA.SQLCODE USING '-------'
   END CASE

   #No.TQC-7B0083  --Begin
   #衝暫估可以跨月
   IF g_errno = 'aap-316' THEN
      IF t110_set_rvv34(g_apb[l_ac].apb21,g_apb[l_ac].apb22) = 'Y' THEN
         LET g_errno = ''
      END IF
   END IF
   #重要信息:衝暫估前,一定要check部分請款,部分暫估現象時,請款已經做過了
   IF g_aptype='11' THEN
      IF l_rvv87 - l_rvv23 > 0 THEN                #部分請款或有做過暫估
         IF l_rvv88 > 0 THEN                       #有暫估資料沒有衝
            IF l_rvv87 - l_rvv23 <> l_rvv88 THEN   #部分請款
               LET g_errno = 'aap-817'
            END IF
         END IF
      END IF
   END IF
   #No.TQC-7B0083  --End  

  #str MOD-850251 add
  #表示此入庫單+項次已有立過暫估,不可再輸入
   IF g_aptype = '16' AND l_rvv87-l_rvv88 <= 0 THEN
      LET g_errno = 'aap-813'
   END IF
  #end MOD-850251 add

   IF NOT cl_null(g_errno) THEN
      RETURN
   END IF

   IF g_apa.apa11 IS NULL THEN
      LET g_apa.apa11 = l_pmm20
   END IF

   IF g_apa.apa13 IS NULL THEN
      LET g_apa.apa13 = l_pmm22
   END IF

   IF g_apa.apa15 IS NULL THEN
      LET g_apa.apa15 = l_pmm21
   END IF

   IF l_pmm20 != g_apa.apa11 THEN                              # 付款條件不符
      CALL cl_getmsg('aap-042',g_lang) RETURNING g_msg
      LET g_buf1=g_msg[1,8],':',l_pmm20 ERROR g_buf1   #FUN-C80078 g_buf-->g_buf1
      WHILE TRUE
            LET INT_FLAG = 0  ######add for prompt bug
         PROMPT g_msg CLIPPED FOR g_chr
            ON IDLE g_idle_seconds  #TQC-860021
               CALL cl_on_idle()    #TQC-860021

            ON ACTION about         #TQC-860021
               CALL cl_about()      #TQC-860021

            ON ACTION help          #TQC-860021
               CALL cl_show_help()  #TQC-860021

            ON ACTION controlg      #TQC-860021
               CALL cl_cmdask()     #TQC-860021
         END PROMPT                 #TQC-860021

         CASE
            WHEN g_chr = '1'
               LET g_errno = 'aap-042'
               RETURN
            WHEN g_chr = '2'
               LET g_apa.apa11 = l_pmm20
               DISPLAY BY NAME g_apa.apa11
               UPDATE apa_file SET apa11 = g_apa.apa11
                WHERE apa01 = g_apa.apa01
         END CASE

         IF g_chr MATCHES "[123]" THEN
            EXIT WHILE
         END IF
      END WHILE
   END IF

   IF l_pmm22 != g_apa.apa13 THEN                              # 幣別不符
      #-----MOD-770041---------
      LET g_errno = 'aap-041'
      CALL cl_err(l_pmm22,'aap-041',0)
      IF NOT cl_null(g_errno) THEN #MOD-9A0143                                                                                      
         RETURN                    #MOD-9A0143                                                                                      
      END IF                       #MOD-9A0143    
     #CALL cl_getmsg('aap-041',g_lang) RETURNING g_msg
     #LET g_buf=g_msg[1,4],':',l_pmm22 ERROR g_buf
     #WHILE TRUE
     #      LET INT_FLAG = 0  ######add for prompt bug
     #   PROMPT g_msg CLIPPED FOR g_chr
     #      ON IDLE g_idle_seconds  #TQC-860021
     #         CALL cl_on_idle()    #TQC-860021
     #
     #      ON ACTION about         #TQC-860021
     #         CALL cl_about()      #TQC-860021
     #
     #      ON ACTION help          #TQC-860021
     #         CALL cl_show_help()  #TQC-860021
     #
     #      ON ACTION controlg      #TQC-860021
     #         CALL cl_cmdask()     #TQC-860021
     #   END PROMPT                 #TQC-860021
     #
     #   CASE
     #      WHEN g_chr = '1'
     #         LET g_errno = 'aap-041'
     #         RETURN
     #      WHEN g_chr = '2'
     #         LET g_apa.apa13 = l_pmm22
     #         DISPLAY BY NAME g_apa.apa13
     #         UPDATE apa_file SET apa13 = g_apa.apa13
     #          WHERE apa01 = g_apa.apa01
     #   END CASE
     #
     #   IF g_chr MATCHES "[123]" THEN
     #      EXIT WHILE
     #   END IF
     #END WHILE
      #-----END MOD-770041-----
   END IF
   #MOD-8C0020---begin                                                                                                    
   LET t_gec04 = 0                                                                                                                  
   IF g_aptype = '16' OR g_aptype = '26' THEN                                                                                       
      SELECT gec04 INTO t_gec04 FROM gec_file                                                                                       
       WHERE gec01 = g_apa.apa15                                                                                                    
      IF t_gec04 <> 0 THEN                                                                                                          
         LET g_errno='aap-887'                                                                                                      
      END IF                                                                                                                        
   ELSE                                                                                                                             
   #MOD-8C0020---end   
   IF l_pmm21 != g_apa.apa15 THEN                              # 稅別不符
      CALL cl_getmsg('aap-043',g_lang) RETURNING g_msg
      LET g_buf1=g_msg[1,4],':',l_pmm22 ERROR g_buf1   ##FUN-C80078 g_buf-->g_buf1
      WHILE TRUE
            LET INT_FLAG = 0  ######add for prompt bug
         PROMPT g_msg CLIPPED FOR g_chr
            ON IDLE g_idle_seconds
               CALL cl_on_idle()
              #CONTINUE PROMPT
 
            ON ACTION about         #MOD-4C0121
               CALL cl_about()      #MOD-4C0121
 
            ON ACTION help          #MOD-4C0121
               CALL cl_show_help()  #MOD-4C0121
 
            ON ACTION controlg      #MOD-4C0121
               CALL cl_cmdask()     #MOD-4C0121
         END PROMPT

         CASE
            WHEN g_chr = '1'
               LET g_errno = 'aap-043'
               RETURN
            WHEN g_chr = '2'
               LET g_apa.apa15 = l_pmm21
               DISPLAY BY NAME g_apa.apa15
               CALL t110_apa15('a')
               UPDATE apa_file SET apa15 = g_apa.apa15
                WHERE apa01 = g_apa.apa01
         END CASE

         IF g_chr MATCHES "[123]" THEN
            EXIT WHILE
         END IF
      END WHILE
     END IF  #MOD-8C0020
   END IF

   LET g_apb04 = l_rvv04
   LET g_apb05 = l_rvv05
   LET g_apb[l_ac].apb06 = l_rvv36
   LET g_apb[l_ac].apb07 = l_rvv37
   LET g_apb[l_ac].apb12 = l_rvv31
   LET g_apb[l_ac].apb25 = l_pmn40
   LET g_apb[l_ac].apb34 = t110_set_rvv34(g_apb[l_ac].apb21,g_apb[l_ac].apb22)   #MOD-850302 add
   #------No:MOD-5A0095 START-------------------
   DISPLAY BY NAME g_apb[l_ac].apb06
   DISPLAY BY NAME g_apb[l_ac].apb07
   DISPLAY BY NAME g_apb[l_ac].apb12
   DISPLAY BY NAME g_apb[l_ac].apb25
   DISPLAY BY NAME g_apb[l_ac].apb34   #MOD-850302 add
   #------No:MOD-5A0095 END---------------------
   #No.TQC-770056--begin------------
   IF NOT cl_null(l_pmn40) THEN
      SELECT aag02 INTO g_apb[l_ac].b25 FROM aag_file 
      #WHERE aag01=l_pmn40 AND aag00=g_bookno1                       #No.MOD-B70280 mark
       WHERE aag01=l_pmn40 AND aag00=g_bookno1 AND aagacti = 'Y'     #No.MOD-B70280 add
      IF SQLCA.sqlcode THEN
         LET g_apb[l_ac].b25 = NULL 
      END IF
      DISPLAY BY NAME g_apb[l_ac].b25
   END IF 
      
   #No.TQC-770056--end--------------

   #FUN-930165---add---str--- 
#   IF g_apb[l_ac].apb12='MISC' THEN       #MOD-950177
    IF g_apb[l_ac].apb12[1,4]='MISC' THEN  #MOD-950177
       SELECT pmk13 INTO l_pmk13 FROM pmk_file 
        WHERE pmk01 IN (SELECT pmn24 FROM pmn_file 
                         WHERE pmn01=l_rvv36 
                           AND pmn02=l_rvv37) 
       IF NOT cl_null(l_pmk13) THEN 
          LET l_pmn67=l_pmk13 
       END IF 
    END IF
   #FUN-930165---add---end--- 
   IF g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' THEN
      LET g_apb[l_ac].apb26 = l_pmn67
   ELSE
      LET g_apb[l_ac].apb26 = g_apa.apa22
      #------No:MOD-5A0095 START-------------------
      DISPLAY BY NAME g_apb[l_ac].apb26
      #------No:MOD-5A0095 END---------------------
   END IF

   #No.TQC-770056--begin--
   IF NOT cl_null(g_apb[l_ac].apb26) THEN
      SELECT gem02 INTO g_apb[l_ac].b26 FROM gem_file
       WHERE gem01 = g_apb[l_ac].apb26
      IF SQLCA.sqlcode THEN
         LET g_apb[l_ac].apb26 = NULL
      END IF 
      DISPLAY BY NAME g_apb[l_ac].b26 
   END IF
   #No.TQC-770056--end--

   LET g_apb[l_ac].apb27 = l_pmn041
   #LET g_apb[l_ac].apb28 = l_pmn07   #FUN-560070
   LET g_apb[l_ac].apb28 = l_pmn86   #FUN-560070
   LET g_apb[l_ac].apb29 = l_rvv03
   #------No:MOD-5A0095 START-------------------
   DISPLAY BY NAME g_apb[l_ac].apb27
   DISPLAY BY NAME g_apb[l_ac].apb28
   DISPLAY BY NAME g_apb[l_ac].apb29
   #------No:MOD-5A0095 END---------------------

   IF l_rvv25='Y' THEN             #樣品單價為0
      LET g_apb[l_ac].apb23 = 0
      LET l_rvv38t = 0    #TQC-8A0079 add
   ELSE
      LET g_apb[l_ac].apb23 = l_rvv38
      #------No:MOD-5A0095 START-------------------
      DISPLAY BY NAME g_apb[l_ac].apb23
      #------No:MOD-5A0095 END---------------------
   END IF

   LET g_apb[l_ac].apb08 = g_apb[l_ac].apb23 * g_apa.apa14
  #LET g_apb[l_ac].apb08 = cl_digcut(g_apb[l_ac].apb08,t_azi.azi03)    #No:MOD-510045   #MOD-6B0066
   LET g_apb[l_ac].apb08 = cl_digcut(g_apb[l_ac].apb08,g_azi03)    #No:MOD-510045   #MOD-6B0066
   #------No:MOD-5A0095 START-------------------
   DISPLAY BY NAME g_apb[l_ac].apb08
   #------No:MOD-5A0095 END---------------------

   IF g_apb[l_ac].apb09 = 0 THEN
      #LET g_apb[l_ac].apb09 = l_rvv17 - l_rvv23   #FUN-560070
      LET g_apb[l_ac].apb09 = l_rvv87 - l_rvv23   #FUN-560070
      #------No:MOD-5A0095 START-------------------
      DISPLAY BY NAME g_apb[l_ac].apb09
      #------No:MOD-5A0095 END---------------------
   END IF

  #str TQC-8A0079 mod
  #IF g_apb[l_ac].apb09>0 THEN
  #   LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
  #END IF
   #單價含稅時,不使用單價*數量=金額,改以含稅金額回推稅率,以避免小數位差的問題
   LET l_gec04 = 0   LET l_gec07 = ''
   #No:MOD-8C0020---Begin
   #SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file
   # WHERE gec01 = g_apa.apa15   
   IF g_apb[l_ac].apb06 <> '' OR NOT cl_null(g_apb[l_ac].apb06) THEN  #TQC-8C0031 add
     #SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file,pmm_file                  #MOD-A80052 mark
      SELECT gec04,gec05,gec07 INTO l_gec04,l_gec05,l_gec07 FROM gec_file,pmm_file    #MOD-A80052
       WHERE gec01 = pmm21 AND pmm01=g_apb[l_ac].apb06 
   #TQC-8C0031---Begin
   ELSE
     #SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file,pmm_file                  #MOD-A80052 mark
      SELECT gec04,gec05,gec07 INTO l_gec04,l_gec05,l_gec07 FROM gec_file             #MOD-A80052
       WHERE gec01 = g_apa.apa15   
   END IF
   #TQC-8C0031---End
   #No:MOD-8C0020---End
   IF cl_null(l_gec04) THEN LET l_gec04=0   END IF
   IF cl_null(l_gec07) THEN LET l_gec07='N' END IF
  #-MOD-A80093-add-
  #IF g_aza.aza26 = '2' THEN                     #MOD-B30578 mark
   IF g_aza.aza26 = '2' AND g_aptype='11' THEN   #MOD-B30578
      SELECT SUM(rvw05f),SUM(rvw05) INTO g_apb[l_ac].apb24,g_apb[l_ac].apb10
        FROM rvw_file
       WHERE rvw08 = g_apb[l_ac].apb21
         AND rvw09 = g_apb[l_ac].apb22 
   ELSE
      IF l_gec07='Y' THEN        #含稅單價*數量=含稅金額     
         #MOD-920013---Begin
         LET l_apb24t= l_rvv38t*g_apb[l_ac].apb09
         LET l_apb24t= cl_digcut(l_apb24t,t_azi04)
        #-MOD-A80052-add-
         IF l_gec05 = 'T' THEN
            LET l_apa32f = l_apb24t * (l_gec04/100)
            LET l_apa32f = cl_digcut(l_apa32f , t_azi04)
            LET g_apb[l_ac].apb24 = l_apb24t - l_apa32f 
         ELSE
            LET g_apb[l_ac].apb24 = l_apb24t/(1+l_gec04/100)
         END IF  
        #-MOD-A80052-end-
        #LET g_apb[l_ac].apb24 = l_apb24t/(1+l_gec04/100)          #MOD-A80052 mark
         #LET g_apb[l_ac].apb24 = (l_rvv38t*g_apb[l_ac].apb09)/(1+l_gec04/100)
         #MOD-920013---End
      ELSE
         IF g_apb[l_ac].apb09>0 THEN
            LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
         END IF
      END IF
     #end TQC-8A0079 mod
   END IF 
  #-MOD-A80093-end-
  #LET g_apb[l_ac].apb24 = cl_digcut(g_apb[l_ac].apb24,g_azi.azi04)   #MOD-6B0066
   LET g_apb[l_ac].apb24 = cl_digcut(g_apb[l_ac].apb24,t_azi04)       #MOD-6B0066
   #------No:MOD-5A0095 START-------------------
   DISPLAY BY NAME g_apb[l_ac].apb24
   #------No:MOD-5A0095 END---------------------

  #LET g_apb[l_ac].apb10 = g_apb[l_ac].apb08 * g_apb[l_ac].apb09      #MOD-860221 mark
   IF g_aza.aza26 <> '2' THEN                                         #MOD-A80093 
      LET g_apb[l_ac].apb10 = g_apb[l_ac].apb24 * g_apa.apa14         #MOD-860221
   END IF                                                             #MOD-A80093 
  #LET g_apb[l_ac].apb10 = cl_digcut(g_apb[l_ac].apb10,t_azi.azi04)   #MOD-6B0066
   LET g_apb[l_ac].apb10 = cl_digcut(g_apb[l_ac].apb10,g_azi04)   #MOD-6B0066
   #------No:MOD-5A0095 START-------------------
   DISPLAY BY NAME g_apb[l_ac].apb10
   #------No:MOD-5A0095 END---------------------

 #str MOD-960328 mark
 #當沖暫估時,單身的本幣金額還是應該用單頭的匯率重算,
 #只有寫入api_file沖暫估資料時,才是應該寫入aapt160的原始金額
 ##str MOD-850302 add
 ##當apb34='Y'時,表示此入庫單已有立暫估,單價,金額等欄位(apb23,apb24,apb08,apb10)
 ##應直接抓取aapt160,不應重新計算
 # IF g_apb[l_ac].apb34='Y' THEN
 #    SELECT apb23,apb24,apb08,apb10
 #      INTO g_apb[l_ac].apb23,g_apb[l_ac].apb24,
 #           g_apb[l_ac].apb08,g_apb[l_ac].apb10
 #      FROM apa_file,apb_file
 #     WHERE apa01 = apb01
 #       AND apa00 = '16'
 #       AND apb21 = g_apb[l_ac].apb21
 #       AND apb22 = g_apb[l_ac].apb22
 #    DISPLAY BY NAME g_apb[l_ac].apb23
 #    DISPLAY BY NAME g_apb[l_ac].apb24
 #    DISPLAY BY NAME g_apb[l_ac].apb08
 #    DISPLAY BY NAME g_apb[l_ac].apb10
 # END IF
 ##end MOD-850302 add
 #end MOD-960328 mark

   #FUN-670064...............begin
   LET g_apb[l_ac].apb930=l_rvv930
   LET g_apb[l_ac].gem02c=s_costcenter_desc(g_apb[l_ac].apb930)
   DISPLAY BY NAME g_apb[l_ac].apb930,g_apb[l_ac].gem02c
   #FUN-670064...............end
END FUNCTION

#str FUN-7A0050 add
FUNCTION t110_apb22_12()
   DEFINE l_apb     RECORD LIKE apb_file.*
   DEFINE l_gec04   LIKE gec_file.gec04      #TQC-8A0079 add
   DEFINE l_gec07   LIKE gec_file.gec07      #TQC-8A0079 add
   DEFINE l_rvv38t  LIKE rvv_file.rvv38t     #TQC-8A0079 add
   DEFINE l_apb24t  LIKE apb_file.apb24      #MOD-920013 add
#MOD-940416  --begin--
   DEFINE l_apb09       LIKE apb_file.apb09
   DEFINE l_apb10       LIKE apb_file.apb10
   DEFINE l_apb24       LIKE apb_file.apb24
   DEFINE l_apb09_b     LIKE apb_file.apb09
   DEFINE l_apb10_b     LIKE apb_file.apb09
   DEFINE l_apb24_b     LIKE apb_file.apb09      
   DEFINE l_apb09_t160  LIKE apb_file.apb09
   DEFINE l_apb10_t160  LIKE apb_file.apb09
   DEFINE l_apb24_t160  LIKE apb_file.apb09    
#MOD-940416  --end--
   DEFINE l_cnt         LIKE type_file.num5    #MOD-950158
   DEFINE l_apa14       LIKE apa_file.apa14    #MOD-960328 add
   
   LET g_errno = ' '

   IF cl_null(g_apb[l_ac].apb21) AND cl_null(g_apb[l_ac].apb22) THEN
      RETURN
   END IF

#MOD-950158 --begin                                        
   LET l_cnt = 0   
   LET g_chr_2 = 'Y'                                                                                                                
   SELECT COUNT(*) INTO l_cnt FROM apb_file,apa_file                                                                     
    WHERE apb21 = g_apb[l_ac].apb21                                                                                            
      AND apb22 = g_apb[l_ac].apb22                                                                                            
      AND apa01 = apb01                                                                                                  
      AND (apa00 = '16' OR apa00 = '26')
      AND apa41 !='Y'                                                                                
      AND apa42 = 'N'                                                                
   IF l_cnt > 0 THEN  
      LET g_chr_2 = 'N'                                                                                                          
      CALL s_errmsg('','','','aap-118',1)                                                                
      RETURN                                                                                   
   END IF                                                                                        
#MOD-950158 --end

  #-MOD-B90056-add-
   #檢查單身費用暫估資料是否重覆 
   LET l_cnt = 0                                                                                                         
   SELECT COUNT(*) INTO l_cnt 
     FROM apa_file,apb_file
    WHERE apb01 = g_apa.apa01 
      AND apb21 = g_apb[l_ac].apb21
      AND apb22 = g_apb[l_ac].apb22
   IF l_cnt > 0 THEN
      LET g_chr_2 = 'N'                                                                                                     
      CALL s_errmsg('','','','atm-310',1)                                                                
      RETURN                                                                                   
   END IF                                                                                        
  #-MOD-B90056-end-

   #檢查是否為 aapt160 費用暫估資料
   SELECT apb_file.* INTO l_apb.* FROM apb_file,apa_file
    WHERE apa01=apb01
      AND apa00='16' 
      AND apb01=g_apb[l_ac].apb21
      AND apb02=g_apb[l_ac].apb22

   CASE WHEN SQLCA.SQLCODE = 100 LET g_errno = 'aap-091'
        OTHERWISE                LET g_errno = SQLCA.SQLCODE USING '-------'
   END CASE

   IF NOT cl_null(g_errno) THEN RETURN END IF

   LET g_apb[l_ac].apb12 = l_apb.apb12
   LET g_apb[l_ac].apb25 = l_apb.apb25
  #DISPLAY BY NAME g_apb[l_ac].apb12
  #DISPLAY BY NAME g_apb[l_ac].apb25

   IF NOT cl_null(l_apb.apb25) THEN
      SELECT aag02 INTO g_apb[l_ac].b25 FROM aag_file 
      #WHERE aag01=l_apb.apb25 AND aag00=g_bookno1                       #No.MOD-B70280 mark
       WHERE aag01=l_apb.apb25 AND aag00=g_bookno1 AND aagacti = 'Y'     #No.MOD-B70280 add
      IF SQLCA.sqlcode THEN
         LET g_apb[l_ac].b25 = NULL 
      END IF
  #   DISPLAY BY NAME g_apb[l_ac].b25
   END IF
  
   IF cl_null(g_apb[l_ac].apb26) THEN                        #MOD-A70003  
     #IF g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' THEN                               #MOD-B50255 mark
      IF (g_apy.apydmy5='Y' OR NOT cl_null(l_apb.apb26)) AND g_apa.apa00[1,1]='1' THEN #MOD-B50255
         LET g_apb[l_ac].apb26 = l_apb.apb26
      ELSE
         LET g_apb[l_ac].apb26 = g_apa.apa22
      END IF
   END IF                                                    #MOD-A70003
  #DISPLAY BY NAME g_apb[l_ac].apb26

   IF NOT cl_null(g_apb[l_ac].apb26) THEN
      SELECT gem02 INTO g_apb[l_ac].b26 FROM gem_file
       WHERE gem01 = g_apb[l_ac].apb26
      IF SQLCA.sqlcode THEN
         LET g_apb[l_ac].apb26 = NULL
      END IF 
  #   DISPLAY BY NAME g_apb[l_ac].b26 
   END IF

   LET g_apb[l_ac].apb27 = l_apb.apb27
   LET g_apb[l_ac].apb28 = l_apb.apb28
   LET g_apb[l_ac].apb29 = l_apb.apb29
  #DISPLAY BY NAME g_apb[l_ac].apb27
  #DISPLAY BY NAME g_apb[l_ac].apb28
  #DISPLAY BY NAME g_apb[l_ac].apb29

   LET g_apb[l_ac].apb23 = l_apb.apb23
  #DISPLAY BY NAME g_apb[l_ac].apb23

   LET g_apb[l_ac].apb08 = g_apb[l_ac].apb23 * g_apa.apa14
   LET g_apb[l_ac].apb08 = cl_digcut(g_apb[l_ac].apb08,g_azi03)    #No:MOD-510045   #MOD-6B0066
  #DISPLAY BY NAME g_apb[l_ac].apb08

# LET g_apb[l_ac].apb09 = l_apb.apb09        #MOD-940416 mark
#MOD-940416 --begin--
  IF g_aptype = '12' THEN     #MOD-AB0167
     CALL t110_chkapb24()                       #MOD-A90146
  END IF                      #MOD-AB0167
 #-MOD-A90146-mark-
 ##aapt120已確認沖費用暫估
 #SELECT SUM(apb09),SUM(apb10),SUM(apb24)
 #  INTO l_apb09,l_apb10,l_apb24
 #  FROM apa_file,apb_file
 # WHERE apb21 = g_apb[l_ac].apb21
 #   AND apb22 = g_apb[l_ac].apb22
 #   AND apa00 = '12'
 #   AND apa01 = apb01
 #   AND apa41 = 'Y'
 #IF cl_null(l_apb09) THEN LET l_apb09 = 0 END IF     
 #IF cl_null(l_apb10) THEN LET l_apb10 = 0 END IF     
 #IF cl_null(l_apb24) THEN LET l_apb24 = 0 END IF     
 #  
 ##aapt120未確認沖費用暫估
 #SELECT SUM(apb09),SUM(apb10),SUM(apb24)
 #  INTO l_apb09_b,l_apb10_b,l_apb24_b
 #  FROM apa_file,apb_file
 # WHERE apb01 = g_apa.apa01 
 #   AND apb21 = g_apb[l_ac].apb21
 #   AND apb22 = g_apb[l_ac].apb22
 #   AND apa00 = '12'
 #   AND apa01 = apb01
 #   AND apa41!= 'Y'
 #IF cl_null(l_apb09_b) THEN LET l_apb09_b = 0 END IF        
 #IF cl_null(l_apb10_b) THEN LET l_apb10_b = 0 END IF        
 #IF cl_null(l_apb24_b) THEN LET l_apb24_b = 0 END IF          
 #
 ##aapt160費用暫估
 #SELECT apb09,apb10,apb24
 #  INTO l_apb09_t160,l_apb10_t160,l_apb24_t160
 #  FROM apa_file,apb_file
 # WHERE apb01 = g_apb[l_ac].apb21
 #   AND apb02 = g_apb[l_ac].apb22
 #   AND apa00 = '16'
 #   AND apa01 = apb01
 #IF cl_null(l_apb09_t160) THEN LET l_apb09_t160 = 0 END IF      
 #IF cl_null(l_apb10_t160) THEN LET l_apb10_t160 = 0 END IF     
 #IF cl_null(l_apb24_t160) THEN LET l_apb24_t160 = 0 END IF          
 #-MOD-A90146-end-

  #aapt160的數量、金額-aapt120已確認的數量、金額-aapt120未確認的數量、金額
 #LET g_apb[l_ac].apb09 = l_apb09_t160 - l_apb09 - l_apb09_b   #MOD-A90146 mark 
  LET g_apb[l_ac].apb09 = g_apb09                              #MOD-A90146
 #LET g_apb[l_ac].apb24 = l_apb24_t160 - l_apb24 - l_apb24_b   #MOD-A90146 mark 
  LET g_apb[l_ac].apb24 = g_apb24                              #MOD-A90146
 #LET g_apb[l_ac].apb10 = l_apb10_t160 - l_apb10 - l_apb10_b   #MOD-960328 mark
  LET g_apb[l_ac].apb10 = g_apb[l_ac].apb24 * g_apa.apa14      #MOD-960328
  IF cl_null(g_apb[l_ac].apb09) OR g_apb[l_ac].apb09=0 THEN
     LET g_apb[l_ac].apb09=1
  END IF
  LET g_apb[l_ac].apb24 = cl_digcut(g_apb[l_ac].apb24,t_azi04)
  LET g_apb[l_ac].apb10 = cl_digcut(g_apb[l_ac].apb10,g_azi04)
  DISPLAY BY NAME g_apb[l_ac].apb09,g_apb[l_ac].apb10,g_apb[l_ac].apb24
  LET g_apb[l_ac].apb23 = g_apb[l_ac].apb24 / g_apb[l_ac].apb09
  LET g_apb[l_ac].apb08 = g_apb[l_ac].apb10 / g_apb[l_ac].apb09
  DISPLAY BY NAME g_apb[l_ac].apb08,g_apb[l_ac].apb23
#MOD-940416 --end--

  #DISPLAY BY NAME g_apb[l_ac].apb09
  IF g_apb[l_ac].apb09 != 0 AND g_apb[l_ac].apb09 IS NOT NULL THEN     #MOD-940416  
     #str TQC-8A0079 mod
     #IF g_apb[l_ac].apb09 > 0 THEN
     #   LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
     #END IF
      #單價含稅時,不使用單價*數量=金額,改以含稅金額回推稅率,以避免小數位差的問題
      LET l_gec04 = 0   LET l_gec07 = ''
      #No:MOD-8C0020---Begin
      #SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file
      # WHERE gec01 = g_apa.apa15     
      IF g_apb[l_ac].apb06 <> '' OR NOT cl_null(g_apb[l_ac].apb06) THEN  #TQC-8C0031 add
         SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file,pmm_file
          WHERE gec01 = pmm21 AND pmm01=g_apb[l_ac].apb06 
      #TQC-8C0031---Begin
      ELSE
         SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file                                                                           
          WHERE gec01 = g_apa.apa15
      END IF
      #TQC-8C0031---End
      #No:MOD-8C0020---End 
      IF cl_null(l_gec04) THEN LET l_gec04=0   END IF
      IF cl_null(l_gec07) THEN LET l_gec07='N' END IF
      LET l_rvv38t = 0
      IF l_gec07='Y' THEN
         IF NOT cl_null(g_apb[l_ac].apb21) AND NOT cl_null(g_apb[l_ac].apb22) THEN   #MOD-9A0201 add
            SELECT rvv38t INTO l_rvv38t FROM rvv_file
             WHERE rvv01 = g_apb[l_ac].apb21
               AND rvv02 = g_apb[l_ac].apb22
            IF cl_null(l_rvv38t) THEN LET l_rvv38t=0 END IF
            #MOD-920013---Begin
            LET l_apb24t = l_rvv38t*g_apb[l_ac].apb09
            LET l_apb24t = cl_digcut(l_apb24t,t_azi04) 
            LET g_apb[l_ac].apb24 = l_apb24t/(1+l_gec04/100)
            #LET g_apb[l_ac].apb24 = (l_rvv38t*g_apb[l_ac].apb09)/(1+l_gec04/100)
            #MOD-920013---End
       #str TQC-A10146 mark
       ##str MOD-9A0201 add
       # ELSE
       #   #aapt120雜項輸入時,稅別若為內含,輸入原幣單價後應為含稅單價,
       #   #需回推為未稅單價
       #    IF g_apb[l_ac].apb23 <> g_apb_t.apb23 OR 
       #       cl_null(g_apb_t.apb23) THEN 
       #       LET g_apb[l_ac].apb23 = cl_digcut(g_apb[l_ac].apb23/(1+l_gec04/100),t_azi03)
       #       DISPLAY BY NAME g_apb[l_ac].apb23
       #       LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
       #    END IF
       #end TQC-A10146 mark
         END IF
        #end MOD-9A0201 add
      ELSE
         IF g_apb[l_ac].apb09 > 0 THEN
            LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
         END IF
      END IF
     #end TQC-8A0079 mod
   END IF                  #MOD-940416    
   LET g_apb[l_ac].apb24 = cl_digcut(g_apb[l_ac].apb24,t_azi04)   #MOD-6B0066
  #DISPLAY BY NAME g_apb[l_ac].apb24

  #LET g_apb[l_ac].apb10 = g_apb[l_ac].apb08 * g_apb[l_ac].apb09   #MOD-860221 mark
   LET g_apb[l_ac].apb10 = g_apb[l_ac].apb24 * g_apa.apa14         #MOD-860221
   LET g_apb[l_ac].apb10 = cl_digcut(g_apb[l_ac].apb10,g_azi04)   #MOD-6B0066
  #DISPLAY BY NAME g_apb[l_ac].apb10

   LET g_apb[l_ac].apb930=l_apb.apb930
   LET g_apb[l_ac].gem02c=s_costcenter_desc(g_apb[l_ac].apb930)
  #DISPLAY BY NAME g_apb[l_ac].apb930,g_apb[l_ac].gem02c

   DISPLAY BY NAME g_apb[l_ac].*

END FUNCTION
#end FUN-7A0050 add

#-MOD-A90146-add-
FUNCTION t110_chkapb24()
   DEFINE l_apb09       LIKE apb_file.apb09
   DEFINE l_apb10       LIKE apb_file.apb10
   DEFINE l_apb24       LIKE apb_file.apb24
   DEFINE l_apb09_b     LIKE apb_file.apb09
   DEFINE l_apb10_b     LIKE apb_file.apb09
   DEFINE l_apb24_b     LIKE apb_file.apb09      
   DEFINE l_apb09_t160  LIKE apb_file.apb09
   DEFINE l_apb10_t160  LIKE apb_file.apb09
   DEFINE l_apb24_t160  LIKE apb_file.apb09    

  #aapt120已確認沖費用暫估
  SELECT SUM(apb09),SUM(apb10),SUM(apb24)
    INTO l_apb09,l_apb10,l_apb24
    FROM apa_file,apb_file
   WHERE apb21 = g_apb[l_ac].apb21
     AND apb22 = g_apb[l_ac].apb22
     AND apa00 = '12'
     AND apa01 = apb01
     AND apa41 = 'Y'
  IF cl_null(l_apb09) THEN LET l_apb09 = 0 END IF     
  IF cl_null(l_apb10) THEN LET l_apb10 = 0 END IF     
  IF cl_null(l_apb24) THEN LET l_apb24 = 0 END IF     
    
  #aapt120未確認沖費用暫估
  SELECT SUM(apb09),SUM(apb10),SUM(apb24)
    INTO l_apb09_b,l_apb10_b,l_apb24_b
    FROM apa_file,apb_file
   WHERE apb01 <> g_apa.apa01 
     AND apb21 = g_apb[l_ac].apb21
     AND apb22 = g_apb[l_ac].apb22
     AND apa00 = '12'
     AND apa01 = apb01
     AND apa41!= 'Y'
  IF cl_null(l_apb09_b) THEN LET l_apb09_b = 0 END IF        
  IF cl_null(l_apb10_b) THEN LET l_apb10_b = 0 END IF        
  IF cl_null(l_apb24_b) THEN LET l_apb24_b = 0 END IF          
  
  #aapt160費用暫估
  SELECT apb09,apb10,apb24
    INTO l_apb09_t160,l_apb10_t160,l_apb24_t160
    FROM apa_file,apb_file
   WHERE apb01 = g_apb[l_ac].apb21      
     AND apb02 = g_apb[l_ac].apb22
     AND apa00 = '16'
     AND apa01 = apb01
  IF cl_null(l_apb09_t160) THEN LET l_apb09_t160 = 0 END IF      
  IF cl_null(l_apb10_t160) THEN LET l_apb10_t160 = 0 END IF     
  IF cl_null(l_apb24_t160) THEN LET l_apb24_t160 = 0 END IF          

  #aapt160的數量、金額-aapt120已確認的數量、金額-aapt120未確認的數量、金額
 #LET g_apb09 = l_apb09_t160 - l_apb09 - l_apb09_b #MOD-B20137 mark 
  LET g_apb09 = 1                                  #MOD-B20137
  LET g_apb24 = l_apb24_t160 - l_apb24 - l_apb24_b           
  LET g_apb10 = g_apb24 * g_apa.apa14     
  LET g_apb24 = cl_digcut(g_apb24,t_azi04)
  LET g_apb10 = cl_digcut(g_apb10,g_azi04)
END FUNCTION
#-MOD-A90146-end-

FUNCTION t110_apb06()

   LET g_apb[l_ac].apb12 = ''
   LET g_apb[l_ac].apb27 = ''
   LET g_apb[l_ac].apb09 = 0
   LET g_apb[l_ac].apb25 = ''
   LET g_apb[l_ac].apb28 = ''
   LET g_apb[l_ac].apb26 = ''
   LET g_apb[l_ac].apb23 = 0
   LET g_apb[l_ac].apb08 = 0
   LET g_apb[l_ac].apb24 = 0
   LET g_apb[l_ac].apb10 = 0
   #------No:MOD-5A0095 START-------------------
   DISPLAY BY NAME g_apb[l_ac].apb12
   DISPLAY BY NAME g_apb[l_ac].apb27
   DISPLAY BY NAME g_apb[l_ac].apb09
   DISPLAY BY NAME g_apb[l_ac].apb25
   DISPLAY BY NAME g_apb[l_ac].apb28
   DISPLAY BY NAME g_apb[l_ac].apb26
   DISPLAY BY NAME g_apb[l_ac].apb23
   DISPLAY BY NAME g_apb[l_ac].apb08
   DISPLAY BY NAME g_apb[l_ac].apb24
   DISPLAY BY NAME g_apb[l_ac].apb10
   #------No:MOD-5A0095 END---------------------

END FUNCTION

FUNCTION t110_apb22_21(p_cmd)
   DEFINE p_cmd           LIKE type_file.chr1      #No.FUN-690028 VARCHAR(1)
  #DEFINE l_sql           LIKE type_file.chr1000   #No.FUN-690028 VARCHAR(1000)   #MOD-720062
   DEFINE l_sql           STRING                   #MOD-720062
   DEFINE l_rvu04         LIKE rvu_file.rvu04
   DEFINE l_rvu02         LIKE rvu_file.rvu02
   DEFINE l_rvv03         LIKE rvv_file.rvv03
   DEFINE l_rvv04         LIKE rvv_file.rvv04
   DEFINE l_rvv05         LIKE rvv_file.rvv05
   DEFINE l_rvv38         LIKE rvv_file.rvv38
   DEFINE l_rvv38t        LIKE rvv_file.rvv38t     #TQC-8A0079 add
   DEFINE l_rvv39         LIKE rvv_file.rvv39
   DEFINE l_rvv39t        LIKE rvv_file.rvv39t     #TQC-8A0079 add
   DEFINE l_rvv17         LIKE rvv_file.rvv17      #FUN-560070
   DEFINE l_rvv87         LIKE rvv_file.rvv87      #FUN-560070
   DEFINE l_rvv23         LIKE rvv_file.rvv23
   DEFINE l_rvv25         LIKE rvv_file.rvv25
   DEFINE l_rvv36         LIKE rvv_file.rvv36
   DEFINE l_rvv37         LIKE rvv_file.rvv37
   DEFINE l_pmm22         LIKE pmm_file.pmm22
   DEFINE l_pmn07         LIKE pmn_file.pmn07
   DEFINE l_pmn86         LIKE pmn_file.pmn86      #FUN-560070
   DEFINE l_pmn40         LIKE pmn_file.pmn40
   DEFINE l_pmn041        LIKE pmn_file.pmn041
   DEFINE l_rvv31         LIKE rvv_file.rvv31
   DEFINE l_invoice       LIKE apa_file.apa08
   DEFINE l_pmn122        LIKE pmn_file.pmn122
   DEFINE l_iqc_no        LIKE rvu_file.rvu02      #FUN-660117 #CHAR(10)
   DEFINE l_iqc_seq       LIKE type_file.num5      #No:FUN-690028 SMALLINT
   DEFINE l_rvv930        LIKE rvv_file.rvv930     #FUN-670064
   DEFINE l_rvv88         LIKE rvv_file.rvv88      #No.TQC-7B0083
   DEFINE l_apb           RECORD LIKE apb_file.*   #MOD-850316 add
   DEFINE l_gec04         LIKE gec_file.gec04      #TQC-8A0079 add
   DEFINE l_gec07         LIKE gec_file.gec07      #TQC-8A0079 add
   DEFINE l_rvv09         LIKE rvv_file.rvv09      #MOD-8C0005 add
   DEFINE l_apb24t        LIKE apb_file.apb24      #MOD-920013 add
   DEFINE l_cnt           LIKE type_file.num5      #MOD-950158 
   DEFINE l_type          LIKE type_file.chr1      #MOD-9A0085
   LET g_errno = ' '

  #CHI-A30023---add---start---
   IF g_aptype='26' THEN
      IF cl_null(g_apb[l_ac].apb21) AND cl_null(g_apb[l_ac].apb22) THEN
         RETURN
      END IF
   END IF
  #MOD-A30023---add---end--- 
#MOD-950158 --begin                                        
   LET l_cnt = 0 
   LET g_chr_3 = 'Y'                                                                                                               
   SELECT COUNT(*) INTO l_cnt FROM apb_file,apa_file                                                                     
    WHERE apb21 = g_apb[l_ac].apb21                                                                                            
      AND apb22 = g_apb[l_ac].apb22                                                                                            
      AND apa01 = apb01                                                                                                  
      AND (apa00 = '16' OR apa00 = '26')
      AND apa41 !='Y'                                                                                
      AND apa42 = 'N'                                                                
   IF l_cnt > 0 THEN   
      LET g_chr_3 = 'N'                                                                                                            
      CALL s_errmsg('','','','aap-118',1)                                                                
      RETURN                                                                                   
   END IF                                                                                        
#MOD-950158 --end

  #str MOD-970061 add
   #若倉退單對應的收貨單已有發票不可再產生暫估單
   IF g_aptype='26' THEN
      LET l_cnt = 0
      IF g_aza.aza26 = '2' THEN
         SELECT COUNT(*) INTO l_cnt
           FROM rvw_file
          WHERE rvw08 = g_apb[l_ac].apb21 AND rvw09 = g_apb[l_ac].apb22
      ELSE
         SELECT COUNT(*) INTO l_cnt
           FROM rvv_file,rvb_file
          WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
            AND rvv04 = rvb01             AND rvv05 = rvb02
            AND rvb22 IS NOT NULL         AND rvb22 != ' '
      END IF
      IF l_cnt > 0 THEN
         CALL s_errmsg('','','','aap-152',1)
         LET g_errno = 'aap-152'
         RETURN
      END IF
   END IF
  #end MOD-970061 add

  #MOD-9A0085   ---start
   SELECT rvv01 FROM rvv_file,rvu_file   
    WHERE rvv01 = g_apb[l_ac].apb21  
      AND rvv02 = g_apb[l_ac].apb22                                                                                           
      AND rvu01 = rvv01                                                                                                       
      AND rvuconf='Y'                                                                                                         
      AND rvu00 = '3'
   IF SQLCA.SQLCODE = 100 THEN 
      LET l_type='1' 
   ELSE
      LET l_type='2'
   END IF         
  #MOD-9A0085   ---end

  #str MOD-850316 add
   IF g_aptype = '21' AND g_apa.apa58 = '3' AND l_type='1' THEN #MOD-9A0085 add l_type
      #當判斷apb21(退貨單號/費用類暫估單號)欄位有輸入時,才需檢查是否存在aapt260
      IF NOT cl_null(g_apb[l_ac].apb21) THEN   #MOD-880181 add
         #檢查是否為 aapt260 扣款折讓暫估資料
         SELECT apb_file.* INTO l_apb.* FROM apb_file,apa_file
          WHERE apa01 = apb01
            AND apa00 = '26' 
            AND apb01 = g_apb[l_ac].apb21
            AND apb02 = g_apb[l_ac].apb22
            AND apa05 = g_apa.apa05          #MOD-C60170 add
         IF SQLCA.SQLCODE = 100 THEN
               LET g_errno='aap-091'
               RETURN
         ELSE
            LET g_apb[l_ac].apb06 = l_apb.apb06
            LET g_apb[l_ac].apb07 = l_apb.apb07
            LET g_apb[l_ac].apb12 = l_apb.apb12
            LET g_apb[l_ac].apb25 = l_apb.apb25
            LET g_apb[l_ac].apb26 = l_apb.apb26
            LET g_apb[l_ac].apb27 = l_apb.apb27
            LET g_apb[l_ac].apb28 = l_apb.apb28
            LET g_apb[l_ac].apb29 = l_apb.apb29
            LET g_apb[l_ac].apb23 = l_apb.apb23
            LET g_apb[l_ac].apb08 = g_apb[l_ac].apb23 * g_apa.apa14
            LET g_apb[l_ac].apb08 =cl_digcut(g_apb[l_ac].apb08,g_azi03)
            LET g_apb[l_ac].apb09 = l_apb.apb09
           #str TQC-8A0079 mod
           #IF g_apb[l_ac].apb09>0 THEN
           #   LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
           #ELSE
           #   LET g_apb[l_ac].apb24 = 0
           #END IF
           #單價含稅時,不使用單價*數量=金額,改以含稅金額回推稅率,以避免小數位差的問題
            LET l_gec04 = 0   LET l_gec07 = ''
           #No:MOD-8C0020---Begin 
           #SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file
           # WHERE gec01 = g_apa.apa15 
            IF g_apb[l_ac].apb06 <> '' OR NOT cl_null(g_apb[l_ac].apb06) THEN  #TQC-8C0031      
               SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file,pmm_file
                WHERE gec01 = pmm21 AND pmm01=g_apb[l_ac].apb06 
           #TQC-8C0031---Begin
            ELSE 
               SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file                                                                  
                WHERE gec01 = g_apa.apa15 
            END IF
           #TQC-8C0031---End 
           #No:MOD-8C0020---End
            IF cl_null(l_gec04) THEN LET l_gec04=0   END IF
            IF cl_null(l_gec07) THEN LET l_gec07='N' END IF
            LET l_rvv38t = 0
            IF l_gec07='Y' THEN        #含稅單價*數量=含稅金額     
               SELECT rvv38t INTO l_rvv38t FROM rvv_file
                WHERE rvv01 = g_apb[l_ac].apb21
                  AND rvv02 = g_apb[l_ac].apb22
               IF cl_null(l_rvv38t) THEN LET l_rvv38t=0 END IF
              #MOD-920013---Begin
               LET l_apb24t = l_rvv38t*g_apb[l_ac].apb09
               LET l_apb24t = cl_digcut(l_apb24t,t_azi04) 
               LET g_apb[l_ac].apb24 = l_apb24t/(1+l_gec04/100)
              #LET g_apb[l_ac].apb24 = (l_rvv38t*g_apb[l_ac].apb09)/(1+l_gec04/100)
              #MOD-920013---End
            ELSE
               IF g_apb[l_ac].apb09>0 THEN
                  LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
               ELSE
                  LET g_apb[l_ac].apb24 = 0
               END IF
            END IF
           #end TQC-8A0079 mod
            LET g_apb[l_ac].apb24 =cl_digcut(g_apb[l_ac].apb24,t_azi04)
           #LET g_apb[l_ac].apb10 =g_apb[l_ac].apb08 * g_apb[l_ac].apb09   #MOD-860221 mark
            LET g_apb[l_ac].apb10 =g_apb[l_ac].apb24 * g_apa.apa14         #MOD-860221
            LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)
            LET g_apb[l_ac].apb34 ='Y'
            LET g_apb[l_ac].apb01_unap =g_apb[l_ac].apb21
            LET g_apb[l_ac].apb930=l_apb.apb930
            LET g_apb[l_ac].gem02c=s_costcenter_desc(g_apb[l_ac].apb930)
            DISPLAY BY NAME g_apb[l_ac].*
         END IF
      END IF   #MOD-880181 add
   ELSE
     #IF g_aptype = '21' AND g_apa.apa58 = '2' THEN                       #MOD-910098 mark
     #IF (g_aptype = '21' AND g_apa.apa58 = '2') OR g_aptype = '26' OR g_aptype = '11' THEN  #No:MOD-910062 #MOD-910098 #MOD-9A0085
      IF (g_aptype = '21' AND (g_apa.apa58 = '2' OR (g_apa.apa58='3' AND l_type='2'))) OR g_aptype = '26' OR g_aptype = '11' THEN  #MOD-9A0085
  #end MOD-850316 add
         #SELECT rvu04,rvv03,rvv04,rvv05,rvv38,rvv39,rvv23,rvv17,pmm22,rvu02,rvv05,   #FUN-560070
     LET l_sql = 
        "SELECT rvu04,rvv03,rvv04,rvv05,rvv38,rvv39,rvv23,rvv87,pmm22,rvu02,rvv05,",   #FUN-560070
        "       rvv31,pmn86,pmn40,pmn041,rvv25,rvv36,rvv37,pmn122,",  #FUN-560070
        "       rvv930,rvv88,rvv39t",   #FUN-670064  #No.TQC-7B0083   #TQC-8A0079 add rvv39t
        "       ,rvv09",      #MOD-8C0005 add rvv09 
        "  FROM rvv_file, rvu_file,rvb_file, ",
        "   (SELECT pmn01,pmn02,pmm22,pmn86,pmn40,pmn041,pmn122 ",
        "     FROM pmm_file,pmn_file ",
        "    WHERE pmn01 = pmm01) tmp ",
        "  WHERE rvv01 = '",g_apb[l_ac].apb21,"'",
        "    AND rvv02 =  ",g_apb[l_ac].apb22,
        "    AND rvu01 = rvv01 ",
        "    AND rvuconf='Y'   AND rvu00 = '3' ",
        "    AND rvv04 = rvb_file.rvb01(+) AND rvv05=rvb_file.rvb02(+) ",
        "    AND rvv36 = tmp.pmn01(+) AND rvv37 = tmp.pmn02(+) "
    PREPARE apb22_21_pre FROM l_sql
    DECLARE apb22_21_cs CURSOR FOR apb22_21_pre
    OPEN apb22_21_cs
    FETCH apb22_21_cs
        INTO l_rvu04,l_rvv03,l_rvv04,l_rvv05,l_rvv38,l_rvv39,l_rvv23,l_rvv87,   #FUN-560070
             l_pmm22,l_iqc_no,l_iqc_seq,l_rvv31,l_pmn86,l_pmn40,l_pmn041,   #FUN-560070
             l_rvv25,l_rvv36,l_rvv37,l_pmn122,
             l_rvv930,l_rvv88,l_rvv39t   #FUN-670064  #No.TQC-7B0083  #TQC-8A0079 add l_rvv39t
             ,l_rvv09      #MOD-8C0005 add l_rvv09 
         IF g_qty1 IS NULL THEN
            LET g_qty1 = 0
         END IF
#FUN-560070
         #IF l_rvv17 IS NULL THEN
         #   LET l_rvv17 = 0
         #END IF
         IF l_rvv87 IS NULL THEN
            LET l_rvv87 = 0
         END IF
#END FUN-560070
    
         IF l_rvv23 IS NULL THEN
            LET l_rvv23 = 0
         END IF
    
         IF l_pmn122 !=g_apa.apa66 THEN
            LET g_errno='aap-300'
            RETURN
         END IF
    
         IF l_rvv03 MATCHES '[12]' THEN
            LET g_errno='aap-093'
            RETURN
         END IF
    
         CASE WHEN SQLCA.SQLCODE = 100  LET g_errno = 'aap-092'
              WHEN l_rvu04 != g_apa.apa05 LET g_errno = 'aap-040'
              #WHEN l_rvv17 <= l_rvv23  LET g_errno = 'aap-774'   #FUN-560070
              WHEN l_rvv87 <= l_rvv23 AND l_rvv23 > 0  LET g_errno = 'aap-774'   #FUN-560070   #No:MOD-910062
              #MOD-8C0005---Begin  
              WHEN YEAR(l_rvv09)  != YEAR(g_apa.apa02)  OR                                                                                
                   (YEAR(l_rvv09)   = YEAR(g_apa.apa02)  AND                                                                              
                   MONTH(l_rvv09) != MONTH(g_apa.apa02) )                                                                                 
                   LET g_errno = 'aap-316'                                                                                                
              WHEN l_rvv09  > g_apa.apa02 LET g_errno = 'aap-317'   
              #MOD-8C0005---End
              OTHERWISE          LET g_errno = SQLCA.SQLCODE USING '-------'
         END CASE
    
         #No.TQC-7B0083  --Begin
         #衝暫估可以跨月
         IF g_errno = 'aap-316' THEN
            IF t110_set_rvv34(g_apb[l_ac].apb21,g_apb[l_ac].apb22) = 'Y' THEN
               LET g_errno = ''
            END IF
         END IF
         #重要信息:衝暫估前,一定要check部分請款,部分暫估現象時,請款已經做過了
         IF g_aptype='11' THEN
            IF l_rvv87 - l_rvv23 > 0 THEN                #部分請款或有做過暫估
               IF l_rvv88 > 0 THEN                       #有暫估資料沒有衝
                  IF l_rvv88 - l_rvv23 <> l_rvv88 THEN   #部分請款
                     LET g_errno = 'aap-817'
                  END IF
               END IF
            END IF
         END IF
         #No.TQC-7B0083  --End  
    
         IF NOT cl_null(g_errno) THEN
            RETURN
         END IF
    
         #No.TQC-7B0109 --start--
         IF cl_null(l_pmn041) THEN
            SELECT ima02 INTO l_pmn041 FROM ima_file
             WHERE ima01 = l_rvv31
         END IF
    
         IF cl_null(l_pmn40) THEN
            SELECT ima39 INTO l_pmn40 FROM ima_file
             WHERE ima01 = l_rvv31
         END IF
    
         IF cl_null(l_pmn86) THEN
            SELECT rvv86 INTO l_pmn86 FROM rvv_file
             WHERE rvv01 = g_apb[l_ac].apb21
               AND rvv02 = g_apb[l_ac].apb22
         END IF
         #No.TQC-7B0109 --end--
    
         IF g_apa.apa13 IS NULL THEN
            LET g_apa.apa13 = l_pmm22
         END IF
    
         IF l_pmm22 != g_apa.apa13 THEN                              # 幣別不符
            #-----MOD-770041---------
            LET g_errno = 'aap-041'
            CALL cl_err(l_pmm22,'aap-041',0)
            IF NOT cl_null(g_errno) THEN #MOD-9A0143                                                                                      
               RETURN                    #MOD-9A0143                                                                                      
            END IF                       #MOD-9A0143    
           #CALL cl_getmsg('aap-041',g_lang) RETURNING g_msg
           #LET g_buf=g_msg[1,4],':',l_pmm22 ERROR g_buf
           #WHILE TRUE
           #      LET INT_FLAG = 0  ######add for prompt bug
           #   PROMPT g_msg CLIPPED FOR g_chr
           #      ON IDLE g_idle_seconds
           #         CALL cl_on_idle()
           # #       CONTINUE PROMPT
           # 
           #      ON ACTION about         #MOD-4C0121
           #         CALL cl_about()      #MOD-4C0121
           # 
           #      ON ACTION help          #MOD-4C0121
           #         CALL cl_show_help()  #MOD-4C0121
           # 
           #      ON ACTION controlg      #MOD-4C0121
           #         CALL cl_cmdask()     #MOD-4C0121
           #   END PROMPT
           # 
           #   CASE
           #      WHEN g_chr = '1'
           #         LET g_errno = 'aap-041'
           #         RETURN
           #      WHEN g_chr = '2'
           #         LET g_apa.apa13 = l_pmm22
           #         DISPLAY BY NAME g_apa.apa13
           #         UPDATE apa_file SET apa13 = g_apa.apa13
           #          WHERE apa01 = g_apa.apa01
           #   END CASE
           # 
           #   IF g_chr MATCHES "[123]" THEN
           #      EXIT WHILE
           #   END IF
           #END WHILE
            #-----END MOD-770041-----
         END IF
        #MOD-970040---modify---start---
         IF g_aza.aza26 = 2 THEN 
            LET g_sql = "SELECT rvw01 FROM rvw_file ",
                        " WHERE rvw08 = '",g_apb[l_ac].apb21,"'",
                        " AND rvw09 = '",g_apb[l_ac].apb22,"'" 
         ELSE
            LET g_sql = "SELECT apa08 FROM apa_file,apb_file ",
                        " WHERE apa01 = apb01 AND apa00 = '11' ",
                        " AND apb04 = '",l_iqc_no,"' AND apb05 = '",l_iqc_seq,"'",
                        " ORDER BY apa08 DESC "
         END IF
         PREPARE t110_preinvoice FROM g_sql
         DECLARE t110_invoice CURSOR FOR t110_preinvoice
        #DECLARE t110_invoice CURSOR FOR
        #   SELECT apa08 FROM apa_file,apb_file
        #    WHERE apa01 = apb01 AND apa00 = '11'
        #      AND apb04 = l_iqc_no AND apb05 = l_iqc_seq
        #    ORDER BY apa08 DESC
        #MOD-970040---modify---end---
    
         LET l_invoice = NULL
    
         FOREACH t110_invoice INTO l_invoice
            IF STATUS THEN
               EXIT FOREACH
            END IF
         END FOREACH
    
         IF g_apb[l_ac].apb11 IS NULL THEN
            LET g_apb[l_ac].apb11 = l_invoice
            #------No:MOD-5A0095 START-------------------
            DISPLAY BY NAME g_apb[l_ac].apb11
            #------No:MOD-5A0095 END---------------------
         END IF
    
         LET g_apb04 = l_rvv04
         LET g_apb05 = l_rvv05
         LET g_apb[l_ac].apb06 = l_rvv36
         LET g_apb[l_ac].apb07 = l_rvv37
         LET g_apb[l_ac].apb12 = l_rvv31
         LET g_apb[l_ac].apb25 = l_pmn40
         LET g_apb[l_ac].apb26 = g_apa.apa22
         LET g_apb[l_ac].apb27 = l_pmn041
         #LET g_apb[l_ac].apb28 = l_pmn07   #FUN-560070
         LET g_apb[l_ac].apb28 = l_pmn86   #FUN-560070
         LET g_apb[l_ac].apb29 = l_rvv03
    
         IF l_rvv25='Y' THEN             #樣品單價為0
            LET g_apb[l_ac].apb23 = 0
         ELSE
            LET g_apb[l_ac].apb23 = l_rvv38
         END IF
         #------No:MOD-5A0095 START-------------------
         DISPLAY BY NAME g_apb[l_ac].apb23
         #------No:MOD-5A0095 END---------------------
    
         LET g_apb[l_ac].apb08 = g_apb[l_ac].apb23 * g_apa.apa14
        #LET g_apb[l_ac].apb08 =cl_digcut(g_apb[l_ac].apb08,t_azi.azi03)       #No:MOD-510045   #MOD-6B0066
         LET g_apb[l_ac].apb08 =cl_digcut(g_apb[l_ac].apb08,g_azi03)       #No:MOD-510045   #MOD-6B0066
         #------No:MOD-5A0095 START-------------------
         DISPLAY BY NAME g_apb[l_ac].apb08
         #------No:MOD-5A0095 END---------------------
    
         IF g_apb[l_ac].apb09 = 0 THEN
           #LET g_apb[l_ac].apb09 = l_rvv17 - l_rvv23   #FUN-560070
            LET g_apb[l_ac].apb09 = l_rvv87 - l_rvv23   #FUN-560070
            #------No:MOD-5A0095 START-------------------
            DISPLAY BY NAME g_apb[l_ac].apb09
            #------No:MOD-5A0095 END---------------------
         END IF
    
        #str TQC-8A0079 mod
        #IF g_apb[l_ac].apb09>0 THEN
        #   LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
        #ELSE
        #   IF g_apb[l_ac].apb24 = 0 THEN
        #      LET g_apb[l_ac].apb24 = l_rvv39
        #   END IF
        #END IF
        #LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
         #單價含稅時,不使用單價*數量=金額,改以含稅金額回推稅率,以避免小數位差的問題
         LET l_gec04 = 0   LET l_gec07 = ''
         #No:MOD-8C0020---Begin 
         #SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file
         # WHERE gec01 = g_apa.apa15     
         IF g_apb[l_ac].apb06 <> '' OR NOT cl_null(g_apb[l_ac].apb06) THEN   #TQC-8C0031
            SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file,pmm_file
             WHERE gec01 = pmm21 AND pmm01=g_apb[l_ac].apb06
         #TQC-8C0031---Begin
         ELSE
            SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file                                                                     
             WHERE gec01 = g_apa.apa15 
         END IF                
         #TQC-8C0031---End 
         #No:MOD-8C0020---End 
         IF cl_null(l_gec04) THEN LET l_gec04=0   END IF
         IF cl_null(l_gec07) THEN LET l_gec07='N' END IF
         LET l_rvv38t = 0
         IF l_gec07='Y' THEN
            IF g_apb[l_ac].apb09>0 THEN
               SELECT rvv38t INTO l_rvv38t FROM rvv_file
                WHERE rvv01 = g_apb[l_ac].apb21
                  AND rvv02 = g_apb[l_ac].apb22
               IF cl_null(l_rvv38t) THEN LET l_rvv38t=0 END IF
               #MOD-920013---Begin
               LET l_apb24t = l_rvv38t*g_apb[l_ac].apb09
               LET l_apb24t = cl_digcut(l_apb24t,t_azi04)
               LET g_apb[l_ac].apb24 = l_apb24t/(1+l_gec04/100)  
               #LET g_apb[l_ac].apb24 = (l_rvv38t*g_apb[l_ac].apb09)/
               #                        (1+l_gec04/100)
               #MOD-920013---End
            ELSE
               IF cl_null(l_rvv39t) THEN LET l_rvv39t=0 END IF
               LET l_rvv39t = cl_digcut(l_rvv39t,t_azi04)   #MOD-920013 
               LET g_apb[l_ac].apb24 = l_rvv39t/(1+l_gec04/100)
            END IF
         ELSE
            IF g_apb[l_ac].apb09>0 THEN
               LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
            ELSE
               IF g_apb[l_ac].apb24 = 0 THEN
                  LET g_apb[l_ac].apb24 = l_rvv39
               END IF
            END IF
         END IF
        #end TQC-8A0079 mod

         #-----No:MOD-910062-----
         IF g_apb[l_ac].apb09 = 0 THEN
            LET g_apb[l_ac].apb24 = l_rvv39
         END IF
         #-----No:MOD-910062 END-----
    
        #LET g_apb[l_ac].apb24 =cl_digcut(g_apb[l_ac].apb24,g_azi.azi04)   #MOD-6B0066
         LET g_apb[l_ac].apb24 =cl_digcut(g_apb[l_ac].apb24,t_azi04)   #MOD-6B0066
         LET g_apb[l_ac].apb10 =g_apb[l_ac].apb24 * g_apa.apa14        #MOD-840632   #MOD-860221 mark回復
        #LET g_apb[l_ac].apb10 =g_apb[l_ac].apb08 * g_apb[l_ac].apb09  #MOD-840632   #MOD-860221 mark
        #LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,t_azi.azi04)   #MOD-6B0066
         LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)   #MOD-6B0066
         #------No:MOD-5A0095 START-------------------
         DISPLAY BY NAME g_apb[l_ac].apb24
         DISPLAY BY NAME g_apb[l_ac].apb10
         #------No:MOD-5A0095 END---------------------
         #-----MOD-6A0025---------
         IF g_apb[l_ac].apb29 = '3' AND g_aptype = '11' THEN
           #LET g_apb[l_ac].apb23 = g_apb[l_ac].apb23 * -1    #No.TQC-7B0063 mark
            LET g_apb[l_ac].apb24 = g_apb[l_ac].apb24 * -1
           #LET g_apb[l_ac].apb08 = g_apb[l_ac].apb08 * -1    #No.TQC-7B0063 mark
            LET g_apb[l_ac].apb10 = g_apb[l_ac].apb10 * -1
            LET g_apb[l_ac].apb09 = g_apb[l_ac].apb09 * -1    #No.TQC-7B0063 add
           #DISPLAY BY NAME g_apb[l_ac].apb23,g_apb[l_ac].apb24,     #No.TQC-7B0063 mark  
           #                g_apb[l_ac].apb08,g_apb[l_ac].apb10      #No.TQC-7B0063 mark 
            DISPLAY BY NAME g_apb[l_ac].apb24,g_apb[l_ac].apb09,g_apb[l_ac].apb10      #No.TQC-7B0063
         END IF
         #-----END MOD-6A0025-----
         #FUN-670064...............begin
         LET g_apb[l_ac].apb930=l_rvv930
         LET g_apb[l_ac].gem02c=s_costcenter_desc(g_apb[l_ac].apb930)
         DISPLAY BY NAME g_apb[l_ac].apb930,g_apb[l_ac].gem02c
         #FUN-670064...............end
      END IF   #MOD-850316 add
   END IF   #MOD-850316 add
END FUNCTION

FUNCTION t110_apb07(p_cmd)
   DEFINE p_cmd           LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_pmm22         LIKE pmm_file.pmm22
   DEFINE l_pmn07         LIKE pmn_file.pmn07
   DEFINE l_pmn86         LIKE pmn_file.pmn86   #FUN-560070
   DEFINE l_pmn40         LIKE pmn_file.pmn40
   DEFINE l_pmn041        LIKE pmn_file.pmn041
   DEFINE l_pmn930        LIKE pmn_file.pmn930  #FUN-670064
   DEFINE l_pmn16         LIKE pmn_file.pmn16   #MOD-8A0051
  #DEFINE s_apb24         LIKE apb_file.apb24   #CHI-910035 add   #MOD-980032 mark
  #DEFINE l_pmn88         LIKE pmn_file.pmn88   #CHI-910035 add   #MOD-980032 mark
   DEFINE l_apb24         LIKE apb_file.apb24   #MOD-A30248 add
   DEFINE l_pmc913        LIKE pmc_file.pmc913  #MOD-A30248 add
   DEFINE l_aag21         LIKE aag_file.aag21   #MOD-A40102 add
   DEFINE l_aag211        LIKE aag_file.aag21   #MOD-A40102 add

   LET g_errno = ' '

   SELECT pmn04,pmn041,pmn87,pmn86,pmn31,pmn87*pmn31,pmm22,  #MOD-590342   #No:TQC-630044 modify   #MOD-6C0031
  #SELECT pmn04,pmn041,pmn20,pmn07,pmn31,pmn20*pmn31,pmm22,  #MOD-590342   #No:TQC-630044 modify   #MOD-6C0031
          pmn930,pmn16   #FUN-670064    #MOD-8A0051
  #SELECT pmn04,pmn041,rvv87,pmn86,pmn31,rvv87*pmn31,pmm22  #FUN-560070
     INTO g_apb[l_ac].apb12,g_apb[l_ac].apb27,g_apb[l_ac].apb09,
          g_apb[l_ac].apb28,g_apb[l_ac].apb23,g_apb[l_ac].apb24,l_pmm22,
          g_apb[l_ac].apb930,l_pmn16   #FUN-670064  #MOD-8A0051
     FROM pmn_file,pmm_file            #MOD-590342
    #FROM pmn_file,pmm_file,rvv_file   #FUN-560070
    WHERE pmn01=g_apb[l_ac].apb06 AND pmn02=g_apb[l_ac].apb07
      AND pmm01=pmn01                     #MOD-590342
     #AND pmm01=pmn01 AND pmm01 = rvv36   #FUN-560070

   CASE
      WHEN SQLCA.SQLCODE = 100
         LET g_errno = 'aap-092'
      WHEN l_pmn16 !='2'           #MOD-8A0051
         LET g_errno = 'aap-510'   #MOD-8A0051
      OTHERWISE
         LET g_errno = SQLCA.SQLCODE USING '-------'
   END CASE
 
  #MOD-A30248---add---start---
   SELECT pmc913 INTO l_pmc913 FROM pmc_file 
    WHERE pmc01 = g_apa.apa05
   IF g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y') THEN
      SELECT SUM(apb24) INTO l_apb24 FROM apb_file,apa_file
       WHERE apa01=apb01
         AND apb01!=g_apa.apa01 AND apa42='N'
         AND apb06=g_apb[l_ac].apb06 AND apb07=g_apb[l_ac].apb07 
         AND apa00 = '15'                                         #No.MOD-B90194 add
      IF cl_null(l_apb24) THEN
         LET l_apb24=0
      END IF
      IF g_apb[l_ac].apb24 > l_apb24 THEN
         LET g_apb[l_ac].apb24 = g_apb[l_ac].apb24 - l_apb24
      ELSE
         LET g_apb[l_ac].apb24 = 0
         LET g_errno = 'aap-937'
         RETURN 
      END IF
   END IF
  #MOD-A30248---add---end---
  #str MOD-980032 mark
  ##str CHI-910035 add
  ##採購單可能預付多次,aapt150需增加檢核預付是否已經超過採購單金額
  #IF g_aptype = '15' THEN
  #   #已立預付原幣金額
  #   LET s_apb24 = 0
  #   SELECT SUM(apb24) INTO s_apb24 FROM apb_file,apa_file
  #    WHERE apa01 =apb01             AND apa00 ='15'
  #      AND apb06 =g_apb[l_ac].apb06 AND apb07 =g_apb[l_ac].apb07
  #      AND (apb01!=g_apa.apa01      OR
  #           apb01 =g_apa.apa01     AND apb02!=g_apb[l_ac].apb02)
  #   IF cl_null(s_apb24) THEN LET s_apb24 = 0 END IF
  #   #採購單原幣金額
  #   LET l_pmn88 = 0
  #   SELECT (pmn87*pmn31) INTO l_pmn88 FROM pmn_file,pmm_file
  #    WHERE pmm01=pmn01
  #      AND pmn01=g_apb[l_ac].apb06 AND pmn02=g_apb[l_ac].apb07
  #   IF cl_null(l_pmn88) THEN LET l_pmn88 = 0 END IF
  #   LET l_pmn88 =cl_digcut(l_pmn88,t_azi04)
  #   
  #   IF g_apb[l_ac].apb24 > l_pmn88 - s_apb24 THEN
  #      LET g_errno = 'aap-937'
  #   END IF
  #END IF
  ##end CHI-910035 add
  #end MOD-980032 mark

   IF NOT cl_null(g_errno) THEN
      RETURN
   END IF

   IF g_apa.apa13 IS NULL THEN
      LET g_apa.apa13 = l_pmm22
   END IF

   IF l_pmm22 != g_apa.apa13 THEN                              # 幣別不符
      #-----MOD-770041---------
      LET g_errno = 'aap-041' 
      CALL cl_err(l_pmm22,'aap-041',0)
      IF NOT cl_null(g_errno) THEN #MOD-9A0143                                                                                      
         RETURN                    #MOD-9A0143                                                                                      
      END IF                       #MOD-9A0143      
     #CALL cl_getmsg('aap-041',g_lang) RETURNING g_msg
     #LET g_buf=g_msg[1,4],':',l_pmm22 ERROR g_buf
     #WHILE TRUE
     #   LET INT_FLAG = 0  ######add for prompt bug
     #   PROMPT g_msg CLIPPED FOR g_chr
     #      ON IDLE g_idle_seconds
     #         CALL cl_on_idle()
     #        #CONTINUE PROMPT
     #      ON ACTION about         #MOD-4C0121
     #         CALL cl_about()      #MOD-4C0121
     #      ON ACTION help          #MOD-4C0121
     #         CALL cl_show_help()  #MOD-4C0121
     #      ON ACTION controlg      #MOD-4C0121
     #         CALL cl_cmdask()     #MOD-4C0121
     #   END PROMPT
     #   CASE
     #      WHEN g_chr = '1'
     #         LET g_errno = 'aap-041'
     #         RETURN
     #      WHEN g_chr = '2'
     #         LET g_apa.apa13 = l_pmm22
     #         DISPLAY BY NAME g_apa.apa13
     #         UPDATE apa_file SET apa13 = g_apa.apa13
     #          WHERE apa01 = g_apa.apa01
     #   END CASE
     #   IF g_chr MATCHES "[123]" THEN
     #      EXIT WHILE
     #   END IF
     #END WHILE
      #-----END MOD-770041-----
   END IF

   LET g_apb[l_ac].apb23 =cl_digcut(g_apb[l_ac].apb23,t_azi03)   #MOD-8B0266 add
   LET g_apb[l_ac].apb24 =cl_digcut(g_apb[l_ac].apb24,t_azi04)   #MOD-8B0266 add
   LET g_apb[l_ac].apb08 =g_apb[l_ac].apb23 * g_apa.apa14
   LET g_apb[l_ac].apb08 =cl_digcut(g_apb[l_ac].apb08,g_azi03)   #MOD-6B0066
   LET g_apb[l_ac].apb10 =g_apb[l_ac].apb24 * g_apa.apa14        #MOD-840632   #MOD-860221 mark回復
  #LET g_apb[l_ac].apb10 =g_apb[l_ac].apb08 * g_apb[l_ac].apb09  #MOD-840632   #MOD-860221 mark
  #LET g_apb[l_ac].apb08 =cl_digcut(g_apb[l_ac].apb08,t_azi.azi03)   #MOD-6B0066
  #LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,t_azi.azi04)   #MOD-6B0066
   LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)   #MOD-6B0066
   DISPLAY BY NAME g_apb[l_ac].apb23   #MOD-8B0266 add
   DISPLAY BY NAME g_apb[l_ac].apb24   #MOD-8B0266 add
   DISPLAY BY NAME g_apb[l_ac].apb08   #No:MOD-5A0095
   DISPLAY BY NAME g_apb[l_ac].apb10   #No:MOD-5A0095
   #FUN-670064................begin
   LET g_apb[l_ac].gem02c=s_costcenter_desc(g_apb[l_ac].apb930)
   DISPLAY BY NAME g_apb[l_ac].apb930,g_apb[l_ac].gem02c
   #FUN-670064................end
  #MOD-A40102---add---start---
   SELECT aag21 INTO l_aag21 FROM aag_file
    WHERE aag01 = g_apa.apa51
      AND aag00 = g_bookno1  
      AND aagacti = 'Y'     #No.MOD-B70280 add
   SELECT aag21 INTO l_aag211 FROM aag_file
    WHERE aag01 = g_apa.apa511
      AND aag00 = g_bookno1  
      AND aagacti = 'Y'     #No.MOD-B70280 add
  #MOD-A40102---add---end---
   IF l_aag21 = 'Y' THEN        #MOD-A40102 add 
      LET g_apb[l_ac].apb25=g_apa.apa51   #MOD-920170 add
      DISPLAY BY NAME g_apb[l_ac].apb25   #MOD-920170 add
   END IF                       #MOD-A40102 add 
  #No.TQC-970195  --Begin
   IF l_aag211 = 'Y' THEN        #MOD-A40102 add 
      LET g_apb[l_ac].apb251=g_apa.apa511
      DISPLAY BY NAME g_apb[l_ac].apb251
   END IF                       #MOD-A40102 add 
   #No.TQC-970195  --End  
END FUNCTION
 
FUNCTION t110_b_askkey()
DEFINE
    #l_wc2           LIKE type_file.chr1000 #No.FUN-690028 VARCHAR(200)   #MOD-720062
    l_wc2           STRING   #MOD-720062

   IF g_apb_sarrno = 0 THEN
      RETURN
   END IF

   CONSTRUCT l_wc2 ON apb02,apb21,apb35,apb36,apb31,apb22,apb34,apb06,apb07,  #FUN-630055 add apb31  #No.TQC-7B0083   #FUN-810045 add apb35/36
                      apb12,apb27,   #CHI-B50012 add
                      apb09,apb25,apb26,apb23,apb24,apb08,apb10
                     #No:FUN-850038 --start--
                     ,apbud01,apbud02,apbud03,apbud04,apbud05
                     ,apbud06,apbud07,apbud08,apbud09,apbud10
                     ,apbud11,apbud12,apbud13,apbud14,apbud15
                     #No:FUN-850038 ---end---
           FROM s_apb[1].apb02,s_apb[1].apb21,
                s_apb[1].apb35,s_apb[1].apb36,  #FUN-810045 add
                s_apb[1].apb31,s_apb[1].apb22, #FUN-630055 add apb31
                s_apb[1].apb34,   #No.TQC-7B0083
                s_apb[1].apb06,s_apb[1].apb07,
                s_apb[1].apb12,s_apb[1].apb27,   #CHI-B50012 add
                s_apb[1].apb09,
                s_apb[1].apb25,s_apb[1].apb26,s_apb[1].apb23,
                s_apb[1].apb24,s_apb[1].apb08,s_apb[1].apb10
               #No:FUN-850038 --start--
               ,s_apb[1].apbud01,s_apb[1].apbud02,s_apb[1].apbud03
    	       ,s_apb[1].apbud04,s_apb[1].apbud05,s_apb[1].apbud06
               ,s_apb[1].apbud07,s_apb[1].apbud08,s_apb[1].apbud09
	       ,s_apb[1].apbud10,s_apb[1].apbud11,s_apb[1].apbud12
               ,s_apb[1].apbud13,s_apb[1].apbud14,s_apb[1].apbud15
               #No:FUN-850038 ---end---

      #No:FUN-580031 --start--     HCN
      BEFORE CONSTRUCT
         CALL cl_qbe_init()
      #No:FUN-580031 --end--       HCN

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE CONSTRUCT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
      #No:FUN-580031 --start--     HCN
      ON ACTION qbe_select
         CALL cl_qbe_select()
      ON ACTION qbe_save
         CALL cl_qbe_save()
      #No:FUN-580031 --end--       HCN
   END CONSTRUCT

   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF
   CALL t110_b_fill(l_wc2)

END FUNCTION

FUNCTION t110_b_fill(p_wc2)              #BODY FILL UP
DEFINE
   #p_wc2           LIKE type_file.chr1000 #No.FUN-690028 VARCHAR(200)   #MOD-720062
   p_wc2           STRING     #MOD-720062

   IF (g_aptype = '12' OR g_aptype = '13') AND l_apz59='N' THEN #TQC-A40106 change g_apz.apz59->l_apz59
      CALL t110_misc_display() RETURN
   END IF

   IF g_apb_sarrno = 0 THEN
      RETURN
   END IF

   IF cl_null(p_wc2) THEN
      LET p_wc2='1=1'
   END IF

 #FUN-810045 begin
   #LET g_sql = "SELECT apb02,apb33,apb11,apb29,apb21,apb31,apb30,apb22,apb34,'',",                           #FUN-680110 add '','' #No.FUN-690080  #No.TQC-7B0083
   #            "       apb06,apb07,apb12,apb27,",  #FUN-630055 add apb31
   #            "       apb09,apb28,apb32,apb25,'',apb251,'',apb26,'',apb930,'',apb23,apb24,apb08,apb10",  #FUN-710078 add '','','' #FUN-670064   #No.FUN-680029 #No.FUN-690080
   LET g_sql = "SELECT apb02,apb33,apb11,apb29,apb21,apb22,apb34,'',",                           #FUN-680110 add '','' #No.FUN-690080  #No.TQC-7B0083
               "       apb06,apb07,apb12,apb27,",  #FUN-630055 add apb31
             # "       apb09,apb28,apb35,apb36,apb31,apb30,apb32,apb25,'',apb251,'',apb26,'',apb930,'',apb23,apb24,apb08,apb10",  #FUN-710078 add '','','' #FUN-670064   #No.FUN-680029 #No.FUN-690080  #No.FUN-830161 remove apb30
               "       apb09,apb28,apb35,apb36,apb31,apb32,'',apb25,'',apb251,'',apb26,'',apb930,'',apb23,apb24,apb08,apb10,",  #FUN-710078 add '','','' #FUN-670064   #No.FUN-680029 #No.FUN-690080  #No.FUN-830161 remove apb30 #FUN-990025 ''
 #FUN-810045 end
             #No:FUN-850038 --start--
               "       apbud01,apbud02,apbud03,apbud04,apbud05,",
               "       apbud06,apbud07,apbud08,apbud09,apbud10,",
               "       apbud11,apbud12,apbud13,apbud14,apbud15 ",
             #No:FUN-850038 ---end---
               " FROM apb_file",                                      
               " WHERE apb01 ='",g_apa.apa01,"' AND ", p_wc2 CLIPPED, 
               " ORDER BY apb02"

   PREPARE t110_pb FROM g_sql
   DECLARE apb_curs CURSOR FOR t110_pb

   CALL g_apb.clear()
   LET g_cnt = 1

   FOREACH apb_curs INTO g_apb[g_cnt].*   #單身 ARRAY 填充
      IF SQLCA.sqlcode THEN
         CALL cl_err('foreach:',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
     #FUN-710078---add---str--- 
      SELECT aag02 INTO g_apb[g_cnt].b25 
        FROM aag_file 
       WHERE aag01=g_apb[g_cnt].apb25 
         AND aag00=g_bookno1   #MOD-840649
         AND aagacti = 'Y'     #No.MOD-B70280 add

      SELECT aag02 INTO g_apb[g_cnt].b251 
        FROM aag_file 
       WHERE aag01=g_apb[g_cnt].apb251 
         AND aag00=g_bookno2   #MOD-840649
         AND aagacti = 'Y'     #No.MOD-B70280 add

      SELECT gem02 INTO g_apb[g_cnt].b26 
        FROM gem_file 
       WHERE gem01=g_apb[g_cnt].apb26 
     #FUN-710078---add---end--- 
     
     #FUN-990025---Begin
     SELECT gen02 INTO g_apb[g_cnt].b32
       FROM gen_file
      WHERE gen01=g_apb[g_cnt].apb32
     #FUN-990025---End 

      #No.TQC-7B0083  --Begin
      ##start FUN-680110 add
      # #沖暫估否
      # LET g_apb[g_cnt].rvv40=t110_set_rvv40(g_apb[g_cnt].apb21,g_apb[g_cnt].apb22)
      # #暫估帳款單號
      # LET g_apb[g_cnt].apb01_unap=t110_set_apb01_unap(g_apb[g_cnt].apb21,g_apb[g_cnt].apb22)
      ##end FUN-680110 add
      #暫估帳款單號
      LET g_apb[g_cnt].apb01_unap=t110_set_apb01_unap(g_apb[g_cnt].apb21,g_apb[g_cnt].apb22,g_apb[g_cnt].apb34)
      #No.TQC-7B0083  --End  
      LET g_apb[g_cnt].gem02c=t110_set_apa930(g_apb[g_cnt].apb930) #FUN-670064
      LET g_cnt = g_cnt + 1
      IF g_cnt > g_max_rec THEN
         CALL cl_err( '', 9035, 0 )
         EXIT FOREACH
      END IF
   END FOREACH
   CALL g_apb.deleteElement(g_cnt)

   LET g_rec_b = g_cnt - 1
   DISPLAY g_rec_b TO FORMONLY.n2

END FUNCTION

FUNCTION t110_bp(p_ud)
   DEFINE   p_ud   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
 
   IF p_ud <> "G" OR g_action_choice = "detail" THEN
      RETURN
   END IF

   LET g_action_choice = " "
   #-----MOD-670131---------
   #IF g_aptype <> '11' THEN   #TQC-7B0117
   IF g_aptype <> '16' THEN   #TQC-7B0117
      CALL cl_set_act_visible("qry_contra_tmp_est",FALSE)
   END IF
   #-----END MOD-670131-----

   #-----TQC-620052---------
   CALL cl_set_act_visible("maintain_misc_vender",FALSE)
   #-----END TQC-620052-----
   #No.FUN-680029--begin
   IF g_aza.aza63 ='N' THEN
      #CALL cl_set_act_visible("entry_sheet2",FALSE)   #FUN-830091
      CALL cl_set_act_visible("entry_sheet2,T_T_entry_sheet2",FALSE)   #FUN-830091
   END IF
   #No.FUN-680029--end

  #IF g_aptype = '11' OR g_aptype = '15' OR g_aptype = '17' THEN  #No.FUN-690080
   IF                    g_aptype = '15' OR g_aptype = '17' THEN  #No.FUN-690080
      CALL cl_set_act_visible("contra_tmp_est",FALSE)
   END IF

   #-----MOD-610011---------
   #IF g_aptype = '11' THEN   #MOD-7B0091
#  IF g_aptype = '11' OR g_aptype = '16' THEN   #MOD-7B0091      #No.FUN-860004 Mark
   IF g_aptype = '11' THEN                                       #No.FUN-860004
      CALL cl_set_act_visible("reproduce",FALSE)
   END IF
   #-----END MOD-610011-----

   #No.FUN-690080 --Begin
   IF g_aptype = '13' THEN
      CALL cl_set_act_visible("contra_tmp_est,qry_bill_allowance",FALSE)
   ELSE
      CALL cl_set_act_visible("revert,revert_query",FALSE)
   END IF
   IF g_aptype = '17' THEN
      CALL cl_set_act_visible("contra_tmp_est,var_process,qry_contra_tmp_est,qry_bill_allowance",FALSE)
   END IF
   #No.FUN-690080 --End

   CALL cl_set_act_visible("revert",FALSE) #No.TQC-7C0134

   CALL cl_set_act_visible("accept,cancel", FALSE)

   DISPLAY ARRAY g_apb TO s_apb.* ATTRIBUTE(COUNT=g_rec_b,UNBUFFERED)

      BEFORE DISPLAY
         CALL cl_navigator_setting( g_curs_index, g_row_count )

         #MOD-490018
         IF (g_aptype = '12' OR g_aptype ='13') AND l_apz59='N' THEN  #TQC-A40106 change g_apz.apz59->l_apz59
            CALL cl_reset_local_action("detail",FALSE)
         END IF
         #--
         #-----TQC-6B0118---------
         ##FUN-630055 add --start--
         ##IF NOT(g_aptype = '12' OR g_aptype = '15' OR g_aptype = '13' OR g_aptype = '17') THEN  #No.FUN-690080   #MOD-690025
         #IF NOT(g_aptype = '15' OR g_aptype = '13' OR g_aptype = '17') THEN   #MOD-690025
         #   CALL cl_set_comp_visible("apb31",FALSE)
         #ELSE
         #   CALL cl_set_comp_visible("apb21",FALSE)
         #END IF
         ##FUN-630055 add --end--
        #IF g_aptype = '12' OR g_aptype = '15' OR   #FUN-7A0050 mark
         IF g_aptype = '15' OR                      #FUN-7A0050
            g_aptype = '13' OR g_aptype = '17' THEN
            CALL cl_set_comp_visible("apb21",FALSE)
         END IF
         #-----END TQC-6B0118-----

         #No.FUN-690080 --Begin
         IF g_aptype = '13' OR g_aptype = '17' THEN
            CALL cl_set_comp_visible("apb11,apb29,apb21,apb22,apb06,apb07,apb12,apb27,apb09,apb28,apb23,apb08",FALSE)
            IF g_aptype = '17' THEN
               CALL cl_set_comp_visible("apb33",FALSE)
            END IF
         ELSE
            #CALL cl_set_comp_visible("apb33,apb30,apb32",FALSE) #FUN-810045
            CALL cl_set_comp_visible("apb33,apb32,b32",FALSE)   #FUN-810045 #FUN-990025 add b32
         END IF
         CALL cl_set_comp_visible("apb051,apb251",g_aza.aza63='Y')
         #No.FUN-690080 --End

      BEFORE ROW
         LET l_ac = ARR_CURR()
#        CALL cl_show_rate_comment()   #No:FUN-530015
         CALL cl_show_fld_cont()
      ON ACTION locale
         CALL cl_dynamic_locale()
         CALL cl_show_fld_cont()   #FUN-550037(smin)
         CALL t110_misc_clear()   #MOD-750064
         IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
         CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti)

         #-----#No:FUN-960117 EBO add start -----
         IF g_aza.aza75 MATCHES '[Yy]' AND (g_prog='aapt110' OR g_prog='aapt120') THEN
            CALL aws_ebocli_toolbar()
            CALL cl_set_act_visible("ebo_status_query", TRUE)
            CALL cl_set_comp_visible("sendtype", TRUE)
            IF g_aza.aza77 MATCHES '[Yy]' THEN
               CALL cl_set_act_visible("ebo_transfer", TRUE)
            ELSE
               CALL cl_set_act_visible("ebo_transfer",FALSE)
            END IF
         ELSE
            CALL cl_set_act_visible("ebo_status_query",FALSE)
            CALL cl_set_act_visible("ebo_transfer",FALSE)
            CALL cl_set_comp_visible("sendtype", FALSE)
         END IF
         #-----#No:FUN-960117 EBO add end -----

         LET g_action_choice = 'locale'
         EXIT DISPLAY
      ON ACTION insert
         LET g_action_choice="insert"
         EXIT DISPLAY
      ON ACTION query
         LET g_action_choice="query"
         EXIT DISPLAY
      ON ACTION delete
         LET g_action_choice="delete"
         EXIT DISPLAY
      ON ACTION modify
         LET g_action_choice="modify"
         EXIT DISPLAY
#No.FUN-680027--begin
      ON ACTION account_period
         LET g_action_choice="account_period"
         EXIT DISPLAY
#No.FUN-680027--end   

      ON ACTION first
         CALL t110_fetch('F')
         CALL cl_navigator_setting(g_curs_index, g_row_count)
         IF g_rec_b != 0 THEN
             CALL fgl_set_arr_curr(1)
         END IF
         ACCEPT DISPLAY    #FUN-550037(smin)

      ON ACTION previous
         LET g_action_choice="previous"
          CALL t110_fetch('P')     #MOD-490490
         CALL cl_navigator_setting(g_curs_index, g_row_count)
         IF g_rec_b != 0 THEN
             CALL fgl_set_arr_curr(1)
         END IF
         ACCEPT DISPLAY    #FUN-550037(smin)

      ON ACTION jump
         LET g_action_choice="jump"
         CALL t110_fetch('/')
         CALL cl_navigator_setting(g_curs_index, g_row_count)
         IF g_rec_b != 0 THEN
             CALL fgl_set_arr_curr(1)
         END IF
         ACCEPT DISPLAY    #FUN-550037(smin)

      ON ACTION next
         LET g_action_choice="next"
         CALL t110_fetch('N')
         CALL cl_navigator_setting(g_curs_index, g_row_count)
         IF g_rec_b != 0 THEN
             CALL fgl_set_arr_curr(1)
         END IF
         ACCEPT DISPLAY    #FUN-550037(smin)

      ON ACTION last
         LET g_action_choice="last"
         CALL t110_fetch('L')
         CALL cl_navigator_setting(g_curs_index, g_row_count)
         IF g_rec_b != 0 THEN
             CALL fgl_set_arr_curr(1)
         END IF
         ACCEPT DISPLAY    #FUN-550037(smin)

      ON ACTION reproduce
         LET g_action_choice="reproduce"
         EXIT DISPLAY
      ON ACTION detail
         LET g_action_choice="detail"
         LET l_ac = 1
         EXIT DISPLAY
      ON ACTION output
         LET g_action_choice="output"
         EXIT DISPLAY
      ON ACTION help
         LET g_action_choice="help"
         EXIT DISPLAY
      ON ACTION exit
         LET g_action_choice="exit"
         EXIT DISPLAY
      ON ACTION controlg
         LET g_action_choice="controlg"
         EXIT DISPLAY
      ON ACTION accept
         LET g_action_choice="detail"
         LET l_ac = ARR_CURR()
         EXIT DISPLAY
      ON ACTION cancel
         LET INT_FLAG=FALSE 		#MOD-570244	mars
         LET g_action_choice="exit"
         EXIT DISPLAY

      ON ACTION on_hold      #留置
         LET g_action_choice="on_hold"
         EXIT DISPLAY

      ON ACTION undo_on_hold #取消留置
         LET g_action_choice="undo_on_hold"
         EXIT DISPLAY

      #--FUN-D30066 add start--
      ON ACTION undoapprove
         CALL t110_undoapprove()

      ON ACTION mod_account
         CALL t110_modaccount()
      #--FUN-D30066 add end--


      ON ACTION mul_invoice  #多發票
         LET g_action_choice="mul_invoice"
         EXIT DISPLAY

      ON ACTION single_invoice
         LET g_action_choice="single_invoice"
         EXIT DISPLAY

      ON ACTION mul_debit #多借方
         LET g_action_choice="mul_debit"
         EXIT DISPLAY

      ON ACTION contra_tmp_est #沖暫估
         LET g_action_choice="contra_tmp_est"
         EXIT DISPLAY

      ON ACTION memo #備註
         LET g_action_choice="memo"
         EXIT DISPLAY

      ON ACTION var_process #差異處理
         LET g_action_choice="var_process"
         EXIT DISPLAY

      ON ACTION contra #沖帳
         LET g_action_choice="contra"
         EXIT DISPLAY

      #No.FUN-690080 --Begin
      ON ACTION revert #還款
         LET g_action_choice="revert"
         EXIT DISPLAY

      ON ACTION revert_query #還款查詢
         LET g_action_choice="revert_query"
         EXIT DISPLAY
      #No.FUN-690080 --End

      ON ACTION modify_date #日期修正
         LET g_action_choice="modify_date"
         EXIT DISPLAY

      ON ACTION pay_direct #直接付款
         LET g_action_choice="pay_direct"
         EXIT DISPLAY

      ON ACTION gen_entry #會計分錄產生
         LET g_action_choice="gen_entry"
         EXIT DISPLAY

      ON ACTION entry_sheet #分錄底稿
         LET g_action_choice="entry_sheet"
         EXIT DISPLAY

#No.FUN-680029--begin
      ON ACTION entry_sheet2 #分錄底稿
         LET g_action_choice="entry_sheet2"
         EXIT DISPLAY
#No.FUN-680029--end

      #-----FUN-830091---------
      ON ACTION T_T_entry_sheet #分錄底稿
         LET g_action_choice="T_T_entry_sheet"
         EXIT DISPLAY

      ON ACTION T_T_entry_sheet2 #分錄底稿2
         LET g_action_choice="T_T_entry_sheet2"
         EXIT DISPLAY
      #-----END FUN-830091-----

      #No.FUN-670060 --start--
      ON ACTION carry_voucher #傳票拋轉  
         LET g_action_choice="carry_voucher"  
         EXIT DISPLAY

      ON ACTION undo_carry_voucher #傳票拋轉還原 
         LET g_action_choice="undo_carry_voucher" 
         EXIT DISPLAY
      #No.FUN-670060 --end--

      #FUN-5C0023 add--start
      ON ACTION appor_expense
         LET g_action_choice="appor_expense"
         EXIT DISPLAY
      #FUN-5C0023 add--end

      #t110_s()
      ON ACTION qry_contra_tmp_est
         LET g_action_choice="qry_contra_tmp_est"
         EXIT DISPLAY

      ON ACTION qry_bill_allowance
         LET g_action_choice="qry_bill_allowance"
         EXIT DISPLAY

      ON ACTION qry_contra #沖帳查詢
         LET g_action_choice="qry_contra"
         EXIT DISPLAY

#t110_s() end
    #@ON ACTION easyflow送簽
     ON ACTION easyflow_approval         #FUN-550042
       LET g_action_choice = "easyflow_approval"
       EXIT DISPLAY

      ON ACTION confirm #確認
         LET g_action_choice="confirm"
         EXIT DISPLAY

      ON ACTION undo_confirm #取消確認
         LET g_action_choice="undo_confirm"
         EXIT DISPLAY

      ON ACTION void #作廢
         LET g_action_choice="void"
         EXIT DISPLAY

       #MOD-540018
      #ON ACTION entry_detail
      #   LET g_action_choice="entry_detail"
      #   EXIT DISPLAY

      ON ACTION maintain_misc_vender
         LET g_action_choice="qry_vender"
         EXIT DISPLAY

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE DISPLAY
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      #FUN-4B0009
      ON ACTION exporttoexcel
         LET g_action_choice = 'exporttoexcel'
         EXIT DISPLAY

#FUN-580114
      ON ACTION agree
         LET g_action_choice = 'agree'
         EXIT DISPLAY

      ON ACTION deny
         LET g_action_choice = 'deny'
         EXIT DISPLAY

      ON ACTION modify_flow
         LET g_action_choice = 'modify_flow'
         EXIT DISPLAY

      ON ACTION withdraw
         LET g_action_choice = 'withdraw'
         EXIT DISPLAY

      ON ACTION org_withdraw
         LET g_action_choice = 'org_withdraw'
         EXIT DISPLAY

      ON ACTION phrase
         LET g_action_choice = 'phrase'
         EXIT DISPLAY
#END FUN-580114

      #@ON ACTION 簽核狀況
       ON ACTION approval_status     #MOD-4C0041
         LET g_action_choice="approval_status"
         EXIT DISPLAY

      ON ACTION related_document                #No:FUN-6A0016  相關文件
         LET g_action_choice="related_document"          
         EXIT DISPLAY

      #FUN-550037(smin)
      AFTER DISPLAY
        CONTINUE DISPLAY
      #END FUN-550037(smin)

      #--------#No:FUN-960117 EBO add start -------
      #@ON ACTION EBO狀態查詢
      ON ACTION ebo_status_query
         LET g_action_choice="ebo_status_query"
         EXIT DISPLAY
 
      #@ON ACTION EBO拋轉
      ON ACTION ebo_transfer
         LET g_action_choice="ebo_transfer"
         EXIT DISPLAY
      #--------#No:FUN-960117 EBO add end   --------
      
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033

    #FUN-810046
      &include "qry_string.4gl"
#No.FUN-A30106 --begin
      ON ACTION drill_down
         LET g_action_choice="drill_down"
         EXIT DISPLAY
#No.FUN-A30106 --end
   END DISPLAY
   CALL cl_set_act_visible("accept,cancel", TRUE)

END FUNCTION

FUNCTION t210_bp(p_ud)

   DEFINE   p_ud   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)

   IF p_ud <> "G" OR g_action_choice = "detail" THEN
      RETURN
   END IF

   LET g_action_choice = " "

   CALL cl_set_act_visible("accept,cancel", FALSE)
   #FUN-640181---start---
   IF g_aza.aza23 matches '[ Nn]' THEN
     CALL cl_set_act_visible("easyflow_approval,approval_status",FALSE)
   END IF
   #FUN-640181---end---

   #CALL cl_set_act_visible("mul_invoice", FALSE)   #MOD-790057 #CHI-A40005 mark
   #No.FUN-990017  --Begin
   #CALL cl_set_act_visible("offset_contra", TRUE)  #MOD-860332 add
   #IF g_aza.aza26='2' THEN                     #No:9467
   #   #CALL cl_set_act_visible("mul_invoice", FALSE)   #MOD-790057
   #  #str MOD-860332 add
   #   IF g_apa.apa08='UNAP' THEN
   #      CALL cl_set_act_visible("offset_contra", FALSE)
   #   END IF
   #  #end MOD-860332 add
   #ELSE  #FUN-580012
   #   CALL cl_set_act_visible("offset_contra", FALSE)
   #END IF
   #No.FUN-990017  --End  
   #No.FUN-680029--begin
   IF g_aza.aza63 ='N' THEN
      #CALL cl_set_act_visible("entry_sheet2",FALSE)   #FUN-830091
      CALL cl_set_act_visible("entry_sheet2,T_T_entry_sheet2",FALSE)   #FUN-830091
   END IF
   #No.FUN-680029--end

   DISPLAY ARRAY g_apb TO s_apb.* ATTRIBUTE(COUNT=g_rec_b)

      BEFORE DISPLAY
         CALL cl_navigator_setting( g_curs_index, g_row_count )
 
         #-----TQC-6B0118--------- 
         ##FUN-630055 add --start--
         ##IF NOT(g_aptype = '12' OR g_aptype = '15' OR g_aptype = '13' OR g_aptype = '17') THEN  #No.FUN-690080   #MOD-690025
         #IF NOT(g_aptype = '15' OR g_aptype = '13' OR g_aptype = '17') THEN  #No.FUN-690080   #MOD-690025
         #   CALL cl_set_comp_visible("apb31",FALSE)
         #ELSE
         #   CALL cl_set_comp_visible("apb21",FALSE)
         #END IF
         ##FUN-630055 add --end--
        #IF g_aptype = '12' OR g_aptype = '15' OR   #FUN-7A0050 mark
         IF g_aptype = '15' OR                      #FUN-7A0050
            g_aptype = '13' OR g_aptype = '17' THEN
            CALL cl_set_comp_visible("apb21",FALSE)
         END IF
         #-----END TQC-6B0118-----


      BEFORE ROW
         LET l_ac = ARR_CURR()
         CALL cl_show_fld_cont()     #FUN-550037(smin)

      ON ACTION locale
         CALL cl_dynamic_locale()
         CALL cl_show_fld_cont()   #FUN-550037(smin)
         LET g_chr2= 'N'
         CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti)
         LET g_action_choice = 'locale'
         EXIT DISPLAY
      ON ACTION insert
         LET g_action_choice="insert"
         EXIT DISPLAY
      ON ACTION query
         LET g_action_choice="query"
         EXIT DISPLAY
      ON ACTION delete
         LET g_action_choice="delete"
         EXIT DISPLAY
      ON ACTION modify
         LET g_action_choice="modify"
         EXIT DISPLAY
      ON ACTION first
         LET g_action_choice="first"
         EXIT DISPLAY
         ACCEPT DISPLAY    #FUN-550037(smin)
      ON ACTION previous
         LET g_action_choice="previous"
         EXIT DISPLAY
         ACCEPT DISPLAY    #FUN-550037(smin)
      ON ACTION jump
         LET g_action_choice="jump"
         EXIT DISPLAY
         ACCEPT DISPLAY    #FUN-550037(smin)
      ON ACTION next
         LET g_action_choice="next"
         EXIT DISPLAY
         ACCEPT DISPLAY    #FUN-550037(smin)
      ON ACTION last
         LET g_action_choice="last"
         EXIT DISPLAY
         ACCEPT DISPLAY    #FUN-550037(smin)
      ON ACTION detail
         LET g_action_choice="detail"
         LET l_ac = 1
         EXIT DISPLAY
      ON ACTION help
         LET g_action_choice="help"
         EXIT DISPLAY
      ON ACTION exit
         LET g_action_choice="exit"
         EXIT DISPLAY
#No.FUN-680027--begin
      ON ACTION account_period
         LET g_action_choice="account_period"
         EXIT DISPLAY
#No.FUN-680027--end   
       #-----No:MOD-4C0113-----
      ON ACTION output
         LET g_action_choice="output"
         EXIT DISPLAY
       #-----No:MOD-4C0113 END-----

      ON ACTION controlg
         LET g_action_choice="controlg"
         EXIT DISPLAY

      #No.TQC-7B0083  --Begin
      ON ACTION contra_tmp_est #沖暫估
         LET g_action_choice="contra_tmp_est"
         EXIT DISPLAY
      #No.TQC-7B0083  --End  

      ON ACTION gen_entry #會計分錄產生
         LET g_action_choice="gen_entry"
         EXIT DISPLAY

      ON ACTION entry_sheet #分錄底稿
         LET g_action_choice="entry_sheet"
         EXIT DISPLAY

#No.FUN-680029--begin
      ON ACTION entry_sheet2 #分錄底稿
         LET g_action_choice="entry_sheet2"
         EXIT DISPLAY
#No.FUN-680029--end

      #-----FUN-830091---------
      ON ACTION T_T_entry_sheet #分錄底稿
         LET g_action_choice="T_T_entry_sheet"
         EXIT DISPLAY

      ON ACTION T_T_entry_sheet2 #分錄底稿2
         LET g_action_choice="T_T_entry_sheet2"
         EXIT DISPLAY
      #-----END FUN-830091-----

      #No.FUN-670060 --start--
      ON ACTION carry_voucher #傳票拋轉  
         LET g_action_choice="carry_voucher"  
         EXIT DISPLAY

      ON ACTION undo_carry_voucher #傳票拋轉還原 
         LET g_action_choice="undo_carry_voucher" 
         EXIT DISPLAY
      #No.FUN-670060 --end--

      ON ACTION void #作廢
         LET g_action_choice="void"
         EXIT DISPLAY

      ON ACTION on_hold #留置
         LET g_action_choice="on_hold"
         EXIT DISPLAY

      ON ACTION undo_on_hold #取消留置
         LET g_action_choice="undo_on_hold"
         EXIT DISPLAY

      #--FUN-D30066 add start--
      ON ACTION undoapprove
         CALL t110_undoapprove()

      ON ACTION mod_account
         CALL t110_modaccount()
      #--FUN-D30066 add end--

      ON ACTION mul_invoice #多發票
         LET g_action_choice="mul_invoice"
         EXIT DISPLAY

#MOD-5B0338
     ON ACTION invoice_detail  #發票明細
        LET g_action_choice="invoice_detail"
        EXIT DISPLAY
#END MOD-5B0338

     #MOD-9C0437---add---start---
      ON ACTION single_invoice
         LET g_action_choice="single_invoice"
         EXIT DISPLAY
     #MOD-9C0437---add---end---

      #No.FUN-990017  --Begin
      ##FUN-580012  --begin
      #ON ACTION offset_contra #待扺衝帳
      #   LET g_action_choice="offset_contra"
      #   EXIT DISPLAY
      ##FUN-580012  --end
      #No.FUN-990017  --End  

      ON ACTION qry_contra #沖帳查詢
         LET g_action_choice="qry_contra"
         EXIT DISPLAY

      ON ACTION memo #備註
         LET g_action_choice="memo"
         EXIT DISPLAY

    #@ON ACTION easyflow送簽
      ON ACTION easyflow_approval         #FUN-550042
         LET g_action_choice = "easyflow_approval"
         EXIT DISPLAY

      ON ACTION confirm #確認
         LET g_action_choice="confirm"
         EXIT DISPLAY

      ON ACTION undo_confirm #取消確認
         LET g_action_choice="undo_confirm"
         EXIT DISPLAY

      ON ACTION accept
         LET g_action_choice="detail"
         LET l_ac = ARR_CURR()
         EXIT DISPLAY
 
      ON ACTION cancel
             LET INT_FLAG=FALSE 		#MOD-570244	mars
         LET g_action_choice="exit"
         EXIT DISPLAY

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE DISPLAY
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      #FUN-4B0009
      ON ACTION exporttoexcel
         LET g_action_choice = 'exporttoexcel'
         EXIT DISPLAY

#FUN-580114
      ON ACTION agree
         LET g_action_choice = 'agree'
         EXIT DISPLAY

      ON ACTION deny
         LET g_action_choice = 'deny'
         EXIT DISPLAY

      ON ACTION modify_flow
         LET g_action_choice = 'modify_flow'
         EXIT DISPLAY

      ON ACTION withdraw
         LET g_action_choice = 'withdraw'
         EXIT DISPLAY

      ON ACTION org_withdraw
         LET g_action_choice = 'org_withdraw'
         EXIT DISPLAY

      ON ACTION phrase
         LET g_action_choice = 'phrase'
         EXIT DISPLAY
#END FUN-580114

      #--
      #@ON ACTION 簽核狀況
       ON ACTION approval_status     #MOD-4C0041
         LET g_action_choice="approval_status"
         EXIT DISPLAY

      ON ACTION related_document                #No:FUN-6A0016  相關文件
         LET g_action_choice="related_document"          
         EXIT DISPLAY

      #FUN-550037(smin)
      AFTER DISPLAY
        CONTINUE DISPLAY
      #END FUN-550037(smin)
      
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033

    #FUN-810046
      &include "qry_string.4gl"
#No.FUN-A30106 --begin
      ON ACTION drill_down
         LET g_action_choice="drill_down"
         EXIT DISPLAY
#No.FUN-A30106 --end
   END DISPLAY
   CALL cl_set_act_visible("accept,cancel", TRUE) 
END FUNCTION


FUNCTION t110_copy()
DEFINE   li_result   LIKE type_file.num5    #No.FUN-690028 SMALLINT
DEFINE
   l_apa        RECORD LIKE apa_file.*,
   l_apb        RECORD LIKE apb_file.*,
   l_t1            LIKE apa_file.apa01,
   l_oldno,l_newno LIKE aba_file.aba01,
   l_date          LIKE apa_file.apa02,
   l_apb02         LIKE apb_file.apb02      #No.FUN-860004
DEFINE   l_sql     String                   #No.TQC-7B0098
DEFINE   l_apc     RECORD LIKE apc_file.*   #No.TQC-7B0098
DEFINE   g_t1      LIKE oay_file.oayslip    #FUN-990014 add
DEFINE   l_apa02   LIKE apa_file.apa02      #MOD-A50098
DEFINE   l_paydate LIKE type_file.dat       #MOD-A50098
DEFINE   l_apb23   LIKE apb_file.apb23      #MOD-AB0069
DEFINE   l_apb24   LIKE apb_file.apb24      #MOD-AB0069
DEFINE   l_apb08   LIKE apb_file.apb08      #MOD-AB0069
DEFINE   l_apb081  LIKE apb_file.apb081     #MOD-AB0069
DEFINE   l_apb10   LIKE apb_file.apb10      #MOD-AB0069
DEFINE   l_apb101  LIKE apb_file.apb101     #MOD-AB0069

   IF s_aapshut(0) THEN
      RETURN
   END IF

   IF cl_null(g_apa.apa01)  THEN
       CALL cl_err('',-400,0)
       RETURN
   END IF

   LET l_apa.* = g_apa.*
   LET g_apa_t.* = g_apa.*       #BACKUP  #MOD-B40036  
   INITIALIZE g_apa_o.* TO NULL      #MOD-AB0069
   LET g_apa_o.apa14 = g_apa.apa14   #MOD-AB0069 
   LET l_apa.apa173 = ''             #MOD-B90110
   LET l_apa.apa174 = ''             #MOD-B90110
   LET l_apa.apa175 = ''             #MOD-B90110
   BEGIN WORK                        #MOD-CA0106 add
   LET g_before_input_done = FALSE   #FUN-570158
   CALL t110_set_entry('a')          #FUN-570158
   CALL t110_set_entry_1()     #No:FUN-8A0075
   LET g_before_input_done = TRUE    #FUN-570158
   CALL cl_set_head_visible("","YES")#No.FUN-6B0033

WHILE TRUE                           #MOD-BC0238 add
  #INPUT l_date,l_newno FROM apa02,apa01            #MOD-CA0106 mark
   INPUT l_newno,l_date FROM apa01,apa02            #MOD-CA0106 add
#No.FUN-550030--begin
       BEFORE INPUT
          CALL cl_set_docno_format("apa01")
#No.FUN-550030--end
       #modi 01/08/10 (先輸入日期，以輸入日期取單號)
       BEFORE FIELD apa02
          LET l_date = g_today
          DISPLAY l_date TO apa02

       AFTER FIELD apa02
          IF NOT cl_null(l_date) THEN
             CALL t110_bookno()     #No.FUN-730064
             IF l_date <= g_apz.apz57 THEN   #立帳日期不可小於關帳日期
                CALL cl_err('','aap-176',1) NEXT FIELD apa02
             END IF
         #END IF    #MOD-A50098 mark
 
         #-MOD-A50098-add-
             LET l_apa.apa09 = l_date 
             LET g_apa.apa09 = l_date 
             
             IF g_aptype[1,1] = '1' AND   
                 g_apa.apa11 IS NOT NULL AND
                 l_date != l_apa02 AND l_apa02 IS NOT NULL THEN       
                IF g_aptype = '13' OR g_aptype = '17' THEN
                   CALL s_paydate('a','',g_apa.apa09,l_date,g_apa.apa11,'EMPL')
                        RETURNING l_paydate,l_apa.apa64,l_apa.apa24
                ELSE
                   CALL s_paydate('a','',g_apa.apa09,l_date,g_apa.apa11,g_apa.apa06)
                        RETURNING l_paydate,l_apa.apa64,l_apa.apa24
                END IF
                IF NOT cl_null(g_errno) THEN
                   CALL cl_err(g_apa.apa01,g_errno,0)
                   LET l_apa.apa64 = g_apa_t.apa64
                   LET l_apa.apa24 = g_apa_t.apa24
                ELSE
                   LET l_apa.apa12 = l_paydate
                END IF
                DISPLAY BY NAME g_apa.apa24,g_apa.apa12,g_apa.apa64
               #CHI-AB0017 add --start--
               IF g_apa.apa24 < 0 THEN
                  IF NOT cl_confirm('aap-142') THEN NEXT FIELD apa02 END IF
               END IF
               #CHI-AB0017 add --end--
             END IF
             IF l_date != l_apa02 THEN     
               #LET g_apa.apa02 = l_date        #MOD-AB0038                        #MOD-AB0069 mark 
               #CALL t110_apa13('u')                                               #MOD-AB0069 mark 
                CALL s_curr3(l_apa.apa13,l_date,g_apz.apz33) RETURNING g_apa.apa14 #MOD-AB0069  
                LET l_apa.apa14 = g_apa.apa14   #MOD-AB0038 
                DISPLAY BY NAME g_apa.apa14                                        #MOD-AB0069
#-----------------------------No.MOD-B70202-------------------------------------------------start
                IF l_apa.apa14 != g_apa_t.apa14 THEN
                   IF NOT t110_apa14(g_apa.apa01) THEN
                      NEXT FIELD apa02
                   END IF
                END IF
#-----------------------------No.MOD-B70202-------------------------------------------------end 
             END IF
          END IF
          LET l_apa02 = l_date              
         #-MOD-A50098-end-

       AFTER FIELD apa01
          IF NOT cl_null(l_newno) THEN
#MOD-580051
            LET l_t1=l_newno[1,g_doc_len]
            #-->讀取單據性質資料
            SELECT * INTO g_apy.* FROM apy_file
             WHERE apyslip=l_t1 AND apyacti = 'Y' AND apykind=g_apa.apa00
            IF SQLCA.sqlcode THEN
#              CALL cl_err(l_t1,"agl-035",0)   #No.FUN-660122
               CALL cl_err3("sel","apy_file",l_t1,"","agl-035","","",1)  #No.FUN-660122
               NEXT FIELD apa01
            END IF
           #------------------------------MOD-CA0106----------------------------------------mark
           #IF g_apy.apyauno='Y' THEN
           #   BEGIN WORK
           #   CALL s_auto_assign_no("aap",l_t1,l_date,g_apa.apa00,"apa_file","apa01","","","")
           #     RETURNING li_result,l_newno
           #   IF NOT li_result THEN
           #      LET INT_FLAG = 1
           #      EXIT INPUT
           #   END IF
           #END IF
           #------------------------------MOD-CA0106----------------------------------------mark
            SELECT count(*) INTO g_cnt FROM apa_file WHERE apa01 = l_newno
            IF g_cnt > 0 THEN
               CALL cl_err(l_newno,-239,0)
               NEXT FIELD apa01
            END IF
#No.FUN-550030--begin
#           CALL s_check_no("aap",l_newno,"","g_apa.apa00","apa_file","apa01","") RETURNING li_result,l_newno
#           DISPLAY l_newno TO apa01
#           IF (NOT li_result) THEN
#              LET g_apa.apa01 = g_apa_o.apa01
#              NEXT FIELD pmw01
#           END IF
#END MOD-580051
#            LET l_t1=l_newno[1,3]
#            #-->讀取單據性質資料
#            SELECT * INTO g_apy.* FROM apy_file
#             WHERE apyslip=l_t1 AND apyacti = 'Y'
#            IF SQLCA.sqlcode THEN
#               CALL cl_err(l_t1,"agl-035",0)
#               NEXT FIELD apa01
#            END IF
#            IF g_apy.apyauno='Y' THEN
#               CALL s_apyauno(l_t1,l_date,g_apa.apa00)
#                 RETURNING g_i,l_newno
#               IF g_i THEN
#                  LET INT_FLAG = 1
#                  EXIT INPUT
#               END IF
#            END IF
#            SELECT count(*) INTO g_cnt FROM apa_file WHERE apa01 = l_newno
#            IF g_cnt > 0 THEN
#               CALL cl_err(l_newno,-239,0)
#               NEXT FIELD apa01
#            END IF
#No.FUN-550030--end
           #---------------------MOD-CA0106---------------(S)
            CALL s_check_no("aap",l_newno,'',g_aptype,"apa_file","apa01","")
            RETURNING li_result,l_newno
            IF (NOT li_result) THEN
               NEXT FIELD apa01
            END IF
           #---------------------MOD-CA0106---------------(E)
          END IF

       ON ACTION CONTROLP
          CASE
             WHEN INFIELD(apa01) #查詢單据
#No.FUN-550030--begin
#               LET l_t1=l_newno[1,3]
                LET l_t1=s_get_doc_no(l_newno)
                #CALL q_apy(FALSE,FALSE,l_t1,g_aptype,g_sys) RETURNING l_t1   #TQC-670008
                CALL q_apy(FALSE,FALSE,l_t1,g_aptype,'AAP') RETURNING l_t1    #TQC-670008
#                CALL FGL_DIALOG_SETBUFFER( l_t1 )
#               LET l_newno[1,3]=l_t1
                LET l_newno=l_t1
#No.FUN-550030--end
                DISPLAY l_newno TO apa01
                NEXT FIELD apa01
           END CASE

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
 
      #-----No:9770------------------
      AFTER INPUT
      IF INT_FLAG THEN
         LET INT_FLAG = 0
         DISPLAY BY NAME g_apa.apa01
#No.FUN-550030--begin
         ROLLBACK WORK
         LET g_apa.* = g_apa_t.*       #MOD-B40036
#No.FUN-550030--end
         RETURN
      END IF
      IF cl_null(l_newno) THEN
         NEXT FIELD apa01
      END IF
      #-----END----------------------

   END INPUT

   IF INT_FLAG THEN
      LET INT_FLAG = 0
      DISPLAY BY NAME g_apa.apa01
#No.FUN-550030--begin
      ROLLBACK WORK
      LET g_apa.* = g_apa_t.*       #MOD-B40036
#No.FUN-550030--end
      RETURN
   END IF
#------------------------MOD-CA0106--------------------------------------------(S)
   IF g_apy.apyauno='Y' THEN
      CALL s_auto_assign_no("aap",l_t1,l_date,g_apa.apa00,"apa_file","apa01","","","")
           RETURNING li_result,l_newno
      IF NOT li_result THEN
         CONTINUE WHILE
      END IF
      DISPLAY l_newno TO apa01
     #EXIT WHILE                          
   END IF
   EXIT WHILE                            
END WHILE
#------------------------MOD-CA0106--------------------------------------------(E)

   LET l_apa.apa01  =l_newno   #新的鍵值 
  #-MOD-AB0069-add-
   IF g_apa_o.apa14 <> l_apa.apa14 THEN     
      LET l_apa.apa31 = l_apa.apa31f * l_apa.apa14
      LET l_apa.apa31 = cl_digcut(l_apa.apa31,g_azi04)   
      LET l_apa.apa32 = l_apa.apa31 * l_apa.apa16 / 100
      LET l_apa.apa32 = cl_digcut(l_apa.apa32,g_azi04)  
      LET l_apa.apa34 = l_apa.apa31 + l_apa.apa32 - l_apa.apa60 - l_apa.apa61
                                                  - l_apa.apa65 + l_apa.apa37
      LET l_apa.apa34 = cl_digcut(l_apa.apa34,g_azi04)   
   END IF
  #-MOD-AB0069-end-
   #-----No:9770-------------------
   IF cl_null(l_apa.apa01) THEN
      RETURN
   END IF
   #-----END-----------------------
   LET l_apa.apa02  =l_date
   IF g_aptype!='16' THEN   #MOD-940158 add
      LET l_apa.apa08 = ''
      LET l_apa.apa09 = ''  #MOD-970221 
   END IF                   #MOD-940158 add
   LET l_apa.apa19  = ' '
   LET l_apa.apa20  = 0
   LET l_apa.apa35f = 0
   LET l_apa.apa35  = 0
  #-MOD-AB0069-add-
   LET l_apa.apa57 = l_apa.apa31
   LET l_apa.apa57f = l_apa.apa31f
   LET g_apa.apa57 = l_apa.apa57
   DISPLAY BY NAME g_apa.apa57
  #-MOD-AB0069-end-
   LET l_apa.apa60  = 0
   LET l_apa.apa61  = 0
   LET l_apa.apa60f = 0
   LET l_apa.apa61f = 0
   LET l_apa.apa65  = 0
   LET l_apa.apa65f = 0
   LET l_apa.apa55  = '1'
  #LET l_apa.apainpd=g_user      #MOD-A50086 mark
   LET l_apa.apainpd=g_today     #MOD-A50086 add
   LET l_apa.apa43  = NULL
   LET l_apa.apa44  = NULL
   LET l_apa.apa56  = 0
   LET l_apa.apa58  = NULL
   LET l_apa.apa59  = NULL
   LET l_apa.apa41  = 'N'
   LET l_apa.apa42  = 'N'
   LET l_apa.apa74  = 'N'
   LET l_apa.apa75 = 'N'
   LET l_apa.apaprno= 0        #列印次數
   LET l_apa.apauser=g_user    #資料所有者
   LET l_apa.apagrup=g_grup    #資料所有者所屬群
   LET l_apa.apamodu=NULL      #資料修改日期
   LET l_apa.apadate=g_today   #資料建立日期
   LET l_apa.apaacti='Y'       #有效資料
   LET l_apa.apa72=l_apa.apa14
   LET l_apa.apa73=l_apa.apa34-l_apa.apa35
   LET l_apa.apa77=g_apa.apa77  #FUN-970108 add
    ### MOD-4A0253
     LET l_apa.apa63 = '0'
     LET l_apa.apamksg = g_apy.apyapr
    ### END MOD-4A0253
   #No.FUN-860004-Add-Begin--#                                                                                                      
   IF g_aptype = '16' THEN                                                                                                          
      LET l_apa.apa57f = 0                                                                                                          
      LET l_apa.apa57 = 0                                                                                                           
      SELECT SUM(apb24),SUM(apb10) INTO l_apa.apa57f,l_apa.apa57                                                                    
        FROM apb_file                                                                                                               
       WHERE apb01=g_apa.apa01                                                                                                      
         AND apb21 IS NULL                                                                                                          
      IF cl_null(l_apa.apa57f) THEN                                                                                                 
         LET l_apa.apa57f = 0                                                                                                       
      END IF                                                                                                                        
      IF cl_null(l_apa.apa57) THEN                                                                                                  
         LET l_apa.apa57 = 0                                                                                                        
      END IF                                                                                                                        
   END IF                                                                                                                           
   #No.FUN-860004-Add-End--#
   #FUN-990014--Begin
   CALL s_get_doc_no(l_apa.apa01) RETURNING g_t1
   SELECT apyvcode INTO l_apa.apa77  FROM apy_file WHERE apyslip = g_t1   
     IF cl_null(l_apa.apa77) THEN 
        LET l_apa.apa77 = g_apz.apz63  #FUN-970108 add
     END IF     
   #FUN-990014---End    
   INSERT INTO apa_file VALUES (l_apa.*)
   IF SQLCA.sqlcode THEN
#     CALL cl_err('ins apa:',SQLCA.sqlcode,0)   #No.FUN-660122
      CALL cl_err3("ins","apa_file",l_apa.apa01,"",SQLCA.sqlcode,"","ins apa:",1)  #No.FUN-660122
#No.FUN-550030--begin
      ROLLBACK WORK
      LET g_apa.* = g_apa_t.*       #MOD-B40036
#No.FUN-550030--end
      RETURN
   ELSE
      #No.TQC-7B0098 --start--
      LET l_sql = "SELECT * FROM apc_file",
                  " WHERE apc01 = '",g_apa.apa01,"'"
      PREPARE t110_apc_p1 FROM l_sql
      DECLARE t110_apc_c1 CURSOR FOR t110_apc_p1
      OPEN t110_apc_c1
      FOREACH t110_apc_c1 INTO l_apc.*
         IF STATUS THEN
            CALL cl_err('foreach:',STATUS,1)
            ROLLBACK WORK
            LET g_apa.* = g_apa_t.*       #MOD-B40036
            RETURN
         END IF
         LET l_apc.apc01 = l_apa.apa01
         #-----MOD-830244---------
         LET l_apc.apc10 = 0
         LET l_apc.apc11 = 0 
         LET l_apc.apc12 = ''
         LET l_apc.apc13 = l_apc.apc09 - l_apc.apc11
         LET l_apc.apc14 = 0
         LET l_apc.apc15 = 0 
         LET l_apc.apc16 = 0
         #-----END MOD-830244----- 
         INSERT INTO apc_file VALUES (l_apc.*)
         IF SQLCA.sqlcode THEN
            CALL cl_err3("ins","apc_file",l_apc.apc01,"",SQLCA.sqlcode,"","ins apc:",1)
            ROLLBACK WORK
            LET g_apa.* = g_apa_t.*       #MOD-B40036
            RETURN
         END IF
      END FOREACH
      #No.TQC-7B0098 --end--
      COMMIT WORK
   END IF

   DROP TABLE x

   #No.FUN-860004-Add-Begin--#
   IF g_aptype = '16' THEN
      SELECT * FROM apb_file
       WHERE apb01=g_apa.apa01
         AND apb21 IS NULL
        INTO TEMP x
   ELSE
      SELECT * FROM apb_file 
       WHERE apb01=g_apa.apa01
        INTO TEMP x
   END IF 
   #No.FUN-860004-Add-End--#

#  SELECT * FROM apb_file         #單身複製                      #FUN-860004 
#   WHERE apb01=g_apa.apa01                                      #FUN-860004
#    INTO TEMP x                                                 #FUN-860004
   IF SQLCA.sqlcode THEN
#     CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)                   #No.FUN-660122
      CALL cl_err3("ins","x","","",SQLCA.sqlcode,"","",1)        #No.FUN-660122
      RETURN
   END IF

   UPDATE x SET apb01=l_newno

   #No.FUN-860004-Add-Begin--#
  #-MOD-AB0069-mark- 
  #IF g_aptype = '16' THEN                                     
  #   LET i =1
  #   LET l_sql ="SELECT apb02 FROM x WHERE apb01=l_newno ORDER BY apb02 "          
  #   PREPARE t110_apb_pb1 FROM l_sql                                                                                                       
  #   DECLARE apb_curs1 CURSOR FOR t110_apb_pb1
  #   FOREACH apb_curs1 INTO l_apb02                   
  #     UPDATE x SET apb02 = i WHERE apb02 = l_apb02
  #      LET i = i+1
  #   END FOREACH  
  #END IF      
  #-MOD-AB0069-end- 
   #No.FUN-860004-Add-End--#

   INSERT INTO apb_file SELECT * FROM x
   IF SQLCA.sqlcode THEN
#     CALL cl_err('ins apb:',SQLCA.sqlcode,0)   #No.FUN-660122
      CALL cl_err3("ins","apb_file",l_newno,"",SQLCA.sqlcode,"","ins apb:",1)  #No.FUN-660122
      RETURN
   END IF

   LET g_cnt=SQLCA.SQLERRD[3]
   MESSAGE '(',g_cnt USING '##&',') ROW of (',l_newno,') O.K'
  #-MOD-AB0069-add- 
   IF g_aptype = '16' OR (g_apa_o.apa14 <> l_apa.apa14) THEN 
      LET i =1
      LET l_sql ="SELECT apb02,apb23,apb24 FROM apb_file WHERE apb01='",l_newno,"' ORDER BY apb02 "  
      PREPARE t110_apb_pb2 FROM l_sql                                                                                                       
      DECLARE apb_curs2 CURSOR FOR t110_apb_pb2
      FOREACH apb_curs2 INTO l_apb02,l_apb23,l_apb24 
         LET l_apb08 = l_apb23 * l_apa.apa14
         LET l_apb08 = cl_digcut(l_apb08,g_azi03)   
         LET l_apb10 = l_apb24 * l_apa.apa14   
         LET l_apb10 = cl_digcut(l_apb10,g_azi04)   
         LET l_apb081= l_apb08
         LET l_apb101= l_apb10
         UPDATE apb_file SET apb02 = i,apb08 = l_apb08,apb10 = l_apb10,apb081 = l_apb08,apb101 = l_apb10
          WHERE apb01 = l_newno 
            AND apb02 = l_apb02 
         LET i = i+1
      END FOREACH  
   END IF      
  #-MOD-AB0069-end- 
   #--NO.FUN-5C0031 START---------
   DROP TABLE y

   SELECT * FROM api_file         #多借方複製
    WHERE api01=g_apa.apa01
     INTO TEMP y
   IF SQLCA.sqlcode THEN
#     CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)   #No.FUN-660122
      CALL cl_err3("ins","y","","",SQLCA.sqlcode,"","",1)  #No.FUN-660122
      RETURN
   END IF

   UPDATE y SET api01=l_newno

   INSERT INTO api_file SELECT * FROM y
   IF SQLCA.sqlcode THEN
#     CALL cl_err('ins api:',SQLCA.sqlcode,0)   #No.FUN-660122
      CALL cl_err3("ins","api_file",l_newno,"",SQLCA.sqlcode,"","ins api:",1)  #No.FUN-660122
      RETURN
   END IF

   LET g_cnt=SQLCA.SQLERRD[3]
   MESSAGE '(',g_cnt USING '##&',') ROW of (',l_newno,') O.K'
   #--NO.FUN-5C0031 END-----------

   LET l_oldno = g_apa.apa01

   SELECT ROWID,apa_file.* INTO g_apa_rowid,g_apa.* FROM apa_file
    WHERE apa01 = l_newno

   CALL t110_u()
#  CALL t110_b('a')                                      #FUN-860004 Mark

   SELECT ROWID,apa_file.* INTO g_apa_rowid,g_apa.* FROM apa_file
    WHERE apa01 = l_oldno

   CALL t110_show()

END FUNCTION

#------------------------------------MOD-B70202--------------------------------add
FUNCTION t110_apa14(p_apa01)
 DEFINE l_apb02  LIKE apb_file.apb02,
        l_apb08  LIKE apb_file.apb08,
        l_apb081 LIKE apb_file.apb081,
        l_apb09  LIKE apb_file.apb09,
        l_apb23  LIKE apb_file.apb23,
        l_apb24  LIKE apb_file.apb24,
        l_apb10  LIKE apb_file.apb10,
        l_apb101 LIKE apb_file.apb101,
        p_apa01  LIKE apa_file.apa01,
        l_apa32  LIKE apa_file.apa32    #No.MOD-B80140 add
 DEFINE g_apk    RECORD LIKE apk_file.*      #MOD-C30916 add

   LET g_apa.apa01=p_apa01

  #str TQC-B80049 add
   LET g_cnt = 0
   SELECT COUNT(*) INTO g_cnt FROM apb_file
    WHERE apb01=g_apa.apa01
   IF cl_null(g_cnt) THEN LET g_cnt=0 END IF
  #end TQC-B80049 add

   IF g_cnt > 0 THEN
      IF NOT cl_confirm('aap-331') THEN
         #-----MOD-640473---------
          #NEXT FIELD NEXT
         CALL cl_err('','aap-888',1)
         LET g_apa.apa14 = g_apa_t.apa14
         DISPLAY BY NAME g_apa.apa14
        #NEXT FIELD apa14
         RETURN FALSE 
         #-----END MOD-640473-----
      END IF
   
      DECLARE upd_apb_cs CURSOR FOR
         SELECT apb23,apb09,apb02,apb24   #MOD-860221 add apb24
           FROM apb_file
          WHERE apb01=g_apa.apa01
      FOREACH upd_apb_cs INTO l_apb23,l_apb09,l_apb02,l_apb24  #MOD-860221 add l_apb24
         LET l_apb08 = l_apb23 * g_apa.apa14
        #LET l_apb08 = cl_digcut(l_apb08,t_azi.azi03)   #MOD-6B0066
         LET l_apb08 = cl_digcut(l_apb08,g_azi03)   #MOD-6B0066
        #LET l_apb10 = l_apb09 * l_apb08       #MOD-860221 mark
         LET l_apb10 = l_apb24 * g_apa.apa14   #MOD-860221
        #LET l_apb10 = cl_digcut(l_apb10,t_azi.azi04)   #MOD-6B0066
         LET l_apb10 = cl_digcut(l_apb10,g_azi04)   #MOD-6B0066
         LET l_apb081= l_apb08
         LET l_apb101= l_apb10
   
         UPDATE apb_file SET apb08 = l_apb08,
                             apb081= l_apb081,
                             apb10 = l_apb10,
                             apb101= l_apb101
          WHERE apb01 = g_apa.apa01
            AND apb02 = l_apb02
         IF STATUS OR SQLCA.SQLCODE THEN
           #CALL cl_err('upd apb:',SQLCA.SQLCODE,0)   #No.FUN-660122
            CALL cl_err3("upd","apb_file",g_apa.apa11,l_apb02,SQLCA.sqlcode,"","upd apb:",1)  #No.FU
            LET g_apa.apa14 = g_apa_t.apa14
            DISPLAY BY NAME g_apa.apa14
           #NEXT FIELD apa14
            RETURN FALSE 
            EXIT FOREACH
         END IF
      END FOREACH
        #-------------------------------------MOD-C50228----------------------------(S)
         SELECT SUM(apb24),SUM(apb10) INTO g_amt1f,g_amt1 FROM apb_file
          WHERE apb01 = g_apa.apa01 AND apb29='1'
         IF g_amt1 IS NULL THEN
            LET g_amt1 = 0
            LET g_amt1f = 0
         END IF
         SELECT SUM(apb24),SUM(apb10) INTO g_amt2f,g_amt2 FROM apb_file
          WHERE apb01 = g_apa.apa01 AND apb29 = '3'
         IF g_amt2 IS NULL THEN
            LET g_amt2 = 0
            LET g_amt2f = 0
         END IF
         IF g_aptype MATCHES '1*' AND g_aptype <> '15' AND g_aptype <> '17' THEN
            LET g_apa.apa57 = g_amt1 + g_amt2
            LET g_apa.apa57f = g_amt1f + g_amt2f
         END IF
         IF g_aptype MATCHES '2*' THEN
            LET g_apa.apa57 = g_amt2 + g_amt1
            LET g_apa.apa57f = g_amt2f + g_amt1f
         END IF
         IF g_aptype = '15' OR g_aptype = '17' OR g_aptype = '16' THEN
            SELECT SUM(apb24),SUM(apb10) INTO g_apa.apa57f,g_apa.apa57
             FROM apb_file WHERE apb01 = g_apa.apa01
         END IF
         IF g_apa.apa57f IS NULL THEN
            LET g_apa.apa57f = 0
         END IF
         IF g_apa.apa57  IS NULL THEN
            LET g_apa.apa57 = 0
         END IF
         LET g_apa.apa57f=cl_digcut(g_apa.apa57f,t_azi04)
         LET g_apa.apa57=cl_digcut(g_apa.apa57,g_azi04)
         UPDATE apa_file SET apa57 = g_apa.apa57,
                             apa57f = g_apa.apa57f
          WHERE apa01 = g_apa.apa01
         DISPLAY BY NAME g_apa.apa57
        #-------------------------------------MOD-C50228----------------------------(E)
      CALL t110_b_fill(' 1=1')
      CALL t110_sum_apa()
   ELSE
     #雜項帳款有可能沒有單身資料
     #IF g_apa.apa00='12' THEN   #MOD-590460
     #IF g_apa.apa00='12' OR g_apa.apa00='15' THEN   #MOD-590460   #MOD-640473
      IF g_apa.apa00='12' OR g_apa.apa00='15' OR g_apa.apa00='16' OR  #MOD-640473  #MOD-870215 add 1
         g_apa.apa00='21' OR g_apa.apa00='13' OR g_apa.apa00='17' OR  #MOD-590460  #MOD-640473  #No.
         g_apa.apa00='22' THEN   #MOD-9B0168 add
         LET g_apa.apa31 = g_apa.apa31f * g_apa.apa14
        #LET g_apa.apa31 = cl_digcut(g_apa.apa31,t_azi.azi04)   #MOD-6B0066
         LET g_apa.apa31 = cl_digcut(g_apa.apa31,g_azi04)   #MOD-6B0066
         LET g_apa.apa32 = g_apa.apa31 * g_apa.apa16 / 100
         CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
         LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
        #LET g_apa.apa32 = cl_digcut(g_apa.apa32,t_azi.azi04)   #MOD-6B0066
         LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)   #MOD-6B0066
         DISPLAY BY NAME g_apa.apa31
         DISPLAY BY NAME g_apa.apa32
         CALL t110_apa34f('0')   #TQC-750140
         CALL t110_unpay()
       END IF
   END IF
  #----------------------MOD-C30916-------------------(S)
   DECLARE curr_apk CURSOR FOR
    SELECT * FROM apk_file WHERE apk01 = g_apa.apa01

   FOREACH curr_apk INTO g_apk.*
      LET g_apk.apk13 = g_apa.apa14
      LET g_apk.apk08 = g_apk.apk08f * g_apk.apk13
      LET g_apk.apk07 = g_apk.apk07f * g_apk.apk13
      LET g_apk.apk06 = g_apk.apk07 + g_apk.apk08        #含稅金額

      LET g_apk.apk06 = cl_digcut(g_apk.apk06,g_azi04)
      LET g_apk.apk07 = cl_digcut(g_apk.apk07,g_azi04)
      LET g_apk.apk08 = cl_digcut(g_apk.apk08,g_azi04)

      UPDATE apk_file SET apk13 = g_apa.apa14,
                          apk06 = g_apk.apk06,
                          apk07 = g_apk.apk07,
                          apk08 = g_apk.apk08
       WHERE apk01 = g_apk.apk01
         AND apk02 = g_apk.apk02
         AND apk03 = g_apk.apk03

      IF STATUS OR SQLCA.SQLCODE THEN
         CALL cl_err3("upd","apk_file",g_apk.apk01,g_apk.apk02,SQLCA.sqlcode,"","upd apk",1)
         ROLLBACK WORK
         LET g_apa.* = g_apa_t.*
         RETURN
      END IF
   END FOREACH
  #-------------------------MOD-C30916-----------------------(E)
   RETURN TRUE
END FUNCTION
#-------------------------------No.MOD-B70202------------------------------------------end 
FUNCTION t110_misc_clear()
   DEFINE i,j,k     LIKE type_file.num5    #No.FUN-690028 SMALLINT
 
    #MOD-490018
   IF (g_aptype = '12' OR g_aptype = '13') AND l_apz59='N' THEN  #No.FUN-690080   #TQC-A40106 change g_apz.apz59->l_apz59
      CALL t110_set_attr()
   END IF
   #--

END FUNCTION
#------------------------------------------------------No.MOD-B80140--------------------------start
FUNCTION t110_apa32()
   DEFINE l_cnt    SMALLINT
   DEFINE t_apa31 LIKE apa_file.apa31
   DEFINE t_apa32 LIKE apa_file.apa32
   DEFINE l_apa32 LIKE apa_file.apa32

   SELECT COUNT(*) INTO l_cnt
     FROM apa_file WHERE apa01 IN (
   SELECT apa08 FROM apv_file,apa_file
    WHERE apv01 = g_apa.apa01 AND apa01 = apv03)
   IF l_cnt > 0 THEN
      LET t_apa31 = 0
      LET t_apa32 = 0
      SELECT SUM(apa31),SUM(apa32) INTO t_apa31,t_apa32
        FROM apa_file WHERE apa01 IN (
      SELECT apa08 FROM apv_file,apa_file
       WHERE apv01 = g_apa.apa01 AND apa01 = apv03)
      IF cl_null(t_apa31)  THEN LET t_apa31 = 0 END IF
      IF cl_null(t_apa32)  THEN LET t_apa32 = 0 END IF
      LET l_apa32 = g_apa.apa31 * g_apa.apa16 / 100
      LET l_apa32 = cl_digcut(l_apa32,g_azi04)
      #從沖帳資料(aapq230)串回aapt150,看當初立預付是否有稅額,
      #若有的話,l_apa32應再扣掉aapt150的稅額
      IF g_apa.apa31 >= t_apa31  THEN
         LET l_apa32 = l_apa32 - t_apa32
         LET l_apa32 = cl_digcut(l_apa32,g_azi04)
      ELSE
         LET l_apa32 = 0
      END IF
   ELSE
      LET l_apa32 = g_apa.apa32
   END IF
   RETURN l_apa32
END FUNCTION

FUNCTION t110_apa32f()
   DEFINE l_cnt    SMALLINT
   DEFINE t_apa31f LIKE apa_file.apa31f
   DEFINE t_apa32f LIKE apa_file.apa32f
   DEFINE l_apa32f LIKE apa_file.apa32f

   SELECT COUNT(*) INTO l_cnt
     FROM apa_file WHERE apa01 IN (
   SELECT apa08 FROM apv_file,apa_file
    WHERE apv01 = g_apa.apa01 AND apa01 = apv03)

   IF l_cnt > 0 THEN
      LET t_apa31f= 0
      LET t_apa32f= 0
      SELECT SUM(apa31f),SUM(apa32f) INTO t_apa31f,t_apa32f
        FROM apa_file WHERE apa01 IN (
      SELECT apa08 FROM apv_file,apa_file
       WHERE apv01 = g_apa.apa01 AND apa01 = apv03)
      IF cl_null(t_apa32f) THEN LET t_apa32f= 0 END IF
      IF cl_null(t_apa32f) THEN LET t_apa32f= 0 END IF
      LET l_apa32f = g_apa.apa31f * g_apa.apa16 / 100
      LET l_apa32f = cl_digcut(l_apa32f,t_azi04)
      #從沖帳資料(aapq230)串回aapt150,看當初立預付是否有稅額,
      #若有的話,l_apa32f應再扣掉aapt150的稅額
      IF g_apa.apa31f >= t_apa31f THEN
         LET l_apa32f= l_apa32f- t_apa32f
         LET l_apa32f = cl_digcut(l_apa32f,t_azi04)
      ELSE
         LET l_apa32f = 0
      END IF
   ELSE
     LET l_apa32f = g_apa.apa32f
   END IF
      RETURN l_apa32f
END FUNCTION

#----------------------------------------No.MOD-B80140------------------------------------end
FUNCTION t110_misc_display()
  DEFINE l_apk     RECORD LIKE apk_file.*
  DEFINE l_api     RECORD LIKE api_file.*
  DEFINE l_str     ARRAY[40] OF LIKE type_file.chr1000     # No:FUN-690028 VARCHAR(77)
  DEFINE i,j,k     LIKE type_file.num5    #No.FUN-690028 SMALLINT

   #MOD-490018
  CALL g_apb.clear()
  LET i=1
  DECLARE m1_c CURSOR FOR
   SELECT apk03,apk04,apk08,apk171 FROM apk_file WHERE apk01=g_apa.apa01
  FOREACH m1_c INTO g_apb[i].apb12,
                    g_apb[i].apb27,
                    g_apb[i].apb09,
                    g_apb[i].apb28
     LET g_apb[i].apb02=i
     LET i=i+1
  END FOREACH
  LET i=1
  DECLARE m2_c CURSOR FOR
  #SELECT api26,api04,api07,api05 FROM api_file WHERE api01=g_apa.apa01
   SELECT api04[1,20],api07,api05 FROM api_file
    WHERE api01=g_apa.apa01
      AND api02='1'
  FOREACH m2_c INTO g_apb[i].apb25,
                    g_apb[i].apb26,
                    g_apb[i].apb23
     LET g_apb[i].apb02=i
     LET i=i+1
  END FOREACH
 #LET g_rec_b=g_apb.getLength()          #MOD-A50098 mark
  LET g_rec_b=g_apb.getLength() - 1      #MOD-A50098
  DISPLAY g_rec_b TO FORMONLY.n2
  DISPLAY ' '     TO apa57
  #--
END FUNCTION

FUNCTION t110_out(p_cmd)
   DEFINE l_cmd              LIKE type_file.chr1000, #No.FUN-690028 VARCHAR(400)
          #l_wc,l_wc2    LIKE type_file.chr1000, #No.FUN-690028 VARCHAR(300)   #MOD-720062
          l_wc    STRING, #MOD-720062
          l_wc2   LIKE type_file.chr1000,   #MOD-720062
          l_prtway      LIKE zz_file.zz22,
          p_cmd         LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)

   CALL cl_wait()
   LET p_cmd= 'a'
   IF p_cmd= 'a'
   THEN LET l_wc = 'apa01="',g_apa.apa01,'"'           # "新增"則印單張
   ELSE LET l_wc = g_wc CLIPPED,                         # 其他則印多張
                   '   AND apa00 = "',g_aptype,'"'
        IF g_wc IS NULL THEN
           CALL cl_err('','9057',0) END IF
   END IF
   SELECT zz22 INTO l_prtway FROM zz_file WHERE zz01 = g_prog
   IF SQLCA.sqlcode OR l_wc2 IS NULL OR l_wc = ' ' THEN
      IF g_apa.apa00='11' THEN
         LET l_wc2 = " 'Y' 'N' 'N' 'N' 'N' '1' '3'"
      END IF
      IF g_apa.apa00='12' THEN
         LET l_wc2 = " 'Y' 'N' 'N' 'N' 'N' '2' '3'"
      END IF
      IF g_apa.apa00='15' THEN
         LET l_wc2 = " 'Y' 'N' 'N' 'N' 'Y' '3' '3'"  #MOD-550108
      END IF
      #NO.FUN-690080 --Begin
      IF g_apa.apa00='13' THEN
         LET l_wc2 = " 'Y' 'N' 'N' 'N' 'Y' '5' '3'"  #MOD-550108   #MOD-7C0201
      END IF
      IF g_apa.apa00='17' THEN
         LET l_wc2 = " 'Y' 'N' 'N' 'N' 'Y' '4' '3'"  #MOD-550108   #MOD-7C0201
      END IF
      #NO.FUN-690080 --End
   END IF
   #-----MOD-6C0164---------
   IF g_apa.apa08 = 'MISC' THEN
      LET l_wc2 = l_wc2[1,5],"'Y'",l_wc2[9,28]
   END IF
   #-----END MOD-6C0164-----
   #95/11/07 By Danny
   LET l_cmd = "aapr111 ",
               " '",g_today CLIPPED,"' ''",
               #" '",g_lang CLIPPED,"' 'Y' '",l_prtway,"' '1'",' ',   #MOD-670075
               " '",g_lang CLIPPED,"' 'Y' '",l_prtway,"' '1'",   #MOD-670075
#               "'",l_wc CLIPPED,"'",' ',l_wc2 clipped
               #" '",l_wc CLIPPED,"' 'Y'",'',l_wc2 clipped   #NO.MOD-5B0135   #MOD-670075
               " '",l_wc CLIPPED,"'",l_wc2 clipped   #NO.MOD-5B0135   #MOD-670075

   CALL cl_cmdrun(l_cmd)
   ERROR ' '
END FUNCTION

FUNCTION t110_bu(u_sw,r_sw)
   DEFINE u_sw,r_sw           LIKE type_file.num5        # No:FUN-690028 SMALLINT
   IF g_aptype='11' THEN CALL t110_bu_11(u_sw,r_sw) END IF
  #IF g_aptype='21' AND g_apa.apa58='2' THEN CALL t110_bu_21(u_sw,r_sw) END IF #MOD-AA0116 mark
   IF g_aptype='21' THEN CALL t110_bu_21(u_sw,r_sw) END IF                     #MOD-AA0116
   #No.TQC-7B0083  --Begin
   IF g_aptype='16' THEN CALL t110_bu_11(u_sw,r_sw) END IF
  #IF g_aptype='26' AND g_apa.apa58='2' THEN CALL t110_bu_21(u_sw,r_sw) END IF #MOD-AA0116 mark
   IF g_aptype='26' THEN CALL t110_bu_21(u_sw,r_sw) END IF                     #MOD-AA0116
   #No.TQC-7B0083  --End  
 
END FUNCTION

FUNCTION t110_bu_11(u_sw,r_sw)
   #DEFINE l_rvv03                 VARCHAR(1)            #FUN-660117 remark
   DEFINE l_rvv03                 LIKE rvv_file.rvv03 #FUN-660117
   DEFINE u_sw,r_sw               LIKE type_file.num5        # No:FUN-690028 SMALLINT
   DEFINE l_qty,l_qty2            LIKE ima_file.ima26      # No:FUN-690028 DEC(15,3)  #FUN-4B0079
   DEFINE l_qty_rvv88             LIKE rvv_file.rvv23      #No.TQC-7B0083
   DEFINE l_qty_rvv23_rvv88       LIKE rvv_file.rvv23      #No.TQC-7B0083
   DEFINE l_rvv40                 LIKE rvv_file.rvv40      #No.TQC-750181
   DEFINE l_apb09                 LIKE apb_file.apb09      #No.TQC-750181
   DEFINE l_n                     LIKE type_file.num5      #No.TQC-750181
   DEFINE l_qty3                  LIKE rvv_file.rvv23      #No.TQC-7B0083
   DEFINE l_qty_rvv88_3           LIKE rvv_file.rvv23      #No.TQC-7B0083
   DEFINE l_qty_rvv23_rvv88_3     LIKE rvv_file.rvv23      #No.TQC-7B0083

   IF u_sw = 1 AND r_sw = 1 AND g_apb_t.apb21 = g_apb[l_ac].apb21
      AND g_apb_t.apb22 = g_apb[l_ac].apb22 THEN
      LET u_sw = 1
      LET r_sw = 0
   END IF

   IF u_sw = 1 THEN
    #str CHI-B30009 mark
    ##-MOD-B10211-add-
    # IF cl_null(g_apb04) OR cl_null(g_apb[l_ac].apb21) THEN
    #    RETURN
    # END IF
    ##-MOD-B10211-end-
    #end CHI-B30009 mark
      IF NOT cl_null(g_apb04) AND NOT cl_null(g_apb05) THEN   #CHI-B30009 add
         LET l_qty=0 LET l_qty2=0
         SELECT SUM(apb09) INTO l_qty FROM apb_file,apa_file
          WHERE apb04 = g_apb04 AND apb05 = g_apb05
            AND apb01 = apa01 AND apa00 = '11'
            AND apa42 = 'N'
            AND apb29 = '1'  #TQC-7B0083
         IF STATUS THEN
#           CALL cl_err('sum(apb09)',STATUS,1)   #No.FUN-660122
            CALL cl_err3("sel","apb_file,apa_file",g_apb04,g_apb05,STATUS,"","sum(apb09)",1)  #No.FUN-660122
            LET g_success='N'
         END IF

         IF l_qty IS NULL THEN
            LET l_qty = 0
         END IF

         #No.TQC-7B0083  --Begin
         CALL t110_rvb06_1(g_apb04,g_apb05) 
              RETURNING l_qty_rvv88,l_qty_rvv23_rvv88
         #No.TQC-7B0083  --End

        #UPDATE rvb_file SET rvb06 = l_qty                                #No.TQC-7B0083
                            #rvb06 = 已請款數量 + 暫估數量 (去掉已衝暫估,否則數量變大)
         UPDATE rvb_file SET rvb06 = l_qty+l_qty_rvv88-l_qty_rvv23_rvv88  #No.TQC-7B0083
          WHERE rvb01 = g_apb04 AND rvb02 = g_apb05
         IF STATUS OR SQLCA.SQLCODE THEN
#           CALL cl_err('upd rvb06',SQLCA.SQLCODE,1)   #No.FUN-660122
            CALL cl_err3("upd","rvb_file",g_apb04,g_apb05,SQLCA.sqlcode,"","upd rvb06",1)  #No.FUN-660122
            LET g_success='N'
         END IF
      END IF   #CHI-B30009 add

      IF NOT cl_null(g_apb[l_ac].apb21) AND NOT cl_null(g_apb[l_ac].apb22) THEN   #CHI-B30009 add
         LET l_qty=0
         SELECT SUM(apb09) INTO l_qty FROM apb_file,apa_file
          WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
            AND apb01 = apa01 AND apa00 = '11'
            AND apa42 = 'N'
         IF STATUS THEN
#           CALL cl_err('sum(apb09)',STATUS,1)  #No.FUN-660122
            CALL cl_err3("sel","apb_file,apa_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","sum(apb09)",1)  #No.FUN-660122
            LET g_success='N'
         END IF

         IF l_qty IS NULL THEN
            LET l_qty = 0
         END IF

         #No.TQC-7B0083  --Begin
         IF l_qty < 0 THEN
            LET l_qty = l_qty * -1
         END IF
         #No.TQC-7B0083  --End  

         #No.TQC-7B0083  --Begin
         #若性質apb29='3'的倉退作業,則要額外select 21
         LET l_qty3 = 0
         SELECT SUM(apb09) INTO l_qty3 FROM apb_file,apa_file
          WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
            AND apb01 = apa01 AND apa00 = '21'
            AND apa42 = 'N'
         IF STATUS THEN
            CALL cl_err3("sel","apb_file,apa_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","sum(apb09)",1)  #No.FUN-660122
            LET g_success='N'
         END IF

         IF l_qty3 IS NULL THEN
            LET l_qty3 = 0
         END IF

         LET l_qty = l_qty + l_qty3
         #No.TQC-7B0083  --End  

         SELECT SUM(ale06) INTO l_qty2 FROM ale_file
          WHERE ale16 = g_apb[l_ac].apb21
            AND ale17 = g_apb[l_ac].apb22
         IF STATUS THEN
#           CALL cl_err('sum(ale06)',STATUS,1)  #No.FUN-660122
            CALL cl_err3("sel","ale_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","sum(ale06)",1)  #No.FUN-660122
            LET g_success='N'
         END IF

         IF l_qty2 IS NULL THEN
            LET l_qty2 = 0
         END IF

         LET l_qty=l_qty+l_qty2

         #No.TQC-7B0083  --Begin
         CALL t110_rvv23_rvv88(g_apb[l_ac].apb21,g_apb[l_ac].apb22,'11','16')
              RETURNING l_qty_rvv88,l_qty_rvv23_rvv88
         CALL t110_rvv23_rvv88(g_apb[l_ac].apb21,g_apb[l_ac].apb22,'21','26')
              RETURNING l_qty_rvv88_3,l_qty_rvv23_rvv88_3
         LET l_qty_rvv88 = l_qty_rvv88 + l_qty_rvv88_3
         LET l_qty_rvv23_rvv88 = l_qty_rvv23_rvv88 + l_qty_rvv23_rvv88_3
         #No.TQC-7B0083  --End

         UPDATE rvv_file SET rvv23 = l_qty,
                             #暫估數量rvv88=已暫估量-衝暫估量
                             rvv88 = l_qty_rvv88 - l_qty_rvv23_rvv88   #No.TQC-7B0083
          WHERE rvv01 = g_apb[l_ac].apb21
            AND rvv02 = g_apb[l_ac].apb22
         IF STATUS OR SQLCA.SQLCODE THEN
#           CALL cl_err('upd rvv23',SQLCA.SQLCODE,1)   #No.FUN-660122
            CALL cl_err3("upd","rvv_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,SQLCA.sqlcode,"","upd rvv23",1)  #No.FUN-660122
            LET g_success='N'
         END IF
      END IF   #CHI-B30009 add
   END IF

   IF r_sw = 1 THEN
    #str CHI-B30009 mark
    ##-MOD-B10211-add-
    # IF cl_null(g_apb04_t) OR cl_null(g_apb_t.apb21) THEN
    #    RETURN
    # END IF
    ##-MOD-B10211-end-
    #end CHI-B30009 mark
      IF NOT cl_null(g_apb04_t) AND NOT cl_null(g_apb05_t) THEN   #CHI-B30009 add
         LET l_qty=0 LET l_qty2=0
         SELECT SUM(apb09) INTO l_qty FROM apb_file,apa_file
          WHERE apb04 = g_apb04_t AND apb05 = g_apb05_t
            AND apb01 = apa01 AND apa00 = '11'
            AND apa42 = 'N'
            AND apb29 = '1'   #No.TQC-7B0083
         IF STATUS THEN
#           CALL cl_err('sum(apb09)',STATUS,1)    #No.FUN-660122
            CALL cl_err3("sel","apb_file,apa_file",g_apb04_t,g_apb05_t,STATUS,"","sum(apb09)",1)  #No.FUN-660122
            LET g_success='N'
         END IF

         IF l_qty IS NULL THEN
            LET l_qty = 0
         END IF

         #No.TQC-7B0083  --Begin
         CALL t110_rvb06_1(g_apb04_t,g_apb05_t)
              RETURNING l_qty_rvv88,l_qty_rvv23_rvv88
         #No.TQC-7B0083  --End

        #UPDATE rvb_file SET rvb06 = l_qty                                   #No.TQC-7B0083
                            #rvb06 = 已請款數量 + 暫估數量 (去掉已衝部分,否則會多算)
         UPDATE rvb_file SET rvb06 = l_qty + l_qty_rvv88 - l_qty_rvv23_rvv88 #No.TQC-7B0083
          WHERE rvb01 = g_apb04_t
            AND rvb02 = g_apb05_t
         IF STATUS OR SQLCA.SQLCODE THEN
#           CALL cl_err('upd rvb06',SQLCA.SQLCODE,1)   #No.FUN-660122
            CALL cl_err3("upd","rvb_file",g_apb04_t,g_apb05_t,SQLCA.sqlcode,"","upd rvb06",1)  #No.FUN-660122
            LET g_success='N'
         END IF
      END IF   #CHI-B30009 add

      IF NOT cl_null(g_apb_t.apb21) AND NOT cl_null(g_apb_t.apb22) THEN   #CHI-B30009 add
         LET l_qty=0
         SELECT SUM(apb09) INTO l_qty FROM apb_file,apa_file
          WHERE apb21 = g_apb_t.apb21 AND apb22 = g_apb_t.apb22
            AND apb01 = apa01 AND apa00 = '11'
            AND apa42 = 'N'
         IF STATUS THEN
#           CALL cl_err('sum(apb09)',STATUS,1)    #No.FUN-660122
            CALL cl_err3("sel","apb_file,apa_file",g_apb_t.apb21,g_apb_t.apb22,STATUS,"","sum(apb09)",1)  #No.FUN-660122
            LET g_success='N'
         END IF

         IF l_qty IS NULL THEN
            LET l_qty = 0
         END IF

         #No.TQC-7B0083  --Begin
         IF l_qty < 0 THEN
            LET l_qty = l_qty * -1
         END IF
         #No.TQC-7B0083  --End  

         #No.TQC-7B0083  --Begin
         #倉退,要額外select 21
         LET l_qty3=0

         SELECT SUM(apb09) INTO l_qty3 FROM apb_file,apa_file
          WHERE apb21 = g_apb_t.apb21 AND apb22 = g_apb_t.apb22
            AND apb01 = apa01 AND apa00 = '21'
            AND apa42 = 'N'
         IF STATUS THEN
            CALL cl_err3("sel","apb_file,apa_file",g_apb_t.apb21,g_apb_t.apb22,STATUS,"","sum(apb09)",1)  #No.FUN-660122
            LET g_success='N'
         END IF

         IF l_qty3 IS NULL THEN
            LET l_qty3 = 0
         END IF
        
         LET l_qty = l_qty + l_qty3
         #No.TQC-7B0083  --End  

         SELECT SUM(ale06) INTO l_qty2 FROM ale_file,alk_file
          WHERE alk01 = ale01
            AND ale16 = g_apb_t.apb21 AND ale17 = g_apb_t.apb22
            AND alkfirm = 'Y'
         IF STATUS THEN
#           CALL cl_err('sum(ale06)',STATUS,1)    #No.FUN-660122
            CALL cl_err3("sel","ale_file,alk_file",g_apb_t.apb21,g_apb_t.apb22,STATUS,"","sum(ale06)",1)  #No.FUN-660122
            LET g_success='N'
         END IF

         IF l_qty2 IS NULL THEN
            LET l_qty2 = 0
         END IF

         LET l_qty=l_qty+l_qty2

         #No.TQC-7B0083  --Begin
         CALL t110_rvv23_rvv88(g_apb_t.apb21,g_apb_t.apb22,'11','16')
              RETURNING l_qty_rvv88,l_qty_rvv23_rvv88
         CALL t110_rvv23_rvv88(g_apb_t.apb21,g_apb_t.apb22,'21','26')
              RETURNING l_qty_rvv88_3,l_qty_rvv23_rvv88_3
         LET l_qty_rvv88 = l_qty_rvv88 + l_qty_rvv88_3
         LET l_qty_rvv23_rvv88 = l_qty_rvv23_rvv88 + l_qty_rvv23_rvv88_3
         #No.TQC-7B0083  --End

         UPDATE rvv_file SET rvv23 = l_qty,
                             #暫估數量=立暫估數量-已衝暫估數量
                             rvv88 = l_qty_rvv88 - l_qty_rvv23_rvv88   #No.TQC-7B0083 
          WHERE rvv01 = g_apb_t.apb21
            AND rvv02 = g_apb_t.apb22
         IF STATUS OR SQLCA.SQLCODE THEN
#           CALL cl_err('upd rvv23',SQLCA.SQLCODE,1)   #No.FUN-660122
            CALL cl_err3("upd","rvv_file",g_apb_t.apb21,g_apb_t.apb22,SQLCA.sqlcode,"","upd rvv23",1)  #No.FUN-660122
            LET g_success='N'
         END IF

         #No.TQC-7B0083  --Begin
         ##No.TQC-750181 --start--
         #SELECT rvv40 INTO l_rvv40 FROM rvv_file
         # WHERE rvv01 = g_apb_t.apb21 AND rvv02 = g_apb_t.apb22
         #IF l_rvv40 = 'N' THEN
         #   SELECT apb09 INTO l_apb09 FROM apb_file,apa_file
         #    WHERE apb21 = g_apb_t.apb21 AND apb22 = g_apb_t.apb22
         #      AND apa01 = apb01 AND apa00 = '16'
         #   IF cl_null(l_apb09) THEN LET l_apb09 = 0 END IF
         #   UPDATE rvv_file SET rvv23 = l_apb09
         #    WHERE rvv01 = g_apb_t.apb21
         #      AND rvv02 = g_apb_t.apb22
         #   IF STATUS OR SQLCA.SQLCODE THEN
         #      CALL cl_err3("upd","rvv_file",g_apb_t.apb21,g_apb_t.apb22,SQLCA.sqlcode,"","upd rvv23",1)
         #      LET g_success='N'
         #   END IF
         #ELSE
         #   SELECT COUNT(*) INTO l_n FROM apb_file
         #    WHERE apb21 = g_apb_t.apb21 AND apb22 = g_apb_t.apb22
         #      AND apa01 = apb01 AND apa00 = '11'
         #   IF l_n = 0 THEN
         #      SELECT apb09 INTO l_apb09 FROM apb_file,apa_file
         #       WHERE apb21 = g_apb_t.apb21 AND apb22 = g_apb_t.apb22
         #         AND apa01 = apb01 AND apa00 = '16'
         #      IF cl_null(l_apb09) THEN LET l_apb09 = 0 END IF
         #      UPDATE rvv_file SET rvv23 = l_apb09
         #       WHERE rvv01 = g_apb_t.apb21
         #         AND rvv02 = g_apb_t.apb22
         #      IF STATUS OR SQLCA.SQLCODE THEN
         #         CALL cl_err3("upd","rvv_file",g_apb_t.apb21,g_apb_t.apb22,SQLCA.sqlcode,"","upd rvv23",1)
         #         LET g_success='N'
         #      END IF
         #   END IF
         #END IF
         ##No.TQC-750181 --end--
         #No.TQC-7B0083  --End  
      END IF   #CHI-B30009 add
   END IF

END FUNCTION

FUNCTION t110_bu_21(u_sw,r_sw)
   DEFINE u_sw,r_sw            LIKE type_file.num5        # No:FUN-690028 SMALLINT
   DEFINE l_qty                LIKE ima_file.ima26      # No:FUN-690028 DEC(15,3)  #FUN-4B0079
   DEFINE l_qty_rvv88          LIKE rvv_file.rvv23        #No.TQC-7B0083
   DEFINE l_qty_rvv23_rvv88    LIKE rvv_file.rvv23        #No.TQC-7B0083

   IF u_sw = 1 AND r_sw = 1 AND g_apb_t.apb21 = g_apb[l_ac].apb21 AND
      g_apb_t.apb22 = g_apb[l_ac].apb22 THEN
      LET u_sw = 1
      LET r_sw = 0
   END IF

   IF u_sw = 1 THEN
      IF NOT cl_null(g_apb[l_ac].apb21) AND NOT cl_null(g_apb[l_ac].apb22) THEN   #CHI-B30009 add
         SELECT SUM(apb09) INTO l_qty FROM apb_file,apa_file
          WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
            AND apb01 = apa01 AND apa00 = '21'
            AND apa42 = 'N' #no.4182
         IF STATUS THEN
#           CALL cl_err('sum(apb09)',STATUS,1)   #No.FUN-660122
            CALL cl_err3("sel","apb_file,apa_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","sum(apb09)",1)  #No.FUN-660122
            LET g_success='N'
         END IF

         IF l_qty IS NULL THEN
            LET l_qty = 0
         END IF

         #No.TQC-7B0083  --Begin
         CALL t110_rvv23_rvv88(g_apb[l_ac].apb21,g_apb[l_ac].apb22,'21','26')
              RETURNING l_qty_rvv88,l_qty_rvv23_rvv88
         #No.TQC-7B0083  --End  

         UPDATE rvv_file SET rvv23 = l_qty,
                             rvv88 = l_qty_rvv88 - l_qty_rvv23_rvv88  #No.TQC-7B0083
          WHERE rvv01 = g_apb[l_ac].apb21
            AND rvv02 = g_apb[l_ac].apb22
         IF STATUS OR SQLCA.SQLCODE THEN
#           CALL cl_err('upd rvv23',SQLCA.SQLCODE,1)   #No.FUN-660122
            CALL cl_err3("upd","rvv_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,SQLCA.sqlcode,"","upd rvv23",1)  #No.FUN-660122
            LET g_success='N'
         END IF
      END IF   #CHI-B30009 add
   END IF

   IF r_sw = 1 THEN
      IF NOT cl_null(g_apb_t.apb21) AND NOT cl_null(g_apb_t.apb22) THEN   #CHI-B30009 add
         SELECT SUM(apb09) INTO l_qty FROM apb_file,apa_file
          WHERE apb21 = g_apb_t.apb21 AND apb22 = g_apb_t.apb22
            AND apb01 = apa01 AND apa00 = '21'
            AND apa42 = 'N'
         IF STATUS THEN
#           CALL cl_err('sum(apb09)',STATUS,1)   #No.FUN-660122
            CALL cl_err3("sel","apb_file,apa_file",g_apb_t.apb21,g_apb_t.apb22,STATUS,"","sum(apb09)",1)  #No.FUN-660122
            LET g_success='N'
         END IF

         IF l_qty IS NULL THEN
            LET l_qty = 0
         END IF

         #No.TQC-7B0083  --Begin
         IF l_qty < 0 THEN
            LET l_qty = l_qty * -1
         END IF
         #No.TQC-7B0083  --End  

         #No.TQC-7B0083  --Begin
         CALL t110_rvv23_rvv88(g_apb_t.apb21,g_apb_t.apb22,'21','26')
              RETURNING l_qty_rvv88,l_qty_rvv23_rvv88
         #No.TQC-7B0083  --End  

         UPDATE rvv_file SET rvv23 = l_qty,
                             rvv88 = l_qty_rvv88 - l_qty_rvv23_rvv88   #No.TQC-7B0083 
          WHERE rvv01 = g_apb_t.apb21 AND rvv02 = g_apb_t.apb22
         IF STATUS OR SQLCA.SQLCODE THEN
#           CALL cl_err('upd rvv23',SQLCA.SQLCODE,1)   #No.FUN-660122
            CALL cl_err3("upd","rvv_file",g_apb_t.apb21,g_apb_t.apb22,SQLCA.sqlcode,"","UPD RVV23",1)  #No.FUN-660122
            LET g_success='N'
         END IF
      END IF   #CHI-B30009 add
   END IF

END FUNCTION

FUNCTION t110_m()
   DEFINE i,j          LIKE type_file.num5    #No.FUN-690028 SMALLINT
   DEFINE g_apd     DYNAMIC ARRAY OF RECORD
                    apd02          LIKE apd_file.apd02,
                    apd03          LIKE apd_file.apd03
                    END RECORD,
   l_allow_insert  LIKE type_file.num5,                #可新增否  #No.FUN-690028 SMALLINT
   l_allow_delete  LIKE type_file.num5                 #可刪除否  #No.FUN-690028 SMALLINT

   IF g_apa.apa01 IS NULL THEN
      RETURN
   END IF

   OPEN WINDOW t110_m_w WITH FORM "aap/42f/aapt110_3"
      ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
    CALL cl_ui_locale("aapt110_3")

 
   DECLARE t110_m_c CURSOR FOR
    SELECT apd02,apd03 FROM apd_file
     WHERE apd01 = g_apa.apa01

   LET i = 1

   FOREACH t110_m_c INTO g_apd[i].*
      LET i = i + 1
      IF i > 100 THEN
         EXIT FOREACH
      END IF
   END FOREACH
   LET i = i - 1

   LET l_allow_insert = cl_detail_input_auth("insert")
   LET l_allow_delete = cl_detail_input_auth("delete")

   INPUT ARRAY g_apd WITHOUT DEFAULTS FROM s_apd.*
         ATTRIBUTE(COUNT=i,MAXCOUNT=g_max_rec,UNBUFFERED,
                   INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)

   CLOSE WINDOW t110_m_w

   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF

   LET j = ARR_COUNT()
   BEGIN WORK
   LET g_success = 'Y'

   WHILE TRUE
      DELETE FROM apd_file
       WHERE apd01 = g_apa.apa01
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
#        CALL cl_err('t110_m(ckp#1):',SQLCA.sqlcode,1)   #No.FUN-660122
         CALL cl_err3("del","apd_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_m(ckp#1):",1)  #No.FUN-660122
         EXIT WHILE
      END IF

      FOR i = 1 TO j
         IF g_apd[i].apd03 IS NULL THEN
            CONTINUE FOR
         END IF

         INSERT INTO apd_file (apd01,apd02,apd03)
              VALUES(g_apa.apa01,g_apd[i].apd02,g_apd[i].apd03)
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
#           CALL cl_err('t110_m(ckp#2):',SQLCA.sqlcode,1)   #No.FUN-660122
            CALL cl_err3("ins","apd_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_m(ckp#2):",1)  #No.FUN-660122
            EXIT WHILE
         END IF
      END FOR
      EXIT WHILE
   END WHILE

   IF g_success = 'Y' THEN
      COMMIT WORK
   ELSE
      ROLLBACK WORK
   END IF

END FUNCTION
 
FUNCTION t110_ccc(p_cmd)
   DEFINE p_cmd          LIKE type_file.chr1            # 1.借方MISC明細  #No.FUN-690028 VARCHAR(1)
   DEFINE l_exit_sw      LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   #DEFINE l_depno        VARCHAR(10)            #FUN-660117 remark
   DEFINE l_depno        LIKE apa_file.apa22  #FUN-660117
   DEFINE l_amt          LIKE api_file.api05
   DEFINE l_amtf         LIKE api_file.api05f
   DEFINE l_tot          LIKE api_file.api05
   DEFINE l_totf         LIKE api_file.api05
   DEFINE i,j,k          LIKE type_file.num5    #No.FUN-690028 SMALLINT
   DEFINE l_apt          RECORD LIKE apt_file.*
   DEFINE m_aag05        LIKE aag_file.aag05
   DEFINE m_aag21        LIKE aag_file.aag21
   DEFINE m_aag23        LIKE aag_file.aag23
   DEFINE m_aag151       LIKE aag_file.aag151
   DEFINE m_aag161       LIKE aag_file.aag161
   DEFINE m_aag171       LIKE aag_file.aag171
   DEFINE m_aag181       LIKE aag_file.aag181
   DEFINE m_aag311       LIKE aag_file.aag311   #FUN-5C0015 BY TSD.GILL
   DEFINE m_aag321       LIKE aag_file.aag321   #FUN-5C0015 BY TSD.GILL
   DEFINE m_aag331       LIKE aag_file.aag331   #FUN-5C0015 BY TSD.GILL
   DEFINE m_aag341       LIKE aag_file.aag341   #FUN-5C0015 BY TSD.GILL
   DEFINE m_aag351       LIKE aag_file.aag351   #FUN-5C0015 BY TSD.GILL
   DEFINE m_aag361       LIKE aag_file.aag361   #FUN-5C0015 BY TSD.GILL
   DEFINE m_aag371       LIKE aag_file.aag371   #FUN-5C0015 BY TSD.GILL
   DEFINE m_aag05_1      LIKE aag_file.aag05    #CHI-8C0005 add
   DEFINE m_aag21_1      LIKE aag_file.aag21    #CHI-8C0005 add
   DEFINE m_aag23_1      LIKE aag_file.aag23    #CHI-8C0005 add
   DEFINE m_aag151_1     LIKE aag_file.aag151   #CHI-8C0005 add
   DEFINE m_aag161_1     LIKE aag_file.aag161   #CHI-8C0005 add
   DEFINE m_aag171_1     LIKE aag_file.aag171   #CHI-8C0005 add
   DEFINE m_aag181_1     LIKE aag_file.aag181   #CHI-8C0005 add
   DEFINE m_aag311_1     LIKE aag_file.aag311   #CHI-8C0005 add
   DEFINE m_aag321_1     LIKE aag_file.aag321   #CHI-8C0005 add
   DEFINE m_aag331_1     LIKE aag_file.aag331   #CHI-8C0005 add
   DEFINE m_aag341_1     LIKE aag_file.aag341   #CHI-8C0005 add
   DEFINE m_aag351_1     LIKE aag_file.aag351   #CHI-8C0005 add
   DEFINE m_aag361_1     LIKE aag_file.aag361   #CHI-8C0005 add
   DEFINE m_aag371_1     LIKE aag_file.aag371   #CHI-8C0005 add
   #DEFINE l_plant_new    VARCHAR(10)             #FUN-660117 remark
   DEFINE l_plant_new    LIKE azp_file.azp01   #FUN-660117
   DEFINE l_dbs_new      LIKE type_file.chr21       # No:FUN-690028 VARCHAR(21)
   #DEFINE l_sql          LIKE type_file.chr1000 #No.FUN-690028 VARCHAR(300)   #MOD-720062
   DEFINE l_sql          STRING  #MOD-720062
   DEFINE g_aaz72        LIKE aaz_file.aaz72,   #總帳參數部門為1.拒絕或2.允許
          l_allow_insert LIKE type_file.num5,                #可新增否  #No.FUN-690028 SMALLINT
          l_allow_delete LIKE type_file.num5                 #可刪除否  #No.FUN-690028 SMALLINT
   DEFINE m_api04        LIKE api_file.api04
   DEFINE m_api041       LIKE api_file.api041   #No.FUN-680029
   DEFINE l_aag05        LIKE aag_file.aag05   #MOD-580051

   #-----MOD-810207---------
   #IF g_apa.apa41='Y' THEN
   #   RETURN
   #END IF
   #-----END MOD-810207-----

   IF g_apa.apa51 != 'MISC' AND g_apa.apa511 != 'MISC' THEN   #No.FUN-680029
      RETURN
   END IF

  #IF cl_null(g_apa.apa01) OR cl_null(g_apa.apa01[5,10]) THEN              #MOD-890281 mark
   IF cl_null(g_apa.apa01) OR cl_null(s_get_serial_no(g_apa.apa01)) THEN   #MOD-890281
      RETURN
   END IF

   LET l_amt  = g_apa.apa31
   LET l_amtf = g_apa.apa31f

   CALL cl_set_comp_visible("api930",g_aaz.aaz90='Y')  #CHI-8C0005 add

   #No.FUN-950053 --begin--
   SELECT pmc903 INTO g_pmc903  FROM pmc_file
     WHERE pmc01 = g_apa.apa05
   #No.FUN-950053 --end--

   OPEN WINDOW t110_ccc_w WITH FORM "aap/42f/aapt110_c"
      ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
   CALL cl_ui_locale("aapt110_c")

#No.FUN-680029--begin
   CALL cl_set_comp_entry("api04,api041",FALSE)
   IF g_apa.apa51 ='MISC' THEN
         CALL cl_set_comp_entry("api04",TRUE)
   END IF
   IF g_apa.apa511='MISC' THEN
         CALL cl_set_comp_entry("api041",TRUE)
   END IF
#No.FUN-680029--end
   CALL t110_ccc_show_filed()  #FUN-5C0015 BY GILL
 
   #DISPLAY g_apa.apa01,l_amt,l_amtf TO api01,l_amt,l_amtf   #MOD-810207
   DISPLAY g_apa.apa01,l_amt,l_amtf TO api01,amt,amtf   #MOD-810207

   DECLARE t110_ccc_c CURSOR FOR 
     #SELECT DISTINCT api04,A.aag02,api041,B.aag02,api07,api06,api05f,api05,   #No.FUN-680029  #No.TQC-7A0095
      SELECT DISTINCT api04,'',api041,'',api07,api930,api06,api05f,api05,   #No.TQC-7A0095   #CHI-8C0005 add api930
             api21,api22,api23,api24,
 
           #FUN-810045 begin
            # #FUN-5C0015 BY TSD.GILL --START
            # api31,api32,api33,api34,api35,
            # api36,api37,
            # #FUN-5C0015 BY TSD.GILL --END
            # api25,api26,api03
            api31,api32,api33,api34,api37,
           #api25,api26,api35,api36,api03  #No.FUN-830161
            api26,api35,api36,api03        #No.FUN-830161
           #FUN-810045 end

       #FROM api_file,OUTER aag_file A,OUTER aag_file B  #No.FUN-680029 #No.TQC-7A0095
        FROM api_file   #No.TQC-7A0095
       WHERE api01 = g_apa.apa01
         AND api02 = p_cmd
       # AND api04 = A.aag01  #No.FUN-680029 #No.TQC-7A0095 mark 
       # AND api041= B.aag01  #No.FUN-680029 #No.TQC-7A0095 mark 
         #AND api00 = aag00    #No.FUN-730064
       ORDER BY api03,api04,api041  #No.FUN-680029

   WHILE TRUE
      LET l_exit_sw = 'Y'
      CALL g_api.clear()
      LET k = 1
      LET l_tot = 0
      LET l_totf= 0
 
      FOREACH t110_ccc_c INTO g_api[k].*,j
         IF SQLCA.sqlcode THEN
            CALL cl_err('t110_ccc_c',SQLCA.sqlcode,0)
            EXIT FOREACH
         END IF
     
        #No.TQC-7A0095--begin-- add
         IF NOT cl_null(g_api[k].api04) THEN
            SELECT aag02 INTO g_api[k].aag02 FROM aag_file 
             WHERE aag01 = g_api[k].api04
               AND aag00 = g_bookno1
               AND aagacti = 'Y'     #No.MOD-B70280 add
         END IF
         IF NOT cl_null(g_api[k].api041) THEN
            SELECT aag02 INTO g_api[k].aag021 FROM aag_file
             WHERE aag01 = g_api[k].api041
               AND aag00 = g_bookno2
               AND aagacti = 'Y'     #No.MOD-B70280 add
         END IF
        #No.TQC-7A0095---end--- add

         LET l_totf = l_totf + g_api[k].api05f
         LET l_tot  = l_tot + g_api[k].api05
         LET k = k + 1

          IF k > g_max_rec THEN          #No:MOD-480131
            EXIT FOREACH
         END IF
      END FOREACH

      CALL g_api.deleteElement(k)
      LET g_rec_b = k - 1
 
      DISPLAY l_totf TO FORMONLY.api05_ft
      DISPLAY l_tot TO FORMONLY.api05_t
 
      IF k = 1 THEN
         IF g_apz.apz13 = 'Y' THEN
            LET l_depno = g_apa.apa22
         ELSE
            LET l_depno = ' '
         END IF
 
         SELECT * INTO l_apt.* FROM apt_file
          WHERE apt01 = g_apa.apa36
            AND apt02 = l_depno
         IF SQLCA.sqlcode THEN
            INITIALIZE l_apt.* TO NULL
         END IF
 
         LET g_api[1].api04 = l_apt.apt032          #No.FUN-680029
         LET g_api[2].api04 = l_apt.apt032
         LET g_api[3].api04 = l_apt.apt033
         LET g_api[4].api04 = l_apt.apt034
         LET g_api[5].api04 = l_apt.apt035
         LET g_api[6].api04 = l_apt.apt036
         LET g_api[7].api04 = l_apt.apt037
         LET g_api[8].api04 = l_apt.apt038
         LET g_api[9].api04 = l_apt.apt039
#No.FUN-680029--begin
         IF g_aza.aza63 ='Y' THEN
            LET g_api[1].api041 = l_apt.apt032
            LET g_api[2].api041 = l_apt.apt032
            LET g_api[3].api041 = l_apt.apt033
            LET g_api[4].api041 = l_apt.apt034
            LET g_api[5].api041 = l_apt.apt035
            LET g_api[6].api041 = l_apt.apt036
            LET g_api[7].api041 = l_apt.apt037
            LET g_api[8].api041 = l_apt.apt038
            LET g_api[9].api041 = l_apt.apt039
         END IF
#No.FUN-680029--end
      END IF
 
      IF g_apa.apa41 = 'Y' THEN
         CALL cl_set_act_visible("accept,cancel", FALSE)
         DISPLAY ARRAY g_api TO s_api.* ATTRIBUTE(COUNT=g_rec_b)

            #-----MOD-810207---------
            AFTER DISPLAY
               #LET l_exit_sw = 'N'   #MOD-840040
               LET l_exit_sw = 'Y'   #MOD-840040

            ON ACTION exit
               LET l_exit_sw = 'Y'
               EXIT DISPLAY
            #-----END MOD-810207-----

            ON IDLE g_idle_seconds
               CALL cl_on_idle()
               CONTINUE DISPLAY
 
             ON ACTION about         #MOD-4C0121
                CALL cl_about()      #MOD-4C0121
 
             ON ACTION help          #MOD-4C0121
                CALL cl_show_help()  #MOD-4C0121
 
             ON ACTION controlg      #MOD-4C0121
                CALL cl_cmdask()     #MOD-4C0121
 
             ON ACTION controls                       #No.FUN-6B0033                                                                       
                CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033

         END DISPLAY
      ELSE
      #-----MOD-810207---------
         CALL cl_set_act_visible("accept,cancel", FALSE)
         DISPLAY ARRAY g_api TO s_api.* ATTRIBUTE(COUNT=g_rec_b)
            BEFORE DISPLAY
               EXIT DISPLAY
         END DISPLAY

         CALL cl_set_act_visible("accept,cancel", TRUE)
         INPUT l_amtf,l_amt WITHOUT DEFAULTS FROM amtf,amt

            AFTER INPUT
               IF INT_FLAG THEN
                  LET INT_FLAG= 0
                  LET l_amt = g_apa.apa31
                  LET l_amtf = g_apa.apa31f
                  DISPLAY l_amt,l_amtf TO amt,amtf
                  EXIT INPUT
               END IF
               IF g_apa.apa31f <> l_amtf OR
                  g_apa.apa31  <> l_amt  THEN
                  IF l_amtf <> 0 OR
                     l_amt  <> 0 THEN
                     CALL cl_err('','aap-292',0)
                     NEXT FIELD amtf
                  END IF
               END IF

            ON ACTION controlg       #TQC-860021
               CALL cl_cmdask()      #TQC-860021

            ON IDLE g_idle_seconds   #TQC-860021
               CALL cl_on_idle()     #TQC-860021
               CONTINUE INPUT        #TQC-860021

            ON ACTION about          #TQC-860021
               CALL cl_about()       #TQC-860021

            ON ACTION help           #TQC-860021
               CALL cl_show_help()   #TQC-860021
         END INPUT
         #-----END MOD-810207-----

        #str CHI-8C0005 add
         LET m_aag05  = ' '
         LET m_aag21  = ' '
         LET m_aag23  = ' '
         LET m_aag151 = ' '
         LET m_aag161 = ' '
         LET m_aag171 = ' '
         LET m_aag181 = ' '
         LET m_aag311 = ' '
         LET m_aag321 = ' '
         LET m_aag331 = ' '
         LET m_aag341 = ' '
         LET m_aag351 = ' '
         LET m_aag361 = ' '
         LET m_aag371 = ' '
         LET m_aag05_1= ' '
         LET m_aag21_1= ' '
         LET m_aag23_1= ' '
         LET m_aag151_1= ' '
         LET m_aag161_1= ' '
         LET m_aag171_1= ' '
         LET m_aag181_1= ' '
         LET m_aag311_1= ' '
         LET m_aag321_1= ' '
         LET m_aag331_1= ' '
         LET m_aag341_1= ' '
         LET m_aag351_1= ' '
         LET m_aag361_1= ' '
         LET m_aag371_1= ' '
        #end CHI-8C0005 add
         LET l_allow_insert = cl_detail_input_auth("insert")
         LET l_allow_delete = cl_detail_input_auth("delete")
 
         INPUT ARRAY g_api WITHOUT DEFAULTS FROM s_api.*
               ATTRIBUTE(COUNT=g_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                         INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)

            BEFORE INPUT
               CALL fgl_set_arr_curr(i)
               LET g_before_input_done = FALSE
               CALL t110_set_entry_api(p_cmd)
               CALL t110_set_no_entry_api(m_aag05,m_aag21,m_aag23,m_aag151,
                    m_aag161,m_aag171,m_aag181,

                    #FUN-5C0015 BY GILL --START
                    m_aag311,m_aag321,m_aag331,m_aag341,m_aag351,m_aag361,
                    m_aag371
                    #FUN-5C0015 BY GILL --END

                    )
               LET g_before_input_done = TRUE
 
            BEFORE ROW
               LET i = ARR_CURR()
               LET j = SCR_LINE()
               LET l_totf = 0
               LET l_tot = 0
                FOR k = 1 TO g_api.getLength()  #No:MOD-4A0348
                  IF g_api[k].api05 IS NULL THEN
                     CONTINUE FOR
                  END IF
                  LET l_totf = l_totf + g_api[k].api05f
                  LET l_tot = l_tot + g_api[k].api05
               END FOR
               DISPLAY l_totf TO FORMONLY.api05_ft
               DISPLAY l_tot TO FORMONLY.api05_t
               CALL cl_show_fld_cont()     #FUN-550037(smin)
 
             #No:MOD-510035 add
            BEFORE FIELD api04
               CALL t110_set_entry_api(p_cmd)
 
            AFTER FIELD api04
#MOD-590460將變數值清空
                  LET m_aag21  = ' '
                  LET m_aag151 = ' '
                  LET m_aag161 = ' '
                  LET m_aag171 = ' '
                  LET m_aag181 = ' '

                  #FUN-5C0015 BY GILL --START
                  LET m_aag311 = ' '
                  LET m_aag321 = ' '
                  LET m_aag331 = ' '
                  LET m_aag341 = ' '
                  LET m_aag351 = ' '
                  LET m_aag361 = ' '
                  LET m_aag371 = ' '
                  #FUN-5C0015 BY GILL --END

#END MOD-590460
               IF NOT cl_null(g_api[i].api04) THEN
                  CALL s_aapact(g_apz.apz11,g_bookno1,g_api[i].api04) RETURNING g_api[i].aag02     #No.FUN-730064
                  IF g_apz.apz02 = 'Y' AND NOT cl_null(g_errno) THEN
                     CALL cl_err(g_api[i].api04,g_errno,0)
                     NEXT FIELD api04
                  END IF
 
                  SELECT aag05,aag21,aag23,aag151,aag161,aag171,aag181,

                  #FUN-5C0015 BY GILL --START
                  aag311,aag321,aag331,aag341,aag351,aag361,aag371
                  #FUN-5C0015 BY GILL --END

                    INTO m_aag05,m_aag21,m_aag23,m_aag151,m_aag161,m_aag171,m_aag181,

                         #FUN-5C0015 BY GILL --START
                         m_aag311,m_aag321,m_aag331,m_aag341,m_aag351,
                         m_aag361,m_aag371
                         #FUN-5C0015 BY GILL --END

                    FROM aag_file
                   WHERE aag01 = g_api[i].api04
                     AND aag00 = g_bookno1     #No.FUN-730064
                     AND aagacti = 'Y'         #No.MOD-B70280 add
                  IF SQLCA.sqlcode THEN
                     LET m_aag05 = ' '   #CHI-8C0005 add
                     LET m_aag21 = ' '
                     LET m_aag23 = ' '   #CHI-8C0005 add
                     LET m_aag151 = ' '
                     LET m_aag161 = ' '
                     LET m_aag171 = ' '
                     LET m_aag181 = ' '

                     #FUN-5C0015 BY GILL --START
                     LET m_aag311 = ' '
                     LET m_aag321 = ' '
                     LET m_aag331 = ' '
                     LET m_aag341 = ' '
                     LET m_aag351 = ' '
                     LET m_aag361 = ' '
                     LET m_aag371 = ' '
                     #FUN-5C0015 BY GILL --END

                  END IF
 
                 #IF m_aag05 = 'N' THEN    #CHI-8C0005 mark
                  IF m_aag05 !='Y' THEN    #CHI-8C0005
                     LET g_api[i].api07 = ' '
                  END IF

                 #FUN-8C0106---add---str--- 
                 #防止User只修改部門欄位時,未再次檢查會科與允許/拒絕部門關係
                  LET g_errno = ' '   
                  IF m_aag05 = 'Y' THEN
                     IF g_aaz.aaz90 ='Y' THEN
                        IF NOT cl_null(g_api[i].api930) THEN
                           CALL s_chkdept(g_aaz.aaz72,g_api[i].api04,g_api[i].api930,g_bookno1)
                                         RETURNING g_errno
                        END IF
                     ELSE
                        IF NOT cl_null(g_api[i].api07) THEN
                           CALL s_chkdept(g_aaz.aaz72,g_api[i].api04,g_api[i].api07,g_bookno1)
                                         RETURNING g_errno
                        END IF
                     END IF
                     IF NOT cl_null(g_errno) THEN
                        CALL cl_err('',g_errno,0)
                        NEXT FIELD api04
                     END IF
                  END IF
                 #FUN-8C0106---add---end---

               END IF
                #No:MOD-510036
               CALL t110_set_no_entry_api(m_aag05,m_aag21,m_aag23,m_aag151,
                    m_aag161,m_aag171,m_aag181,

                    #FUN-5C0015 BY GILL --START
                    m_aag311,m_aag321,m_aag331,m_aag341,m_aag351,
                    m_aag361,m_aag371
                    #FUN-5C0015 BY GILL --END
                    )
 
              #FUN-5C0015 BY GILL --START
               CALL t110_set_no_required()
               CALL t110_set_required(m_aag151,m_aag161,m_aag171,m_aag181,
                                      m_aag311,m_aag321,m_aag331,m_aag341,
                                      m_aag351,m_aag361,m_aag371,m_aag05,    #TQC-750121
                                      m_aag21,m_aag23)                       #MOD-B10093 
              #FUN-5C0015 BY GILL --END
#No.FUN-680029--begin
            BEFORE FIELD api041
               CALL t110_set_entry_api(p_cmd)

            AFTER FIELD api041
#MOD-590460將變數值清空
              #str CHI-8C0005 mod
               LET m_aag05_1= ' '
               LET m_aag21_1= ' '
               LET m_aag23_1= ' '
               LET m_aag151_1= ' '
               LET m_aag161_1= ' '
               LET m_aag171_1= ' '
               LET m_aag181_1= ' '
               LET m_aag311_1= ' '   #FUN-5C0015 BY GILL
               LET m_aag321_1= ' '   #FUN-5C0015 BY GILL
               LET m_aag331_1= ' '   #FUN-5C0015 BY GILL
               LET m_aag341_1= ' '   #FUN-5C0015 BY GILL
               LET m_aag351_1= ' '   #FUN-5C0015 BY GILL
               LET m_aag361_1= ' '   #FUN-5C0015 BY GILL
               LET m_aag371_1= ' '   #FUN-5C0015 BY GILL
              #end CHI-8C0005 mod
#END MOD-590460
               IF NOT cl_null(g_api[i].api041) THEN
                  CALL s_aapact(g_apz.apz11,g_bookno2,g_api[i].api041) RETURNING g_api[i].aag021     #No.FUN-730064
                  IF g_apz.apz02 = 'Y' AND NOT cl_null(g_errno) THEN
                     CALL cl_err(g_api[i].api041,g_errno,0)
                     NEXT FIELD api041
                  END IF
 
                  SELECT aag05,aag21,aag23,aag151,aag161,aag171,aag181,
                         #FUN-5C0015 BY GILL --START
                         aag311,aag321,aag331,aag341,aag351,aag361,aag371
                         #FUN-5C0015 BY GILL --END
                 #str CHI-8C0005 mod
                    INTO m_aag05_1,m_aag21_1,m_aag23_1,m_aag151_1,m_aag161_1,m_aag171_1,m_aag181_1,
                         m_aag311_1,m_aag321_1,m_aag331_1,m_aag341_1,m_aag351_1,
                         m_aag361_1,m_aag371_1
                 #end CHI-8C0005 mod
                    FROM aag_file
                   WHERE aag01 = g_api[i].api041
                     AND aag00 = g_bookno2      #No.FUN-730064
                     AND aagacti = 'Y'          #No.MOD-B70280 add
                  IF SQLCA.sqlcode THEN
                    #str CHI-8C0005 mod
                     LET m_aag05_1= ' '
                     LET m_aag21_1= ' '
                     LET m_aag23_1= ' '
                     LET m_aag151_1= ' '
                     LET m_aag161_1= ' '
                     LET m_aag171_1= ' '
                     LET m_aag181_1= ' '
                     LET m_aag311_1= ' '   #FUN-5C0015 BY GILL
                     LET m_aag321_1= ' '   #FUN-5C0015 BY GILL
                     LET m_aag331_1= ' '   #FUN-5C0015 BY GILL
                     LET m_aag341_1= ' '   #FUN-5C0015 BY GILL
                     LET m_aag351_1= ' '   #FUN-5C0015 BY GILL
                     LET m_aag361_1= ' '   #FUN-5C0015 BY GILL
                     LET m_aag371_1= ' '   #FUN-5C0015 BY GILL
                    #end CHI-8C0005 mod
                  END IF
 
                 #IF m_aag05 = 'N' THEN    #CHI-8C0005 mark
                  IF m_aag05 != 'Y'AND m_aag05_1 !='Y' THEN   #CHI-8C0005
                     LET g_api[i].api07 = ' '
                  END IF

                 #FUN-8C0106---add---str--- 
                 #防止User只修改部門欄位時,未再次檢查會科與允許/拒絕部門關係
                  LET g_errno = ' '   
                  IF m_aag05_1 = 'Y' THEN
                     IF g_aaz.aaz90 ='Y' THEN
                        IF NOT cl_null(g_api[i].api930) THEN
                           CALL s_chkdept(g_aaz.aaz72,g_api[i].api041,g_api[i].api930,g_bookno2)
                                         RETURNING g_errno
                        END IF
                     ELSE
                        IF NOT cl_null(g_api[i].api07) THEN
                           CALL s_chkdept(g_aaz.aaz72,g_api[i].api041,g_api[i].api07,g_bookno2)
                                         RETURNING g_errno
                        END IF
                     END IF
                     IF NOT cl_null(g_errno) THEN
                        CALL cl_err('',g_errno,0)
                        NEXT FIELD api041
                     END IF
                  END IF
                 #FUN-8C0106---add---end---

               END IF
                #No:MOD-510036
              #str CHI-8C0005 mod
               CALL t110_set_no_entry_api(m_aag05_1,m_aag21_1,m_aag23_1,m_aag151_1,
                    m_aag161_1,m_aag171_1,m_aag181_1,
                    #FUN-5C0015 BY GILL --START
                    m_aag311_1,m_aag321_1,m_aag331_1,m_aag341_1,m_aag351_1,
                    m_aag361_1,m_aag371_1
                    #FUN-5C0015 BY GILL --END
                    )
              #end CHI-8C0005 mod
 
              #FUN-5C0015 BY GILL --START
               CALL t110_set_no_required()
              #str CHI-8C0005 mod
               CALL t110_set_required(m_aag151_1,m_aag161_1,m_aag171_1,m_aag181_1,
                                      m_aag311_1,m_aag321_1,m_aag331_1,m_aag341_1,
                                      m_aag351_1,m_aag361_1,m_aag371_1,m_aag05_1,   #TQC-750121 add aag05
                                      m_aag21_1,m_aag23_1)                          #MOD-B10093 
              #end CHI-8C0005 mod
              #FUN-5C0015 BY GILL --END
#No.FUN-680029--end

            AFTER FIELD api07
#MOD-590301  提高程式可讀性
               SELECT aag05 INTO m_aag05 FROM aag_file
                      WHERE aag01=g_api[i].api04
                        AND aag00=g_bookno1      #No.FUN-730064
                        AND aagacti = 'Y'        #No.MOD-B70280 add
               IF STATUS OR SQLCA.SQLCODE THEN
                  LET m_aag05=''
               END IF
               IF g_aza.aza63 ='Y' THEN   #CHI-8C0005 add
                  #No.FUN-680029--begin
                  SELECT aag05 INTO m_aag05_1 FROM aag_file   #CHI-8C0005 mod
                   WHERE aag01=g_api[i].api041
                     AND aag00=g_bookno2      #No.FUN-730064
                     AND aagacti = 'Y'        #No.MOD-B70280 add
                  IF STATUS OR SQLCA.SQLCODE THEN
                     LET m_aag05_1=''   #CHI-8C0005 mod
                  END IF
               END IF   #CHI-8C0005 add
#No.FUN-680029--end
#END MOD-590301
                   #-----No:MOD-530494-----
               IF cl_null(g_api[i].api07) THEN
                 #IF m_aag05 = "Y" THEN                      #CHI-8C0005 mark
                  IF m_aag05 = "Y" OR m_aag05_1 = "Y" THEN   #CHI-8C0005
                     CALL cl_err(g_api[i].api07,'mfg0037',0)
                     NEXT FIELD api07
                  END IF
               ELSE
                  LET g_api[i].api930=s_costcenter(g_api[i].api07)  #CHI-8C0005 add
                  DISPLAY BY NAME g_api[i].api930                   #CHI-8C0005 add
                  LET g_errno = ' '   #MOD-5B0255
                  IF m_aag05 = "Y" THEN
#MOD-590301
##MOD-580051   科目有做科目部門管理的才CALL s_chkdept
#                     SELECT aag05 INTO l_aag05 FROM aag_file
#                        WHERE aag01 = g_api[i].api04
#                     IF STATUS OR SQLCA.SQLCODE THEN
#                        LET l_aag05=''
#                     END IF
#                     IF l_aag05 = 'Y' THEN
#                        CALL s_chkdept(g_aaz.aaz72,g_api[i].api04,g_api[i].api07,g_bookno1) RETURNING g_errno      #No.FUN-730064
#                     END IF
##                     CALL s_chkdept(g_aaz.aaz72,g_api[i].api04,g_api[i].api07,g_bookno1) RETURNING g_errno    #No.FUN-730064
##END MOD-580051
                    #str CHI-8C0005 mod
                    #CALL s_chkdept(g_aaz.aaz72,g_api[i].api04,g_api[i].api07,g_bookno1) RETURNING g_errno    #No.FUN-730064
                    #CALL s_chkdept(g_aaz.aaz72,g_api[i].api041,g_api[i].api07,g_bookno2) RETURNING g_errno      #No.FUN-680029 #No.FUN-730064
                    #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                     IF g_aaz.aaz90 !='Y' THEN
                        IF NOT cl_null(g_api[i].api04) THEN  #FUN-8C0106 add
                           CALL s_chkdept(g_aaz.aaz72,g_api[i].api04,g_api[i].api07,g_bookno1)
                                RETURNING g_errno    #No.FUN-680029 #No.FUN-730064
                        END IF                               #FUN-8C0106 add
                     END IF
                    #end CHI-8C0005 mod
#END MOD-590301

                     IF NOT cl_null(g_errno) THEN
                        CALL cl_err('',g_errno,0)
#                       NEXT FIELD apb25
                        NEXT FIELD api07     #No.FUN-5B0081
                     END IF
                  END IF
                   #-----No:MOD-530494 END-----
                 #str CHI-8C0005 add
                  IF m_aag05_1 = "Y" THEN
                    #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                     IF g_aza.aza63 ='Y' THEN
                        IF g_aaz.aaz90 !='Y' THEN
                           IF NOT cl_null(g_api[i].api041) THEN     #FUN-8C0106 add
                              CALL s_chkdept(g_aaz.aaz72,g_api[i].api041,g_api[i].api07,g_bookno2)
                                   RETURNING g_errno    #No.FUN-680029 #No.FUN-730064
                           END IF                                   #FUN-8C0106 add 
                        END IF
                     END IF
                     IF NOT cl_null(g_errno) THEN
                        CALL cl_err('',g_errno,0)
                        NEXT FIELD api07
                     END IF
                  END IF
                 #end CHI-8C0005 add
 
                  SELECT gem02 FROM gem_file
                   WHERE gem01 = g_api[i].api07
                     AND gem05 = 'Y'
                     AND gemacti = 'Y'
 
                  IF SQLCA.sqlcode THEN
#                    CALL cl_err(g_api[i].api07,'aap-039',0)   #No.FUN-660122
                     CALL cl_err3("sel","gem_file",g_api[i].api07,"","aap-039","","",1)  #No.FUN-660122
                     NEXT FIELD api07
                  END IF
 
                  IF g_apz.apz02='Y' THEN
                     LET l_plant_new = g_apz.apz02p
 
                     IF l_plant_new = g_plant THEN
                        LET l_dbs_new = NULL
                     ELSE
                        SELECT azp03 INTO l_dbs_new FROM azp_file
                         WHERE azp01=l_plant_new
                        IF STATUS THEN
                           LET l_dbs_new = NULL
                        ELSE
                           #No.FUN-7B0012  --Begin
                           #LET l_dbs_new[21,21] = ':'
                           #LET l_dbs_new = l_dbs_new CLIPPED,s_dbstring(l_dbs_new clipped)   #MOD-B80060 mark
                           #No.FUN-7B0012  --End
                           LET l_dbs_new = s_dbstring(l_dbs_new CLIPPED)                      #MOD-B80060 add
                        END IF
                     END IF
 
                    #str CHI-8C0005 mark
                    #LET g_cnt=0
                    #LET l_sql = "SELECT COUNT(*) ",
                    #            "  FROM ",l_dbs_new CLIPPED," aab_file",
                    #            " WHERE aab01 =?  AND aab02=? "
                    #PREPARE t110_misc_p FROM l_sql
                    #DECLARE t110_misc_c CURSOR FOR t110_misc_p
                    #end CHI-8C0005 mark
 
                    #str CHI-8C0005 add
                     LET l_sql = "SELECT aaz72  FROM ",l_dbs_new,"aaz_file ",
                                 " WHERE aaz00 = '0' "
	CALL cl_replace_sqldb(l_sql) RETURNING l_sql		#FUN-920032
                     PREPARE t110_aab_p FROM l_sql
                     DECLARE t110_aab_c CURSOR FOR t110_aab_p
                     OPEN t110_aab_c
                     FETCH t110_aab_c INTO g_aaz72
                     IF SQLCA.sqlcode THEN
                        LET g_aaz72 = '1'
                     END IF
                    #end CHI-8C0005 add

                    #str MOD-890220 add
                     IF cl_null(g_api[i].api04) THEN
                        IF g_apa.apa51 ='MISC' THEN   #MOD-8A0016 add
                           CALL cl_err(g_api[i].api04,'aap-099',0)
                           NEXT FIELD api04
                        END IF                        #MOD-8A0016 add
                     ELSE
                    #end MOD-890220 add
                       #str CHI-8C0005 mod
                       #OPEN t110_misc_c USING g_api[i].api04,g_api[i].api07
                       #FETCH t110_misc_c INTO g_cnt
                       #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                        IF g_aaz.aaz90 !='Y' THEN
                           CALL s_chkdept_dbs(g_aaz72,g_api[i].api04,
                                              g_api[i].api07,g_bookno1,l_dbs_new)
                                RETURNING g_errno    #No.FUN-680029 #No.FUN-730064
                        END IF
                        IF NOT cl_null(g_errno) THEN
                           CALL cl_err('',g_errno,0)
                           NEXT FIELD api07
                        END IF
                       #end CHI-8C0005 mod
                     END IF   #MOD-890220 add

#No.FUN-680029--begin
                     IF g_aza.aza63 ='Y' THEN
                       #str MOD-890220 add
                        IF cl_null(g_api[i].api041) THEN
                           IF g_apa.apa511 ='MISC' THEN   #MOD-8A0016 add
                              CALL cl_err(g_api[i].api041,'aap-099',0)
                              NEXT FIELD api041
                           END IF                         #MOD-8A0016 add
                        ELSE
                       #end MOD-890220 add
                          #str CHI-8C0005 mod
                          #OPEN t110_misc_c USING g_api[i].api041,g_api[i].api07
                          #FETCH t110_misc_c INTO g_cnt
                          #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                           IF g_aaz.aaz90 !='Y' THEN
                              CALL s_chkdept_dbs(g_aaz72,g_api[i].api041,
                                                 g_api[i].api07,g_bookno2,l_dbs_new)
                                   RETURNING g_errno    #No.FUN-680029 #No.FUN-730064
                           END IF
                           IF NOT cl_null(g_errno) THEN
                              CALL cl_err('',g_errno,0)
                              NEXT FIELD api07
                           END IF
                          #end CHI-8C0005 mod
                        END IF   #MOD-890220 add
                     END IF
#No.FUN-680029--end
                  END IF
               END IF
 
           #str CHI-8C0005 add
            AFTER FIELD api930
               IF g_aaz.aaz90 ='Y' THEN
                  IF NOT s_costcenter_chk(g_api[i].api930) THEN
                     NEXT FIELD apb930
                  ELSE
                     LET m_aag05=''
                     SELECT aag05 INTO m_aag05 FROM aag_file
                      WHERE aag01=g_api[i].api04
                        AND aag00=g_bookno1
                        AND aagacti = 'Y'     #No.MOD-B70280 add
                     IF STATUS OR SQLCA.SQLCODE THEN
                        LET m_aag05=''
                     END IF
                     IF g_aza.aza63 ='Y' THEN
                        SELECT aag05 INTO m_aag05_1 FROM aag_file
                         WHERE aag01=g_api[i].api041
                           AND aag00=g_bookno2
                           AND aagacti = 'Y'     #No.MOD-B70280 add
                        IF STATUS OR SQLCA.SQLCODE THEN
                           LET m_aag05_1=''
                        END IF
                     END IF
                     IF m_aag05 = 'Y' THEN
                        IF cl_null(g_api[i].api930) THEN
                           CALL cl_err(g_api[i].api930,'mfg0037',0)
                           NEXT FIELD api930
                        ELSE
                           SELECT gem02 FROM gem_file
                            WHERE gem01 = g_api[i].api930
                              AND gem05 = 'Y'
                              AND gemacti = 'Y'
                           IF SQLCA.sqlcode THEN
#                             CALL cl_err('sel gem:',STATUS,0)   #No.FUN-660122
                              CALL cl_err3("sel","gem_file",g_api[i].api930,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                              NEXT FIELD api930
                           END IF
                           LET g_errno = ' '   #MOD-5B0255
                           #科目有做科目部門管理的才CALL s_chkdept
                           #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                           IF g_aaz.aaz90 ='Y' AND NOT cl_null(g_api[i].api04) THEN  #FUN-8C0106 mod
                              CALL s_chkdept(g_aaz.aaz72,g_api[i].api04,g_api[i].api930,g_bookno1) RETURNING g_errno
                              IF NOT cl_null(g_errno) THEN
                                 CALL cl_err('',g_errno,0)
                                 NEXT FIELD api930
                              END IF
                           END IF    #FUN-8C0106 add
                        END IF
                     ELSE
                        IF NOT cl_null(g_api[i].api930) THEN
                           SELECT gem02 FROM gem_file
                            WHERE gem01 = g_api[i].api930
                              AND gem05 = 'Y'
                              AND gemacti = 'Y'
                           IF SQLCA.sqlcode THEN
#                             CALL cl_err('sel gem:',STATUS,0)   #No.FUN-660122
                              CALL cl_err3("sel","gem_file",g_api[i].api930,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                              NEXT FIELD api930
                           END IF
                        END IF
                     END IF
                     IF m_aag05_1 = 'Y' THEN
                        IF cl_null(g_api[i].api930) THEN
                           CALL cl_err(g_api[i].api930,'mfg0037',0)
                           NEXT FIELD api930
                        ELSE
                           SELECT gem02 FROM gem_file
                            WHERE gem01 = g_api[i].api930
                              AND gem05 = 'Y'
                              AND gemacti = 'Y'
                           IF SQLCA.sqlcode THEN
#                             CALL cl_err('sel gem:',STATUS,0)   #No.FUN-660122
                              CALL cl_err3("sel","gem_file",g_api[i].api930,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                              NEXT FIELD api930
                           END IF
                           LET g_errno = ' '   #MOD-5B0255
                           #科目有做科目部門管理的才CALL s_chkdept
                           #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                           #IF g_aza.aza63 ='Y' THEN                    #FUN-8C0106 mark
                           IF g_aaz.aaz90 ='Y' AND g_aza.aza63='Y' AND NOT cl_null(g_api[i].api041) THEN  #FUN-8C0106 mod
                              CALL s_chkdept(g_aaz.aaz72,g_api[i].api041,g_api[i].api930,g_bookno2) RETURNING g_errno
                           END IF
                           IF NOT cl_null(g_errno) THEN
                              CALL cl_err('',g_errno,0)
                              NEXT FIELD api930
                           END IF
                        END IF
                     ELSE
                        IF NOT cl_null(g_api[i].api930) THEN
                           SELECT gem02 FROM gem_file
                            WHERE gem01 = g_api[i].api930
                              AND gem05 = 'Y'
                              AND gemacti = 'Y'
                           IF SQLCA.sqlcode THEN
#                             CALL cl_err('sel gem:',STATUS,0)   #No.FUN-660122
                              CALL cl_err3("sel","gem_file",g_api[i].api930,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                              NEXT FIELD api930
                           END IF
                        END IF
                     END IF
                  END IF
               END IF
           #end CHI-8C0005 add

            AFTER FIELD api05f
               IF NOT cl_null(g_api[i].api05f) THEN
                  LET g_api[i].api05 = g_api[i].api05f * g_apa.apa14
                  #LET g_api[i].api05 = cl_digcut(g_api[i].api05,t_azi.azi04)   #MOD-6B0066
                  LET g_api[i].api05 = cl_digcut(g_api[i].api05,g_azi04)   #MOD-6B0066
               END IF
 
            AFTER FIELD api05
               IF NOT cl_null(g_api[i].api05) THEN
                  #LET g_api[i].api05 = cl_digcut(g_api[i].api05,t_azi.azi04)   #MOD-6B0066
                  LET g_api[i].api05 = cl_digcut(g_api[i].api05,g_azi04)   #MOD-6B0066
               END IF
 
            AFTER FIELD api26
               IF NOT cl_null(g_api[i].api26) THEN
                  CALL t110_api26(p_cmd,g_api[i].api26)
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err('',g_errno,0)
                     NEXT FIELD api26
                  END IF
               END IF
 
            AFTER FIELD api21
               #FUN-5C0015 BY GILL --START
               #CALL t110_api21(m_aag151,'1',g_api[i].api21,g_api[i].api04)
               CALL s_chk_aee(g_api[i].api04,'1',g_api[i].api21,g_bookno1)   #No.FUN-730064 
               #FUN-5C0015 BY GILL --END
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api21
               END IF
 
            AFTER FIELD api22
               #FUN-5C0015 BY GILL --START
               #CALL t110_api21(m_aag161,'2',g_api[i].api22,g_api[i].api04)
               CALL s_chk_aee(g_api[i].api04,'2',g_api[i].api22,g_bookno1)    #No.FUN-730064
               #FUN-5C0015 BY GILL --END
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api22
               END IF
 
            AFTER FIELD api23
               #FUN-5C0015 BY GILL --START
               #CALL t110_api21(m_aag171,'3',g_api[i].api23,g_api[i].api04)
               CALL s_chk_aee(g_api[i].api04,'3',g_api[i].api23,g_bookno1)    #No.FUN-730064
               #FUN-5C0015 BY GILL --END
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api23
               END IF
 
            AFTER FIELD api24
               #FUN-5C0015 BY GILL --START
               #CALL t110_api21(m_aag181,'4',g_api[i].api24,g_api[i].api04)
               CALL s_chk_aee(g_api[i].api04,'4',g_api[i].api24,g_bookno1)    #No.FUN-730064
               #FUN-5C0015 BY GILL --END
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api24
               END IF
 
            #FUN-5C0015 BY GILL --START
            AFTER FIELD api31
               CALL s_chk_aee(g_api[i].api04,'5',g_api[i].api31,g_bookno1)    #No.FUN-730064
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api31
               END IF

            AFTER FIELD api32
               CALL s_chk_aee(g_api[i].api04,'6',g_api[i].api32,g_bookno1)    #No.FUN-730064
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api32
               END IF

            AFTER FIELD api33
               CALL s_chk_aee(g_api[i].api04,'7',g_api[i].api33,g_bookno1)     #No.FUN-730064
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api33
               END IF

            AFTER FIELD api34
               CALL s_chk_aee(g_api[i].api04,'8',g_api[i].api34,g_bookno1)     #No.FUN-730064
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api34
               END IF

            AFTER FIELD api35
               CALL s_chk_aee(g_api[i].api04,'9',g_api[i].api35,g_bookno1)     #No.FUN-730064
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api35
               END IF

            AFTER FIELD api36
               CALL s_chk_aee(g_api[i].api04,'10',g_api[i].api36,g_bookno1)      #No.FUN-730064
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api36
               END IF

            AFTER FIELD api37
               CALL s_chk_aee(g_api[i].api04,'99',g_api[i].api37,g_bookno1)     #No.FUN-730064
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api37
               END IF
 
            #FUN-5C0015 BY GILL --END

            AFTER FIELD api06
               LET g_msg = g_api[i].api06
               IF g_msg[1,1] = '.' THEN
                  LET g_msg = g_msg[2,10]
                  SELECT aad02 INTO g_api[i].api06 FROM aad_file
                   WHERE aad01 = g_msg
                     AND aadacti = 'Y'
                  NEXT FIELD api06
               END IF
 
            AFTER ROW
               IF INT_FLAG THEN
                  EXIT INPUT
               END IF
               IF cl_null(g_api[i].api05) OR g_api[i].api05f = 0 THEN
                  INITIALIZE g_api[i].* TO NULL
               END IF
 
            AFTER INPUT
               IF INT_FLAG THEN
                  EXIT INPUT
               END IF
               LET l_tot = 0

               FOR k = 1 TO 300
                  IF g_api[k].api05 IS NULL THEN
                     CONTINUE FOR
                  END IF
                  LET l_tot = l_tot + g_api[k].api05
               END FOR

               IF l_tot != l_amt THEN
                  CALL cl_err('','aap-177',0)
                  NEXT FIELD api05
               END IF
 
            ON ACTION apportion
               CALL t110_ins_api(p_cmd)
               LET g_aba.aba13 = g_apa.apa31 - l_tot
               CALL t110_xw()
               LET l_exit_sw = 'N'
               EXIT INPUT
 
            ON ACTION CONTROLP
               CASE
                  WHEN INFIELD(api04) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     LET g_qryparam.default1 = g_api[i].api04
                     LET g_qryparam.arg1 = g_bookno1      #No.FUN-730064
                     CALL cl_create_qry() RETURNING g_api[i].api04
                     DISPLAY g_api[i].api04 TO api04
#No.FUN-680029--begin
                  WHEN INFIELD(api041) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     LET g_qryparam.arg1 = g_bookno2  #TQC-790133
                     LET g_qryparam.default1 = g_api[i].api041
                     CALL cl_create_qry() RETURNING g_api[i].api041
                     DISPLAY g_api[i].api041 TO api041
#No.FUN-680029--end
                  WHEN INFIELD(api07)      #部門代號
                     CALL cl_init_qry_var()
                     LET g_qryparam.form ="q_gem"
                     LET g_qryparam.default1 = g_api[i].api07
                     CALL cl_create_qry() RETURNING g_api[i].api07
                     DISPLAY g_api[i].api07 TO api07
                 #str CHI-8C0005 add
                  WHEN INFIELD(api930)     #成本中心
                     CALL cl_init_qry_var()
                     LET g_qryparam.form ="q_gem4"
                     LET g_qryparam.default1 = g_api[i].api930
                     CALL cl_create_qry() RETURNING g_api[i].api930
                     DISPLAY g_api[i].api930 TO api930
                 #end CHI-8C0005 add
                  WHEN INFIELD(api06)     #查詢常用摘要
                     CALL q_aad(FALSE,TRUE,g_api[i].api06) RETURNING g_api[i].api06
                     DISPLAY g_api[i].api06 TO api06
                  #-----MOD-830040---------
                  #WHEN INFIELD(api21)    #查詢異動碼-1
                  #   CALL cl_init_qry_var()
                  #   LET g_qryparam.form ="q_aee"
                  #   LET g_qryparam.default1 =g_api[i].api21
                  #   LET g_qryparam.arg1 =g_api[i].api04
                  #   LET g_qryparam.arg2 =1
                  #   CALL cl_create_qry() RETURNING g_api[i].api21
                  #    DISPLAY g_api[i].api21 TO api21      #No:MOD-490344
                  #WHEN INFIELD(api22)    #查詢異動碼-2
                  #   CALL cl_init_qry_var()
                  #   LET g_qryparam.form ="q_aee"
                  #   LET g_qryparam.default1 =g_api[i].api22
                  #   LET g_qryparam.arg1 =g_api[i].api04
                  #   LET g_qryparam.arg2 =2
                  #   CALL cl_create_qry() RETURNING g_api[i].api22
                  #    DISPLAY g_api[i].api22 TO api22       #No:MOD-490344
                  #WHEN INFIELD(api23)    #查詢異動碼-1
                  #   CALL cl_init_qry_var()
                  #   LET g_qryparam.form ="q_aee"
                  #   LET g_qryparam.default1 =g_api[i].api23
                  #   LET g_qryparam.arg1 =g_api[i].api04
                  #   LET g_qryparam.arg2 =3
                  #   CALL cl_create_qry() RETURNING g_api[i].api23
                  #    DISPLAY g_api[i].api23 TO api23      #No:MOD-490344
                  #WHEN INFIELD(api24)
                  #   CALL cl_init_qry_var()
                  #   LET g_qryparam.form ="q_aee"
                  #   LET g_qryparam.default1 =g_api[i].api24
                  #   LET g_qryparam.arg1 =g_api[i].api04
                  #   LET g_qryparam.arg2 =4
                  #   CALL cl_create_qry() RETURNING g_api[i].api24
                  #    DISPLAY g_api[i].api24 TO api24         #No:MOD-490344
                  #
                  ##FUN-5C0015 BY GILL --START
                  #WHEN INFIELD(api31)    #異動碼5
                  #   CALL cl_init_qry_var()
                  #   LET g_qryparam.form ="q_aee"
                  #   LET g_qryparam.default1 =g_api[i].api31
                  #   LET g_qryparam.arg1 =g_api[i].api04
                  #   LET g_qryparam.arg2 =5
                  #   CALL cl_create_qry() RETURNING g_api[i].api31
                  #    DISPLAY g_api[i].api31 TO api31
                  #WHEN INFIELD(api32)    #異動碼6
                  #   CALL cl_init_qry_var()
                  #   LET g_qryparam.form ="q_aee"
                  #   LET g_qryparam.default1 =g_api[i].api32
                  #   LET g_qryparam.arg1 =g_api[i].api04
                  #   LET g_qryparam.arg2 =6
                  #   CALL cl_create_qry() RETURNING g_api[i].api32
                  #    DISPLAY g_api[i].api32 TO api32
                  #WHEN INFIELD(api33)    #異動碼7
                  #   CALL cl_init_qry_var()
                  #   LET g_qryparam.form ="q_aee"
                  #   LET g_qryparam.default1 =g_api[i].api33
                  #   LET g_qryparam.arg1 =g_api[i].api04
                  #   LET g_qryparam.arg2 =7
                  #   CALL cl_create_qry() RETURNING g_api[i].api33
                  #    DISPLAY g_api[i].api33 TO api33
                  #WHEN INFIELD(api34)    #異動碼8
                  #   CALL cl_init_qry_var()
                  #   LET g_qryparam.form ="q_aee"
                  #   LET g_qryparam.default1 =g_api[i].api34
                  #   LET g_qryparam.arg1 =g_api[i].api04
                  #   LET g_qryparam.arg2 =8
                  #   CALL cl_create_qry() RETURNING g_api[i].api34
                  #    DISPLAY g_api[i].api34 TO api34
                  #WHEN INFIELD(api35)    #異動碼9
                  #   CALL cl_init_qry_var()
                  #   LET g_qryparam.form ="q_aee"
                  #   LET g_qryparam.default1 =g_api[i].api35
                  #   LET g_qryparam.arg1 =g_api[i].api04
                  #   LET g_qryparam.arg2 =9
                  #   CALL cl_create_qry() RETURNING g_api[i].api35
                  #    DISPLAY g_api[i].api35 TO api35
                  #WHEN INFIELD(api36)    #異動碼10
                  #   CALL cl_init_qry_var()
                  #   LET g_qryparam.form ="q_aee"
                  #   LET g_qryparam.default1 =g_api[i].api36
                  #   LET g_qryparam.arg1 =g_api[i].api04
                  #   LET g_qryparam.arg2 =10
                  #   CALL cl_create_qry() RETURNING g_api[i].api36
                  #    DISPLAY g_api[i].api36 TO api36
                  #WHEN INFIELD(api37)    #關係人異動碼
                  #   CALL cl_init_qry_var()
                  #   LET g_qryparam.form ="q_aee"
                  #   LET g_qryparam.default1 =g_api[i].api37
                  #   LET g_qryparam.arg1 =g_api[i].api04
                  #   LET g_qryparam.arg2 =99
                  #   CALL cl_create_qry() RETURNING g_api[i].api37
                  #    DISPLAY g_api[i].api37 TO api37
                  ##FUN-5C0015 BY GILL --END

                  WHEN INFIELD(api21)    #查詢異動碼-1
                       CALL s_ahe_qry(g_api[i].api04,'1','i',g_api[i].api21,g_bookno1)  
                         RETURNING g_api[i].api21
                       DISPLAY g_api[i].api21 TO api21
                       NEXT FIELD api21
                  
                  WHEN INFIELD(api22)    #查詢異動碼-2
                       CALL s_ahe_qry(g_api[i].api04,'2','i',g_api[i].api22,g_bookno1)  
                         RETURNING g_api[i].api22
                       DISPLAY g_api[i].api22 TO api22
                       NEXT FIELD api22
                  
                  WHEN INFIELD(api23)    #查詢異動碼-3
                       CALL s_ahe_qry(g_api[i].api04,'3','i',g_api[i].api23,g_bookno1)  
                         RETURNING g_api[i].api23
                       DISPLAY g_api[i].api23 TO api23
                       NEXT FIELD api23
                  
                  WHEN INFIELD(api24)    #查詢異動碼-4
                       CALL s_ahe_qry(g_api[i].api04,'4','i',g_api[i].api24,g_bookno1)  
                         RETURNING g_api[i].api24
                       DISPLAY g_api[i].api24 TO api24
                       NEXT FIELD api24
                  
                  WHEN INFIELD(api31)    #查詢異動碼-5
                       CALL s_ahe_qry(g_api[i].api04,'5','i',g_api[i].api31,g_bookno1)  
                         RETURNING g_api[i].api31
                       DISPLAY g_api[i].api31 TO api31
                       NEXT FIELD api31
                  
                  WHEN INFIELD(api32)    #查詢異動碼-6
                       CALL s_ahe_qry(g_api[i].api04,'6','i',g_api[i].api32,g_bookno1)  
                         RETURNING g_api[i].api32
                       DISPLAY g_api[i].api32 TO api32
                       NEXT FIELD api32
                  
                  WHEN INFIELD(api33)    #查詢異動碼-7
                       CALL s_ahe_qry(g_api[i].api04,'7','i',g_api[i].api33,g_bookno1)  
                         RETURNING g_api[i].api33
                       DISPLAY g_api[i].api33 TO api33
                       NEXT FIELD api33
                  
                  WHEN INFIELD(api34)    #查詢異動碼-8
                       CALL s_ahe_qry(g_api[i].api04,'8','i',g_api[i].api34,g_bookno1)  
                         RETURNING g_api[i].api34
                       DISPLAY g_api[i].api34 TO api34
                       NEXT FIELD api34
                  
                #FUN-810045 begin
                  #WHEN INFIELD(api35)    #查詢異動碼-9
                  #     CALL s_ahe_qry(g_api[i].api04,'9','i',g_api[i].api35,g_bookno1)  
                  #       RETURNING g_api[i].api35
                  #     DISPLAY g_api[i].api35 TO api35
                  #     NEXT FIELD api35
                  #
                  #WHEN INFIELD(api36)    #查詢異動碼-10
                  #     CALL s_ahe_qry(g_api[i].api04,'10','i',g_api[i].api36,g_bookno1) 
                  #       RETURNING g_api[i].api36
                  #     DISPLAY g_api[i].api36 TO api36
                  #     NEXT FIELD api36
                  WHEN INFIELD(api26)    #專案
                    CALL cl_init_qry_var()
                    LET g_qryparam.form ="q_pja2"  
                    CALL cl_create_qry() RETURNING g_api[i].api26 
                    DISPLAY BY NAME g_api[i].api26
                    NEXT FIELD api26
                  
                  WHEN INFIELD(api35)    #查詢異動碼-9(WBS)
                     CALL cl_init_qry_var()
                     LET g_qryparam.form ="q_pjb4"
                     LET g_qryparam.arg1 = g_api[i].api26  
                     CALL cl_create_qry() RETURNING g_api[i].api35 
                     DISPLAY BY NAME g_api[i].api35
                       NEXT FIELD api35
                  
                  WHEN INFIELD(api36)    #查詢異動碼-10(費用原因)
                    CALL cl_init_qry_var()
                    LET g_qryparam.form ="q_azf"
                    LET g_qryparam.arg1 = '2'
                    CALL cl_create_qry() RETURNING g_api[i].api36
                    DISPLAY g_api[i].api36 TO api36
                    NEXT FIELD api36
                #FUN-810045 end
  
                  WHEN INFIELD(api37)    #關係人
                       CALL s_ahe_qry(g_api[i].api04,'99','i',g_api[i].api37,g_bookno1) 
                         RETURNING g_api[i].api37
                       DISPLAY g_api[i].api37 TO api37
                       NEXT FIELD api37
               
                  #-----END MOD-830040-----


                  OTHERWISE EXIT CASE
               END CASE
 
            ON ACTION CONTROLO
               IF INFIELD(api04) AND i > 1 THEN
                  LET g_api[i].* = g_api[i-1].*
                  DISPLAY g_api[i].* TO s_api[i].*           #MOD-B10011
               END IF
               IF INFIELD(api06) AND i > 1 THEN
                  LET g_api[i].api06 = g_api[i-1].api06
               END IF

            ON IDLE g_idle_seconds
               CALL cl_on_idle()
               CONTINUE INPUT
 
             ON ACTION about         #MOD-4C0121
                CALL cl_about()      #MOD-4C0121
 
             ON ACTION help          #MOD-4C0121
                CALL cl_show_help()  #MOD-4C0121
 
             ON ACTION controlg      #MOD-4C0121
                CALL cl_cmdask()     #MOD-4C0121
 
             ON ACTION controls                       #No.FUN-6B0033                                                                       
                CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033

         END INPUT
      END IF

      IF l_exit_sw = 'Y' THEN
         EXIT WHILE
      END IF
   END WHILE


   CLOSE WINDOW t110_ccc_w
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF

   CALL t110_ins_api(p_cmd)  

END FUNCTION

FUNCTION t110_api26(p_cmd,p_api26)
 DEFINE p_cmd      LIKE type_file.chr1,    #No.FUN-690028 VARCHAR(1)
        p_api26    LIKE api_file.api26,
       #l_gja02    LIKE gja_file.gja02,  #FUN-810045 remark
       #l_gjaacti  LIKE gja_file.gjaacti #FUN-810045 remark
        l_pjaacti  LIKE pja_file.pjaacti  #FUN-810045 
       ,l_pjaclose LIKE pja_file.pjaclose #FUN-960038

   LET g_errno = ' '
  #FUN-810045 begin
   #SELECT gja02,gjaacti INTO l_gja02,l_gjaacti
   #  FROM gja_file WHERE gja01 = p_api26
   SELECT pjaacti,pjaclose INTO l_pjaacti,l_pjaclose
     FROM pja_file WHERE pja01 = p_api26
  #FUN-810045 end
   CASE WHEN STATUS=100          LET g_errno = 'agl-007'  #7926 
        WHEN l_pjaacti = 'N'     LET g_errno = '9028'           #FUN-810045 gjaacti->pjaacti
        WHEN l_pjaclose = 'Y'    LET g_errno = 'abg-503'  #FUN-960038
        OTHERWISE           LET g_errno = SQLCA.sqlcode USING '----------'
   END CASE
END FUNCTION
 
FUNCTION t110_api21(p_cmd,p_seq,p_key,p_aee01)
 DEFINE p_cmd    LIKE aag_file.aag151,    # 檢查否
        #p_seq        VARCHAR(1),             # 項        #FUN-660117 remark
        #p_key        VARCHAR(20),            # 異動碼    #FUN-660117 remark
        p_seq        LIKE aee_file.aee02, # 項         #FUN-660117
        p_key        LIKE aee_file.aee03, # 異動碼     #FUN-660117
        p_aee01      LIKE aee_file.aee01,
        l_aeeacti  LIKE aee_file.aeeacti,
        l_aee04    LIKE aee_file.aee04

   LET g_errno = ' '
   SELECT aee04,aeeacti INTO l_aee04,l_aeeacti FROM aee_file
    WHERE aee01 = p_aee01
      AND aee02 = p_seq
      AND aee03 = p_key
   CASE p_cmd
      WHEN '2'   #異動碼必須輸入不檢查
         IF p_key IS NULL OR p_key = ' ' THEN
            LET g_errno = 'agl-154'
         END IF
      WHEN '3'   #異動碼必須輸入要檢查
         CASE
            WHEN p_key IS NULL OR p_key = ' '
               LET g_errno = 'agl-154'
            WHEN l_aeeacti = 'N'
               LET g_errno = '9027'
            WHEN SQLCA.sqlcode = 100
               LET g_errno = 'agl-153'
            OTHERWISE
               LET g_errno = SQLCA.sqlcode USING'-------'
         END CASE
      OTHERWISE EXIT CASE
   END CASE
END FUNCTION
 
FUNCTION t110_ins_api(p_cmd)
   DEFINE p_cmd LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE i,j,k LIKE type_file.num5    #No.FUN-690028 SMALLINT
   LET j = ARR_COUNT()
   DELETE FROM api_file
    WHERE api01 = g_apa.apa01 AND api02 = p_cmd
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
#     CALL cl_err('t110_ccc(ckp#1):',SQLCA.sqlcode,1)   #No.FUN-660122
      CALL cl_err3("del","api_file", g_apa.apa01,p_cmd,SQLCA.sqlcode,"","t110_ccc(ckp#1):",1)  #No.FUN-660122
      RETURN
   END IF
    FOR i = 1 TO g_api.getLength() #No:MOD-480131
     #IF g_api[i].api04 IS NULL THEN     #No.TQC-7A0095 mark
      IF cl_null(g_api[i].api04) AND cl_null(g_api[i].api041) THEN    #No.TQC-7A0095 
         CONTINUE FOR 
      END IF
      IF g_api[i].api05f = 0 THEN CONTINUE FOR END IF
      #No.TQC-810091--begin--
      LET g_api[i].api05 = cl_digcut(g_api[i].api05 ,g_azi04)   
      LET g_api[i].api05f= cl_digcut(g_api[i].api05f,t_azi04)   
      #No.TQC-810091---end---
      INSERT INTO api_file(api01,api02,api03,api04,api041,api07,api06,api05f,api05,      #No.FUN-680029
                          #api25,api26,api21,api22,api23,api24,  #No.FUN-830161
                           api26,api21,api22,api23,api24,        #No.FUN-830161

                           #FUN-5C0015 BY GILL --START
                           api31,api32,api33,api34,api35,api36,api37
                           #FUN-5C0015 BY GILL --END
                          ,api930   #CHI-8C0005 add
                           )
           VALUES(g_apa.apa01,p_cmd,i,g_api[i].api04,g_api[i].api041,g_api[i].api07,       #No.FUN-680029
                  g_api[i].api06,g_api[i].api05f,g_api[i].api05,
                 #g_api[i].api25,g_api[i].api26,g_api[i].api21,  #No.FUN-830161
                  g_api[i].api26,g_api[i].api21,                 #No.FUN-830161
                  g_api[i].api22,g_api[i].api23,g_api[i].api24,

                  #FUN-5C0015 BY GILL --START
                  g_api[i].api31,g_api[i].api32,g_api[i].api33,g_api[i].api34,
                  g_api[i].api35,g_api[i].api36,g_api[i].api37
                  #FUN-5C0015 BY GILL --END
                 ,g_api[i].api930   #CHI-8C0005 add 
                  )
      IF SQLCA.sqlcode THEN
#        CALL cl_err('t110_ccc(ckp#2):',SQLCA.sqlcode,1)   #No.FUN-660122
         CALL cl_err3("ins","api_file",g_apa.apa01,p_cmd,SQLCA.sqlcode,"","t110_ccc(ckp#2):",1)  #No.FUN-660122
      END IF
   END FOR
END FUNCTION

#str FUN-7A0050 add
FUNCTION t110_ins_api_12()
   DEFINE p_apa            RECORD LIKE apa_file.*
   DEFINE p_apb            RECORD LIKE apb_file.*
   DEFINE p_api            RECORD LIKE api_file.*
   DEFINE l_api            RECORD LIKE api_file.*
   DEFINE l_apc            RECORD LIKE apc_file.*
   DEFINE l_diff_api03     LIKE api_file.api03
   DEFINE l_diff_api05f    LIKE api_file.api05f
   DEFINE l_diff_api05     LIKE api_file.api05
   DEFINE l_apa00          LIKE apa_file.apa00
   DEFINE l_apa13          LIKE apa_file.apa13
   DEFINE l_apa72          LIKE apa_file.apa72
   DEFINE l_apa73          LIKE apa_file.apa73
   DEFINE l_apa541         LIKE apa_file.apa541
   DEFINE l_apc13          LIKE apc_file.apc13
   DEFINE l_api05          LIKE api_file.api05
   DEFINE l_api05f         LIKE api_file.api05f
   DEFINE l_apa14          LIKE apa_file.apa14

   LET g_success = 'Y'
   LET g_sql = "SELECT apa_file.*,apb_file.* FROM apa_file,apb_file ",
               " WHERE apa01 = apb01 ",
               "   AND apa00 = '12'",
               "   AND apa01 = '",g_apa.apa01,"'",
               " ORDER BY apa01,apb02 "

   PREPARE t110_preapi  FROM g_sql
   IF STATUS THEN
      CALL s_errmsg("apa01",g_apb[l_ac].apb21,"prepare",STATUS,0)
      RETURN
   END IF

   DECLARE t110_csapi CURSOR WITH HOLD FOR t110_preapi

   LET p_api.api02 = '2'

   FOREACH t110_csapi INTO p_apa.*,p_apb.*
      LET p_api.api01 = p_apa.apa01
      #尋找該筆資料存在, 何筆暫估中. 
      LET p_api.api26 = NULL
      LET p_api.api05f= NULL
      LET p_api.api05 = NULL
      LET p_api.api07 = NULL
      LET p_api.api04 = NULL

      LET g_sql = "SELECT apa00,apb01,apb24,apb10,apa22,apa54,apa541",
                  "  FROM apb_file,apa_file ",
                  "WHERE apb01 = '",p_apb.apb21,"'",
                  "  AND apb02 = '",p_apb.apb22,"'",
                  "  AND apb01 = apa01",
                  "  AND apa08 = 'UNAP'",
                  "  AND apa00 = '16'"
      PREPARE t110_preapb00  FROM g_sql                                                                                             
      IF STATUS THEN                                                                                                                
         LET g_showmsg=p_apb.apb21,"/",p_apb.apb22,"/","UNAP"
         CALL s_errmsg("apb21,apb22,apa08",g_showmsg,"prepare:",STATUS,0)
         CONTINUE FOREACH
      END IF                                                                                                                        
      DECLARE t110_csapb00 CURSOR WITH HOLD FOR t110_preapb00                                                                       
                                                                                                                                    
      FOREACH t110_csapb00 INTO l_apa00,p_api.api26,p_api.api05f,p_api.api05,p_api.api07,p_api.api04,l_apa541 #No.FUN-680029 新增l_apa541
         IF STATUS THEN
            LET g_success = 'N' 
            EXIT FOREACH 
         END IF 

         IF p_api.api26 IS NOT NULL AND p_api.api26 <> 'DIFF' THEN
            SELECT apa13,apa72,apa73,apa14          #TQC-940171 add apa14
              INTO l_apa13,l_apa72,l_apa73,l_apa14  #TQC-940171 add apa14
              FROM apa_file
             WHERE apa01=p_api.api26 AND apa41='Y' AND apa42='N'
            IF g_apz.apz27 = 'Y' AND g_aza.aza17 != l_apa13 THEN
               LET p_api.api05=p_api.api05f*l_apa72
               LET p_api.api05= cl_digcut(p_api.api05,g_azi04)
            END IF                                                                                                                     
           #str TQC-940171 add
            IF g_apz.apz27!= 'Y' AND g_aza.aza17 != l_apa13 THEN
               LET p_api.api05=p_api.api05f*l_apa14
               LET p_api.api05=cl_digcut(p_api.api05,g_azi04)
            END IF                                                                                                                     
           #end TQC-940171 add
         END IF                                                                                                                        
         IF p_api.api05f IS NULL THEN 
            LET p_api.api05f = 0 
         END IF 
         IF p_api.api05 IS NULL THEN
            LET p_api.api05 = 0 
         END IF 

         DECLARE t110_csapc CURSOR FOR
            SELECT apc_file.*,apa14 FROM apc_file,apa_file 
             WHERE apc01=apa01 AND apa01=p_api.api26
         FOREACH t110_csapc INTO l_apc.*,l_apa14
            IF p_api.api05 = 0 THEN
               EXIT FOREACH
            END IF
            IF l_apc.apc13=0 THEN
               CONTINUE FOREACH
            END IF
            IF l_apc.apc13>0 THEN
               IF p_api.api05 >= l_apc.apc13 THEN
                  LET l_api05 = l_apc.apc13
               ELSE
                  LET l_api05 = p_api.api05
               END IF
               SELECT * INTO l_api.* FROM api_file 
                WHERE api01=p_api.api01 AND api40=l_apc.apc02
                  AND api02=p_api.api02 AND api04=p_api.api04
                  AND api26=p_api.api26
               IF SQLCA.sqlcode = 100 THEN
                  LET l_api.* = p_api.*
                  SELECT MAX(api03)+1 INTO l_api.api03 FROM api_file
                   WHERE api01 = l_api.api01
                  IF cl_null(l_api.api03) THEN   #No.TQC-760006
                     LET l_api.api03 = 1
                  END IF 
                  LET l_api.api06 = 'UNAP:',l_api.api26
                  LET l_api.api05 = l_api05             #本幣
                  LET l_api.api05f= l_api05/l_apa14     #原幣=本幣/匯率   #TQC-6B0156
                  LET l_api.api40 = l_apc.apc02
                  #No.TQC-810091--begin--
                  LET l_api.api05 = cl_digcut(l_api.api05 ,g_azi04)   
                  LET l_api.api05f= cl_digcut(l_api.api05f,t_azi04)   
                  #No.TQC-810091---end---
                #FUN-810045 begin
                  LET l_api.api35 = p_apb.apb36
                  LET l_api.api36 = p_apb.apb31
                #FUN-810045 end
                  INSERT INTO api_file VALUES (l_api.*)
                  IF SQLCA.sqlcode THEN
                     LET g_success = 'N'
                     LET g_showmsg=l_api.api01,"/",l_api.api02,"/",l_api.api03
                     CALL s_errmsg("api01,api02,api03",g_showmsg,"ins api_file",SQLCA.sqlcode,1)
                     CONTINUE FOREACH
                  ELSE 
                     LET p_api.api05 =  p_api.api05-l_api05
                  END IF
               ELSE   #No.TQC-760006
                  IF SQLCA.sqlcode = 0 THEN
                     IF l_api.api05+l_api05 <= l_apc.apc13 THEN
                        LET l_api.api05  =  l_api05+l_api.api05
                        LET l_api.api05f =  l_api.api05f + l_api05*l_apa14
                        UPDATE api_file SET api05  = l_api.api05,
                                            api05f = l_api.api05f
                         WHERE api01 = l_api.api01 AND  api40 = l_api.api40
                        IF SQLCA.sqlcode THEN
                           LET g_success='N'
                           LET g_showmsg=l_api.api01,"/",l_api.api40
                           CALL s_errmsg("api01,api40",g_showmsg,"upd api_file",SQLCA.sqlcode,1)
                           CONTINUE FOREACH
                        ELSE 
                           LET p_api.api05 =  p_api.api05-l_api05
                        END IF
                     ELSE
                        CONTINUE FOREACH
                     END IF
                  END IF
               END IF
            END IF 
         END FOREACH
      END FOREACH   #MOD-790033
   END FOREACH   #MOD-790033

   #有匯差的情況                                                                                         
   SELECT MAX(api03)+1,SUM(api05f),SUM(api05)                                                                                    
     INTO l_diff_api03,l_diff_api05f,l_diff_api05                                                                                
     FROM api_file WHERE api01 = p_api.api01                                                                                     
   IF l_diff_api05 != l_diff_api05f*g_apa.apa14 THEN                                                                             
      LET l_diff_api05 = l_diff_api05f*g_apa.apa14 - l_diff_api05                                                                
      LET l_diff_api05= cl_digcut(l_diff_api05,g_azi04)
      LET p_api.api03=l_diff_api03                                                                                               
      LET p_api.api04=''                                                                                                         
      LET p_api.api05f=0                                                                                                         
      LET p_api.api05=l_diff_api05                                                                                               
      LET p_api.api06=''                                                                                                         
      LET p_api.api26='DIFF'                                                                                                     
      LET p_api.api40=NULL
    #FUN-810045 begin
      LET p_api.api35 = ' '
      LET p_api.api36 = ' '
    #FUN-810045 end

      INSERT INTO api_file VALUES(p_api.*)                                                                                       
      IF SQLCA.sqlcode THEN                                                                                                      
         IF cl_sql_dup_value(SQLCA.SQLCODE) THEN 
            UPDATE api_file SET api05 = l_diff_api05                                                                             
             WHERE api01=p_api.api01                                                                                             
               AND api26='DIFF'                                                                                                  
            IF SQLCA.sqlcode THEN                                                                                                
               LET g_success = 'N'                                                                                               
               LET g_showmsg=p_api.api01,"/","DIFF"
               CALL s_errmsg("api01,api26",g_showmsg,"",SQLCA.sqlcode,1)
            END IF                                                                                                               
         ELSE
            LET g_success = 'N'                                                                                                  
            LET g_showmsg=p_api.api01,"/",p_api.api02,"/",p_api.api03
            CALL s_errmsg("api01,api02,api03",g_showmsg,"insert api diff",SQLCA.sqlcode,1)
         END IF                                                                                                                  
      END IF                                                                                                                     
   END IF                                                                                                                        
END FUNCTION
#end FUN-7A0050 add

FUNCTION t110_xw()
DEFINE  g_aba14_t  LIKE aba_file.aba14    #No.TQC-950004  
DEFINE  chk_aba00  LIKE type_file.num5    #MOD-C40155 add
DEFINE l_cnt       LIKE type_file.num5    #MOD-C40155 add

   OPEN WINDOW t110_xw2 WITH FORM "agl/42f/aglt1101"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
   CALL cl_ui_locale("aglt1101")

   CALL cl_set_head_visible("","YES")            #No.FUN-6B0033

   LET g_aba.aba00 = g_apz.apz02b                                                  #MOD-C40155 add
   DISPLAY BY NAME g_aba.aba00                                                     #MOD-C40155 add
  #INPUT BY NAME g_aba.aba13,g_aba.aba14,g_aba.aba15 WITHOUT DEFAULTS              #MOD-C40155 mark
   INPUT BY NAME g_aba.aba13,g_aba.aba14,g_aba.aba15,g_aba.aba00 WITHOUT DEFAULTS  #MOD-C40155 add
      AFTER FIELD aba14
         IF g_aba.aba14 = '0' THEN
            LET INT_FLAG=1
            EXIT INPUT
         END IF
         IF g_aba.aba14 NOT MATCHES "[123]" THEN
            NEXT FIELD aba14
         END IF
#No.TQC-950004 --begin                                                          
         IF NOT cl_null(g_aba14_t) AND g_aba.aba14 <> g_aba14_t THEN            
            LET g_aba.aba15 =NULL                                               
         END IF                                                                 
         LET g_aba14_t =g_aba.aba14                                             
#No.TQC-950004 --end  

      AFTER FIELD aba15
         IF NOT cl_null(g_aba.aba15) THEN    #No.TQC-950004   
         SELECT aha01 FROM aha_file
          WHERE aha000 = g_aba.aba14 AND aha01 = g_aba.aba15
            AND aha00 = g_bookno1    #TQC-750121
         IF STATUS THEN
#           CALL cl_err('',SQLCA.sqlcode,0)   #No.FUN-660122
            CALL cl_err3("sel","aha_file",g_aba.aba14,g_aba.aba15,SQLCA.sqlcode,"","",1)  #No.FUN-660122
            NEXT FIELD aba15
         END IF
         END IF          #No.TQc-950004

     #------------------------MOD-C40155----------------------(S)
      AFTER FIELD aba00
         IF NOT cl_null(g_aba.aba00) THEN
            SELECT COUNT(*) INTO l_cnt FROM aha_file
             WHERE aha00 = g_aba.aba00
               AND aha01 = g_aba.aba15
            IF l_cnt = 0 THEN
               CALL cl_err('','agl-090',0)
               NEXT FIELD  aba00
            END IF
          END IF
     #------------------------MOD-C40155----------------------(E)

      ON ACTION CONTROLP
         CASE                                                             #MOD-C40155 add
            WHEN INFIELD(aba15)                                           #MOD-C40155 add
                #IF INFIELD(aba15) THEN                                           #MOD-C40155 mark
                 CALL q_aha(FALSE,TRUE,g_aba.aba15,g_apz.apz02b,g_aba.aba14)
                 RETURNING g_aba.aba15
                #CALL cl_init_qry_var()
                #LET g_qryparam.form ="q_aha"
                #LET g_qryparam.default1 =g_aba.aba15
                #LET g_qryparam.arg1 = g_apz.apz02b
                #LET g_qryparam.arg2 = g_aba.aba14
                #CALL cl_create_qry() RETURNING g_aba.aba15
                #CALL FGL_DIALOG_SETBUFFER(g_aba.aba15)
                 DISPLAY BY NAME g_aba.aba15
                #END IF                                       #MOD-C40155 mark
           #------------------------MOD-C40155----------------------(S)
            WHEN INFIELD(aba00)
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_aaa"
                 CALL cl_create_qry() RETURNING g_aba.aba00
                 DISPLAY BY NAME g_aba.aba00
            END CASE
           #------------------------MOD-C40155----------------------(E)
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
 
   END INPUT
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      CLOSE WINDOW t110_xw2
      RETURN
   END IF
   DECLARE t110_c5 CURSOR FOR
      SELECT * FROM ahb_file
       WHERE ahb000 = g_aba.aba14 
         AND ahb01 = g_aba.aba15 
         AND ahb06='1'
         AND ahb00 = g_aba.aba00               #MOD-C40155 add

   CASE WHEN g_aba.aba14 = '1' CALL t110_xw1()     # 固定金額
        WHEN g_aba.aba14 = '2' CALL t110_xw2()     # 固定比率
        WHEN g_aba.aba14 = '3' CALL t110_xw3()     # 變動比率
   END CASE
   CLOSE WINDOW t110_xw2
END FUNCTION

FUNCTION t110_xw1()
   DEFINE l_ahb         RECORD LIKE ahb_file.*
   DEFINE l_amt         LIKE type_file.num20_6     # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_amt2        LIKE type_file.num20_6     #MOD-6B0067
   DEFINE l_tot1,l_tot2 LIKE type_file.num20_6     # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_seq         LIKE type_file.num5        # No:FUN-690028 SMALLINT
   DEFINE l_seq1,l_seq2 LIKE type_file.num5        # No:FUN-690028 SMALLINT
   DEFINE l_api06       LIKE api_file.api06        #CHI-910036  

   LET l_api06 = ''  #CHI-910036 
   LET l_seq = 0
   SELECT MAX(api03) INTO l_seq FROM api_file WHERE api01=g_apa.apa01
   IF l_seq IS NULL THEN LET l_seq=0 END IF
   LET l_tot1 = 0 LET l_tot2 = 0
   LET g_success = 'Y'
   BEGIN WORK
   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa_rowid
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl xw1:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF
 #MOD-560240
#   FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
#   IF SQLCA.sqlcode THEN
#      CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
#      CLOSE t110_cl
#      ROLLBACK WORK
#      RETURN
#   END IF
 #END MOD-560240
   FOREACH t110_c5 INTO l_ahb.*
      LET l_amt = l_ahb.ahb07
      #LET l_amt = cl_digcut(l_amt,0)   #MOD-6B0067
      LET l_amt = cl_digcut(l_amt,g_azi04)   #MOD-6B0067
      IF l_amt = 0 THEN CONTINUE FOREACH END IF #no.5577
      LET l_amt2 = cl_digcut(l_amt/g_apa.apa14,t_azi04)   #MOD-6B0067
      LET l_seq = l_seq + 1
#CHI-910036---BEGIN                                                                                                                 
      IF cl_null(l_ahb.ahb04) THEN                                                                                                  
         LET l_api06 = g_apa.apa25                                                                                                  
      ELSE                                                                                                                          
         LET l_api06 = l_ahb.ahb04                                                                                                  
      END IF                                                                                                                        
#CHI-910036---END  
      MESSAGE " SEQ:",l_seq USING '###', " AMT:",l_amt
       INSERT INTO api_file(api01,api02,api03,api04,api05f,api05,api06,api061,  #No:MOD-470041
                           api062,api07,api21,api22,api23,api24,

                           #FUN-5C0015 BY GILL --START
                           api31,api32,api33,api34,api35,api36,api37,
                           #FUN-5C0015 BY GILL --END

                          #api25,api26)  #No.FUN-830161
                           api26,api930) #No.FUN-830161   #CHI-8C0005 add api930
             #VALUES (g_apa.apa01,'1',l_seq,l_ahb.ahb03,l_amt,l_amt,g_apa.apa25,   #MOD-6B0067
         #    VALUES (g_apa.apa01,'1',l_seq,l_ahb.ahb03,l_amt2,l_amt,g_apa.apa25,   #MOD-6B0067   #CHI-910036 
              VALUES (g_apa.apa01,'1',l_seq,l_ahb.ahb03,l_amt2,l_amt,l_api06,    #CHI-910036 
                     '','',l_ahb.ahb05,l_ahb.ahb11,l_ahb.ahb12,l_ahb.ahb13,
                     l_ahb.ahb14,

                     #FUN-5C0015 BY GILL --START
                     l_ahb.ahb31,l_ahb.ahb32,l_ahb.ahb33,l_ahb.ahb34,
                     l_ahb.ahb35,l_ahb.ahb36,l_ahb.ahb37,
                     #FUN-5C0015 BY GILL --END

                    #l_ahb.ahb15,l_ahb.ahb08)  #No.FUN-830161
                     l_ahb.ahb08,g_apa.apa930) #No.FUN-830161  #CHI-8C0005 add apa930
      IF STATUS OR SQLCA.SQLCODE THEN
#        CALL cl_err('t110_xw(ckp#4)',SQLCA.sqlcode,1)   #No.FUN-660122
         CALL cl_err3("ins","api_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_xw(ckp#4)",1)  #No.FUN-660122
         LET g_success = 'N'
         EXIT FOREACH
      END IF
   END FOREACH
   MESSAGE ''
   IF g_success = 'Y' THEN
      COMMIT WORK
   ELSE
      ROLLBACK WORK
   END IF
END FUNCTION

FUNCTION t110_xw2()
   DEFINE l_ahb         RECORD LIKE ahb_file.*
   DEFINE l_amt         LIKE type_file.num20_6     # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_amt2        LIKE type_file.num20_6     #MOD-6B0067
   DEFINE l_tot1,l_tot2 LIKE type_file.num20_6     # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_seq         LIKE type_file.num5        # No:FUN-690028 SMALLINT
   DEFINE l_seq1,l_seq2 LIKE type_file.num5        # No:FUN-690028 SMALLINT
   DEFINE l_api06       LIKE api_file.api06        #CHI-910036  
   
   LET l_api06 ='' #CHI-910036   
   LET l_seq = 0
   SELECT MAX(api03) INTO l_seq FROM api_file WHERE api01=g_apa.apa01
   IF l_seq IS NULL THEN LET l_seq=0 END IF
   LET l_tot1 = 0 LET l_tot2 = 0
   LET g_success = 'Y'
   BEGIN WORK
   
   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa_rowid
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl xw2:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF
 #MOD-560240
#   FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
#   IF SQLCA.sqlcode THEN
#      CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
#      CLOSE t110_cl
#      ROLLBACK WORK
#      RETURN
#   END IF
 #END MOD-560240
   FOREACH t110_c5 INTO l_ahb.*
      LET l_amt = g_aba.aba13 * l_ahb.ahb07 / 100
      #LET l_amt = cl_digcut(l_amt,0)   #MOD-6B0067
      LET l_amt = cl_digcut(l_amt,g_azi04)   #MOD-6B0067
      IF l_amt = 0 THEN CONTINUE FOREACH END IF
      LET l_amt2 = cl_digcut(l_amt/g_apa.apa14,t_azi04)   #MOD-6B0067
      LET l_seq = l_seq + 1
      IF l_ahb.ahb06 = '1' THEN
         LET l_tot1 = l_tot1 + l_amt
         LET l_seq1 = l_seq
      ELSE
         LET l_tot2 = l_tot2 + l_amt
         LET l_seq2 = l_seq
      END IF
#CHI-910036---BEGIN                                                                                                                 
      IF cl_null(l_ahb.ahb04) THEN                                                                                                  
         LET l_api06 = g_apa.apa25                                                                                                  
      ELSE                                                                                                                          
         LET l_api06 = l_ahb.ahb04                                                                                                  
      END IF                                                                                                                        
#CHI-910036---END  
      MESSAGE " SEQ:",l_seq USING '###', " AMT:",l_amt
       INSERT INTO api_file(api01,api02,api03,api04,api05f,api05,api06,api061,  #No:MOD-470041
                           api062,api07,api21,api22,api23,api24,

                           #FUN-5C0015 BY GILL --START
                           api31,api32,api33,api34,api35,api36,api37,
                           #FUN-5C0015 BY GILL --END

                          #api25,api26)  #No.FUN-830161
                           api26,api930) #No.FUN-830161   #CHI-8C0005 add api930
             #VALUES (g_apa.apa01,'1',l_seq,l_ahb.ahb03,l_amt,l_amt,   #MOD-6B0067
             VALUES (g_apa.apa01,'1',l_seq,l_ahb.ahb03,l_amt2,l_amt,   #MOD-6B0067
        #             g_apa.apa25,'','',l_ahb.ahb05,l_ahb.ahb11,l_ahb.ahb12,   #CHI-910036 
                     l_api06,'','',l_ahb.ahb05,l_ahb.ahb11,l_ahb.ahb12,    #CHI-910036  
                     l_ahb.ahb13,l_ahb.ahb14,

                     #FUN-5C0015 BY GILL --START
                     l_ahb.ahb31,l_ahb.ahb32,l_ahb.ahb33,l_ahb.ahb34,
                     l_ahb.ahb35,l_ahb.ahb36,l_ahb.ahb37,
                     #FUN-5C0015 BY GILL --END

                    #l_ahb.ahb15,l_ahb.ahb08)  #No.FUN-830161
                     l_ahb.ahb08,g_apa.apa930) #No.FUN-830161   #CHI-8C0005 add apa930
      IF STATUS OR SQLCA.SQLCODE THEN
#        CALL cl_err('t110_xw(ckp#4)',SQLCA.sqlcode,1)   #No.FUN-660122
         CALL cl_err3("ins","api_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_xw(ckp#4)",1)  #No.FUN-660122
         LET g_success = 'N'
         EXIT FOREACH
      END IF
   END FOREACH
   IF l_tot1 != g_aba.aba13 AND g_success = 'Y' THEN     # Debit 差異調整
      LET l_amt = g_aba.aba13 - l_tot1
      UPDATE api_file SET api05 = api05 + l_amt,
                          api05f=api05f + l_amt
       WHERE api01 = g_apa.apa01
         AND api02 = '1'
         AND api03 = l_seq1
   END IF
   MESSAGE ''
   IF g_success = 'Y' THEN
      COMMIT WORK
   ELSE
      ROLLBACK WORK
   END IF
END FUNCTION

FUNCTION t110_xw3()
   DEFINE l_ahb         RECORD LIKE ahb_file.*
   DEFINE l_amt         LIKE type_file.num20_6     # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_amt2        LIKE type_file.num20_6     #MOD-6B0067
   DEFINE l_tot1,l_tot2 LIKE type_file.num20_6     # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_seq         LIKE type_file.num5        # No:FUN-690028 SMALLINT
   DEFINE l_seq1,l_seq2 LIKE type_file.num5        # No:FUN-690028 SMALLINT
   DEFINE l_amtarr ARRAY[50] OF LIKE type_file.num20_6     # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_amt_debit,l_amt_credit LIKE type_file.num20_6     # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_rate        LIKE type_file.num20_6     # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   #DEFINE l_aag04          VARCHAR(1)         #FUN-660117 remark
   DEFINE l_aag04     LIKE aag_file.aag04   #FUN-660117
   DEFINE l_api06       LIKE api_file.api06        #CHI-910036     

   LET l_api06 = ''  #CHI-910036 
   LET g_success = 'Y'
   BEGIN WORK
   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa_rowid
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl xw3:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF
 #MOD-560240
#   FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
#   IF SQLCA.sqlcode THEN
#      CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
#      CLOSE t110_cl
#      ROLLBACK WORK
#      RETURN
#   END IF
 #END MOD-560240
   LET l_seq = 0
   SELECT MAX(api03) INTO l_seq FROM api_file WHERE api01=g_apa.apa01
   IF l_seq IS NULL THEN LET l_seq=0 END IF
   LET l_amt_debit  = 0 LET l_amt_credit = 0
   FOREACH t110_c5 INTO l_ahb.*          # 先得基礎科目餘額
      SELECT aag04 INTO l_aag04 FROM aag_file WHERE aag01 = l_ahb.ahb16
                                                AND aag00 = g_bookno1      #No.FUN-730064
                                                AND aagacti = 'Y'          #No.MOD-B70280 add
      #-----MOD-660104---------
      IF l_ahb.ahb05 IS NOT NULL THEN
         IF l_aag04 = '1' THEN  #資產類
            SELECT SUM(aao05-aao06) INTO l_amt FROM aao_file
                                    WHERE aao00 = g_apz.apz02b AND
                                    aao01 = l_ahb.ahb16 AND
                                    aao02 = l_ahb.ahb05 AND
                                    aao03 = YEAR(g_apa.apa02) AND
                                    aao04 <= MONTH(g_apa.apa02)
         ELSE  #損益類
            SELECT SUM(aao05-aao06) INTO l_amt FROM aao_file
                                   WHERE aao00 = g_apz.apz02b AND
                                         aao01 = l_ahb.ahb16 AND
                                         aao02 = l_ahb.ahb05 AND
                                         aao03 = YEAR(g_apa.apa02) AND
                                         aao04 = MONTH(g_apa.apa02)
         END IF
      ELSE
      #-----END MOD-660104-----
         IF l_aag04 = '1' THEN
            SELECT SUM(aah04-aah05) INTO l_amt FROM aah_file
             WHERE aah00 = g_apz.apz02b
               AND aah01 = l_ahb.ahb16
               AND aah02 = YEAR(g_apa.apa02)
               AND aah03 <= MONTH(g_apa.apa02)
         END IF
         IF l_aag04 = '2' THEN
            SELECT SUM(aah04-aah05) INTO l_amt FROM aah_file
             WHERE aah00 = g_apz.apz02b
               AND aah01 = l_ahb.ahb16
               AND aah02 = YEAR(g_apa.apa02)
               AND aah03 = MONTH(g_apa.apa02)
         END IF
      END IF   #MOD-660104
      #IF SQLCA.sqlcode OR l_amt IS NULL THEN LET l_amt = 0.001 END IF   #MOD-660104
      IF SQLCA.sqlcode OR l_amt IS NULL THEN LET l_amt = 0 END IF   #MOD-660104
      LET l_seq = l_seq + 1
      LET l_amtarr[l_seq] = l_amt
      IF l_ahb.ahb06 = '1' THEN
         LET l_amt_debit  = l_amt_debit  + l_amt
      ELSE
         LET l_amt_credit = l_amt_credit + l_amt
      END IF
   END FOREACH
   LET l_seq = 0
   SELECT MAX(api03) INTO l_seq FROM api_file WHERE api01=g_apa.apa01
   IF l_seq IS NULL THEN LET l_seq=0 END IF
   LET l_tot1 = 0 LET l_tot2 = 0
   FOREACH t110_c5 INTO l_ahb.*                         # 再算分攤比率
      LET l_seq = l_seq + 1
      IF l_ahb.ahb06 = '1' THEN
         LET l_rate = l_amtarr[l_seq] / l_amt_debit
      ELSE
         LET l_rate = l_amtarr[l_seq] / l_amt_credit
      END IF
      LET l_amt = g_aba.aba13 * l_rate
      #LET l_amt = cl_digcut(l_amt,0)   #MOD-6B0067
      LET l_amt = cl_digcut(l_amt,g_azi04)   #MOD-6B0067
      IF l_amt = 0 THEN CONTINUE FOREACH END IF
      LET l_amt2 = cl_digcut(l_amt/g_apa.apa14,t_azi04)   #MOD-6B0067
      IF l_ahb.ahb06 = '1' THEN
         LET l_tot1 = l_tot1 + l_amt
         LET l_seq1 = l_seq
      ELSE
         LET l_tot2 = l_tot2 + l_amt
         LET l_seq2 = l_seq
      END IF
#CHI-910036---BEGIN                                                                                                                 
      IF cl_null(l_ahb.ahb04) THEN                                                                                                  
         LET l_api06 = g_apa.apa25                                                                                                  
      ELSE                                                                                                                          
         LET l_api06 = l_ahb.ahb04                                                                                                  
      END IF                                                                                                                        
#CHI-910036---END 
      MESSAGE " SEQ:",l_seq USING '###'," AMT:",l_amt
       INSERT INTO api_file(api01,api02,api03,api04,api05f,api05,api06,api061,  #No:MOD-470041
                           api062,api07,api21,api22,api23,api24,

                           #FUN-5C0015 BY GILL --START
                           api31,api32,api33,api34,api35,api36,api37,
                           #FUN-5C0015 BY GILL --END

                          #api25,api26)  #No.FUN-830161
                           api26,api930) #No.FUN-830161   #CHI-8C0005 add api930
             #VALUES (g_apa.apa01,'1',l_seq,l_ahb.ahb03,l_amt,l_amt,   #MOD-6B0067
             VALUES (g_apa.apa01,'1',l_seq,l_ahb.ahb03,l_amt2,l_amt,   #MOD-6B0067
                 #    g_apa.apa25,'','',l_ahb.ahb05,                   #CHI-910036 
                     l_api06,'','',l_ahb.ahb05,                   #CHI-910036 
                     l_ahb.ahb11, l_ahb.ahb12, l_ahb.ahb13, l_ahb.ahb14,

                     #FUN-5C0015 BY GILL --START
                     l_ahb.ahb31,l_ahb.ahb32,l_ahb.ahb33,l_ahb.ahb34,
                     l_ahb.ahb35,l_ahb.ahb36,l_ahb.ahb37,
                     #FUN-5C0015 BY GILL --END

                    #l_ahb.ahb15, l_ahb.ahb08) #No.FUN-830161
                     l_ahb.ahb08,g_apa.apa930) #No.FUN-830161   #CHI-8C0005 add apa930
      IF STATUS OR SQLCA.SQLCODE THEN
#        CALL cl_err('t110_xw(ckp#4)',SQLCA.sqlcode,1)   #No.FUN-660122
         CALL cl_err3("ins","api_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_xw(ckp#4)",1)  #No.FUN-660122
         LET g_success = 'N'
         EXIT FOREACH
      END IF
   END FOREACH
   IF l_tot1 != g_aba.aba13 AND g_success = 'Y' THEN     # Debit 差異調整
      LET l_amt = g_aba.aba13 - l_tot1
      UPDATE api_file SET api05 = api05 + l_amt,
                          api05f= api05f + l_amt
       WHERE api01 = g_apa.apa01 AND api02 = '1'
         AND api03 = l_seq1
   END IF
   MESSAGE ''
   IF g_success = 'Y' THEN
      COMMIT WORK
   ELSE
      ROLLBACK WORK
   END IF
END FUNCTION

#No.TQC-7B0083  --Begin
#重要信息:t110_ppp中可以看得到三類資料
#1.和請款單身對應的暫估資料  正常產生方式:在請款單身錄入時,自動生成
#                            此類資料,不得在ppp()中做刪除
#                                     單號不得修改
#2.DIFF 有差異時,可以錄入的內容
#3.期初暫估資料  由于客戶上線時,會錄入一些期初暫估資料,這些暫估資料
#                是無法對應具體入庫單,所以無法在t110的單身中來做暫估衝帳
#                故只能在ppp()中自行來挑選,對于此類暫估單,由于和apb無直接對應
#                關系,所以可以INSERT/DELETE/UPDATE
#還有一個重要信息: 因為apb單身中,對于同一筆暫估單,衝多次都沒有關系
#                  但是也要和api中一一對應,故目api中的項次直接存放apb02
#                  這樣子,才可以在apb操作時,根據對應apb的具體操作來
#                  INSERT/DELETE/UPDATE api_file中對應衝暫估資料
#No.TQC-7B0083  --End  
FUNCTION t110_ppp(p_api02)
   DEFINE p_api02        LIKE api_file.api02 # 2.沖暫估AP (UNAP)#FUN-660117
   DEFINE b_api          RECORD LIKE api_file.*
   DEFINE l_api          DYNAMIC ARRAY OF RECORD
                          api26          LIKE api_file.api26,
                          api40          LIKE api_file.api40,      #No.FUN-680027
                          api04          LIKE api_file.api04,
                          api041         LIKE api_file.api041,     #No.FUN-680029
                          api07          LIKE api_file.api07,
                          api930         LIKE api_file.api930,  #CHI-8C0005 add
                          api05f         LIKE api_file.api05f,
                          api05          LIKE api_file.api05
                         END RECORD
   #No.TQC-7B0083  --Begin
   DEFINE l_api03_a      DYNAMIC ARRAY OF RECORD
                          api03          LIKE api_file.api03
                         END RECORD
   DEFINE l_apa33        LIKE apa_file.apa33
   DEFINE l_apa33f       LIKE apa_file.apa33f
   #No.TQC-7B0083  --End  
   DEFINE l_amt          LIKE api_file.api05
   DEFINE l_amtf         LIKE api_file.api05f
   DEFINE l_tot          LIKE api_file.api05
   DEFINE l_totf         LIKE api_file.api05
   DEFINE l_apa54        LIKE apa_file.apa54
   DEFINE l_apa541       LIKE apa_file.apa541   #No.FUN-680029
   DEFINE l_apa22        LIKE apa_file.apa22
   DEFINE l_apa34f       LIKE apa_file.apa34f
   DEFINE l_apa34        LIKE apa_file.apa34
   DEFINE l_apa14        LIKE apa_file.apa14
   DEFINE l_apa08        LIKE apa_file.apa08
   DEFINE l_apa06        LIKE apa_file.apa06
   DEFINE l_apa07        LIKE apa_file.apa07
   DEFINE api26_o        LIKE api_file.api26
   DEFINE api40_o        LIKE api_file.api40
   DEFINE api05f_o       LIKE api_file.api05f
   DEFINE l_apa60f       LIKE apa_file.apa60f
   DEFINE l_apa60        LIKE apa_file.apa60
   DEFINE l_apa00        LIKE apa_file.apa00    #No.FUN-5B0081  區分是入庫暫估還是退貨暫估
   #No.MOD-590312  --begin
   DEFINE l_apa13        LIKE apa_file.apa13
   DEFINE l_apa72        LIKE apa_file.apa72
   DEFINE l_apa73        LIKE apa_file.apa73
   #No.MOD-590312  --end
   DEFINE i,j,k,m        LIKE type_file.num5,   #No.FUN-690028 SMALLINT   #MOD-870011 add m
          l_allow_insert LIKE type_file.num5,   #可新增否  #No.FUN-690028 SMALLINT
          l_allow_delete LIKE type_file.num5    #可刪除否  #No.FUN-690028 SMALLINT
   DEFINE l_api05        LIKE api_file.api05    #MOD-640329
   DEFINE l_api05f       LIKE api_file.api05f   #MOD-640329
   DEFINE l_apb10        LIKE apb_file.apb10    #No.FUN-680010
   DEFINE l_apb24        LIKE apb_file.apb24    #No.FUN-680010
   DEFINE l_cnt          LIKE type_file.num5    #No.TQC-7B0083
   DEFINE l_apb21        LIKE apb_file.apb21    #No.TQC-7B0083
   DEFINE l_apb22        LIKE apb_file.apb22    #No.TQC-7B0083
   DEFINE l_flag         LIKE type_file.chr1    #No.TQC-7B0083
   DEFINE m_aag05        LIKE aag_file.aag05    #MOD-890084 add
   DEFINE m_aag05_1      LIKE aag_file.aag05    #CHI-8C0005 add

   #No.TQC-7B0083  --Begin
   #能否打開"衝暫估"功能,看單身有沒有apb34='Y'的值就可以
   #IF g_apa.apa51 != 'UNAP' THEN
   #   RETURN
   #END IF
  #IF g_apa.apa51 != 'UNAP' THEN   #MOD-920382 mark
      IF g_apa.apa56 != '5' THEN   #5.沖期初開帳的暫估   #CHI-930001 add
         LET l_cnt = 0 
         SELECT COUNT(*) INTO l_cnt FROM apb_file
          WHERE apb01 = g_apa.apa01
            AND apb34 = 'Y'
         IF l_cnt = 0 THEN 
            CALL cl_err(g_apa.apa01,'aap-134',1)   #MOD-920382 add
            RETURN
         END IF
      END IF   #CHI-930001 add
  #END IF   #MOD-920382 mark
   #No.TQC-7B0083  --End  

  #IF cl_null(g_apa.apa01) OR cl_null(g_apa.apa01[5,10]) THEN              #MOD-890281 mark
   IF cl_null(g_apa.apa01) OR cl_null(s_get_serial_no(g_apa.apa01)) THEN   #MOD-890281
      RETURN
   END IF

   #No.TQC-7B0083  --Begin
   #no.5916 必須扣除折讓金額
   SELECT apa60f,apa60,apa33,apa33f INTO l_apa60f,l_apa60,l_apa33,l_apa33f
     FROM apa_file WHERE apa01 = g_apa.apa01

   IF cl_null(l_apa60f) THEN
      LET l_apa60f = 0
   END IF

   IF cl_null(l_apa60)  THEN
      LET l_apa60 = 0
   END IF
   IF cl_null(l_apa33) THEN
      LET l_apa33 = 0
   END IF
   IF cl_null(l_apa33f) THEN
      LET l_apa33f = 0
   END IF
   #FUN-680010
   LET l_apb10=0
   LET l_apb24=0
   #SELECT SUM(apb10) INTO l_apb10 FROM apb_file,rvv_file
   # WHERE apb01=g_apa.apa01
   #   AND rvv01=apb21 AND rvv02=apb22
   #   AND rvv40='N'
   SELECT SUM(apb10),SUM(apb24) INTO l_apb10,l_apb24 FROM apb_file
    WHERE apb01=g_apa.apa01
      AND apb34='N'
   IF cl_null(l_apb10) THEN LET l_apb10=0 END IF
   IF cl_null(l_apb24) THEN LET l_apb24=0 END IF
   #SELECT SUM(apb24) INTO l_apb24 FROM apb_file,rvv_file
   # WHERE apb01=g_apa.apa01
   #   AND rvv01=apb21 AND rvv02=apb22
   #   AND rvv40='N'

  #str MOD-850081 mod
  #計算沖暫估單頭的金額時,不需扣掉折讓金額
  #LET l_amt  = g_apa.apa31  - l_apa60  - l_apb10 - l_apa33
  #LET l_amtf = g_apa.apa31f - l_apa60f - l_apb24 - l_apa33f
   LET l_amt  = g_apa.apa31  - l_apb10 - l_apa33
   LET l_amtf = g_apa.apa31f - l_apb24 - l_apa33f
  #end MOD-850081 mod
   #LET l_amt  = l_apb10
   #LET l_amtf = l_apb24
   #No.TQC-7B0083  --End  

   CALL cl_set_comp_visible("api930",g_aaz.aaz90='Y')  #CHI-8C0005 add

   OPEN WINDOW t110_ppp_w WITH FORM "aap/42f/aapt110_p"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
    CALL cl_ui_locale("aapt110_p")
 
#No.FUN-680029--begin
    IF g_aza.aza63 ='N' THEN
       CALL cl_set_comp_visible("api041",FALSE)
    END IF
#No.FUN-680029--end
    CALL cl_set_comp_entry("api40",FALSE)    #No.TQC-7B0083

   DISPLAY g_apa.apa01,l_amt,l_amtf TO api01,l_amt,l_amtf
   DECLARE t110_ppp_c CURSOR FOR
      SELECT api26,api40,api04,api041,api07,api930,api05f,api05,api03        #No.FUN-680027 No.FUN-680029  #No.TQC-7B0083   #CHI-8C0005 add api930
        FROM api_file
       WHERE api01 = g_apa.apa01 AND api02 = p_api02
       ORDER BY api26
   LET k = 1
   LET l_tot = 0
   LET l_totf= 0

   FOREACH t110_ppp_c INTO l_api[k].*,l_api03_a[k].api03      #No.TQC-7B0083
      IF STATUS THEN CALL cl_err('t110_ppp_c',STATUS,0) EXIT FOREACH END IF
     #str MOD-880212 add
     #-MOD-C20104-mark-
     #IF g_apz.apz27 = 'Y' AND g_aza.aza17 != g_apa.apa13 THEN
     #  #str MOD-8C0016 mod
     #  #應抓取暫估單aapt160的重評價匯率，而非沖暫估單aapt120的重評價匯率
     #   IF l_api[k].api26 != 'DIFF' THEN
     #      SELECT apa72 INTO l_apa72 FROM apa_file WHERE apa01=l_api[k].api26
     #      IF cl_null(l_apa72) THEN LET l_apa72=1 END IF
     #     #LET l_api[k].api05=l_api[k].api05f*g_apa.apa72
     #      LET l_api[k].api05=l_api[k].api05f*l_apa72
     #   END IF
     #  #end MOD-8C0016 mod
     #   LET l_api[k].api05=cl_digcut(l_api[k].api05,g_azi04)
     #END IF
     #-MOD-C20104-end-
     #end MOD-880212 add
      LET l_totf = l_totf+ l_api[k].api05f
      LET l_tot  = l_tot + l_api[k].api05

      LET k = k + 1
      IF k > g_max_rec THEN EXIT FOREACH END IF     #No:MOD-480131
   END FOREACH
   CALL l_api.deleteElement(k)

   LET k=k-1
   DISPLAY l_totf TO FORMONLY.api05_ft
   DISPLAY l_tot TO FORMONLY.api05_t

   IF g_apa.apa41 ='Y' THEN
      CALL cl_set_act_visible("accept,cancel", FALSE)
      DISPLAY ARRAY l_api TO s_api.* ATTRIBUTE(COUNT=k)
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE DISPLAY
 
         ON ACTION about         #MOD-4C0121
            CALL cl_about()      #MOD-4C0121
 
         ON ACTION help          #MOD-4C0121
            CALL cl_show_help()  #MOD-4C0121
 
         ON ACTION controlg      #MOD-4C0121
            CALL cl_cmdask()     #MOD-4C0121
 
         ON ACTION controls                       #No.FUN-6B0033                                                                       
            CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033

      END DISPLAY
      CLOSE WINDOW t110_ppp_w
      RETURN
   END IF

   IF g_apa.apa42 = 'Y' THEN
      CALL cl_err('','aap-165',0)
      CLOSE WINDOW t110_ppp_w
      RETURN
   END IF

 #-----------No:MOD-650061 modify
  #LET l_allow_insert = cl_detail_input_auth("insert")
  #LET l_allow_delete = cl_detail_input_auth("delete")
  #No.TQC-7B0083  --Begin
  #LET l_allow_insert = TRUE
  #LET l_allow_delete = TRUE
  #No.TQC-7B0083  --End  
 #-----------No:MOD-650061 end

   INPUT ARRAY l_api WITHOUT DEFAULTS FROM s_api.*
         ATTRIBUTE(COUNT=k,MAXCOUNT=g_max_rec,UNBUFFERED,
                  #INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)  #No.TQC-7B0083
                   INSERT ROW=FALSE,         DELETE ROW=TRUE          ,APPEND ROW=TRUE          )  #No.TQC-7B0083

      BEFORE ROW
         LET i = ARR_CURR()
         LET j = SCR_LINE()
         LET l_totf = 0
         LET l_tot = 0
          FOR k = 1 TO l_api.getLength()    #No:MOD-480131
            IF l_api[k].api26 IS NULL THEN
               CONTINUE FOR
            END IF
            IF l_api[k].api05 IS NULL THEN
               CONTINUE FOR
            END IF
            LET l_totf= l_totf+ l_api[k].api05f
            LET l_tot = l_tot + l_api[k].api05
         END FOR
         DISPLAY l_totf TO FORMONLY.api05_ft
         DISPLAY l_tot TO FORMONLY.api05_t
         CALL cl_show_fld_cont()     #FUN-550037(smin)
         LET api26_o=l_api[i].api26  #No.TQC-7B0083
         NEXT FIELD api26

      BEFORE INSERT
         LET i = ARR_CURR()
         LET j = SCR_LINE()
         NEXT FIELD api26

      #No.TQC-7B0083  --Begin
      #BEFORE FIELD api26
      #   LET api26_o=l_api[i].api26
      #No.TQC-7B0083  --End  
     #str MOD-870011 add

      BEFORE FIELD api26
         IF l_api[i].api26 = 'DIFF' THEN
            IF l_api[i].api05 IS NULL AND l_api[i].api05f IS NULL THEN   #MOD-890038 add
               LET l_totf = 0
               LET l_tot = 0
               FOR k = 1 TO l_api.getLength()    #No:MOD-480131
                  IF l_api[k].api26 IS NULL THEN
                     CONTINUE FOR
                  END IF
                  IF l_api[k].api05 IS NULL THEN
                     CONTINUE FOR
                  END IF
                 #str MOD-890038 mark
                 #IF l_api[k].api26 ='DIFF' THEN
                 #   CONTINUE FOR
                 #END IF
                 #end MOD-890038 mark
                  LET l_totf = l_totf + l_api[k].api05f
                  LET l_tot = l_tot + l_api[k].api05
               END FOR
               LET l_api[i].api05f= l_amtf-l_totf
               LET l_api[i].api05 = l_amt -l_tot
               DISPLAY BY NAME l_api[i].api05f   #MOD-870011 add
               DISPLAY BY NAME l_api[i].api05    #MOD-870011 add
               LET l_totf=l_totf+l_api[i].api05f
               LET l_tot =l_tot +l_api[i].api05
               DISPLAY l_totf TO FORMONLY.api05_ft
               DISPLAY l_tot TO FORMONLY.api05_t
            END IF   #MOD-890038 add
         END IF
        #MOD-A70122---add---start---
         LET l_cnt = 0
         SELECT COUNT(*) INTO l_cnt FROM apa_file,apb_file,api_file
          WHERE apa01 = api01 AND api01 = g_apa.apa01
            AND apb01 = l_api[i].api26
         IF l_cnt > 0 THEN
            CALL cl_set_comp_entry("api05f,api05",FALSE)
         ELSE
            CALL cl_set_comp_entry("api05f,api05",TRUE)
         END IF
        #MOD-A70122---add---end---
     #end MOD-870011 add

      AFTER FIELD api26
         IF l_api[i].api26=g_apa.apa01 THEN
            LET l_api[i].api26=NULL
            NEXT FIELD api26
         END IF
       #str MOD-890038 mark
       #取消DIFF多筆檢核判斷
       ##str MOD-870011 add
       # IF l_api[i].api26='DIFF' THEN
       #    LET m = 0
       #    FOR k = 1 TO l_api.getLength()
       #       IF l_api[k].api26 ='DIFF' THEN
       #          LET m = m + 1
       #          CONTINUE FOR
       #       END IF
       #    END FOR
       #    IF m>=2 THEN
       #       CALL cl_err(l_api[i].api26,'axm-298',0)
       #       INITIALIZE l_api[i].* TO NULL
       #       NEXT FIELD api26
       #    END IF
       # END IF
       ##end MOD-870011 add
       #end MOD-890038 mark
         #No.TQC-7B0083  --Begin
         #單號不能隨便修改,因為項次和apb項次對應
         IF api26_o IS NOT NULL THEN
            IF api26_o <> l_api[i].api26 OR l_api[i].api26 IS NULL THEN
               LET l_api[i].api26 = api26_o
               NEXT FIELD api26
            END IF
         END IF
         #No.TQC-7B0083  --End  
        
         IF l_api[i].api26 IS NOT NULL AND l_api[i].api26 <> 'DIFF' THEN
            #No.TQC-7B0083  --Begin
            DECLARE t110_find_stock CURSOR FOR 
             SELECT apb21,apb22 FROM apb_file
              WHERE apb01 = l_api[i].api26
            LET l_flag = 'N'
            FOREACH t110_find_stock INTO l_apb21,l_apb22
               LET l_cnt = 0
               SELECT COUNT(*) INTO l_cnt FROM apb_file
                WHERE apb21 = l_apb21 AND apb22 = l_apb22
                  AND apb01 = g_apa.apa01
                  AND apb34 = 'Y'
                  #AND apb02 = l_api03_a[i]  #MOD-9C0252
                  AND apb02 = l_api03_a[i].api03 #MOD-9C0252
               IF l_cnt > 0 THEN
                  LET l_flag = 'Y'
               END IF
            END FOREACH
            IF l_flag = 'N' THEN
               IF g_aptype = '12' OR
                 (g_aptype='21' AND g_apa.apa58='3') THEN   #MOD-850316 add
                  SELECT COUNT(*) INTO l_cnt FROM apb_file
                   WHERE apb21 = l_api[i].api26
                     AND apb01 = g_apa.apa01
                     AND apb34 = 'Y'
                     #AND apb02 = l_api03_a[i]  #MOD-9C0252
                      AND apb02 = l_api03_a[i].api03 #MOD-9C0252
                  IF l_cnt > 0 THEN
                     LET l_flag = 'Y'
                  END IF
               END IF
            END IF
            IF l_flag = 'N' THEN
               LET l_cnt = 0
               SELECT COUNT(*) INTO l_cnt FROM apb_file
                WHERE apb01 = l_api[i].api26
               IF l_cnt = 0 THEN
                  LET l_flag = 'Y'
               END IF
            END IF
            IF l_flag = 'N' THEN
               CALL cl_err(l_api[i].api26,'aap-814',1)
               NEXT FIELD api26   
            END IF
#No.FUN-680027--begin
#           #No.MOD-590312  --begin
#No.FUN-5B0081--begin
            SELECT apa34f-apa35f,apa34-apa35,apa54,apa541,apa22,apa14,apa08,apa06,
                   apa07,apa13,apa72,apa73,apa00
              INTO l_apa34f,l_apa34,l_apa54,l_apa541,l_apa22,l_apa14,l_apa08,l_apa06,
                   l_apa07,l_apa13,l_apa72,l_apa73,l_apa00
            #No.MOD-590312  --end
              FROM apa_file
             WHERE apa01=l_api[i].api26 AND apa41='Y' AND apa42='N'
            IF STATUS THEN
               CALL cl_err3("sel","apa_file",l_api[i].api26,"",STATUS,"","sel apa:",1)  #No.FUN-660122
               NEXT FIELD api26
            END IF
            IF l_apa08 !='UNAP' THEN
               CALL cl_err(l_apa08,'aap-023',0)
               NEXT FIELD api26
            END IF
            #No.MOD-590312  --begin
            IF g_apz.apz27 = 'Y' AND g_aza.aza17 != l_apa13 THEN
               LET l_apa34 = l_apa73
               LET l_apa14 = l_apa72
            END IF
            #No.MOD-590312  --end
            #付款廠商,簡稱和當初立暫估的不同,秀警告訊息告知!
            IF l_apa06 !=g_apa.apa06 OR l_apa07 !=g_apa.apa07 THEN
               CALL cl_err(l_apa06,'aap-024',0)
            END IF
            #-----MOD-640329---------
            SELECT SUM(api05),SUM(api05f) INTO l_api05,l_api05f 
              FROM api_file,apa_file
               WHERE api01=apa01 AND api26 = l_api[i].api26 AND 
#                    api01 <> g_apa.apa01 AND apa42 <> 'X'                 #No.MOD-710006
                     api01 <> g_apa.apa01 AND apa41 = 'N' AND apa42 = 'N'  #No.MOD-710006 
           #MOD-C40218---S---
           #IF cl_null(l_api05) THEN LET l_api05 = 0 END IF
           #IF cl_null(l_api05f) THEN LET l_api05f = 0 END IF
           #MOD-C40218---E---
            #-----END MOD-640329-----

            #-----MOD-750056---------                                           
            IF g_aptype!='21' THEN    #MOD-850316 add
               IF l_apa00 = '26' THEN 
                 #MOD-C40218---S---                                             
                 #LET l_api05 = l_api05 * -1                                       
                 #LET l_api05f = l_api05f * -1                                     
                 #MOD-C40218---E---
               END IF                                   
            END IF                    #MOD-850316 add                           
            #-----END MOD-750056----- 
            IF l_api[i].api05 IS NULL OR l_api[i].api05 = 0 OR
               api26_o <> l_api[i].api26 OR cl_null(api26_o) THEN  #No.TQC-7B0083
               LET l_api[i].api04 = l_apa54
               #No.FUN-680029--begin                                                           
               IF g_aza.aza63 THEN                                              
                  LET l_api[i].api041 = l_apa541                                
               END IF                                                           
               #No.FUN-680029--end 
               LET l_api[i].api07 = l_apa22
               #-----MOD-640329---------
               #LET l_api[i].api05f= l_apa34f
               #LET l_api[i].api05 = l_apa34
              #MOD-C40218---S---
              #LET l_api[i].api05f= l_apa34f - l_api05f
              #LET l_api[i].api05 = l_apa34 - l_api05
              #MOD-C40218---E---
               #-----END MOD-640329-----
            END IF
            IF g_aptype!='21' THEN    #MOD-850316 add
               IF l_apa00 = '26' THEN    #MOD-750056
                 #MOD-C40218---S---
                 #IF l_api[i].api05f>0 THEN
                 #  LET l_api[i].api05f= l_api[i].api05f*(-1)
                 #END IF
                 #IF l_api[i].api05 >0 THEN
                 #  LET l_api[i].api05 = l_api[i].api05 *(-1)
                 #END IF
                 #MOD-C40218---E---
               END IF
            END IF                    #MOD-850316 add
#No.FUN-5B0081--end
        #MOD-C40218---S---
        #LET l_api[i].api05 = cl_digcut(l_api[i].api05 ,g_azi04)  #No.MOD-830006
        #LET l_api[i].api05f= cl_digcut(l_api[i].api05f,t_azi04)  #No.MOD-830006
        #MOD-C40218---E---
         END IF
         IF l_api[i].api26 = 'DIFF' THEN
            IF l_api[i].api05 IS NULL AND l_api[i].api05f IS NULL THEN   #MOD-890038 add
               LET l_totf = 0
               LET l_tot = 0
               FOR k = 1 TO l_api.getLength()    #No:MOD-480131
                  IF l_api[k].api26 IS NULL THEN
                     CONTINUE FOR
                  END IF
                  IF l_api[k].api05 IS NULL THEN
                     CONTINUE FOR
                  END IF
                 #str MOD-890038 mark
                 #IF l_api[k].api26 ='DIFF' THEN
                 #   CONTINUE FOR
                 #END IF
                 #end MOD-890038 mark
                  LET l_totf = l_totf + l_api[k].api05f
                  LET l_tot = l_tot + l_api[k].api05
               END FOR
              #MOD-C40218---S---
              #LET l_api[i].api05f= l_amtf-l_totf
              #LET l_api[i].api05 = l_amt -l_tot
              #DISPLAY BY NAME l_api[i].api05f   #MOD-870011 add
              #DISPLAY BY NAME l_api[i].api05    #MOD-870011 add
              #LET l_totf=l_totf+l_api[i].api05f
              #LET l_tot =l_tot +l_api[i].api05
              #DISPLAY l_totf TO FORMONLY.api05_ft
              #DISPLAY l_tot TO FORMONLY.api05_t
              #MOD-C40218---E---
            END IF   #MOD-890038 add
         END IF
         #No.TQC-7B0083  --End  

     #No.TQC-7B0083  --Begin
     #BEFORE FIELD api40
     #   LET api26_o=l_api[i].api40
     #AFTER FIELD api40
     #   IF l_api[i].api40 IS NOT NULL THEN
     #      SELECT apc08-apc10,apc09-apc11,apa54,apa541,apa22,apc06,apc12,apa06,           #No.FUN-680029
     #             apa07,apa13,apc07,apc13,apa00
     #        INTO l_apa34f,l_apa34,l_apa54,l_apa541,l_apa22,l_apa14,l_apa08,l_apa06,      #No.FUN-680029
     #             l_apa07,l_apa13,l_apa72,l_apa73,l_apa00
     #        FROM apa_file,apc_file
     #       WHERE apa01=l_api[i].api26 AND apa41='Y' AND apa42='N'
     #         AND apa01 =apc01
     #         AND apc02=l_api[i].api40
     #      IF STATUS THEN
     #         CALL cl_err3("sel","apa_file",l_api[i].api26,"",STATUS,"","sel apa:",1)  #No.FUN-660122
     #         NEXT FIELD api40
     #      END IF
     #      IF l_apa08 !='UNAP' THEN
     #         CALL cl_err(l_apa08,'aap-023',0)
     #         NEXT FIELD api40
     #      END IF
     #      IF g_apz.apz27 = 'Y' AND g_aza.aza17 != l_apa13 THEN
     #         LET l_apa34 = l_apa73
     #         LET l_apa14 = l_apa72
     #      END IF
     #      #付款廠商,簡稱和當初立暫估的不同,秀警告訊息告知!
     #      IF l_apa06 !=g_apa.apa06 OR l_apa07 !=g_apa.apa07 THEN
     #         CALL cl_err(l_apa06,'aap-024',0)
     #      END IF
     #      #-----MOD-640329---------
     #      SELECT SUM(api05),SUM(api05f) INTO l_api05,l_api05f 
     #        FROM api_file,apa_file
     #         WHERE api01=apa01 AND api26 = l_api[i].api26 AND 
     #               #api01 <> g_apa.apa01 AND apa42 <> 'X'   #MOD-710006
     #               api01 <> g_apa.apa01 AND apa41 = 'N' AND apa42 = 'N'   #MOD-710006
     #               AND api40 =l_api[i].api40
     #      IF cl_null(l_api05) THEN LET l_api05 = 0 END IF
     #      IF cl_null(l_api05f) THEN LET l_api05f = 0 END IF
     #      #-----END MOD-640329-----
     #      #-----MOD-750056---------
     #      IF l_apa00 = '26' THEN   
     #         LET l_api05 = l_api05 * -1
     #         LET l_api05f = l_api05f * -1
     #      END IF
     #      #-----END MOD-750056-----
     #      IF l_api[i].api05 IS NULL OR l_api[i].api05 = 0 OR api26_o <> l_api[i].api26 OR
     #         api40_o <> l_api[i].api40 THEN
     #         LET l_api[i].api04 = l_apa54
#No.F#N-680029--begin
     #         IF g_aza.aza63 THEN
     #            LET l_api[i].api041 = l_apa541
     #         END IF
#No.F#N-680029--end
     #         LET l_api[i].api07 = l_apa22
     #         LET l_api[i].api05f= l_apa34f - l_api05f
     #         LET l_api[i].api05 = l_apa34 - l_api05
     #      END IF
     #      #IF l_apa00 = '21' THEN   #MOD-750056
     #      IF l_apa00 = '26' THEN   #MOD-750056
     #         IF l_api[i].api05f>0 THEN
     #           LET l_api[i].api05f= l_api[i].api05f*(-1)
     #         END IF
     #         IF l_api[i].api05 >0 THEN
     #           LET l_api[i].api05 = l_api[i].api05 *(-1)
     #         END IF
     #      END IF
     #   END IF
     #   IF l_api[i].api26 = 'DIFF' THEN
     #      LET l_totf = 0
     #      LET l_tot = 0
     #       FOR k = 1 TO l_api.getLength()    #No:MOD-480131
     #         IF l_api[k].api26 IS NULL THEN
     #            CONTINUE FOR
     #         END IF
     #         IF l_api[k].api05 IS NULL THEN
     #            CONTINUE FOR
     #         END IF
     #         IF l_api[k].api26 ='DIFF' THEN
     #            CONTINUE FOR
     #         END IF
     #         LET l_totf = l_totf + l_api[k].api05f
     #         LET l_tot = l_tot + l_api[k].api05
     #      END FOR
     #      LET l_api[i].api05f= l_amtf-l_totf
     #      LET l_api[i].api05 = l_amt -l_tot
     #      LET l_totf=l_totf+l_api[i].api05f
     #      LET l_tot =l_tot +l_api[i].api05
     #      DISPLAY l_totf TO FORMONLY.api05_ft
     #      DISPLAY l_tot TO FORMONLY.api05_t
     #   END IF
#No.FUN-680027--end  
     #No.TQC-7B0083  --End  

      AFTER FIELD api04
         IF NOT cl_null(l_api[i].api04) THEN
            CALL s_aapact(g_apz.apz11,g_bookno1,l_api[i].api04) RETURNING g_msg    #No.FUN-730064
            IF g_apz.apz02 = 'Y' AND NOT cl_null(g_errno) THEN
               CALL cl_err('sel aag:',g_errno,0)
               NEXT FIELD api04
            END IF
           #str MOD-890084 add
            LET m_aag05=''
            SELECT aag05 INTO m_aag05 FROM aag_file
             WHERE aag01=l_api[i].api04
               AND aag00=g_bookno1
               AND aagacti = 'Y'     #No.MOD-B70280 add
            IF STATUS OR SQLCA.SQLCODE THEN
               LET m_aag05=''
            END IF
            IF m_aag05 = 'Y' THEN
               CALL cl_set_comp_required("api07",TRUE)
            ELSE                                                        #MOD-960152                                                 
               CALL cl_set_comp_required("api07",FALSE)                 #MOD-960152
            END IF
           #end MOD-890084 add
         END IF

#No.FUN-680029--begin
      AFTER FIELD api041
         IF NOT cl_null(l_api[i].api041) THEN
            CALL s_aapact(g_apz.apz11,g_bookno2,l_api[i].api041) RETURNING g_msg      #No.FUN-730064
            IF g_apz.apz02 = 'Y' AND NOT cl_null(g_errno) THEN
               CALL cl_err('sel aag:',g_errno,0)
               NEXT FIELD api041
            END IF
           #str MOD-890084 add
            LET m_aag05_1=''   #CHI-8C0005 mod
            SELECT aag05 INTO m_aag05_1 FROM aag_file   #CHI-8C0005 mod
             WHERE aag01=l_api[i].api041
               AND aag00=g_bookno2
               AND aagacti = 'Y'     #No.MOD-B70280 add
            IF STATUS OR SQLCA.SQLCODE THEN
               LET m_aag05_1=''   #CHI-8C0005 mod
            END IF
            IF m_aag05_1 = 'Y' THEN   #CHI-8C0005 mod
               CALL cl_set_comp_required("api07",TRUE)
            END IF
           #end MOD-890084 add
         END IF
#No.FUN-680029--end

      AFTER FIELD api07
        #str MOD-890084 add
         LET m_aag05=''
         SELECT aag05 INTO m_aag05 FROM aag_file
          WHERE aag01=l_api[i].api04
            AND aag00=g_bookno1
            AND aagacti = 'Y'     #No.MOD-B70280 add
         IF STATUS OR SQLCA.SQLCODE THEN
            LET m_aag05=''
         END IF
         IF g_aza.aza63 ='Y' THEN
            SELECT aag05 INTO m_aag05_1 FROM aag_file   #CHI-8C0005 mod
             WHERE aag01=l_api[i].api041
               AND aag00=g_bookno2
               AND aagacti = 'Y'     #No.MOD-B70280 add
            IF STATUS OR SQLCA.SQLCODE THEN
               LET m_aag05_1=''   #CHI-8C0005 mod
            END IF
         END IF
         IF m_aag05 = 'Y' THEN
            IF cl_null(l_api[i].api07) THEN
               CALL cl_err(l_api[i].api07,'mfg0037',0)
               NEXT FIELD api07
            ELSE
               LET g_api[i].api930=s_costcenter(g_api[i].api07)  #CHI-8C0005 add
               DISPLAY BY NAME g_api[i].api930                   #CHI-8C0005 add
               SELECT gem02 FROM gem_file
                WHERE gem01 = l_api[i].api07
                  AND gem05 = 'Y'
                  AND gemacti = 'Y'
               IF SQLCA.sqlcode THEN
#                 CALL cl_err('sel gem:',STATUS,0)   #No.FUN-660122
                  CALL cl_err3("sel","gem_file",l_api[i].api07,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                  NEXT FIELD api07
               END IF
               LET g_errno = ' '   #MOD-5B0255
               #科目有做科目部門管理的才CALL s_chkdept
              #str CHI-8C0005 mod
              #CALL s_chkdept(g_aaz.aaz72,l_api[i].api04,l_api[i].api07,g_bookno1) RETURNING g_errno
              #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
               IF g_aaz.aaz90 !='Y' THEN
                  CALL s_chkdept(g_aaz.aaz72,l_api[i].api04,l_api[i].api07,g_bookno1) RETURNING g_errno
               END IF
              #end CHI-8C0005 mod
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,0)
                  NEXT FIELD api07
               END IF
            END IF
         ELSE
        #end MOD-890084 add
            IF NOT cl_null(l_api[i].api07) THEN
               SELECT gem02 FROM gem_file
                WHERE gem01 = l_api[i].api07
                  AND gem05 = 'Y'
                  AND gemacti = 'Y'
               IF SQLCA.sqlcode THEN
#                 CALL cl_err('sel gem:',STATUS,0)   #No.FUN-660122
                  CALL cl_err3("sel","gem_file",l_api[i].api07,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                  NEXT FIELD api07
               END IF
            END IF
         END IF   #MOD-890084 add
        #str CHI-8C0005 add
         IF m_aag05_1 = 'Y' THEN
            IF cl_null(l_api[i].api07) THEN
               CALL cl_err(l_api[i].api07,'mfg0037',0)
               NEXT FIELD api07
            ELSE
               LET g_api[i].api930=s_costcenter(g_api[i].api07)  #CHI-8C0005 add
               DISPLAY BY NAME g_api[i].api930                   #CHI-8C0005 add
               SELECT gem02 FROM gem_file
                WHERE gem01 = l_api[i].api07
                  AND gem05 = 'Y'
                  AND gemacti = 'Y'
               IF SQLCA.sqlcode THEN
#                 CALL cl_err('sel gem:',STATUS,0)   #No.FUN-660122
                  CALL cl_err3("sel","gem_file",l_api[i].api07,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                  NEXT FIELD api07
               END IF
               LET g_errno = ' '   #MOD-5B0255
               #科目有做科目部門管理的才CALL s_chkdept
               IF g_aza.aza63 ='Y' THEN
                 #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                  IF g_aaz.aaz90 !='Y' THEN
                     CALL s_chkdept(g_aaz.aaz72,l_api[i].api041,l_api[i].api07,g_bookno2) RETURNING g_errno
                  END IF
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,0)
                  NEXT FIELD api07
               END IF
            END IF
         ELSE
            IF NOT cl_null(l_api[i].api07) THEN
               SELECT gem02 FROM gem_file
                WHERE gem01 = l_api[i].api07
                  AND gem05 = 'Y'
                  AND gemacti = 'Y'
               IF SQLCA.sqlcode THEN
                  CALL cl_err3("sel","gem_file",l_api[i].api07,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                  NEXT FIELD api07
               END IF
            END IF
         END IF
        #end CHI-8C0005 add

     #str CHI-8C0005 add
      AFTER FIELD api930
         IF g_aaz.aaz90 ='Y' THEN
            IF NOT s_costcenter_chk(l_api[i].api930) THEN
               NEXT FIELD apb930
            ELSE
               LET m_aag05=''
               SELECT aag05 INTO m_aag05 FROM aag_file
                WHERE aag01=l_api[i].api04
                  AND aag00=g_bookno1
                  AND aagacti = 'Y'     #No.MOD-B70280 add
               IF STATUS OR SQLCA.SQLCODE THEN
                  LET m_aag05=''
               END IF
               IF g_aza.aza63 ='Y' THEN
                  SELECT aag05 INTO m_aag05_1 FROM aag_file
                   WHERE aag01=l_api[i].api041
                     AND aag00=g_bookno2
                     AND aagacti = 'Y'     #No.MOD-B70280 add
                  IF STATUS OR SQLCA.SQLCODE THEN
                     LET m_aag05_1=''
                  END IF
               END IF
               IF m_aag05 = 'Y' THEN
                  IF cl_null(l_api[i].api930) THEN
                     CALL cl_err(l_api[i].api930,'mfg0037',0)
                     NEXT FIELD api930
                  ELSE
                     SELECT gem02 FROM gem_file
                      WHERE gem01 = l_api[i].api930
                        AND gem05 = 'Y'
                        AND gemacti = 'Y'
                     IF SQLCA.sqlcode THEN
#                       CALL cl_err('sel gem:',STATUS,0)   #No.FUN-660122
                        CALL cl_err3("sel","gem_file",l_api[i].api930,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                        NEXT FIELD api930
                     END IF
                     LET g_errno = ' '   #MOD-5B0255
                     #科目有做科目部門管理的才CALL s_chkdept
                     #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                     CALL s_chkdept(g_aaz.aaz72,l_api[i].api04,l_api[i].api930,g_bookno1) RETURNING g_errno
                     IF NOT cl_null(g_errno) THEN
                        CALL cl_err('',g_errno,0)
                        NEXT FIELD api930
                     END IF
                  END IF
               ELSE
                  IF NOT cl_null(l_api[i].api930) THEN
                     SELECT gem02 FROM gem_file
                      WHERE gem01 = l_api[i].api930
                        AND gem05 = 'Y'
                        AND gemacti = 'Y'
                     IF SQLCA.sqlcode THEN
#                       CALL cl_err('sel gem:',STATUS,0)   #No.FUN-660122
                        CALL cl_err3("sel","gem_file",l_api[i].api930,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                        NEXT FIELD api930
                     END IF
                  END IF
               END IF
              #str CHI-8C0005 add
               IF m_aag05_1 = 'Y' THEN
                  IF cl_null(l_api[i].api930) THEN
                     CALL cl_err(l_api[i].api930,'mfg0037',0)
                     NEXT FIELD api930
                  ELSE
                     SELECT gem02 FROM gem_file
                      WHERE gem01 = l_api[i].api930
                        AND gem05 = 'Y'
                        AND gemacti = 'Y'
                     IF SQLCA.sqlcode THEN
#                       CALL cl_err('sel gem:',STATUS,0)   #No.FUN-660122
                        CALL cl_err3("sel","gem_file",l_api[i].api930,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                        NEXT FIELD api930
                     END IF
                     LET g_errno = ' '   #MOD-5B0255
                     #科目有做科目部門管理的才CALL s_chkdept
                     #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                     IF g_aza.aza63 ='Y' THEN
                        CALL s_chkdept(g_aaz.aaz72,l_api[i].api041,l_api[i].api930,g_bookno2) RETURNING g_errno
                     END IF
                     IF NOT cl_null(g_errno) THEN
                        CALL cl_err('',g_errno,0)
                        NEXT FIELD api930
                     END IF
                  END IF
               ELSE
                  IF NOT cl_null(l_api[i].api930) THEN
                     SELECT gem02 FROM gem_file
                      WHERE gem01 = l_api[i].api930
                        AND gem05 = 'Y'
                        AND gemacti = 'Y'
                     IF SQLCA.sqlcode THEN
#                       CALL cl_err('sel gem:',STATUS,0)   #No.FUN-660122
                        CALL cl_err3("sel","gem_file",l_api[i].api930,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                        NEXT FIELD api930
                     END IF
                  END IF
               END IF
              #end CHI-8C0005 add
            END IF
         END IF
     #end CHI-8C0005 add

      BEFORE FIELD api05f
         LET api05f_o=l_api[i].api05f

      AFTER FIELD api05f
         IF NOT cl_null(l_api[i].api05f) THEN
            IF l_api[i].api26 IS NOT NULL AND l_api[i].api26 <> 'DIFF' THEN
               #No.MOD-590312  --begin
               SELECT apa34f-apa35f,apa34-apa35,apa54,apa22,apa14,
                      apa13,apa72,apa73
                 INTO l_apa34f,l_apa34,l_apa54,l_apa22,l_apa14,
                      l_apa13,l_apa72,l_apa73
               #No.MOD-590312  --end
                 FROM apa_file
                WHERE apa01=l_api[i].api26 AND apa41='Y' AND apa42='N'
               #No.MOD-590312  --begin
               IF g_apz.apz27 = 'Y' AND g_aza.aza17 != l_apa13 THEN
                  LET l_apa34 = l_apa73
                  LET l_apa14 = l_apa72
               END IF
               #No.MOD-590312  --end
               IF cl_null(l_apa34f) THEN
                  LET l_apa34f = 0
               END IF
               IF cl_null(l_apa34) THEN
                  LET l_apa34 = 0
               END IF
               #-----MOD-640329---------
               SELECT SUM(api05),SUM(api05f) INTO l_api05,l_api05f 
                 FROM api_file,apa_file
                  WHERE api01=apa01 AND api26 = l_api[i].api26 AND 
                        #api01 <> g_apa.apa01 AND apa42 <> 'X'   #MOD-710006
                        api01 <> g_apa.apa01 AND apa41 = 'N' AND apa42 = 'N'   #MOD-710006
               IF cl_null(l_api05) THEN LET l_api05 = 0 END IF
               IF cl_null(l_api05f) THEN LET l_api05f = 0 END IF

               #IF l_api[i].api05f > l_apa34f THEN
             # IF l_api[i].api05f > l_apa34f - l_api05f THEN
               IF s_abs(l_api[i].api05f) > l_apa34f - l_api05f THEN   #No:MOD-910069
               #-----END MOD-640329-----
                  CALL cl_err(l_apa34f,'mfg-025',0)
                  NEXT FIELD api05f
               END IF
               #-----MOD-750048---------
               IF g_aptype!='21' THEN    #MOD-850316 add
                  IF l_apa00 = '26' THEN                                                                                                  
                     IF l_api[i].api05f>0 THEN                                                                                            
                       LET l_api[i].api05f= l_api[i].api05f*(-1)                                                                          
                     END IF                                                                                                               
                  END IF                                    
               END IF                    #MOD-850316 add                                                                              
               #-----END MOD-750048-----
            END IF
            IF l_api[i].api05 IS NULL OR l_api[i].api05 = 0 OR
               api05f_o <> l_api[i].api05f THEN
               LET l_api[i].api05 = l_api[i].api05f * l_apa14
            END IF
            LET l_api[i].api05f = cl_digcut(l_api[i].api05f,t_azi04) #No.MOD-830006
          #str MOD-890038 mark
          ##str MOD-870011 add
          # IF l_api[i].api26 = 'DIFF' THEN
          #    SELECT SUM(api05f),SUM(api05) INTO l_api05f,l_api05
          #      FROM api_file
          #     WHERE api01 = g_apa.apa01 AND api02 = p_api02
          #       AND api26 != 'DIFF'
          #    IF l_api05f+l_api[i].api05f<>l_amtf OR
          #       l_api05 +l_api[i].api05 <>l_amt  THEN
          #       NEXT FIELD api26
          #    END IF
          # END IF
          ##end MOD-870011 add
          #end MOD-890038 mark
#-----MOD-750048---------
##No.TQC-5C0093--begin                                                                                                               
#            IF l_apa00 = '21' THEN                                                                                                  
#               IF l_api[i].api05f>0 THEN                                                                                            
#                 LET l_api[i].api05f= l_api[i].api05f*(-1)                                                                          
#               END IF                                                                                                               
#            END IF                                                                                                                  
##No.TQC-5C0093--end   
#-----END MOD-750048-----
         END IF

      AFTER FIELD api05
         IF NOT cl_null(l_api[i].api05) THEN
            IF l_api[i].api26 IS NOT NULL AND l_api[i].api26 <> 'DIFF' THEN
               #No.MOD-590312  --begin
               SELECT apa34f-apa35f,apa34-apa35,apa54,apa22,apa14,
                      apa13,apa72,apa73
                 INTO l_apa34f,l_apa34,l_apa54,l_apa22,l_apa14,
                      l_apa13,l_apa72,l_apa73
               #No.MOD-590312  --end
                 FROM apa_file
                WHERE apa01=l_api[i].api26 AND apa41='Y' AND apa42='N'
               #No.MOD-590312  --begin
               IF g_apz.apz27 = 'Y' AND g_aza.aza17 != l_apa13 THEN
                   LET l_apa34 = l_apa73
                   LET l_apa14 = l_apa72
               END IF
               #No.MOD-590312  --end
               IF cl_null(l_apa34f) THEN
                  LET l_apa34f = 0
               END IF
               IF cl_null(l_apa34) THEN
                  LET l_apa34 = 0
               END IF
               #-----MOD-640329---------
               SELECT SUM(api05),SUM(api05f) INTO l_api05,l_api05f 
                 FROM api_file,apa_file
                  WHERE api01=apa01 AND api26 = l_api[i].api26 AND 
                        #api01 <> g_apa.apa01 AND apa42 <> 'X'   #MOD-710006
                        api01 <> g_apa.apa01 AND apa41 = 'N' AND apa42 = 'N'  #MOD-710006
               IF cl_null(l_api05) THEN LET l_api05 = 0 END IF
               IF cl_null(l_api05f) THEN LET l_api05f = 0 END IF

               #IF l_api[i].api05 > l_apa34 THEN
               IF l_api[i].api05 > l_apa34 - l_api05 THEN
               #-----END MOD-640329-----
                  CALL cl_err(l_apa34,'mfg-025',0)
                  NEXT FIELD api05
               END IF
               #-----MOD-750048---------
               IF g_aptype!='21' THEN    #MOD-850316 add
                  IF l_apa00 = '26' THEN                                                                                                  
                     IF l_api[i].api05 >0 THEN                                                                                            
                       LET l_api[i].api05 = l_api[i].api05 *(-1)                                                                          
                     END IF                                                                                                               
                  END IF                                   
               END IF                    #MOD-850316 add                                                                               
               #-----END MOD-750048-----
            END IF
            LET l_api[i].api05 = cl_digcut(l_api[i].api05,g_azi04) #No.MOD-830006
#-----MOD-750048---------
##No.TQC-5C0093--begin                                                                                                               
#            IF l_apa00 = '21' THEN                                                                                                  
#               IF l_api[i].api05 >0 THEN                                                                                            
#                 LET l_api[i].api05 = l_api[i].api05 *(-1)                                                                          
#               END IF                                                                                                               
#            END IF                                                                                                                  
##No.TQC-5C0093--end  
#-----END MOD-750048-----
          #str MOD-890038 mark
          ##str MOD-870011 add
          # IF l_api[i].api26 = 'DIFF' THEN
          #    SELECT SUM(api05f),SUM(api05) INTO l_api05f,l_api05
          #      FROM api_file
          #     WHERE api01 = g_apa.apa01 AND api02 = p_api02
          #       AND api26 != 'DIFF'
          #    IF l_api05f+l_api[i].api05f<>l_amtf OR
          #       l_api05 +l_api[i].api05 <>l_amt  THEN
          #       NEXT FIELD api26
          #    END IF
          # END IF
          ##end MOD-870011 add
          #end MOD-890038 mark
         END IF                                                                                                                     

      #No.TQC-7B0083  --Begin
      BEFORE DELETE
         #請款單身有衝暫估資料,不能刪除,否則造成不一致
         IF l_api[i].api26 IS NOT NULL AND l_api[i].api26 <> 'DIFF' THEN
            DECLARE t110_find_stock1 CURSOR FOR 
             SELECT apb21,apb22 FROM apb_file
              WHERE apb01 = l_api[i].api26
            LET l_flag = 'N'
            FOREACH t110_find_stock1 INTO l_apb21,l_apb22
               LET l_cnt = 0
               SELECT COUNT(*) INTO l_cnt FROM apb_file
                WHERE apb21 = l_apb21 AND apb22 = l_apb22
                  AND apb01 = g_apa.apa01
                  #AND apb02 = l_api03_a[i]   #MOD-9C0252
                  AND apb02 = l_api03_a[i].api03 #MOD-9C0252
                  AND apb34 = 'Y'
               IF l_cnt > 0 THEN
                  LET l_flag = 'Y'
               END IF
            END FOREACH
            IF l_flag = 'Y' THEN
               CALL cl_err(l_api[i].api26,'aap-338',1)
               CANCEL DELETE
            END IF
         END IF
         CALL l_api03_a.deleteElement(i)
         #No.TQC-7B0083  --End  

      AFTER ROW
         IF INT_FLAG THEN EXIT INPUT  END IF
         IF cl_null(l_api[i].api05) OR cl_null(l_api[i].api05f) THEN
            INITIALIZE l_api[i].* TO NULL
         END IF

      AFTER INPUT
        #str MOD-890038 add
         LET l_tot = 0
         FOR k = 1 TO l_api.getLength()    #No:MOD-480131
            IF l_api[k].api26 IS NULL THEN
               CONTINUE FOR
            END IF
            IF l_api[k].api05 IS NULL THEN
               CONTINUE FOR
            END IF
            LET l_tot = l_tot + l_api[k].api05
         END FOR
        #end MOD-890038 add
         IF l_tot != l_amt THEN
            CALL cl_err('','aap-177',0)
            NEXT FIELD api26
         END IF
         IF INT_FLAG THEN
            EXIT INPUT
         END IF

        ON ACTION CONTROLP
           CASE
              WHEN INFIELD(api26)
                 #CALL q_apa3(FALSE,FALSE,l_api[i].api26,g_apa.apa06,g_apa.apa07)   #MOD-640329
                 #No.TQC-7B0083  --Begin
                 IF api26_o IS NULL THEN
                    CALL q_apa3(FALSE,TRUE,l_api[i].api26,g_apa.apa06,g_apa.apa07,g_apa.apa01)   #MOD-640329   #MOD-750056
                    RETURNING l_api[i].api26,l_api[i].api40,l_api[i].api04,l_api[i].api041,    #No.FUN-680027
                              l_api[i].api07,l_api[i].api05f,l_api[i].api05
                 END IF
                 #No.TQC-7B0083  --End  
#No.FUN-680029--begin
              WHEN INFIELD(api041)
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_aag02"   #TQC-790133
                 LET g_qryparam.arg1 = g_bookno2  #TQC-790133
                 LET g_qryparam.default1 =l_api[i].api041
                 CALL cl_create_qry() RETURNING l_api[i].api041
                 DISPLAY l_api[i].api041 TO api041
#No.FUN-680029--end
              WHEN INFIELD(api04)
#                CALL q_aag(0,0,l_api[i].api04,'','','')
#                RETURNING l_api[i].api04
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_aag02"    #TQC-790133
                 LET g_qryparam.default1 =l_api[i].api04
                 LET g_qryparam.arg1 = g_bookno1      #No.FUN-730064
                 CALL cl_create_qry() RETURNING l_api[i].api04
                 DISPLAY l_api[i].api04 TO api04
              WHEN INFIELD(api07) # Dept CODE
#                CALL q_gem(0,0,l_api[i].api07) RETURNING l_api[i].api07
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_gem"
                 LET g_qryparam.default1 =l_api[i].api07
                 CALL cl_create_qry() RETURNING l_api[i].api07
                 DISPLAY l_api[i].api07 TO api07
             #str CHI-8C0005 add
              WHEN INFIELD(api930)     #成本中心
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_gem4"
                 LET g_qryparam.default1 = l_api[i].api930
                 CALL cl_create_qry() RETURNING l_api[i].api930
                 DISPLAY l_api[i].api930 TO api930
             #end CHI-8C0005 add
            END CASE
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
      
   END INPUT
   CLOSE WINDOW t110_ppp_w

   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF

   BEGIN WORK              #No:MOD-480131
   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa_rowid
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl ppp:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF

   FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
       CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
       CLOSE t110_cl ROLLBACK WORK RETURN
   END IF

   LET g_success='Y'
   DELETE FROM api_file WHERE api01 = g_apa.apa01 AND api02 = p_api02
   IF STATUS THEN
#     CALL cl_err('del api',STATUS,1)   #No.FUN-660122
      CALL cl_err3("del","api_file",g_apa.apa01,p_api02,STATUS,"","del api",1)  #No.FUN-660122
      LET g_success='N'
   END IF

    FOR k = 1 TO l_api.getLength()    #No:MOD-480131
      IF l_api[k].api26 IS NULL THEN
         CONTINUE FOR
      END IF

      IF l_api[k].api05 IS NULL THEN
         CONTINUE FOR
      END IF

      IF l_api[k].api05 = 0 THEN
         CONTINUE FOR
      END IF

      LET b_api.api01 =g_apa.apa01
      LET b_api.api02 =p_api02
      #No.TQC-7B0083  --Begin
      #LET b_api.api03 =k
      LET b_api.api03 =l_api03_a[k].api03
      #No.TQC-7B0083  --End  
      LET b_api.api04 =l_api[k].api04
      LET b_api.api041=l_api[k].api041                 #No.FUN-680029
      LET b_api.api05f=l_api[k].api05f
      LET b_api.api05 =l_api[k].api05
      LET b_api.api07 =l_api[k].api07
      LET b_api.api930=l_api[k].api930   #CHI-8C0005 add
      LET b_api.api26 =l_api[k].api26
    # #FUN-810045 begin
    #  LET b_api.api35 =l_api[k].api35
    #  LET b_api.api36 =l_api[k].api36
    # #FUN-810045 end
      #No.TQC-7B0083  --Begin
      IF b_api.api26 ='DIFF' THEN
         LET b_api.api40 =NULL
      ELSE
         LET b_api.api40 =1  
      END IF
      IF cl_null(b_api.api03) THEN
         SELECT MAX(api03) INTO b_api.api03 FROM api_file
          WHERE api01 = g_apa.apa01   #CHI-930001 mod
            AND api02 = p_api02
         IF cl_null(b_api.api03) THEN LET b_api.api03 = 1 END IF
      END IF
      #No.TQC-7B0083  --End  
      #No.TQC-810091--begin--
      LET b_api.api05 = cl_digcut(b_api.api05 ,g_azi04)   
      LET b_api.api05f= cl_digcut(b_api.api05f,t_azi04)   
      #No.TQC-810091---end---
      INSERT INTO api_file VALUES(b_api.*)
      IF STATUS OR SQLCA.SQLCODE THEN
#        CALL cl_err('ins api',SQLCA.SQLCODE,1)   #No.FUN-660122
         CALL cl_err3("ins","api_file",b_api.api01,b_api.api02,SQLCA.sqlcode,"","ins api",1)  #No.FUN-660122
         LET g_success='N'
      END IF
   END FOR

   IF g_success='Y' THEN
      COMMIT WORK
   ELSE
      ROLLBACK WORK
   END IF

END FUNCTION

FUNCTION t110_ddd(l_cmd)   #MOD-950112 add參數
   DEFINE l_cmd                   LIKE type_file.chr1     #MOD-950112 add
   DEFINE l_depno                 LIKE apa_file.apa22,    #No:FUN-690028 VARCHAR(10),
          l_rec_b                 LIKE type_file.num5,    #No.FUN-690028 SMALLINT
          l_tot1,l_tot2,l_tot3    LIKE apa_file.apa31,
          l_totf1,l_totf2,l_totf3 LIKE apa_file.apa31f,
          l_tot28,l_tot28f        LIKE apk_file.apk28,
          i,j,k,u_sign            LIKE type_file.num5,    #No:FUN-690028 SMALLINT,
          l_n,l_nochk             LIKE type_file.num5,    #No:FUN-690028 SMALLINT,
          apk03_t                 LIKE apk_file.apk03,
          l_tax                   LIKE type_file.num20_6, #No:FUN-690028 DEC(20,6),  #FUN-4B0079
          l_flag1,l_flag          LIKE type_file.chr1,    #No.FUN-690028 VARCHAR(1)
          l_flag2                 LIKE type_file.chr1,    #MOD-620048  #No.FUN-690028 VARCHAR(1)
          l_del                   LIKE type_file.chr1,    #No:FUN-690028 VARCHAR(01),
          l_amb01,l_amb02         LIKE type_file.num5,    #No:FUN-690028 SMALLINT,
          l_amb03                 LIKE amb_file.amb03,    #No:FUN-690028 VARCHAR(02),
          l_chk                   LIKE type_file.chr1,    #No:FUN-690028 VARCHAR(1),
          l_ans                   LIKE type_file.chr1,    #No:FUN-690028 VARCHAR(01),
          l_ans1,l_opensw         LIKE type_file.chr1,    #No:FUN-690028 VARCHAR(01),           #85-09-23
          l_apa31                 LIKE apa_file.apa31,
          l_apa31f                LIKE apa_file.apa31f,
          l_apa32                 LIKE apa_file.apa32,
          l_apa32f                LIKE apa_file.apa32f,
          l_apa34f                LIKE apa_file.apa34f,
          l_apa34                 LIKE apa_file.apa34,
          l_apk02                 LIKE apk_file.apk02,    #MOD-950226 add
          l_apk29                 LIKE apk_file.apk29,
          l_azi04                 LIKE azi_file.azi04,
          apk11_t                 LIKE apk_file.apk11,
          apk08_t                 LIKE apk_file.apk08,
          apk08f_t                LIKE apk_file.apk08f,
          l_allow_insert          LIKE type_file.num5,    #可新增否  #No.FUN-690028 SMALLINT
          l_allow_delete          LIKE type_file.num5,    #可刪除否  #No.FUN-690028 SMALLINT
          l_gec07                 LIKE gec_file.gec07     #MOD-7C0053
   DEFINE apk13_t                 LIKE apk_file.apk13     #MOD-830075
   DEFINE p_cmd                   LIKE type_file.chr1     #CHI-940018
   DEFINE l_lock_sw               LIKE type_file.chr1     #CHI-940018
   DEFINE t_tot1,t_tot2,t_tot3    LIKE apa_file.apa31     #MOD-960106                                                               
   DEFINE t_tot28                 LIKE apk_file.apk28     #MOD-960106  
   DEFINE g_t1                    LIKE oay_file.oayslip   #FUN-990014 add
   DEFINE l_gec05                 LIKE gec_file.gec05     #CHI-930020 add
   DEFINE l_apa171                LIKE apa_file.apa171    #MOD-B40115 add

   IF g_aza.aza26 = '2' THEN   #大陸版功能
      CALL t110_ddd_c('')
      DISPLAY BY NAME g_apa.apa07      #TQC-630164  
      CALL t110_show_multi_invoice()   #No.TQC-A30076
      RETURN
   END IF

   IF g_apa.apa42='Y' THEN
      RETURN
   END IF

   IF g_aptype != '21' THEN #No.CHI-A40005 add
      IF g_apa.apa08 != 'MISC' OR cl_null(g_apa.apa08) THEN
         RETURN
      END IF
   END IF                   #No.CHI-A40005 add
  #-MOD-B10013-add-
   BEGIN WORK
   IF g_apa.apa41 = 'Y' THEN       #MOD-C20048 add
      LET l_cmd = '1'              #MOD-C20048 add
   END IF                          #MOD-C20048 add
   IF l_cmd = '2' THEN
      CALL t110_lock_cl()  #FUN-C80078 add
      OPEN t110_cl USING g_apa_rowid
      IF STATUS THEN
         CALL cl_err("OPEN t110_cl b:", STATUS, 1)
         CLOSE t110_cl
         ROLLBACK WORK
         RETURN
      END IF
      FETCH t110_cl INTO g_apa_t.*    # 鎖住將被更改或取消的資料   
      IF SQLCA.sqlcode THEN
         CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
         CLOSE t110_cl
         ROLLBACK WORK
         RETURN
      END IF       
   END IF
  #-MOD-B10013-end-
   OPEN WINDOW t110_ddd_w WITH FORM "aap/42f/aapt110_d"
      ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
   CALL cl_ui_locale("aapt110_d")

   #--FUN-950094 mark----
   ##-----CHI-7A0030---------
   #IF g_aptype = '13' THEN
   #   CALL cl_set_comp_visible("apk07,apk07f",FALSE)
   #END IF
   ##-----END CHI-7A0030-----
   #--FUN-950094 mark-----

   DECLARE t110_ddd_c CURSOR FOR
      SELECT apk02,apk11,apk171,apk17,apk172,
             apk05,apk03,apk04,apk12,apk13,   #No:8511為配合字軌檢查apk05要往前輸入 #No:8654
             apk08f,apk07f,apk06f,apk08,apk07,apk06,apk32    #FUN-970108 add apk32
        FROM apk_file
       WHERE apk01 = g_apa.apa01
       ORDER BY apk02

#  CALL g_apk_c.clear() #MOD-560111   #MOD-5B0340
   CALL g_apk.clear()     #MOD-5B0340
   LET k = 1
   LET l_tot1 = 0
   LET l_tot2 = 0
   LET l_tot3 = 0
   LET t_tot1 = 0   #MOD-960106                                                                                                     
   LET t_tot2 = 0   #MOD-960106                                                                                                     
   LET t_tot3 = 0   #MOD-960106                                                                                                     
   LET t_tot28 = 0  #MOD-960106 
   LET i = 1
   LET l_tot28 = 0
   LET l_opensw = 'N'

  #FOREACH t110_ddd_c INTO l_ac,g_apk[k].*   #CHI-940018 i->l_ac  #MOD-950226 mark
   FOREACH t110_ddd_c INTO g_apk[k].*   #CHI-940018 i->l_ac       #MOD-950226
      IF g_apk[k].apk171 = '23' THEN
         LET u_sign = -1
      ELSE
         LET u_sign = 1
      END IF

      IF g_apk[k].apk171 = '28' OR g_apk[k].apk171 = '29' THEN
         LET l_tot28= l_tot28+ g_apk[k].apk08 * u_sign
         LET l_tot2 = l_tot2 + g_apk[k].apk07 * u_sign
      ELSE
         LET l_tot1 = l_tot1 + g_apk[k].apk08 * u_sign
         LET l_tot2 = l_tot2 + g_apk[k].apk07 * u_sign
        #LET l_tot3 = (l_tot1 + l_tot2) * u_sign   #MOD-640457
         LET l_tot3 = (l_tot1 + l_tot2)  #MOD-640457
      END IF

      IF cl_null(g_apk[k].apk03) THEN
         LET g_apk[k].apk03 = ' '
      END IF   #No:8511

      LET k = k + 1
      IF k > g_max_rec THEN    #No:MOD-480131
         EXIT FOREACH
      END IF
   END FOREACH

   CALL g_apk.deleteElement(k)
   LET l_rec_b  = k - 1
   LET t_tot1 = l_tot1 #MOD-960106                                                                                                  
   LET t_tot2 = l_tot2 #MOD-960106                                                                                                  
   LET t_tot3 = l_tot3 #MOD-960106                                                                                                  
   LET t_tot28 = l_tot28 #MOD-960106 
   DISPLAY BY NAME l_tot28,l_tot1,l_tot2,l_tot3

   IF g_apa.apa41 = 'Y' THEN
      CALL cl_set_act_visible("accept,cancel", FALSE)
      DISPLAY ARRAY g_apk TO s_apk.*  ATTRIBUTE(COUNT=l_rec_b)
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE DISPLAY
 
         ON ACTION about         #MOD-4C0121
            CALL cl_about()      #MOD-4C0121
 
         ON ACTION help          #MOD-4C0121
            CALL cl_show_help()  #MOD-4C0121
 
         ON ACTION controlg      #MOD-4C0121
            CALL cl_cmdask()     #MOD-4C0121
 
         ON ACTION controls                       #No.FUN-6B0033                                                                       
            CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
      END DISPLAY
      IF INT_FLAG THEN   #MOD-6B0035
         LET INT_FLAG = 0   #MOD-6B0035
         CLOSE WINDOW t110_ddd_w
         RETURN
      END IF   #MOD-6B0035
   ELSE
#CHI-940018 --add begin--                          
      LET g_forupd_sql = "SELECT apk02,apk11,apk171,apk17,apk172,",  #MOD-950226 add apk02
                         "       apk05,apk03,apk04,apk12,apk13,",
                         "       apk08f,apk07f,apk06f,apk08,apk07,apk06,apk32",  #FUN-970108 add apk32
                         "  FROM apk_file ",
                         " WHERE apk01 = '",g_apa.apa01,"'",                        
                         "   AND apk02 = ?",   #MOD-950226 add
                         "   AND apk03 = ?  FOR UPDATE NOWAIT"    #MOD-970145   #TQC-970144
#                         "   AND apk03 = ?",  #MOD-970145
#                         " ORDER BY apk02,apk03 FOR UPDATE NOWAIT"   #MOD-950226 add apk03   #MOD-970145
      DECLARE ddd_bcl CURSOR FROM g_forupd_sql      # LOCK CURSOR          
#CHI-940018 --add end--      	
     
      #CHI-A40005 mod---start---
      #LET l_allow_insert = cl_detail_input_auth("insert")
      #LET l_allow_delete = cl_detail_input_auth("delete")
      IF  g_prog = 'aapt210' THEN
         LET l_allow_insert = FALSE 
         LET l_allow_delete = FALSE
       ELSE 
         LET l_allow_insert = cl_detail_input_auth("insert")
         LET l_allow_delete = cl_detail_input_auth("delete")
      END IF
      #CHI-A40005 ---end---

      INPUT ARRAY g_apk WITHOUT DEFAULTS FROM s_apk.*
            ATTRIBUTE(COUNT=l_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                      INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)
 
         BEFORE INPUT
           IF l_rec_b != 0 THEN             #CHI-940018  
              CALL fgl_set_arr_curr(i)      #CHI-940018  l_ac->i
           END IF                           #CHI-940018  
           LET l_del='N'

        #-MOD-B40086-add- 
         AFTER INPUT
           CALL t110_sum_apa32_1() RETURNING l_apa32,l_apa32f 
           IF (l_apa32 != g_apa.apa32 OR
             #l_apa32f != g_apa.apa32f) AND g_aptype = '21' THEN #MOD-B60016 mark
              l_apa32f != g_apa.apa32f) AND g_aptype = '21' AND g_aza.aza26 <> '2' THEN #MOD-B60016 
              CALL cl_err('','aap-212',1)
              NEXT FIELD apk07f 
           END IF    
        #-MOD-B40086-end- 

         BEFORE ROW
           LET i = ARR_CURR()
           LET j = SCR_LINE()
#CHI-940018  --add begin-- 
           LET p_cmd = ''
           LET l_opensw = 'N'
           LET g_success = 'Y'        
           BEGIN WORK      #MOD-B10013 mark #MOD-B10061 remark 
           INITIALIZE g_apk_t.* TO NULL          
          #-MOD-B10013-mark-
          #IF l_cmd = '2' THEN   #MOD-950112 add
          #   OPEN t110_cl USING g_apa_rowid
          #   IF STATUS THEN
          #      CALL cl_err("OPEN t110_cl b:", STATUS, 1)
          #      CLOSE t110_cl
          #      ROLLBACK WORK
          #      CLOSE WINDOW t110_ddd_w
          #      RETURN
          #   END IF
          #   FETCH t110_cl INTO g_apa_t.*    # 鎖住將被更改或取消的資料   #MOD-9A0070 mod
          #   IF SQLCA.sqlcode THEN
          #      CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
          #      CLOSE t110_cl
          #      ROLLBACK WORK
          #      CLOSE WINDOW t110_ddd_w
          #      RETURN
          #   END IF       
          #END IF   #MOD-950112 add
          #-MOD-B10013-end-
#CHI-940018  --add end--         
           LET apk03_t = g_apk[i].apk03
           LET apk11_t = g_apk[i].apk11

           #No.5945 稅率用多發票apk29的稅率不用apa16
           SELECT apk29 INTO l_apk29 FROM apk_file
            WHERE apk01 = g_apa.apa01
          #   AND apk02 = i                #MOD-950226 mark
              AND apk02 = g_apk[i].apk02   #MOD-950226
              AND apk03 = g_apk[i].apk03
           IF cl_null(l_apk29) THEN LET l_apk29 = 0 END IF

#--FUN-950094 mark-----------
#          #str MOD-880146 add
#          #當執行aapt121(g_aptype='13')時,不管選什麼稅別,都不算稅額,
#          #所以LET l_apk29=0
#           IF g_aptype = '13' THEN LET l_apk29 = 0 END IF
#          #end MOD-880146 add
#--FUN-950094 mark-----------

           SELECT azi04 INTO l_azi04 FROM azi_file
            WHERE azi01 = g_apk[i].apk12 AND aziacti = 'Y'
           IF cl_null(l_azi04) THEN LET l_azi04 = 0 END IF

            #MOD-4B0243
           IF l_del = 'Y' THEN
              LET l_del = 'N'
              CALL cl_show_fld_cont()     #FUN-550037(smin)
          #   NEXT FIELD apk02   #MOD-950226 mark
           END IF

           IF g_apk[i].apk02 IS NULL THEN  #MOD-950226 mod apk11->apk02
              CALL cl_show_fld_cont()     #FUN-550037(smin)
              NEXT FIELD apk02   #MOD-950226 mod apk11->apk02
           END IF

#CHI-940018  --add begin--  
           IF l_rec_b >= i THEN
              LET p_cmd='u'
              LET g_apk_t.* = g_apk[i].*  #BACKUP
             #OPEN ddd_bcl USING g_apk_t.apk03                #MOD-950226 mark
              OPEN ddd_bcl USING g_apk_t.apk02,g_apk_t.apk03  #MOD-950226
              IF STATUS THEN
                 CALL cl_err("OPEN ddd_bcl:", STATUS, 1)
                 LET l_opensw = "Y"
              END IF
              FETCH ddd_bcl INTO g_apk[i].*
              IF SQLCA.sqlcode THEN
                 CALL cl_err(g_apk_t.apk03,SQLCA.sqlcode,1)
                 LET l_opensw = "Y"
              END IF
              LET g_before_input_done = FALSE
              CALL t110_set_entry_apk_120(p_cmd)
              CALL t110_set_no_entry_apk_120(p_cmd)
              LET g_before_input_done = TRUE
           END IF
#CHI-940018  --add end--                              
           CALL t110_set_no_apk_required()  #FUN-970108 
           CALL t110_set_apk_required()     #FUN-970108
#CHI-940018 mark--
#          #-----TQC-620113---------
#          CALL t110_set_entry_apk()
#          IF g_apk[i].apk171 = '28' OR g_apk[i].apk171 = '29' THEN
#             LET g_apk[i].apk12 = g_aza.aza17
#             LET g_apk[i].apk13 = 1
#             CALL t110_set_no_entry_apk()
#          END IF
#          #-----END TQC-620113-----
#CHI-940018 mark--

#CHI-940018  add begin--
      BEFORE INSERT
           LET p_cmd='a'
           INITIALIZE g_apk[i].* TO NULL          
           LET g_apk_t.* = g_apk[i].*         #新輸入資料
           LET apk03_t = ''   #MOD-950226 add
           LET apk11_t = ''   #MOD-950226 add
           LET g_before_input_done = FALSE
           CALL t110_set_entry_apk_120(p_cmd)
           IF g_apk[i].apk171 = '28' OR g_apk[i].apk171 = '29' THEN
              LET g_apk[i].apk12 = g_aza.aza17
              LET g_apk[i].apk13 = 1
              CALL t110_set_no_entry_apk_120(p_cmd)
           END IF           
           #No.TQC-A30072  --Begin
           IF NOT cl_null(g_apa.apa77) THEN 
              LET g_apk[i].apk32 = g_apa.apa77
           ELSE
              CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1
              SELECT apyvcode INTO g_apk[i].apk32  FROM apy_file WHERE apyslip = g_t1   
              IF cl_null(g_apk[i].apk32) THEN 
                 LET g_apk[i].apk32 = g_apz.apz63  
              END IF     
           END IF
           #No.TQC-A30072  --End   
           LET g_before_input_done = TRUE
           CALL cl_show_fld_cont()     
           NEXT FIELD apk02   #MOD-950226 mod apk11->apk02
           
        AFTER INSERT
           IF INT_FLAG THEN
              CALL cl_err('',9001,0)
              LET INT_FLAG = 0
              CANCEL INSERT
           END IF
           IF g_apk[i].apk06 IS NULL OR g_apk[i].apk06 = 0 THEN
             #CALL cl_err('',9001,0)   #MOD-9C0342 mark
              CALL g_apk.deleteElement(i)   #MOD-950226 add
              LET INT_FLAG = 0
             #NEXT FIELD apk11         #MOD-9C0342 mark
              CANCEL INSERT 
           END IF              
           SELECT gec04 INTO l_apk29 FROM gec_file
            WHERE gec01 = g_apk[i].apk11 AND gec011='1'      
           LET g_apk[i].apk06 = cl_digcut(g_apk[i].apk06,g_azi04)
           LET g_apk[i].apk07 = cl_digcut(g_apk[i].apk07,g_azi04)
           LET g_apk[i].apk08 = cl_digcut(g_apk[i].apk08,g_azi04)
           LET g_apk[i].apk06f= cl_digcut(g_apk[i].apk06f,l_azi04)
           LET g_apk[i].apk07f= cl_digcut(g_apk[i].apk07f,l_azi04)
           LET g_apk[i].apk08f= cl_digcut(g_apk[i].apk08f,l_azi04)
           IF cl_null(g_apk[i].apk03) THEN LET g_apk[i].apk03=' ' END IF               
           #No.TQC-A30072  --Begin
           ##FUN-990014--Begin
           #IF NOT cl_null(g_apa.apa77) THEN 
           #   LET g_apk[i].apk32 = g_apa.apa77
           #ELSE
           #   CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1
           #   SELECT apyvcode INTO g_apk[i].apk32  FROM apy_file WHERE apyslip = g_t1   
           #   IF cl_null(g_apk[i].apk32) THEN 
           #       LET g_apk[i].apk32 = g_apz.apz63  
           #   END IF     
           #END IF
           ##FUN-990014---End
           #No.TQC-A30072  --End  
           INSERT INTO apk_file (apk01,apk02,apk03,apk04,apk05,apk06,apk06f,
                                 apk07,apk07f,apk08,apk08f,apk11,apk12,apk13,
                                 apk17,apk171,apk172,apk173,apk174,
                                 apk22,apk25,apk29,apk32,              #FUN-970108 add apk32
                                 apkacti,apkgrup,apkuser,apkdate)   
          #VALUES(g_apa.apa01,i,g_apk[i].apk03,               #MOD-950226 mark
           VALUES(g_apa.apa01,g_apk[i].apk02,g_apk[i].apk03,  #MOD-950226
                  g_apk[i].apk04,g_apk[i].apk05,
                  g_apk[i].apk06,g_apk[i].apk06f,
                  g_apk[i].apk07,g_apk[i].apk07f,
                  g_apk[i].apk08,g_apk[i].apk08f,
                  g_apk[i].apk11,g_apk[i].apk12,g_apk[i].apk13,
                  g_apk[i].apk17,g_apk[i].apk171,g_apk[i].apk172,
                  g_apa.apa173,g_apa.apa174,g_apa.apa22,g_apa.apa25,l_apk29,
                  g_apk[i].apk32,'Y',g_grup,g_user,g_today)    #FUN-970108 add apk32
           IF SQLCA.sqlcode THEN
              CALL cl_err3("ins","apk_file",g_apa.apa01,g_apk[i].apk03,SQLCA.sqlcode,"","",1)  
              CANCEL INSERT
           ELSE
              MESSAGE 'INSERT O.K'            
              LET l_rec_b=l_rec_b+1
              IF g_success='Y' THEN
                 COMMIT WORK
              ELSE
                 ROLLBACK WORK
              END IF
           END IF           
#CHI-940018  add end--   

        #str MOD-950226 add
         BEFORE FIELD apk02
           IF g_apk[i].apk06 IS NULL THEN
              INITIALIZE g_apk[i].* TO NULL
              IF g_apk[i].apk02 IS NULL OR g_apk[i].apk02 = 0 THEN
                 SELECT MAX(apk02)+1 INTO g_apk[i].apk02 FROM apk_file
                  WHERE apk01 = g_apa.apa01
                 IF g_apk[i].apk02 IS NULL THEN
                    LET g_apk[i].apk02 = 1
                 END IF
                #DISPLAY g_apk[i].apk02 TO apk02   #MOD-9C0342 mark
              END IF
              IF i = 1 THEN
                 LET g_apk[i].apk04 = g_apa.apa18
                 LET g_apk[i].apk11 = g_apa.apa15
                 LET g_apk[i].apk12 = g_apa.apa13
                 LET g_apk[i].apk13 = g_apa.apa14
                 LET g_apk[i].apk06f= 0
                 LET g_apk[i].apk07f= 0
                 LET g_apk[i].apk08f= 0
                 LET g_apk[i].apk06 = 0
                 LET g_apk[i].apk07 = 0
                 LET g_apk[i].apk08 = 0
                 #FUN-990014---Begin
                 IF NOT cl_null(g_apa.apa77) THEN 
                    LET g_apk[i].apk32 = g_apa.apa77
                 ELSE
                    CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1
                    SELECT apyvcode INTO g_apk[i].apk32  FROM apy_file WHERE apyslip = g_t1   
                    IF cl_null(g_apk[i].apk32) THEN 
                        LET g_apk[i].apk32 = g_apz.apz63  
                    END IF     
                 END IF
                 #FUN-990014---End	 
              END IF
              IF i > 1 THEN
                 LET g_apk[i].apk04  = g_apk[i-1].apk04
                 LET g_apk[i].apk05  = g_apk[i-1].apk05
                 LET g_apk[i].apk11  = g_apk[i-1].apk11
                 LET g_apk[i].apk12  = g_apk[i-1].apk12
                 LET g_apk[i].apk13  = g_apk[i-1].apk13
                 LET g_apk[i].apk171 = g_apk[i-1].apk171
                 LET g_apk[i].apk17  = g_apk[i-1].apk17
                 LET g_apk[i].apk172 = g_apk[i-1].apk172
                 LET g_apk[i].apk32  = g_apk[i-1].apk32   #FUN-970108 add
                 LET g_apk[i].apk06f = 0
                 LET g_apk[i].apk07f = 0
                 LET g_apk[i].apk08f = 0
                 LET g_apk[i].apk06  = 0
                 LET g_apk[i].apk07  = 0
                 LET g_apk[i].apk08  = 0
              END IF
              IF g_apk[i].apk171 = 'XX' THEN
                 LET g_apk[i].apk03 = ' '
                #DISPLAY g_apk[i].apk03 TO apk03   #MOD-9C0342 mark
              END IF
           END IF

         AFTER FIELD apk02
           IF cl_null(g_apk[i].apk02) THEN 
              CALL cl_err('','aqc-052',0)          
              NEXT FIELD apk02
           ELSE
              IF g_apk[i].apk02 != g_apk_t.apk02 OR
                 g_apk_t.apk02 IS NULL THEN
                 #檢查項次是否存在
                 LET l_n = 0
                 SELECT COUNT(*) INTO l_n FROM apk_file 
                  WHERE apk01 = g_apa.apa01 
                    AND apk02 = g_apk[i].apk02
                 IF l_n > 0 THEN 
                    CALL cl_err(g_apk[i].apk02,'asf-406',0)
                    NEXT FIELD apk02
                 END IF 
              END IF 
           END IF 
        #end MOD-950226 add

        #str MOD-950226 mark
        #BEFORE FIELD apk11
        #  IF g_apk[i].apk06 IS NULL THEN
        #     INITIALIZE g_apk[i].* TO NULL
        #     IF i = 1 THEN
        #        #-----MOD-620048---------
        #        IF l_flag2 = 'Y' THEN
        #           LET l_flag2 = 'N'
        #        ELSE
        #        #-----END MOD-620048-----
        #           LET g_apk[i].apk04 = g_apa.apa18
        #           LET g_apk[i].apk11 = g_apa.apa15
        #           LET g_apk[i].apk12 = g_apa.apa13
        #           LET g_apk[i].apk13 = g_apa.apa14
        #           #-----MOD-620048---------
        #           LET g_apk[i].apk06f= 0
        #           LET g_apk[i].apk07f= 0
        #           LET g_apk[i].apk08f= 0
        #           LET g_apk[i].apk06 = 0
        #           LET g_apk[i].apk07 = 0
        #           LET g_apk[i].apk08 = 0
        #        END IF
        #           #-----END MOD-620048-----
        #     END IF
        #     IF i > 1 THEN
        #        LET g_apk[i].apk04  = g_apk[i-1].apk04
        #        LET g_apk[i].apk05  = g_apk[i-1].apk05
        #        LET g_apk[i].apk11  = g_apk[i-1].apk11
        #        LET g_apk[i].apk12  = g_apk[i-1].apk12
        #        LET g_apk[i].apk13  = g_apk[i-1].apk13
        #        LET g_apk[i].apk171 = g_apk[i-1].apk171
        #        LET g_apk[i].apk17  = g_apk[i-1].apk17
        #        LET g_apk[i].apk172 = g_apk[i-1].apk172
        #        #-----MOD-620048---------
        #        LET g_apk[i].apk06f= 0
        #        LET g_apk[i].apk07f= 0
        #        LET g_apk[i].apk08f= 0
        #        LET g_apk[i].apk06 = 0
        #        LET g_apk[i].apk07 = 0
        #        LET g_apk[i].apk08 = 0
        #        #-----END MOD-620048-----
        #     END IF
        #     #-----MOD-620048---------
        #     #LET g_apk[i].apk06f= 0
        #     #LET g_apk[i].apk07f= 0
        #     #LET g_apk[i].apk08f= 0
        #     #LET g_apk[i].apk06 = 0
        #     #LET g_apk[i].apk07 = 0
        #     #LET g_apk[i].apk08 = 0
        #     #LET g_apk[i].apk171 = '21'
        #     #LET g_apk[i].apk17  = '1'
        #     #LET g_apk[i].apk172 = '1'
        #     #-----END MOD-620048-----
        #  END IF
        #end MOD-950226 mark
 
         AFTER FIELD apk11
           IF NOT cl_null(g_apk[i].apk11) THEN
              IF cl_null(apk11_t) OR g_apk[i].apk11 != apk11_t THEN
                 SELECT gec04,gec06,gec08
                   INTO l_apk29,g_apk[i].apk172,g_apk[i].apk171
                   FROM gec_file
                  WHERE gec01 = g_apk[i].apk11 AND gec011='1'  #進項
                    AND gecacti = 'Y'
                 IF STATUS THEN
#                   CALL cl_err(g_apk[i].apk11,'mfg3044',1)   #No.FUN-660122
                    CALL cl_err3("sel","gec_file", g_apk[i].apk11,"","mfg3044","","",1)  #No.FUN-660122
                    NEXT FIELD apk11
                 END IF
                 DISPLAY g_apk[i].apk171,g_apk[i].apk172 TO apk171,apk172   #MOD-950226 add
#--FUN-950094 mark-----------------------------------------------------------
#                #str MOD-880146 add
#                #當執行aapt121(g_aptype='13')時,不管選什麼稅別,都不算稅額,
#                #所以LET l_apk29=0
#                 IF g_aptype = '13' THEN LET l_apk29 = 0 END IF
#                #end MOD-880146 add
#                  #-----No:MOD-530296-----
#--FUN-950094 mark--------------------------------------------------------------
                 IF NOT cl_null(g_apk[i].apk08f) THEN
                    LET g_apk[i].apk08f = cl_digcut(g_apk[i].apk08f,l_azi04)
                    LET g_apk[i].apk07f = g_apk[i].apk08f * l_apk29 / 100
                    LET g_apk[i].apk07f = cl_digcut(g_apk[i].apk07f,l_azi04)
                    LET g_apk[i].apk06f = g_apk[i].apk08f + g_apk[i].apk07f
                    LET g_apk[i].apk06f = cl_digcut(g_apk[i].apk06f,l_azi04)
                    LET g_apk[i].apk08  = g_apk[i].apk08f * g_apk[i].apk13
                    LET g_apk[i].apk08  = cl_digcut(g_apk[i].apk08,g_azi04)
                    LET g_apk[i].apk07  = g_apk[i].apk07f * g_apk[i].apk13
                    LET g_apk[i].apk07  = cl_digcut(g_apk[i].apk07,g_azi04)
                    LET g_apk[i].apk06  = g_apk[i].apk08 + g_apk[i].apk07
                    LET g_apk[i].apk06  = cl_digcut(g_apk[i].apk06,g_azi04)
                 END IF
                  #-----No:MOD-530296-----
                 LET apk11_t = g_apk[i].apk11     #MOD-D40014  add
              END IF
           END IF
           #-----TQC-620113---------
#          CALL t110_set_entry_apk()            #CHI-940018
           CALL t110_set_entry_apk_120(p_cmd)   #CHI-940018
           IF g_apk[i].apk171 = '28' OR g_apk[i].apk171 = '29' THEN
              LET g_apk[i].apk12 = g_aza.aza17
              LET g_apk[i].apk13 = 1
#             CALL t110_set_no_entry_apk()             #CHI-940018
              CALL t110_set_no_entry_apk_120(p_cmd)    #CHI-940018
           END IF
           #-----END TQC-620113-----
           #MOD-B30214--add--str--
           IF g_apk[i].apk171 <> 'XX' THEN
              LET g_apk[i].apk17 = '1'
           END IF
           #MOD-B30214--add--end--

         AFTER FIELD apk03
           IF NOT cl_null(g_apk[i].apk03) AND
              (apk03_t IS NULL OR g_apk[i].apk03 != apk03_t) THEN
#MOD-580051  僅針對帳款性質11,12做t110_invoice_chk()的處理
              LET g_errno = ''   #MOD-5C0088
              IF g_apa.apa00='11' OR g_apa.apa00='12' OR 
                 g_apa.apa00='13' OR g_apa.apa00='15' THEN  #No.FUN-690080  #MOD-9B0190 add 15
                 #CALL t110_invoice_chk(g_apk[i].apk03)   #MOD-770138
                 #CALL t110_invoice_chk(g_apk[i].apk03,g_apk[i].apk11)   #MOD-770138
                 #CALL t110_invoice_chk(g_apk[i].apk03,g_apk[i].apk11,g_apk[i].apk05)   #CHI-820005   #No.TQC-CB0066 Mark
                  CALL t110_invoice_chk(g_apk[i].apk03,g_apk[i].apk11,g_apk[i].apk05,'')              #No.TQC-CB0066 Add
              END IF
#             CALL t110_invoice_chk(g_apk[i].apk03)
#END MOD-580051

              IF NOT cl_null(g_errno) THEN
                 CALL cl_err('',g_errno,0)
                 NEXT FIELD apk03
              END IF
              LET g_errno = ''
              IF i > 1 THEN
                 CALL t110_duplicate(' ',g_apk[i].apk03,i-1)
              END IF
              IF NOT cl_null(g_errno) THEN
                 CALL cl_err('duplicate:',g_errno,0)
                 INITIALIZE g_apk[i].* TO NULL
                 NEXT FIELD apk03
              END IF
               #No.MOD-480431
              LET l_nochk = LENGTH(g_apk[i].apk03)
              IF g_apk[i].apk171 = '28' OR g_apk[i].apk171 = '29' THEN
                 IF l_nochk != 14 THEN
                    CALL cl_err(g_apk[i].apk03,'amd-009',0)
                    NEXT FIELD apk03
                 END IF
                 LET l_chk = 'N'
              ELSE
                 IF NOT cl_null(g_apk[i].apk03) THEN
                    #IF g_apk[i].apk171 != 'XX' THEN   #TQC-630082
                    IF g_aza.aza26<>'2' THEN   #No.MOD-7B0128
                       IF g_apk[i].apk171 != 'XX' AND g_apk[i].apk171 != '22' THEN   #TQC-630082
                          IF l_nochk != 10 THEN
                             CALL cl_err(g_apk[i].apk03,'amd-010',0)
                             NEXT FIELD apk03
                          END IF
                      #str MOD-870022 add
                       ELSE
                          #稅別格式若為22時,提示警訊即可,不控卡
                          IF g_apk[i].apk171='22' THEN
                             CALL cl_err(g_apk[i].apk03,'amd-010',0)
                          END IF
                      #end MOD-870022 add
                       END IF
                    END IF
                 END IF
              END IF
              #MOD-B30214--add--str--
              IF g_apk[i].apk03 != 'MISC' AND g_apk[i].apk03 != 'UNAP' THEN
                 LET l_gec05 = ''
                 SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01=g_apk[i].apk11
                #IF l_gec05 != 'X' THEN                   #No.MOD-B80015 mark
                 IF l_gec05 NOT MATCHES '[4X]' THEN       #No.MOD-B80015 add
                    LET l_apa171=g_apa.apa171          #MOD-B40115 add
                    LET g_apa.apa171=g_apk[i].apk171   #MOD-B40115 add
                    IF NOT t110_chk(g_apk[i].apk03) THEN
                       CALL cl_err(g_apk[i].apk03,'sub-005',0)
                       NEXT FIELD apk03
                    END IF
                    LET g_apa.apa171=l_apa171          #MOD-B40115 add
                 END IF
              END IF
              #MOD-B30214--add--end--

               #No.MOD-480431
           #-----MOD-7A0015---------
           ELSE
             #-MOD-AC0101-add-
             #當發票聯數(gec05)不為4或X時,aapt120的發票欄位(apk03)為必輸
              IF g_aptype ='12' OR g_aptype ='13' OR g_aptype ='15' THEN   #MOD-B30179 add 15 #MOD-B40108 add 13
                 LET l_gec05 = ''
                 SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01=g_apk[i].apk11
                 IF l_gec05 NOT MATCHES '[4X]' AND cl_null(g_apk[i].apk03) THEN
                    CALL cl_err('apk03 is null: ','aap-099',0)
                    NEXT FIELD apk03
                 ELSE
                    IF cl_null(g_apk[i].apk03) THEN   #MOD-B10070  
                       LET g_apk[i].apk03 = ' '     
                    END IF                            #MOD-B10070
                 END IF
              END IF
             #-MOD-AC0101-end-
             #IF g_apk[i].apk171 = 'XX' THEN   #MOD-AA0035 mark
             #   LET g_apk[i].apk03 = ' '      #MOD-AA0035 mark
             #END IF                           #MOD-AA0035 mark
             #str MOD-870022 add
             #稅別格式若為22時,提示警訊即可,不控卡
              IF g_apk[i].apk171='22' THEN
                 CALL cl_err(g_apk[i].apk03,'amd-010',0)
              END IF
             #end MOD-870022 add
           #-----END MOD-7A0015-----
           END IF

            #No.MOD-480431
           IF l_flag1='Y' THEN
              LET l_amb01=YEAR(g_apk[i].apk05)
              LET l_amb02=MONTH(g_apk[i].apk05)
              LET l_amb03=g_apk[i].apk03[1,2]
              LET g_msg = ""   #MOD-9C0356 add
              #CHI-930020--Begin
              SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01 = g_apa.apa15
              IF g_apz.apz07 = 'Y' AND (l_gec05 = '2' OR l_gec05 = '3') AND 
                 g_aza.aza26!= '2' THEN   #MOD-9C0444 add
                 CALL s_apkchk(l_amb01,l_amb02,l_amb03,g_apk[i].apk171)
                      RETURNING g_errno,g_msg
              END IF 
              #CHI-930020---End   
              IF NOT cl_null(g_msg) THEN
                 CALL cl_getmsg(g_msg,g_lang) RETURNING g_msg
                 ERROR g_msg,' invoice =',g_apk[i].apk03,
                             ' SQLCODE=',g_errno
                  IF cl_confirm('aap-766') THEN   #No.MOD-480431
                    IF g_errno='1' OR g_errno='2'  THEN
                       NEXT FIELD apk05
                    ELSE
                       IF g_errno='3'  THEN
                          NEXT FIELD apk03
                       ELSE
                          NEXT FIELD apk171
                       END IF
                    END IF
                 END IF
              END IF
           END IF
            #No.MOD-480431(end)
 
         AFTER FIELD apk171
           IF g_apk[i].apk171 != '21' AND g_apk[i].apk171 != '22' AND
              g_apk[i].apk171 != '23' AND g_apk[i].apk171 != '24' AND
              g_apk[i].apk171 != '25' AND g_apk[i].apk171 != 'XX' AND
              g_apk[i].apk171 != '26' AND g_apk[i].apk171 != '27' AND
              g_apk[i].apk171 != '28' AND g_apk[i].apk171 != '29' THEN
              CALL cl_err(g_apk[i].apk171,'amd-006',0)
              NEXT FIELD apk171
           END IF
           #--- modify by apple 98/06/19-(格式22)無發票號碼不檢查字軌--
           LET l_chk = 'Y'
           IF g_apk[i].apk171 = '22' AND cl_null(g_apk[i].apk03) THEN
              LET l_chk = 'N'
           END IF
           IF g_apk[i].apk171 = 'XX' THEN
              LET l_chk = 'N'
           #MOD-B30214--add--str--
              CALL cl_set_comp_required("apk04",FALSE)
           ELSE
              CALL cl_set_comp_required("apk04",TRUE)
           #MOD-B30214--add--end--
           END IF
         #此段搬到 after field apk03 才判斷  No.MOD-480431
         # #BUGNO4197不檢查字軌檢長碼數,no:7393
         # LET l_nochk = LENGTH(g_apk[i].apk03)
         # IF g_apk[i].apk171 = '28' OR g_apk[i].apk171 = '29' THEN
         #    IF l_nochk != 14 THEN
         #       CALL cl_err(g_apk[i].apk03,'amd-009',0)
         #       NEXT FIELD apk03
         #    END IF
         #    LET l_chk = 'N'
         # ELSE
         #    IF NOT cl_null(g_apk[i].apk03) THEN
         #       IF g_aza.aza26<>'2' THEN   #No.MOD-7B0128
         #          IF g_apk[i].apk171 != 'XX' THEN
         #             IF l_nochk != 10 THEN
         #                 CALL cl_err(g_apk[i].apk03,'amd-010',0)
         #                 NEXT FIELD apk03
         #              END IF
         #          END IF
         #       END IF
         #    END IF
         # END IF
           IF g_apk[i].apk171 = '28' OR g_apk[i].apk171 ='29' THEN
              LET g_apk[i].apk12 = g_aza.aza17
              LET g_apk[i].apk13 = 1
           END IF
 
         AFTER FIELD apk17
           IF NOT cl_null(g_apk[i].apk17) THEN
              IF g_apk[i].apk17 <>' ' AND g_apk[i].apk17 NOT MATCHES '[1234]' THEN   #No:FUN-4C0091
                 NEXT FIELD apk17
              END IF
              IF g_apk[i].apk17 MATCHES '[1234]'  THEN            #No:FUN-4C0091
                 LET l_flag1='Y'
                 IF g_apk[i].apk171='22' THEN
                    IF (g_apk[i].apk03 IS NULL OR g_apk[i].apk03=' ' ) THEN
                       LET l_flag1='N'
                    ELSE
                      IF g_apk[i].apk03[1,1] MATCHES '[A-Z]' AND
                         g_apk[i].apk03[2,2] MATCHES '[A-Z]' AND
                         g_apk[i].apk03[3,3] MATCHES '[0-9]' AND
                         g_apk[i].apk03[4,4] MATCHES '[0-9]' AND
                         g_apk[i].apk03[10,10] MATCHES '[0-9]' THEN
                         LET l_flag1='Y'
                      ELSE
                         LET l_flag1='N'
                      END IF
                    END IF
                 END IF
                 #BUGNO4197不檢查字軌,no:7393
                 IF g_apk[i].apk171 = '28' OR g_apk[i].apk171='29' THEN
                    LET l_flag1='N'
                 END IF
                 IF g_apk[i].apk171 = 'XX' THEN
                    LET l_flag1='N'
                 END IF
 
                # GP版到 after field apk03 再 check #No.MOD-480431
                #IF l_flag1='Y' THEN
                #   LET l_amb01=YEAR(g_apk[i].apk05)
                #   LET l_amb02=MONTH(g_apk[i].apk05)
                #   LET l_amb03=g_apk[i].apk03[1,2]
                #   CALL s_apkchk(l_amb01,l_amb02,l_amb03,g_apk[i].apk171)
                #          RETURNING g_errno,g_msg
                #   IF NOT cl_null(g_msg) THEN
                #      ERROR g_msg,' invoice =',g_apk[i].apk03,
                #                  ' SQLCODE=',g_errno
                #      IF cl_confirm('aap-766') THEN
                #         IF g_errno='1' OR g_errno='2'  THEN
                #            NEXT FIELD apk05
                #         ELSE
                #            IF g_errno='3'  THEN
                #               NEXT FIELD apk03
                #            ELSE
                #               NEXT FIELD apk171
                #            END IF
                #         END IF
                #      END IF
                #   END IF
                #END IF  #No.MOD-480431
              END IF
           END IF
 
         AFTER FIELD apk172
           IF NOT cl_null(g_apk[i].apk172) THEN
              IF g_apk[i].apk172 NOT MATCHES '[123]' THEN
                 CALL cl_err(g_apk[i].apk172,'amd-007',0)
                 NEXT FIELD apk172
              END IF
              IF g_apk[i].apk172='1' THEN
                 SELECT gec04 INTO l_apk29        #No:8593 順便改
                   FROM gec_file
                  WHERE gec01 = g_apk[i].apk11 AND gec011='1'  #進項
                    AND gecacti = 'Y'
#------------FUN-950094 mark----------------------------------------
#                #str MOD-880146 add
#                #當執行aapt121(g_aptype='13')時,不管選什麼稅別,都不算稅額,
#                #所以LET l_apk29=0
#                 IF g_aptype = '13' THEN LET l_apk29 = 0 END IF
#                #end MOD-880146 add
#------------FUN-950094 mark----------------------------------------
                 LET l_tax=g_apk[i].apk08* l_apk29 / 100
                #LET l_tax = cl_digcut(l_tax,l_azi04)     #No:8511 要先取位才對   #No.TQC-CC0035   Mark
                 LET l_tax = cl_digcut(l_tax,g_azi04)                             #No.TQC-CC0035   Add
                 IF g_apk[i].apk07 !=l_tax THEN
                    CALL cl_err(g_apk[i].apk171,'aap-757',0)
                    IF (g_apk[i].apk07 > l_tax+2) OR (g_apk[i].apk07<l_tax-2)  THEN
                       CALL cl_err(g_apk[i].apk171,'mfg-033',0)
                      #NEXT FIELD apk08      #No.TQC-CC0035   Mark
                       NEXT FIELD apk172     #No.TQC-CC0035   Add
                    END IF
                 END IF
                 LET l_tax=cl_digcut(l_tax,l_azi04)
              ELSE
                 LET l_tax=0
              END IF
           END IF
 
         AFTER FIELD apk04
           #-----TQC-630164---------
           IF NOT cl_null(g_apk[i].apk04) THEN
              IF (g_apz.apz14 = 'Y' OR g_aza.aza21 = 'Y') AND   #FUN-990053 mod #TQC-9A0017 add (  #TQC-9A0119 mod ()
                 NOT s_chkban(g_apk[i].apk04) THEN #MOD-9A0145 g_apk[i].apk04-->l_apa.apa18  #TQC-9A0119 mod
                 CALL cl_err('','aoo-080',0) NEXT FIELD apk04
              END IF
              IF g_apa.apa06='MISC' THEN
                 CALL t110_input_apl(g_apk[i].apk04)
              END IF
           ELSE
             LET l_gec05 = ''                                                   #MOD-B50183 
             SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01=g_apk[i].apk11 #MOD-B50183
             #str MOD-B30214 add
             #IF g_apk[i].apk171!='XX' THEN  #MOD-B50183 mark
              IF g_apk[i].apk171 != 'XX' AND g_apk[i].apk171 != '28' AND g_apk[i].apk171 != '29'  #MOD-B50183 
                 AND l_gec05 NOT MATCHES '[4X]' THEN #MOD-B50183
                 CALL cl_err('apk04 is null: ','aap-099',0)
                 NEXT FIELD apk04
              END IF
             #end MOD-B30214 add
             #IF g_apa.apa06='MISC' THEN      #MOD-870232 mark
             #IF g_apk[i].apk171!='XX' THEN   #MOD-870232            #MOD-880044 mark
             #IF g_apa.apa06='MISC' AND g_apk[i].apk171!='XX' THEN   #MOD-880044                             #MOD-880173 mark
             #IF g_apa.apa06='MISC' AND g_apk[i].apk171!='XX' AND g_apk[i].apk171!='28' THEN   #MOD-880044   #MOD-880173     #MOD-B50183 mark
              IF g_apa.apa06='MISC' AND g_apk[i].apk171 != 'XX' AND g_apk[i].apk171 != '28'  #MOD-B50183
                 AND g_apk[i].apk171 != '29' AND l_gec05 NOT MATCHES '[4X]'  THEN            #MOD-B50183
                 NEXT FIELD apk04
              END IF
           END IF

           #IF g_apz.apz14 = 'Y' AND NOT cl_null(g_apk[i].apk04) AND
           #   NOT s_chkban(g_apk[i].apk04) THEN
           #   CALL cl_err('','aoo-080',0)
           #   NEXT FIELD apk04
           #END IF
           # #No.MOD-480441
           #IF g_aza.aza26 = '0' THEN
           #   IF (g_apk[i].apk171 <> 'XX' AND g_apk[i].apk171 <> '28') AND
           #       g_apk[i].apk171 <> '22' AND   #MOD-5B0111
           #       cl_null(g_apk[i].apk04) THEN
           #      NEXT FIELD apk04
           #   END IF
           #END IF
           # #No.MOD-480441 (end)
           #-----END TQC-630164-----
 
         AFTER FIELD apk12
            IF NOT cl_null(g_apk[i].apk12) THEN
               SELECT azi04 INTO l_azi04 FROM azi_file
                WHERE azi01 = g_apk[i].apk12 AND aziacti = 'Y'
               IF STATUS THEN
#                 CALL cl_err(g_apk[i].apk12,'aap-002',0)   #No.FUN-660122
                  CALL cl_err3("sel","azi_file",g_apk[i].apk12,"","aap-002","","",1)  #No.FUN-660122
                  NEXT FIELD apk12
               ELSE
                 #CALL s_curr3(g_apk[i].apk12,g_apa.apa02,'S') #FUN-640022
                  CALL s_curr3(g_apk[i].apk12,g_apa.apa02,g_apz.apz33) #FUN-640022
                       RETURNING g_apk[i].apk13
                  IF g_apk[i].apk12 = g_aza.aza17 THEN
                     LET g_apk[i].apk13 = 1
                  END IF
               END IF
               IF g_apk[i].apk171 = '28' OR g_apk[i].apk171='29' THEN
                  IF g_apk[i].apk12 <> g_aza.aza17 THEN
                     CALL cl_err('','aap-905',1)
                     NEXT FIELD apk12
                  END IF
                  LET g_apk[i].apk12 = g_aza.aza17
                  LET g_apk[i].apk13 = 1
               END IF
            END IF
 
         #-----MOD-830075---------
         BEFORE FIELD apk13
            LET apk13_t = g_apk[i].apk13
 
         AFTER FIELD apk13
            IF apk13_t IS NULL OR apk13_t <> g_apk[i].apk13 THEN
               LET g_apk[i].apk08  = g_apk[i].apk08f * g_apk[i].apk13
               LET g_apk[i].apk07  = g_apk[i].apk07f * g_apk[i].apk13
               LET g_apk[i].apk06  = g_apk[i].apk08  + g_apk[i].apk07
               LET g_apk[i].apk08  = cl_digcut(g_apk[i].apk08,g_azi04)
               LET g_apk[i].apk07  = cl_digcut(g_apk[i].apk07,g_azi04)
               LET g_apk[i].apk06  = cl_digcut(g_apk[i].apk06,g_azi04)
               DISPLAY BY NAME g_apk[i].apk06,g_apk[i].apk07,g_apk[i].apk08               #MOD-9A0051 add
            END IF
         #-----END MOD-830075-----

        #TQC-AB0266--------add--------------str------------
        AFTER FIELD apk06f
           IF g_apk[i].apk06f <= 0 THEN
             #NEXT FIELD apk06f                #TQC-B90062 mark
              IF NOT cl_confirm('aap-249') THEN    #TQC-B90062
                 NEXT FIELD apk06f                 #TQC-B90062
              END IF                               #TQC-B90062
           END IF
        #TQC-AB0266--------add--------------end------------

         BEFORE FIELD apk08f
            LET apk08f_t = g_apk[i].apk08f
 
         AFTER FIELD apk08f
            IF NOT cl_null(g_apk[i].apk08f) THEN
               IF g_apk[i].apk08f <= 0 THEN
                 #NEXT FIELD apk08f            #TQC-B90062 mark
                  IF NOT cl_confirm('aap-249') THEN    #TQC-B90062
                     NEXT FIELD apk08f                 #TQC-B90062
                  END IF                               #TQC-B90062
               END IF
               IF apk08f_t IS NULL OR apk08f_t<>g_apk[i].apk08f THEN   #MOD-7C0053
                  IF g_apk[i].apk172='1' THEN
                     #-----MOD-7C0053---------
                     LET l_gec07 = ''
                     SELECT gec07 INTO l_gec07 FROM gec_file 
                       WHERE gec01 = g_apk[i].apk11
                     IF l_gec07 = 'N' THEN                 
                        LET l_tax = g_apk[i].apk08f * (l_apk29/100)
                     ELSE
                        LET g_apk[i].apk08f = g_apk[i].apk08f / (1+l_apk29/100)
                        LET l_tax = g_apk[i].apk08f * (l_apk29/100)      
                     END IF
                     #LET l_tax = g_apk[i].apk08f * (l_apk29/100)
                     #-----END MOD-7C0053-----
                  ELSE
                     LET l_tax = 0
                  END IF
               #IF apk08f_t IS NULL OR apk08f_t<>g_apk[i].apk08f THEN   #MOD-7C0053
                  LET g_apk[i].apk07f = cl_digcut(l_tax,l_azi04)
                  LET g_apk[i].apk08  = g_apk[i].apk08f * g_apk[i].apk13
                  LET g_apk[i].apk07  = g_apk[i].apk07f * g_apk[i].apk13
                  LET g_apk[i].apk06  = g_apk[i].apk08  + g_apk[i].apk07
                  LET g_apk[i].apk08  = cl_digcut(g_apk[i].apk08,g_azi04)
                  LET g_apk[i].apk07  = cl_digcut(g_apk[i].apk07,g_azi04)
                  LET g_apk[i].apk06  = cl_digcut(g_apk[i].apk06,g_azi04)
               #END IF    #MOD-7C0053
                  LET g_apk[i].apk06f = g_apk[i].apk08f + g_apk[i].apk07f
                  LET g_apk[i].apk06f = cl_digcut(g_apk[i].apk06f,l_azi04)
                  LET g_apk[i].apk08f = cl_digcut(g_apk[i].apk08f,l_azi04)
               END IF    #MOD-7C0053
            END IF
 
         AFTER FIELD apk07f
            IF NOT cl_null(g_apk[i].apk07f) THEN
               IF g_apk[i].apk172='1' THEN
                  LET l_tax = g_apk[i].apk08f*l_apk29/100
                  LET l_tax = cl_digcut(l_tax,l_azi04)
                  IF g_apk[i].apk07f !=l_tax THEN
                     CALL cl_err(g_apk[i].apk171,'aap-757',0)
                     IF (g_apk[i].apk07f > l_tax+2) OR (g_apk[i].apk07f<l_tax-2) THEN
                        CALL cl_err(g_apk[i].apk171,'mfg-033',0)
                        NEXT FIELD apk07f
                     END IF
                  END IF
               END IF
               IF g_apk[i].apk07f > 0 AND l_apk29 = 0 THEN
                  CALL cl_err('','aap-902',1)
                  NEXT FIELD apk07f
               END IF
               LET g_apk[i].apk06f = g_apk[i].apk08f + g_apk[i].apk07f
               LET g_apk[i].apk06f = cl_digcut(g_apk[i].apk06f,l_azi04)
               LET g_apk[i].apk07f = cl_digcut(g_apk[i].apk07f,l_azi04)
               LET g_apk[i].apk07  = g_apk[i].apk07f * g_apk[i].apk13
               LET g_apk[i].apk06  = g_apk[i].apk08  + g_apk[i].apk07
               LET g_apk[i].apk07  = cl_digcut(g_apk[i].apk07,g_azi04)
               LET g_apk[i].apk06  = cl_digcut(g_apk[i].apk06,g_azi04)
               DISPLAY g_apk[i].apk07 TO apk07                              #MOD-D10210 add
            END IF
 
         BEFORE FIELD apk08
            LET apk08_t = g_apk[i].apk08
 
         AFTER FIELD apk08
            IF NOT cl_null(g_apk[i].apk08) THEN
               IF g_apk[i].apk08 <= 0 THEN
                 #CALL cl_err('','agl-006',0)  #MOD-4A0001  #TQC-B90062 mark
                 #NEXT FIELD apk08                          #TQC-B90062 mark
                  IF NOT cl_confirm('aap-249') THEN            #TQC-B90062
                     NEXT FIELD apk08                          #TQC-B90062
                  END IF                                       #TQC-B90062
               END IF
               IF apk08_t IS NULL OR apk08_t<>g_apk[i].apk08 THEN   #MOD-7C0053
                  IF g_apk[i].apk172='1' THEN
                     #-----MOD-7C0053---------
                     LET l_gec07 = ''
                     SELECT gec07 INTO l_gec07 FROM gec_file 
                       WHERE gec01 = g_apk[i].apk11
                     IF l_gec07 = 'N' THEN                 
                        LET l_tax = g_apk[i].apk08 * (l_apk29/100)
                     ELSE
                        LET g_apk[i].apk08 = g_apk[i].apk08 / (1+l_apk29/100)
                        LET l_tax = g_apk[i].apk08 * (l_apk29/100)      
                     END IF
                     #LET l_tax = g_apk[i].apk08 * (l_apk29/100)
                     #-----END MOD-7C0053-----
                  ELSE
                     LET l_tax = 0
                  END IF
               #IF apk08_t IS NULL OR apk08_t<>g_apk[i].apk08 THEN   #MOD-7C0053
                  #LET g_apk[i].apk07 = cl_digcut(l_tax,l_azi04)   #MOD-6B0066
                  LET g_apk[i].apk07 = cl_digcut(l_tax,g_azi04)   #MOD-6B0066
               #END IF   #MOD-7C0053
                  LET g_apk[i].apk06 = g_apk[i].apk08 + g_apk[i].apk07
                  LET g_apk[i].apk06 = cl_digcut(g_apk[i].apk06,g_azi04)
                  LET g_apk[i].apk08 = cl_digcut(g_apk[i].apk08,g_azi04)
               END IF   #MOD-7C0053
            END IF
 
         AFTER FIELD apk07
            IF NOT cl_null(g_apk[i].apk07) THEN
               IF g_apk[i].apk07 < 0 THEN
                 #NEXT FIELD apk07            #TQC-B90062 mark
                  IF NOT cl_confirm('aap-249') THEN    #TQC-B90062
                     NEXT FIELD apk07                  #TQC-B90062
                  END IF                               #TQC-B90062
               END IF
               IF g_apk[i].apk07 > 0 AND l_apk29 = 0 THEN
                  CALL cl_err('','aap-902',1)
                  NEXT FIELD apk07
               END IF
               IF g_apk[i].apk172='1' THEN
                  LET l_tax=g_apk[i].apk08*l_apk29/100
                 #LET l_tax = cl_digcut(l_tax,l_azi04)   #No.TQC-CC0035   Mark
                  LET l_tax = cl_digcut(l_tax,g_azi04)   #No.TQC-CC0035   Add
                  IF g_apk[i].apk07 !=l_tax THEN
                     CALL cl_err(g_apk[i].apk171,'aap-757',0)
                     IF (g_apk[i].apk07 > l_tax+2) OR (g_apk[i].apk07<l_tax-2)  THEN
                        CALL cl_err(g_apk[i].apk171,'mfg-033',0)
                        NEXT FIELD apk07
                     END IF
                  END IF
               END IF
               LET g_apk[i].apk06 = g_apk[i].apk08 + g_apk[i].apk07
               LET g_apk[i].apk06 = cl_digcut(g_apk[i].apk06,g_azi04)
               LET g_apk[i].apk07 = cl_digcut(g_apk[i].apk07,g_azi04)
            END IF
 
         #FUN-970108---Begin
         AFTER FIELD apk32
            IF NOT cl_null(g_apk[i].apk32) THEN   
              SELECT COUNT(*) INTO g_cnt FROM ama_file
               WHERE ama02 = g_apk[i].apk32
                IF g_cnt = 0 THEN 
                   IF g_aza.aza26 = '0' THEN              #MOD-A10127 add
                      CALL cl_err("","amd-028",1) 
                   END IF                                 #MOD-A10127 add
                END IF
               #IF g_aza.aza21 = 'Y' OR NOT s_chkban(g_apk[i].apk32) THEN #FUN-990053 mod   #TQC-9A0017 mark
                IF g_aza.aza21 = 'Y' AND NOT s_chkban(g_apk[i].apk32) THEN #FUN-990053 mod  #TQC-9A0017
                   CALL cl_err("","mfg7015",1)
                   NEXT FIELD apk32
                END IF 
            ELSE
               IF g_aza.aza94 = 'Y' THEN
                   CALL cl_err('apk32 is null: ','aap-099',0)  
                   NEXT FIELD apk32 
               END IF
            END IF       
         #FUN-970108---End
         
         BEFORE DELETE                            #是否取消單身
            DELETE FROM apk_file
             WHERE apk03 = g_apk[i].apk03
               AND apk01 = g_apa.apa01
               AND apk02 = g_apk[i].apk02    #MOD-950226 add
            LET l_flag2 = 'Y'   #MOD-620048
            IF SQLCA.sqlcode THEN
#              CALL cl_err(g_apk[i].apk03,SQLCA.sqlcode,0)   #No.FUN-660122
               CALL cl_err3("del","apk_file",g_apk[i].apk03,g_apa.apa01,SQLCA.sqlcode,"","",1)  #No.FUN-660122
               LET g_success = 'N'
               ROLLBACK WORK
               CANCEL DELETE
            ELSE                             #CHI-940018
               COMMIT WORK                   #MOD-950226 add
               LET l_rec_b = l_rec_b - 1     #CHI-940018                       
            END IF
            LET l_del ='Y'  #MOD-4B0243

#CHI-940018 --add begin--     
        ON ROW CHANGE
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               LET g_apk[i].* = g_apk_t.*
               CLOSE ddd_bcl
               ROLLBACK WORK
               EXIT INPUT
            END IF

            #CHI-A40005 add --start--
           #-MOD-B40086-mark-
           #CALL t110_sum_apa32() RETURNING l_apa32,l_apa32f 
           #IF (l_apa32 != g_apa.apa32 OR
           #   l_apa32f != g_apa.apa32f) AND g_aptype = '21'  THEN    #MOD-A50005 add g_aptype='21'
           #   CALL cl_err('','aap-212',1)
           #   NEXT FIELD apk07f 
           #END IF    
           #-MOD-B40086-end-
            #CHI-A40005 add --end--              

            IF l_opensw = 'Y' THEN
               CALL cl_err(g_apk[i].apk03,-263,1)
               LET g_apk[i].* = g_apk_t.*
            ELSE
               IF g_apk[i].apk06 IS NOT NULL AND g_apk[i].apk06 != 0 THEN 
                  SELECT gec04 INTO l_apk29 FROM gec_file
                   WHERE gec01 = g_apk[i].apk11 AND gec011='1'      
                  LET g_apk[i].apk06 = cl_digcut(g_apk[i].apk06,g_azi04)
                  LET g_apk[i].apk07 = cl_digcut(g_apk[i].apk07,g_azi04)
                  LET g_apk[i].apk08 = cl_digcut(g_apk[i].apk08,g_azi04)
                  LET g_apk[i].apk06f= cl_digcut(g_apk[i].apk06f,l_azi04)
                  LET g_apk[i].apk07f= cl_digcut(g_apk[i].apk07f,l_azi04)
                  LET g_apk[i].apk08f= cl_digcut(g_apk[i].apk08f,l_azi04)
                  IF cl_null(g_apk[i].apk03) THEN LET g_apk[i].apk03=' ' END IF             	 
                  UPDATE apk_file SET apk03  = g_apk[i].apk03,
                                      apk04  = g_apk[i].apk04,
                                      apk05  = g_apk[i].apk05,
                                      apk08f = g_apk[i].apk08f,
                                      apk08  = g_apk[i].apk08,
                                      apk07f = g_apk[i].apk07f,
                                      apk07  = g_apk[i].apk07,
                                      apk06f = g_apk[i].apk06f,
                                      apk06  = g_apk[i].apk06,
                                      apk11  = g_apk[i].apk11,
                                      apk12  = g_apk[i].apk12,
                                      apk13  = g_apk[i].apk13,
                                      apk17  = g_apk[i].apk17,          	                                  	                                  	                        
                                      apk171 = g_apk[i].apk171,          	                        
                                      apk172 = g_apk[i].apk172,
                                      apk32  = g_apk[i].apk32    #FUN-970108 add
                   WHERE apk01 = g_apa.apa01
                     AND apk02 = g_apk_t.apk02   #MOD-950226 add
                     AND apk03 = g_apk_t.apk03
                  IF SQLCA.sqlcode OR SQLCA.sqlerrd[3]=0 THEN
                     CALL cl_err3("upd","apk_file",g_apa.apa01,i ,SQLCA.sqlcode,"","t110_ddd(ckp#2):",1) 
                     LET g_apk[i].* = g_apk_t.*
                  ELSE
                     MESSAGE "UPDATE OK"             	  
                     #COMMIT WORK   #No.CHI-A40005 mark 
                  END IF                              	         
               END IF 
            END IF                        
#CHI-940018 --add end--    

         AFTER ROW
          #CHI-A40005 add --start--
          IF INT_FLAG AND g_aptype = '21' THEN      #MOD-A50005 g_aptype='21' add 
               IF l_apa32 != g_apa.apa32 OR l_apa32f != g_apa.apa32f THEN
               ELSE
                 CALL cl_err('',9001,0)                                                                                                
                 LET INT_FLAG = 0                                                                                                                    
                 IF p_cmd = 'u' THEN                                                                                                   
                    LET g_apk[i].* = g_apk_t.*                                                                                      
                 END IF                                                                                                                
                 CLOSE ddd_bcl                                                                                                        
                 ROLLBACK WORK        
                 LET g_success  = 'N'                                                                                                 
                 EXIT INPUT            #MOD-A50005 add
              END IF
          END IF
          #CHI-A40005 add --end--                                                                                                                   

            LET i = ARR_CURR()   #MOD-950226 mod
            #-----MOD-640518---------
            IF INT_FLAG = 0 THEN
               IF cl_null(g_apk[i].apk17) AND g_apk[i].apk171 <> 'XX' THEN 
                  NEXT FIELD apk17
               END IF
            END IF
            #-----END MOD-640518-----
            IF (g_apk[i].apk07f=0 AND g_apk[i].apk08f=0) OR 
               (cl_null(g_apk[i].apk07f) AND cl_null(g_apk[i].apk08f)) THEN   #MOD-950226 add
               INITIALIZE g_apk[i].* TO NULL
            END IF
            IF g_apk[i].apk17 MATCHES '[1234]' THEN      #No:FUN-4C0091
               LET l_flag1= 'Y'
               IF g_apk[i].apk171='22' THEN
                  IF g_apk[i].apk03 IS NULL OR g_apk[i].apk03 = ' ' THEN
                     LET l_flag1='N'
                  ELSE
                     IF g_apk[i].apk03[1,1] MATCHES '[A-Z]' AND
                        g_apk[i].apk03[2,2] MATCHES '[A-Z]' AND
                        g_apk[i].apk03[3,3] MATCHES '[0-9]' AND
                        g_apk[i].apk03[4,4] MATCHES '[0-9]' AND
                        g_apk[i].apk03[10,10] MATCHES '[0-9]' THEN
                        LET l_flag1='Y'
                     ELSE
                        LET l_flag1='N'
                     END IF
                  END IF
               END IF
               IF g_apk[i].apk171 = '28' OR g_apk[i].apk171='29' THEN
                  LET l_flag1='N'
               END IF
               IF g_apk[i].apk171 ='XX' THEN LET l_flag1='N' END IF
               IF l_flag1='Y' THEN
                  LET l_amb01=YEAR(g_apk[i].apk05)
                  LET l_amb02=MONTH(g_apk[i].apk05)
                  LET l_amb03=g_apk[i].apk03[1,2]
                  LET g_msg = ""   #MOD-9C0356 add
                #CHI-930020--Begin
                  SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01 = g_apa.apa15
                  IF g_apz.apz07 = 'Y' AND (l_gec05 = '2' OR l_gec05 = '3') AND 
                     g_aza.aza26!= '2' THEN   #MOD-9C0444 add
                     CALL s_apkchk(l_amb01,l_amb02,l_amb03,g_apk[i].apk171)
                          RETURNING g_errno,g_msg
                  END IF 
                #CHI-930020---End
                  IF g_prog <> 'aapt210' THEN  #CHI-A40005 add 
                     IF NOT cl_null(g_msg) THEN
                        CALL cl_getmsg(g_msg,g_lang) RETURNING g_msg
                        ERROR g_msg,' invoice =',g_apk[i].apk03,' SQLCODE=',g_errno
                         IF cl_confirm('aap-766') THEN #No.MOD-480431
                           IF g_errno='1' OR g_errno='2'  THEN
                              NEXT FIELD apk05
                           ELSE
                              IF g_errno='3'  THEN
                                 NEXT FIELD apk03
                              ELSE
                                 NEXT FIELD apk171
                              END IF
                           END IF
                        END IF
                     END IF
                  END IF  #CHI-A40005 add
               END IF
            END IF
           #str CHI-850025 add
           #當匯率為1時,需檢核原幣與本幣的稅額、金額需相同
           #IF g_apk[i].apk13 = 1 THEN                                    #MOD-880041 mark
            IF g_apk[i].apk13 = 1 AND g_aza.aza17 = g_apk[i].apk12 THEN   #MOD-880041
               IF g_apk[i].apk08f!=g_apk[i].apk08 OR 
                  g_apk[i].apk07f!=g_apk[i].apk07 OR
                  g_apk[i].apk06f!=g_apk[i].apk06 THEN
                  CALL cl_err('','apm-988',1)
                  NEXT FIELD apk08f
               END IF
            END IF
           #end CHI-850025 add
           #str MOD-950226 add
            IF g_apk[i].apk06 IS NULL OR g_apk[i].apk06 = 0 THEN
               CALL g_apk.deleteElement(i)
            END IF
           #end MOD-950226 add
            LET l_tot1 = 0 LET l_tot2 = 0 LET l_tot3 = 0
            LET l_tot28 = 0
             FOR k = 1 TO g_apk.getLength()    #No:MOD-480131
               IF g_apk[k].apk06 IS NULL OR g_apk[k].apk06=0 THEN
                  CONTINUE FOR
               END IF
               IF g_apk[k].apk171='23' THEN
                  LET u_sign = -1
               ELSE
                  LET u_sign = 1
               END IF
               IF g_apk[k].apk171='28'  OR g_apk[k].apk171='29' THEN
                  LET l_tot2 = l_tot2 + g_apk[k].apk07*u_sign    #稅
                  LET l_tot28= l_tot28+ g_apk[k].apk08*u_sign    #營業稅稅基
                  #LET l_tot3 = (l_tot1+l_tot2 )*u_sign   #MOD-640457
                  LET l_tot3 = (l_tot1+l_tot2 )   #MOD-640457
                  LET l_opensw = 'Y'
               ELSE
                  LET l_tot1 = l_tot1 + g_apk[k].apk08*u_sign    #未稅
                  LET l_tot2 = l_tot2 + g_apk[k].apk07*u_sign    #稅
                  #LET l_tot3 = (l_tot1+l_tot2 )*u_sign           #020528add   #MOD-640457
                  LET l_tot3 = (l_tot1+l_tot2 )           #020528add   #MOD-640457
               END IF
            END FOR
            DISPLAY BY NAME l_tot28,l_tot1,l_tot2,l_tot3
#CHI-940018 --begin--          
           IF INT_FLAG THEN                                                                                                         
              CALL cl_err('',9001,0)                                                                                                
              LET INT_FLAG = 0                                                                                                                    
              IF p_cmd = 'u' THEN                                                                                                   
                 LET g_apk[i].* = g_apk_t.*                                                                                      
              END IF                                                                                                                
              CLOSE ddd_bcl                                                                                                        
              ROLLBACK WORK        
              LET g_success  = 'N'                                                                                                 
              EXIT INPUT                                                                                                            
           END IF                                                                                                                   
          CLOSE ddd_bcl                                                                                                           
          COMMIT WORK            
#CHI-940018  --end  
 
          ON ACTION CONTROLP
             IF INFIELD(apk11) THEN
                CALL cl_init_qry_var()
                LET g_qryparam.form     = "q_gec"
                LET g_qryparam.default1 = g_apk[i].apk11
                LEt g_qryparam.arg1     = '1'
                CALL cl_create_qry() RETURNING g_apk[i].apk11
                DISPLAY g_apk[i].apk11 TO apk11          #No:MOD-490344
             END IF
             #FUN-4B0054
             IF INFIELD(apk13) THEN
                   CALL s_rate(g_apk[i].apk12,g_apk[i].apk13)
                   RETURNING g_apk[i].apk13
                   DISPLAY BY NAME g_apk[i].apk13
                   NEXT FIELD apk13
             END IF
             #--
             #FUN-970108---Begin
             IF INFIELD(apk32) THEN
                CALL cl_init_qry_var()
                LET g_qryparam.form     = "q_ama02"
                LET g_qryparam.default1 = g_apk[i].apk32
                CALL cl_create_qry() RETURNING g_apk[i].apk32
                 DISPLAY g_apk[i].apk32 TO apk32 
             END IF
             #FUN-970108---End
             
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
 
      END INPUT
   END IF

   IF INT_FLAG THEN
      LET INT_FLAG = 0
      CLOSE WINDOW t110_ddd_w
      RETURN
   END IF

   LET j = ARR_COUNT()
   
#CHI-940018 --mark begin--
#   WHILE TRUE
#      DELETE FROM apk_file WHERE apk01 = g_apa.apa01
#      IF STATUS THEN
##        CALL cl_err('t110_ddd(ckp#1):',STATUS,1)   #No.FUN-660122
#         CALL cl_err3("del","apk_file",g_apa.apa01,"",STATUS,"","t110_ddd(ckp#1):",1)  #No.FUN-660122
#         LET g_success = 'N' EXIT WHILE
#      END IF
#
#       FOR k = 1 TO g_apk.getLength() #No:MOD-480131
#         IF g_apk[k].apk06 IS NULL OR g_apk[k].apk06=0 THEN
#            CONTINUE FOR
#         END IF
#
#         SELECT gec04 INTO l_apk29 FROM gec_file
#          WHERE gec01 = g_apk[k].apk11 AND gec011='1'        #No:7872 No:8511加gec011
#
#        #No.MOD-840046--begin-- 
#         LET g_apk[k].apk06 = cl_digcut(g_apk[k].apk06,g_azi04)
#         LET g_apk[k].apk07 = cl_digcut(g_apk[k].apk07,g_azi04)
#         LET g_apk[k].apk08 = cl_digcut(g_apk[k].apk08,g_azi04) 
#         LET g_apk[k].apk06f= cl_digcut(g_apk[k].apk06f,l_azi04) 
#         LET g_apk[k].apk07f= cl_digcut(g_apk[k].apk07f,l_azi04)  
#         LET g_apk[k].apk08f= cl_digcut(g_apk[k].apk08f,l_azi04)   
#        #No.MOD-840046---end--- 
#
#         IF cl_null(g_apk[k].apk03) THEN LET g_apk[k].apk03=' ' END IF     #No:8511
#         INSERT INTO apk_file (apk01,apk02,apk03,apk04,apk05,apk06,apk06f,
#                               apk07,apk07f,apk08,apk08f,apk11,apk12,apk13,
#                               apk17,apk171,apk172,apk173,apk174,
#                               apk22,apk25,apk29,
#                               apkacti,apkgrup,apkuser,apkdate)   #MOD-870029 add
#             VALUES(g_apa.apa01,k ,g_apk[k].apk03,g_apk[k].apk04,
#                    g_apk[k].apk05,
#                    g_apk[k].apk06,g_apk[k].apk06f,
#                    g_apk[k].apk07,g_apk[k].apk07f,
#                    g_apk[k].apk08,g_apk[k].apk08f,
#                    g_apk[k].apk11,g_apk[k].apk12,g_apk[k].apk13,
#                    g_apk[k].apk17,g_apk[k].apk171,g_apk[k].apk172,
#                    g_apa.apa173,g_apa.apa174,g_apa.apa22,g_apa.apa25,l_apk29,
#                    'Y',g_grup,g_user,g_today)   #MOD-870029 add
#         IF SQLCA.sqlcode THEN
##           CALL cl_err('t110_ddd(ckp#2):',SQLCA.sqlcode,1)   #No.FUN-660122
#            CALL cl_err3("ins","apk_file",g_apa.apa01,k ,SQLCA.sqlcode,"","t110_ddd(ckp#2):",1)  #No.FUN-660122
#         END IF
#      END FOR
#      EXIT WHILE
#   END WHILE
##CHI-940018 --mark end--
   CLOSE ddd_bcl               #CHI-940018
   COMMIT WORK                #CHI-940018
   CLOSE WINDOW t110_ddd_w    #MOD-4A0001
#MOD-960106---BEGIN                                                                                                                 
  IF (t_tot1 != l_tot1 OR t_tot2 != l_tot2 OR t_tot3 != l_tot3 OR t_tot28 != l_tot28 OR g_apz.apz08='2') THEN #MOD-990177 add OR g_apz.apz08='2'                                   
#  IF g_success = 'Y' THEN     #CHI-940018                                                                                          
#MOD-960106---END  
     #CHI-A40005 mod start---
     #CALL t110_apz08('')
     IF  g_prog <> 'aapt210' THEN 
        CALL t110_apz08('')
     END IF
     #CHI-A40005 mod end---
  END IF                      #CHI-940018

END FUNCTION

#MOD-5B0338
FUNCTION t110_inv()
 DEFINE  l_rec_b                 LIKE type_file.num5,    #No.FUN-690028 SMALLINT
         l_tot1,l_tot2,l_tot3    LIKE apa_file.apa31,
         l_totf1,l_totf2,l_totf3 LIKE apa_file.apa31f,
         l_tot28                 LIKE apk_file.apk28,
         i,k                    LIKE type_file.num5,        # No:FUN-690028 SMALLINT,
         apk08_t                 LIKE apk_file.apk08,
         apk08f_t                LIKE apk_file.apk08f,
         l_apb11                 DYNAMIC ARRAY OF LIKE apb_file.apb11

   OPEN WINDOW t110_inv_w WITH FORM "aap/42f/aapt110_i"
      ATTRIBUTE (STYLE = g_win_style CLIPPED)
   CALL cl_ui_locale("aapt110_i")

   DECLARE t110_inv_c CURSOR FOR
      SELECT DISTINCT apb11 FROM apa_file,apb_file
       WHERE apa01 = g_apa.apa01
         AND apa01 = apb01
   LET i = 1
   LET k = 1
   LET l_tot1 = 0
   LET l_tot2 = 0
   LET l_tot3 = 0
   LET l_tot28 = 0
   CALL g_apk1.clear()   #MOD-960128 mod g_apk->g_pak1
   FOREACH t110_inv_c INTO l_apb11[i]

      DECLARE t110_inv_c2 CURSOR FOR
         SELECT apk11,apk171,apk17,apk172,apk05,
                apk03,apk04,apk12,apk13,apk08f,
                apk07f,apk06f,apk08,apk07,apk06,apk32    #FUN-970108
           FROM apk_file
          WHERE apk03 = l_apb11[i]
        #   AND (apk171='23' OR apk171='24')    #MOD-750014
            AND (apk171='23' OR apk171='24' OR apk171='29' OR apk171='XX')  #MOD-750014
            AND apk01 = g_apa.apa01   #MOD-750014

     #str MOD-960128 mod g_apk->g_pak1
      FOREACH t110_inv_c2 INTO g_apk1[k].*

         IF g_apk1[k].apk171 = '28' OR g_apk1[k].apk171 = '29' THEN
            LET l_tot28 = l_tot28 + g_apk1[k].apk08
            LET l_tot2 = l_tot2 + g_apk1[k].apk07
         ELSE
            LET l_tot1 = l_tot1 + g_apk1[k].apk08
            LET l_tot2 = l_tot2 + g_apk1[k].apk07
            LET l_tot3 = (l_tot1 + l_tot2)
         END IF

         IF cl_null(g_apk1[k].apk03) THEN
            LET g_apk1[k].apk03 = ' '
         END IF

         LET k = k + 1
      END FOREACH
     #end MOD-960128 mod g_apk->g_pak1
      LET i = i + 1
   END FOREACH

   LET l_rec_b  = k - 1

   DISPLAY BY NAME l_tot28,l_tot1,l_tot2,l_tot3

   CALL cl_set_act_visible("accept,cancel", FALSE)

   DISPLAY ARRAY g_apk1 TO s_apk.*  ATTRIBUTE(COUNT=l_rec_b)  #MOD-960128 mod g_apk->g_pak1

      ON IDLE g_idle_seconds
         CALL cl_on_idle()

      ON ACTION about
         CALL cl_about()

      ON ACTION help
         CALL cl_show_help()

      ON ACTION controlg
         CALL cl_cmdask()
 
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033

  END DISPLAY

  CLOSE WINDOW t110_inv_w
  RETURN
END FUNCTION
#END MOD-5B0338

FUNCTION t110_sum(p_apk02,p_apk03,p_apk06,p_apk07,p_apk08,p_apk171)
DEFINE p_i        LIKE type_file.num5      #SMALLINT
DEFINE l_tot1     LIKE type_file.num20_6     # No:FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_tot2     LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_tot3     LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_tot28    LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_totl1    LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_totl2    LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_totl3    LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_totl11   LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_totl21   LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_totl31   LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_totl28   LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_apk08     LIKE apk_file.apk08
DEFINE l_t028     LIKE apk_file.apk08
DEFINE l_apk07     LIKE apk_file.apk07
DEFINE l_apk06     LIKE apk_file.apk06
DEFINE p_apk02  LIKE apk_file.apk02
DEFINE p_apk03  LIKE apk_file.apk03
DEFINE p_apk06  LIKE apk_file.apk06
DEFINE p_apk07  LIKE apk_file.apk07
DEFINE p_apk08  LIKE apk_file.apk08
DEFINE p_apk171 LIKE apk_file.apk171

   SELECT SUM(apk08),SUM(apk07),SUM(apk06) INTO l_totl1,l_totl2,l_totl3
     FROM apk_file
    WHERE apk01=g_apa.apa01 AND apk171 NOT IN ('23','24')

   IF cl_null(l_totl1) THEN
      LET l_totl1 = 0
   END IF

   IF cl_null(l_totl2) THEN
      LET l_totl2 = 0
   END IF

   IF cl_null(l_totl3) THEN
      LET l_totl3 = 0
   END IF

   SELECT SUM(apk08),SUM(apk07),SUM(apk06) INTO l_totl11,l_totl21,l_totl31
     FROM apk_file
    WHERE apk01=g_apa.apa01 AND apk171 IN ('23','24')

   IF cl_null(l_totl11) THEN
      LET l_totl11 = 0
   END IF

   IF cl_null(l_totl21) THEN
      LET l_totl21 = 0
   END IF

   IF cl_null(l_totl31) THEN
      LET l_totl31 = 0
   END IF

   IF g_aptype MATCHES '1*' THEN
      LET l_totl1 = l_totl1 - l_totl11
      LET l_totl2 = l_totl2 - l_totl21
      LET l_totl3 = l_totl3 - l_totl31
   ELSE
      LET l_totl1 = l_totl11
      LET l_totl2 = l_totl21
      LET l_totl3 = l_totl31
   END IF

   IF p_apk08 < 0 THEN
      LET p_apk08 = p_apk08 * -1
      LET p_apk07 = p_apk07 * -1
      LET p_apk06 = p_apk06 * -1
   END IF

   IF cl_null(p_apk02) THEN
      SELECT apk08,apk07,apk06 INTO l_apk08,l_apk07,l_apk06 FROM apk_file
       WHERE apk01=g_apa.apa01
         AND apk03=p_apk03
   ELSE
      SELECT apk08,apk07,apk06 INTO l_apk08,l_apk07,l_apk06 FROM apk_file
       WHERE apk01=g_apa.apa01
         AND apk02=p_apk02
         AND apk03=p_apk03
   END IF

   IF SQLCA.SQLCODE=100 THEN
      LET l_apk08=p_apk08
      LET l_apk07=p_apk07
      LET l_apk06=p_apk06
      LET l_totl1=l_totl1+l_apk08
      LET l_totl2=l_totl2+l_apk07
      LET l_totl3=l_totl3+l_apk06
   ELSE
      LET l_totl1=l_totl1-l_apk08
      LET l_totl2=l_totl2-l_apk07
      LET l_totl3=l_totl3-l_apk06
      LET l_totl1=l_totl1+p_apk08
      LET l_totl2=l_totl2+p_apk07
      LET l_totl3=l_totl3+p_apk06
   END IF

   LET l_tot1=l_totl1
   LET l_tot2=l_totl2
   LET l_tot3=(l_totl1+l_totl2)

   IF g_aptype MATCHES '2*' THEN
      LET l_tot1=l_totl1 * -1
      LET l_tot2=l_totl2 * -1
      LET l_tot3=(l_totl1+l_totl2) * -1
   END IF

   SELECT SUM(apk08) INTO l_totl28 FROM apk_file
    WHERE apk01=g_apa.apa01
      AND (apk171='28' OR apk171='29')

   IF cl_null(l_totl28) THEN
      LET l_totl28 = 0
   END IF

   IF p_apk171='28' OR p_apk171='29' THEN
      SELECT apk08 INTO l_t028 FROM apk_file
       WHERE apk01=g_apa.apa01
         AND apk03=p_apk03
         AND (apk171='28' OR apk171='29')
       IF SQLCA.SQLCODE=100 THEN
          LET l_t028=p_apk08
          LET l_totl28=l_totl1+l_t028
       ELSE
          LET l_totl28=l_totl28-l_t028
          LET l_totl28=l_totl28+p_apk08
       END IF
   END IF

   LET l_tot28=l_totl28
   IF g_aza.aza26 = '2' THEN
      DISPLAY BY NAME l_tot1,l_tot2,l_tot3
   ELSE
      DISPLAY BY NAME l_tot1,l_tot2,l_tot3,l_tot28
   END IF

END FUNCTION

FUNCTION t110_k()
   DEFINE l_totf,l_amtf    LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_tot,l_amt      LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_apv04          LIKE apv_file.apv04      #FUN-4B0079
   DEFINE cnt1,cnt2        LIKE type_file.num5      # No:FUN-690028 SMALLINT
   DEFINE i,j,k            LIKE type_file.num5      #No.FUN-690028 SMALLINT
   #DEFINE l_sql           LIKE type_file.chr1000   #No.FUN-690028 VARCHAR(600)   #MOD-720062
   DEFINE l_sql            STRING                   #MOD-720062
   DEFINE p_cmd            LIKE type_file.chr1      #No.FUN-690028 VARCHAR(1)
   DEFINE g_apv            DYNAMIC ARRAY OF RECORD
                            apv02     LIKE apv_file.apv02,
                            apv03     LIKE apv_file.apv03,
                            apa07     LIKE apa_file.apa07,
                            apv05     LIKE apv_file.apv05,         #No.FUN-680027
                            apa08     LIKE apa_file.apa08,
                            apa14     LIKE apa_file.apa14,
#No.FUN-680027--begin
#                           apa34f_b  LIKE apa_file.apa34,
#                           apa34_b   LIKE apa_file.apa34,
                            apc08     LIKE apc_file.apc08,
                            apc09     LIKE apc_file.apc09,
#No.FUN-680027--end        
                            un_payf   LIKE apv_file.apv04,
                            un_pay    LIKE apv_file.apv04,
                            apv04f    LIKE apv_file.apv04,
                            apv04     LIKE apv_file.apv04
                           END RECORD
   DEFINE g_apv_t          RECORD
                            apv02     LIKE apv_file.apv02,
                            apv03     LIKE apv_file.apv03,
                            apa07     LIKE apa_file.apa07,
                            apv05     LIKE apv_file.apv05,         #No.FUN-680027
                            apa08     LIKE apa_file.apa08,
                            apa14     LIKE apa_file.apa14,
#No.FUN-680027--begin
#                           apa34f_b  LIKE apa_file.apa34,
#                           apa34_b   LIKE apa_file.apa34,
                            apc08     LIKE apc_file.apc08,
                            apc09     LIKE apc_file.apc09,
#No.FUN-680027--end         
                            un_payf   LIKE apv_file.apv04,
                            un_pay    LIKE apv_file.apv04,
                            apv04f    LIKE apv_file.apv04,
                            apv04     LIKE apv_file.apv04
                           END RECORD
   #No.MOD-580365  --begin
   DEFINE m_apa            DYNAMIC ARRAY OF RECORD
                            apa13     LIKE apa_file.apa13,
                            apa72     LIKE apa_file.apa72,
                            apa73     LIKE apa_file.apa73
                           END RECORD
   DEFINE m_apa_t          RECORD
                            apa13     LIKE apa_file.apa13,
                            apa72     LIKE apa_file.apa72,
                            apa73     LIKE apa_file.apa73
                           END RECORD
   DEFINE m_apa34f         LIKE apa_file.apa34f
   DEFINE m_apa34          LIKE apa_file.apa34    #No.MOD-590312
   DEFINE m_apa73          LIKE apa_file.apa73
   DEFINE m_amt            LIKE type_file.num20_6 # No:FUN-690028 DEC(20,6)
   DEFINE l_apa            RECORD LIKE apa_file.*
   DEFINE l_net            LIKE apv_file.apv04
   DEFINE l_apa14          LIKE apa_file.apa14
   DEFINE l_apv02          LIKE apv_file.apv02
   DEFINE l_i              LIKE type_file.num5    #No.FUN-690028 SMALLINT
   #No.MOD-580365  --end
   DEFINE l_apa13          LIKE apa_file.apa13
   DEFINE l_apa41          LIKE apa_file.apa41
   DEFINE l_apv04f         LIKE apv_file.apv04f
   DEFINE l_apa35f,l_apa35 LIKE apa_file.apa35
   DEFINE l_difff,l_diff   LIKE apa_file.apa34
   DEFINE l_sumf,l_sum     LIKE apa_file.apa34
   DEFINE l_sumf_h,l_sum_h LIKE apa_file.apa34
   DEFINE l_total          LIKE apa_file.apa34
   DEFINE l_lock_sw        LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_modify_flag    LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_k,l_over       LIKE type_file.num5,   # No:FUN-690028 SMALLINT,
   l_allow_insert          LIKE type_file.num5,   #可新增否  #No.FUN-690028 SMALLINT
   l_allow_delete          LIKE type_file.num5    #可刪除否  #No.FUN-690028 SMALLINT
   DEFINE ls_rec_b         LIKE type_file.num10   # No:FUN-690028 INTEGER
   DEFINE l_apa06          LIKE apa_file.apa06    #MOD-580079
#No.FUN-680027--begin
   DEFINE l_apc            RECORD LIKE apc_file.* #No.FUN-680027
   DEFINE m_apc13          LIKE apc_file.apc13    #No.FUN-680027
   DEFINE l_apa65          LIKE apa_file.apa65  
   DEFINE l_apa65f         LIKE apa_file.apa65f 
   DEFINE l_apc02          LIKE apc_file.apc02  
   DEFINE l_apc14          LIKE apc_file.apc14  
   DEFINE l_apc15          LIKE apc_file.apc15  
#No.FUN-680027--end
#No.TQC-6B0066--begin
   DEFINE l_apc08          LIKE apc_file.apc08  
   DEFINE l_apc09          LIKE apc_file.apc09 
   DEFINE l_apc13          LIKE apc_file.apc13    #MOD-960280 add 
  #DEFINE l_apc10          LIKE apc_file.apc10    #MOD-880144 add   #MOD-880231 mark
  #DEFINE l_apc11          LIKE apc_file.apc11    #MOD-880144 add   #MOD-880231 mark
   DEFINE l_apv            RECORD
                            apv02     LIKE apv_file.apv02,
                            apv03     LIKE apv_file.apv03,
                            apa07     LIKE apa_file.apa07,
                            apv05     LIKE apv_file.apv05,        
                            apa08     LIKE apa_file.apa08,
                            apa14     LIKE apa_file.apa14,
                            apc08     LIKE apc_file.apc08,
                            apc09     LIKE apc_file.apc09,
                            un_payf   LIKE apv_file.apv04,
                            un_pay    LIKE apv_file.apv04,
                            apv04f    LIKE apv_file.apv04,
                            apv04     LIKE apv_file.apv04
                           END RECORD
   DEFINE l_apa1           RECORD
                            apa13     LIKE apa_file.apa13,
                            apa72     LIKE apa_file.apa72,
                            apa73     LIKE apa_file.apa73
                           END RECORD
#No.TQC-6B0066--end
   DEFINE l_pmb02          LIKE pmb_file.pmb02    #TQC-770027
   DEFINE l_cnt            LIKE type_file.num5    #CHI-840021
   DEFINE apv04f_sum       LIKE apv_file.apv04f   #CHI-840021
   DEFINE apv04_sum        LIKE apv_file.apv04    #CHI-840021
   DEFINE l_apa00          LIKE apa_file.apa00    #No.TQC-950113

   SELECT * INTO g_apa.* FROM apa_file
    WHERE apa01=g_apa.apa01

   IF g_apa.apa00[1,1] = '2' THEN
      RETURN
   END IF
   IF g_apa.apa41 = 'Y' THEN
      CALL cl_err(g_apa.apa01,'aap-005',0)
      RETURN
   END IF
   #IF g_apa.apa63 MATCHES '[Ss1]' THEN      #FUN-540045 #FUN-550042 #FUN-8A0075
   IF g_apa.apa63 MATCHES '[1]' THEN      #FUN-FUN-8A0075  
      CALL cl_err('','mfg3557',0)
      RETURN
   END IF

   LET g_success='Y'
   LET g_apa_t.* = g_apa.*
   BEGIN WORK
   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa_rowid
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl k:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF
   FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
       CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
       CLOSE t110_cl
       ROLLBACK WORK
       RETURN
   END IF

   OPEN WINDOW t110_kkk_w WITH FORM "aap/42f/aapt110_e"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
    CALL cl_ui_locale("aapt110_e")

   #-----MOD-660095---------
#No.CHI-6A0004-------Begin------
#   SELECT azi04 INTO g_azi04 FROM azi_file
#      WHERE azi01 = g_aza.aza17
#No.CHI-6A0004------End--------
   SELECT azi04 INTO t_azi04 FROM azi_file
      WHERE azi01 = g_apa.apa13
   #-----END MOD-660095-----


 
   SELECT COUNT(*) INTO cnt1 FROM apv_file WHERE apv01 = g_apa.apa01

   IF cnt1 = 0 THEN
      DECLARE t110_kkk_c0 CURSOR FOR
#No.FUN-680027--begin
#       SELECT apa01,apa07,apa08,apa14,
#              apa34f,(apa34f-apa35f),0,
#              apa34,(apa34-apa35),0,apa13,apa72,apa73 #No.MOD-580365
#         FROM apa_file
#        WHERE apa06=g_apa.apa06 AND apa07=g_apa.apa07
#          AND apa00 MATCHES "2*"
#          AND apa13 = g_apa.apa13          # 幣別必須相同
#          AND apa08 != g_apa.apa01            # 不可沖自已產生的預付
#          AND apa41 = 'Y' AND apa42 != 'Y'
#          AND (apa58 = '2' OR apa58 ='3' OR apa58 IS NULL)
#          AND apa34 > apa35

        SELECT apc01,apa07,apa08,apc06,    #No.TQC-6B0066
               apc08,(apc08-apc10),0, 
               apc09,(apc09-apc11),0,apa13,apc07,apc13   #No.MOD-580365
          FROM apa_file,apc_file 
         WHERE apa06 = g_apa.apa06
           AND apa07 = g_apa.apa07
           AND apa00 MATCHES '2*' 
           AND apa00 !='25'                 #No.FUN-690080
           AND (apa08 !='UNAP' OR apa08 IS NULL)   #MOD-820129
           AND apa13 = g_apa.apa13          # 幣別必須相同
           AND apa08 != g_apa.apa01         # 不可沖自已產生的預付
           AND apa41 = 'Y' AND apa42 != 'Y' 
           AND (apa58 = '2' OR apa58 ='3' OR apa58 IS NULL) 
           AND apa34 > apa35 
           AND apa01 =apc01 

#No.FUN-680027--end    
      CALL g_apv.clear()
      LET i = 1
      FOREACH t110_kkk_c0 INTO g_apv[i].apv03,g_apv[i].apa07,g_apv[i].apa08,    #No.FUN-680027 #No.FUN-690080
                               g_apv[i].apa14,g_apv[i].apc08,    #No.FUN-680027 #No.FUN-690080
                               g_apv[i].un_payf,g_apv[i].apv04f, #No.FUN-690080
                               g_apv[i].apc09,g_apv[i].un_pay,g_apv[i].apv04,   #No.FUN-680027
                               #No.MOD-580365  --begin
                               m_apa[i].apa13,m_apa[i].apa72,m_apa[i].apa73
                               #No.MOD-580365  --end

         #No.MOD-580365  --begin
         IF g_apz.apz27 = 'Y' AND m_apa[i].apa13 !=g_aza.aza17 THEN
             LET g_apv[i].un_pay = m_apa[i].apa73
             LET g_apv[i].apa14  = m_apa[i].apa72
         END IF
         #No.MOD-580365  --end
         IF cl_null(g_apv[i].apv03) THEN
            EXIT FOREACH
         END IF
         IF g_apa.apa00='11' THEN
            DROP TABLE x

            SELECT apa08 INTO g_msg FROM apa_file WHERE apa01=g_apv[i].apv03

            SELECT apb06 po_no FROM apb_file,apa_file
             WHERE apa01=g_msg AND apa01=apb01 AND apa41='Y' AND apa42!='Y'
              INTO TEMP x

            SELECT COUNT(*) INTO g_cnt FROM x     # 如果原預付有指定 P/O No

            IF g_cnt > 0 THEN
               SELECT MAX(po_no) INTO g_msg FROM x
               SELECT COUNT(*) INTO g_cnt FROM apb_file, x
                WHERE apb01=g_apa.apa01 AND apb06=po_no
               IF g_cnt=0 THEN
                  INITIALIZE g_apv[i].* TO NULL CONTINUE FOREACH
               END IF
            END IF
         END IF

#TQC-6B0066--begin
         DECLARE t110_sel_apc02 CURSOR FOR
	     #SELECT apc02 FROM apc_file WHERE apc01 =g_apa.apa01  #No.MOD-A10055 mark by liuxqa 
             SELECT apc02 FROM apc_file WHERE apc01 =g_apv[i].apv03 #No.MOD-A10055 mod by liuxqa 
                                          AND apc08 >(apc10+apc14)
         LET j=0
         LET l_apv.apv03    = g_apv[i].apv03  
         LET l_apv.apa07    = g_apv[i].apa07  
         LET l_apv.apa08    = g_apv[i].apa08  
         LET l_apv.apa14    = g_apv[i].apa14  
         LET l_apv.apc08    = g_apv[i].apc08  
         LET l_apv.un_payf  = g_apv[i].un_payf
         LET l_apv.apv04f   = g_apv[i].apv04f 
         LET l_apv.apc09    = g_apv[i].apc09  
         LET l_apv.un_pay   = g_apv[i].un_pay 
         LET l_apv.apv04    = g_apv[i].apv04  
         LET l_apa1.apa13   = m_apa[i].apa13  
         LET l_apa1.apa72   = m_apa[i].apa72  
         LET l_apa1.apa73   = m_apa[i].apa73 
         FOREACH t110_sel_apc02 INTO l_apc02
            LET g_apv[i].apv02    = i
            LET g_apv[i].apv05    = l_apc02
            LET g_apv[i].apv03    = l_apv.apv03  
            LET g_apv[i].apa07    = l_apv.apa07  
            LET g_apv[i].apa08    = l_apv.apa08  
            LET g_apv[i].apa14    = l_apv.apa14  
            LET g_apv[i].apc08    = l_apv.apc08  
            LET g_apv[i].un_payf  = l_apv.un_payf
            LET g_apv[i].apv04f   = l_apv.apv04f 
            LET g_apv[i].apc09    = l_apv.apc09  
            LET g_apv[i].un_pay   = l_apv.un_pay 
            LET g_apv[i].apv04    = l_apv.apv04  
            LET m_apa[i].apa13    = l_apa1.apa13  
            LET m_apa[i].apa72    = l_apa1.apa72  
            LET m_apa[i].apa73    = l_apa1.apa73 
            INSERT INTO apv_file(apv01,apv02,apv03,apv04f,apv04,apv05)     #No.FUN-680027
              VALUES (g_apa.apa01,i,g_apv[i].apv03,0,0,g_apv[i].apv05)     #No.FUN-680027
            LET j=1 
            LET i = i + 1
            IF i > g_max_rec THEN     #No:MOD-480131
               EXIT FOREACH
            END IF
         END FOREACH
         LET i=i-j
#TQC-6B0066--end
         LET i = i + 1
         IF i > g_max_rec THEN     #No:MOD-480131
            EXIT FOREACH
         END IF
      END FOREACH
      CALL g_apv.deleteElement(i)
      LET ls_rec_b = i - 1
   END IF

   IF cnt1 > 0 THEN
     #-MOD-A70095-add-
    #-MOD-A80217-mark-
    # LET l_cnt = 0
    # SELECT count(*) INTO l_cnt
    #   FROM apv_file
    #  WHERE apv01 = g_apa.apa01 AND apv03 = 'DIFF'
    ##若有DIFF既代表此筆AP帳款已用全額沖帳方式處理,如有匯率異動時則會計算出apa34差異金額
    # IF l_cnt > 0 THEN    
    #    UPDATE apv_file SET apv04 = apv04 + g_apa.apa34
    #     WHERE apv01 = g_apa.apa01 AND apv03 = 'DIFF'
    #    IF SQLCA.sqlcode OR SQLCA.SQLERRD[3]=0 THEN  
    #       CALL cl_err3("upd","apv_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apv04:",1)  
    #    END IF
    #    LET g_apa.apa65  = g_apa.apa65  + g_apa.apa34
    # END IF
    #-MOD-A80217-end-
     #-MOD-A70095-end-
      DECLARE t110_kkk_c CURSOR FOR
#No.FUN-680027--begin
#        SELECT apv02,apv03,apa07,apa08,apa14,
#           apa34f,apa34,(apa34f-apa35f),(apa34-apa35 ),apv04f,apv04,#MOD-4A0288
#           apa13,apa72,apa73  #No.MOD-580365
#          FROM apv_file, OUTER apa_file
#         WHERE apv01 = g_apa.apa01 AND apv03 = apa_file.apa01
#         ORDER BY apv02
         SELECT apv02,apv03,apa07,apv05,apa08,apc06,                #No.TQC-6B0066
            apc08,apc09,(apc08-apc10),(apc09-apc11),apv04f,apv04,#MOD-4A0288
            apa13,apc07,apc13  #No.MOD-580365
           FROM apv_file,OUTER apc_file,OUTER apa_file
          WHERE apv01 = g_apa.apa01 AND apv03 = apa_file.apa01
            AND  apc_file.apc01 =apv03
#           AND  apc_file.apc01 =apa_file.apa01  #No.TQC-850001
            AND  apa_file.apa01 =apv03           #No.TQC-850001
#           AND  apc_file.apc02 =apv05
            AND  apc_file.apc02 =1        #No.TQC-6B0066
          ORDER BY apv02
#No.FUN-680027--end   

      CALL g_apv.clear()
      LET k = 1
     #LET g_apa.apa65f= 0   #MOD-860251 mark
     #LET g_apa.apa65 = 0   #MOD-860251 mark

      FOREACH t110_kkk_c INTO g_apv[k].*,m_apa[k].* #No.MOD-580365
        #LET g_apa.apa65f = g_apa.apa65f + g_apv[k].apv04f   #MOD-860251 mark
        #LET g_apa.apa65  = g_apa.apa65  + g_apv[k].apv04    #MOD-860251 mark
         LET k = k + 1
         IF k > g_max_rec THEN         #No:MOD-480131
            EXIT FOREACH
         END IF
      END FOREACH
      CALL g_apv.deleteElement(k)
     #str MOD-860251 add
     #重新計算沖帳視窗中的匯差
     #-MOD-A70095-mark-
     #LET l_net = 0
     #FOR l_i = 1 TO g_apv.getLength()
     #    IF cl_null(g_apv[l_i].apv03) THEN CONTINUE FOR END IF
     #    IF g_apv[l_i].apv03 = 'DIFF' THEN CONTINUE FOR END IF
     #    SELECT apa14 INTO l_apa14 FROM apa_file
     #     WHERE apa01=g_apv[l_i].apv03
     #    IF l_apa14 <> g_apv[l_i].apa14 THEN
     #       LET l_amt=cl_digcut(g_apv[l_i].apv04f*g_apa.apa14,g_azi04)
     #                -g_apv[l_i].apv04
     #       IF cl_null(l_amt) THEN LET l_amt=0 END IF
     #       LET l_net = l_net + l_amt
     #       LET l_net = cl_digcut(l_net,g_azi04)
     #    ELSE
     #       IF g_apv[l_i].apa14 <> g_apa.apa14 THEN
     #          LET l_amt=cl_digcut(g_apv[l_i].apv04f*g_apa.apa14,g_azi04)
     #                   -g_apv[l_i].apv04
     #          IF cl_null(l_amt) THEN LET l_amt=0 END IF
     #          LET l_net = l_net + l_amt
     #          LET l_net = cl_digcut(l_net,g_azi04)
     #       END IF
     #    END IF
     #END FOR
     #DELETE FROM apv_file WHERE apv01=g_apa.apa01 AND apv03='DIFF'
     #IF SQLCA.sqlcode THEN
     #   CALL cl_err3("del","apv_file", g_apa.apa01,"",SQLCA.sqlcode,"","delete diff",1)
     #END IF
     #LET l_cnt = 0
     #SELECT COUNT(*) INTO l_cnt FROM apv_file WHERE apv01=g_apa.apa01
     #IF l_cnt > 0 THEN
     #   SELECT SUM(apv04f),SUM(apv04) INTO apv04f_sum,apv04_sum
     #     FROM apv_file WHERE apv01 = g_apa.apa01
     #   IF cl_null(apv04f_sum) THEN LET apv04f_sum = 0 END IF
     #   IF cl_null(apv04_sum) THEN LET apv04_sum = 0 END IF
     #   IF apv04f_sum = g_apa.apa31f THEN
     #      LET l_net = g_apa.apa31-apv04_sum
     #   END IF
     #END IF
     #IF l_net <> 0 THEN
     #   SELECT MAX(apv02)+1 INTO l_apv02 FROM apv_file
     #    WHERE apv01 = g_apa.apa01
     #   IF cl_null(l_apv02)  THEN
     #      LET l_apv02 = 1
     #   END IF
     #   INSERT INTO apv_file (apv01,apv02,apv03,apv04f,apv04)          
     #                 VALUES (g_apa.apa01,l_apv02,'DIFF',0,l_net)  
     #   IF SQLCA.sqlcode THEN
     #      CALL cl_err3("ins","apv_file",g_apa.apa01,l_apv02,SQLCA.sqlcode,"","insert diff",1)
     #   END IF
     #END IF

     #CALL g_apv.clear()
     #LET k = 1
     #LET g_apa.apa65f = 0
     #LET g_apa.apa65 = 0

     #FOREACH t110_kkk_c INTO g_apv[k].*,m_apa[k].*
     #   LET g_apa.apa65f = g_apa.apa65f + g_apv[k].apv04f
     #   LET g_apa.apa65  = g_apa.apa65  + g_apv[k].apv04
     #   LET k = k + 1
     #   IF k > g_max_rec THEN
     #      EXIT FOREACH
     #   END IF
     #END FOREACH
     #CALL g_apv.deleteElement(k)
     #-MOD-A70095-end-
     #end MOD-860251 add
      LET ls_rec_b = k - 1
   END IF

   LET l_sumf_h = g_apa.apa65f
   LET l_sum_h  = g_apa.apa65

   DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
 
   LET l_allow_insert = cl_detail_input_auth("insert")
   LET l_allow_delete = cl_detail_input_auth("delete")

   LET i = 1
   INPUT ARRAY g_apv WITHOUT DEFAULTS FROM s_apv.*
         ATTRIBUTE(COUNT=ls_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                   INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)

      BEFORE INSERT
         LET i = ARR_CURR()
         LET p_cmd='a'
         INITIALIZE g_apv[i].* TO NULL
         LET g_apv_t.* = g_apv[i].*
         NEXT FIELD apv02
 
      AFTER INSERT
         IF INT_FLAG THEN
            CALL cl_err('',9001,0)
            LET INT_FLAG = 0
            CANCEL INSERT
         END IF
         IF g_apv[i].apv03 IS NULL THEN
            CALL g_apv.deleteElement(i)
            NEXT FIELD apv02
            CANCEL INSERT
         END IF
         INSERT INTO apv_file(apv01,apv02,apv03,apv04f,apv04,apv05)      #No.FUN-680027
          VALUES(g_apa.apa01,g_apv[i].apv02,g_apv[i].apv03,
                 g_apv[i].apv04f,g_apv[i].apv04,g_apv[i].apv05)          #No.FUN-680027
         IF SQLCA.sqlcode THEN
#           CALL cl_err('ins apv:',SQLCA.SQLCODE,1)   #No.FUN-660122
            CALL cl_err3("ins","apv_file",g_apa.apa01,g_apv[i].apv02,SQLCA.sqlcode,"","ins apv:",1)  #No.FUN-660122
            LET g_success = 'N'
            CANCEL INSERT
         ELSE
            LET ls_rec_b = ls_rec_b + 1
            MESSAGE "insert ok"
           #IF g_success = 'Y' THEN   #MOD-830234                              
            IF g_success = 'Y' AND g_apv[i].apv03 <> 'DIFF' THEN   #MOD-830234 
               SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa65f,g_apa.apa65
                 FROM apv_file WHERE apv01=g_apa.apa01
 
               IF cl_null(g_apa.apa65f) THEN
                  LET g_apa.apa65f = 0
               END IF
 
               IF cl_null(g_apa.apa65 ) THEN
                  LET g_apa.apa65 = 0
               END IF
 
               DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
 
               UPDATE apa_file SET apa65f=g_apa.apa65f,apa65=g_apa.apa65
                WHERE apa01 = g_apa.apa01
               #IF STATUS OR SQLCA.SQLCODE THEN   #MOD-730098
               IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
#                 CALL cl_err('upd apa1:',SQLCA.SQLCODE,1)   #No.FUN-660122
                  CALL cl_err3("upd","apa_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                  LET g_success='N'
                  IF p_cmd = 'u' THEN
                     LET g_apv[i].*=g_apv_t.*
                  END IF
#No.TQC-6B0066--begin 
               #-----CHI-820015---------
               #ELSE
#No.FUN-680027--begin
               #   UPDATE apc_file SET apc08=apc08-g_apv[i].apv04f,
               #                       apc09=apc09-g_apv[i].apv04,
               #                       apc14=apc14+g_apv[i].apv04f,
               #                       apc15=apc15+g_apv[i].apv04
               #    WHERE apc01 =g_apa.apa01
               #      AND apc02 =g_apv[i].apv05
               #     IF STATUS OR SQLCA.SQLCODE THEN
               #        CALL cl_err3("upd","apcfile", g_apa.apa01,g_apv[i].apv05,SQLCA.sqlcode,"","",1)  
               #        LET g_success='N'
               #        IF p_cmd = 'u' THEN
               #           LET g_apv[i].*=g_apv_t.*
               #        END IF
               #     END IF
               #-----END CHI-820015-----
               END IF
#            DECLARE t110_apc_cs2 CURSOR FOR
#              SELECT apc14,apc15 FROM apc_file WHERE apc01 =g_apa.apa01 ORDER BY apc02  

#             SELECT count(*) g_cnt FROM apc_file 
#              WHERE apc01 = g_apa.apa01
#             IF g_cnt >0 THEN
#                LET l_apa65  =g_apa.apa65
#                LET l_apa65f =g_apa.apa65f
#                FOREACH t110_apc_cs2 INTO l_apc02,l_apc14,l_apc15
#                    IF l_apc14 >=l_apa65f THEN
#                       LET l_apc14 = l_apc14 - l_apa65f
#                       LET l_apa65f = 0
#                    ELSE 
#                       LET l_apa65f = l_apa65f - l_apc14
#                       LET l_apc14 = 0
#                    END IF
#                    IF l_apc15 >=l_apa65f THEN
#                       LET l_apc15 = l_apc15 - l_apa65
#                       LET l_apa65 = 0
#                    ELSE 
#                       LET l_apa65 = l_apa65 - l_apc15
#                       LET l_apc15 = 0
#                    END IF
#                    UPDATE apc_file set apc14 =l_apc14,
#                                        apc15 =l_apc15
#                     WHERE apc01 = g_apa.apa01
#                       AND apc02 = l_apc02
#                    IF l_apa65 =0 OR l_apa65f = 0 THEN
#                       EXIT FOREACH
#                    END IF
#                END FOREACH
#             END IF
#No.TQC-6B0066--end
#No.FUN-680027--end

            #str MOD-880231 將MOD-850301mark回復
             #str MOD-850301 mark
             #回寫待抵帳款的已付金額的時機,改於確認段再回寫,所以這段mark掉
              SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                FROM aph_file,apf_file
               WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                 AND aph03 IN ('6','7','8','9')
             
              IF g_amt1f IS NULL THEN
                 LET g_amt1f = 0
                 LET g_amt1 = 0
              END IF
             
              SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                FROM apv_file Where apv03=g_apv[i].apv03
             
              IF g_amt2f IS NULL THEN
                 LET g_amt2f = 0
                 LET g_amt2 = 0
              END IF
             
              SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                FROM oob_file,ooa_file
               WHERE oob01 = ooa01
                 AND oob06 = g_apv[i].apv03
                 AND oob03 = '2' AND oob04 = '9'
                 AND ooaconf = 'Y' #須為已確認
             
              IF cl_null(g_amt3f) THEN
                 LET g_amt3f = 0
                 LET g_amt3 = 0
              END IF
             
              #-----TQC-6C0044---------
              #成本分攤
              SELECT SUM(aqb04) INTO g_amt4 FROM aqa_file,aqb_file
               WHERE aqa01 = aqb01 AND aqa04='Y' AND aqaconf = 'Y'
                 AND aqb02=g_apv[i].apv03
              IF cl_null(g_amt4) THEN
                 LET g_amt4=0
                 LET g_amt4f=0
              END IF
              LET g_amt4f=g_amt4/g_apv[i].apa14
             
              #LET g_amt1f=g_amt1f+g_amt2f+g_amt3f
              #LET g_amt1=g_amt1+g_amt2+g_amt3
              LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f
              LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4
              #-----END TQC-6C0044-----
             
              #No.MOD-580365  --begin
              #LET g_apa.apa72=g_apa.apa14
              #LET g_apa.apa73=g_apa.apa34-g_apa.apa35
              SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
              #No.MOD-590312  --begin
              CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
              #No.MOD-640537  --Begin
              #SELECT apa34 INTO m_apa34 FROM apa_file
              #WHERE apa01 = g_apv[i].apv03
              #LET g_apa.apa73 = m_apa34 - g_amt1 + g_net
              LET l_apa.apa73 = l_apa.apa34 - g_amt1 + g_net
              #No.MOD-640537  --End  
              #No.MOD-590312  --end
             
              UPDATE apa_file SET apa35f= g_amt1f,
                                  apa35 = g_amt1,
              #                   apa72 = g_apa.apa72,
                                  apa73 = l_apa.apa73  #No.MOD-640537
               WHERE apa01 = g_apv[i].apv03
              #No.MOD-580365  --end
              #-----MOD-730098---------
              IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
                 CALL cl_err3("upd","apa_file",g_apv[i].apv03,"",STATUS,"","upd apa",1)
                 LET g_success='N'
                 IF p_cmd = 'u' THEN
                    LET g_apv[i].*=g_apv_t.*
                 END IF
              END IF
              #-----END MOD-730098-----
#No.FUN-68002--begin
              SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                FROM aph_file,apf_file
               WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                 AND aph03 IN ('6','7','8','9')
#                AND aph17 = g_apv[i].apv05             #No.FUN-680027
                 AND aph17 = 1                          #No.TQC-6B0066
                  
              IF g_amt1f IS NULL THEN
                 LET g_amt1f = 0
                 LET g_amt1 = 0
              END IF
              
              SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                FROM apv_file Where apv03 =g_apv[i].apv03
#                                AND apv05 = g_apv[i].apv05             #No.FUN-680027
              
              IF g_amt2f IS NULL THEN
                 LET g_amt2f = 0
                 LET g_amt2 = 0
              END IF
              
              SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                FROM oob_file,ooa_file
               WHERE oob01 = ooa01
                 AND oob06 = g_apv[i].apv03
                 AND oob03 = '2' AND oob04 = '9'
                 AND ooaconf = 'Y' #須為已確認
#                AND oob19 = g_apv[i].apv05             #No.FUN-680027
                 AND oob19 = 1                          #No.TQC-6B0066
              
              IF cl_null(g_amt3f) THEN
                 LET g_amt3f = 0
                 LET g_amt3 = 0
              END IF
              

              LET g_amt1f = g_amt1f + g_amt2f + g_amt3f + g_amt4f            #TQC-C70079 add g_amt4f 
              LET g_amt1 = g_amt1 + g_amt2 + g_amt3 + g_amt4                 #TQC-C70079 add g_amt4 
              SELECT * INTO l_apc.* FROM apc_file WHERE apc01=g_apv[i].apv03 AND apc02 =1   #No.TQC-6B0066
              CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
              LET l_apc.apc13 = l_apc.apc09 - g_amt1 + g_net
              UPDATE apc_file set apc10 = g_amt1f,
                                  apc11 = g_amt1,
                                 #apc14 = apc10,    #No.TQC-7C0094   #CHI-820015
                                 #apc15 = apc11,    #No.TQC-7C0094   #CHI-820015
                                  apc13 = l_apc.apc13
               WHERE apc01 =g_apv[i].apv03
#                AND apc02 =g_apv[i].apv05
                 AND apc02 =1               #No.TQC-6B0066
             #end MOD-850301 mark
            #end MOD-880231 將MOD-850301mark回復
#No.FUN-680027--end
#No.TQC-6B0066--begin
                SELECT SUM(apv04),SUM(apv04f) INTO l_apv04,l_apv04f FROM apv_file
                 WHERE apv03 =g_apv[i].apv03
                FOR j=1 TO g_apv.getLength()
                    IF g_apv[j].apv03 =g_apv[i].apv03 THEN
                       LET g_apv[j].un_pay  =g_apv[j].apc09-l_apv04
                    END IF
                END FOR
                
                IF cl_null(g_apv_t.apv04f) THEN
                   LET g_apv_t.apv04f = 0
                END IF
                IF cl_null(g_apv[i].apv04f) THEN
                   LET g_apv[i].apv04f =0
                END IF
                FOR j=1 TO g_apv.getLength()
                    IF g_apv[j].apv03 =g_apv[i].apv03 THEN
                       LET g_apv[j].un_payf =g_apv[j].apc08-l_apv04f
                    END IF
                END FOR
#No.TQC-6B0066--end
            END IF
         END IF

      BEFORE INPUT
         IF ls_rec_b != 0 THEN
            CALL fgl_set_arr_curr(i)
         END IF
         LET g_before_input_done = FALSE
         CALL t110_set_entry_apv('a')
         CALL t110_set_no_entry_apv('a')
         LET g_before_input_done = TRUE

      BEFORE ROW
         LET p_cmd = ''
         LET i = ARR_CURR()
         LET l_lock_sw = 'N'
         IF ls_rec_b >= i THEN
            LET p_cmd='u'
            LET g_apv_t.* = g_apv[i].*
            # LET g_success = 'Y'              #No:MOD-510148
            #-->鎖住待抵沖帳資料
            #No.MOD-580365  --begin
            IF g_apv_t.apv03 <> 'DIFF' THEN
               LET g_forupd_sql = "SELECT apa07,apc12,apc06,apc08,(apc08-apc10),",      #No.FUN-680027
                                  "       apc09,(apc09-apc11),apa13,apc07,apc13",      #No.FUN-680027
                                  "  FROM apa_file,apc_file",       #No.FUN-680027
                                  " WHERE apa01 =apc01 ",           #No.FUN-680027
                                 #"   AND apa01=? FOR UPDATE NOWAIT"       #No.FUN-680027   #No.TQC-850001
                                  "   AND apa01=?           "       #No.FUN-680027   #No.TQC-850001
               #No.MOD-580365  --end
               DECLARE t110_loc_cr CURSOR FROM g_forupd_sql
 
               OPEN t110_loc_cr USING g_apv_t.apv03
               IF STATUS THEN
                  CALL cl_err("OPEN t110_loc_cr:", STATUS, 1)
                  LET l_lock_sw = "Y"
               END IF
 
               FETCH t110_loc_cr INTO g_apv[i].apa07,g_apv[i].apa08,g_apv[i].apa14,
                                      g_apv[i].apc08,g_apv[i].un_payf,      #No.FUN-680027
                                      g_apv[i].apc09,g_apv[i].un_pay,       #No.FUN-680027
                                      m_apa[i].*  #No.MOD-580365
               IF SQLCA.sqlcode THEN
                  CALL cl_err(g_apv_t.apv02,SQLCA.sqlcode,1)
                  LET l_lock_sw = "Y"
               END IF
             #No.MOD-580365  --begin
               IF g_apz.apz27 = 'Y' AND g_aza.aza17 ! = m_apa[i].apa13 THEN
                  LET g_apv[i].un_pay = m_apa[i].apa73
                  LET g_apv[i].apa14  = m_apa[i].apa72
               END IF
            END IF
            #No.MOD-580365  --end
            CALL cl_show_fld_cont()     #FUN-550037(smin)
         END IF
         #-----MOD-680029---------
         CALL t110_set_entry_apv('D')
         IF g_apv[i].apv03='DIFF' THEN
            CALL t110_set_no_entry_apv('D')
         END IF
         #-----END MOD-680029-----

      BEFORE FIELD apv02
         IF cl_null(g_apv[i].apv02) OR g_apv[i].apv02 = 0 THEN
            SELECT MAX(apv02)+1 INTO g_apv[i].apv02 FROM apv_file
             WHERE apv01 = g_apa.apa01
            IF cl_null(g_apv[i].apv02)  THEN
               LET g_apv[i].apv02 = 1
            END IF
            LET g_apv[i].apv04f= 0
            LET g_apv[i].apv04 = 0
         END IF
          CALL t110_set_entry_apv(p_cmd)  #MOD-4A0288

      AFTER FIELD apv02
         IF g_apv_t.apv02 IS NULL OR
            g_apv_t.apv02 != g_apv[i].apv02 THEN
            SELECT COUNT(*) INTO k FROM apv_file
                WHERE apv01 = g_apa.apa01 AND apv02 = g_apv[i].apv02
            IF k > 0 THEN
               CALL cl_err('',-239,0)
               NEXT FIELD apv02
            END IF
         END IF
          CALL t110_set_no_entry_apv(p_cmd)  #MOD-4A0288


      AFTER FIELD apv03
         #No.MOD-580365  --begin
         #IF NOT cl_null(g_apv[i].apv03) THEN
         IF NOT cl_null(g_apv[i].apv03) AND g_apv[i].apv03 <> 'DIFF' THEN
            CALL t110_set_entry_apv('F')
           #-MOD-AA0027-add-
            IF g_apv[i].apv03 = g_apa.apa01 THEN
               CALL cl_err(g_apv[i].apv03,'aap-128',0)
               NEXT FIELD apv03
            END IF
           #-MOD-AA0027-end-
         #No.MOD-580365  --end
#No.TQC-6B0066--begin(原先apv05表示待扺帳款的子帳期，所以把判斷移到apv05之后，
#                     現在apv05表示本單據的子帳期，因此判斷放回apv03)
            #MOD-A30008---modify---start---
            #LET g_forupd_sql = "SELECT apa07,apa08,apa13,apc06,apc08,",
            #                   "       (apc08-apc10),apc09,(apc09-apc11),",
            #                   "       apa41,apa13,apc07,apc13 FROM apa_file,apc_file",
            #                   " WHERE apa01 = ? AND apa00 LIKE '2%'",
#           #                   "   AND apa00 <> '25' ",     #No.FUN-690080  TQC-950113 mark
            #                   "   AND (apa58='2' OR apa58='3' OR apa58 IS NULL)",
            #                   "   AND apc01=apa01 AND apc02 ='1'",
            #                   "   AND apa41 = 'Y' AND apa42 != 'Y' FOR UPDATE NOWAIT"
             LET g_forupd_sql = "SELECT '','','',apc06,apc08,",
                                "       (apc08-apc10),apc09,(apc09-apc11),",
                                "       '','',apc07,apc13 FROM apc_file",
                                " WHERE apc01 = ? AND apc02 ='1' FOR UPDATE NOWAIT"
            #MOD-A30008---modify---end---
            DECLARE t110_loc2_cr CURSOR FROM g_forupd_sql

            OPEN t110_loc2_cr USING g_apv[i].apv03
            IF STATUS THEN
               CALL cl_err("OPEN t110_loc2_cr:", STATUS, 1)
               CLOSE t110_loc2_cr
               ROLLBACK WORK
               RETURN
            END IF

            FETCH t110_loc2_cr INTO g_apv[i].apa07,g_apv[i].apa08,l_apa13,
                                    g_apv[i].apa14,g_apv[i].apc08,l_amtf,
                                    g_apv[i].apc09,l_amt,l_apa41,
                                    m_apa[i].apa13,m_apa[i].apa72,m_apa[i].apa73 #No.MOD-580365
            IF SQLCA.sqlcode THEN
               CALL cl_err(g_apv[i].apv03,SQLCA.sqlcode,0)
               LET g_apv[i].apv03 = g_apv_t.apv03
               CLOSE t110_loc2_cr
               NEXT FIELD apv03
           #MOD-A30008---add---start---
            ELSE
               SELECT apa07,apa08,apa13,apa41,apa13 INTO g_apv[i].apa07,g_apv[i].apa08,l_apa13,l_apa41,m_apa[i].apa13
               FROM apa_file
               WHERE apa01=g_apv[i].apv03
                 AND apa00 MATCHES '2*'
                 AND (apa58='2' OR apa58='3' OR apa58 IS NULL)
                 AND apa41 = 'Y' AND apa42 != 'Y'
           #MOD-A30008---add---end---
              #-MOD-AA0027-add-
               IF SQLCA.sqlcode THEN
                  CALL cl_err(g_apv[i].apv03,'mfg9089',0)
                  NEXT FIELD apv03
               END IF
              #-MOD-AA0027-end-
            END IF
#No.TQC-6B0066-end


#No.FUN-680027--begin  mark起來的內容放在AFTER FIELD apv05內處理
#           LET g_forupd_sql = "SELECT apa07,apa08,apa13,apa14,apa34f,",
#                              "       (apa34f-apa35f),apa34,(apa34-apa35),",
#                              #No.MOD-580365  --begin
#                              "       apa41,apa13,apa72,apa73 FROM apa_file",
#                              #No.MOD-580365  --end
#                              " WHERE apa01 = ? AND apa00 LIKE '2%'",
#                              "   AND (apa58='2' OR apa58='3' OR apa58 IS NULL)",
#                              "   AND apa41 = 'Y' AND apa42 != 'Y' FOR UPDATE NOWAIT"
#           DECLARE t110_loc2_cr CURSOR FROM g_forupd_sql

#           OPEN t110_loc2_cr USING g_apv[i].apv03
#           IF STATUS THEN
#              CALL cl_err("OPEN t110_loc2_cr:", STATUS, 1)
#              CLOSE t110_loc2_cr
#              ROLLBACK WORK
#              RETURN
#           END IF

#           FETCH t110_loc2_cr INTO g_apv[i].apa07,g_apv[i].apa08,l_apa13,
#                                   g_apv[i].apa14,g_apv[i].apa34f_b,l_amtf,
#                                   g_apv[i].apa34_b,l_amt,l_apa41,
#                                   m_apa[i].apa13,m_apa[i].apa72,m_apa[i].apa73 #No.MOD-580365
#           IF SQLCA.sqlcode THEN
#              CALL cl_err(g_apv[i].apv03,SQLCA.sqlcode,0)
#              LET g_apv[i].apv03 = g_apv_t.apv03
#              CLOSE t110_loc2_cr
#              NEXT FIELD apv03
#           END IF
 #MOD-580079
#No.TQC-6B0066--begin(apv05的含義改變，判斷仍放回原處)
            #-----MOD-820129---------
            IF g_apv[i].apa08 = 'UNAP' THEN
               CALL cl_err(g_apv[i].apv03,'aap-915',0)
               NEXT FIELD apv03
            END IF
            #-----END MOD-820129-----
            SELECT apa00,apa06 INTO l_apa00,l_apa06 FROM apa_file
               WHERE apa01= g_apv[i].apv03
#           IF g_apa.apa06 <> l_apa06 THEN
            IF g_apa.apa06 <> l_apa06 AND l_apa00 <> '25' THEN    #No.TQC-950113
               CALL cl_err('','aap-090',1)
            END IF
            #-->此帳款尚未確認
            IF l_apa41 != 'Y' THEN
               CALL cl_err(g_apv[i].apv03,'aap-141',0)
               NEXT FIELD apv03
            END IF

            #-->不可沖不同幣別
            IF l_apa13 != g_apa.apa13 THEN
               CALL cl_err(g_apv[i].apv03,'aap-014',0)
               NEXT FIELD apv03
            END IF

            #-->無金額可沖帳
            IF l_amtf <=0 AND l_amt <=0 AND g_apa.apa41 <> 'N' THEN  #No.FUN-690080
               CALL cl_err(g_apv[i].apv03,'aap-203',0)
               NEXT FIELD apv03
            END IF
            LET g_apv[i].un_payf= l_amtf
            LET g_apv[i].un_pay = l_amt
            #No.MOD-580365  --begin
            SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
            IF g_apz.apz27 = 'Y' AND g_aza.aza17 != m_apa[i].apa13 THEN
                LET g_apv[i].un_pay = m_apa[i].apa73
                LET g_apv[i].apa14  = m_apa[i].apa72
            END IF
#No.TQC-6B0066-end
 #END MOD-580079
#           #-->此帳款尚未確認
#           IF l_apa41 != 'Y' THEN
#              CALL cl_err(g_apv[i].apv03,'aap-141',0)
#              NEXT FIELD apv03
#           END IF

#           #-->不可沖不同幣別
#           IF l_apa13 != g_apa.apa13 THEN
#              CALL cl_err(g_apv[i].apv03,'aap-014',0)
#              NEXT FIELD apv03
#           END IF

#           #-->無金額可沖帳
#           IF l_amtf <=0 AND l_amt <=0 THEN
#              CALL cl_err(g_apv[i].apv03,'aap-203',0)
#              NEXT FIELD apv03
#           END IF
#           LET g_apv[i].un_payf= l_amtf
#           LET g_apv[i].un_pay = l_amt
#           #No.MOD-580365  --begin
#           SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
#           IF g_apz.apz27 = 'Y' AND g_aza.aza17 != m_apa[i].apa13 THEN
#               LET g_apv[i].un_pay = m_apa[i].apa73
#               LET g_apv[i].apa14  = m_apa[i].apa72
#           END IF
#           #No.MOD-580365  --end
#No.FUN-680027--end
         END IF

      AFTER FIELD apv04f
         #No.MOD-580365  --begin
         IF NOT cl_null(g_apv[i].apv04f) THEN
               IF g_apv[i].apv04f < 0 THEN
               NEXT FIELD apv04f
            END IF
            LET l_apv04 = g_apv[i].apv04f * g_apv[i].apa14
            IF g_apv[i].apv03 <> 'DIFF' THEN
               LET g_apv[i].apv04 = l_apv04
            END IF
        #No.TQC-6B0066--begin
        #   SELECT apc08 INTO l_apc08 FROM apc_file
           #SELECT apc08-apc10 INTO l_apc08 FROM apc_file  #No.TQC-740314   #CHI-820015
           #SELECT SUM(apc08-apc10) INTO l_apc08 FROM apc_file  #No.TQC-740314   #CHI-820015   #MOD-880144 mark
           #SELECT SUM(apc10) INTO l_apc10 FROM apc_file  #No.TQC-740314   #CHI-820015         #MOD-880144   #MOD-880231 mark
            SELECT apc08 INTO l_apc08 FROM apc_file       #No.TQC-740314   #CHI-820015         #MOD-880144   #MOD-880231
            #WHERE apc01 =g_apa.apa01       #MOD-850205 mark
             WHERE apc01 = g_apv[i].apv03   #MOD-850205
               #AND apc02 =g_apv[i].apv05   #CHI-820015

       #str MOD-880231 mod
       #   #IF l_apc08 <g_apv[i].apv04f THEN   #MOD-880144 mark
       #    IF l_apc10 <g_apv[i].apv04f THEN   #MOD-880144
       #       CALL cl_err('','aap-779',1)
       #       LET g_apv[i].apv04f =g_apv_t.apv04f
       #       NEXT FIELD apv04f
       #    END IF
       ##No.TQC-6B0066--end
#No.MOD-9B0150 --begin
           #SELECT SUM(apc09-apc11)  INTO l_apc09 FROM apc_file     #TQC-A80186 mark
            SELECT SUM(apc09)  INTO l_apc09 FROM apc_file           #TQC-A80186  
             WHERE apc01 = g_apv[i].apv03   
            IF l_apc08 = g_apv[i].apv04f THEN
               LET g_apv[i].apv04 = l_apc09
            END IF  
#No.MOD-9B0150 --end
            LET g_amt1f = 0
            LET g_amt2f = 0
            LET g_amt3f = 0
            SELECT SUM(aph05f) INTO g_amt1f
              FROM aph_file,apf_file
             WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
               AND aph03 IN ('6','7','8','9')
               AND aph17 = 1                           #No.TQC-6B0066
            IF g_amt1f IS NULL THEN LET g_amt1f = 0 END IF
 
            LET g_amt2f = g_apv[i].apv04f
            IF g_amt2f IS NULL THEN LET g_amt2f = 0 END IF
 
            SELECT SUM(oob09) INTO g_amt3f
              FROM oob_file,ooa_file
             WHERE oob01 = ooa01
               AND oob06 = g_apv[i].apv03
               AND oob03 = '2' AND oob04 = '9'
               AND ooaconf = 'Y' #須為已確認
               AND oob19 = 1                          #No.TQC-6B0066
            IF cl_null(g_amt3f) THEN LET g_amt3f = 0 END IF
 
            LET g_amt1f=g_amt1f+g_amt2f+g_amt3f
            #依全額比較,sum相關沖帳金額與apc08比較,
            #沖帳金額若大於時則提示錯誤訊息
            IF l_apc08 < g_amt1f THEN
               CALL cl_err('','aap-779',1)
               LET g_apv[i].apv04f =g_apv_t.apv04f
               NEXT FIELD apv04f
            END IF
       #end MOD-880231 mod
         END IF
         #原幣是否已經衝平，如果原幣已經衝平，則本幣也應衝平
         SELECT apa34f,apa73 INTO m_apa34f,m_apa73 FROM apa_file
         WHERE apa01 = g_apv[i].apv03
         SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
           FROM aph_file,apf_file
          WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'  
            AND aph03 IN ('6','7','8','9')
         IF g_amt1f IS NULL THEN
            LET g_amt1f = 0
            LET g_amt1 = 0
         END IF
 
         SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
           FROM apv_file Where apv03=g_apv[i].apv03
         IF g_amt2f IS NULL THEN
            LET g_amt2f = 0
            LET g_amt2 = 0
         END IF
 
         SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
           FROM oob_file,ooa_file
          WHERE oob01 = ooa01
            AND oob06 = g_apv[i].apv03
            AND oob03 = '2' AND oob04 = '9'
            AND ooaconf = 'Y' #須為已確認
         IF cl_null(g_amt3f) THEN
            LET g_amt3f = 0
            LET g_amt3 = 0
         END IF

         #-----TQC-6C0044---------
         #成本分攤
         SELECT SUM(aqb04) INTO g_amt4 FROM aqa_file,aqb_file
          WHERE aqa01 = aqb01 AND aqa04='Y' AND aqaconf = 'Y'
            AND aqb02=g_apv[i].apv03
         IF cl_null(g_amt4) THEN
            LET g_amt4=0
            LET g_amt4f=0
         END IF
         LET g_amt4f=g_amt4/g_apv[i].apa14
         #LET m_amt=g_amt1f+g_amt2f+g_amt3f
         LET m_amt=g_amt1f+g_amt2f+g_amt3f+g_amt4f
         #-----END TQC-6C0044-----

         IF p_cmd = 'a' THEN
            LET m_amt=m_amt+g_apv[i].apv04f
         ELSE
            LET m_amt=m_amt+g_apv[i].apv04f-g_apv_t.apv04f
         END IF
        #No.TQC-7A0095--begin-- mark
        #IF m_amt = m_apa34f THEN
        #   #LET g_apv[i].apv04 = m_apa73
        #   LET g_apv[i].apv04 = g_apv[i].apc08*g_apv[i].apa14    #No.FUN-680027  #NO.TQC-7A0097 mark
        #END IF
        #No.TQC-7A0095---end--- mark
         #No.MOD-580365  --end
         #-----MOD-5B0132---------
         SELECT (apa34f-apa35f) INTO l_difff
           FROM apa_file WHERE apa01 = g_apv[i].apv03
 
         IF cl_null(g_apv_t.apv04f) THEN
            LET g_apv_t.apv04f = 0
         END IF
 
         LET l_total = l_difff + g_apv_t.apv04f
 
         IF  g_apv[i].apv04f > l_total THEN
            LET g_apv[i].apv04f = 0
            LET g_apv[i].apv04 = 0
            CALL cl_err(g_apa.apa01,'aap-194',0)
            NEXT FIELD apv04f
         END IF
         #-----END MOD-5B0132-----
         LET g_apv[i].apv04f = cl_digcut(g_apv[i].apv04f,t_azi04)    #MOD-660095
         LET g_apv[i].apv04 = cl_digcut(g_apv[i].apv04,g_azi04)      #MOD-660095
         DISPLAY g_apv[i].apv04 TO apv04                             #MOD-D20103 add
       
      AFTER FIELD apv04
         IF NOT cl_null(g_apv[i].apv04) THEN
            #No.MOD-580365  --begin
            #IF g_apv[i].apv04 < 0 THEN
            #No.MOD-6A0073--begin-- add                                                                                             
            IF g_apv[i].apv04f >0  AND g_apv[i].apv04=0 THEN                                                                        
               NEXT FIELD apv04                                                                                                     
            END IF                                                                                                                  
        #No.TQC-6B0066--begin
        #   SELECT apc09 INTO l_apc09 FROM apc_file
           #SELECT apc09-apc11 INTO l_apc09 FROM apc_file #No.TQC-740314   #CHI-820015
           #SELECT SUM(apc09-apc11) INTO l_apc09 FROM apc_file #No.TQC-740314   #CHI-820015   #MOD-880144 mark
           #SELECT SUM(apc11) INTO l_apc11 FROM apc_file #No.TQC-740314   #CHI-820015         #MOD-880144   #MOD-880231 mark
           #SELECT apc09 INTO l_apc09 FROM apc_file #No.TQC-740314   #CHI-820015   #MOD-880144   #MOD-880231   #MOD-960280 mark
            SELECT apc13 INTO l_apc13 FROM apc_file #No.TQC-740314   #CHI-820015   #MOD-880144   #MOD-880231   #MOD-960280
            #WHERE apc01 =g_apa.apa01      #MOD-850205 mark
             WHERE apc01 =g_apv[i].apv03   #MOD-850205
              #AND apc02 =g_apv[i].apv05   #CHI-820015

       #str MOD-880231 mod
       #   #IF l_apc09 <g_apv[i].apv04 THEN   #MOD-880144 mark
       #    IF l_apc11 <g_apv[i].apv04 THEN   #MOD-880144
       #       CALL cl_err('','aap-779',1)
       #       LET g_apv[i].apv04 =g_apv_t.apv04
       #       NEXT FIELD apv04
       #    END IF
       ##No.TQC-6B0066--end
            LET g_amt1 = 0
            LET g_amt2 = 0
            LET g_amt3 = 0
            SELECT SUM(aph05) INTO g_amt1
              FROM aph_file,apf_file
             WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
               AND aph03 IN ('6','7','8','9')
               AND aph17 = 1                           #No.TQC-6B0066
            IF g_amt1 IS NULL THEN LET g_amt1 = 0 END IF
 
            LET g_amt2 = g_apv[i].apv04
            IF g_amt2 IS NULL THEN LET g_amt2 = 0 END IF

            SELECT SUM(oob10) INTO g_amt3
              FROM oob_file,ooa_file
             WHERE oob01 = ooa01
               AND oob06 = g_apv[i].apv03
               AND oob03 = '2' AND oob04 = '9'
               AND ooaconf = 'Y' #須為已確認
               AND oob19 = 1                          #No.TQC-6B0066
            IF g_amt3 IS NULL THEN LET g_amt3 = 0 END IF
 
            LET g_amt1=g_amt1+g_amt2+g_amt3
            #依全額比較,sum相關沖帳金額與apc08比較,
            #沖帳金額若大於時則提示錯誤訊息
           #IF l_apc09 < g_amt1 THEN   #MOD-960280 mark
           #MOD-9B0050---modify---start---
            IF cl_null(g_apv_t.apv04) THEN
               LET l_apv04=0
            ELSE
               LET l_apv04=g_apv_t.apv04
            END IF
            IF l_apc13 + l_apv04< g_amt2 THEN
           #IF l_apc13 < g_amt2 THEN   #MOD-960280  #MOD-990130 g_amt1-->g_amt2
           #MOD-9B0050---modify---end---
               CALL cl_err('','aap-779',1)
               LET g_apv[i].apv04 =g_apv_t.apv04
               NEXT FIELD apv04
            END IF
       #end MOD-880231 mod
            #-----MOD-750050---------
            #IF g_apv[i].apv04f * g_apv[i].apa14 != g_apv[i].apv04 THEN   
            IF cl_digcut(g_apv[i].apv04f * g_apv[i].apa14,g_azi04) != g_apv[i].apv04 THEN   
            #-----END MOD-750050-----
               IF NOT cl_confirm('aap-202') THEN                                                                                    
                  LET g_apv[i].apv04 = g_apv[i].apv04f*g_apv[i].apa14                                                               
                  LET l_apv04 = g_apv[i].apv04                                                                                      
                  NEXT FIELD apv04                                                                                                  
               END IF                                                                                                               
            END IF                                                                                                                  
            IF g_apv[i].apv04 != g_apv_t.apv04 THEN                                                                                 
               UPDATE apv_file SET apv04=g_apv[i].apv04                                                                             
                WHERE apv01 = g_apa.apa01                                                                                           
                  AND apv02 = g_apv_t.apv02                                                                                         
               IF SQLCA.sqlcode THEN                                                                                                
                  LET g_apv[i].apv04 = 0                                                                                            
                  NEXT FIELD apv04                                                                                                  
               END IF                                                                                                               
            END IF                                                                                                                  
            #No.MOD-6A0073--end-- add  
            IF g_apv[i].apv04 < 0 AND g_apv[i].apv03 <> 'DIFF' THEN
               NEXT FIELD apv04
            END IF

            #No.MOD-580365  --begin
            IF g_apv[i].apv03 != 'DIFF' THEN
            #-->check 沖帳金額是否超過
              #不用控制本幣了，
              #因為有可能本幣會超過請款的金額，超過部分要確認匯兌損溢
            #No.MOD-580365  --end
               LET l_sum = 0
               LET l_sumf = 0
               LET l_over = 0
                FOR l_k =1 TO g_apv.getLength()   #No:MOD-480131
                  IF cl_null(g_apv[l_k].apv03) THEN
                     EXIT FOR
                  END IF
                  LET l_sumf= l_sumf+ g_apv[l_k].apv04f
                  LET l_sum = l_sum + g_apv[l_k].apv04
                  #No.MOD-580365  --begin
                  #IF l_sumf > (g_apa.apa34f + l_sumf_h) OR
                  #   l_sum > (g_apa.apa34 + l_sum_h) THEN
                  IF l_sumf > (g_apa.apa34f + l_sumf_h) THEN #維持原來
                  #No.MOD-580365  --end
                     LET g_apv[i].apv04f= 0
                     LET g_apv[i].apv04 = 0
                     CALL cl_err(g_apa.apa34,'aap-193',0)
                     LET l_over = 1
                     EXIT FOR
                  END IF
               END FOR

               IF l_over=1 THEN
                  NEXT FIELD apv04f
               END IF

               #No.MOD-580365  --begin
               #SELECT (apa34f-apa35f),(apa34-apa35) INTO l_difff,l_diff
               SELECT (apa34f-apa35f),apa73 INTO l_difff,l_diff
                 FROM apa_file WHERE apa01 = g_apv[i].apv03
               #No.MOD-580365  --end

               IF cl_null(g_apv_t.apv04f) THEN
                  LET g_apv_t.apv04f = 0
                  LET g_apv_t.apv04 = 0
               END IF

               LET l_total = l_diff + g_apv_t.apv04

               IF  g_apv[i].apv04 > l_total THEN
                  LET g_apv[i].apv04f = 0
                  LET g_apv[i].apv04 = 0
                  CALL cl_err(g_apa.apa01,'aap-194',0)
                  LET l_over = 1
               END IF

               IF l_over=1 THEN
                  NEXT FIELD apv04f
               END IF
             END IF #No.MOD-580365
         END IF
         LET g_apv[i].apv04 = cl_digcut(g_apv[i].apv04,g_azi04)  #MOD-66009
         DISPLAY g_apv[i].apv04 TO apv04                         #MOD-D20103 add


#No.FUN-680027--begin
      AFTER FIELD apv05
          IF NOT cl_null(g_apv[i].apv05) THEN
#No.TQC-6B0066--begin(apv05含義改變,判斷放回原處)
             IF g_apv_t.apv05 IS NULL OR g_apv[i].apv05 <> g_apv_t.apv05 THEN
                SELECT COUNT(*) INTO g_cnt FROM apc_file 
                 #WHERE apc01 =g_apa.apa01   #MOD-810111
                 WHERE apc01 =g_apv[i].apv03   #MOD-810111
                   AND apc02 =g_apv[i].apv05
                IF g_cnt =0 THEN
                  CALL cl_err('','aap-777',1)
                  NEXT FIELD apv05
                END IF
                SELECT COUNT(*) INTO g_cnt FROM apc_file 
                 #WHERE apc01 =g_apa.apa01   #MOD-810111
                 WHERE apc01 =g_apv[i].apv03   #MOD-810111
                   AND apc02 =g_apv[i].apv05
                   #AND apc08 >(apc10+apc14)   #CHI-820015
                   AND apc08 >apc10   #CHI-820015
                IF g_cnt =0 THEN
                  CALL cl_err('','aap-778',1)
                  NEXT FIELD apv05
                END IF
#            LET g_forupd_sql = "SELECT apa07,apa08,apa13,apc06,apc08,",
#                               "       (apc08-apc10),apc09,(apc09-apc11),",
#                               "       apa41,apa13,apc07,apc13 FROM apa_file,apc_file",
#                               " WHERE apa01 = ? AND apa00 LIKE '2%'",
#                               "   AND apa00 <> '25' ",     #No.FUN-690080
#                               "   AND (apa58='2' OR apa58='3' OR apa58 IS NULL)",
#                               "   AND apc01=apa01 AND apc02 ='",g_apv[i].apv05,"'",
#                               "   AND apa41 = 'Y' AND apa42 != 'Y' FOR UPDATE NOWAIT"
#           DECLARE t110_loc2_cr CURSOR FROM g_forupd_sql

#           OPEN t110_loc2_cr USING g_apv[i].apv03
#           IF STATUS THEN
#              CALL cl_err("OPEN t110_loc2_cr:", STATUS, 1)
#              CLOSE t110_loc2_cr
#              ROLLBACK WORK
#              RETURN
#           END IF

#           FETCH t110_loc2_cr INTO g_apv[i].apa07,g_apv[i].apa08,l_apa13,
#                                    g_apv[i].apa14,g_apv[i].apc08,l_amtf,
#                                   g_apv[i].apc09,l_amt,l_apa41,
#                                   m_apa[i].apa13,m_apa[i].apa72,m_apa[i].apa73 #No.MOD-580365
#           IF SQLCA.sqlcode THEN
#              CALL cl_err(g_apv[i].apv05,SQLCA.sqlcode,0)
#              LET g_apv[i].apv05 = g_apv_t.apv05
#              CLOSE t110_loc2_cr
#              NEXT FIELD apv05
#           END IF
#           #-->此帳款尚未確認
#           IF l_apa41 != 'Y' THEN
#              CALL cl_err(g_apv[i].apv03,'aap-141',0)
#              NEXT FIELD apv05
#           END IF

#           #-->不可沖不同幣別
#           IF l_apa13 != g_apa.apa13 THEN
#              CALL cl_err(g_apv[i].apv03,'aap-014',0)
#              NEXT FIELD apv05
#           END IF

#           #-->無金額可沖帳
#           IF l_amtf <=0 AND l_amt <=0 AND g_apa.apa41 <> 'N' THEN  #No.FUN-690080
#              CALL cl_err(g_apv[i].apv03,'aap-203',0)
#              NEXT FIELD apv05
#           END IF
#           LET g_apv[i].un_payf= l_amtf
#           LET g_apv[i].un_pay = l_amt
#           #No.MOD-580365  --begin
#           SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
#           IF g_apz.apz27 = 'Y' AND g_aza.aza17 != m_apa[i].apa13 THEN
#               LET g_apv[i].un_pay = m_apa[i].apa73
#               LET g_apv[i].apa14  = m_apa[i].apa72
#           END IF
#           #No.MOD-580365  --end
#No.TQC-6B0066--end  
            END IF
         END IF
#No.FUN-680027--begin


      ON ACTION CONTROLP
           CASE
          #FUN-580012  --begin
          #   WHEN INFIELD(apv02)
          #      CALL cl_init_qry_var()
          #      LET g_qryparam.form ="q_apa1"
          #      LET g_qryparam.default1 =g_apv[i].apa08
          #      CALL cl_create_qry() RETURNING g_apv[i].apa08
          #       DISPLAY g_apv[i].apa08 TO apa08                 #No:MOD-490344
          #      NEXT FIELD apv02
          #FUN-580012  --end
              WHEN INFIELD(apv03)
#                CALL q_apa2(FALSE,TRUE,' ','1') RETURNING g_apv[i].apv03,g_apv[i].apv05 #FUN-580012
#                 DISPLAY g_apv[i].apv03,g_apv[i].apv05 TO apv03,apv05                 #No:MOD-490344
                 #CALL q_apa2(FALSE,TRUE,' ','2') RETURNING g_apv[i].apv03    #No.TQC-6B0066  #TQC-750140
                 #CALL q_apa2(FALSE,TRUE,' ','1') RETURNING g_apv[i].apv03                     #TQC-750140    #MOD-820002
                 CALL q_apa2(FALSE,TRUE,' ','1',g_apa.apa06) RETURNING g_apv[i].apv03                     #TQC-750140    #MOD-820002
                  DISPLAY g_apv[i].apv03 TO apv03                                      #No.TQC-6B0066 
                 NEXT FIELD apv03
              OTHERWISE EXIT CASE
           END CASE

         #MOD-4A0288
        BEFORE DELETE                            #是否取消單身
           IF g_apv[i].apv02 > 0 AND g_apv_t.apv02 IS NOT NULL THEN
              IF NOT cl_delb(0,0) THEN
                 CANCEL DELETE
              END IF
              DELETE FROM apv_file
               WHERE apv01 = g_apa.apa01 AND apv02 = g_apv_t.apv02
              IF SQLCA.sqlcode THEN
#                CALL cl_err(g_apv_t.apv02,SQLCA.sqlcode,0)   #No.FUN-660122
                 CALL cl_err3("del","apv_file",g_apa.apa01,g_apv_t.apv02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
                 CANCEL DELETE
              END IF
              LET ls_rec_b = ls_rec_b - 1
              MESSAGE "delete ok"
              IF g_success = 'Y' AND g_apv[i].apv03 <> 'DIFF' THEN #No.MOD-580365
                 SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa65f,g_apa.apa65
                   FROM apv_file WHERE apv01=g_apa.apa01
                 IF cl_null(g_apa.apa65f) THEN LET g_apa.apa65f = 0 END IF
                 IF cl_null(g_apa.apa65 ) THEN LET g_apa.apa65 = 0 END IF
                 DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
                 UPDATE apa_file SET apa65f=g_apa.apa65f,apa65=g_apa.apa65
                  WHERE apa01 = g_apa.apa01
                 #IF STATUS OR SQLCA.SQLCODE THEN   #MOD-730098
                 IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
#                   CALL cl_err('upd apa1:',SQLCA.SQLCODE,1)   #No.FUN-660122
                    CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                    LET g_success='N'
#No.TQC-6B0066--begin 
                 #-----CHI-820015---------
                 #ELSE
                 #   UPDATE apc_file SET apc08=apc08+g_apv[i].apv04f,
                 #                       apc09=apc09+g_apv[i].apv04,
                 #                       apc14=apc14-g_apv[i].apv04f,
                 #                       apc15=apc15-g_apv[i].apv04
                 #    WHERE apc01 =g_apa.apa01
                 #      AND apc02 =g_apv[i].apv05
                 #     IF STATUS OR SQLCA.SQLCODE THEN
                 #        CALL cl_err3("upd","apcfile", g_apa.apa01,g_apv[i].apv05,SQLCA.sqlcode,"","",1)  
                 #        LET g_success='N'
                 #     END IF
                 #-----END CHI-820015-----
                 END IF
#No.TQC-6B0066--end
                 SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                   FROM aph_file,apf_file
                  WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                    AND aph03 IN ('6','7','8','9')
                 IF g_amt1f IS NULL THEN
                    LET g_amt1f = 0
                    LET g_amt1 = 0
                 END IF
                 SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                   FROM apv_file Where apv03=g_apv[i].apv03
                 IF g_amt2f IS NULL THEN
                    LET g_amt2f = 0
                    LET g_amt2 = 0
                 END IF
                 SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                   FROM oob_file,ooa_file
                  WHERE oob01 = ooa01
                    AND oob06 = g_apv[i].apv03
                    AND oob03 = '2' AND oob04 = '9'
                    AND ooaconf = 'Y' #須為已確認
                 IF cl_null(g_amt3f) THEN
                    LET g_amt3f = 0
                    LET g_amt3 = 0
                 END IF
                 #-----TQC-6C0044---------
                 #成本分攤
                 SELECT SUM(aqb04) INTO g_amt4 FROM aqa_file,aqb_file
                  WHERE aqa01 = aqb01 AND aqa04='Y' AND aqaconf = 'Y'
                    AND aqb02=g_apv[i].apv03
                 IF cl_null(g_amt4) THEN
                    LET g_amt4=0
                    LET g_amt4f=0
                 END IF
                 LET g_amt4f=g_amt4/g_apv[i].apa14
 
                 #LET g_amt1f=g_amt1f+g_amt2f+g_amt3f
                 #LET g_amt1=g_amt1+g_amt2+g_amt3
                 LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f
                 LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4
                 #-----END TQC-6C0044-----
                 #No.MOD-580365  --begin
                 #LET g_apa.apa72=g_apa.apa14
                 #LET g_apa.apa73=g_apa.apa34-g_apa.apa35
                 SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
                 #No.MOD-590312  --begin
                 CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
                 #No.MOD-640537  --Begin
                 #SELECT apa34 INTO m_apa34 FROM apa_file
                 # WHERE apa01 = g_apv[i].apv03
                 #LET g_apa.apa73 = m_apa34 - g_amt1 + g_net
                 LET l_apa.apa73 = l_apa.apa34 - g_amt1 + g_net
                 #No.MOD-640537  --End  
                 #No.MOD-590312  --end
                 #No.MOD-580365  --end
                 UPDATE apa_file SET apa35f= g_amt1f,
                                     apa35 = g_amt1,
                                    #apa72 = g_apa.apa72,   No.MOD-580365
                                     apa73 = l_apa.apa73   #No.MOD-640537
                  WHERE apa01 = g_apv[i].apv03
                 #-----MOD-730098---------
                 IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
                    CALL cl_err3("upd","apa_file",g_apv[i].apv03,"",STATUS,"","upd apa:",1)
                    LET g_success='N'
                 END IF
                 #-----END MOD-730098-----
#No.FUN-680027--begin
               SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                 FROM aph_file,apf_file
                WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                  AND aph03 IN ('6','7','8','9')
#                  AND aph17 = g_apv[i].apv05             #No.FUN-680027
                  AND aph17 = 1                           #No.TQC-6B0066
 
               IF g_amt1f IS NULL THEN
                  LET g_amt1f = 0
                  LET g_amt1 = 0
               END IF
 
               SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                 FROM apv_file Where apv03=g_apv[i].apv03
#                                AND aph04=g_apv[i].apv05   #No.FUN-680027
#                                AND apv05=g_apv[i].apv05   #No.TQC-6B0066 

               IF g_amt2f IS NULL THEN
                  LET g_amt2f = 0
                  LET g_amt2 = 0
               END IF
 
               SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                 FROM oob_file,ooa_file
                WHERE oob01 = ooa01
                  AND oob06 = g_apv[i].apv03
                  AND oob03 = '2' AND oob04 = '9'
                  AND ooaconf = 'Y' #須為已確認
#                  AND oob19 = g_apv[i].apv05             #No.FUN-680027
                  AND oob19 = 1                           #No.TQC-6B0066
 
               IF cl_null(g_amt3f) THEN
                  LET g_amt3f = 0
                  LET g_amt3 = 0
               END IF
 
               LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f       #TQC-C70079  add   g_amt4f
               LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4            #TQC-C70079  add   g_amt4
               SELECT * INTO l_apc.* FROM apc_file WHERE apc01=g_apv[i].apv03 AND apc02 =1      #No.TQC-6B0066
               CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
               LET l_apc.apc13 = l_apc.apc09 - g_amt1 + g_net
               UPDATE apc_file set apc10=g_amt1f,
                                   apc11=g_amt1,
                                   #apc14=apc10,    #No.TQC-7C0094   #CHI-820015
                                   #apc15=apc11,    #No.TQC-7C0094   #CHI-820015
                                   apc13=l_apc.apc13
                WHERE apc01 =g_apv[i].apv03
#                  AND apc02 =g_apv[i].apv05
                  AND apc02 =1               #No.TQC-6B0066
#No.FUN-680027--end
#No.TQC-6B0066--begin
                SELECT SUM(apv04),SUM(apv04f) INTO l_apv04,l_apv04f  FROM apv_file
                 WHERE apv03 =g_apv[i].apv03
                FOR j=1 TO g_apv.getLength()
                    IF g_apv[j].apv03 =g_apv[i].apv03 THEN
                       LET g_apv[j].un_pay  =g_apv[j].apc09-l_apv04
                    END IF
                END FOR
                
                IF cl_null(g_apv_t.apv04f) THEN
                   LET g_apv_t.apv04f = 0
                END IF
                IF cl_null(g_apv[i].apv04f) THEN
                   LET g_apv[i].apv04f =0
                END IF
                FOR j=1 TO g_apv.getLength()
                    IF g_apv[j].apv03 =g_apv[i].apv03 THEN
                       LET g_apv[j].un_payf =g_apv[j].apc08-l_apv04f
                    END IF
                END FOR
#No.TQC-6B0066--end
              END IF
           END IF
           #--


      ON ROW CHANGE
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             LET g_apv[l_ac].* = g_apv_t.*
             CLOSE t110_loc2_cr
             LET g_success = 'N'
             EXIT INPUT
          END IF
          IF l_lock_sw = 'Y' THEN
             CALL cl_err(g_apv[l_ac].apv02,-263,1)
             LET g_apv[l_ac].* = g_apv_t.*
          ELSE
             UPDATE apv_file SET apv02 = g_apv[i].apv02,
                                 apv03 = g_apv[i].apv03,
                                 apv04f= g_apv[i].apv04f,
                                 apv04 = g_apv[i].apv04,
                                 apv05 = g_apv[i].apv05      #No.FUN-680027
              WHERE apv01 = g_apa.apa01
                AND apv02 = g_apv_t.apv02
             IF STATUS OR SQLCA.SQLCODE THEN
#               CALL cl_err('upd apv:',SQLCA.SQLCODE,1)   #No.FUN-660122
                CALL cl_err3("upd","apv_file",g_apa.apa01,g_apv_t.apv02,SQLCA.sqlcode,"","upd apv:",1)  #No.FUN-660122
                LET g_success = 'N'
                LET g_apv[i].* = g_apv_t.*
                ELSE MESSAGE "update ok"
             END IF
             IF g_success = 'Y' AND g_apv[i].apv03 <> 'DIFF' THEN #No.MOD-580365
               #str MOD-8C0011 add
               #當修改了待抵編號,應將舊待抵編號的已沖金額扣回(參考刪除段),
               #                 再UPDATE新待抵編號的已沖金額
                IF g_apv_t.apv03 != g_apv[i].apv03 THEN
                   SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                     FROM aph_file,apf_file
                    WHERE aph04=g_apv_t.apv03 AND aph01=apf01 AND apf41='Y'
                      AND aph03 IN ('6','7','8','9')
                   IF g_amt1f IS NULL THEN
                      LET g_amt1f = 0
                      LET g_amt1 = 0
                   END IF
                   SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                     FROM apv_file Where apv03=g_apv_t.apv03
                   IF g_amt2f IS NULL THEN
                      LET g_amt2f = 0
                      LET g_amt2 = 0
                   END IF
                   SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                     FROM oob_file,ooa_file
                    WHERE oob01 = ooa01
                      AND oob06 = g_apv_t.apv03
                      AND oob03 = '2' AND oob04 = '9'
                      AND ooaconf = 'Y' #須為已確認
                   IF cl_null(g_amt3f) THEN
                      LET g_amt3f = 0
                      LET g_amt3 = 0
                   END IF
                   SELECT SUM(aqb04) INTO g_amt4 FROM aqa_file,aqb_file
                    WHERE aqa01 = aqb01 AND aqa04='Y' AND aqaconf = 'Y'
                      AND aqb02=g_apv_t.apv03
                   IF cl_null(g_amt4) THEN
                      LET g_amt4=0
                      LET g_amt4f=0
                   END IF
                   LET g_amt4f=g_amt4/g_apv[i].apa14

                   LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f
                   LET g_amt1 =g_amt1 +g_amt2 +g_amt3 +g_amt4

                   SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv_t.apv03
                   CALL t110_comp_oox(g_apv_t.apv03) RETURNING g_net
                   LET l_apa.apa73 = l_apa.apa34 - g_amt1 + g_net
                   UPDATE apa_file SET apa35f= g_amt1f,
                                       apa35 = g_amt1,
                                       apa73 = l_apa.apa73   #No.MOD-640537
                    WHERE apa01 = g_apv_t.apv03
                   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
                      CALL cl_err3("upd","apa_file",g_apv_t.apv03,"",STATUS,"","upd apa:",1)
                      LET g_success='N'
                   END IF
                   SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                     FROM aph_file,apf_file
                    WHERE aph04=g_apv_t.apv03 AND aph01=apf01 AND apf41='Y'
                      AND aph03 IN ('6','7','8','9')
                      AND aph17 = 1                           #No.TQC-6B0066
                   IF g_amt1f IS NULL THEN
                      LET g_amt1f = 0
                      LET g_amt1 = 0
                   END IF
 
                   SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                     FROM apv_file WHERE apv03=g_apv_t.apv03
                   IF g_amt2f IS NULL THEN
                      LET g_amt2f = 0
                      LET g_amt2 = 0
                   END IF
 
                   SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                     FROM oob_file,ooa_file
                    WHERE oob01 = ooa01
                      AND oob06 = g_apv_t.apv03
                      AND oob03 = '2' AND oob04 = '9'
                      AND ooaconf = 'Y' #須為已確認
                      AND oob19 = 1                           #No.TQC-6B0066
                   IF cl_null(g_amt3f) THEN
                      LET g_amt3f = 0
                      LET g_amt3 = 0
                   END IF

                   LET g_amt1f = g_amt1f + g_amt2f + g_amt3f + g_amt4f            #TQC-C70079 add g_amt4f 
                   LET g_amt1 = g_amt1 + g_amt2 + g_amt3 + g_amt4                 #TQC-C70079 add g_amt4 
                   SELECT * INTO l_apc.* FROM apc_file
                    WHERE apc01=g_apv_t.apv03 AND apc02 =1
                   CALL t110_comp_oox(g_apv_t.apv03) RETURNING g_net
                   LET l_apc.apc13 = l_apc.apc09 - g_amt1 + g_net
                   UPDATE apc_file set apc10=g_amt1f,
                                       apc11=g_amt1,
                                       apc13=l_apc.apc13
                    WHERE apc01 =g_apv_t.apv03
                      AND apc02 =1
                END IF
               #end MOD-8C0011 add

                SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa65f,g_apa.apa65
                  FROM apv_file WHERE apv01=g_apa.apa01
 
                IF cl_null(g_apa.apa65f) THEN
                   LET g_apa.apa65f = 0
                END IF
 
                IF cl_null(g_apa.apa65 ) THEN
                   LET g_apa.apa65 = 0
                END IF
 
                DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
 
                UPDATE apa_file SET apa65f=g_apa.apa65f,apa65=g_apa.apa65
                 WHERE apa01 = g_apa.apa01
                #IF STATUS OR SQLCA.SQLCODE THEN   #MOD-730098
                IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
#                  CALL cl_err('upd apa1:',SQLCA.SQLCODE,1)   #No.FUN-660122
                   CALL cl_err3("upd","apa_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                   LET g_success='N'
                   IF p_cmd = 'u' THEN
                      LET g_apv[i].*=g_apv_t.*
                   END IF
#No.TQC-6B0066--begin 
                 #-----CHI-820015---------
                 #ELSE
                 #   UPDATE apc_file SET apc08=apc08-g_apv[i].apv04f+g_apv_t.apv04f,
                 #                       apc09=apc09-g_apv[i].apv04+g_apv_t.apv04,
                 #                       apc14=apc14+g_apv[i].apv04f-g_apv_t.apv04f,
                 #                       apc15=apc15+g_apv[i].apv04-g_apv_t.apv04
                 #    WHERE apc01 =g_apa.apa01
                 #      AND apc02 =g_apv[i].apv05
                 #     IF STATUS OR SQLCA.SQLCODE THEN
                 #        CALL cl_err3("upd","apcfile", g_apa.apa01,g_apv[i].apv05,SQLCA.sqlcode,"","",1)  
                 #        LET g_success='N'
                 #        IF p_cmd = 'u' THEN
                 #            LET g_apv[i].*=g_apv_t.*
                 #        END IF
                 #     END IF
                 #-----END CHI-820015-----
                 END IF
#No.TQC-6B0066--end
 
                SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                  FROM aph_file,apf_file
                 WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                   AND aph03 IN ('6','7','8','9')
 
                IF g_amt1f IS NULL THEN
                   LET g_amt1f = 0
                   LET g_amt1 = 0
                END IF
 
                SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                  FROM apv_file Where apv03=g_apv[i].apv03
 
                IF g_amt2f IS NULL THEN
                   LET g_amt2f = 0
                   LET g_amt2 = 0
                END IF
 
                SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                  FROM oob_file,ooa_file
                 WHERE oob01 = ooa01
                   AND oob06 = g_apv[i].apv03
                   AND oob03 = '2' AND oob04 = '9'
                   AND ooaconf = 'Y' #須為已確認
 
                IF cl_null(g_amt3f) THEN
                   LET g_amt3f = 0
                   LET g_amt3 = 0
                END IF

                #-----TQC-6C0044---------
                #成本分攤
                SELECT SUM(aqb04) INTO g_amt4 FROM aqa_file,aqb_file
                 WHERE aqa01 = aqb01 AND aqa04='Y' AND aqaconf = 'Y'
                   AND aqb02=g_apv[i].apv03
                IF cl_null(g_amt4) THEN
                   LET g_amt4=0
                   LET g_amt4f=0
                END IF
                LET g_amt4f=g_amt4/g_apv[i].apa14
 
                #LET g_amt1f=g_amt1f+g_amt2f+g_amt3f
                #LET g_amt1=g_amt1+g_amt2+g_amt3
                LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f
                LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4
                #-----END TQC-6C0044-----

                #No.MOD-580365  --begin
                #LET g_apa.apa72=g_apa.apa14
                #LET g_apa.apa73=g_apa.apa34-g_apa.apa35
                SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
                #No.MOD-590312  --begin
                CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
                #No.MOD-640537  --Begin
                #SELECT apa34 INTO m_apa34 FROM apa_file
                # WHERE apa01 = g_apv[i].apv03
                #LET g_apa.apa73 = m_apa34 - g_amt1 + g_net
                LET l_apa.apa73 = l_apa.apa34 - g_amt1 + g_net
                #No.MOD-640537  --End  
                #No.MOD-590312  --end
                #No.MOD-580365  --end
 
                UPDATE apa_file SET apa35f= g_amt1f,
                                    apa35 = g_amt1,
                                    #apa72 = g_apa.apa72, #No.MOD-580365
                                    apa73 = l_apa.apa73   #No.MOD-640537
                 WHERE apa01 = g_apv[i].apv03
                 #-----MOD-730098---------
                 IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
                    CALL cl_err3("upd","apa_file",g_apv[i].apv03,"",STATUS,"","upd apa:",1)
                    LET g_success='N'
                    IF p_cmd = 'u' THEN
                       LET g_apv[i].*=g_apv_t.*
                    END IF
                 END IF
                 #-----END MOD-730098-----
#No.FUN-680027--begin
               SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                 FROM aph_file,apf_file
                WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                  AND aph03 IN ('6','7','8','9')
#                  AND aph17 = g_apv[i].apv05             #No.FUN-680027
                  AND aph17 = 1                           #No.TQC-6B0066
 
               IF g_amt1f IS NULL THEN
                  LET g_amt1f = 0
                  LET g_amt1 = 0
               END IF
 
               SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                 FROM apv_file Where apv03=g_apv[i].apv03
#                                AND aph04=g_apv[i].apv05   #No.FUN-680027
#                                AND apv05=g_apv[i].apv05   #No.TQC-6B0066
 
               IF g_amt2f IS NULL THEN
                  LET g_amt2f = 0
                  LET g_amt2 = 0
               END IF
 
               SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                 FROM oob_file,ooa_file
                WHERE oob01 = ooa01
                  AND oob06 = g_apv[i].apv03
                  AND oob03 = '2' AND oob04 = '9'
                  AND ooaconf = 'Y' #須為已確認
#                 AND oob19 = g_apv[i].apv05             #No.FUN-680027
                  AND oob19 = 1                          #No.TQC-6B0066
 
               IF cl_null(g_amt3f) THEN
                  LET g_amt3f = 0
                  LET g_amt3 = 0
               END IF
 
               LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f            #TQC-C70079  add   g_amt4f
               LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4                 #TQC-C70079  add   g_amt4
               SELECT * INTO l_apc.* FROM apc_file WHERE apc01=g_apv[i].apv03 AND apc02 =1          #No.TQC-6B0066
               CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
               LET l_apc.apc13 = l_apc.apc09 - g_amt1 + g_net
               UPDATE apc_file set apc10=g_amt1f,
                                   apc11=g_amt1,
                                   #apc14=apc10,    #No.TQC-7C0094   #CHI-820015
                                   #apc15=apc11,    #No.TQC-7C0094   #CHI-820015
                                   apc13=l_apc.apc13
                WHERE apc01 =g_apv[i].apv03
#                 AND apc02 =g_apv[i].apv05
                  AND apc02 =1                    #No.TQC-6B0066
#No.FUN-680027--end
#No.TQC-6B0066--begin
                IF cl_null(g_apv_t.apv04) THEN
                   LET g_apv_t.apv04 = 0
                END IF
                IF cl_null(g_apv[i].apv04) THEN
                   LET g_apv[i].apv04 =0
                END IF
                SELECT SUM(apv04),SUM(apv04f) INTO l_apv04,l_apv04f FROM apv_file
                 WHERE apv03 =g_apv[i].apv03
                FOR j=1 TO g_apv.getLength()
                    IF g_apv[j].apv03 =g_apv[i].apv03 THEN
                       LET g_apv[j].un_pay  =g_apv[j].apc09 -l_apv04
                    END IF
                END FOR
                
                IF cl_null(g_apv_t.apv04f) THEN
                   LET g_apv_t.apv04f = 0
                END IF
                IF cl_null(g_apv[i].apv04f) THEN
                   LET g_apv[i].apv04f =0
                END IF
                FOR j=1 TO g_apv.getLength()
                    IF g_apv[j].apv03 =g_apv[i].apv03 THEN
                       LET g_apv[j].un_payf =g_apv[j].apc08-l_apv04f
                    END IF
                END FOR
#No.TQC-6B0066--end
            END IF
          END IF

      AFTER ROW
          LET l_ac = ARR_CURR()
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             IF p_cmd = 'u' THEN
                LET g_apv[l_ac].* = g_apv_t.*
             END IF
             CLOSE t110_loc2_cr
             LET g_success = 'N'
             EXIT INPUT
          END IF
          CLOSE t110_loc2_cr

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
      #No.MOD-580365  --begin
     #計算匯差
     AFTER INPUT
        LET l_net = 0
#No.MOD-9B0150 --begin
#        FOR l_i = 1 TO g_apv.getLength()
#            IF cl_null(g_apv[l_i].apv03) THEN CONTINUE FOR END IF
#            IF g_apv[l_i].apv03 = 'DIFF' THEN CONTINUE FOR END IF
#            SELECT apa14 INTO l_apa14 FROM apa_file
#             WHERE apa01=g_apv[l_i].apv03
#            IF l_apa14 <> g_apv[l_i].apa14 THEN
#               #LET l_amt=g_apv[l_i].apv04f*(l_apa14-g_apv[l_i].apa14)
#               #-----MOD-760089---------
#               #LET l_amt=g_apv[l_i].apv04f*g_apa.apa14-g_apv[l_i].apv04
#              #LET l_amt=cl_digcut(g_apv[l_i].apv04f*g_apa.apa14,g_azi04) #MOD-990248
#              #          - g_apv[l_i].apv04 #MOD-990248
#               LET l_amt=cl_digcut((g_apv[l_i].apv04f*g_apa.apa14)-(g_apv[l_i].apv04f*g_apv[l_i].apa14),g_azi04)  #MOD-990248
#              #-----END MOD-760089-----
#               IF cl_null(l_amt) THEN LET l_amt=0 END IF
##-----CHI-820015---------還原TQC-6B0066修改的部份
###No.TQC-6B0066--begin
##               LET l_amt = cl_digcut(l_amt,g_azi04) 
##               UPDATE apc_file SET apc09=apc09-l_amt,
##                                   apc15=apc15+l_amt
##                WHERE apc01 =g_apa.apa01
##                  AND apc02 =g_apv[l_i].apv05
##               IF STATUS OR SQLCA.SQLCODE THEN
##                  CALL cl_err3("upd","apcfile", g_apa.apa01,g_apv[l_i].apv05,SQLCA.sqlcode,"","",1)  
##                  LET g_success='N'
##               END IF               
#              LET l_net = l_net + l_amt
#              LET l_net = cl_digcut(l_net,g_azi04)   #MOD-680029
##No.TQC-6B0066--end
##-----END CHI-820015-----
#            ELSE
#               IF g_apv[l_i].apa14 <> g_apa.apa14 THEN
#                  #LET l_amt=g_apv[l_i].apv04f*(g_apa.apa14-g_apv[l_i].apa14)
#                  #-----MOD-760089---------
#                  #LET l_amt=g_apv[l_i].apv04f*g_apa.apa14-g_apv[l_i].apv04
#                 #LET l_amt=cl_digcut(g_apv[l_i].apv04f*g_apa.apa14,g_azi04) #MOD-990248
#                 #          - g_apv[l_i].apv04 #MOD-990248
#                  LET l_amt=cl_digcut((g_apv[l_i].apv04f*g_apa.apa14)-(g_apv[l_i].apv04f*g_apv[l_i].apa14),g_azi04) #MOD-990248
#                 #-----END MOD-760089-----
#                  IF cl_null(l_amt) THEN LET l_amt=0 END IF
##-----CHI-820015---------還原TQC-6B0066修改的部份
###No.TQC-6B0066--begin
##                  LET l_amt = cl_digcut(l_amt,g_azi04) 
##                  UPDATE apc_file SET apc09=apc09-l_amt,
##                                      apc15=apc15+l_amt
##                   WHERE apc01 =g_apa.apa01
##                     AND apc02 =g_apv[l_i].apv05
##                  IF STATUS OR SQLCA.SQLCODE THEN
##                     CALL cl_err3("upd","apcfile", g_apa.apa01,g_apv[l_i].apv05,SQLCA.sqlcode,"","",1)  
##                     LET g_success='N'
##                  END IF               
#                 LET l_net = l_net + l_amt
#                 LET l_net = cl_digcut(l_net,g_azi04)   #MOD-680029
##No.TQC-6B0066--end
##-----END CHI-820015-----
#               END IF
#            END IF
#        END FOR
#No.MOD-9B0150 --end
       #CHI-A30035---mark---start---
       #DELETE FROM apv_file
       # WHERE apv01=g_apa.apa01
       #   AND apv03='DIFF'
       #IF SQLCA.sqlcode THEN
#      #   CALL cl_Err('delete diff',SQLCA.sqlcode,1)  #No.FUN-660122
       #   CALL cl_err3("del","apv_file", g_apa.apa01,"",SQLCA.sqlcode,"","delete diff",1)  #No.FUN-660122
       #   NEXT FIELD apv04
       #END IF
       #CHI-A30035---mark---end---
        #-----CHI-840021---------
        LET l_cnt = 0
        SELECT COUNT(*) INTO l_cnt FROM apv_file
          WHERE apv01=g_apa.apa01
        IF l_cnt > 0 THEN
           SELECT SUM(apv04f),SUM(apv04) INTO apv04f_sum,apv04_sum FROM apv_file
             WHERE apv01 = g_apa.apa01
           IF cl_null(apv04f_sum) THEN LET apv04f_sum = 0 END IF
           IF cl_null(apv04_sum) THEN LET apv04_sum = 0 END IF
#No.MOD-9B0150 --begin
#           IF apv04f_sum = g_apa.apa31f THEN
#              LET l_net = g_apa.apa31-apv04_sum
#           END IF 
           IF apv04f_sum = g_apa.apa34f THEN
              LET l_net = g_apa.apa34-apv04_sum
           END IF
#No.MOD-9B0150 --end
        END IF

        #-----END CHI-840021-----
       #-MOD-A80217-mark-
       #IF l_net <> 0 THEN
       #    SELECT MAX(apv02)+1 INTO l_apv02 FROM apv_file
       #     WHERE apv01 = g_apa.apa01
       #    IF cl_null(l_apv02)  THEN
       #       LET l_apv02 = 1
       #    END IF
       #    INSERT INTO apv_file(apv01,apv02,apv03,apv04f,apv04)
       #    VALUES(g_apa.apa01,l_apv02,'DIFF',0,l_net)
       #    IF SQLCA.sqlcode THEN
#      #       CALL cl_err('insert diff',SQLCA.sqlcode,1)   #No.FUN-660122
       #       CALL cl_err3("ins","apv_file",g_apa.apa01,l_apv02,SQLCA.sqlcode,"","insert diff",1)  #No.FUN-660122
       #       NEXT FIELD apv04
       #    END IF
       # END IF
       #-MOD-A80217-end-
      #No.MOD-580365  --end
  
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
 
   END INPUT

   IF INT_FLAG THEN
      LET g_success='N'
      LET INT_FLAG = 0
   END IF

   IF g_success = 'Y' THEN
      COMMIT WORK
      MESSAGE "Commit"
   ELSE
      ROLLBACK WORK
      MESSAGE "RollBack"
   END IF

   CALL t110_apv_diff()    #MOD-A80217
   SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa65f,g_apa.apa65
     FROM apv_file WHERE apv01=g_apa.apa01

   IF cl_null(g_apa.apa65f) THEN
      LET g_apa.apa65f = 0
   END IF

   IF cl_null(g_apa.apa65 ) THEN
      LET g_apa.apa65 = 0
   END IF

   DISPLAY BY NAME g_apa.apa65f,g_apa.apa65

   UPDATE apa_file SET apa65f=g_apa.apa65f,apa65=g_apa.apa65
    WHERE apa01 = g_apa.apa01

   #IF STATUS OR SQLCA.SQLCODE THEN   #MOD-730098
   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
#     CALL cl_err('upd apa65:',SQLCA.SQLCODE,1)   #No.FUN-660122
      CALL cl_err3("upd","apa_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apa65:",1)  #No.FUN-660122
      LET g_success='N'   #MOD-730098
   END IF

   CLOSE WINDOW t110_kkk_w

   DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
   CLOSE t110_loc_cr
   CLOSE t110_loc2_cr

   IF l_lock_sw = 'Y' THEN
      RETURN
   END IF

   CALL t110_apa34f('0')    #TQC-750140

   LET g_apa.apa72 = g_apa.apa14
   CALL t110_comp_oox(g_apa.apa01) RETURNING g_net       #CHI-890017 add
  #LET g_apa.apa73 = g_apa.apa34 - g_apa.apa35           #CHI-890017 mark
   LET g_apa.apa73 = g_apa.apa34 - g_apa.apa35 + g_net   #CHI-890017

   UPDATE apa_file set * = g_apa.* WHERE apa01 = g_apa.apa01
   #-----MOD-730098---------
   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
      CALL cl_err3("upd","apa_file", g_apa.apa01,"",STATUS,"","upd apa",1)
      LET g_success='N'
   END IF
   #-----END MOD-730098-----
#TQC-770027.....begin
   IF g_apa.apa31 <>g_apa_t.apa31 OR g_apa.apa32 <> g_apa_t.apa32
      OR g_apa.apa34 <> g_apa_t.apa34 OR g_apa.apa57 <> g_apa_t.apa57
      OR g_apa.apa57 <> g_apa_t.apa57 OR g_apa.apa73 <> g_apa_t.apa73
      OR g_apa.apa31f <> g_apa_t.apa31f OR g_apa.apa32f <> g_apa_t.apa32f
      OR g_apa.apa34f <> g_apa_t.apa34f OR g_apa.apa57f <> g_apa_t.apa57f THEN
     SELECT DISTINCT(pmb02) INTO l_pmb02 FROM pmb_file
      WHERE pmb01 = g_apa.apa11
     #IF l_pmb02 = 1 THEN   #MOD-810156
     IF l_pmb02 = 1 OR cl_null(l_pmb02) THEN   #MOD-810156
        DELETE FROM apc_file WHERE apc01 = g_apa.apa01
        CALL t110_ins_apc(g_apa.*)
     ELSE
        IF g_apa.apa35 <> g_apa_t.apa35 OR g_apa.apa35f <> g_apa_t.apa35f THEN
           LET g_sn = 'y'
        END IF
        CALL t110_account_period()
        LET g_sn = 'n'
     END IF
    END IF
#TQC-770027.....end

   CALL t110_up_gl()
   CALL t110_unpay()

#  DELETE FROM apv_file WHERE apv01 = g_apa.apa01 AND apv04 = 0
   DELETE FROM apv_file WHERE apv01 = g_apa.apa01 AND apv04 = 0 AND apv04f =0   #No.TQC-950113

   CALL t110_diff_rtn('0') ##TQC-750140
   CALL t110_api_diff()    #No.TQC-7B0083

END FUNCTION

#-MOD-A80217-add-
FUNCTION t110_apv_diff()
   DEFINE l_net            LIKE apv_file.apv04
   DEFINE l_i              LIKE type_file.num5    
   DEFINE l_j              LIKE type_file.num5    
   DEFINE l_apa14          LIKE apa_file.apa14
   DEFINE l_amt            LIKE type_file.num20_6  
   DEFINE l_cnt            LIKE type_file.num5    
   DEFINE l_apv02          LIKE apv_file.apv02
   DEFINE l_apv03          LIKE apv_file.apv03
   DEFINE l_apv04f         LIKE apv_file.apv04f
   DEFINE l_apv04          LIKE apv_file.apv04
   DEFINE l_apv04f_sum     LIKE apv_file.apv04f   
   DEFINE l_apv04_sum      LIKE apv_file.apv04  
   DEFINE l_sql            STRING      

   LET l_net = 0
   LET  l_sql = "SELECT apv03,apv04f,apv04 ",     
                "  FROM apv_file",                                 
                " WHERE apv01 = '",g_apa.apa01,"' ",
                "   AND apv03 <> 'DIFF'" 
   PREPARE t110_apv_p FROM l_sql
   DECLARE t110_apv_c CURSOR FOR t110_apv_p
   FOREACH t110_apv_c INTO l_apv03,l_apv04f,l_apv04     #計算部分沖帳(與立帳原幣金額不同)時的匯差
       SELECT apa14 INTO l_apa14 FROM apa_file
        WHERE apa01=l_apv03
       IF l_apa14 <> g_apa.apa14 THEN
          LET l_amt=cl_digcut(l_apv04f*g_apa.apa14,g_azi04)-l_apv04
          IF cl_null(l_amt) THEN LET l_amt=0 END IF
          LET l_net = l_net + l_amt
          LET l_net = cl_digcut(l_net,g_azi04)
       END IF
   END FOREACH
   LET l_cnt = 0
   SELECT COUNT(*) INTO l_cnt FROM apv_file WHERE apv01=g_apa.apa01
   IF l_cnt > 0 THEN
      SELECT SUM(apv04f),SUM(apv04) INTO l_apv04f_sum,l_apv04_sum
        FROM apv_file WHERE apv01 = g_apa.apa01
      IF cl_null(l_apv04f_sum) THEN LET l_apv04f_sum = 0 END IF
      IF cl_null(l_apv04_sum)  THEN LET l_apv04_sum = 0 END IF
      IF l_apv04f_sum = g_apa.apa31f THEN               #計算全額沖帳(與立帳原幣金額相同)時的匯差
         LET l_net = g_apa.apa31-l_apv04_sum
      END IF
     #str MOD-B70180 add
      IF l_apv04f_sum = g_apa.apa31f+g_apa.apa32f THEN  #計算含稅全額沖帳(與立帳原幣金額相同)時的匯差
         LET l_net = (g_apa.apa31+g_apa.apa32)-l_apv04_sum
      END IF
     #end MOD-B70180 add
   END IF
   IF l_net <> 0 THEN
      DELETE FROM apv_file WHERE apv01=g_apa.apa01 AND apv03='DIFF'  #無論是否有資料一律刪除,不用提示錯誤
      SELECT MAX(apv02)+1 INTO l_apv02 FROM apv_file
       WHERE apv01 = g_apa.apa01
      IF cl_null(l_apv02)  THEN
         LET l_apv02 = 1
      END IF
      INSERT INTO apv_file (apv01,apv02,apv03,apv04f,apv04)          
                    VALUES (g_apa.apa01,l_apv02,'DIFF',0,l_net)  
      IF SQLCA.sqlcode THEN
         CALL cl_err3("ins","apv_file",g_apa.apa01,l_apv02,SQLCA.sqlcode,"","insert diff",1)
      END IF
      SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa65f,g_apa.apa65
        FROM apv_file WHERE apv01=g_apa.apa01
      IF cl_null(g_apa.apa65f) THEN
         LET g_apa.apa65f = 0
      END IF
      IF cl_null(g_apa.apa65 ) THEN
         LET g_apa.apa65 = 0
      END IF
      DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
   END IF
END FUNCTION
#-MOD-A80217-end-

#FUN-580012  --begin
FUNCTION t110_k2()
   DEFINE l_totf,l_amtf   LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_tot,l_amt     LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_apv04       LIKE apv_file.apv04  #FUN-4B0079
   DEFINE cnt1,cnt2     LIKE type_file.num5      # No:FUN-690028 SMALLINT
   DEFINE i,j,k          LIKE type_file.num5    #No.FUN-690028 SMALLINT
   #DEFINE l_sql      LIKE type_file.chr1000 #No.FUN-690028 VARCHAR(600)   #MOD-720062
   DEFINE l_sql     STRING   #MOD-720062
   DEFINE p_cmd     LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE g_apv     DYNAMIC ARRAY OF RECORD
                    apv02     LIKE apv_file.apv02,
                    apv03     LIKE apv_file.apv03,
                    apa07     LIKE apa_file.apa07,
                    apv05     LIKE apv_file.apv05,         #No.FUN-680027
                    apa08     LIKE apa_file.apa08,
                    apa14     LIKE apa_file.apa14,
#No.FUN-680027--begin
#                   apa34f_b  LIKE apa_file.apa34,
#                   apa34_b   LIKE apa_file.apa34,
                    apc08     LIKE apc_file.apc08,
                    apc09     LIKE apc_file.apc09,
#No.FUN-680027--end
                    un_payf   LIKE apv_file.apv04,
                    un_pay    LIKE apv_file.apv04,
                    apv04f    LIKE apv_file.apv04,
                    apv04     LIKE apv_file.apv04
                    END RECORD
   DEFINE g_apv_t   RECORD
                    apv02     LIKE apv_file.apv02,
                    apv03     LIKE apv_file.apv03,
                    apa07     LIKE apa_file.apa07,
                    apv05     LIKE apv_file.apv05,         #No.FUN-680027
                    apa08     LIKE apa_file.apa08,
                    apa14     LIKE apa_file.apa14,
#No.FUN-680027--begin
#                   apa34f_b  LIKE apa_file.apa34,
#                   apa34_b   LIKE apa_file.apa34,
                    apc08     LIKE apc_file.apc08,
                    apc09     LIKE apc_file.apc09,
#No.FUN-680027--end
                    un_payf   LIKE apv_file.apv04,
                    un_pay    LIKE apv_file.apv04,
                    apv04f    LIKE apv_file.apv04,
                    apv04     LIKE apv_file.apv04
                    END RECORD
   #No.MOD-580365  --begin
   DEFINE m_apa     DYNAMIC ARRAY OF RECORD
                    apa13     LIKE apa_file.apa13,
                    apa72     LIKE apa_file.apa72,
                    apa73     LIKE apa_file.apa73
                    END RECORD
   DEFINE m_apa_t   RECORD
                    apa13     LIKE apa_file.apa13,
                    apa72     LIKE apa_file.apa72,
                    apa73     LIKE apa_file.apa73
                    END RECORD
   DEFINE m_apa34f  LIKE apa_file.apa34f
   DEFINE m_apa34   LIKE apa_file.apa34    #No.MOD-590312
   DEFINE m_apa73   LIKE apa_file.apa73
   DEFINE m_amt     LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)
   DEFINE l_apa     RECORD LIKE apa_file.*
   DEFINE l_net     LIKE apv_file.apv04
   DEFINE l_apa14   LIKE apa_file.apa14
   DEFINE l_apv02   LIKE apv_file.apv02
   DEFINE l_i       LIKE type_file.num5    #No.FUN-690028 SMALLINT
   #No.MOD-580365  --end
   DEFINE l_apa13   LIKE apa_file.apa13
   DEFINE l_apa41   LIKE apa_file.apa41
   DEFINE l_apv04f  LIKE apv_file.apv04f
   DEFINE l_apa35f,l_apa35 LIKE apa_file.apa35
   DEFINE l_difff,l_diff   LIKE apa_file.apa34
   DEFINE l_sumf,l_sum     LIKE apa_file.apa34
   DEFINE l_sumf_h,l_sum_h LIKE apa_file.apa34
   DEFINE l_total   LIKE apa_file.apa34
   DEFINE l_lock_sw       LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_modify_flag   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_k,l_over      LIKE type_file.num5,      # No:FUN-690028 SMALLINT,
   g_t1            LIKE oay_file.oayslip,  #No.FUN-690028 VARCHAR(5)
   l_allow_insert  LIKE type_file.num5,                #可新增否  #No.FUN-690028 SMALLINT
   l_allow_delete  LIKE type_file.num5                 #可刪除否  #No.FUN-690028 SMALLINT
   DEFINE ls_rec_b        LIKE type_file.num10      # No:FUN-690028 INTEGER
   DEFINE l_apa06  LIKE apa_file.apa06   #MOD-580079
#No.FUN-680027--begin
   DEFINE l_apc     RECORD LIKE apc_file.*   #No.FUN-680027
   DEFINE m_apc09   LIKE apc_file.apc09    #No.FUN-680027
   DEFINE l_apc02  LIKE apc_file.apc02  
   DEFINE l_apc10  LIKE apc_file.apc10  
   DEFINE l_apc11  LIKE apc_file.apc11  
#No.FUN-680027--end

    SELECT * INTO g_apa.* FROM apa_file
     WHERE apa01=g_apa.apa01

   LET g_t1 = s_get_doc_no(g_apa.apa01)
   SELECT apydmy6 INTO g_apy.apydmy6 FROM apy_file WHERE apyslip = g_t1
   IF g_aza.aza26 != '2' OR g_aptype[1,1]!='2' OR g_apy.apydmy6!='Y' THEN
      RETURN
   END IF
   IF g_apa.apa41 = 'Y' THEN
      CALL cl_err(g_apa.apa01,'aap-005',0)
      RETURN
   END IF
   #IF g_apa.apa63 MATCHES '[Ss1]' THEN      #FUN-540045 #FUN-550042#FUN-8A0075
   IF g_apa.apa63 MATCHES '[1]' THEN      #FUN-8A0075
      CALL cl_err('','mfg3557',0)
      RETURN
   END IF

   LET g_success='Y'
   LET g_apa_t.* = g_apa.*
   BEGIN WORK
   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa_rowid
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl k:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF
   FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
       CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
       CLOSE t110_cl
       ROLLBACK WORK
       RETURN
   END IF

   OPEN WINDOW t110_kkk_w WITH FORM "aap/42f/aapt110_e"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
   CALL cl_ui_locale("aapt110_e")

   CALL cl_getmsg('aap-909',g_lang) RETURNING g_msg
   CALL cl_set_comp_att_text("apv03",g_msg CLIPPED)
   CALL cl_getmsg('aap-910',g_lang) RETURNING g_msg
   CALL cl_set_comp_att_text("apv04f",g_msg CLIPPED)
   CALL cl_getmsg('aap-911',g_lang) RETURNING g_msg
   CALL cl_set_comp_att_text("apv04",g_msg CLIPPED)
 
   SELECT COUNT(*) INTO cnt1 FROM apv_file WHERE apv01 = g_apa.apa01

   IF cnt1 = 0 THEN   
      #No.MOD-5B0053 --start--
      LET  l_sql = "SELECT apc01,apc02,apa07,apa08,apc06, ",          #No.TQC-6B0066
                   "       apc08,(apc08-apc10),0, ",                  #No.FUN-680027
                   "       apc09,(apc09-apc11),0,apa13,apc07,apc13 ", #No.FUN-680027
                   "  FROM apa_file,apc_file",                        #No,FUN-680027
                   " WHERE apa06= '",g_apa.apa06,"' AND apa07= '",g_apa.apa07,"' ",
                   "   AND apa00 LIKE '1%' ",
                   "   AND apa13 = '",g_apa.apa13,"' ",       # 幣別必須相同
                   "   AND apa08 != '",g_apa.apa01,"' ",      # 不可衝自已產生的預付
                   "   AND apa41 = 'Y' AND apa42 != 'Y' ",
                   "   AND (apa58 = '2' OR apa58 ='3' OR apa58 IS NULL) ",
                   "   AND apc01 =apa01"
      IF g_apz.apz27 = 'N' THEN
         LET l_sql = l_sql CLIPPED, " AND apa34 > apa35 "
      ELSE
         LET l_sql = l_sql CLIPPED, " AND apa73 > 0 "
      END IF
      PREPARE t110_p2_c0 FROM l_sql
      DECLARE t110_k2_c0 CURSOR FOR t110_p2_c0
      #No.MOD-5B0053 --end--

      CALL g_apv.clear()
      LET i = 1

      FOREACH t110_k2_c0 INTO g_apv[i].apv03,g_apv[i].apv05,g_apv[i].apa07,g_apv[i].apa08,     #No.TQC-6B0066
                              g_apv[i].apa14,g_apv[i].apc08,    #No.FUN-680027
                              g_apv[i].un_payf,g_apv[i].apv04f,
                              g_apv[i].apc09,g_apv[i].un_pay,g_apv[i].apv04,    #No.FUN-680027
                              #No.MOD-580365  --begin
                              m_apa[i].apa13,m_apa[i].apa72,m_apa[i].apa73
                              #No.MOD-580365  --end

         #No.MOD-580365  --begin
         IF g_apz.apz27 = 'Y' AND m_apa[i].apa13 !=g_aza.aza17 THEN
             LET g_apv[i].un_pay = m_apa[i].apa73
             LET g_apv[i].apa14  = m_apa[i].apa72
         END IF
         #No.MOD-580365  --end
         IF cl_null(g_apv[i].apv03) THEN
            EXIT FOREACH
         END IF

         LET g_apv[i].apv02 = i

         INSERT INTO apv_file(apv01,apv02,apv03,apv04f,apv04,apv05)     #No.FUN-680027
           VALUES (g_apa.apa01,i,g_apv[i].apv03,0,0,g_apv[i].apv05)     #No.FUN-680027
 
         LET i = i + 1
         IF i > g_max_rec THEN     #No:MOD-480131
            EXIT FOREACH
         END IF
      END FOREACH
      CALL g_apv.deleteElement(i)
      LET ls_rec_b = i - 1
   END IF

   IF cnt1 > 0 THEN
      DECLARE t110_k2_c CURSOR FOR
         SELECT apv02,apv03,apa07,apv05,apa08,apc06,   #No.FUN-680027       TQC-6B0066
            apc08+apv04f,apc09+apv04,(apc08+apv04f-apc10),(apc09+apv04-apc11 ),apv04f,apv04  #No.FUN-680027
            apa13,apc07,apc13  #No.MOD-580365
           FROM apv_file, OUTER apa_file,OUTER apc_file  #No.FUN-680027
          WHERE apv01 = g_apa.apa01 AND apv03 = apa_file.apa01 AND apa01 =apc01
          ORDER BY apv02

      CALL g_apv.clear()
      LET k = 1
      LET g_apa.apa35f = 0
      LET g_apa.apa35 = 0

      FOREACH t110_k2_c INTO g_apv[k].*,m_apa[k].* #No.MOD-580365
         LET g_apa.apa35f = g_apa.apa35f + g_apv[k].apv04f
         LET g_apa.apa35  = g_apa.apa35  + g_apv[k].apv04
         LET k = k + 1
          IF k > g_max_rec THEN         #No:MOD-480131
            EXIT FOREACH
         END IF
      END FOREACH
      CALL g_apv.deleteElement(k)
      LET ls_rec_b = k - 1
   END IF

   LET l_sumf_h = g_apa.apa35f
   LET l_sum_h  = g_apa.apa35
   DISPLAY l_sumf_h TO apa65f
   DISPLAY l_sum_h  TO apa65

   LET l_allow_insert = cl_detail_input_auth("insert")
   LET l_allow_delete = cl_detail_input_auth("delete")

   LET i = 1
   INPUT ARRAY g_apv WITHOUT DEFAULTS FROM s_apv.*
         ATTRIBUTE(COUNT=ls_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                   INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)

      BEFORE INSERT
         LET i = ARR_CURR()
         LET p_cmd='a'
         INITIALIZE g_apv[i].* TO NULL
         LET g_apv_t.* = g_apv[i].*
         NEXT FIELD apv02
 
      AFTER INSERT
         IF INT_FLAG THEN
            CALL cl_err('',9001,0)
            LET INT_FLAG = 0
            CANCEL INSERT
         END IF
         IF g_apv[i].apv03 IS NULL THEN
            CALL g_apv.deleteElement(i)
            NEXT FIELD apv02
            CANCEL INSERT
         END IF
         INSERT INTO apv_file(apv01,apv02,apv03,apv04f,apv04,apv05)     #No.FUN-680027
          VALUES(g_apa.apa01,g_apv[i].apv02,g_apv[i].apv03,
                 g_apv[i].apv04f,g_apv[i].apv04,g_apv[i].apv05)         #No.FUN-680027
         IF SQLCA.sqlcode THEN
#           CALL cl_err('ins apv:',SQLCA.SQLCODE,1)   #No.FUN-660122
            CALL cl_err3("ins","apv_file",g_apa.apa01,g_apv[i].apv02,SQLCA.sqlcode,"","ins apv:",1)  #No.FUN-660122
            LET g_success = 'N'
            CANCEL INSERT
         ELSE
            LET ls_rec_b = ls_rec_b + 1
            MESSAGE "insert ok"
            IF g_success = 'Y' THEN
               SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa35f,g_apa.apa35
                 FROM apv_file WHERE apv01=g_apa.apa01
 
               IF cl_null(g_apa.apa35f) THEN
                  LET g_apa.apa35f = 0
               END IF
 
               IF cl_null(g_apa.apa35 ) THEN
                  LET g_apa.apa35 = 0
               END IF
 
             # DISPLAY BY NAME g_apa.apa35f,g_apa.apa35
               DISPLAY g_apa.apa35f TO apa65f
               DISPLAY g_apa.apa35  TO apa65
 
               CALL t110_comp_oox(g_apa.apa01) RETURNING g_net      #CHI-890017 add
               UPDATE apa_file SET apa35f=g_apa.apa35f,
                                   apa35 =g_apa.apa35
                                  ,apa73 =apa34-g_apa.apa35+g_net   #CHI-890017 add
                WHERE apa01 = g_apa.apa01
               #IF STATUS OR SQLCA.SQLCODE THEN   #MOD-730098
               IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
#                 CALL cl_err('upd apa1:',SQLCA.SQLCODE,1)   #No.FUN-660122
                  CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                  LET g_success='N'
                  IF p_cmd = 'u' THEN
                     LET g_apv[i].*=g_apv_t.*
                  END IF
#No.TQC-6B0066--begin 
               ELSE
#No.FUN-680027--begin              
                  CALL t110_comp_oox1(g_apv[i].apv03,g_apv[i].apv05) RETURNING g_net    #MOD-940090     
                  UPDATE apc_file SET apc08=apc08-g_apv[i].apv04f,
                                      apc09=apc09-g_apv[i].apv04,
                                      apc13=apc09-g_apv[i].apv04-apc11+g_net,        #MOD-940090
                                      apc14=apc14+g_apv[i].apv04f,
                                      apc15=apc15+g_apv[i].apv04
                   WHERE apc01 =g_apv[i].apv03
                     AND apc02 =g_apv[i].apv05                   
                     
                    IF STATUS OR SQLCA.SQLCODE THEN 
                       CALL cl_err3("upd","apcfile", g_apa.apa01,g_apv[i].apv05,SQLCA.sqlcode,"","",1)  
                       LET g_success='N'
                       IF p_cmd = 'u' THEN
                          LET g_apv[i].*=g_apv_t.*
                       END IF
                    END IF
               END IF
#No.FUN-680027--begin
#             DECLARE t110_apc_cs3 CURSOR FOR
#               SELECT apc02,apc10,apc11 FROM apc_file WHERE apc01 =g_apa.apa01 ORDER BY apc02
#
#             SELECT count(*) g_cnt FROM apc_file 
#              WHERE apc01 = g_apa.apa01
#             IF g_cnt >0 THEN
#                LET l_apa35  =g_apa.apa35
#                LET l_apa35f =g_apa.apa35f
#                FOREACH t110_apc_cs3 INTO l_apc02,l_apc10,l_apc11
#                    IF l_apc10 >=l_apa35f THEN
#                       LET l_apc10 = l_apc10 - l_apa35f
#                       LET l_apa35f = 0
#                    ELSE 
#                       LET l_apa35f = l_apa35f - l_apc10
#                       LET l_apc10 = 0
#                    END IF
#                    IF l_apc11 >=l_apa35f THEN
#                       LET l_apc11 = l_apc11 - l_apa35
#                       LET l_apa35 = 0
#                    ELSE 
#                       LET l_apa35 = l_apa35 - l_apc11
#                       LET l_apc11 = 0
#                    END IF
#                    UPDATE apc_file set apc10 =l_apc10,
#                                        apc11 =l_apc11
#                     WHERE apc01 = g_apa.apa01
#                       AND apc02 = l_apc02
#                    IF l_apa35 =0 OR l_apa35f = 0 THEN
#                       EXIT FOREACH
#                    END IF
#                END FOREACH
#             END IF
#No.TQC-6B0066--end
#No.FUN-680027--end
 
               SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                 FROM aph_file,apf_file
                WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                  AND aph03 IN ('6','7','8','9')
 
               IF g_amt1f IS NULL THEN
                  LET g_amt1f = 0
                  LET g_amt1 = 0
               END IF
 
               SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                 FROM apv_file Where apv03=g_apv[i].apv03
 
               IF g_amt2f IS NULL THEN
                  LET g_amt2f = 0
                  LET g_amt2 = 0
               END IF

               #-----MOD-820008---------
               SELECT SUM(apv04f),SUM(apv04) INTO g_amt5f,g_amt5
                 FROM apv_file Where apv01=g_apv[i].apv03

               IF g_amt5f IS NULL THEN
                  LET g_amt5f = 0
                  LET g_amt5 = 0
               END IF
               #-----END MOD-820008-----

               SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                 FROM oob_file,ooa_file
                WHERE oob01 = ooa01
                  AND oob06 = g_apv[i].apv03
                  AND oob03 = '2' AND oob04 = '9'
                  AND ooaconf = 'Y' #須為已確認
 
               IF cl_null(g_amt3f) THEN
                  LET g_amt3f = 0
                  LET g_amt3 = 0
               END IF
 
               #-----MOD-820008---------
               #LET g_amt1f=g_amt1f+g_amt2f+g_amt3f
               #LET g_amt1=g_amt1+g_amt2+g_amt3
               LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt5f
               LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt5
               #-----END MOD-820008-----
               #No.MOD-580365  --begin
               #LET g_apa.apa72=g_apa.apa14
               #LET g_apa.apa73=g_apa.apa34-g_apa.apa35

               SELECT * INTO l_apa.* FROM apa_file
                WHERE apa01 = g_apv[i].apv03
               LET l_apa.apa34 = l_apa.apa31 + l_apa.apa32 - g_amt1
               LET l_apa.apa34f= l_apa.apa31f+ l_apa.apa32f- g_amt1f
               #No.MOD-590312  --begin
               CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
               SELECT apa34 INTO m_apa34 FROM apa_file
                WHERE apa01 = g_apv[i].apv03
               LET g_apa.apa73 = m_apa34 - g_amt1 + g_net
               #No.MOD-590312  --end
               UPDATE apa_file SET apa65f= g_amt1f,
                                   apa65 = g_amt1,
                                   apa34 = l_apa.apa34,
                                   apa34f= l_apa.apa34f,
                 #                 apa72 = g_apa.apa72,
                                   apa73 = g_apa.apa73
                WHERE apa01 = g_apv[i].apv03
               #No.MOD-580365  --end
               #-----MOD-730098---------
               IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
                  CALL cl_err3("upd","apa_file",g_apv[i].apv03,"",STATUS,"","upd apa:",1)
                  LET g_success='N'
                  IF p_cmd = 'u' THEN
                     LET g_apv[i].*=g_apv_t.*
                  END IF
               END IF
               #-----END MOD-730098-----
#No.FUN-680027--begin
               SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                 FROM aph_file,apf_file
                WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                  AND aph03 IN ('6','7','8','9')
#                 AND aph17 = g_apv[i].apv05             #No.FUN-680027
                  AND aph17 = 1                          #No.TQC-6B0066 
               IF g_amt1f IS NULL THEN
                  LET g_amt1f = 0
                  LET g_amt1 = 0
               END IF
 
               SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                 FROM apv_file Where apv03=g_apv[i].apv03
#                                AND aph04=g_apv[i].apv05   #No.FUN-680027
                                 AND apv05=g_apv[i].apv05   #No.TQC-6B0066 
               IF g_amt2f IS NULL THEN
                  LET g_amt2f = 0
                  LET g_amt2 = 0
               END IF
 
               SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                 FROM oob_file,ooa_file
                WHERE oob01 = ooa01
                  AND oob06 = g_apv[i].apv03
                  AND oob03 = '2' AND oob04 = '9'
                  AND ooaconf = 'Y' #須為已確認
#                 AND oob19 = g_apv[i].apv05             #No.FUN-680027
                  AND oob19 = 1                          #No.TQC-6B0066
               IF cl_null(g_amt3f) THEN
                  LET g_amt3f = 0
                  LET g_amt3 = 0
               END IF
 
               LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f     #TQC-C70079  add   g_amt4f
               LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4          #TQC-C70079  add   g_amt4
               SELECT * INTO l_apc.* FROM apc_file WHERE apc01=g_apv[i].apv03 AND apc02 =1        #No.TQC-6B0066
               LET l_apc.apc09 = l_apc.apc09 - g_amt1
               LET l_apc.apc08 = l_apc.apc08 - g_amt1f
               CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
               SELECT apc09 INTO m_apc09 FROM apc_file
                WHERE apc01 = g_apv[i].apv03
#                 AND apc02 = g_apv[i].apv05
                  AND apc02 = 1                   #No.TQC-6B0066
               LET l_apc.apc13 = m_apc09 - g_amt1 + g_net
               UPDATE apc_file SET apc14 = g_amt1f,
                                   apc15 = g_amt1,
                                   apc09 = l_apc.apc09,
                                   apc08 = l_apc.apc08,
                                   apc13 = l_apc.apc13
                WHERE apc01 =g_apv[i].apv03
#                 AND apc02 =g_apv[i].apv05
                  AND apc02 =1                    #No.TQC-6B0066
#No.FUN-680027--end
 
            END IF
         END IF

      BEFORE INPUT
         IF ls_rec_b != 0 THEN
            CALL fgl_set_arr_curr(i)
         END IF
         LET g_before_input_done = FALSE
         CALL t110_set_entry_apv('a')
         CALL t110_set_no_entry_apv('a')
         LET g_before_input_done = TRUE

      BEFORE ROW
         LET p_cmd = ''
         LET i = ARR_CURR()
         LET l_lock_sw = 'N'
         IF ls_rec_b >= i THEN
            LET p_cmd='u'
            LET g_apv_t.* = g_apv[i].*
            # LET g_success = 'Y'              #No:MOD-510148
            #-->鎖住待抵沖帳資料
            #No.MOD-580365  --begin
            IF g_apv_t.apv03 <> 'DIFF' THEN
              #MOD-A30008---modify---start---
              #LET g_forupd_sql = "SELECT apa07,apa08,apc06,apc08,(apc08-apc10),",        #No.FUN-680027
              #                   "       apc09,(apc09-apc11),apa13,apc07,apc13",
#             #                   "  FROM apa_file,apc_file ",     #No.FUN-680027
              #                   "  FROM apa_file,apc_file ",      #No.MOD-780028
              #                   " WHERE apa01 =apc01 ",          #No.FUN-680027
              #                   "   AND apa01=? FOR UPDATE NOWAIT"      #No.FUN-680027
               LET g_forupd_sql = "SELECT '','',apc06,apc08,(apc08-apc10),",       
                                  "       apc09,(apc09-apc11),'',apc07,apc13",
                                  "  FROM apc_file ",     
                                  " WHERE apa01=? FOR UPDATE NOWAIT"      
              #MOD-A30008---modify---end---
               #No.MOD-580365  --end
               DECLARE t110_k2_cr CURSOR FROM g_forupd_sql

               OPEN t110_k2_cr USING g_apv_t.apv03
               IF STATUS THEN
                  CALL cl_err("OPEN t110_k2_cr:", STATUS, 1)
                  LET l_lock_sw = "Y"
               END IF

               FETCH t110_k2_cr INTO g_apv[i].apa07,g_apv[i].apa08,g_apv[i].apa14,
                                      g_apv[i].apc08,g_apv[i].un_payf,   #No.FUN-680027
                                      g_apv[i].apc09,g_apv[i].un_pay,   #No.FUN-680027
                                      m_apa[i].*  #No.MOD-580365
               IF SQLCA.sqlcode THEN
                  CALL cl_err(g_apv_t.apv02,SQLCA.sqlcode,1)
                  LET l_lock_sw = "Y"
              #MOD-A30008---add---start---
               ELSE
                  SELECT apa07,apa08,apa13 INTO g_apv[i].apa07,g_apv[i].apa08,m_apa[i].apa13
                  FROM apa_file
                  WHERE apa01=g_apv_t.apv03
              #MOD-A30008---add---end---
               END IF
               LET g_apv[i].apc08 = g_apv[i].apc08 + g_apv[i].apv04f      #No.FUN-680027
               LET g_apv[i].apc09 = g_apv[i].apc09 + g_apv[i].apv04       #No.FUN-680027
               LET g_apv[i].un_payf = g_apv[i].un_payf + g_apv[i].apv04f
               LET g_apv[i].un_pay  = g_apv[i].un_pay  + g_apv[i].apv04
            #No.MOD-580365  --begin
               IF g_apz.apz27 = 'Y' AND g_aza.aza17 ! = m_apa[i].apa13 THEN
                  LET g_apv[i].un_pay = g_apv[i].apv04 + m_apa[i].apa73
                  LET g_apv[i].apa14  = m_apa[i].apa72
               END IF
            END IF
            #No.MOD-580365  --end
            CALL cl_show_fld_cont()     #FUN-550037(smin)
         END IF
         CALL t110_set_entry_apv(p_cmd)
         CALL t110_set_no_entry_apv(p_cmd)

      BEFORE FIELD apv02
         IF cl_null(g_apv[i].apv02) OR g_apv[i].apv02 = 0 THEN
            SELECT MAX(apv02)+1 INTO g_apv[i].apv02 FROM apv_file
             WHERE apv01 = g_apa.apa01
            IF cl_null(g_apv[i].apv02)  THEN
               LET g_apv[i].apv02 = 1
            END IF
            LET g_apv[i].apv04f= 0
            LET g_apv[i].apv04 = 0
         END IF
          CALL t110_set_entry_apv(p_cmd)  #MOD-4A0288

      AFTER FIELD apv02
         IF g_apv_t.apv02 IS NULL OR
            g_apv_t.apv02 != g_apv[i].apv02 THEN
            SELECT COUNT(*) INTO k FROM apv_file
                WHERE apv01 = g_apa.apa01 AND apv02 = g_apv[i].apv02
            IF k > 0 THEN
               CALL cl_err('',-239,0)
               NEXT FIELD apv02
            END IF
         END IF
          CALL t110_set_no_entry_apv(p_cmd)  #MOD-4A0288


      AFTER FIELD apv03
         #No.MOD-580365  --begin
         #IF NOT cl_null(g_apv[i].apv03) THEN
         IF NOT cl_null(g_apv[i].apv03) AND g_apv[i].apv03 <> 'DIFF' THEN
            CALL t110_set_entry_apv('F')
         #No.MOD-580365  --end
#No.TQC-6B0066--begin(原先apv05表示待扺帳款的子帳期，所以把判斷移到apv05之后，
#                     現在apv05表示本單據的子帳期，因此判斷放回apv03)
           #MOD-A30008---modify---start---
           #LET g_forupd_sql = "SELECT apa07,apc12,apa13,apc06,apc08,",
           #                   "       (apc08-apc10),apc09,(apc09-apc11),",
           #                   #"       apa41,apa13,apc07,apc13 FROM apa_file",   #TQC-7C0039
           #                   "       apa41,apa13,apc07,apc13 FROM apa_file,apc_file",   #TQC-7C0039
           #                   " WHERE apa01 = ? AND apa00 LIKE '2%'",
           #                   "   AND (apa58='2' OR apa58='3' OR apa58 IS NULL)",
           #                   "   AND apc01=apa01 AND apc02 ='1'",
           #                   "   AND apa41 = 'Y' AND apa42 != 'Y' FOR UPDATE NOWAIT"
            LET g_forupd_sql = "SELECT '',apc12,'',apc06,apc08,",
                               "       (apc08-apc10),apc09,(apc09-apc11),",
                               "       '','',apc07,apc13 FROM apc_file",   
                               " WHERE apc01 = ? AND apc02='1' FOR UPDATE NOWAIT " 
           #MOD-A30008---modify---end---
            DECLARE t110_k22_cr CURSOR FROM g_forupd_sql

            OPEN t110_k22_cr USING g_apv[i].apv03
            IF STATUS THEN
               CALL cl_err("OPEN t110_k22_cr:", STATUS, 1)   #TQC-7C0039
               CLOSE t110_loc2_cr
               ROLLBACK WORK
               RETURN
            END IF

            FETCH t110_k22_cr INTO g_apv[i].apa07,g_apv[i].apa08,l_apa13,
                                    g_apv[i].apa14,g_apv[i].apc08,l_amtf,     #No.FUN-680027
                                    g_apv[i].apc09,l_amt,l_apa41,             #No.FUN-680027
                                    m_apa[i].apa13,m_apa[i].apa72,m_apa[i].apa73 #No.MOD-580365
            IF SQLCA.sqlcode THEN
               CALL cl_err(g_apv[i].apv03,SQLCA.sqlcode,0)
               LET g_apv[i].apv03 = g_apv_t.apv03
               CLOSE t110_k22_cr
               NEXT FIELD apv03
           #MOD-A30008---add---start---
            ELSE
               SELECT apa07,apa13,apa41,apa13 INTO g_apv[i].apa07,l_apa13,l_apa41,m_apa[i].apa13
               FROM apa_file
               WHERE apa01=g_apv[i].apv03 AND apa00 MATCHES '2*'
                 AND (apa58='2' OR apa58='3' OR apa58 IS NULL)
                 AND apa41 = 'Y' AND apa42 != 'Y' 
           #MOD-A30008---add---end---
            END IF
#No.TQC-6B0066--end

  
#No.FUN-680027--begin    mark的內容放在AFTER FIELD apv05
#           LET g_forupd_sql = "SELECT apa07,apa08,apa13,apa14,apa34f,",
#                              "       (apa34f-apa35f),apa34,(apa34-apa35),",
#                              #No.MOD-580365  --begin
#                              "       apa41,apa13,apa72,apa73 FROM apa_file",
#                              #No.MOD-580365  --end
#                              " WHERE apa01 = ? AND apa00 MATCHES '1*'",
#                              "   AND (apa58='2' OR apa58='3' OR apa58 IS NULL)",
#                              "   AND apa41 = 'Y' AND apa42 != 'Y' FOR UPDATE NOWAIT"
#           DECLARE t110_k22_cr CURSOR FROM g_forupd_sql

#           OPEN t110_k22_cr USING g_apv[i].apv03
#           IF STATUS THEN
#              CALL cl_err("OPEN t110_k22_cr:", STATUS, 1)
#              CLOSE t110_k22_cr
#              ROLLBACK WORK
#              RETURN
#           END IF

#           FETCH t110_k22_cr INTO g_apv[i].apa07,g_apv[i].apa08,l_apa13,
#                                   g_apv[i].apa14,g_apv[i].apa34f_b,l_amtf,
#                                   g_apv[i].apa34_b,l_amt,l_apa41,
#                                   #No.MOD-580365  --begin
#                                   m_apa[i].apa13,m_apa[i].apa72,m_apa[i].apa73
#                                   #No.MOD-580365  --end
#           IF SQLCA.sqlcode THEN
#              CALL cl_err(g_apv[i].apv03,SQLCA.sqlcode,0)
#              LET g_apv[i].apv03 = g_apv_t.apv03
#              CLOSE t110_k22_cr
#              NEXT FIELD apv03
#           END IF
##MOD-580079
            SELECT apa06 INTO l_apa06 FROM apa_file
               WHERE apa01= g_apv[i].apv03
            IF g_apa.apa06 <> l_apa06 THEN
               CALL cl_err('','aap-090',1)
            END IF
#No.TQC-6B0066--begin(apv05的含義改變，判斷仍放回原處)
            #-->此帳款尚未確認
            IF l_apa41 != 'Y' THEN
               CALL cl_err(g_apv[i].apv03,'aap-141',0)
               NEXT FIELD apv03
            END IF

            #-->不可沖不同幣別
            IF l_apa13 != g_apa.apa13 THEN
               CALL cl_err(g_apv[i].apv03,'aap-014',0)
               NEXT FIELD apv03
            END IF

            #-->無金額可沖帳
            IF l_amtf <=0 AND l_amt <=0 THEN
               CALL cl_err(g_apv[i].apv03,'aap-203',0)
               NEXT FIELD apv03
            END IF
            LET g_apv[i].un_payf= l_amtf
            LET g_apv[i].un_pay = l_amt
            #No.MOD-580365  --begin
            SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
            IF g_apz.apz27 = 'Y' AND g_aza.aza17 != m_apa[i].apa13 THEN
                LET g_apv[i].un_pay = m_apa[i].apa73
                LET g_apv[i].apa14  = m_apa[i].apa72
            END IF 
            #END MOD-580079
#No.TQC-6B0066--end
#           #-->此帳款尚未確認
#           IF l_apa41 != 'Y' THEN
#              CALL cl_err(g_apv[i].apv03,'aap-141',0)
#              NEXT FIELD apv03
#           END IF

#           #-->不可沖不同幣別
#           IF l_apa13 != g_apa.apa13 THEN
#              CALL cl_err(g_apv[i].apv03,'aap-014',0)
#              NEXT FIELD apv03
#           END IF

#           #-->無金額可沖帳
#           IF l_amtf <=0 AND l_amt <=0 THEN
#              CALL cl_err(g_apv[i].apv03,'aap-203',0)
#              NEXT FIELD apv03
#           END IF
#           LET g_apv[i].un_payf= l_amtf
#           LET g_apv[i].un_pay = l_amt
#           #No.MOD-580365  --begin
#           SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
#           IF g_apz.apz27 = 'Y' AND g_aza.aza17 != m_apa[i].apa13 THEN
#               LET g_apv[i].un_pay = m_apa[i].apa73
#               LET g_apv[i].apa14  = m_apa[i].apa72
#           END IF
#           #No.MOD-580365  --end
#No.FUN-680027--end
         END IF

      AFTER FIELD apv04f
         #No.MOD-580365  --begin
         IF NOT cl_null(g_apv[i].apv04f) THEN
               IF g_apv[i].apv04f < 0 THEN
               NEXT FIELD apv04f
            END IF
            LET l_apv04 = g_apv[i].apv04f * g_apv[i].apa14
            IF g_apv[i].apv03 <> 'DIFF' THEN
               LET g_apv[i].apv04 = l_apv04
            END IF
         END IF
         #原幣是否已經衝平，如果原幣已經衝平，則本幣也應衝平
         SELECT apa34f,apa73 INTO m_apa34f,m_apa73 FROM apa_file
         WHERE apa01 = g_apv[i].apv03
         SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
           FROM aph_file,apf_file
          WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
            AND aph03 IN ('6','7','8','9')
         IF g_amt1f IS NULL THEN
            LET g_amt1f = 0
            LET g_amt1 = 0
         END IF
 
         SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
           FROM apv_file Where apv03=g_apv[i].apv03
         IF g_amt2f IS NULL THEN
            LET g_amt2f = 0
            LET g_amt2 = 0
         END IF
 
         SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
           FROM oob_file,ooa_file
          WHERE oob01 = ooa01
            AND oob06 = g_apv[i].apv03
            AND oob03 = '2' AND oob04 = '9'
            AND ooaconf = 'Y' #須為已確認
         IF cl_null(g_amt3f) THEN
            LET g_amt3f = 0
            LET g_amt3 = 0
         END IF
         LET m_amt=g_amt1f+g_amt2f+g_amt3f
         IF p_cmd = 'a' THEN
            LET m_amt=m_amt+g_apv[i].apv04f
         ELSE
            LET m_amt=m_amt+g_apv[i].apv04f-g_apv_t.apv04f
         END IF
         IF m_amt = m_apa34f THEN
            #LET g_apv[i].apv04 = m_apa73
            LET g_apv[i].apv04 = g_apv[i].apc08*g_apv[i].apa14      #No.FUN-680027
         END IF
         #No.MOD-580365  --end
         LET g_apv[i].apv04f = cl_digcut(g_apv[i].apv04f,t_azi04) #MOD-750050
         LET g_apv[i].apv04 = cl_digcut(g_apv[i].apv04,g_azi04) #MOD-750050

      AFTER FIELD apv04
         IF NOT cl_null(g_apv[i].apv04) THEN
            #No.MOD-580365  --begin
            #IF g_apv[i].apv04 < 0 THEN
            #No.MOD-6A0073--begin-- add                                                                                             
            IF g_apv[i].apv04f >0  AND g_apv[i].apv04=0 THEN                                                                        
               NEXT FIELD apv04                                                                                                     
            END IF                                                                                                                  
            #-----MOD-750050---------
            #IF g_apv[i].apv04f * g_apv[i].apa14 != g_apv[i].apv04 THEN   
            IF cl_digcut(g_apv[i].apv04f * g_apv[i].apa14,g_azi04) != g_apv[i].apv04 THEN   
            #-----END MOD-750050-----
               IF NOT cl_confirm('aap-202') THEN                                                                                    
                  LET g_apv[i].apv04 = g_apv[i].apv04f*g_apv[i].apa14                                                               
                  LET l_apv04 = g_apv[i].apv04                                                                                      
                  NEXT FIELD apv04                                                                                                  
               END IF                                                                                                               
            END IF                                                                                                                  
            IF g_apv[i].apv04 != g_apv_t.apv04 THEN                                                                                 
               UPDATE apv_file SET apv04=g_apv[i].apv04                                                                             
                WHERE apv01 = g_apa.apa01                                                                                           
                  AND apv02 = g_apv_t.apv02                                                                                         
               IF SQLCA.sqlcode THEN                                                                                                
                  LET g_apv[i].apv04 = 0                                                                                            
                  NEXT FIELD apv04                                                                                                  
               END IF                                                                                                               
            END IF                                                                                                                  
            #No.MOD-6A0073--end-- add  
            IF g_apv[i].apv04 < 0 AND g_apv[i].apv03 <> 'DIFF' THEN
               NEXT FIELD apv04
            END IF

            IF g_apv[i].apv03 != 'DIFF' THEN
            #-->check 沖帳金額是否超過
              #不用控制本幣了，
              #因為有可能本幣會超過請款的金額，超過部分要確認匯兌損溢
            #No.MOD-580365  --end
               LET l_sum = 0
               LET l_sumf = 0
               LET l_over = 0
                FOR l_k =1 TO g_apv.getLength()   #No:MOD-480131
                  IF cl_null(g_apv[l_k].apv03) THEN
                     EXIT FOR
                  END IF
                  LET l_sumf= l_sumf+ g_apv[l_k].apv04f
                  LET l_sum = l_sum + g_apv[l_k].apv04
                  #No.MOD-580365  --begin
                  #IF l_sumf > g_apa.apa34f OR l_sum > g_apa.apa34 THEN
                  IF l_sumf > g_apa.apa34f THEN
                  #No.MOD-580365  --end
                     LET g_apv[i].apv04f= 0
                     LET g_apv[i].apv04 = 0
                     CALL cl_err(g_apa.apa34,'aap-913',0)
                     LET l_over = 1
                     EXIT FOR
                  END IF
               END FOR

               IF l_over=1 THEN
                  NEXT FIELD apv04f
               END IF

               #No.MOD-580365  --begin
               #SELECT (apa34f-apa35f),(apa34-apa35) INTO l_difff,l_diff
               SELECT (apa34f-apa35f),apa73 INTO l_difff,l_diff
                 FROM apa_file WHERE apa01 = g_apv[i].apv03
               #No.MOD-580365  --end

               IF cl_null(g_apv_t.apv04f) THEN
                  LET g_apv_t.apv04f = 0
                  LET g_apv_t.apv04 = 0
               END IF

               LET l_total = l_diff + g_apv_t.apv04

               IF  g_apv[i].apv04 > l_total THEN
                  LET g_apv[i].apv04f = 0
                  LET g_apv[i].apv04 = 0
                  CALL cl_err(g_apa.apa01,'aap-194',0)
                  LET l_over = 1
               END IF

               IF l_over=1 THEN
                  NEXT FIELD apv04f
               END IF
            END IF   #No.MOD-580365
         END IF
         LET g_apv[i].apv04 = cl_digcut(g_apv[i].apv04,g_azi04) #MOD-750050

#No.FUN-680027--begin
      AFTER FIELD apv05
          IF NOT cl_null(g_apv[i].apv05) THEN
#No.TQC-6B0066--begin(apv05的含義改變，判斷仍放回原處)
             IF g_apv_t.apv05 IS NULL OR g_apv[i].apv05 <> g_apv_t.apv05 THEN
                SELECT COUNT(*) INTO g_cnt FROM apc_file 
                 #WHERE apc01 =g_apa.apa01   #MOD-810111
                 WHERE apc01 =g_apv[i].apv03   #MOD-810111
                   AND apc02 =g_apv[i].apv05
                IF g_cnt =0 THEN
                  CALL cl_err('','aap-777',1)
                  NEXT FIELD apv05
                END IF
                SELECT COUNT(*) INTO g_cnt FROM apc_file 
                 #WHERE apc01 =g_apa.apa01    #MOD-810111 
                 WHERE apc01 =g_apv[i].apv03   #MOD-810111
                   AND apc02 =g_apv[i].apv05
                   AND apc08 >(apc10+apc14)
                IF g_cnt =0 THEN
                  CALL cl_err('','aap-778',1)
                  NEXT FIELD apv05
                END IF
#            LET g_forupd_sql = "SELECT apa07,apc12,apa13,apc06,apc08,",
#                               "       (apc08-apc10),apc09,(apc09-apc11),",
#                               "       apa41,apa13,apc07,apc13 FROM apa_file",
#                               " WHERE apa01 = ? AND apa00 LIKE '2%'",
#                               "   AND (apa58='2' OR apa58='3' OR apa58 IS NULL)",
#                               "   AND apc01=apa01 AND apc02 ='",g_apv[i].apv05,"'",
#                               "   AND apa41 = 'Y' AND apa42 != 'Y' FOR UPDATE NOWAIT"
#            DECLARE t110_k22_cr CURSOR FROM g_forupd_sql
#
#            OPEN t110_k22_cr USING g_apv[i].apv03
#            IF STATUS THEN
#               CALL cl_err("OPEN t110_loc2_cr:", STATUS, 1)
#               CLOSE t110_loc2_cr
#               ROLLBACK WORK
#               RETURN
#            END IF
#
#            FETCH t110_k22_cr INTO g_apv[i].apa07,g_apv[i].apa08,l_apa13,
#                                    g_apv[i].apa14,g_apv[i].apc08,l_amtf,     #No.FUN-680027
#                                    g_apv[i].apc09,l_amt,l_apa41,             #No.FUN-680027
#                                    m_apa[i].apa13,m_apa[i].apa72,m_apa[i].apa73 #No.MOD-580365
#            IF SQLCA.sqlcode THEN
#               CALL cl_err(g_apv[i].apv05,SQLCA.sqlcode,0)
#               LET g_apv[i].apv05 = g_apv_t.apv05
#               CLOSE t110_k22_cr
#               NEXT FIELD apv05
#            END IF
#            #-->此帳款尚未確認
#            IF l_apa41 != 'Y' THEN
#               CALL cl_err(g_apv[i].apv03,'aap-141',0)
#               NEXT FIELD apv05
#            END IF
#
#            #-->不可沖不同幣別
#            IF l_apa13 != g_apa.apa13 THEN
#               CALL cl_err(g_apv[i].apv03,'aap-014',0)
#               NEXT FIELD apv05
#            END IF
#
#            #-->無金額可沖帳
#            IF l_amtf <=0 AND l_amt <=0 THEN
#               CALL cl_err(g_apv[i].apv03,'aap-203',0)
#               NEXT FIELD apv05
#            END IF
#            LET g_apv[i].un_payf= l_amtf
#            LET g_apv[i].un_pay = l_amt
#            #No.MOD-580365  --begin
#            SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
#            IF g_apz.apz27 = 'Y' AND g_aza.aza17 != m_apa[i].apa13 THEN
#                LET g_apv[i].un_pay = m_apa[i].apa73
#                LET g_apv[i].apa14  = m_apa[i].apa72
#            END IF
#            #No.MOD-580365  --end
#No.TQC-6B0066--end
         END IF
         END IF
#No.FUN-680027--begin


      ON ACTION CONTROLP
           CASE
              WHEN INFIELD(apv03)
#                CALL q_apa2(FALSE,TRUE,' ','2') RETURNING g_apv[i].apv03,g_apv[i].apv05 #FUN-580012
#                 DISPLAY g_apv[i].apv03,g_apv[i].apv05 TO apv03,apv05                 #No:MOD-490344
                 #CALL q_apa2(FALSE,TRUE,' ','2') RETURNING g_apv[i].apv03              #No.TQC-6B0066   #MOD-820002
                 CALL q_apa2(FALSE,TRUE,' ','2',g_apa.apa06) RETURNING g_apv[i].apv03              #No.TQC-6B0066   #MOD-820002
                  DISPLAY g_apv[i].apv03 TO apv03                                      #No.TQC-6B0066  
                 NEXT FIELD apv03
              OTHERWISE EXIT CASE
           END CASE

         #MOD-4A0288
        BEFORE DELETE                            #是否取消單身
           IF g_apv[i].apv02 > 0 AND g_apv_t.apv02 IS NOT NULL THEN
              IF NOT cl_delb(0,0) THEN
                 CANCEL DELETE
              END IF
              DELETE FROM apv_file
               WHERE apv01 = g_apa.apa01 AND apv02 = g_apv_t.apv02
              IF SQLCA.sqlcode THEN
#                CALL cl_err(g_apv_t.apv02,SQLCA.sqlcode,0)   #No.FUN-660122
                 CALL cl_err3("del","apv_file",g_apa.apa01,g_apv_t.apv02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
                 CANCEL DELETE
              END IF
              LET ls_rec_b = ls_rec_b - 1
              MESSAGE "delete ok"
              IF g_success = 'Y' AND g_apv[i].apv03 <> 'DIFF' THEN   #No.MOD-580365
                 SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa35f,g_apa.apa35
                   FROM apv_file WHERE apv01=g_apa.apa01
                 IF cl_null(g_apa.apa35f) THEN LET g_apa.apa35f = 0 END IF
                 IF cl_null(g_apa.apa35 ) THEN LET g_apa.apa35 = 0 END IF
               # DISPLAY BY NAME g_apa.apa35f,g_apa.apa35
                 DISPLAY g_apa.apa35f TO apa65f
                 DISPLAY g_apa.apa35  TO apa65
                 CALL t110_comp_oox(g_apa.apa01) RETURNING g_net      #CHI-890017 add
                 UPDATE apa_file SET apa35f=g_apa.apa35f,
                                     apa35 =g_apa.apa35
                                    ,apa73 =apa34-g_apa.apa35+g_net   #CHI-890017 add
                  WHERE apa01 = g_apa.apa01
                 #IF STATUS OR SQLCA.SQLCODE THEN   #MOD-730098
                 IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
#                   CALL cl_err('upd apa1:',SQLCA.SQLCODE,1)   #No.FUN-660122
                    CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                    LET g_success='N'
#No.TQC-6B0066--begin 
                 ELSE
                 	  CALL t110_comp_oox1(g_apv[i].apv03,g_apv[i].apv05) RETURNING g_net  #MOD-940090                    
                    UPDATE apc_file SET apc08=apc08+g_apv[i].apv04f,
                                        apc09=apc09+g_apv[i].apv04,
                                        apc13=apc09+g_apv[i].apv04-apc11+g_net,         #MOD-940090
                                        apc14=apc14-g_apv[i].apv04f,
                                        apc15=apc15-g_apv[i].apv04
                     WHERE apc01 =g_apv[i].apv03
                       AND apc02 =g_apv[i].apv05                          
                      IF STATUS OR SQLCA.SQLCODE THEN
                         CALL cl_err3("upd","apcfile", g_apa.apa01,g_apv[i].apv05,SQLCA.sqlcode,"","",1)  
                         LET g_success='N'
                      END IF
                 END IF
#No.TQC-6B0066--end
                 
                 
                 SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                   FROM aph_file,apf_file
                  WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                    AND aph03 IN ('6','7','8','9')
                 IF g_amt1f IS NULL THEN
                    LET g_amt1f = 0
                    LET g_amt1 = 0
                 END IF
                 SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                   FROM apv_file Where apv03=g_apv[i].apv03
                 IF g_amt2f IS NULL THEN
                    LET g_amt2f = 0
                    LET g_amt2 = 0
                 END IF
                 #-----MOD-820008---------
                 SELECT SUM(apv04f),SUM(apv04) INTO g_amt5f,g_amt5
                   FROM apv_file Where apv01=g_apv[i].apv03

                 IF g_amt5f IS NULL THEN
                    LET g_amt5f = 0
                    LET g_amt5 = 0
                 END IF
                 #-----END MOD-820008-----
                 SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                   FROM oob_file,ooa_file
                  WHERE oob01 = ooa01
                    AND oob06 = g_apv[i].apv03
                    AND oob03 = '2' AND oob04 = '9'
                    AND ooaconf = 'Y' #須為已確認
                 IF cl_null(g_amt3f) THEN
                    LET g_amt3f = 0
                    LET g_amt3 = 0
                 END IF
                 #-----MOD-820008---------
                 #LET g_amt1f=g_amt1f+g_amt2f+g_amt3f
                 #LET g_amt1=g_amt1+g_amt2+g_amt3
                 LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt5f
                 LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt5
                 #-----END MOD-820008-----
                 #No.MOD-580365  --begin
                 #LET g_apa.apa72=g_apa.apa14
                 #LET g_apa.apa73=g_apa.apa34-g_apa.apa35
                 SELECT * INTO l_apa.* FROM apa_file
                  WHERE apa01 = g_apv[i].apv03
                 LET l_apa.apa34 = l_apa.apa31 + l_apa.apa32 - g_amt1
                 LET l_apa.apa34f= l_apa.apa31f+ l_apa.apa32f- g_amt1f
                 #No.MOD-590312  --begin
                 CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
                 SELECT apa34 INTO m_apa34 FROM apa_file
                 WHERE apa01 = g_apv[i].apv03
                 LET g_apa.apa73 = m_apa34 - g_amt1 + g_net
                 #No.MOD-590312  --end
                 #No.MOD-580365  --end
                 UPDATE apa_file SET apa65f= g_amt1f,
                                     apa65 = g_amt1,
                                     apa34 = l_apa.apa34,
                                     apa34f= l_apa.apa34f,
                                  #  apa72 = g_apa.apa72,
                                     apa73 = g_apa.apa73
                  WHERE apa01 = g_apv[i].apv03
                  #-----MOD-730098---------
                  IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
                     CALL cl_err3("upd","apa_file",g_apv[i].apv03,"",STATUS,"","upd apa",1)
                     LET g_success='N'
                  END IF
                  #-----END MOD-730098-----
              END IF
           END IF
           #--


      ON ROW CHANGE
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             LET g_apv[l_ac].* = g_apv_t.*
             CLOSE t110_k22_cr
             LET g_success = 'N'
             EXIT INPUT
          END IF
          IF l_lock_sw = 'Y' THEN
             CALL cl_err(g_apv[l_ac].apv02,-263,1)
             LET g_apv[l_ac].* = g_apv_t.*
          ELSE
             UPDATE apv_file SET apv02 = g_apv[i].apv02,
                                 apv03 = g_apv[i].apv03,
                                 apv04f= g_apv[i].apv04f,
                                 apv04 = g_apv[i].apv04,
                                 apv05 = g_apv[i].apv05      #No.FUN-680027
              WHERE apv01 = g_apa.apa01
                AND apv02 = g_apv_t.apv02
             IF STATUS OR SQLCA.SQLCODE THEN
#               CALL cl_err('upd apv:',SQLCA.SQLCODE,1)   #No.FUN-660122
                CALL cl_err3("upd","apv_file",g_apa.apa01,g_apv_t.apv02,SQLCA.sqlcode,"","upd apv:",1)  #No.FUN-660122
                LET g_success = 'N'
                LET g_apv[i].* = g_apv_t.*
                ELSE MESSAGE "update ok"
             END IF
             IF g_success = 'Y' AND g_apv[i].apv03 <> 'DIFF' THEN #No.MOD-580365
                SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa35f,g_apa.apa35
                  FROM apv_file WHERE apv01=g_apa.apa01
 
                IF cl_null(g_apa.apa35f) THEN
                   LET g_apa.apa35f = 0
                END IF
 
                IF cl_null(g_apa.apa35 ) THEN
                   LET g_apa.apa35 = 0
                END IF
 
              # DISPLAY BY NAME g_apa.apa35f,g_apa.apa35
 
                DISPLAY g_apa.apa35f TO apa65f
                DISPLAY g_apa.apa35  TO apa65
                CALL t110_comp_oox(g_apa.apa01) RETURNING g_net      #CHI-890017 add
                UPDATE apa_file SET apa35f=g_apa.apa35f,
                                    apa35 =g_apa.apa35
                                   ,apa73 =apa34-g_apa.apa35+g_net   #CHI-890017 add
                 WHERE apa01 = g_apa.apa01
                #IF STATUS OR SQLCA.SQLCODE THEN   #MOD-730098
                IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
#                  CALL cl_err('upd apa1:',SQLCA.SQLCODE,1)   #No.FUN-660122
                   CALL cl_err3("upd","apa_file",g_apa_t.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                   LET g_success='N'
                   IF p_cmd = 'u' THEN
                      LET g_apv[i].*=g_apv_t.*
                   END IF
#No.TQC-6B0066--begin 
                 ELSE
                 	  CALL t110_comp_oox1(g_apv[i].apv03,g_apv[i].apv05) RETURNING g_net  #MOD-940090
                    UPDATE apc_file SET apc08=apc08-g_apv[i].apv04f+g_apv_t.apv04f,
                                        apc09=apc09-g_apv[i].apv04+g_apv_t.apv04,
                                        apc13=apc09-g_apv[i].apv04+g_apv_t.apv04-apc11+g_net, #MOD-940090
                                        apc14=apc14+g_apv[i].apv04f-g_apv_t.apv04f,
                                        apc15=apc15+g_apv[i].apv04-g_apv_t.apv04
                     WHERE apc01 =g_apv[i].apv03
                       AND apc02 =g_apv[i].apv05                                 
                      IF STATUS OR SQLCA.SQLCODE THEN
                         CALL cl_err3("upd","apcfile", g_apa.apa01,g_apv[i].apv05,SQLCA.sqlcode,"","",1)  
                         LET g_success='N'
                         IF p_cmd = 'u' THEN
                             LET g_apv[i].*=g_apv_t.*
                         END IF
                      END IF
                 END IF
#No.TQC-6B0066--end
 
                SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                  FROM aph_file,apf_file
                 WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                   AND aph03 IN ('6','7','8','9')
 
                IF g_amt1f IS NULL THEN
                   LET g_amt1f = 0
                   LET g_amt1 = 0
                END IF
 
                SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                  FROM apv_file Where apv03=g_apv[i].apv03
 
                IF g_amt2f IS NULL THEN
                   LET g_amt2f = 0
                   LET g_amt2 = 0
                END IF

                #-----MOD-820008---------
                SELECT SUM(apv04f),SUM(apv04) INTO g_amt5f,g_amt5
                  FROM apv_file Where apv01=g_apv[i].apv03

                IF g_amt5f IS NULL THEN
                   LET g_amt5f = 0
                   LET g_amt5 = 0
                END IF
                #-----END MOD-820008-----
 
                SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                  FROM oob_file,ooa_file
                 WHERE oob01 = ooa01
                   AND oob06 = g_apv[i].apv03
                   AND oob03 = '2' AND oob04 = '9'
                   AND ooaconf = 'Y' #須為已確認
 
                IF cl_null(g_amt3f) THEN
                   LET g_amt3f = 0
                   LET g_amt3 = 0
                END IF

                #-----MOD-820008---------
                #LET g_amt1f=g_amt1f+g_amt2f+g_amt3f
                #LET g_amt1=g_amt1+g_amt2+g_amt3
                LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt5f
                LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt5
                #-----END MOD-820008-----
                #No.MOD-58036  --begin
                #LET g_apa.apa72=g_apa.apa14
                #LET g_apa.apa73=g_apa.apa34-g_apa.apa35
 
                 SELECT * INTO l_apa.* FROM apa_file
                  WHERE apa01 = g_apv[i].apv03
                 LET l_apa.apa34 = l_apa.apa31 + l_apa.apa32 - g_amt1
                 LET l_apa.apa34f= l_apa.apa31f+ l_apa.apa32f- g_amt1f
                 #No.MOD-590312  --begin
                 CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
                 SELECT apa34 INTO m_apa34 FROM apa_file
                 WHERE apa01 = g_apv[i].apv03
                 LET g_apa.apa73 = m_apa34 - g_amt1 + g_net
                 #No.MOD-590312  --end
                #No.MOD-58036  --end
                UPDATE apa_file SET apa65f= g_amt1f,
                                    apa65 = g_amt1,
                                    apa34 = l_apa.apa34,
                                    apa34f= l_apa.apa34f,
                                    #apa72 = g_apa.apa72,  #No.MOD-580365
                                    apa73 = g_apa.apa73
                 WHERE apa01 = g_apv[i].apv03
                #-----MOD-730098---------
                IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
                   CALL cl_err3("upd","apa_file",g_apv[i].apv03,"",STATUS,"","upd apa",1)
                   LET g_success='N'
                   IF p_cmd = 'u' THEN
                      LET g_apv[i].*=g_apv_t.*
                   END IF
                END IF
                #-----END MOD-730098-----
            END IF
          END IF

      AFTER ROW
          LET l_ac = ARR_CURR()
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             IF p_cmd = 'u' THEN
                LET g_apv[l_ac].* = g_apv_t.*
             END IF
             CLOSE t110_k22_cr
             LET g_success = 'N'
             EXIT INPUT
          END IF
          CLOSE t110_k22_cr

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
 
      #No.MOD-580365  --begin
     #計算匯差
     AFTER INPUT
        LET l_net = 0
        FOR l_i = 1 TO g_apv.getLength()
            IF cl_null(g_apv[l_i].apv03) THEN CONTINUE FOR END IF
            IF g_apv[l_i].apv03 = 'DIFF' THEN CONTINUE FOR END IF
            SELECT apa14 INTO l_apa14 FROM apa_file
             WHERE apa01=g_apv[l_i].apv03
            IF l_apa14 <> g_apv[l_i].apa14 THEN
               #LET l_amt=g_apv[l_i].apv04f*(l_apa14-g_apv[l_i].apa14)
               #-----MOD-760089---------
               #LET l_amt=g_apv[l_i].apv04f*g_apa.apa14-g_apv[l_i].apv04
               LET l_amt=cl_digcut(g_apv[l_i].apv04f*g_apa.apa14,g_azi04)
                         - g_apv[l_i].apv04
               #-----END MOD-760089-----
               IF cl_null(l_amt) THEN LET l_amt=0 END IF
#No.TQC-6B0066--begin
               CALL t110_comp_oox1(g_apv[i].apv03,g_apv[l_i].apv05) RETURNING g_net  #MOD-940090
               LET l_amt = cl_digcut(l_amt,g_azi04)  
               UPDATE apc_file SET apc09=apc09-l_amt,
                                   apc13=apc09-l_amt-apc11+g_net,                    #MOD-940090
                                   apc15=apc15+l_amt
                WHERE apc01 =g_apv[i].apv03
                  AND apc02 =g_apv[l_i].apv05
               IF STATUS OR SQLCA.SQLCODE THEN
                  CALL cl_err3("upd","apcfile", g_apa.apa01,g_apv[l_i].apv05,SQLCA.sqlcode,"","",1)  
                  LET g_success='N'
               END IF               
#              LET l_net = l_net + l_amt
#No.TQC-6B0066--end
     #          UPDATE apa_file SET apa65 = apa65+l_amt
     #           WHERE apa01 = g_apv[i].apv03
            ELSE
               IF g_apv[l_i].apa14 <> g_apa.apa14 THEN
                  #LET l_amt=g_apv[l_i].apv04f*(g_apa.apa14-g_apv[l_i].apa14)
                  #-----MOD-760089---------
                  #LET l_amt=g_apv[l_i].apv04f*g_apa.apa14-g_apv[l_i].apv04
                  LET l_amt=cl_digcut(g_apv[l_i].apv04f*g_apa.apa14,g_azi04)
                            - g_apv[l_i].apv04
                  #-----END MOD-760089-----
                  IF cl_null(l_amt) THEN LET l_amt=0 END IF
#No.TQC-6B0066--begin
                  CALL t110_comp_oox1(g_apv[i].apv03,g_apv[l_i].apv05) RETURNING g_net  #MOD-940090
                  LET l_amt = cl_digcut(l_amt,g_azi04) 
                  UPDATE apc_file SET apc09=apc09-l_amt,
                                      apc13=apc09-l_amt-apc11+g_net,                    #MOD-940090
                                      apc15=apc15+l_amt
                   WHERE apc01 =g_apv[i].apv03
                     AND apc02 =g_apv[l_i].apv05
                  IF STATUS OR SQLCA.SQLCODE THEN
                     CALL cl_err3("upd","apcfile", g_apa.apa01,g_apv[l_i].apv05,SQLCA.sqlcode,"","",1)  
                     LET g_success='N'
                  END IF               
#              LET l_net = l_net + l_amt
#No.TQC-6B0066--end
     #             UPDATE apa_file SET apa65 = apa65+l_amt
     #              WHERE apa01 = g_apv[i].apv03
               END IF
            END IF
        END FOR
        DELETE FROM apv_file
         WHERE apv01=g_apa.apa01
           AND apv03='DIFF'
        IF SQLCA.sqlcode THEN
#          CALL cl_Err('delete diff',SQLCA.sqlcode,1) #No.FUN-660122
           CALL cl_err3("del","apv_file",g_apa.apa01,"",SQLCA.sqlcode,"","delete diff",1)  #No.FUN-660122
           NEXT FIELD apv04
        END IF
        IF l_net <> 0 THEN
            SELECT MAX(apv02)+1 INTO l_apv02 FROM apv_file
             WHERE apv01 = g_apa.apa01
            IF cl_null(l_apv02)  THEN
               LET l_apv02 = 1
            END IF
            INSERT INTO apv_file(apv01,apv02,apv03,apv04f,apv04)
            VALUES(g_apa.apa01,l_apv02,'DIFF',0,l_net)
            IF SQLCA.sqlcode THEN
#              CALL cl_err('insert diff',SQLCA.sqlcode,1)   #No.FUN-660122
               CALL cl_err3("ins","apv_file",g_apa.apa01,l_apv02,SQLCA.sqlcode,"","insert diff",1)  #No.FUN-660122
               NEXT FIELD apv04
            END IF
         END IF
      #No.MOD-580365  --end
 
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033

   END INPUT

   IF INT_FLAG THEN
      LET g_success='N'
      LET INT_FLAG = 0
   END IF

   IF g_success = 'Y' THEN
      COMMIT WORK
      MESSAGE "Commit"
   ELSE
      ROLLBACK WORK
      MESSAGE "RollBack"
   END IF

   SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa35f,g_apa.apa35
     FROM apv_file WHERE apv01=g_apa.apa01

   IF cl_null(g_apa.apa35f) THEN
      LET g_apa.apa35f = 0
   END IF

   IF cl_null(g_apa.apa35 ) THEN
      LET g_apa.apa35 = 0
   END IF

 # DISPLAY BY NAME g_apa.apa35f,g_apa.apa35

   DISPLAY g_apa.apa35f TO apa65f
   DISPLAY g_apa.apa35  TO apa65
   CALL t110_comp_oox(g_apa.apa01) RETURNING g_net      #CHI-890017 add
   UPDATE apa_file SET apa35f=g_apa.apa35f,
                       apa35 =g_apa.apa35
                      ,apa73 =apa34-g_apa.apa35+g_net   #CHI-890017 add
    WHERE apa01 = g_apa.apa01

   #IF STATUS OR SQLCA.SQLCODE THEN   #MOD-730098
   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
#     CALL cl_err('upd apa35:',SQLCA.SQLCODE,1)   #No.FUN-660122
      CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa35:",1)  #No.FUN-660122
      LET g_success = 'N'   #MOD-730098
   END IF

   CLOSE WINDOW t110_kkk_w

   DISPLAY BY NAME g_apa.apa35f,g_apa.apa35
 # DISPLAY g_apa.apa35f TO apa65f
 # DISPLAY g_apa.apa35  TO apa65
   CLOSE t110_k2_cr
   CLOSE t110_k22_cr

   IF l_lock_sw = 'Y' THEN
      RETURN
   END IF

   CALL t110_apa34f('0')     #TQC-750140

   LET g_apa.apa72 = g_apa.apa14
   CALL t110_comp_oox(g_apa.apa01) RETURNING g_net       #CHI-890017 add
  #LET g_apa.apa73 = g_apa.apa34 - g_apa.apa35           #CHI-890017 mark
   LET g_apa.apa73 = g_apa.apa34 - g_apa.apa35 + g_net   #CHI-890017

   UPDATE apa_file set * = g_apa.* WHERE apa01 = g_apa.apa01
   #-----MOD-730098---------
   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
      CALL cl_err3("upd","apa_file",g_apa.apa01,"",STATUS,"","upd apa:",1)
      LET g_success = 'N'
   END IF
   #-----END MOD-730098-----

   CALL t110_up_gl()
   CALL t110_unpay()

   DELETE FROM apv_file WHERE apv01 = g_apa.apa01 AND apv04 = 0

   CALL t110_diff_rtn('0') #TQC-750140
   CALL t110_api_diff()    #No.TQC-7B0083

END FUNCTION
#FUN-580012  --end

FUNCTION t110_pay_record()
   DEFINE i,j          LIKE type_file.num5       #No.FUN-690028 SMALLINT
   DEFINE l_amtf,l_amt LIKE type_file.num20_6,   # No:FUN-690028 DEC(20,6),  #FUN-4B0079
          tmp_prog     LIKE type_file.chr1000    # No:FUN-690028 VARCHAR(100)
   DEFINE l_ape     RECORD
                    no          LIKE apv_file.apv01,      # No:FUN-690028 VARCHAR(16),  #FUN-580012
                    sq          LIKE type_file.num5,      # No:FUN-690028 SMALLINT,
                    amtf        LIKE type_file.num20_6,   # No:FUN-690028 DEC(20,6),  #FUN-4B0079
                    amt         LIKE type_file.num20_6,   # No:FUN-690028 DEC(20,6),  #FUN-4B0079
                    #nmd02       VARCHAR(10),            #FUN-660117 remark
                    nmd02       LIKE nmd_file.nmd02,  #FUN-660117
                    nmd05       LIKE type_file.dat,       # No:FUN-690028 DATE,
                    nmd04       LIKE nmd_file.nmd04 #FUN-4B0079
                    END RECORD

   CALL g_ape.clear()
   IF g_apa.apa01 IS NULL THEN
      RETURN
   END IF

#  WHENEVER ERROR CALL cl_err_msg_log

   OPEN WINDOW t110_pay_record_w WITH FORM "aap/42f/aapt110_4"
      ATTRIBUTE(STYLE = g_win_style)
   CALL cl_ui_locale('aapt110_4')

   LET l_amtf = 0 LET l_amt  = 0
   LET i = 1
   IF g_aptype MATCHES '1*' THEN
      DECLARE t110_pay_c11 CURSOR FOR
           SELECT apv03,'',apv04f,apv04,'','',''
             FROM apv_file
            WHERE apv01 = g_apa.apa01
          #FUN-580012  --begin
          # ORDER BY apv03
            UNION
           SELECT apv01,'',apv04f,apv04,'','',''
             FROM apv_file
            WHERE apv03 = g_apa.apa01
          # ORDER BY apv01
          #FUN-580012  --end


      FOREACH t110_pay_c11 INTO g_ape[i].*
         LET l_amtf = l_amtf + g_ape[i].amtf
         LET l_amt  = l_amt  + g_ape[i].amt
         LET i = i + 1
          IF i > g_max_rec THEN    #No:MOD-480131
            EXIT FOREACH
         END IF
      END FOREACH

      LET g_sql = "SELECT MAX(nmd02),MAX(nmd05),MAX(nmd04) ",
                  "  FROM nmd_file WHERE nmd10=? AND nmd30 <> 'X' "

      PREPARE t110_prenmd FROM g_sql
      DECLARE t110_csnmd CURSOR FOR t110_prenmd

     #str CHI-880003 mod
     #DECLARE zr_curs1 CURSOR WITH HOLD FOR
     # SELECT UNIQUE azr03 FROM azr_file
     #  WHERE azr01 = g_plant AND azr04 = 'AAP' AND azr02 = 'AAP'
    #str MOD-8B0183 mod
    # DECLARE zp_curs1 CURSOR WITH HOLD FOR
    #  SELECT azp01 FROM azp_file WHERE azp053 = 'Y'
      LET g_sql = "SELECT azp01 FROM azp_file WHERE azp053='Y'"
    # IF g_apa.apa55='2' THEN   #直接付款           #MOD-940213
      IF g_apa.apa55='2' OR g_apz.apz26 = 'N' THEN   #直接付款  #MOD-940213 
         LET g_sql = g_sql CLIPPED," AND azp01='",g_plant CLIPPED,"'"
      END IF
      PREPARE zp_pre FROM g_sql
      DECLARE zp_curs1 CURSOR FOR zp_pre
    #end MOD-8B0183 mod
     #end CHI-880003 mod

      FOREACH zp_curs1 INTO g_plant_new   #CHI-880003 mod zr_curs1->zp_curs1
         IF STATUS THEN
            EXIT FOREACH
         END IF
         CALL s_getdbs()
         LET g_sql = "SELECT apf01,apg02,apg05f,apg05,'','','' ",
                     " FROM ",g_dbs_new CLIPPED," apg_file,",
                              g_dbs_new CLIPPED," apf_file ",
                     " WHERE apg01 = apf01 AND apf41='Y' ",
                     "   AND apg03 = '",g_plant CLIPPED,"' ",    #No.MOD-910020
                     "   AND apg04 = '",g_apa.apa01,"'",
                     "   AND apf01 NOT IN(SELECT apf01 FROM apf_file,apg_file",                            #No.FUN-690090
                     "                 WHERE apf01 =apg01 AND apf992 IS NOT NULL AND apg03 ='",g_plant,"')",        #No.FUN-690090
                     " ORDER BY apf01 "

	CALL cl_replace_sqldb(g_sql) RETURNING g_sql		#FUN-920032
         PREPARE t110_prepay FROM g_sql
         DECLARE t110_pay_cl2 CURSOR FOR t110_prepay

         FOREACH t110_pay_cl2 INTO g_ape[i].*
           IF SQLCA.sqlcode THEN
              CALL cl_err('t110_pay_cl2',SQLCA.sqlcode,0)
              EXIT FOREACH
           END IF

           OPEN t110_csnmd USING g_ape[i].no
           FETCH t110_csnmd INTO g_ape[i].nmd02,g_ape[i].nmd05,g_ape[i].nmd04
 
           LET l_amtf = l_amtf + g_ape[i].amtf
           LET l_amt  = l_amt  + g_ape[i].amt
           LET i = i + 1

            IF i > g_max_rec THEN                  #No:MOD-480131
              EXIT FOREACH
           END IF
        END FOREACH
      END FOREACH
   END IF

   IF g_aptype MATCHES '2*' THEN
      DECLARE t110_pay_c21 CURSOR FOR
           SELECT apa01,apv02,apv04f,apv04,'','',''
             FROM apv_file, OUTER apa_file
            WHERE apv03 = g_apa.apa01 AND apv01=apa_file.apa01
          #FUN-580012  --begin
          # ORDER BY apa01
            UNION
           SELECT apv03,apv02,apv04f,apv04,'','',''
             FROM apv_file
            WHERE apv01 = g_apa.apa01
          # ORDER BY apv01
          #FUN-580012  --end

      FOREACH t110_pay_c21 INTO g_ape[i].*
         LET l_amtf = l_amtf + g_ape[i].amtf
         LET l_amt  = l_amt  + g_ape[i].amt
         LET i = i + 1
         IF i > 48 THEN
            EXIT FOREACH
         END IF
      END FOREACH

     #str CHI-880003 mod
     #DECLARE zr_curs2 CURSOR WITH HOLD FOR
     # SELECT UNIQUE azr03 FROM azr_file
     #  WHERE azr01 = g_plant AND azr04 = 'AAP' AND azr02 = 'AAP'
    #str MOD-8B0224 mod
    # DECLARE zp_curs2 CURSOR WITH HOLD FOR
    #  SELECT azp01 FROM azp_file WHERE azp053 = 'Y'
      LET g_sql = "SELECT azp01 FROM azp_file WHERE azp053='Y'"
      IF g_apa.apa00='21' OR g_apa.apa00='22' OR
         g_apa.apa00='23' OR g_apa.apa00='25' THEN
         LET g_sql = g_sql CLIPPED," AND azp01='",g_plant CLIPPED,"'"
      END IF
      PREPARE zp_pre2 FROM g_sql
      DECLARE zp_curs2 CURSOR FOR zp_pre2
    #end MOD-8B0224 mod
     #end CHI-880003 mod

      FOREACH zp_curs2 INTO g_plant_new   #CHI-880003 mod zr_curs2->zp_curs2
         IF STATUS THEN
            EXIT FOREACH
         END IF

         CALL s_getdbs()

         LET g_sql = " SELECT apf01,aph02,aph05f,aph05,'','','' ",
                     "   FROM ",g_dbs_new CLIPPED,"aph_file,",
                                g_dbs_new CLIPPED,"apf_file ",
                     "  WHERE aph04 ='", g_apa.apa01 ,"'",
                     "    AND aph01=apf01 AND apf41='Y'",
                     "  ORDER BY apf01 "
	CALL cl_replace_sqldb(g_sql) RETURNING g_sql		#FUN-920032
         PREPARE t110_pay_p22 FROM g_sql

         DECLARE t110_pay_c22 CURSOR FOR t110_pay_p22

         FOREACH t110_pay_c22 INTO g_ape[i].*
            LET l_amtf = l_amtf + g_ape[i].amtf
            LET l_amt  = l_amt  + g_ape[i].amt
            LET i = i + 1
             IF i > g_max_rec THEN             #No:MOD-480131
               EXIT FOREACH
            END IF
         END FOREACH
        #MOD-9A0075   ---start
         LET g_sql = "SELECT apf01,apg02,apg05f,apg05,'','','' ",                                                                   
                     " FROM ",g_dbs_new CLIPPED," apg_file,",                                                                       
                              g_dbs_new CLIPPED," apf_file ",                                                                       
                     " WHERE apg01 = apf01 AND apf41='Y' ",                                                                         
                     "   AND apg03 = '",g_plant CLIPPED,"' ",    #No.MOD-910020                                                     
                     "   AND apg04 = '",g_apa.apa01,"'",                                                                            
                     "   AND apf01 NOT IN(SELECT apf01 FROM apf_file,apg_file",                            #No.FUN-690090           
                     "                 WHERE apf01 =apg01 AND apf992 IS NOT NULL AND apg03 ='",g_plant,"')",        #No.FUN-690090  
                     " ORDER BY apf01 "                                                                                             
                                                                                                                                    
         CALL cl_replace_sqldb(g_sql) RETURNING g_sql            #FUN-920032                                                         
         PREPARE t110_prepay_1 FROM g_sql                                                                                             
         DECLARE t110_pay_cl2_1 CURSOR FOR t110_prepay_1                                                                               
                                                                                                                                    
         FOREACH t110_pay_cl2_1 INTO g_ape[i].*                                                                                       
            LET l_amtf = l_amtf + g_ape[i].amtf     
            LET l_amt  = l_amt  + g_ape[i].amt                                                                                       
            LET i = i + 1                                                                                                            
                                                                                                                                    
            IF i > g_max_rec THEN                  #No:MOD-480131                                                                   
               EXIT FOREACH                                                                                                          
            END IF                                                                                                                   
         END FOREACH           
        #MOD-9A0075   ---end
      END FOREACH
      #-----MOD-6B0156---------
      LET g_sql = " SELECT aqa01,'',aqb04,aqb04,'','','' ",
                  "   FROM aqa_file,aqb_file ",
                  "  WHERE aqb02 ='", g_apa.apa01 ,"'",
                  "    AND aqa01=aqb01 AND aqaconf='Y'",
                  "  ORDER BY aqa01 "
      PREPARE t110_pay_p23 FROM g_sql
 
      DECLARE t110_pay_c23 CURSOR FOR t110_pay_p23
 
      FOREACH t110_pay_c23 INTO g_ape[i].*
         LET l_amtf = l_amtf + g_ape[i].amtf
         LET l_amt  = l_amt  + g_ape[i].amt
         LET i = i + 1
          IF i > g_max_rec THEN
            EXIT FOREACH
         END IF
      END FOREACH
      #-----END MOD-6B0156-----

   END IF

   CALL g_ape.deleteElement(i)    #MOD-B50017 
   LET g_rec_b = i - 1
   DISPLAY l_amtf TO FORMONLY.totf
   DISPLAY l_amt  TO FORMONLY.tot
   DISPLAY ARRAY g_ape TO s_ape.* ATTRIBUTE(COUNT=g_rec_b)
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE DISPLAY
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033

   END DISPLAY
   IF INT_FLAG THEN
      LET INT_FLAG = 0
   END IF

   CLOSE WINDOW t110_pay_record_w
END FUNCTION

FUNCTION t110_gen_gl()
#  DEFINE l_t1       VARCHAR(03),
   DEFINE l_t1       LIKE apy_file.apyslip,    # No:FUN-690028 VARCHAR(05),                      #No.FUN-550030
          l_apydmy3  LIKE apy_file.apydmy3

   IF NOT cl_null(g_apa.apa44) THEN   #No:MOD-670056
      CALL cl_err(g_apa.apa01,'aap-122',1) RETURN
   END IF

   #TQC-C90078--add--str--
   IF g_apa.apa58='1' THEN
      CALL cl_err('','aap-260',0)
   END IF
   #TQC-C90078--add--end--

   IF g_apa.apa56='1' THEN
      CALL cl_err(g_apa.apa01,'aap-230',0)
      RETURN
   END IF
#No.FUN-550030--begin
#  LET l_t1 = g_apa.apa01[1,3]
   LET l_t1 = s_get_doc_no(g_apa.apa01)
#No.FUN-550030--begin
   SELECT apydmy3 INTO l_apydmy3 FROM apy_file WHERE apyslip = l_t1
   IF SQLCA.sqlcode THEN
#     CALL cl_err('sel apy:',STATUS,0)    #No.FUN-660122
      CALL cl_err3("sel","apy_file","","",STATUS,"","sel apy:",1)  #No.FUN-660122
      RETURN
   END IF

   IF l_apydmy3 = 'Y' THEN
      IF g_apa.apa58 <> '1' THEN   #TQC-C90078  add
         CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'0')    #No.FUN-680029
#No.FUN-680029--begin
         IF g_aza.aza63 ='Y' THEN
            CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'1')   
         END IF
      END IF                       #TQC-C90078  add
#No.FUN-680029--end
   END IF

END FUNCTION

#FUN-580114
#FUNCTION t110_firm1()
FUNCTION t110_firm1_chk()
   DEFINE only_one,l_sw         LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_amt,l_amt1,l_amt2   LIKE type_file.num20_6,   # No:FUN-690028 DEC(20,6),  #FUN-4B0079
          l_apk                 RECORD LIKE apk_file.*,
          i,j                   LIKE type_file.num5,    #No.FUN-690028 SMALLINT
          l_cmd                 LIKE type_file.chr1000 #No.FUN-690028 VARCHAR(200)
   DEFINE l_apydmy3             LIKE apy_file.apydmy3,    # No:FUN-690028 VARCHAR(1),
          l_apb14               LIKE apb_file.apb14,
          l_apb14f              LIKE apb_file.apb14f,
          l_apa01               LIKE apa_file.apa01,
          l_apa41               LIKE apa_file.apa41,
          l_apa32               LIKE apa_file.apa32,      #MOD-AC0268 
          l_apa32f              LIKE apa_file.apa32f,     #MOD-AC0268
          l_apa34               LIKE apa_file.apa34,
          l_apa34f              LIKE apa_file.apa34f
#    DEFINE l_arr1 DYNAMIC ARRAY OF VARCHAR(12)         #No:MOD-480131   #MOD-5B0255
   #DEFINE l_arr1 DYNAMIC ARRAY OF VARCHAR(16)         #No:MOD-480131   #MOD-5B0255  #FUN-660117 remark
   DEFINE l_arr1 DYNAMIC ARRAY OF LIKE apk_file.apk01   #FUN-660117
   DEFINE l_arr2 DYNAMIC ARRAY OF RECORD
#                    invoice    VARCHAR(12),   #MOD-5B0255
                    #invoice    VARCHAR(16),    #MOD-5B0255   #FUN-660117 remark
                    invoice    LIKE apk_file.apk03,        #FUN-660117
                    apa58      LIKE apa_file.apa58,
                    amt1       LIKE type_file.num20_6,   # No:FUN-690028 DEC(20,6),  #FUN-4B0079
                    amt2       LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
                 END RECORD
   DEFINE g_apa61              LIKE apa_file.apa61  #FUN-4B0079
   DEFINE l_api05              LIKE api_file.api05
   DEFINE g_t1                 LIKE oay_file.oayslip             #No.FUN-550030  #No.FUN-690028 VARCHAR(05)
   DEFINE l_flag               LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_yy,l_mm            LIKE type_file.num5    #No.FUN-690028 SMALLINT
   DEFINE l_cnt                LIKE type_file.num10   #No.FUN-690028 INTEGER
   DEFINE l_apv04f             LIKE apv_file.apv04f  #FUN-580012
   DEFINE l_apv04              LIKE apv_file.apv04   #FUN-580012               
   DEFINE l_apc08              LIKE apc_file.apc08   #No.FUN-680027
   DEFINE l_apc09              LIKE apc_file.apc09   #No.FUN-680027
   DEFINE l_apc16              LIKE apc_file.apc16   #No.FUN-680027
   DEFINE l_apb11              LIKE apb_file.apb11   #MOD-7C0139
   DEFINE l_aag21              LIKE aag_file.aag21   #MOD-850100 add  
   DEFINE l_gec05              LIKE gec_file.gec05   #MOD-940079    
   DEFINE l_pmm22              LIKE pmm_file.pmm22   #MOD-9C0334 add    
   DEFINE l_apb06              LIKE apb_file.apb06   #MOD-9C0334 add   
   DEFINE l_sumamtf            LIKE apa_file.apa34f  #MOD-B60066
   DEFINE l_sumamt             LIKE apa_file.apa34   #MOD-B60066

   SELECT * INTO g_apa.* FROM apa_file WHERE apa01 = g_apa.apa01   #FUN-640231
 
   LET g_success = 'Y'
 
#FUN-540041
   IF g_apa.apa01 IS NULL THEN
      LET g_success = 'N'
     #RETURN #CHI-A80031 mark
   END IF
 #FUN-550042
 # IF g_apa.apa63 <> '0' THEN
 #    RETURN
 # END IF
# IF g_apa.apamksg='Y'   THEN
#     IF g_apa.apa63 != '1' THEN CALL cl_err('','aws-078',1) RETURN END IF
# END IF
   IF g_apa.apaacti='N' THEN
     #CALL cl_err('','mfg0301',1) #CHI-A80031 mark
      CALL s_errmsg('','','','mfg0301',1) #CHI-A80031
      LET g_success = 'N'
     #RETURN #CHI-A80031 mark
   END IF
 #END FUN-550042

  #str CHI-B60063 add          
  #確認時若碰到應付金額=0的資料,增加詢問"應付金額為0,是否確定執行確認(Y/N)?"
   LET g_flag2 = 'Y'           
   IF g_apa.apa34f = 0  THEN   
      CALL cl_getmsg('aap-168',g_lang) RETURNING g_msg
      LET g_msg = g_apa.apa01,g_msg 
      IF cl_confirm(g_msg) THEN 
         LET g_flag2 = 'N' #不檢查,直接確認
      ELSE
         LET g_flag2 = 'Y'     
         LET g_success = 'N'
      END IF
      RETURN
   END IF
  #end CHI-B60063 add

  #MOD-9C0334---add---start---
   DECLARE apb06 CURSOR FOR 
     SELECT apb06 FROM apb_file where apb01=g_apa.apa01
   FOREACH apb06 INTO l_apb06
     IF NOT cl_null(l_apb06) THEN
        SELECT pmm22 INTO l_pmm22 FROM pmm_file
         WHERE pmm01 = l_apb06
        IF l_pmm22 <> g_apa.apa13 THEN
          #CALL cl_err('','aap-041',1) #CHI-A80031 mark
           CALL s_errmsg('','','','aap-041',1) #CHI-A80031
           LET g_success = 'N'
          #RETURN #CHI-A80031 mark
        END IF
     END IF
   END FOREACH
  #MOD-9C0334---add---end---

#END FUN-540041
   IF g_apa.apa41 = 'Y' THEN
      LET g_success = 'N'
     #RETURN #CHI-A80031 mark
   END IF

   IF g_apa.apa42 = 'Y' THEN
     #CALL cl_err('','9024',0) #CHI-A80031 mark
      CALL s_errmsg('','','','9024',1) #CHI-A80031
      LET g_success = 'N'
     #RETURN #CHI-A80031 mark
   END IF
  
   #-----MOD-770066---------
   IF g_apa.apa56 = '1' THEN
     #CALL cl_err('','aap-807',0) #CHI-A80031 mark
      CALL s_errmsg('','','','aap-807',1) #CHI-A80031 #TQC-AB0084 mod
      LET g_success = 'N'
     #RETURN #CHI-A80031 mark
   END IF
   #-----END MOD-770066-----

   #No.TQC-7C0094--begin--
   SELECT COUNT(*) INTO l_cnt FROM apc_file
    WHERE apc01 =g_apa.apa01
   IF l_cnt =0 THEN
     #CALL cl_err(g_apa.apa01,'aap-339',1) #CHI-A80031 mark
      CALL s_errmsg('apa01',g_apa.apa01,'','aap-339',1) #CHI-A80031
      LET g_success ='N'
     #RETURN #CHI-A80031 mark
   END IF
   #No.TQC-7C0094---end---

  #str MOD-850100 add
  #借方科目(apa51)若有預算控管時(aag21='Y'),單身沒輸入科目(apb25)不可確認
   SELECT aag21 INTO l_aag21 FROM aag_file
    WHERE aag01 = g_apa.apa51
      AND aag00 = g_bookno1     #No.FUN-730064
      AND aagacti = 'Y'         #No.MOD-B70280 add
   IF l_aag21 = 'Y' THEN       
      LET l_cnt = 0
      SELECT COUNT(*) INTO l_cnt FROM apb_file
       WHERE apb01=g_apa.apa01 AND apb25=g_apa.apa51
      IF l_cnt = 0 THEN
        #CALL cl_err('','aap-116',1) #CHI-A80031 mark
         CALL s_errmsg('','','','aap-116',1) #CHI-A80031
         LET g_success ='N'
        #RETURN #CHI-A80031 mark
      END IF
   END IF
   IF g_aza.aza63 = 'Y' THEN
      SELECT aag21 INTO l_aag21 FROM aag_file
       WHERE aag01 = g_apa.apa511
         AND aag00 = g_bookno2     #No.FUN-730064
         AND aagacti = 'Y'         #No.MOD-B70280 add
      IF l_aag21 = 'Y' THEN        
         LET l_cnt = 0
         SELECT COUNT(*) INTO l_cnt FROM apb_file
          WHERE apb01=g_apa.apa01 AND apb251=g_apa.apa511
         IF l_cnt > 0 THEN
           #CALL cl_err('','aap-116',1) #CHI-A80031 mark
            CALL s_errmsg('','','','aap-116',1) #CHI-A80031
            LET g_success ='N'
           #RETURN #CHI-A80031 mark
         END IF
      END IF
   END IF
  #end MOD-850100 add

#No.MOD-970101--mark
#   #FUN-580012  --begin
#   IF g_aza.aza26 = '2' THEN
#      IF g_aptype[1,1]='2' THEN
#         LET g_t1 = s_get_doc_no(g_apa.apa01)
#         SELECT apydmy6 INTO g_apy.apydmy6 FROM apy_file WHERE apyslip = g_t1
#         IF g_apy.apydmy6='Y' THEN
#            SELECT SUM(apv04),SUM(apv04f) INTO l_apv04,l_apv04f
#              FROM apv_file
#             WHERE apv01=g_apa.apa01
#            IF cl_null(l_apv04) THEN LET l_apv04 = 0 END IF
#            IF cl_null(l_apv04f) THEN LET l_apv04f = 0 END IF
#            IF l_apv04<>g_apa.apa34 OR l_apv04f <> g_apa.apa34f THEN
#               CALL cl_err('','aap-912',0)
#               LET g_success = 'N'
#               RETURN
#            END IF
#         END IF
#      END IF
#   END IF
#   #FUN-580012  --end
#No.MOD-970101--mark
   #No.FUN-690080 --Begin
   #IF g_aptype <> '13' THEN  #FUN-950094 mark
#-----MOD-7A0049---------
{
#TQC-790167.....begin
         UPDATE apc_file SET apc08=g_apa.apa34f,
                             apc09=g_apa.apa34
          WHERE apc01=g_apa.apa01
#TQC-790167.....end
}
#-----END MOD-7A0049-----
#No.FUN-680027--begin
        #-MOD-B60066-add-
         IF g_aptype MATCHES '1*' THEN
            LET l_sumamtf = g_apa.apa34f + g_apa.apa65f
            LET l_sumamt  = g_apa.apa34  + g_apa.apa65
         ELSE
            LET l_sumamtf = g_apa.apa34f
            LET l_sumamt  = g_apa.apa34
         END IF
        #-MOD-B60066-end-
         SELECT SUM(apc08),SUM(apc09),SUM(apc16) INTO l_apc08,l_apc09,l_apc16 FROM apc_file
          WHERE apc01 =g_apa.apa01
        #IF l_apc08 <>g_apa.apa34f OR l_apc09 <>g_apa.apa34 OR l_apc16 <>g_apa.apa20 THEN #MOD-B60066 mark
         IF l_apc08 <> l_sumamtf OR l_apc09 <> l_sumamt OR l_apc16 <>g_apa.apa20 THEN     #MOD-B60066
#           CALL cl_err('','aap-921',0)  #No.TQC-740168 mark
           #CALL cl_err('','aap-921',1)  #No.TQC-740168 #CHI-A80031 mark
            CALL s_errmsg('','','','aap-921',1) #CHI-A80031
            LET g_success = 'N'
           #RETURN #CHI-A80031 mark
         END if
#No.FUN-680027--end
   #END IF                #FUN-950094 mark
   #No.FUN-690080 --End

   #TQC-740281
#   IF g_apa.apa00 = '11' AND g_apa.apa51 <> 'UNAP' THEN #No.TQC-7C0140      #MOD-970115 
   IF g_apa.apa00 = '11' AND g_apa.apa51 <> 'UNAP' AND g_apa.apa56 <> '5' THEN #No.TQC-7C0140      #MOD-970115
      SELECT COUNT(*) INTO g_cnt FROM apb_file WHERE apb01 = g_apa.apa01
      IF g_cnt = 0 THEN
        #CALL cl_err(g_apa.apa01,'arm-034',1) #CHI-A80031 mark
         CALL s_errmsg('apa01',g_apa.apa01,'','arm-034',1) #CHI-A80031
         LET g_success='N'
        #RETURN #CHI-A80031 mark
      END IF
   END IF
   #END TQC-740281
#MOD-940079 --begin                                                                                                         
   SELECT gec05 INTO l_gec05 FROM gec_file                                                                                  
    WHERE gec01 = g_apa.apa15                                                                                               
#MOD-940079 --end            
   #-----MOD-7C0139--------- 
 # IF (g_apa.apa58 = '3' OR g_apa.apa58 = '2') AND g_apa.apa00='21' THEN  #MOD-940079
   IF (g_apa.apa58 = '3' OR g_apa.apa58 = '2') AND g_apa.apa00='21' AND l_gec05 != 'X' AND g_aza.aza26 <> '2' THEN #MOD-940079   #No.FUN-990017
      DECLARE apb_cur CURSOR FOR 
        SELECT apb11 FROM apb_file where apb01=g_apa.apa01
      FOREACH apb_cur INTO l_apb11
         IF l_apb11 IS NULL OR l_apb11 = ' ' THEN 
            #CALL cl_err(g_apa.apa01,'mfg-011',0) #CHI-A80031 mark
             CALL s_errmsg('apa01',g_apa.apa01,'','mfg-011',1) #CHI-A80031
             LET g_success = 'N'
            #RETURN #CHI-A80031 mark
         END IF
      END FOREACH
   END IF
   #-----END MOD-7C0139-----

   #No.MOD-840385  --Begin
   LET l_cnt = 0
   SELECT COUNT(*) INTO l_cnt FROM api_file,apa_file
    WHERE api26 = apa01
      AND (apa00 = '16' OR apa00 = '26')
      AND api01 = g_apa.apa01
      AND api02 = '2'
      AND (apa41 IS NULL OR apa41 = 'N')
   IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
   IF l_cnt > 0 THEN
     #CALL cl_err(g_apa.apa01,'aap-343',1)  #CHI-A80031 mark
      CALL s_errmsg('apa01',g_apa.apa01,'','aap-343',1) #CHI-A80031
      LET g_success = 'N'
     #RETURN #CHI-A80031 mark
   END IF
   #No.MOD-840385  --End  

  #-MOD-AC0268-add-
   #CALL t110_sum_apa32() RETURNING l_apa32,l_apa32f     #No.TQC-AC0367 mark
   CALL t110_sum_apa32_1() RETURNING l_apa32,l_apa32f    #No.TQC-AC0367 add  
   IF (l_apa32 != g_apa.apa32 OR
     #l_apa32f != g_apa.apa32f) AND g_aptype = '21' THEN #MOD-B60016 mark
      l_apa32f != g_apa.apa32f) AND g_aptype = '21' AND g_aza.aza26 <> '2' THEN #MOD-B60016 
      CALL s_errmsg('apa01',g_apa.apa01,'','aap-212',1) 
      LET g_success = 'N'
   END IF    
  #-MOD-AC0268-end-

  #CHI-B10042 add --start--
   IF g_action_choice CLIPPED = "confirm" OR #執行 "確認" 功能(非簽核模式呼叫)
      g_action_choice CLIPPED = "insert" THEN 
      IF g_apa.apamksg='Y' THEN
         IF g_apa.apa63 != '1' THEN
            CALL s_errmsg('apa01',g_apa.apa01,'','aws-078',1) 
            LET g_success = 'N'
         END IF
      END IF
  END IF
  #CHI-B10042 add --end--
END FUNCTION

FUNCTION t110_firm1_upd()
   DEFINE only_one,l_sw         LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_amt,l_amt1,l_amt2   LIKE type_file.num20_6,   # No:FUN-690028 DEC(20,6),  #FUN-4B0079
          l_apk                 RECORD LIKE apk_file.*,
          l_apv                 RECORD LIKE apv_file.*,   #MOD-850301 add
          l_apa                 RECORD LIKE apa_file.*,   #MOD-850301 add
          l_apc                 RECORD LIKE apc_file.*,   #MOD-850301 add
          i,j                   LIKE type_file.num5,    #No.FUN-690028 SMALLINT
          l_cmd                 LIKE type_file.chr1000 #No.FUN-690028 VARCHAR(200)
   DEFINE l_apydmy3             LIKE apy_file.apydmy3,    # No:FUN-690028 VARCHAR(1),
          l_apb14               LIKE apb_file.apb14,
          l_apb14f              LIKE apb_file.apb14f,
          l_apa01               LIKE apa_file.apa01,
          l_apa41               LIKE apa_file.apa41,
          l_apa34               LIKE apa_file.apa34,
          l_apa34f              LIKE apa_file.apa34f
   #DEFINE l_arr1 DYNAMIC ARRAY OF VARCHAR(16)   #No:MOD-480131   #No:TQC-630032 modify  #FUN-660117 remark
   DEFINE l_arr1 DYNAMIC ARRAY OF LIKE apk_file.apk01    #FUN-660117
   DEFINE l_arr2 DYNAMIC ARRAY OF RECORD             
                   #invoice    VARCHAR(12),       #No:TQC-630032  mark
                   #invoice    VARCHAR(16),       #No:TQC-630032  add #FUN-660117 remark
                    invoice    LIKE apk_file.apk03,                #FUN-660117
                    apa58      LIKE apa_file.apa58,
                    amt1       LIKE type_file.num20_6,  # No:FUN-690028 DEC(20,6),  #FUN-4B0079
                    amt2       LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
                 END RECORD
   DEFINE g_apa61              LIKE apa_file.apa61      #FUN-4B0079
   DEFINE l_api05              LIKE api_file.api05
   DEFINE g_t1                 LIKE oay_file.oayslip    #FUN-580012  #No.FUN-690028 VARCHAR(05)
   DEFINE l_flag               LIKE type_file.chr1      #No.FUN-690028 VARCHAR(1)
   DEFINE l_yy,l_mm            LIKE type_file.num5      #No.FUN-690028 SMALLINT
   DEFINE l_cnt                LIKE type_file.num10     #No.FUN-690028 INTEGER
   DEFINE l_cnt1               LIKE type_file.num10     #No.TQC-7B0083
   DEFINE l_n                  LIKE type_file.num5      #No.FUN-690028 SMALLINT
   DEFINE l_amt3,l_amt4        LIKE type_file.num20_6   #MOD-6B0051
   DEFINE l_apb10              LIKE apb_file.apb10      #FUN-680010
   DEFINE l_wc                 STRING                   #No.MOD-7A0006
  #DEFINE l_aph05f             LIKE aph_file.aph05f     #MOD-880080 add   #MOD-880222 mark
  #DEFINE l_aph05              LIKE aph_file.aph05      #MOD-880080 add   #MOD-880222 mark
   DEFINE l_gec05              LIKE gec_file.gec05      #MOD-940079 
   DEFINE l_apa44              LIKE apa_file.apa44      #MOD-C50093 add
   DEFINE l_arr_i              LIKE type_file.num5      #MOD-C50093 add
   DEFINE l_arr_cnt            LIKE type_file.num5      #MOD-C50093 add
   DEFINE l_apa01_arr  DYNAMIC ARRAY OF RECORD          #MOD-C50093 add
                          apa01   LIKE apa_file.apa01   #MOD-C50093 add
                       END RECORD                       #MOD-C50093 add

   LET g_success = 'Y'
   LET g_totsuccess='Y' #CHI-A80031 add
   LET only_one = '1'
   LET l_arr_i = 1                                      #MOD-C50093 add
  
   IF g_action_choice CLIPPED = "confirm" OR #執行 "確認" 功能(非簽核模式呼叫)
      g_action_choice CLIPPED = "insert" THEN    #FUN-640240
     
      IF g_action_choice CLIPPED = "insert" THEN    #CHI-B10042 add
         IF g_apa.apamksg='Y' THEN
            IF g_apa.apa63 != '1' THEN
               CALL cl_err('','aws-078',1)
               LET g_success = 'N'
               RETURN
            END IF
         END IF
      END IF #CHI-B10042 add

      OPEN WINDOW t110_w6 WITH FORM "aap/42f/aapt110_6"
            ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
      CALL cl_ui_locale("aapt110_6")
 
      LET only_one = '1'
      CALL cl_set_head_visible("","YES")     #No.FUN-6B0033

      INPUT BY NAME only_one WITHOUT DEFAULTS
         AFTER FIELD only_one
            IF NOT cl_null(only_one) THEN
               IF only_one NOT MATCHES "[12]" THEN
                  NEXT FIELD only_one
               END IF
            END IF
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE INPUT
         ON ACTION about         #MOD-4C0121
            CALL cl_about()      #MOD-4C0121
         ON ACTION help          #MOD-4C0121
            CALL cl_show_help()  #MOD-4C0121
         ON ACTION controlg      #MOD-4C0121
            CALL cl_cmdask()     #MOD-4C0121
      END INPUT
      IF INT_FLAG THEN
         LET INT_FLAG = 0
         LET g_success = 'N'
         CLOSE WINDOW t110_w6
         RETURN
      END IF
   END IF

   IF only_one = '1' THEN
      LET g_wc = " apa01 = '",g_apa.apa01,"' "
   ELSE
      CALL cl_set_head_visible("","YES")     #No.FUN-6B0033

      CONSTRUCT BY NAME g_wc ON apa01,apa02,apa21,apa22,apa06

         #No:FUN-580031 --start--     HCN
         BEFORE CONSTRUCT
            CALL cl_qbe_init()
         #No:FUN-580031 --end--       HCN

         ON ACTION CONTROLP
            CASE
               WHEN INFIELD(apa01) #查詢單据
#No.FUN-550030-begin
                  LET g_t1=s_get_doc_no(g_apa.apa01)
                  #CALL q_apy(TRUE,FALSE,g_t1,g_aptype,g_sys) RETURNING g_t1 #TQC-670008
                  CALL q_apy(TRUE,FALSE,g_t1,g_aptype,'AAP') RETURNING g_t1  #TQC-670008
                  LET g_apa.apa01=g_t1
#No.FUN-550030-end
                  DISPLAY BY NAME g_apa.apa01
                  NEXT FIELD apa01
               WHEN INFIELD(apa06) #PAY TO VENDOR
#                 CALL q_pmc1(0,0,g_apa.apa06) RETURNING g_apa.apa06
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
    #              LET g_qryparam.form ="q_pmc1"#MOD-960121
                  LET g_qryparam.form ="q_pmc"  #MOD-960121 
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apa06
                  CALL t110_apa06('d')
               WHEN INFIELD(apa21) # Employee CODE
#                 CALL q_gen(0,0,g_apa.apa21) RETURNING g_apa.apa21
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
                  LET g_qryparam.form ="q_gen"
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apa21
               WHEN INFIELD(apa22) # Dept CODE
#                 CALL q_gem(0,0,g_apa.apa22) RETURNING g_apa.apa22
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
                  LET g_qryparam.form ="q_gem"
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apa22
               OTHERWISE EXIT CASE
            END CASE

         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE CONSTRUCT
 
         ON ACTION about         #MOD-4C0121
            CALL cl_about()      #MOD-4C0121
 
         ON ACTION help          #MOD-4C0121
            CALL cl_show_help()  #MOD-4C0121
 
         ON ACTION controlg      #MOD-4C0121
            CALL cl_cmdask()     #MOD-4C0121
 
         #No:FUN-580031 --start--     HCN
         ON ACTION qbe_select
            CALL cl_qbe_select()
         ON ACTION qbe_save
            CALL cl_qbe_save()
         #No:FUN-580031 --end--       HCN
      END CONSTRUCT
 
      IF INT_FLAG THEN
         LET INT_FLAG=0
         LET g_success = 'N'
         CLOSE WINDOW t110_w6
         RETURN
      END IF
   END IF

  #-MOD-B10239-add-
   IF g_apz.apz27 = 'N' THEN
      LET g_sql = "SELECT SUM(apa34-apa35-(apa20*apa14)) FROM apa_file",   
                  " WHERE apa41 = 'N' AND apa42 !='Y' AND ",
                  " apa00='",g_aptype,"' AND ",g_wc CLIPPED
   ELSE
      LET g_sql = "SELECT SUM(apa73-(apa20*apa72)) FROM apa_file",   
                  " WHERE apa41 = 'N' AND apa42 !='Y' AND ",
                  " apa00='",g_aptype,"' AND ",g_wc CLIPPED
   END IF
   PREPARE t110_firm1_p2 FROM g_sql
   DECLARE t110_firm1_c2 CURSOR FOR t110_firm1_p2
   OPEN t110_firm1_c2
   FETCH t110_firm1_c2 INTO l_amt
   IF cl_null(l_amt) THEN LET l_amt = 0 END IF
   DISPLAY BY NAME l_amt
  #-MOD-B10239-end-

   IF g_action_choice CLIPPED = "confirm" OR #執行 "確認" 功能(非簽核模式呼叫)
      g_action_choice CLIPPED = "insert" THEN    #FUN-640240
      IF NOT cl_confirm('aap-222') THEN
         LET g_success = 'N'
         CLOSE WINDOW t110_w6            #TQC-5B0016
         RETURN
      END IF
#CHI-C30107 -------------- add ------------- begin
      IF only_one = '1' THEN
         SELECT * INTO g_apa.* FROM apa_file WHERE apa01 = g_apa.apa01
         CALL t110_firm1_chk()
      END IF
#CHI-C30107 -------------- add ------------- end   
   END IF

   #No.MOD-5B0053 --start--
  #-MOD-B10239-mark-
  #IF g_apz.apz27 = 'N' THEN
  #  #LET g_sql = "SELECT SUM(apa34-apa35-apa20) FROM apa_file",   #TQC-780065
  #   LET g_sql = "SELECT SUM(apa34-apa35-(apa20*apa14)) FROM apa_file",   #TQC-780065
  #               " WHERE apa41 = 'N' AND apa42 !='Y' AND ",
  #               " apa00='",g_aptype,"' AND ",g_wc CLIPPED
  #ELSE
  #  #LET g_sql = "SELECT SUM(apa73-apa20) FROM apa_file",   #TQC-780065
  #   LET g_sql = "SELECT SUM(apa73-(apa20*apa72)) FROM apa_file",   #TQC-780065
  #               " WHERE apa41 = 'N' AND apa42 !='Y' AND ",
  #               " apa00='",g_aptype,"' AND ",g_wc CLIPPED
  #END IF
  ##No.MOD-5B0053 --end--
  #PREPARE t110_firm1_p2 FROM g_sql
  #DECLARE t110_firm1_c2 CURSOR FOR t110_firm1_p2
  #OPEN t110_firm1_c2
  #FETCH t110_firm1_c2 INTO l_amt
  #IF cl_null(l_amt) THEN LET l_amt = 0 END IF
  #DISPLAY BY NAME l_amt
  #-MOD-B10239-end-

  #MESSAGE "WORKING !"
   CALL cl_msg("WORKING !")                                       #FUN-640240

   LET g_sql = "SELECT * FROM apa_file",  #85-09-24
               " WHERE apa00='",g_aptype,"' AND ",g_wc CLIPPED,
               "   AND apa41 = 'N' AND apa42!='Y'"
#              "   AND apamksg = 'N'"            #MOD-590301      #FUN-640240
   PREPARE t110_firm1_p3 FROM g_sql
   DECLARE t110_firm1_c3 CURSOR FOR t110_firm1_p3

   LET g_flag='0'
   BEGIN WORK

   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa_rowid
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl firm1:", STATUS, 1)
      LET g_success='N'
      CLOSE t110_cl
      ROLLBACK WORK
      CLOSE WINDOW t110_w6    #TQC-5B0016
      RETURN
   END IF

   FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
      CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
      CLOSE t110_cl
      ROLLBACK WORK
      CLOSE WINDOW t110_w6
      RETURN
   END IF
   #No.FUN-690080 --Begin
   IF g_aptype = '13' THEN
      IF g_apa.apa37f > 0 THEN
         IF cl_null(g_apa.apa101) OR cl_null(g_apa.apa102) THEN
            CALL cl_err(g_apa.apa01,'aap-095',1)
            CLOSE t110_cl
            ROLLBACK WORK
            CLOSE WINDOW t110_w6
            CALL t110_upd_apa101()
            RETURN
         END IF
         #產生銀行異動記錄檔
         CALL t110_ins_nme_1()
         IF g_success = 'N' THEN
            CLOSE t110_cl
            ROLLBACK WORK
            CLOSE WINDOW t110_w6
            RETURN
         END IF
      END IF
   END IF
   #No.FUN-690080 --End
   LET l_flag = 0   #MOD-590301
   LET g_apa01_t = g_apa.apa01     #保留舊值 #CHI-A80031 add
   FOREACH t110_firm1_c3 INTO m_apa.*           #-->逐筆確認
      IF STATUS THEN
        #CALL cl_err('foreah',STATUS,1) #CHI-A80031 mark
         CALL s_errmsg('','','foreach',STATUS,1) #CHI-A80031
         LET g_success='N'
         LET g_totsuccess='N' #CHI-A80031 add
        #EXIT FOREACH #CHI-A80031 mark
         CONTINUE FOREACH #CHI-A80031
      ELSE    #MOD-590301
         LET l_flag = 1    #MOD-590301
      END IF

      #CHI-A80031 add --start--
      LET g_apa.apa01=m_apa.apa01
      IF only_one = '2' THEN   #CHI-B60063 add
         CALL t110_firm1_chk()
      END IF                   #CHI-B60063 add
      #CHI-A80031 add --end--
  
      #單頭原幣若 = 0 ，不可確認。
      IF m_apa.apa00 = '21' THEN
        #IF m_apa.apa34f = 0 THEN                    #CHI-B60063 mark
         IF m_apa.apa34f = 0 AND g_flag2 = 'Y' THEN  #CHI-B60063
            LET g_success='N'
            LET g_totsuccess='N' #CHI-A80031 add
            CONTINUE FOREACH
         END IF
      END IF

      IF m_apa.apa02 <= g_apz.apz57 THEN
         DISPLAY "m_apa.apa02=",m_apa.apa02
         DISPLAY "g_apz.apz57=",g_apz.apz57
        #CALL cl_err(m_apa.apa01,'aap-176',1) #CHI-A80031 mark
         CALL s_errmsg('apa01',m_apa.apa01,'','aap-176',1) #CHI-A80031
         LET g_success = 'N'
         LET g_totsuccess='N' #CHI-A80031 add
        #EXIT FOREACH #CHI-A80031 mark
         CONTINUE FOREACH #CHI-A80031
      END IF

      #No.TQC-810047  --Begin
     #IF m_apa.apa00='11' THEN
#     IF g_apa.apa00='11' AND g_apa.apa51<>'UNAP' THEN   #MOD-970115 
      IF g_apa.apa00='11' AND g_apa.apa51<>'UNAP' AND g_apa.apa56<>'5' THEN   #MOD-970115
      #No.TQC-810047  --End  
         SELECT COUNT(*) INTO g_cnt FROM apb_file WHERE apb01 = m_apa.apa01
         IF g_cnt = 0 THEN
           #CALL cl_err(m_apa.apa01,'arm-034',1) #CHI-A80031 mark
            CALL s_errmsg('apa01',m_apa.apa01,'','arm-034',1) #CHI-A80031
            LET g_success='N'
            LET g_totsuccess='N' #CHI-A80031 add
           #EXIT FOREACH #CHI-A80031 mark
            CONTINUE FOREACH #CHI-A80031
         END IF
      END IF

      LET l_amt1 = 0
      LET l_amt2 = 0
      FOR i = 1 TO 1000                 #No:MOD-480131
         LET l_arr1[i] = ' '
         LET l_arr2[i].invoice = ' '
         LET l_arr2[i].apa58   = ' '
         LET l_arr2[i].amt1    = 0
         LET l_arr2[i].amt2    = 0
      END FOR

      LET j = 1
      LET i = 0
      LET g_cnt = 0

      IF m_apa.apa00[1,1]='1' AND m_apa.apa08 = 'MISC' THEN
         SELECT COUNT(*) INTO g_cnt FROM apk_file WHERE apk01 = m_apa.apa01
         IF g_cnt = 0 THEN
           #CALL cl_err('','aap-907',1) #CHI-A80031 mark
            CALL s_errmsg('','','','aap-907',1) #CHI-A80031
            LET g_success='N'
            LET g_totsuccess='N' #CHI-A80031 add
           #EXIT FOREACH #CHI-A80031 mark
            CONTINUE FOREACH #CHI-A80031
         END IF
      END IF

      IF m_apa.apa00[1,1] = '1' THEN
         IF m_apa.apa60 > 0 AND g_apz.apz60 = 'Y' THEN
            SELECT COUNT(*) INTO g_cnt FROM apa_file
             WHERE apa00 = '21'
               AND apa08 = g_apa.apa01
            IF g_cnt > 0 THEN
               IF cl_confirm('aap-314') THEN
                  LET g_flag='1'
               END IF
            END IF

            IF g_cnt=0 THEN
               LET g_flag='2'
            END IF

            IF g_flag MATCHES '[12]' THEN
               CALL t110_21_ins(m_apa.*)
               IF INT_FLAG OR g_success='N' THEN
                  LET g_success = 'N'
                  LET g_totsuccess='N' #CHI-A80031 add
                 #CALL cl_err(m_apa.apa01,'aap-013',1) #CHI-A80031 mark
                  CALL s_errmsg('apa01',m_apa.apa01,'','aap-013',1) #CHI-A80031
                 #EXIT FOREACH #CHI-A80031
                  CONTINUE FOREACH #CHI-A80031
               END IF
            END IF
         END IF
      END IF

   #str MOD-880231 mark
   ##str MOD-850301 add
   ##回寫待抵帳款的已付金額的時機,改於確認段再回寫
   # DECLARE t110_firm1_c_apv CURSOR FOR
   #    SELECT * FROM apv_file WHERE apv01=m_apa.apa01
   #                             AND apv03!='DIFF'   #MOD-860267 add
   #
   # FOREACH t110_firm1_c_apv INTO l_apv.*
   #   IF STATUS THEN
   #      CALL cl_err('foreah',STATUS,1)
   #      LET g_success='N'
   #      EXIT FOREACH
   #   END IF
   #
   #   SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
   #     FROM aph_file,apf_file
   #    WHERE aph04=l_apv.apv03 AND aph01=apf01 AND apf41='Y'
   #      AND aph03 IN ('6','7','8','9')
   #   
   #   IF g_amt1f IS NULL THEN
   #      LET g_amt1f = 0
   #      LET g_amt1 = 0
   #   END IF
   #   
   #   SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2 FROM apv_file
   #    WHERE apv03=l_apv.apv03
   #   
   #   IF g_amt2f IS NULL THEN
   #      LET g_amt2f = 0
   #      LET g_amt2 = 0
   #   END IF
   #   
   #   SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
   #     FROM oob_file,ooa_file
   #    WHERE oob01 = ooa01
   #      AND oob06 = l_apv.apv03
   #      AND oob03 = '2' AND oob04 = '9'
   #      AND ooaconf = 'Y' #須為已確認
   #   
   #   IF cl_null(g_amt3f) THEN
   #      LET g_amt3f = 0
   #      LET g_amt3 = 0
   #   END IF
   #   
   #   #成本分攤
   #   SELECT SUM(aqb04) INTO g_amt4 FROM aqa_file,aqb_file
   #    WHERE aqa01 = aqb01 AND aqa04='Y' AND aqaconf = 'Y'
   #      AND aqb02=l_apv.apv03
   #   IF cl_null(g_amt4) THEN
   #      LET g_amt4=0
   #      LET g_amt4f=0
   #   END IF
   #   LET g_amt4f=g_amt4/m_apa.apa14
   #   
   #   LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f
   #   LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4
   #   
   #   SELECT * INTO l_apa.* FROM apa_file WHERE apa01=l_apv.apv03
   #   CALL t110_comp_oox(l_apv.apv03) RETURNING g_net
   #   LET l_apa.apa73 = l_apa.apa34 - g_amt1 + g_net
   #   
   #   UPDATE apa_file SET apa35f= g_amt1f,
   #                       apa35 = g_amt1,
   #                       apa73 = l_apa.apa73
   #    WHERE apa01 = l_apv.apv03
   #   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
   #      CALL cl_err3("upd","apa_file",l_apv.apv03,"",STATUS,"","upd apa",1)
   #      LET g_success='N'
   #   END IF
   #
   #   SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
   #     FROM aph_file,apf_file
   #    WHERE aph04=l_apv.apv03 AND aph01=apf01 AND apf41='Y'
   #      AND aph03 IN ('6','7','8','9')
   #      AND aph17 = 1
   #       
   #   IF g_amt1f IS NULL THEN
   #      LET g_amt1f = 0
   #      LET g_amt1 = 0
   #   END IF
   #   
   #   SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2 FROM apv_file
   #    WHERE apv03 =l_apv.apv03
   #   
   #   IF g_amt2f IS NULL THEN
   #      LET g_amt2f = 0
   #      LET g_amt2 = 0
   #   END IF
   #   
   #   SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
   #     FROM oob_file,ooa_file
   #    WHERE oob01 = ooa01
   #      AND oob06 = l_apv.apv03
   #      AND oob03 = '2' AND oob04 = '9'
   #      AND ooaconf = 'Y' #須為已確認
   #      AND oob19 = 1
   #   
   #   IF cl_null(g_amt3f) THEN
   #      LET g_amt3f = 0
   #      LET g_amt3 = 0
   #   END IF
   #   
   #   LET g_amt1f=g_amt1f+g_amt2f+g_amt3f
   #   LET g_amt1=g_amt1+g_amt2+g_amt3
   #   SELECT * INTO l_apc.* FROM apc_file WHERE apc01=l_apv.apv03 AND apc02 =1
   #   CALL t110_comp_oox(l_apv.apv03) RETURNING g_net
   #   LET l_apc.apc13 = l_apc.apc09 - g_amt1 + g_net
   #   UPDATE apc_file set apc10=g_amt1f,
   #                       apc11=g_amt1,
   #                       apc13=l_apc.apc13
   #    WHERE apc01 =l_apv.apv03
   #      AND apc02 =1
   # END FOREACH
   ##end MOD-850301 add
   #end MOD-880231 mark

   #str MOD-880222 mark
   ##str MOD-880080 add
   ##直接付款於確認段再更新apa35f,apa35
   # IF m_apa.apa55='2' THEN
   #    LET l_aph05f=0 LET l_aph05=0
   #    SELECT SUM(aph05f),SUM(aph05) INTO l_aph05f,l_aph05
   #      FROM aph_file WHERE aph01=m_apa.apa01
   #    IF cl_null(m_apa.apa20) THEN LET m_apa.apa20 = 0 END IF
   #    IF cl_null(l_aph05f) OR l_aph05f=0 THEN
   #       LET l_aph05f=m_apa.apa34f-m_apa.apa35f-m_apa.apa20
   #    END IF
   #    LET l_aph05f=cl_digcut(l_aph05f,t_azi04)
   #    IF cl_null(l_aph05) OR l_aph05=0 THEN
   #       IF g_apz.apz27 = 'N' THEN
   #          LET l_aph05=m_apa.apa34-m_apa.apa35-m_apa.apa20*m_apa.apa14
   #       ELSE
   #          LET l_aph05=m_apa.apa73-m_apa.apa20*m_apa.apa72
   #       END IF
   #    END IF
   #    LET l_aph05=cl_digcut(l_aph05,g_azi04)
   #    UPDATE apa_file SET apa35f= l_aph05f,
   #                        apa35 = l_aph05,
   #                        apa73 = m_apa.apa34 - l_aph05
   #      WHERE apa01 = m_apa.apa01
   #    IF SQLCA.sqlcode OR SQLCA.SQLERRD[3]=0 THEN
   #       CALL cl_err(m_apa.apa01,SQLCA.sqlcode,0)
   #       LET g_success='N'
   #    END IF
   # END IF
   ##end MOD-880080 add
   #end MOD-880222 mark

    #CHI-A40005 mark --start--
    ##-----FUN-680003---------
    ##-----CHI-750015---------
    #LET l_cnt = 0
    #SELECT COUNT(*) INTO l_cnt FROM apk_file WHERE apk01 = m_apa.apa01
    ##IF m_apa.apa00= '21' AND  m_apa.apa58 = '3' THEN
    #IF (m_apa.apa00= '21' AND  m_apa.apa58 = '3') OR 
    #   (m_apa.apa00= '21' AND  m_apa.apa58 = '2' AND 
    #    m_apa.apa08 <> 'UNAP' AND l_cnt = 0 ) THEN
    ##-----END CHI-750015-----
    ##MOD-940079 --begin                                                                                                         
        SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01 = m_apa.apa15  #MOD-C40225 remark                                                    
    #  #IF l_gec05 != 'X' THEN                           #No.FUN-990017 
    #   IF l_gec05 != 'X' AND g_aza.aza26 <> '2' THEN    #No.FUN-990017 
    ##MOD-940079  --end  
    #      CALL t110_21_ins2(m_apa.*)
    #      IF g_success='N' THEN
    #         LET g_success = 'N'
    #         CALL cl_err(m_apa.apa01,'aap-013',1)
    #         EXIT FOREACH
    #      END IF
    #   END IF #MOD-940079
    #END IF
    ##-----END FUN-680003-----
    #CHI-A40005 mark --end--
    IF m_apa.apa00[1,1] = '1' THEN
      #本幣折讓扣款金額,請款折讓
       IF m_apa.apa60 > 0 THEN
          SELECT SUM(apb14f),SUM(apb14) INTO l_apb14f,l_apb14 FROM apb_file
           WHERE apb01=m_apa.apa01

          IF cl_null(l_apb14f) THEN
             LET l_apb14f = 0
          END IF

          IF cl_null(l_apb14 ) THEN
             LET l_apb14  = 0
          END IF

         #LET l_apb14f = cl_digcut(l_apb14f,g_azi.azi04)   #MOD-6B0066
         #LET l_apb14  = cl_digcut(l_apb14 ,t_azi.azi04)   #MOD-6B0066
          LET l_apb14f = cl_digcut(l_apb14f,t_azi04)   #MOD-6B0066
          LET l_apb14  = cl_digcut(l_apb14 ,g_azi04)   #MOD-6B0066

          IF m_apa.apa33 != l_apb14 OR m_apa.apa33f !=l_apb14f THEN
             LET g_success = 'N'
             LET g_totsuccess = 'N' #CHI-A80031 add
            #CALL cl_err(m_apa.apa01,'aap-159',1) #CHI-A80031 mark
             CALL s_errmsg('apa01',m_apa.apa01,'','aap-159',1) #CHI-A80031
            #EXIT FOREACH #CHI-A80031 mark
             CONTINUE FOREACH #CHI-A80031
          END IF
       END IF

       IF m_apa.apa60 > 0 AND g_apz.apz60='Y' THEN
          DECLARE z1_curs CURSOR FOR        ## 可能多發票
           SELECT apk03,SUM(apk07+apk08) FROM apk_file
         #  WHERE apk01 = m_apa.apa01 AND apk171 IN ('21','22','25')       #MOD-9C0454 mark
            WHERE apk01 = m_apa.apa01 AND apk171 IN ('21','22','25','XX')  #MOD-9C0454
            GROUP BY apk03
           #發票金額由大至小,為免多發票:折讓金額大於第一張發票金額
            ORDER BY 2 DESC

          FOREACH z1_curs INTO l_apk.apk03,l_apk.apk07
             IF STATUS THEN
                EXIT FOREACH
             END IF                         ## 原發票金額

             LET i = i + 1
             LET l_arr2[i].invoice = l_apk.apk03
             LET l_arr2[i].amt1    = l_apk.apk07
             #----折讓單之CHECK--------

             DECLARE z2_curs CURSOR FOR   ## get multi allowence,discount #
              SELECT apk01,apa58,SUM(apk07+apk08) FROM apa_file,apk_file
            #  WHERE apk03 = l_apk.apk03 AND apk171 IN ('23','24')       #MOD-9C0454 mark
               WHERE apk03 = l_apk.apk03 AND apk171 IN ('23','24','XX')  #MOD-9C0454
                 AND apa01 = apk01
                 AND apa00 MATCHES '2*'                                  #MOD-A70229 
               GROUP BY apk01,apa58   ## 不使用 apk26 ,因為1發票 -> M 折讓

             FOREACH z2_curs INTO l_apk.apk01,l_sw,l_apk.apk07
                IF STATUS THEN
                   EXIT FOREACH
                END IF

                LET l_arr2[i].amt2 = l_arr2[i].amt2 + l_apk.apk07
                LET l_amt2 = l_amt2 + l_arr2[i].amt2

                IF l_sw = '1' THEN
                   LET l_amt1 = l_amt1+ l_arr2[i].amt2
                END IF

                FOR j = 1 TO 1000                  #No:MOD-480131
                   IF cl_null(l_arr2[j].apa58) THEN
                      IF l_sw = '1' THEN
                         LET l_arr1[j] = l_apk.apk01
                         LET g_cnt = g_cnt + 1
                      END IF
                      LET l_arr2[j].apa58 = l_sw
                      EXIT FOR
                   END IF

                   IF l_arr1[j] = l_apk.apk01 THEN
                      EXIT FOR
                   END IF
                END FOR
             END FOREACH
          END FOREACH

          LET g_apa61 = m_apa.apa61

          IF (m_apa.apa60+g_apa61) > l_amt1 THEN
            #LET g_buf = '此張單據發票折讓總金額不足'   #No:MOD-510140 改到aap-037
            #CALL cl_err('','aap-037',0)                  #No:MOD-510140 #CHI-A80031 mark
             CALL s_errmsg('','','','aap-037',1) #CHI-A80031
             LET g_success = 'N' EXIT FOREACH #CHI-A80031 mark
             LET g_success = 'N' #CHI-A80031 add
             LET g_totsuccess = 'N' #CHI-A80031 add
             CONTINUE FOREACH #CHI-A80031
          END IF

          FOR i = 1 TO 1000                #No:MOD-480131
             IF l_arr2[i].amt1 = 0 THEN
                EXIT FOR
             END IF

             IF l_arr2[i].amt1 < l_arr2[i].amt2 THEN
                LET l_apk.apk01 = ' '
                DECLARE z9_curs CURSOR FOR
                 SELECT apa01 FROM apa_file,apk_file
               #  WHERE apk03 = l_arr2[i].invoice AND apk171 IN ('23','24')       #MOD-9C0454 mark
                  WHERE apk03 = l_arr2[i].invoice AND apk171 IN ('23','24','XX')  #MOD-9C0454
                    AND apa01 = apk01
                    AND apa41 = 'N'
                OPEN z9_curs
                FETCH z9_curs INTO l_apk.apk01
                CLOSE z9_curs
               #LET g_buf = l_apk.apk01,':此折讓單折讓金額超過'  #No:MOD-510140 add aap-045
               #CALL cl_err(l_apk.apk01,'aap-045',0)     #No:MOD-510140 #CHI-A80031 mark
                CALL s_errmsg('apk01',l_apk.apk01,'','aap-045',1) #CHI-A80031
                LET g_success = 'N'
                LET g_totsuccess = 'N' #CHI-A80031 add
               #EXIT FOREACH #CHI-A80031 mark
                CONTINUE FOREACH #CHI-A80031
             END IF
          END FOR

          FOR i = 1 TO 1000                      #No:MOD-480131
              IF cl_null(l_arr2[i].apa58) THEN
                 EXIT FOR
              END IF

              IF l_arr2[i].apa58 <> '1' THEN   ## 非請款折讓(系統產生)
                 CONTINUE FOR
              END IF

              IF g_cnt > 1 OR   ## 1 請款單 -> M折讓單(apa58 = '1')
                 (m_apa.apa60 + m_apa.apa61) = l_amt1 THEN
                                   ## 1 SP -> 1 SL(apa58 = '1')
                 CALL t110_comp_oox(l_arr1[i]) RETURNING g_net              #CHI-890017 add
                #UPDATE apa_file SET apa35f=apa34f,apa35=apa34,apa73=0      #CHI-890017 mark
                 UPDATE apa_file SET apa35f=apa34f,apa35=apa34,apa73=g_net  #CHI-890017
                  WHERE apa01 = l_arr1[i] AND apa41 = 'Y'
                 IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN
                    #LET g_buf = l_arr1[i],':此折讓單尚未確認更新有誤_1'
#                   CALL cl_err(l_arr1[i],'aap-046',0)              #No:MOD-510140 add aap-046   #No.FUN-660122
                   #CALL cl_err3("upd","apa_file",l_arr1[i],"","aap-046","","",1)  #No.FUN-660122 #CHI-A80031 mark
                    CALL s_errmsg('',l_arr1[i],'upd apa_file','aap-046',1) #CHI-A80031
                    LET g_success = 'N'
                    LET g_totsuccess = 'N' #CHI-A80031 mark
                   #EXIT FOREACH #CHI-A80031 mark
                    CONTINUE FOREACH #CHI-A80031
                 END IF
              END IF

              IF g_cnt = 1 AND (m_apa.apa60+m_apa.apa61) < l_amt1 THEN
                 #No.MOD-590312  --begin
                 CALL t110_comp_oox(l_arr1[i]) RETURNING g_net
                 UPDATE apa_file SET apa35f=apa35f+ m_apa.apa60f
                                                  + m_apa.apa61f ,
                                     apa35 =apa35 + m_apa.apa60
                                                  + m_apa.apa61,
                                     apa73 =apa34 -(apa35+m_apa.apa60      #No:MOD-4C0008
                                                         +m_apa.apa61) 
                                                  + g_net
                 #No.MOD-590312  --end
                  WHERE apa01 = l_arr1[i] AND apa41 = 'Y'
                 IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN
                    #LET g_buf = l_arr1[i],':此折讓單尚未確認更新有誤_2'
#                   CALL cl_err(l_arr1[i],'aap-047',0)              #No:MOD-510140 add aap-047   #No.FUN-660122
                   #CALL cl_err3("upd","apa_file",l_arr1[i],"","app-047","","",1)  #No.FUN-660122 #CHI-A80031 mark
                    CALL s_errmsg('',l_arr1[i],'upd apa_file','aap-047',1) #CHI-A80031
                    LET g_success = 'N'
                    LET g_totsuccess = 'N' #CHI-A80031 add
                   #EXIT FOREACH #CHI-A80031 mark
                    CONTINUE FOREACH #CHI-A80031
                 END IF
              END IF
          END FOR
       END IF
    ELSE
       DECLARE z3_curs CURSOR FOR
        SELECT UNIQUE apk03 FROM apk_file
        #WHERE apk01 = m_apa.apa01 AND apk171 IN ('23','24')   #MOD-6B0051
         WHERE apk01 = m_apa.apa01 AND apk171 IN ('23','24','29','XX')   #MOD-6B0051

       FOREACH z3_curs INTO l_apk.apk03
 #MOD-560240
          IF cl_null(l_apk.apk03) THEN
             CONTINUE FOREACH
          END IF
 #END MOD-560240
          IF STATUS THEN
             EXIT FOREACH
          END IF                      ## 可能一發票折多次,故須判斷其他 SL

          SELECT SUM(apk07+apk08) INTO l_arr2[1].amt1 FROM apk_file
          #WHERE apk03 = l_apk.apk03 AND apk171 IN ('23','24')   #MOD-6B0051
           WHERE apk03 = l_apk.apk03 AND apk171 IN ('23','24','29')   #MOD-6B0051
          IF STATUS <> 0 OR l_arr2[1].amt1 IS NULL THEN
             LET l_arr2[1].amt1 = 0
          END IF
          #-----MOD-6B0051---------
          SELECT SUM(apk07+apk08) INTO l_amt3 FROM apk_file,apa_file
           WHERE apk03 = l_apk.apk03 AND apk171 = 'XX'
             AND apk01 = apa01 AND apa00 MATCHES "2*"
          IF STATUS <> 0 OR l_amt3 IS NULL THEN
             LET l_amt3 = 0
          END IF
          LET l_arr2[1].amt1 = l_arr2[1].amt1 + l_amt3
          #-----END MOD-6B0051-----

         #-----FUN-680003---------
         SELECT COUNT(*) INTO l_cnt FROM apk_file
          #WHERE apk03=l_apk.apk03 AND apk171 IN ('21','22','25')   #MOD-6B0051
           WHERE apk03=l_apk.apk03 AND apk171 IN ('21','22','25','28','XX')   #MOD-6B0051
         IF l_cnt > 0 THEN
         #-----END FUN-680003-----
            ## 原發票金額
            SELECT SUM(apk07+apk08) INTO l_arr2[1].amt2 FROM apk_file
             #WHERE apk03 = l_apk.apk03 AND apk171 IN ('21','22','25')   #MOD-6B0051
              WHERE apk03 = l_apk.apk03 AND apk171 IN ('21','22','25','28')   #MOD-6B0051

            IF STATUS <> 0 OR l_ARR2[1].amt2 IS NULL THEN
               LET l_arr2[1].amt2 = 0
            END IF
         #-----FUN-680003---------
            #-----MOD-6B0051---------
            SELECT SUM(apk07+apk08) INTO l_amt4 FROM apk_file,apa_file
             WHERE apk03 = l_apk.apk03 AND apk171 = 'XX'
               AND apk01 = apa01 AND apa00 MATCHES "1*"
            IF STATUS <> 0 OR l_amt4 IS NULL THEN
               LET l_amt4 = 0
            END IF
            LET l_arr2[1].amt2 = l_arr2[1].amt2 + l_amt4
            #-----END MOD-6B0051-----
         ELSE
            SELECT SUM(amd07+amd08) INTO l_arr2[1].amt2 FROM amd_file
            #WHERE amd03 = l_apk.apk03 AND amd171 IN ('21','22','25')   #MOD-6B0051
             WHERE amd03 = l_apk.apk03 AND amd171 IN ('21','22','25','28')   #MOD-6B0051
            IF STATUS <> 0 OR l_ARR2[1].amt2 IS NULL THEN
               LET l_arr2[1].amt2 = 0
            END IF
         END IF
         #-----END FUN-680003-----

         IF g_aza.aza26 !='2' THEN   #No.TQC-790158 ---add----
            IF l_arr2[1].amt1 > l_arr2[1].amt2 THEN
              #LET g_buf = l_apk.apk03,':此發票折讓總金額超過發票金額:',
              #                          l_arr2[1].amt1 USING '#######.&',' > ',
              #                          l_arr2[1].amt2 USING '#######.&'
              #MOD-9A0093   ---start
               IF m_apa.apa00<>'21' OR l_gec05 !='X' THEN 
                 #CALL cl_err(l_apk.apk03,'aap-052',0)  #CHI-A80031 mark
                  CALL s_errmsg('apk03',l_apk.apk03,'','aap-052',1) #CHI-A80031
                  LET g_success = 'N'
                  LET g_totsuccess = 'N'  #CHI-A80031 add
                 #EXIT FOREACH #CHI-A80031 mark
                  CONTINUE FOREACH #CHI-A80031
               ELSE 
                  LET l_cnt=0 
                  SELECT COUNT(*) INTO l_cnt FROM apa_file,apb_file 
                   WHERE apa01=apb01 AND apa01=m_apa.apa01
                     AND apb06 IS NOT NULL 
                 #IF l_cnt<>0 THEN                   #MOD-C40225 mark 
                  IF l_cnt=0 AND l_gec05 ='X'  THEN  #MOD-C40225 
                    #CALL cl_err(l_apk.apk03,'aap-052',0)    #CHI-A80031 mark
                     CALL s_errmsg('apk03',l_apk.apk03,'','aap-052',1) #CHI-A80031
                     LET g_success = 'N'
                     LET g_totsuccess = 'N'  #CHI-A80031 add
                    #EXIT FOREACH #CHI-A80031 mark
                     CONTINUE FOREACH #CHI-A80031
                  END IF
               END IF  
              #CALL cl_err(l_apk.apk03,'aap-052',0)            #No:MOD-510140 add aap-052
              #LET g_success = 'N'
              #EXIT FOREACH
              #MOD-9A0093   ---end    
            END IF
         END IF   #No.TQC-790158 ---add----
       END FOREACH
 
       IF g_success = 'N' THEN
         #EXIT FOREACH #CHI-A80031 mark
          CONTINUE FOREACH #CHI-A80031
       END IF
    END IF

    IF m_apa.apa20 > (m_apa.apa34f - m_apa.apa35f) THEN
      #CALL cl_err(m_apa.apa01,'aap-150',0) #CHI-A80031 mark
       CALL s_errmsg('apa01',m_apa.apa01,'','aap-150',1) #CHI-A80031
       LET g_success = 'N'
       LET g_totsuccess = 'N'  #CHI-A80031 add
      #EXIT FOREACH #CHI-A80031 mark
       CONTINUE FOREACH #CHI-A80031
    END IF

    #檢查分錄底稿平衡正確否
    LET g_t1=s_get_doc_no(g_apa.apa01)  #No.FUN-550030
    SELECT * INTO g_apy.* FROM apy_file WHERE apyslip=g_t1
#   IF g_apy.apydmy3 = 'Y' THEN  #No.FUN-670060
  # IF g_apy.apydmy3 = 'Y' AND g_apy.apyglcr = 'N' THEN  #No.FUN-670060  #MOD-940069
   #IF g_apy.apydmy3 = 'Y' THEN                     #MOD-940069   #CHI-B60063 mark
    IF g_apy.apydmy3 = 'Y' AND g_flag2 = 'Y' THEN   #MOD-940069   #CHI-B60063
      #IF g_apa.apa58 <> '1' THEN                                 #TQC-C90078 add #TQC-D10065 mark
       IF g_apa.apa58 <> '1' OR cl_null(g_apa.apa58) THEN         #TQC-D10065 add 
          CALL s_chknpq(m_apa.apa01,'AP',1,'0',g_bookno1)         #No.FUN-680029    #No.FUN-730064
#No.FUN-680029--begin
          IF g_aza.aza63 ='Y' AND g_success ='Y' THEN
             CALL s_chknpq(m_apa.apa01,'AP',1,'1',g_bookno2)     #No.FUN-730064 
          END IF
       END IF                    #TQC-C90078 add
#No.FUN-680029--end
    END IF

    IF g_success = 'N' THEN
      #EXIT FOREACH #CHI-A80031 mark
       CONTINUE FOREACH #CHI-A80031
    END IF

    #No.FUN-690080 --Begin
    IF NOT (g_aptype = '13' OR g_aptype = '17') THEN
       #--------------------------------- 請採購預算控管 00/03/30 By Melody
       IF g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' AND g_success='Y' THEN
          CALL t110_budchk()
#No.FUN-680029--begin
          IF g_aza.aza63 ='Y' AND g_success ='Y' THEN
             CALL t110_budchk_1()
          END IF
#No.FUN-680029--end
       END IF
    END IF
    #No.FUN-690080 --End

    IF g_success = 'N' THEN
      #EXIT FOREACH #CHI-A80031 mark
       CONTINUE FOREACH #CHI-A80031
    END IF

    #----------------------------------- 預付待抵產生 96-10-07
    IF m_apa.apa00= '15' OR m_apa.apa00 = '17' THEN  #No.FUN-690080
       CALL t110_ins_prepaid()
    END IF

    #-----MOD-680036---------
    #除了非沖暫估且不直接付款的情況,其於皆要insert apf_file
    #No.TQC-7B0083  --Begin
    LET l_cnt1 =0
    SELECT COUNT(*) INTO l_cnt1 FROM apb_file
     WHERE apb01 = m_apa.apa01
       AND apb34 = 'Y' 
    IF cl_null(l_cnt1) THEN LET l_cnt1 = 0 END IF
    #No.TQC-7B0083  --End  
   #IF m_apa.apa51='UNAP' OR m_apa.apa55='2' OR l_cnt1>0 THEN  #No.TQC-7B0083     #MOD-8C0067 mark
    IF m_apa.apa51='UNAP' OR m_apa.apa55='2' OR l_cnt1>0 OR m_apa.apa56='5' THEN  #MOD-8C0067
       CALL t110_ins_apf()
    END IF
    #-----END MOD-680036-----

    #----------------------------------- 沖暫估AP 97-07-19 Roger
   #IF m_apa.apa51= 'UNAP' OR l_cnt1 > 0 THEN  #No.TQC-7B0083       #MOD-8C0067 mark
    IF m_apa.apa51= 'UNAP' OR l_cnt1 > 0 OR m_apa.apa56 = '5' THEN  #MOD-8C0067
       #no.5902 檢查沖暫估金額是否與單頭金額相等
       SELECT SUM(api05) INTO l_api05 FROM api_file
        WHERE api01 = m_apa.apa01
          AND api02 = '2'   #MOD-850155

       IF cl_null(l_api05) THEN
          LET l_api05 = 0
       END IF

       #FUN-680010
       LET l_apb10=0
       #No.TQC-7B0083  --Begin
       #SELECT SUM(apb10) INTO l_apb10 FROM apb_file,rvv_file
       # WHERE apb01=g_apa.apa01
       #   AND rvv01=apb21 AND rvv02=apb22
       #   AND rvv40='N'
       SELECT SUM(apb10) INTO l_apb10 FROM apb_file
        WHERE apb01=g_apa.apa01
          AND apb34='N'
       #No.TQC-7B0083  --End  
       IF cl_null(l_apb10) THEN LET l_apb10=0 END IF
       #--
      #IF (m_apa.apa31 - m_apa.apa60) != l_api05 THEN 
      #IF (m_apa.apa31 - m_apa.apa60) -l_apb10 != l_api05 THEN #FUN-680010  #No.TQC-7B0083
      #差異處理是3:折讓時,apa60和apa33會同時有值存在,造成重複扣除差異金額,
      #所以判斷式不需扣掉折讓金額
      #IF (m_apa.apa31 - m_apa.apa60 - m_apa.apa33 ) -l_apb10 != l_api05 THEN #FUN-680010  #No.TQC-7B0083  #MOD-8A0129 mark
       IF (m_apa.apa31 - m_apa.apa33 ) -l_apb10 != l_api05 THEN #FUN-680010  #No.TQC-7B0083                #MOD-8A0129
         #CALL cl_err(m_apa.apa01,'aap-030',1) #CHI-A80031 mark
          CALL s_errmsg('apa01',m_apa.apa01,'','aap-030',1) #CHI-A80031
          LET g_success='N'
          LET g_totsuccess='N' #CHI-A80031 add
         #EXIT FOREACH #CHI-A80031 mark
          CONTINUE FOREACH #CHI-A80031
       END IF
   #str MOD-880080 add
    END IF
   #IF m_apa.apa51 = 'UNAP' OR m_apa.apa55 = '2' OR l_cnt1 > 0 THEN  #No.TQC-7B0083   #TQC-890010 mark
   #IF m_apa.apa51 = 'UNAP' OR l_cnt1 > 0 THEN  #No.TQC-7B0083                        #TQC-890010  #MOD-8C0067 mark
    IF m_apa.apa51 = 'UNAP' OR l_cnt1 > 0 OR m_apa.apa56 = '5' THEN                                #MOD-8C0067
   #end MOD-880080 add
       CALL t110_ins_apg()              #MOD-880080 mark   #TQC-890010 mark回復
      #CALL t110_ins_apg(m_apa.apa51)   #MOD-880080        #TQC-890010 mark
    END IF

    #-----MOD-680036---------
    ##----------------------------------- 直接付款 97-08-27 Roger
    #IF m_apa.apa55='2' THEN
    #   CALL t110_ins_apf()
    #END IF
    #-----END MOD-680036-----

    #----------------------------------- 直接付款沖待抵帳款 97-09-11 Roger
    IF m_apa.apa55='2' THEN
       CALL t110_aph_upd(1)
    END IF
 
    #-----FUN-680003---------
    ##MOD-4B0308
    #IF m_apa.apa00= '21' AND  m_apa.apa58 = '3' THEN
    #   CALL t110_21_ins2(m_apa.*)
    #   IF g_success='N' THEN
    #      LET g_success = 'N'
    #      CALL cl_err(m_apa.apa01,'aap-013',1)
    #      EXIT FOREACH
    #   END IF
    #END IF
    ##--
    #-----END FUN-680003-----
#No.TQC-7B0100 --begin
#     #FUN-580012  --begin
#     LET g_t1 = s_get_doc_no(g_apa.apa01)
#     SELECT apydmy6 INTO g_apy.apydmy6 FROM apy_file WHERE apyslip = g_t1
#     IF g_aza.aza26 != '2' OR g_aptype[1,1]!='2' OR g_apy.apydmy6!='Y' THEN
#        SELECT SUM(apg05f),SUM(apg05) INTO m_apa.apa35f,m_apa.apa35
#          FROM apg_file,apf_file
#         WHERE apg04=m_apa.apa01 AND apg01=apf01 AND apf41='Y'
#
#        IF m_apa.apa35f IS NULL THEN
#           LET m_apa.apa35f = 0
#        END IF
#
#        IF m_apa.apa35  IS NULL THEN
#           LET m_apa.apa35  = 0
#        END IF
#     END IF
#     #FUN-580012  --end
#No.TQC-7B0100 --end
#-----MOD-7B0180---------
#    #No.MOD-590312  --begin
#    CALL t110_comp_oox(m_apa.apa01) RETURNING g_net
#    LET m_apa.apa73 = m_apa.apa34-m_apa.apa35 + g_net
#    #No.MOD-590312  --end
#-----END MOD-7B0180-----

     #No.FUN-670060 --start--
    #IF g_apy.apydmy3 = 'Y' AND g_apy.apyglcr = 'Y' THEN                    #CHI-B60063 mark
     IF g_apy.apydmy3 = 'Y' AND g_apy.apyglcr = 'Y' AND g_flag2 = 'Y' THEN  #CHI-B60063
        SELECT COUNT(*) INTO l_n FROM npq_file
         WHERE npq01 = m_apa.apa01
           AND npqsys = 'AP'
           AND npq00 = 1
           AND npq011 = 1
        IF l_n = 0 THEN
           CALL t110_gen_glcr(m_apa.*,g_apy.*)
        END IF
        IF g_success = 'Y' THEN                                                                                                       
          #IF g_apa.apa58 <> '1' THEN                                 #TQC-C90078 add #TQC-D10065 mark
           IF g_apa.apa58 <> '1' OR cl_null(g_apa.apa58) THEN         #TQC-D10065 add 
              CALL s_chknpq(m_apa.apa01,'AP',1,'0',g_bookno1)     #No.FUN-680029   #No.FUN-730064                                   
          #No.FUN-680029--begin
              IF g_aza.aza63 ='Y' THEN
                 CALL s_chknpq(m_apa.apa01,'AP',1,'1',g_bookno2)    #No.FUN-730064
              END IF
           END IF                        #TQC-C90078 add
          #No.FUN-680029--end
        END IF   
      #-----------------------------------------------MOD-C50093--------------------------------mark
      ##-----------------------CHI-C20003------------------stat                                                                                                                     
      # IF g_success = 'Y' THEN  
      #    LET g_wc_gl = " npp01='",g_apa.apa01,"'"
      #    LET l_wc = g_wc_gl clipped," AND npp011 = 1 "
      #    LET g_str = "aapp400" ,
      #                ' "',l_wc CLIPPED,'"',
      #                ' "',g_apa.apauser,'"',   
      #                ' "',g_apa.apauser,'"',   
      #                ' "',g_apz.apz02p,'" ',
      #                ' "',g_apz.apz02b,'" ',
      #                ' "',g_apy.apygslp,'" ',
      #                ' "',g_apa.apa02,'" ',
      #                ' "Y" ',
      #                ' "1" ',  
      #                ' "Y" ',
      #                ' "',g_apz.apz02c,'" ',
      #                ' "',g_apy.apygslp1,'" ',
      #                ' "Y" '                    
      #    CALL cl_cmdrun(g_str CLIPPED)  
      # END IF
      ##-----------------------CHI-C20003--------------------end                                                                                                                     
        LET l_apa01_arr[l_arr_i].apa01 = g_apa.apa01              #MOD-C50093 add
        LET l_arr_i = l_arr_i + 1                                 #MOD-C50093 add
      #-----------------------------------------------MOD-C50093--------------------------------mark
     END IF
    #IF g_success ='N' THEN EXIT FOREACH END IF           #No.FUN-680029 #CHI-A80031 mark
     IF g_success ='N' THEN CONTINUE FOREACH END IF           #No.FUN-680029 #CHI-A80031

     #No.FUN-670060 --end--

     UPDATE apa_file SET apa41 = 'Y',
                         apa63 = '1'    #MOD-590301
#                        apa35f= m_apa.apa35f,   #No.TQC-7B0100
#                        apa35 = m_apa.apa35,   #No.TQC-7B0100
#                        apa73 = m_apa.apa73   #No.TQC-7B0100
      WHERE apa01=m_apa.apa01
     #IF STATUS OR SQLCA.SQLCODE THEN   #MOD-730098
     IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
#       CALL cl_err('up_apa41',SQLCA.SQLCODE,1)   #No.FUN-660122
       #CALL cl_err3("upd","apa_file",m_apa.apa01,"",SQLCA.sqlcode,"","up_apa41",1)  #No.FUN-660122 #CHI-A80031 mark
        CALL s_errmsg('apa01',m_apa.apa01,'up_apa41',SQLCA.sqlcode,1) #CHI-A80031
        LET g_success='N'
        LET g_totsuccess='N' #CHI-A80031 add
       #EXIT FOREACH #CHI-A80031 mark
        CONTINUE FOREACH #CHI-A80031
     END IF
   END FOREACH
   LET g_apa.apa01 = g_apa01_t #CHI-A80031 add
#MOD-590301
   IF l_flag = 0 THEN
      CALL cl_err('',100,1)
      LET g_success = 'N'   #FUN-890128
      LET g_totsuccess = 'N' #CHI-A80031 add
   END IF
#END MOD-590301
   IF INT_FLAG THEN
      LET INT_FLAG=0
   END IF
  #CHI-A80031 add --start--
  IF g_totsuccess = 'N' THEN
     LET g_success = 'N'
  END IF
  #CHI-A80031 add --end--

 ### MOD-4A0253 ###
#     IF g_success = 'Y' AND g_apa.apamksg = 'Y' AND g_apa.apa41 = 'N' THEN  #暫時mark
              ### MOD-4B0002 ###
              ### MOD-4B0277 ###
         {    LET l_cnt=0
             SELECT COUNT(*) INTO l_cnt
               FROM apb_file
              WHERE apb01=g_apa.apa01
             IF l_cnt=0 OR l_cnt IS NULL THEN
                CALL cl_err('','aws-065',0)
                LET g_success = 'N'
             ELSE
         }
#               CALL t110_ef()   #暫時mark

         #    END IF
              ### END MOD-4B0277 ###
              ### END MOD-4B0002 ###
#      END IF    #暫時mark
   IF l_flag = '1' THEN   #MOD-590301
   IF g_success = 'Y' THEN
      IF g_apa.apamksg = 'Y' THEN #簽核模式
         CASE aws_efapp_formapproval()            #呼叫 EF 簽核功能
              WHEN 0  #呼叫 EasyFlow 簽核失敗
                   LET g_apa.apa41="N"
                   LET g_success = "N"
                   ROLLBACK WORK
                   CLOSE WINDOW t110_w6        #TQC-5B0016
                   RETURN
              WHEN 2  #當最後一關有兩個以上簽核者且此次簽核完成後尚未結案
                   LET g_apa.apa41="N"
                   ROLLBACK WORK
                   CLOSE WINDOW t110_w6    #TQC-5B0016
                   RETURN
         END CASE
      END IF
      IF g_success='Y' THEN
         LET g_apa.apa63='1'              #執行成功, 狀態值顯示為 '1' 已核准
         LET g_apa.apa41='Y'              #執行成功, 確認碼顯示為 'Y' 已確認
#MOD-590301
#         UPDATE apa_file SET (apa41,apa63) = (g_apa.apa41,g_apa.apa63)
#          WHERE apa01 = m_apa.apa01
#         IF STATUS THEN
#            CALL cl_err('upd apa63',STATUS,1)
#            LET g_success = 'N'
#            CLOSE WINDOW t110_w6    #TQC-5B0016
#            RETURN
#         END IF
#END MOD-590301
         DISPLAY BY NAME g_apa.apa41
         DISPLAY BY NAME g_apa.apa63
         COMMIT WORK
         CALL cl_flow_notify(g_apa.apa01,'Y')
      ELSE
         LET g_apa.apa41='N'
         LET g_success = 'N'
         ROLLBACK WORK
      END IF
   ELSE
      LET g_apa.apa41='N'
      LET g_success = 'N'
      ROLLBACK WORK
   END IF
   END IF   #MOD-590301

#    IF g_apa.apamksg = 'N' THEN
#      LET g_apa.apa63='1'
#      LET g_apa.apa41='Y'
#      UPDATE apa_file SET (apa41,apa63) = (g_apa.apa41,g_apa.apa63)
#       WHERE apa01 = m_apa.apa01
#      IF STATUS THEN
#         CALL cl_err('upd apa63',STATUS,1)
#         LET g_success = 'N'
#         CLOSE WINDOW t110_w6    #TQC-5B0016
#         RETURN
#      END IF
#    END IF
#    COMMIT WORK
#    CALL cl_flow_notify(g_apa.apa01,'Y')
 ### END MOD-4A0253 ###
#   ELSE
#      ROLLBACK WORK
#   END IF


 #------------------------CHI-C20003-移至28701行--------------------------------------mark
 ##No.FUN-670060 --start--
 ##IF g_apy.apydmy3 = 'Y' AND g_apy.apyglcr = 'Y' AND g_success = 'Y' THEN                    #CHI-B60063 mark
 # IF g_apy.apydmy3 = 'Y' AND g_apy.apyglcr = 'Y' AND g_success = 'Y' AND g_flag2 = 'Y' THEN  #CHI-B60063
 #   #No.MOD-7A0006-----begin
 #   #LET g_wc_gl = 'npp01 = "',g_apa.apa01,'" AND npp011 = 1'
 #   #LET g_str="aapp400 '",g_wc_gl CLIPPED,"' '",g_user,"' '",g_user,"' '",g_apz.apz02p,"' '",g_apz.apz02b,"' '",g_apy.apygslp,"' '",g_apa.apa02,"' 'Y' '0' 'Y' '",g_apz.apz02c,"' '",g_apy.apygslp1,"'"
 #   #CALL cl_cmdrun_wait(g_str)
 #    LET g_wc_gl = " npp01='",g_apa.apa01,"'"
 #    LET l_wc = g_wc_gl clipped," AND npp011 = 1 "
 #    LET g_str = "aapp400" ,
 #                ' "',l_wc CLIPPED,'"',
 #               #' "',g_user,'"',   #MOD-7B0159
 #               #' "',g_user,'"',   #MOD-7B0159
 #                ' "',g_apa.apauser,'"',   #MOD-7B0159
 #                ' "',g_apa.apauser,'"',   #MOD-7B0159
 #                ' "',g_apz.apz02p,'" ',
 #                ' "',g_apz.apz02b,'" ',
 #                ' "',g_apy.apygslp,'" ',
 #                ' "',g_apa.apa02,'" ',
 #                ' "Y" ',
 #               #' "0" ',  #No.MOD-860075
 #                ' "1" ',  #No.MOD-860075
 #                ' "Y" ',
 #                ' "',g_apz.apz02c,'" ',
 #                ' "',g_apy.apygslp1,'" ',
 #                ' "Y" '                    #MOD-B10041
 #    CALL cl_wait()
 #   #CALL cl_cmdrun(g_str CLIPPED)   #MOD-7B0209
 #    CALL cl_cmdrun_wait(g_str CLIPPED)   #MOD-7B0209
 #   #No.MOD-7A0006-----end
 #   #MOD-780129....................mark begin #移到下面做
 #   #SELECT apa44,apa43 INTO g_apa.apa44,g_apa.apa43 FROM apa_file 
 #   # WHERE apa01 = g_apa.apa01
 #   #DISPLAY BY NAME g_apa.apa44
 #   #MOD-780129....................mark end
 # END IF 
 ##No.FUN-670060 --end--
 #------------------------CHI-C20003-移至28701行--------------------------------------mark
  IF g_success = 'Y' THEN                        #MOD-C50243 add
 #-----------------------MOD-C50093------------------(S)
    #CALL s_showmsg_init()                       #MOD-C50243 mark
     LET l_arr_cnt = l_arr_i - 1
     LET l_wc = NULL   #MOD-DA0157
     FOR l_arr_i = 1 TO l_arr_cnt
      IF NOT cl_null(l_apa01_arr[l_arr_i].apa01) AND g_success = 'Y' THEN
         #MOD-DA0157--add--str--
         IF cl_null(l_wc) THEN
            LET l_wc = ' npp011 = 1 AND npp01 IN ("',l_apa01_arr[l_arr_i].apa01,'"'
         ELSE
            LET l_wc = l_wc,',"',l_apa01_arr[l_arr_i].apa01,'"'
         END IF
         #MOD-DA0157--add--end
         #MOD-DA0157--mark--str--批次確認只需要show一次起訖憑證編號
        #LET g_wc_gl = " npp01='",l_apa01_arr[l_arr_i].apa01,"'"
        #LET l_wc = g_wc_gl clipped," AND npp011 = 1 "
        #LET g_str = "aapp400" ,
        #            ' "',l_wc CLIPPED,'"',
        #            ' "',g_apa.apauser,'"',
        #            ' "',g_apa.apauser,'"',
        #            ' "',g_apz.apz02p,'" ',
        #            ' "',g_apz.apz02b,'" ',
        #            ' "',g_apy.apygslp,'" ',
        #            ' "',g_apa.apa02,'" ',
        #            ' "Y" ',
        #            ' "1" ',
        #            ' "Y" ',
        #            ' "',g_apz.apz02c,'" ',
        #            ' "',g_apy.apygslp1,'" ',
        #            ' "Y" '
        #IF g_apa.apa58 <> '1' THEN   #TQC-C90078 add
        #   CALL cl_cmdrun_wait(g_str CLIPPED)
        #END IF                       #TQC-C90078 add
        #MOD-DA0157--mark--end
      END IF
     END FOR
     #MOD-DA0157--add--str-- 批次確認時只要show一次起訖憑證編號
     LET l_wc = l_wc,')'
     LET g_str = "aapp400 '",l_wc CLIPPED,
                 "' '",g_apa.apauser,
                 "' '",g_apa.apauser,
                 "' '",g_apz.apz02p,
                 "' '",g_apz.apz02b,
                 "' '",g_apy.apygslp,
                 "' '",g_apa.apa02,
                 "' 'Y' '1' 'Y' '",g_apz.apz02c,
                 "' '",g_apy.apygslp1,"' 'Y'"
    IF g_apa.apa58 <> '1' OR cl_null(g_apa.apa58) THEN
       CALL cl_cmdrun_wait(g_str CLIPPED)
    END IF
    #MOD-DA0157--add--end--
  END IF                                        #MOD-C50243 add
  CALL s_showmsg()
  #-----------------------MOD-C50093------------------(S)

   #FUN-640240
   IF g_action_choice CLIPPED = "confirm" OR #執行 "確認" 功能(非簽核模式呼叫)
      g_action_choice CLIPPED = "insert"
   THEN
      CLOSE WINDOW t110_w6
   END IF
   #END FUN-640240

   IF l_flag = 1 THEN   #MOD-590301
 ### MOD-4A0253 ###

   IF g_apa_rowid IS NOT NULL THEN
      SELECT apa41,apa35f,apa35,apa63,apa43,apa44  #MOD-780129 
        INTO g_apa.apa41,g_apa.apa35f,g_apa.apa35,g_apa.apa63,
             g_apa.apa43,g_apa.apa44 #MOD-780129
        FROM apa_file WHERE apa01 = m_apa.apa01
      DISPLAY BY NAME g_apa.apa41,g_apa.apa35f,g_apa.apa35,g_apa.apa63
      DISPLAY BY NAME g_apa.apa44 #MOD-780129
      CALL t110_unpay()
   END IF
 ### END MOD-4A0253 ###
#FUN-550042
#   IF g_aptype = '11' OR g_aptype = '12' THEN
#     IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
#     CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti)
#   ELSE
#      CALL cl_set_field_pic(g_apa.apa41,"","","",g_apa.apa42,g_apa.apaacti)
#   END IF
#END FUN-550042

   SELECT * INTO g_apa.* FROM apa_file WHERE apa01 = g_apa.apa01
   IF g_apa.apa41='X' THEN LET g_chr='Y' ELSE LET g_chr='N' END IF
   IF g_apa.apa63='1' OR
      g_apa.apa63='2' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
   IF g_apa.apa63='6' THEN LET g_chr3='Y' ELSE LET g_chr3='N' END IF
   CALL cl_set_field_pic(g_apa.apa41,g_chr2,"",g_chr3,g_chr,g_apa.apaacti)
   END IF   #MOD-590301

   #--------#No:FUN-960117 EBO add start --------
   IF g_aza.aza75 MATCHES '[Yy]' AND (g_prog='aapt110' OR g_prog='aapt120') THEN
      CALL aws_ebocli(g_dbs,g_apa.apa01,'*','*','*','*','EBO-120','M010','qry_maxver') RETURNING l_maxkey2
      CALL aws_ebocli(g_dbs,g_apa.apa01,l_maxkey2,'*','*','*','EBO-120','M010','show_transfer')
   END IF
   #--------#No:FUN-960117 EBO add  end   --------

END FUNCTION
#FUN-580114 End

#------- 請採購預算控管 00/03/29 By Melody
FUNCTION t110_budchk()
    DEFINE l_apb    RECORD LIKE apb_file.*
    DEFINE l_pnr05  LIKE pnr_file.pnr05
    DEFINE l_bud    LIKE type_file.num5      # No:FUN-690028 SMALLINT
    DEFINE over_amt LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
    DEFINE last_amt LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
    DEFINE l_msg    LIKE ze_file.ze03    # No:FUN-690028 VARCHAR(30)
    #No.FUN-830161  --Begin
    DEFINE p_sum1    LIKE afc_file.afc07
    DEFINE p_sum2    LIKE afc_file.afc07
    DEFINE l_flag    LIKE type_file.num5
    DEFINE l_over    LIKE afc_file.afc07
    DEFINE l_bookno1 LIKE aaa_file.aaa01
    DEFINE l_bookno2 LIKE aaa_file.aaa01
    #No.FUN-830161  --End
    DEFINE l_year    LIKE type_file.num5  #MOD-A30113 add
    DEFINE l_month   LIKE type_file.num5  #MOD-A30113 add
    DEFINE l_aag21   LIKE aag_file.aag21  #MOD-B20152  

    DECLARE bud_cur CURSOR FOR
       SELECT * FROM apb_file WHERE apb01=g_apa.apa01

    FOREACH bud_cur INTO l_apb.*
      #-MOD-B20152-add-
       IF cl_null(l_apb.apb25) THEN
          CONTINUE FOREACH
       END IF
       SELECT aag21 INTO l_aag21 
         FROM aag_file
        WHERE aag01 = l_apb.apb25 
          AND aag00 = g_bookno1   
          AND aagacti = 'Y'     #No.MOD-B70280 add 
       IF l_aag21 = 'N' THEN       
          CONTINUE FOREACH
       END IF
       IF g_aza.aza63 = 'Y' THEN
          IF cl_null(l_apb.apb251) THEN
             CONTINUE FOREACH
          END IF
          SELECT aag21 INTO l_aag21 FROM aag_file
           WHERE aag01 = l_apb.apb251 
             AND aag00 = g_bookno2    
             AND aagacti = 'Y'     #No.MOD-B70280 add 
          IF l_aag21 = 'N' THEN        
             CONTINUE FOREACH
          END IF
       END IF
      #-MOD-B20152-end-
       LET l_msg=g_apa.apa01,'+',l_apb.apb02 USING '##&'
       #No.FUN-830161  --Begin
       IF g_aza.aza08 = 'N' THEN
          LET l_apb.apb35 = ' '
          LET l_apb.apb36= ' '
       END IF
       CALL s_get_bookno(YEAR(g_apa.apa02)) RETURNING l_flag,l_bookno1,l_bookno2
       LET p_sum1 = l_apb.apb10
       LET p_sum2 = l_apb.apb10
       IF cl_null(p_sum1) THEN LET p_sum1 = 0 END IF
       IF cl_null(p_sum2) THEN LET p_sum2 = 0 END IF
#No.FUN-850027--begin
       LET l_year = NULL    #MOD-A30113 add
       LET l_month = NULL   #MOD-A30113 add 
       IF g_aaz.aaz90= 'Y' THEN
         #MOD-A30113---modify---start---
         #CALL t110_bud_s(l_bookno1,l_apb.apb31,l_apb.apb25,
         #                YEAR(g_apa.apa02),l_apb.apb36,
         #                l_apb.apb930,l_apb.apb35,
         #                #MONTH(g_apa.apa02),'0','a',0,0,'1')   #MOD-950284
         #                MONTH(g_apa.apa02),'0','a',0,p_sum2,'1')   #MOD-950284
          CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
          CALL t110_bud_s(l_bookno1,l_apb.apb31,l_apb.apb25,
                          l_year,l_apb.apb36,
                          l_apb.apb930,l_apb.apb35,
                          l_month,'0','-',0,p_sum2,'1')  #MOD-B40117 mod 'a'->'-'
         #MOD-A30113---modify---end---
       ELSE
         #MOD-A30113---modify---start---
         #CALL t110_bud_s(l_bookno1,l_apb.apb31,l_apb.apb25,
         #                YEAR(g_apa.apa02),l_apb.apb36,
         #                l_apb.apb26,l_apb.apb35,
         #                #MONTH(g_apa.apa02),'0','a',0,0,'1')   #MOD-950284
         #                MONTH(g_apa.apa02),'0','a',0,p_sum2,'1')   #MOD-950284
          CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
          CALL t110_bud_s(l_bookno1,l_apb.apb31,l_apb.apb25,
                          l_year,l_apb.apb36,
                          l_apb.apb26,l_apb.apb35,
                          l_month,'0','-',0,p_sum2,'1')  #MOD-B40117 mod 'a'->'-'
         #MOD-A30113---modify---end---
       END IF
#No.FUN-850027--end
       #No.FUN-830161  --End 
       #No.FUN-830161  --Begin
       #IF cl_null(l_apb.apb25) OR cl_null(l_apb.apb30) OR cl_null(l_apb.apb26) THEN
       #   CALL cl_err(l_msg,'apm-312',1)
       #   LET g_success='N'
       #   RETURN
       #END IF

       #SELECT pnr05 INTO l_pnr05 FROM pnr_file
       # WHERE pnr01=l_apb.apb30
       #   AND pnr02=l_apb.apb25
       #   AND pnr03=l_apb.apb26
       #   AND pnr04=YEAR(g_apa.apa02)
       #IF STATUS THEN
#      #   CALL cl_err(l_msg,'apm-229',1)   #No.FUN-660122
       #   CALL cl_err3("sel","pnr_file",l_apb.apb30,l_apb.apb25,"apm-229","","",1)  #No.FUN-660122
       #   LET g_success='N'
       #   RETURN
       #END IF

       #CASE l_pnr05
       #   WHEN '1'
       #      CONTINUE FOREACH
       #   WHEN '2'
       #      CALL s_budchk(l_apb.apb26,l_apb.apb30,l_apb.apb25,
       #                    g_apa.apa02,l_apb.apb08*l_apb.apb09,
       #                    g_apz.apz02b)
       #                    RETURNING l_bud,over_amt,last_amt
       #      IF l_bud=0 THEN
       #         LET l_msg=l_msg CLIPPED,'+',over_amt
       #         CALL cl_err(l_msg,'apm-310',1)
       #      END IF
       #      IF g_aptype='12' OR g_aptype='13' THEN   #No.FUN-690080
       #         IF l_bud=0 THEN
       #            LET over_amt=over_amt-l_apb.apb08*l_apb.apb09
       #            LET l_msg=l_msg CLIPPED,'+',over_amt
       #            CALL cl_err(l_msg,'apm-310',1)
       #         ELSE
       #            IF over_amt-l_apb.apb08*l_apb.apb09 <0 THEN
       #               LET over_amt=over_amt-l_apb.apb08*l_apb.apb09
       #               LET l_msg=l_msg CLIPPED,'+',over_amt
       #               CALL cl_err(l_msg,'apm-310',1)
       #            END IF
       #         END IF
       #      END IF
       #   WHEN '3'
       #      CALL s_budchk(l_apb.apb26,l_apb.apb30,l_apb.apb25,
       #                    g_apa.apa02,l_apb.apb08*l_apb.apb09,
       #                    g_apz.apz02b)
       #                    RETURNING l_bud,over_amt,last_amt
       #      IF l_bud=0 THEN
       #         LET l_msg=l_msg CLIPPED,'+',over_amt
       #         CALL cl_err(l_msg,'apm-310',1)
       #         LET g_success='N'
       #         RETURN
       #      END IF
       #      IF g_aptype='12' OR g_aptype='13' THEN  #No.FUN-690080
       #         IF l_bud=0 THEN
       #            LET over_amt=over_amt-l_apb.apb08*l_apb.apb09
       #            LET l_msg=l_msg CLIPPED,'+',over_amt
       #            CALL cl_err(l_msg,'apm-310',1)
       #            LET g_success='N'
       #            RETURN
       #         ELSE
       #            IF over_amt-l_apb.apb08*l_apb.apb09 <0 THEN
       #               LET over_amt=over_amt-l_apb.apb08*l_apb.apb09
       #               LET l_msg=l_msg CLIPPED,'+',over_amt
       #               CALL cl_err(l_msg,'apm-310',1)
       #               LET g_success='N'
       #               RETURN
       #            END IF
       #         END IF
       #      END IF
       #END CASE
       #No.FUN-830161  --End  
    END FOREACH

END FUNCTION
#No.FUN-680029--begin
FUNCTION t110_budchk_1()
    DEFINE l_apb    RECORD LIKE apb_file.*
    DEFINE l_pnr05  LIKE pnr_file.pnr05
    DEFINE l_bud    LIKE type_file.num5      # No:FUN-690028 SMALLINT
    DEFINE over_amt LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
    DEFINE last_amt LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
    DEFINE l_msg    LIKE ze_file.ze03    # No:FUN-690028 VARCHAR(30)
    #No.FUN-830161  --Begin
    DEFINE p_sum1    LIKE afc_file.afc07
    DEFINE p_sum2    LIKE afc_file.afc07
    DEFINE l_flag    LIKE type_file.num5
    DEFINE l_over    LIKE afc_file.afc07
    DEFINE l_bookno1 LIKE aaa_file.aaa01
    DEFINE l_bookno2 LIKE aaa_file.aaa01
    #No.FUN-830161  --End
    DEFINE l_year    LIKE type_file.num5  #MOD-A30113 add
    DEFINE l_month   LIKE type_file.num5  #MOD-A30113 add

    DECLARE bud_cur_1 CURSOR FOR
       SELECT * FROM apb_file WHERE apb01=g_apa.apa01

    FOREACH bud_cur_1 INTO l_apb.*
       LET l_msg=g_apa.apa01,'+',l_apb.apb02 USING '##&'
       #No.FUN-830161  --Begin
       IF g_aza.aza08 = 'N' THEN
          LET l_apb.apb35 = ' '
          LET l_apb.apb36= ' '
       END IF
       CALL s_get_bookno(YEAR(g_apa.apa02)) RETURNING l_flag,l_bookno1,l_bookno2
       LET p_sum1 = l_apb.apb10
       LET p_sum2 = l_apb.apb10
       IF cl_null(p_sum1) THEN LET p_sum1 = 0 END IF
       IF cl_null(p_sum2) THEN LET p_sum2 = 0 END IF
#No.FUN-850027--begin
       LET l_year = NULL    #MOD-A30113 add
       LET l_month = NULL   #MOD-A30113 add 
       IF g_aaz.aaz90 = 'Y' THEN
         #MOD-A30113---modify---start---
         #CALL t110_bud_s(l_bookno2,l_apb.apb31,l_apb.apb251,
         #                YEAR(g_apa.apa02),l_apb.apb36,
         #                l_apb.apb930,l_apb.apb35,
         #                #MONTH(g_apa.apa02),'1','a',0,0,'1')   #MOD-950284
         #                MONTH(g_apa.apa02),'1','a',0,p_sum2,'1')   #MOD-950284
          CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
          CALL t110_bud_s(l_bookno2,l_apb.apb31,l_apb.apb251,
                          l_year,l_apb.apb36,
                          l_apb.apb930,l_apb.apb35,
                          l_month,'1','-',0,p_sum2,'1')  #MOD-B40117 mod 'a'->'-'
         #MOD-A30113---modify---end---
       ELSE
         #MOD-A30113---modify---start---
         #CALL t110_bud_s(l_bookno2,l_apb.apb31,l_apb.apb251,
         #                YEAR(g_apa.apa02),l_apb.apb36,
         #                l_apb.apb26,l_apb.apb35,
         #                #MONTH(g_apa.apa02),'1','a',0,0,'1')   #MOD-950284
         #                MONTH(g_apa.apa02),'1','a',0,p_sum2,'1')   #MOD-950284
          CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
          CALL t110_bud_s(l_bookno2,l_apb.apb31,l_apb.apb251,
                          l_year,l_apb.apb36,
                          l_apb.apb26,l_apb.apb35,
                          l_month,'1','-',0,p_sum2,'1')  #MOD-B40117 mod 'a'->'-'
         #MOD-A30113---modify---end---
       END IF
#No.FUN-850027--end
       #No.FUN-830161  --End 

       #No.FUN-830161  --Begin
       #IF cl_null(l_apb.apb251) OR cl_null(l_apb.apb30) OR cl_null(l_apb.apb26) THEN
       #   CALL cl_err(l_msg,'apm-312',1)
       #   LET g_success='N'
       #   RETURN
       #END IF

       #SELECT pnr05 INTO l_pnr05 FROM pnr_file
       # WHERE pnr01=l_apb.apb30
       #   AND pnr02=l_apb.apb251
       #   AND pnr03=l_apb.apb26
       #   AND pnr04=YEAR(g_apa.apa02)
       #IF STATUS THEN
#      #   CALL cl_err(l_msg,'apm-229',1)   #No.FUN-660122
       #   CALL cl_err3("sel","pnr_file",l_apb.apb30,l_apb.apb251,"apm-229","","",1)  #No.FUN-660122
       #   LET g_success='N'
       #   RETURN
       #END IF

       #CASE l_pnr05
       #   WHEN '1'
       #      CONTINUE FOREACH
       #   WHEN '2'
       #      CALL s_budchk(l_apb.apb26,l_apb.apb30,l_apb.apb251,
       #                    g_apa.apa02,l_apb.apb08*l_apb.apb09,
       #                    g_apz.apz02b)
       #                    RETURNING l_bud,over_amt,last_amt
       #      IF l_bud=0 THEN
       #         LET l_msg=l_msg CLIPPED,'+',over_amt
       #         CALL cl_err(l_msg,'apm-310',1)
       #      END IF
       #      IF g_aptype='12' OR g_aptype='13' THEN  #No.FUN-690080
       #         IF l_bud=0 THEN
       #            LET over_amt=over_amt-l_apb.apb08*l_apb.apb09
       #            LET l_msg=l_msg CLIPPED,'+',over_amt
       #            CALL cl_err(l_msg,'apm-310',1)
       #         ELSE
       #            IF over_amt-l_apb.apb08*l_apb.apb09 <0 THEN
       #               LET over_amt=over_amt-l_apb.apb08*l_apb.apb09
       #               LET l_msg=l_msg CLIPPED,'+',over_amt
       #               CALL cl_err(l_msg,'apm-310',1)
       #            END IF
       #         END IF
       #      END IF
       #   WHEN '3'
       #      CALL s_budchk(l_apb.apb26,l_apb.apb30,l_apb.apb251,
       #                    g_apa.apa02,l_apb.apb08*l_apb.apb09,
       #                    g_apz.apz02b)
       #                    RETURNING l_bud,over_amt,last_amt
       #      IF l_bud=0 THEN
       #         LET l_msg=l_msg CLIPPED,'+',over_amt
       #         CALL cl_err(l_msg,'apm-310',1)
       #         LET g_success='N'
       #         RETURN
       #      END IF
       #      IF g_aptype='12' OR g_aptype='13' THEN  #No.FUN-690080
       #         IF l_bud=0 THEN
       #            LET over_amt=over_amt-l_apb.apb08*l_apb.apb09
       #            LET l_msg=l_msg CLIPPED,'+',over_amt
       #            CALL cl_err(l_msg,'apm-310',1)
       #            LET g_success='N'
       #            RETURN
       #         ELSE
       #            IF over_amt-l_apb.apb08*l_apb.apb09 <0 THEN
       #               LET over_amt=over_amt-l_apb.apb08*l_apb.apb09
       #               LET l_msg=l_msg CLIPPED,'+',over_amt
       #               CALL cl_err(l_msg,'apm-310',1)
       #               LET g_success='N'
       #               RETURN
       #            END IF
       #         END IF
       #      END IF
       #END CASE
       #No.FUN-830161  --End  
    END FOREACH

END FUNCTION
#No.FUN-680029--end
 
FUNCTION t110_firm2()
   DEFINE g_t1     LIKE oay_file.oayslip                  #No.FUN-580012  #No.FUN-690028 VARCHAR(05)
   DEFINE l_aba19               LIKE aba_file.aba19       #No.FUN-670060
   DEFINE l_dbs                 STRING                    #No.FUN-670060
   DEFINE l_sql                 STRING                    #No.FUN-670060
   DEFINE only_one,l_sw         LIKE type_file.chr1       #No.FUN-690028 VARCHAR(1)
   DEFINE i,j,l_n               LIKE type_file.num5       #No.FUN-690028 SMALLINT
   DEFINE l_amt                 LIKE type_file.num10      # No:FUN-690028 INTEGER
   DEFINE l_apa35               LIKE apa_file.apa35
   DEFINE l_apa01               LIKE apa_file.apa01
   DEFINE l_apk03               LIKE apk_file.apk03
   DEFINE l_apk11               LIKE apk_file.apk11       #MOD-B50190 
   DEFINE l_apk171              LIKE apk_file.apk171      #MOD-B50190 
   DEFINE l_apa41               LIKE apa_file.apa41
   DEFINE l_apc01               LIKE apc_file.apc01       #MOD-940392 add
   DEFINE b_apa01               LIKE apa_file.apa01
   DEFINE b_apa41               LIKE apa_file.apa41
   DEFINE b_apa34               LIKE apa_file.apa34
   DEFINE b_apa34f              LIKE apa_file.apa34f,
          l_apk                 RECORD LIKE apk_file.*,
          l_apc                 RECORD LIKE apc_file.*,   #No.FUN-680027
          l_apv                 RECORD LIKE apv_file.*,   #MOD-850301 add
          l_apa                 RECORD LIKE apa_file.*,   #MOD-850301 add
          l_amt1,l_amt2         LIKE type_file.num20_6,   #No:FUN-690028 DEC(20,6),  #FUN-4B0079
          l_apv04f              LIKE apv_file.apv04f,     #FUN-580012
          l_apv04               LIKE apv_file.apv04,      #FUN-580012
          l_cnt                 LIKE type_file.num5       #No.FUN-690028 SMALLINT
   DEFINE l_cnt1                LIKE type_file.num5       #No.TQC-7B0083
   DEFINE l_yy,l_mm             LIKE type_file.num5       #No.FUN-690028 SMALLINT
   #DEFINE l_arr1 DYNAMIC ARRAY OF VARCHAR(16)               #No:MOD-480131   #No:TQC-630032 modify #FUN-660117 remark
   DEFINE l_arr1 DYNAMIC ARRAY OF LIKE apk_file.apk01     #FUN-660117
   DEFINE l_arr2 DYNAMIC ARRAY OF RECORD             
                   #invoice    VARCHAR(12),       #No:TQC-630032  mark
                   #invoice    VARCHAR(16),       #No:TQC-630032  add  #FUN-660117 remark
                    invoice    LIKE apk_file.apk03,                 #FUN-660117      
                    apa58      LIKE apa_file.apa58,
                    amt1       LIKE type_file.num20_6,    #No:FUN-690028 DEC(20,6),  #FUN-4B0079
                    amt2       LIKE type_file.num20_6     #No:FUN-690028 DEC(20,6)  #FUN-4B0079
                 END RECORD
   DEFINE l_ebocode VARCHAR(1)  #eB-Online回傳值  #NO:FUN-960117 add
   DEFINE l_no       LIKE apy_file.apyslip     #MOD-790046
   DEFINE l_apydmy3  LIKE apy_file.apydmy3     #MOD-790046
   DEFINE l_poz01    LIKE poz_file.poz01       #TQC-830007 add  
   DEFINE l_poz18    LIKE poz_file.poz18       #TQC-830007 add
   DEFINE l_poz19    LIKE poz_file.poz19       #TQC-830007 add 
  #DEFINE l_aph05f   LIKE aph_file.aph05f      #MOD-880080 add   #MOD-880222 mark
  #DEFINE l_aph05    LIKE aph_file.aph05       #MOD-880080 add   #MOD-880222 mark
   DEFINE l_gec05    LIKE apk_file.apk171      #MOD-B50190 

   IF g_apa.apa41 = 'N' THEN
      RETURN
   END IF
 ## No:MOD-4A0253 ##
     IF g_apa.apa63 = 'S' THEN
        CALL cl_err(g_apa.apa63,'apm-030',1)
        RETURN
     END IF
 ## END No:MOD-4A0253 ##
   #No.8150
   IF NOT cl_null(g_apa.apa99) THEN
      #TQC-830007-begin-add
       LET l_poz18=''
       LET l_poz19=''
       LET l_poz01=''
       SELECT poz01,poz18,poz19 INTO l_poz01,l_poz18,l_poz19  
         FROM pmm_file,poz_file
        WHERE pmm904 = poz01
          AND pmm01  = g_apb[1].apb06
          AND pmm901 = 'Y'         #三角貿易否
          AND pmm905 = 'Y'         #已拋轉
         #AND pmm906 = 'Y'         #來源單據  #CHI-8B0055 mark
        IF l_poz19 = 'Y'  AND g_plant=l_poz18 THEN  
           #已設立中斷點,單據可以取消確認
        ELSE 
      #TQC-830007-end-add
           CALL cl_err('','tri-018',1) RETURN
        END IF  #TQC-830007
   END IF
   #No.8150(end)
   #-----CHI-810018---------
   LET l_cnt = 0
   SELECT COUNT(*) INTO l_cnt FROM npl_file
      WHERE npl01 = g_apa.apa25
   IF l_cnt > 0 THEN
      CALL cl_err('','aap-425',0)
      RETURN
   END IF
   #-----END CHI-810018-----

  #-----MOD-770005---------已有產生折讓發票,不可取消確認
  IF g_aptype MATCHES '1*' THEN   #MOD-770081
     DECLARE apk_curs CURSOR FOR 
       SELECT apk03,apk11,apk171   #MOD-B50190 add apk11,apk171 
         FROM apk_file 
        WHERE apk01 = g_apa.apa01  
     LET l_apk03=''
     FOREACH apk_curs INTO l_apk03,l_apk11,l_apk171     #MOD-B50190 add apk11,apk171
       #-MOD-B50190-add-
        SELECT gec05 INTO l_gec05
          FROM gec_file
         WHERE gec01 = l_apk11
           AND gec011 = '1'
#       IF l_apk171 = '22' AND l_gec05 = '4' THEN                        #MOD-B70053
        IF (l_apk171 = '22' AND l_gec05 = '4') OR l_apk171 = 'XX' THEN   #MOD-B70053
        ELSE 
       #-MOD-B50190-end- 
           LET l_cnt=0
           SELECT COUNT(*) INTO l_cnt FROM apb_file,apa_file
             WHERE apb11 = l_apk03 AND 
                   apb01 = apa01 AND 
                   apa00 MATCHES "2*" AND 
                   apa58 <> '1' #MOD-770081
           IF l_cnt > 0 THEN
              CALL cl_err(l_apk03,'aap-666',0)
              RETURN
           END IF
        END IF       #MOD-B50190
     END FOREACH
  END IF   #MOD-770081
  #-----END MOD-770005-----

  #-----TQC-740314--------已有沖暫估資料不可取消確認
  LET l_cnt=0
  SELECT COUNT(*) INTO l_cnt FROM api_file
    WHERE api01 = g_apa.apa01 AND api02='2'
   IF l_cnt > 0 AND g_aptype ='16' THEN
      CALL cl_err(g_apa.apa01,'aap-140',0)
      RETURN
   END IF
  #-----END TQC-7400314----

  #-----MOD-620008---------已有沖帳之資料不可取消確認
  LET l_cnt=0
  SELECT COUNT(*) INTO l_cnt FROM aph_file,apf_file
    WHERE aph04 = g_apa.apa01 AND apf01=aph01
      AND apf41 != 'X'
   IF l_cnt > 0 THEN
      CALL cl_err(g_apa.apa01,'agl-905',0)
      RETURN
   END IF
  #-----END MOD-620008-----

  #-----MOD-6C0122---------已沖暫估之資料不可取消確認
  IF g_apa.apa00 = '11' THEN
     LET l_cnt = 0
     SELECT COUNT(*) INTO l_cnt FROM api_file
       WHERE api26 = g_apa.apa01
     IF l_cnt > 0 THEN
        CALL cl_err(g_apa.apa01,'aap-140',0)
        RETURN
     END IF
  END IF
  #-----END MOD-6C0122-----

  #MOD-840531 add 080422 --begin
  #帳款單號已經存在于進銷項維護作業（amd_file.amd01），
  #不能取消確認
  LET l_cnt = 0
  SELECT COUNT(*) INTO l_cnt
    FROM amd_file
   WHERE amd01 = g_apa.apa01
  IF l_cnt > 0 THEN
     CALL cl_err(g_apa.apa01,'aap-188',0)
     RETURN
  END IF
  #MOD-840531 add 080422 --end

   #No.FUN-670060 --start--
   #取消確認時，若單據別設為"系統自動拋轉總帳",則可自動拋轉還原    
#  CALL s_get_doc_no(m_apa.apa01) RETURNING g_t1   #No.TQC-740067 mark
   CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1   #No.TQC-740067
   SELECT * INTO g_apy.* FROM apy_file WHERE apyslip=g_t1                                                                           
#  IF NOT cl_null(m_apa.apa44) OR NOT cl_null(m_apa.apa43) THEN                                                                     
#  IF NOT cl_null(m_apa.apa44)  THEN         #No.FUN-680029 #No.TQC-740067 mark                                        
   IF NOT cl_null(g_apa.apa44)  THEN         #No.TQC-740067                                                            
      IF NOT (g_apy.apydmy3 = 'Y' AND g_apy.apyglcr = 'Y') THEN                                                                     
#        CALL cl_err(m_apa.apa01,'axr-370',0) RETURN    #No.TQC-740067 mark                                                                              
         CALL cl_err(g_apa.apa01,'axr-370',0) RETURN    #No.TQC-740067                                                                            
      END IF                                                                                                                        
   END IF                                                                                                                           
   IF g_apy.apydmy3 = 'Y' AND g_apy.apyglcr = 'Y' THEN                                                                              
      IF NOT cl_null(g_apa.apa44) THEN   #CHI-B60063 add
         LET g_plant_new=g_apz.apz02p CALL s_getdbs() LET l_dbs=g_dbs_new
         LET l_sql = " SELECT aba19 FROM ",l_dbs,"aba_file",
                     "  WHERE aba00 = '",g_apz.apz02b,"'",
#                    "    AND aba01 = '",m_apa.apa44,"'"   #No.TQC-740067 mark
                     "    AND aba01 = '",g_apa.apa44,"'"   #No.TQC-740067
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql		#FUN-920032
         PREPARE aba_pre FROM l_sql
         DECLARE aba_cs CURSOR FOR aba_pre
         OPEN aba_cs
         FETCH aba_cs INTO l_aba19
         IF l_aba19 = 'Y' THEN                                                                                                         
#           CALL cl_err(m_apa.apa44,'axr-071',1)     #No.TQC-740067 mark                                                                                  
            CALL cl_err(g_apa.apa44,'axr-071',1)     #No.TQC-740067                                                                                  
            CLOSE aba_cs   #No.TQC-7B0083
            RETURN                                                                                                                     
         END IF                                                                                                                        
         CLOSE aba_cs   #No.TQC-7B0083
      END IF   #CHI-B60063 add
   END IF                                                                                                                           
   #No.FUN-670060 --end-- 

#No.FUN-670060 --start-- mark
   #-->已拋轉總帳, 不可取消確認
#  SELECT apa44 INTO g_apa.apa44 FROM apa_file WHERE apa01=g_apa.apa01   #MOD-640458
#  #IF NOT cl_null(g_apa.apa44) AND g_apz.apz24 = 'N' THEN   #TQC-630134
#  IF NOT cl_null(g_apa.apa44) THEN   #TQC-630134
#     CALL cl_err(g_apa.apa01,'aap-145',1)
#     RETURN
#  END IF
#No.FUN-670060 --end-- 

   #-->立帳日期不可小於關帳日期
   IF g_apa.apa02 <= g_apz.apz57 THEN
      CALL cl_err(g_apa.apa01,'aap-176',1)
      RETURN
   END IF
   # 期末調匯(A008)

   IF g_apz.apz27 = 'Y' AND g_apa.apa13 != g_aza.aza17 THEN
      LET l_yy = YEAR(g_apa.apa02)
      LET l_mm = MONTH(g_apa.apa02)
      IF (l_yy*12+l_mm) - (g_apz.apz21*12+g_apz.apz22) = 0 THEN
         CALL cl_err(l_mm,'axr-407',0) RETURN
      END IF
   END IF

   #-->若有沖帳之資料不可取消確認 modi in 01/03/14 bug:2923
   SELECT COUNT(*) INTO l_n FROM apg_file ,apf_file
   #WHERE apg04 = g_apa.apa01 AND apf01=apg01 AND apf00 !='11'   #MOD-790086
    WHERE apg04 = g_apa.apa01 AND apf01=apg01 AND apf00 !='11' AND apf00 !='16'  #MOD-790086
      AND apg03 = g_plant   #MOD-B40117 add
      AND apf41 != 'X'   #no.7349
   IF l_n > 0 THEN
      CALL cl_err(g_apa.apa01,'agl-905',0)
      RETURN
   END IF

  #為請款折讓,不可取消確認,統一由AAPT110取消時再刪除
   IF g_apa.apa00='21' AND g_apa.apa58='1' AND g_apz.apz60 = 'Y' THEN
      CALL cl_err('','aap-321',0)
      RETURN
   END IF

   #-->已付款沖帳不可取消確認
   #FUN-580012  --begin
   LET g_t1 = s_get_doc_no(g_apa.apa01)
   SELECT apydmy6 INTO g_apy.apydmy6 FROM apy_file WHERE apyslip = g_t1
   IF g_aza.aza26 != '2' OR g_aptype[1,1]!='2' OR g_apy.apydmy6!='Y' THEN
      IF (g_apa.apa35<>0 OR g_apa.apa35f<>0) AND g_apa.apa55!='2' THEN
         CALL cl_err("apa41=Y",'aap-255',0)
         RETURN
      END IF
   END IF
   #FUN-580012  --end

   #-->待抵已沖帳不可取消確認
   IF g_apa.apa00 = '15' OR g_apa.apa00 = '17' THEN  #No.FUN-690080
      SELECT apa35 INTO l_apa35 FROM apa_file
       WHERE apa08 = g_apa.apa01 
         AND (apa00 = '23' OR apa00 = '25')  #No.FUN-690080
      IF l_apa35 > 0 THEN
         CALL cl_err('23:apa35>0','aap-204',0)
         RETURN
      END IF
   END IF

   #-->已結案不可取消確認
   IF g_apa.apa42 = 'Y' THEN
      CALL cl_err("apa42=Y",'aap-165',0)
      RETURN
   END IF

   #-->外購拋入不可取消確認
   IF g_apa.apa75 = 'Y' THEN
      CALL cl_err("apa75=Y",'aap-333',0)
      RETURN
   END IF
   #FUN-580012  --begin
   IF g_aza.aza26 = '2' AND g_apa.apa00[1,1] = '1' THEN
      SELECT SUM(apv04),SUM(apv04f) INTO l_apv04,l_apv04f
        FROM apv_file
       WHERE apv03=g_apa.apa01
      IF cl_null(l_apv04) THEN LET l_apv04 = 0 END IF
      IF cl_null(l_apv04f) THEN LET l_apv04f = 0 END IF
      IF l_apv04 != 0 OR l_apv04f != 0 THEN
         CALL cl_err('','aap-914',0)
         LET g_success = 'N'
         RETURN
      END IF
   END IF
   #FUN-580012  --end

   #單身已分攤, 則不可取消確認
   LET l_cnt=0
   IF g_apa.apa00='11' THEN
      SELECT COUNT(*) INTO l_cnt
        FROM aqa_file,aqc_file
       WHERE aqc01 = aqa01
         AND aqc02 = g_apa.apa01
         AND aqaconf<> 'X' #CHI-A50028 add
       IF SQLCA.SQLCODE <> 0 OR l_cnt IS NULL THEN
          LET l_cnt =0
       END IF

       IF l_cnt > 0 THEN
          CALL cl_err("apb10<>apb101",'aap-291',0)
          RETURN
       END IF
   END IF

  #str MOD-960302 mod
   IF g_apa.apa00='12' OR g_apa.apa00 ='13' OR g_apa.apa00 ='16' OR
      g_apa.apa00='22' OR g_apa.apa00 ='15' OR g_apa.apa00 ='25' THEN   #No.FUN-690080 #MOD-B20046 mod 23 -> 15
  #end MOD-960302 mod
     #-MOD-B20046-add-
      IF g_apa.apa00 = '15' THEN
         LET l_apa01 = ''
         SELECT apa01 INTO l_apa01 
           FROM apa_file
          WHERE apa08 = g_apa.apa01
            AND apa00 = '23'
 
         SELECT COUNT(*) INTO l_cnt
           FROM aqa_file,aqb_file
          WHERE aqb01 = aqa01
            AND aqb02 = l_apa01
            AND aqaconf<> 'X' 
      ELSE
     #-MOD-B20046-end-
         SELECT COUNT(*) INTO l_cnt
           FROM aqa_file,aqb_file
          WHERE aqb01 = aqa01
            AND aqb02 = g_apa.apa01
            AND aqaconf<> 'X' #CHI-A50028 add
      END IF  #MOD-B20046
      IF SQLCA.SQLCODE <> 0 OR l_cnt IS NULL THEN
         LET l_cnt =0
      END IF

      IF l_cnt > 0 THEN
         CALL cl_err("apb10<>apb101",'aap-291',0)
         RETURN
      END IF
   END IF

   #No.MOD-840381  --Begin
   IF g_apa.apa00 = '16' OR g_apa.apa00 = '26' THEN
      LET l_cnt = 0 
      SELECT COUNT(*) INTO l_cnt FROM api_file
       WHERE api26 = g_apa.apa01
      IF l_cnt > 0 THEN
         CALL cl_err(g_apa.apa01,'aap-140',1)
         LET g_success = 'N'
         RETURN
      END IF 
   END IF 
   #No.MOD-840381  --End  

   IF cl_confirm('aap-224') THEN
      MESSAGE "WORKING !"
      #No.TQC-740315 --start--
      IF g_apy.apydmy3 = 'Y' AND g_apy.apyglcr = 'Y' THEN
         IF NOT cl_null(g_apa.apa44) THEN   #CHI-B60063 add
            LET g_wc_gl = 'npp01 = "',g_apa.apa01,'" AND npp011 = 1'
            LET g_str="aapp409 '",g_apz.apz02p,"' '",g_apz.apz02b,"' '",g_apa.apa44,"' 'Y'"
               CALL cl_cmdrun_wait(g_str)
               SELECT apa44,apa43 INTO g_apa.apa44,g_apa.apa43 FROM apa_file 
                WHERE apa01 = g_apa.apa01
               DISPLAY BY NAME g_apa.apa44
               IF NOT cl_null(g_apa.apa44) THEN
                  CALL cl_err('','aap-929',0)
                  RETURN
               END IF
         END IF   #CHI-B60063 add
      END IF 
      #No.TQC-740315 --end--
      LET g_success = 'Y'
      BEGIN WORK

      CALL t110_lock_cl()  #FUN-C80078 add
      OPEN t110_cl USING g_apa_rowid
      IF STATUS THEN
         CALL cl_err("OPEN t110_cl firm2:", STATUS, 1)
         CLOSE t110_cl
         ROLLBACK WORK
         RETURN
      END IF

      FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
      IF SQLCA.sqlcode THEN
         CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
         CLOSE t110_cl
         ROLLBACK WORK
         RETURN
      END IF

      #-----MOD-790046---------
      {
      FOR i = 1 TO 1000               #No:MOD-480131
          LET l_arr1[i] = ' '
          LET l_arr2[i].invoice = ' '
          LET l_arr2[i].amt1    = 0
          LET l_arr2[i].amt2    = 0
      END FOR

      LET j = 1
      LET i = 1
      LET l_amt1 = 0
      LET l_amt2 = 0

      IF g_apa.apa00[1,1] = '1' THEN
         IF g_apa.apa60 > 0 THEN
            DECLARE z4_curs CURSOR FOR
             SELECT UNIQUE apk03 FROM apk_file
              WHERE apk01 = g_apa.apa01 AND apk171 IN ('21','22','25')

            FOREACH z4_curs INTO l_apk.apk03
               IF STATUS THEN EXIT FOREACH END IF

               DECLARE z5_curs CURSOR FOR           ## 可能多張 SL
                SELECT apk01,SUM(apk07+apk08) FROM apa_file,apk_file
                 WHERE apk03 = l_apk.apk03 AND apk171 IN ('23','24')
                   AND apa01 = apk01       AND apa58 = '1'
                 GROUP BY apk01

               FOREACH z5_curs INTO l_apk.apk01,l_apk.apk07
                  IF STATUS THEN
                     EXIT FOREACH
                  END IF

                  LET l_amt2 = l_amt2 + l_apk.apk07

                   FOR j = 1 TO 1000               #No:MOD-480131
                      IF cl_null(l_arr1[j]) THEN
                         LET l_arr1[j] = l_apk.apk01
                         EXIT FOR
                      END IF
                      IF l_arr1[j] = l_apk.apk01 THEN
                         EXIT FOR
                      END IF
                  END FOR
               END FOREACH
            END FOREACH

             FOR i = 1 TO 1000               #No:MOD-480131
                IF cl_null(l_arr1[i]) THEN
                   EXIT FOR
                END IF

                IF l_arr1[2] <> ' ' OR (g_apa.apa60+g_apa.apa61) = l_amt2 THEN
                   #No.MOD-590312  --begin
                   CALL t110_comp_oox(l_arr1[i]) RETURNING g_net
                   UPDATE apa_file SET apa35f = 0,
                                       apa35 = 0,
                                       apa73 = apa34 + g_net
                   #No.MOD-590312  --end
                    WHERE apa01 = l_arr1[i] AND apa41 = 'Y'
                   IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN
                      #LET g_buf = l_arr1[i],':此折讓單更新有誤_1'
#                      CALL cl_err(l_arr1[i],'aap-046',0)                 #No:MOD-510140   #No.FUN-660122
                       CALL cl_err3("upd","apa_file",l_arr1[i],"","app-046","","",1)  #No.FUN-660122
                      LET g_success = 'N' EXIT FOR
                   END IF
                END IF

                IF cl_null(l_arr1[2]) AND
                   (g_apa.apa60+g_apa.apa61) < l_amt2 THEN
                   #No.MOD-590312  --begin
                   CALL t110_comp_oox(l_arr1[i]) RETURNING g_net
                   UPDATE apa_file SET apa35f=apa35f- g_apa.apa60f
                                                    - g_apa.apa61f ,
                                       apa35 =apa35 - g_apa.apa60
                                                    - g_apa.apa61,
                                       apa73 =apa34 -(apa35-g_apa.apa60   #CHI-890017 mod
                                                           -g_apa.apa61)  #CHI-890017 mod
                                                    + g_net
                   #No.MOD-590312  --end
                    WHERE apa01 = l_arr1[i] AND apa41 = 'Y'
                   IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN
                      #LET g_buf = l_arr1[i],':此折讓單更新有誤_2'
#                      CALL cl_err(l_arr1[i],'aap-047',0)               #No:MOD-510140   #No.FUN-660122
                       CALL cl_err3("upd","apa_file",l_arr1[i],"","app-047","","",1)  #No.FUN-660122
                      LET g_success = 'N'
                      EXIT FOR
                   END IF
                END IF
            END FOR
         END IF
      END IF
      }
      IF g_apa.apa00[1,1] = '1' AND g_apa.apa60 > 0 THEN
         DECLARE apk_c SCROLL CURSOR FOR 
           SELECT apk01 FROM apk_file WHERE apk26=g_apa.apa01
         OPEN apk_c
         FETCH FIRST apk_c INTO l_apk.apk01
         CLOSE apk_c

         SELECT SUM(apk07+apk08) INTO l_apk.apk07 FROM apk_file
            WHERE apk01=l_apk.apk01
         LET l_amt2 = l_apk.apk07

         IF (g_apa.apa60+g_apa.apa61) = l_amt2 THEN
            DELETE FROM apa_file WHERE apa01=l_apk.apk01
            IF SQLCA.SQLCODE OR STATUS THEN
               CALL cl_err3("del","apa_file",l_apk.apk01,"",SQLCA.sqlcode,"","del apa",1)  
               LET g_success = 'N'
            END IF
            DELETE FROM apc_file WHERE apc01=l_apk.apk01
            IF SQLCA.SQLCODE OR STATUS THEN
               CALL cl_err3("del","apc_file",l_apk.apk01,"",SQLCA.sqlcode,"","del apc",1)  
               LET g_success = 'N'
            END IF
            DELETE FROM apb_file WHERE apb01=l_apk.apk01
            IF SQLCA.SQLCODE OR STATUS THEN
               CALL cl_err3("del","apb_file",l_apk.apk01,"",SQLCA.sqlcode,"","del apb",1)  
               LET g_success = 'N'
            END IF
            DELETE FROM apk_file WHERE apk01=l_apk.apk01
            IF SQLCA.SQLCODE OR STATUS THEN
               CALL cl_err3("del","apk_file",l_apk.apk01,"",SQLCA.sqlcode,"","del apk",1)  
               LET g_success = 'N'
            END IF
            DELETE FROM npp_file WHERE npp01=l_apk.apk01 AND nppsys='AP' AND
                                       npp00=1 AND npp011=1
            IF SQLCA.SQLCODE OR STATUS THEN
               CALL cl_err3("del","npp_file",l_apk.apk01,"",SQLCA.sqlcode,"","del npp",1)  
               LET g_success = 'N'
            END IF
            DELETE FROM npq_file WHERE npq01=l_apk.apk01 AND npqsys='AP' AND
                                       npq00=1 AND npq011=1
            IF SQLCA.SQLCODE OR STATUS THEN
               CALL cl_err3("del","npq_file",l_apk.apk01,"",SQLCA.sqlcode,"","del npq",1)  
               LET g_success = 'N'
            END IF
            UPDATE apb_file SET apb16='N' WHERE apb01 = g_apa.apa01   #MOD-770081
            IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3]=0 THEN
               CALL cl_err3("upd","apb_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apb",1)  
               LET g_success = 'N'
            END IF
         END IF

         IF (g_apa.apa60+g_apa.apa61) < l_amt2 THEN
            CALL t110_comp_oox(l_apk.apk07) RETURNING g_net
            UPDATE apa_file SET apa31f = apa31f - g_apa.apa60f,
                                apa31  = apa31  - g_apa.apa60,
                                apa32f = apa32f - g_apa.apa61f,
                                apa32  = apa32  - g_apa.apa61,
                                apa34f = apa34f - g_apa.apa60f-g_apa.apa61f,
                                apa34  = apa34  - g_apa.apa60 -g_apa.apa61 ,
                                apa35f = apa35f - g_apa.apa60f-g_apa.apa61f,
                                apa35  = apa35  - g_apa.apa60 -g_apa.apa61 ,
                                apa57  = apa57  - g_apa.apa60,
                                apa73  = apa73  - g_apa.apa60
                                                - g_apa.apa61
                                                + g_net
             WHERE apa01 = l_apk.apk01 AND apa41 = 'Y'
            IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN
               CALL cl_err3("upd","apa_file",l_apk.apk01,"","app-047","","",1) 
               LET g_success = 'N'
            END IF
            UPDATE apc_file SET apc08 = apc08 - g_apa.apa60f-g_apa.apa61f,
                                apc09 = apc09 - g_apa.apa60 -g_apa.apa61 ,
                                apc10 = apc10 - g_apa.apa60f-g_apa.apa61f,
                                apc11 = apc11 - g_apa.apa60 -g_apa.apa61 ,
                                apc13 = apc13 - g_apa.apa60 -g_apa.apa61 +g_net
             WHERE apc01 = l_apk.apk01 
            IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN
               CALL cl_err3("upd","apc_file",l_apk.apk01,"",SQLCA.sqlcode,"","upd apc",1) 
               LET g_success = 'N'
            END IF
            DELETE FROM apb_file WHERE apb11=g_apa.apa08
            IF SQLCA.SQLCODE OR STATUS THEN
               CALL cl_err3("del","apb_file",g_apa.apa08,"",SQLCA.sqlcode,"","del apb",1)  
               LET g_success = 'N'
            END IF
            DELETE FROM apk_file WHERE apk26=g_apa.apa01
            IF SQLCA.SQLCODE OR STATUS THEN
               CALL cl_err3("del","apk_file",g_apa.apa01,"",SQLCA.sqlcode,"","del apk",1)  
               LET g_success = 'N'
            END IF
            LET l_no = s_get_doc_no(l_apk.apk01)
            SELECT apydmy3 INTO l_apydmy3 FROM apy_file WHERE apyslip=l_no
            IF l_apydmy3 = 'Y' THEN 
               DELETE FROM npp_file WHERE npp01=l_apk.apk01 AND nppsys='AP' AND
                                          npp00=1 AND npp011=1
               IF SQLCA.SQLCODE OR STATUS THEN
                  CALL cl_err3("del","npp_file",l_apk.apk01,"",SQLCA.sqlcode,"","del npp",1)  
                  LET g_success = 'N'
               END IF
               DELETE FROM npq_file WHERE npq01=l_apk.apk01 AND npqsys='AP' AND
                                          npq00=1 AND npq011=1
               IF SQLCA.SQLCODE OR STATUS THEN
                  CALL cl_err3("del","npq_file",l_apk.apk01,"",SQLCA.sqlcode,"","del npq",1)  
                  LET g_success = 'N'
               END IF
               CALL t110_g_gl('21',l_apk.apk01,'0')
               IF g_aza.aza63 = 'Y' AND g_success = 'Y' THEN
                  CALL t110_g_gl('21',l_apk.apk01,'1')
               END IF
            END IF
            UPDATE apb_file SET apb16='N' WHERE apb01 = g_apa.apa01   #MOD-770081
            IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3]=0 THEN
               CALL cl_err3("upd","apb_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apb",1)  
               LET g_success = 'N'
            END IF
         END IF
      END IF

      LET m_apa.* = g_apa.*
      #-----MOD-790046---------

      #----預付待抵刪除------------
      IF g_aptype= '15' OR g_aptype= '17' THEN  #No.FUN-690080
#No.FUN-680027--begin
        #str MOD-940392 mod
        #DELETE FROM apc_file WHERE apc01 IN(SELECT apc01 FROM apc_file,apa_file
        #                                     WHERE apc01 =apa01 
        #                                       AND (apa00 = '23' OR apa00 = '25')  #No.FUN-690080
        #                                       AND apa08=g_apa.apa01)
        #IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
        #   CALL cl_err3("del","apc_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_firm2_apc:",1)  
        #   LET g_success = 'N'
        #END IF
         LET l_sql = "SELECT apc01 FROM apc_file,apa_file ",
                     " WHERE apc01 =apa01 ",
                     "   AND (apa00 = '23' OR apa00 = '25') ",
                     "   AND apa08 = '",g_apa.apa01 CLIPPED,"' "
         PREPARE p150_p1 FROM l_sql
         DECLARE p150_cs1 CURSOR FOR p150_p1
         FOREACH p150_cs1 INTO l_apc01
            DELETE FROM apc_file WHERE apc01 = l_apc01
            IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
               CALL cl_err3("del","apc_file",l_apc01,"",SQLCA.sqlcode,"","t110_firm2_apc:",1)
               LET g_success = 'N'
            END IF
         END FOREACH
        #end MOD-940392 mod
#No.FUN-680027--end
         DELETE FROM apa_file WHERE (apa00 = '23' OR apa00 = '25') AND apa08=g_apa.apa01  #No.FUN-690080
         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
#           CALL cl_err('t110_firm2_apa:',SQLCA.SQLCODE,0)   #No.FUN-660122
            CALL cl_err3("del","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_firm2_apa:",1)  #No.FUN-660122
            LET g_success = 'N'
         END if
      END IF

      #No.TQC-7B0083  --Begin
      LET l_cnt1 = 0
      SELECT COUNT(*) INTO l_cnt1 FROM apb_file
       WHERE apb01 = g_apa.apa01
         AND apb34 = 'Y'
      IF cl_null(l_cnt1) THEN LET l_cnt1 = 0 END IF
      #No.TQC-7B0083  --End  
      #----沖暫估AP刪除------------
     #IF g_apa.apa51='UNAP' OR l_cnt1 > 0 THEN  #No.TQC-7B0083                     #MOD-8C0067 mark
      IF g_apa.apa51='UNAP' OR l_cnt1 > 0 OR g_apa.apa56='5' THEN  #No.TQC-7B0083  #MOD-8C0067
         CALL t110_del_apg()
      END IF

      #----直接付款刪除------------
      IF g_apa.apa55='2' THEN
         CALL t110_del_apg0()
      END IF

      #----直接付款沖待抵帳款 97-09-11 Roger
      IF m_apa.apa55='2' THEN
         CALL t110_aph_upd(-1)
      END IF

      #-----MOD-790046---------
      {
      #-----MOD-640225---------
      #-->若已有相對應之折讓單，須刪除折讓單
      IF g_apa.apa00[1,1] = '1' THEN
         SELECT apa01 INTO l_apa01 FROM apa_file
          WHERE apa08 = g_apa.apa01 AND apa58 = '1'
         IF STATUS <> 100 THEN
            DELETE FROM apa_file WHERE apa01 = l_apa01
            IF STATUS THEN
#              CALL cl_err('del apa_21:',STATUS,0)   #No.FUN-660122
               CALL cl_err3("del","apa_file",l_apa01,"",STATUS,"","del apa_21:",1)  #No.FUN-660122
               LET g_success='N'
            END IF
#No.FUN-680029--begin--取消確認時，除了把產生的折讓帳款刪除，同時要apb16置成'N'，否則aapp112無法產生這筆資料的折讓帳款
            UPDATE apb_file SET apb16 ='N' WHERE apb01 =g_apa.apa01
            IF STATUS THEN
               CALL cl_err3("upd","apb_file",g_apa.apa01,"",STATUS,"","",1) 
               LET g_success='N'
            END IF
#No.FUN-680029--end
            DELETE FROM apb_file WHERE apb01 = l_apa01
            IF STATUS THEN
#              CALL cl_err('del apb_21:',STATUS,0)   #No.FUN-660122
               CALL cl_err3("del","apb_file",l_apa01,"",STATUS,"","del apb_21:",1)  #No.FUN-660122
               LET g_success='N'
            END if
            	
#No.FUN-680027--begin
            DELETE FROM apc_file WHERE apc01 = l_apa01
            IF STATUS THEN
               CALL cl_err3("del","apc_file",l_apa01,"",STATUS,"","del apc_21:",1) 
               LET g_success='N'
            END if
#No.FUN-680027--end
            	
            DELETE FROM apk_file WHERE apk01 = l_apa01
            IF STATUS THEN
#              CALL cl_err('del apk_21',STATUS,0)  #No.FUN-660122
               CALL cl_err3("del","apk_file",l_apa01,"",STATUS,"","del apk_21:",1)  #No.FUN-660122
               LET g_success = 'N'
            END IF
            UPDATE apb_file SET apb16='N' WHERE apb01 = g_apa.apa01   #MOD-770081
         END IF
      END IF
      #-----END MOD-640225-----
      }
      #-----END MOD-790046-----

     #MOD-A50005---mark---start---
     # #MOD-4B0308
     #IF m_apa.apa00= '21' AND  m_apa.apa58 = '3' THEN
     #   DELETE FROM apk_file WHERE apk01=g_apa.apa01
     #   IF STATUS THEN
#    #      CALL cl_err('apa58=3 del apk',status,1)   #No.FUN-660122
     #      CALL cl_err3("del","apk_file",g_apa.apa01,"",STATUS,"","apa58=3 del apk",1)  #No.FUN-660122
     #      LET g_success='N'
     #   END IF
     #END IF
     ##--
     #MOD-A50005---mark---end---

     #FUN-580012  --begin
#No.TQC-7B0123 --begin
#     LET g_t1 = s_get_doc_no(g_apa.apa01)
#     SELECT apydmy6 INTO g_apy.apydmy6 FROM apy_file WHERE apyslip = g_t1
#     IF g_aza.aza26 != '2' OR g_aptype[1,1]!='2' OR g_apy.apydmy6!='Y' THEN
#        SELECT SUM(apg05f),SUM(apg05) INTO g_apa.apa35f,g_apa.apa35
#          FROM apg_file,apf_file
#         WHERE apg04=g_apa.apa01 AND apg01=apf01
#           AND apf00 !='11'
#           AND apf41 !='X'
#
#        IF g_apa.apa35f IS NULL THEN
#           LET g_apa.apa35f = 0
#        END IF
#
#        IF g_apa.apa35  IS NULL THEN
#           LET g_apa.apa35  = 0
#        END IF
#     END IF
#No.TQC-7B0123 --end
     #No.FUN-690080 --Begin
     #刪除還款銀行異動記錄檔
     IF g_aptype = '13' AND g_apa.apa37f > 0 THEN                
        CALL t110_del_nme_1()
     END IF
     #No.FUN-690080 --End
#-----MOD-7B0180---------
{
      #No.MOD-590312  --begin
      CALL t110_comp_oox(g_apa.apa01) RETURNING g_net
      LET g_apa.apa73=g_apa.apa34-g_apa.apa35 + g_net
      #No.MOD-590312  --end
}
#-----END MOD-7B0180-----
   #str MOD-880222 mark
   ##str MOD-880080 add
   ##直接付款於取消確認段需更新apa35f,apa35
   # IF g_apa.apa55='2' THEN
   #    LET l_aph05f=0 LET l_aph05=0
   #    SELECT SUM(aph05f),SUM(aph05) INTO l_aph05f,l_aph05
   #      FROM aph_file WHERE aph01=g_apa.apa01
   #    IF cl_null(g_apa.apa20) THEN LET g_apa.apa20 = 0 END IF
   #    IF cl_null(l_aph05f) OR l_aph05f=0 THEN
   #       LET l_aph05f=g_apa.apa34f-g_apa.apa35f-g_apa.apa20
   #    END IF
   #    LET l_aph05f=cl_digcut(l_aph05f,t_azi04)
   #    IF cl_null(l_aph05) OR l_aph05=0 THEN
   #       IF g_apz.apz27 = 'N' THEN
   #          LET l_aph05=g_apa.apa34-g_apa.apa35-g_apa.apa20*g_apa.apa14
   #       ELSE
   #          LET l_aph05=g_apa.apa73-g_apa.apa20*g_apa.apa72
   #       END IF
   #    END IF
   #    LET l_aph05=cl_digcut(l_aph05,g_azi04)
   #    UPDATE apa_file SET apa35f= apa35f - l_aph05f,
   #                        apa35 = apa35  - l_aph05,
   #                        apa73 = g_apa.apa34 + l_aph05
   #      WHERE apa01 = g_apa.apa01
   #    IF SQLCA.sqlcode OR SQLCA.SQLERRD[3]=0 THEN
   #       CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)
   #       LET g_success='N'
   #    END IF
   # END IF
   ##end MOD-880080 add
   #end MOD-880222 mark
 ### MOD-4A0253
         UPDATE apa_file SET apa41 = 'N',
#                         apa35f = g_apa.apa35f,     #No.TQC-7B0123
#                         apa35 = g_apa.apa35,     #No.TQC-7B0123
#                         apa73 = g_apa.apa73,     #No.TQC-7B0123
                          apa63 = '0'
       WHERE apa01=g_apa.apa01

 ### END MOD-4A0253
      IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
#        CALL cl_err('t110_apa41:',SQLCA.SQLCODE,0)   #No.FUN-660122
         CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_apa41:",1)  #No.FUN-660122
         LET g_success = 'N'
      END IF

#No.TQC-7B0100 --begin
#No.FUN-680027--begin
#     IF g_aza.aza26 != '2' OR g_aptype[1,1]!='2' OR g_apy.apydmy6!='Y' THEN
#        DECLARE apg_firm2_cs CURSOR FOR 
#          SELECT apc_file.* FROM apc_file
#           WHERE apc01 = g_apa.apa01
#        FOREACH apg_firm2_cs INTO l_apc.*
#            SELECT SUM(apg05f),SUM(apg05) INTO g_apa.apa35f,g_apa.apa35
#              FROM apg_file,apf_file
#             WHERE apg04=g_apa.apa01 AND apg01=apf01
#               AND apf00 !='11'
#               AND apf41 !='X'
#               AND apg06 = l_apc.apc02
#
#            IF g_apa.apa35f IS NULL THEN
#               LET g_apa.apa35f = 0
#            END IF
#
#            IF g_apa.apa35  IS NULL THEN
#               LET g_apa.apa35  = 0
#            END IF
#            #No.FUN-7B0055  --Begin
#            #CALL t110_comp_oox(g_apa.apa01) RETURNING g_net
#            CALL t110_comp_oox1(g_apa.apa01,l_apc.apc02) RETURNING g_net
#            #No.FUN-7B0055  --End  
#            LET l_apc.apc13=l_apc.apc09-g_apa.apa35 + g_net
#                
#                UPDATE apc_file SET apc10 = g_apa.apa35f,
#                                    apc11 = g_apa.apa35,
#                                    apc13 = l_apc.apc13
#                 WHERE apc01 =g_apa.apa01
#                   AND apc02 =l_apc.apc02
#            IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
#               CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_apa41:",1) 
#               LET g_success = 'N'
#            END IF
#        END FOREACH
#     END IF
#No.FUN-680027--end
#No.TQC-7B0100 -end
   #str MOD-880231 mark
   ##str MOD-850301 add
   # DECLARE t110_firm2_c_apv CURSOR FOR
   #    SELECT * FROM apv_file WHERE apv01=g_apa.apa01
   #                             AND apv03!='DIFF'   #MOD-860267 add
   #
   # FOREACH t110_firm2_c_apv INTO l_apv.*
   #   IF STATUS THEN
   #      CALL cl_err('foreah',STATUS,1)
   #      LET g_success='N'
   #      EXIT FOREACH
   #   END IF
   #
   #   SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
   #     FROM aph_file,apf_file
   #    WHERE aph04=l_apv.apv03 AND aph01=apf01 AND apf41='Y'
   #      AND aph03 IN ('6','7','8','9')
   #   IF g_amt1f IS NULL THEN
   #      LET g_amt1f = 0
   #      LET g_amt1 = 0
   #   END IF
   #   SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
   #     FROM apv_file Where apv03=l_apv.apv03
   #   IF g_amt2f IS NULL THEN
   #      LET g_amt2f = 0
   #      LET g_amt2 = 0
   #   END IF
   #   SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
   #     FROM oob_file,ooa_file
   #    WHERE oob01 = ooa01
   #      AND oob06 = l_apv.apv03
   #      AND oob03 = '2' AND oob04 = '9'
   #      AND ooaconf = 'Y' #須為已確認
   #   IF cl_null(g_amt3f) THEN
   #      LET g_amt3f = 0
   #      LET g_amt3 = 0
   #   END IF
   #   #-----TQC-6C0044---------
   #   #成本分攤
   #   SELECT SUM(aqb04) INTO g_amt4 FROM aqa_file,aqb_file
   #    WHERE aqa01=aqb01 AND aqa04='Y' AND aqaconf = 'Y'
   #      AND aqb02=l_apv.apv03
   #   IF cl_null(g_amt4) THEN
   #      LET g_amt4=0
   #      LET g_amt4f=0
   #   END IF
   #   LET g_amt4f=g_amt4/g_apa.apa14
   # 
   #   LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f
   #   LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4
   #   SELECT * INTO l_apa.* FROM apa_file WHERE apa01=l_apv.apv03
   #   CALL t110_comp_oox(l_apv.apv03) RETURNING g_net
   #   LET l_apa.apa73 = l_apa.apa34 - g_amt1 + g_net
   #   UPDATE apa_file SET apa35f= apa35f-g_amt1f,
   #                       apa35 = apa35 -g_amt1,
   #                       apa73 = apa73 -g_apa.apa73
   #    WHERE apa01 = l_apv.apv03
   #   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
   #      CALL cl_err3("upd","apa_file",l_apv.apv03,"",STATUS,"","upd apa:",1)
   #      LET g_success='N'
   #   END IF
   #   SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
   #     FROM aph_file,apf_file
   #    WHERE aph04=l_apv.apv03 AND aph01=apf01 AND apf41='Y'
   #      AND aph03 IN ('6','7','8','9')
   #      AND aph17 = 1
   # 
   #   IF g_amt1f IS NULL THEN
   #      LET g_amt1f = 0
   #      LET g_amt1 = 0
   #   END IF
   # 
   #   SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
   #     FROM apv_file Where apv03=l_apv.apv03
   #
   #   IF g_amt2f IS NULL THEN
   #      LET g_amt2f = 0
   #      LET g_amt2 = 0
   #   END IF
   #
   #   SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
   #     FROM oob_file,ooa_file
   #    WHERE oob01 = ooa01
   #      AND oob06 = l_apv.apv03
   #      AND oob03 = '2' AND oob04 = '9'
   #      AND ooaconf = 'Y' #須為已確認
   #      AND oob19 = 1
   #
   #   IF cl_null(g_amt3f) THEN
   #      LET g_amt3f = 0
   #      LET g_amt3 = 0
   #   END IF
   #
   #   LET g_amt1f=g_amt1f+g_amt2f+g_amt3f
   #   LET g_amt1=g_amt1+g_amt2+g_amt3
   #   SELECT * INTO l_apc.* FROM apc_file WHERE apc01=l_apv.apv03 AND apc02 =1
   #   CALL t110_comp_oox(l_apv.apv03) RETURNING g_net
   #   LET l_apc.apc13 = l_apc.apc09 - g_amt1 + g_net
   #   UPDATE apc_file set apc10=apc10-g_amt1f,
   #                       apc11=apc11-g_amt1,
   #                       apc13=apc13-l_apc.apc13
   #    WHERE apc01 =l_apv.apv03
   #      AND apc02 =1
   # END FOREACH
   ##end MOD-850301 add
   #end MOD-880231 mark

      #NO:FUN-960117 add Start################################
      ##刪除eB-Online底稿區資料
      IF g_aza.aza75 MATCHES '[Yy]' AND (g_prog = 'aapt110' OR g_prog = 'aapt120') THEN
         CALL aws_ebocli(g_dbs,g_apa.apa01,'*','*','*','*','EBO-120','M010','qry_maxver') RETURNING l_maxkey2
         CALL aws_ebocli(g_dbs,g_apa.apa01,l_maxkey2,'*','*','*','EBO-120','M010','show_transfer')
      END IF
      #NO:FUN-960117 add End###################################

      MESSAGE ""
      IF g_success = 'Y' THEN
         COMMIT WORK
      ELSE
         ROLLBACK WORK
      END IF
   END IF

#No.TQC-740315 --start-- mark
#  #No.FUN-670060 --start--
#  IF g_apy.apydmy3 = 'Y' AND g_apy.apyglcr = 'Y' AND g_success = 'Y' THEN
#     LET g_wc_gl = 'npp01 = "',g_apa.apa01,'" AND npp011 = 1'
#     LET g_str="aapp409 '",g_apz.apz02p,"' '",g_apz.apz02b,"' '",g_apa.apa44,"' 'Y'"
#     CALL cl_cmdrun_wait(g_str)
#     SELECT apa44,apa43 INTO g_apa.apa44,g_apa.apa43 FROM apa_file 
#      WHERE apa01 = g_apa.apa01
#     DISPLAY BY NAME g_apa.apa44
#  END IF 
#  #No.FUN-670060 --end--
#No.TQC-740315 --end--

   IF g_apa_rowid IS NOT NULL THEN
 ### MOD-4A0253
        SELECT apa41,apa35f,apa35,apa63 INTO g_apa.apa41,g_apa.apa35f,g_apa.apa35
         ,g_apa.apa63 FROM apa_file WHERE ROWID=g_apa_rowid
        DISPLAY BY NAME g_apa.apa41,g_apa.apa35f,g_apa.apa35,g_apa.apa63
        CALL t110_unpay()
 ### END MOD-4A0253
   END IF

   #--------#No:FUN-960117 add EBO start --------
   IF g_aza.aza75 MATCHES '[Yy]' AND (g_prog='aapt110' OR g_prog='aapt120') THEN
      CALL aws_ebocli(g_dbs,g_apa.apa01,'*','*','*','*','EBO-120','M010','qry_maxver') RETURNING l_maxkey2
      CALL aws_ebocli(g_dbs,g_apa.apa01,l_maxkey2,'*','*','*','EBO-120','M010','show_transfer')
   END IF
   #--------#No:FUN-960117 add EBO end   --------

END FUNCTION

FUNCTION t110_21_ins(l_apa)
  DEFINE l_apa   RECORD LIKE apa_file.*,
         l_apb   RECORD LIKE apb_file.*,
         toa     RECORD LIKE apa_file.*,
         tob     RECORD LIKE apb_file.*,
         toapk   RECORD LIKE apk_file.*,
         l_azi04        LIKE azi_file.azi04,
         l_tax          LIKE apb_file.apb10,
         l_taxf         LIKE apb_file.apb10,
         l_amt_totf     LIKE apa_file.apa34,
         l_amt_tot      LIKE apa_file.apa34,
         l_sumf         LIKE apa_file.apa34,
         l_sum          LIKE apa_file.apa34,
         l_amt          LIKE apa_file.apa60,
         tr_no          LIKE apa_file.apa01,   #FUN-660117
         l_d_actno      LIKE aps_file.aps21,   #FUN-660117
         l_c_actno      LIKE aps_file.aps22,   #FUN-660117
         l_d_actno1     LIKE aps_file.aps211,  #FUN-680029
         l_c_actno1     LIKE aps_file.aps221,  #FUN-680029
         l_depno        LIKE apa_file.apa22,   #FUN-660117
         to_trtype      LIKE apy_file.apyslip, #No:FUN-690028 VARCHAR(5),              #No.FUN-550030
         li_result      LIKE type_file.num5,   #No:FUN-560002  #No.FUN-690028 SMALLINT
         to_apa02       LIKE type_file.dat,    #No:FUN-690028 DATE,
         l_apr02        LIKE apr_file.apr02,
         l_apa01        LIKE apa_file.apa01,
         to_apa15       LIKE apa_file.apa15,
         to_apa16       LIKE apa_file.apa15,
         to_apa21       LIKE apa_file.apa21,
         to_apa22       LIKE apa_file.apa22,
         to_apa36       LIKE apa_file.apa36,
         inv_no         LIKE apa_file.apa08,
         to_amt         LIKE apa_file.apa06,
         t_apk08        LIKE apk_file.apk08,
         t_apk07        LIKE apk_file.apk07,
         t_apk06        LIKE apk_file.apk06,
         l_diffapk08    LIKE apk_file.apk08,
         l_diffapk07    LIKE apk_file.apk07,
         l_diffapk06    LIKE apk_file.apk06,
         l_apk03        LIKE apk_file.apk03,
         o_apk02        LIKE apk_file.apk02,
         l_apk06        LIKE apk_file.apk06,
         o_apk06        LIKE apk_file.apk06,
         g_t1           LIKE oay_file.oayslip  #FUN-990014 add
  
    INITIALIZE toa.* TO NULL
    INITIALIZE tob.* TO NULL
    INITIALIZE toapk.* TO NULL

    OPEN WINDOW t110_21_w WITH FORM "aap/42f/aapt1101"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
    CALL cl_ui_locale("aapt1101")

    # 若無指定發票時,抓發票金額最大者
    LET to_apa02=l_apa.apa02
    LET to_apa15=l_apa.apa15
    LET to_apa16=l_apa.apa16
    LET to_apa21=g_user
    LET to_apa22=g_grup
    LET to_apa36=l_apa.apa36

    IF g_apa.apa08 !='MISC' THEN
       LET inv_no=l_apa.apa08
    ELSE
       IF cl_null(inv_no) THEN
          DECLARE t110_apk_no CURSOR FOR
           SELECT apk03,apk06 FROM apk_file
            WHERE apk01 = l_apa.apa01 AND apk171 IN ('21','22','25')
            ORDER by apk06 DESC,apk03
          OPEN t110_apk_no
          FETCH t110_apk_no INTO l_apk03,l_apk06
          CLOSE t110_apk_no
          IF STATUS OR cl_null(l_apk03) THEN
             LET l_apk03 = ''
          END IF
          IF cl_null(l_apk06) THEN LET l_apk06 = 0 END IF
          LET inv_no=l_apk03
          LET to_amt=l_apk06
       END IF
    END IF

    DISPLAY BY NAME to_amt
    CALL cl_set_head_visible("","YES")     #No.FUN-6B0033

    INPUT BY NAME to_trtype,to_apa02,to_apa15,to_apa16,to_apa21,to_apa22,
                  to_apa36,inv_no WITHOUT DEFAULTS

       AFTER FIELD to_trtype
          IF NOT cl_null(to_trtype) THEN
            #No:FUN-560002  --start
#            CALL s_check_no(g_sys,to_trtype,"","21","","","")
             CALL s_check_no("aap",to_trtype,"","21","","","")    #No.FUN-A40041
                  RETURNING li_result,to_trtype
             IF (NOT li_result) THEN
                NEXT FIELD to_trtype
             END IF
#            CALL s_apyslip(to_trtype,'21',g_sys)     #檢查單別
#            IF NOT cl_null(g_errno) THEN             #抱歉, 有問題
#               CALL cl_err(to_trtype,g_errno,0)
#               NEXT FIELD to_trtype
#            END IF
            #No:FUN-560002  --end
             LET g_apa.apamksg = g_apy.apyapr   ### MOD-4A0253
          END IF

       AFTER FIELD to_apa15
          IF NOT cl_null(to_apa15) THEN
             SELECT gec04 INTO to_apa16 FROM gec_file
              WHERE gec01 = to_apa15 AND gecacti = 'Y'
               AND gec011='1'  #進項
             IF STATUS THEN
#               CALL cl_err(to_apa15,SQLCA.sqlcode,0)   #No.FUN-660122
                CALL cl_err3("sel","gec_file",to_apa15,"",SQLCA.sqlcode,"","",1)  #No.FUN-660122
                NEXT FIELD apa15
             END IF
             DISPLAY BY NAME to_apa16
          END IF

       AFTER FIELD to_apa21
          IF NOT cl_null(to_apa21) THEN
             SELECT COUNT(*) INTO g_cnt FROM gen_file
              WHERE gen01 = to_apa21
             IF g_cnt = 0 THEN                #抱歉, 有問題
                CALL cl_err(to_apa21,'aap-038',0)
                NEXT FIELD to_apa21
             END IF
             SELECT gen03 INTO to_apa22 FROM gen_file WHERE gen01=to_apa21
             DISPLAY BY NAME to_apa22
          END IF

       AFTER FIELD to_apa22
          IF NOT cl_null(to_apa22) THEN
             SELECT COUNT(*) INTO g_cnt FROM gem_file
              WHERE gem01 = to_apa22
                AND gemacti='Y'   #NO:6950
             IF g_cnt = 0 THEN                #抱歉, 有問題
                CALL cl_err(to_apa22,'aap-039',0)
                NEXT FIELD to_apa22
             END IF
          END IF

       AFTER FIELD to_apa36
          IF NOT cl_null(to_apa36) THEN
             SELECT COUNT(*) INTO g_cnt FROM apr_file
              WHERE apr01 = to_apa36
             IF g_cnt = 0 THEN
                CALL cl_err(to_apa36,'aap-044',0)
                NEXT FIELD to_apa36
             END IF

             SELECT apr02 INTO l_apr02 FROM apr_file WHERE apr01 = to_apa36
             DISPLAY l_apr02 TO FORMONLY.apr02

             LET l_depno = ''
             IF g_apz.apz13 = 'Y' THEN
                LET l_depno = to_apa22
             ELSE
                LET l_depno = ' '
             END IF

             SELECT aps21,aps211,aps22,aps221 INTO l_d_actno,l_d_actno1,l_c_actno,l_c_actno1 FROM aps_file    #No.FUN-680029
              WHERE aps01 = l_depno
          END IF

       AFTER FIELD inv_no
          IF NOT cl_null(inv_no) THEN
             IF g_apa.apa08 !='MISC' AND g_apa.apa08 != inv_no THEN
                LET inv_no=g_apa.apa08
                DISPLAY BY NAME inv_no
                NEXT FIELD inv_no
             END IF

            #str MOD-9C0416 add
             IF g_aza.aza26 = '2' THEN
                SELECT SUM(apk07+apk08) INTO l_amt FROM apk_file
                 WHERE apk01 = l_apa.apa01
                   AND apk03 = inv_no
             ELSE
            #end MOD-9C0416 add
                SELECT SUM(apk07+apk08) INTO l_amt FROM apk_file
                #WHERE apk01 = l_apa.apa01 AND apk171 IN ('21','22','25')         #MOD-A70229 mark     
                 WHERE apk01 = l_apa.apa01 AND apk171 IN ('21','22','25','XX')    #MOD-A70229
                   AND apk03 = inv_no
             END IF   #MOD-9C0416 add
             IF SQLCA.SQLCODE THEN
#               CALL cl_err(inv_no,'aap-151',0)   #No.FUN-660122
                CALL cl_err3("sel","apk_file",l_apa.apa01,inv_no,"app-151","","",1)  #No.FUN-660122
                LET inv_no=l_apk03
                LET to_amt=l_apk06
                DISPLAY BY NAME inv_no,to_amt
                NEXT FIELD inv_no
             END IF

             LET to_amt=l_amt
             DISPLAY BY NAME to_amt

             IF l_amt=0 OR l_amt <(l_apa.apa60+l_apa.apa61) THEN
                #LET g_buf = '此折讓單折讓金額:',
                #    l_apa.apa60+l_apa.apa61 USING '#######&',' 超過此發票金額:',
                #    l_amt USING '#######&'
                 CALL cl_err('','aap-062',0)             #No:MOD-510140
                LET inv_no=l_apk03
                LET to_amt=l_apk06
                DISPLAY BY NAME inv_no,to_amt
                NEXT FIELD inv_no
             END IF
          END IF
 
       AFTER INPUT
           IF NOT cl_null(inv_no) THEN
             #str MOD-9C0416 add
              IF g_aza.aza26 = '2' THEN
                 SELECT SUM(apk07+apk08) INTO l_amt FROM apk_file
                  WHERE apk01 = l_apa.apa01
                    AND apk03 = inv_no
              ELSE
             #end MOD-9C0416 add
                 SELECT SUM(apk07+apk08) INTO l_amt FROM apk_file
                 #WHERE apk01 = l_apa.apa01 AND apk171 IN ('21','22','25')         #MOD-A70229 mark     
                  WHERE apk01 = l_apa.apa01 AND apk171 IN ('21','22','25','XX')    #MOD-A70229
                    AND apk03 = inv_no
              END IF   #MOD-9C0416 add
              IF SQLCA.SQLCODE  THEN
#                CALL cl_err(inv_no,'aap-151',0)   #No.FUN-660122
                 CALL cl_err3("sel","apk_file",l_apa.apa01,inv_no,"app-151","","",1)  #No.FUN-660122
                 LET inv_no=l_apk03 LET to_amt=l_apk06
                 DISPLAY BY NAME inv_no,to_amt
                 NEXT FIELD inv_no
              END IF

              IF cl_null(l_amt) THEN
                 LET l_amt=0
              END IF

              IF l_amt=0 OR l_amt <(l_apa.apa60+l_apa.apa61) THEN
                 #LET g_buf ='此折讓單折讓金額:',
                 #   l_apa.apa60+l_apa.apa61 USING '#######&',' 超過此發票金額:',
                 #   l_amt USING '#######&'
                  CALL cl_err('','aap-062',0)     #No:MOD-510140
                 LET inv_no=l_apk03
                 LET to_amt=l_apk06
                 DISPLAY BY NAME inv_no,to_amt
                 NEXT FIELD inv_no
              END IF
           END IF

        ON ACTION CONTROLZ
           CALL cl_show_req_fields()
 
        ON ACTION CONTROLG
           CALL cl_cmdask()

        ON ACTION CONTROLP
           CASE
              WHEN INFIELD(to_trtype) # 單別
                 #CALL q_apy(FALSE,FALSE,to_trtype,'21',g_sys) RETURNING to_trtype  #TQC-670008
                 CALL q_apy(FALSE,FALSE,to_trtype,'21','AAP') RETURNING to_trtype   #TQC-670008
#                 CALL FGL_DIALOG_SETBUFFER( to_trtype )
                 DISPLAY BY NAME to_trtype
              WHEN INFIELD(to_apa21) # Class
#                CALL q_gen(7,9,to_apa21) RETURNING to_apa21
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_gen"
                 LET g_qryparam.default1 = to_apa21
                 CALL cl_create_qry() RETURNING to_apa21
#                 CALL FGL_DIALOG_SETBUFFER( to_apa21 )
                 DISPLAY BY NAME to_apa21
              WHEN INFIELD(to_apa22) # Class
#                CALL q_gem(7,9,to_apa22) RETURNING to_apa22
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_gem"
                 LET g_qryparam.default1 =to_apa22
                 CALL cl_create_qry() RETURNING to_apa22
#                 CALL FGL_DIALOG_SETBUFFER( to_apa22 )
                 DISPLAY BY NAME to_apa22
              WHEN INFIELD(to_apa15) # Class
#                CALL q_gec(7,9,to_apa15,'1') RETURNING to_apa15
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_gec"
                 LET g_qryparam.default1 =to_apa15
                 LET g_qryparam.arg1 ='1'
                 CALL cl_create_qry() RETURNING to_apa15
#                 CALL FGL_DIALOG_SETBUFFER( to_apa15 )
                 DISPLAY BY NAME to_apa15
              WHEN INFIELD(to_apa36) # Class
#                CALL q_apr(7,9,to_apa36) RETURNING to_apa36
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_apr"
                 LET g_qryparam.default1 =to_apa36
                 CALL cl_create_qry() RETURNING to_apa36
#                 CALL FGL_DIALOG_SETBUFFER( to_apa36 )
                 DISPLAY BY NAME to_apa36
              WHEN INFIELD(inv_no) #INV_NO
#                CALL q_apk(7,9,g_apa.apa01,'1') RETURNING inv_no
                 CALL cl_init_qry_var()
#                 LET g_qryparam.form ="q_apk"   #MOD-5B0255
                 LET g_qryparam.form ="q_apk02"   #MOD-5B0255
                #LET g_qryparam.default1 = g_apa.apa01  #MOD-8A0188 mark
                 LET g_qryparam.default1 = g_apa.apa08  #MOD-8A0188
                 LET g_qryparam.arg1 = g_apa.apa01      #MOD-8A0188 add
                 CALL cl_create_qry() RETURNING inv_no
#                 CALL FGL_DIALOG_SETBUFFER( inv_no )
                 DISPLAY BY NAME inv_no
           END CASE

       ON IDLE g_idle_seconds
          CALL cl_on_idle()
          CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
 
    END INPUT

    IF INT_FLAG THEN
       LET INT_FLAG=0     #No:9599
       CLOSE WINDOW t110_21_w
       RETURN
    END IF

     IF g_flag='1' THEN    #已重新產生要求刪除再重新產生
        DECLARE t110_21_ins_c1 CURSOR FOR
         SELECT apa01 FROM apa_file
          WHERE apa00='21' AND apa08=l_apa.apa01 AND apa58='1'

        FOREACH t110_21_ins_c1 INTO l_apa01
          DELETE FROM apa_file WHERE apa00='21' AND apa01=l_apa01
          IF SQLCA.SQLCODE OR STATUS THEN
#            CALL cl_err('del 21_apa:',SQLCA.SQLCODE,1)   #No.FUN-660122
             CALL cl_err3("del","apa_file",l_apa01,"",SQLCA.sqlcode,"","del 21_apa:",1)  #No.FUN-660122
             LET g_success='N'
             EXIT FOREACH
          END IF

          DELETE FROM apb_file WHERE apb01=l_apa01
          IF SQLCA.SQLCODE OR STATUS THEN
#            CALL cl_err('del 21_apb:',SQLCA.SQLCODE,1)   #No.FUN-660122
             CALL cl_err3("del","apb_file",l_apa01,"",SQLCA.sqlcode,"","del 21_apb:",1)  #No.FUN-660122
             LET g_success='N'
             EXIT FOREACH
          END IF

#No.FUN-680027--begin
          DELETE FROM apc_file WHERE apc01=l_apa01
          IF SQLCA.SQLCODE OR STATUS THEN
             CALL cl_err3("del","apc_file",l_apa01,"",SQLCA.sqlcode,"","del 21_apc:",1) 
             LET g_success='N'
             EXIT FOREACH
          END IF
#No.FUN-680027--end

          DELETE FROM apk_file WHERE apk01=l_apa01
          IF SQLCA.SQLCODE OR STATUS THEN
#            CALL cl_err('del 21_apk:',SQLCA.SQLCODE,1)   #No.FUN-660122
             CALL cl_err3("del","apk_file",l_apa01,"",SQLCA.sqlcode,"","del 21_apk:",1)  #No.FUN-660122
             LET g_success='N'
             EXIT FOREACH
          END IF
        END FOREACH
      END IF

      IF g_success='N' THEN
         RETURN
      END IF

      LET toa.apa00 = '21'
#No:FUN-560060  --start
#      CALL s_apyauno(to_trtype,to_apa02,toa.apa00) RETURNING g_i,tr_no
      CALL s_auto_assign_no("aap",to_trtype,to_apa02,toa.apa00,"","","","","")
      RETURNING li_result,tr_no
#No:FUN-560060  --end
      LET toa.apa01 = tr_no
      LET toa.apa02 = to_apa02
      LET toa.apa09 = l_apa.apa09
      LET toa.apa05 = l_apa.apa05
      LET toa.apa06 = l_apa.apa06
      LET toa.apa07 = l_apa.apa07
      LET toa.apa18 = l_apa.apa18
      LET toa.apa17 = l_apa.apa17
     #LET toa.apa171= '23'          #MOD-AC0128 mark
      LET toa.apa171= l_apa.apa171  #MOD-AC0128 
     #-MOD-AC0128-add-
      CASE 
         WHEN (toa.apa171 = '21' OR toa.apa171 = '25' OR toa.apa171 = '26')
           LET toa.apa171  = '23' 
         WHEN (toa.apa171 = '22' OR toa.apa171 = '27')
           LET toa.apa171  = '24'
         WHEN (toa.apa171 = '28')
           LET toa.apa171  = '29'
         WHEN (toa.apa171 = 'XX')
           LET toa.apa171  = 'XX'
      END CASE 
     #-MOD-AC0128-end- 
      LET toa.apa172= l_apa.apa172
      LET toa.apa08 = l_apa.apa01
     #LET toa.apa11 = NULL   #MOD-7B0101
      LET toa.apa11 = l_apa.apa11   #MOD-7B0101
      LET toa.apa12 = NULL
      LET toa.apa13 = l_apa.apa13
      LET toa.apa14 = l_apa.apa14    #No:MOD-530439
      LET toa.apa15 = to_apa15
      LET toa.apa16 = to_apa16
      LET toa.apa175= NULL
      LET toa.apa19 = NULL
      LET toa.apa20 = 0
      LET toa.apa21 = to_apa21
      LET toa.apa22 = to_apa22
      LET toa.apa24 = NULL
      LET toa.apa33f= 0
      LET toa.apa33 = 0
      LET toa.apa65f= 0
      LET toa.apa65 = 0
      LET toa.apa36 = to_apa36
      LET toa.apa31f= l_apa.apa60f
      LET toa.apa31 = l_apa.apa60
      LET toa.apa32f= l_apa.apa61f
      LET toa.apa32 = l_apa.apa61
      LET toa.apa35f= toa.apa31f+toa.apa32f
      LET toa.apa35 = toa.apa31 +toa.apa32
      LET toa.apa34f= toa.apa35f
      LET toa.apa34 = toa.apa35
      LET toa.apa57 = toa.apa31
      LET toa.apa57f= toa.apa31f
      LET toa.apa41 = 'Y'
      LET toa.apa42 = 'N'
      LET toa.apa44 = NULL
      LET toa.apa51 = l_c_actno
      LET toa.apa54 = l_d_actno
      LET toa.apa53 = NULL
#No.FUN-680029--begin
      IF g_aza.aza63 ='Y' THEN
         LET toa.apa511= l_c_actno1
         LET toa.apa541= l_d_actno1
         LET toa.apa531= NULL
      END IF
#No.FUN-680029--end
      LET toa.apa56 = '0'
      LET toa.apa58 = '1'
      LET toa.apa60f= 0
      LET toa.apa60 = 0
      LET toa.apa61f= 0
      LET toa.apa61 = 0
      LET toa.apa72 = toa.apa14
      #No.MOD-590312  --begin
      CALL t110_comp_oox(toa.apa01) RETURNING g_net
      LET toa.apa73 = toa.apa34-toa.apa35 + g_net
      #No.MOD-590312  --end
      LET toa.apa74 = 'N'
      LET toa.apa75 = 'N'
      LET toa.apaacti = 'Y'
      LET toa.apauser = g_user
      LET toa.apagrup = g_grup
      LET toa.apadate = g_today
      LET toa.apa930=l_apa.apa930  #FUN-670064
      #FUN-990014--Begin
      CALL s_get_doc_no(toa.apa01) RETURNING g_t1
      SELECT apyvcode INTO toa.apa77  FROM apy_file WHERE apyslip = g_t1   
      IF cl_null(toa.apa77) THEN 
         LET toa.apa77 = g_apz.apz63  #FUN-970108 add
      END IF     
      #FUN-990014---End
      
      DISPLAY "insert apa:",toa.apa01,' ',toa.apa02,' ',toa.apa06 AT 2,1

      INSERT INTO apa_file VALUES(toa.*)
      IF STATUS THEN
#        CALL cl_err('t110_21_ins(ckp#1):',SQLCA.sqlcode,1)   #No.FUN-660122
         CALL cl_err3("ins","apa_file",toa.apa01,"",SQLCA.sqlcode,"","t110_21_ins(ckp#1):",1)  #No.FUN-660122
         LET g_success = 'N'
      END IF
#No.FUN-680027--begin
      CALL t110_ins_apc(toa.*)
#No.FUN-680027--end
     IF l_apa.apa08 = 'MISC' THEN
        IF NOT cl_null(inv_no) THEN
           LET l_apk03=inv_no
        END IF
        IF cl_null(l_apk03) THEN
           LET l_apk03=' '
        END IF
     END IF

  #str CHI-850032 add
  #在確認段寫入apk_file前,先檢核apk_file是否存在,若是則先刪除再新增
   DELETE FROM apk_file WHERE apk01=toa.apa01
   IF SQLCA.SQLCODE OR STATUS THEN
#     CALL cl_err('del 21_apk:',SQLCA.SQLCODE,1)   #No.FUN-660122
      CALL cl_err3("del","apk_file",toa.apa01,"",SQLCA.sqlcode,"","del 21_apk:",1)  #No.FUN-660122
   END IF
  #end CHI-850032 add

   INITIALIZE tob.* TO NULL
   INITIALIZE toapk.* TO NULL
   LET tob.apb01 = tr_no
   LET tob.apb02 = 0
   LET l_amt_totf= 0
   LET l_amt_tot = 0
   LET tob.apb13f= 0
   LET tob.apb13 = 0
   LET tob.apb14f= 0
   LET tob.apb14 = 0
   LET tob.apb15 = 0
   LET o_apk06 = 0
   LET o_apk02 = 0

   SELECT azi04 INTO l_azi04 FROM azi_file WHERE azi01 = l_apa.apa13

   DECLARE t110_21_ins CURSOR FOR
    SELECT * FROM apb_file WHERE apb01 = l_apa.apa01
                             AND apb14 !=0

   FOREACH t110_21_ins INTO l_apb.*
      IF STATUS THEN
         CALL cl_err('foreach 21',STATUS,0)   
         EXIT FOREACH
      END IF

      LET tob.apb02 = tob.apb02 + 1

      IF l_apb.apb13f IS NULL THEN
         LET l_apb.apb13f = 0
      END IF

      IF l_apb.apb14f IS NULL THEN
         LET l_apb.apb14f = 0
      END IF

      IF l_apb.apb15 IS NULL THEN
         LET l_apb.apb15 = 0
      END IF

      IF l_apb.apb14f = 0 THEN
         LET l_apb.apb14f = l_apb.apb14
      END IF

      LET l_amt_totf= l_amt_totf+ l_apb.apb14f
      LET l_amt_tot = l_amt_tot + l_apb.apb14
      LET tob.apb03 = l_apb.apb03
      LET tob.apb12 = l_apb.apb12
      LET tob.apb23 = l_apb.apb13f
      LET tob.apb08 = l_apb.apb13
      LET tob.apb081= l_apb.apb13
      LET tob.apb09 = l_apb.apb15
      LET tob.apb24 = l_apb.apb14f
      LET tob.apb10 = l_apb.apb14
      LET tob.apb101= l_apb.apb14

      IF l_apa.apa08 = 'MISC' THEN
         LET tob.apb11 = l_apk03
      ELSE
         LET tob.apb11 = l_apa.apa08
      END IF

      LET tob.apb21 = l_apb.apb21
      LET tob.apb31 = l_apb.apb31  #FUN-630055 add
      LET tob.apb22 = l_apb.apb22
      LET tob.apb34 = 'N'          #No.TQC-7B0083
      LET tob.apb27 = l_apb.apb27
      LET tob.apb28 = l_apb.apb28
      LET tob.apb35 = l_apb.apb35  #FUN-810045
      LET tob.apb36 = l_apb.apb36  #FUN-810045
      LET tob.apb29 = '3'
      LET tob.apb06 = l_apb.apb06
      LET tob.apb07 = l_apb.apb07
      LET tob.apb930 = l_apb.apb930 #FUN-670064

      INSERT INTO apb_file VALUES(tob.*)
      IF STATUS OR SQLCA.SQLCODE THEN
#        CALL cl_err('t110_21_apb(ckp#2):',SQLCA.sqlcode,1)   #No.FUN-660122
         CALL cl_err3("ins","apb_file",tob.apb01,tob.apb02,SQLCA.sqlcode,"","t110_21_apb(ckp#2):",1)  #No.FUN-660122
         LET g_success = 'N'
      END IF

      UPDATE apa_file SET apa59 = 'Y' WHERE apa01 = l_apa.apa01
      #-----MOD-730098---------
      IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
         CALL cl_err3("upd","apa_file",l_apa.apa01,"",STATUS,"","upd apa:",1)
         LET g_success = 'N'
      END IF
      #-----END MOD-730098-----

      UPDATE apb_file SET apb16 = 'Y'
       WHERE apb01 = l_apb.apb01 and apb02 = l_apb.apb02
 
     LET toapk.apk01   = tob.apb01                    #折讓單
     LET toapk.apk02   = tob.apb02                    #項次
     LET toapk.apk03   = tob.apb11                    #發票號碼
     LET toapk.apk04   = toa.apa18                    #統一編號
    #LET toapk.apk05   = toa.apa09                    #發票日期  #MOD-B20017 mark
    #-MOD-B20017-add-
     LET toapk.apk05   = NULL  
     DECLARE t110_apk05_c2 SCROLL CURSOR FOR 
       SELECT apk05 FROM apk_file WHERE apk03=toapk.apk03
     OPEN t110_apk05_c2
     FETCH FIRST t110_apk05_c2 INTO toapk.apk05
     CLOSE t110_apk05_c2
     IF cl_null(toapk.apk05) THEN
        DECLARE t110_amd05_c2 SCROLL CURSOR FOR 
          SELECT amd05 FROM amd_file WHERE amd03=toapk.apk03
        OPEN t110_amd05_c2
        FETCH FIRST t110_amd05_c2 INTO toapk.apk05
        CLOSE t110_amd05_c2
     END IF 
    #-MOD-B20017-end-
     LET l_tax  = tob.apb10 * toa.apa16 /100
    #CALL cl_digcut(l_tax ,l_azi04) RETURNING l_tax   #No.TQC-CC0035   Mark
     CALL cl_digcut(l_tax ,g_azi04) RETURNING l_tax   #No.TQC-CC0035   Add
     LET toapk.apk07   = l_tax                        #稅額
     LET toapk.apk08   = tob.apb10                    #未稅金額
     LET toapk.apk06   = toapk.apk07 + toapk.apk08    #含稅金額
     LET toapk.apk06   = cl_digcut(toapk.apk06,g_azi04)
     LET toapk.apk07   = cl_digcut(toapk.apk07,g_azi04)
     LET toapk.apk08   = cl_digcut(toapk.apk08,g_azi04)
     LET toapk.apk11   = toa.apa15
     LET toapk.apk29   = toa.apa16
     LET toapk.apk12   = toa.apa13
     LET toapk.apk13   = toa.apa14
     LET toapk.apk07f  = tob.apb24 * toapk.apk29 / 100
     LET toapk.apk08f  = tob.apb24
     LET toapk.apk06f  = toapk.apk07f + toapk.apk08f
     LET toapk.apk06f  = cl_digcut(toapk.apk06f,l_azi04)
     LET toapk.apk07f  = cl_digcut(toapk.apk07f,l_azi04)
     LET toapk.apk08f  = cl_digcut(toapk.apk08f,l_azi04)
     LET toapk.apk09   = ' '
     LET toapk.apk10   = ' '
     LET toapk.apk17   = toa.apa17
    #LET toapk.apk171  = '23'          #MOD-AC0128 mark
     LET toapk.apk171  = toa.apa171    #MOD-AC0128 
    #-MOD-AC0128-add-
     CASE 
        WHEN (toapk.apk171 = '21' OR toapk.apk171 = '25' OR toapk.apk171 = '26')
          LET toapk.apk171  = '23' 
        WHEN (toapk.apk171 = '22' OR toapk.apk171 = '27')
          LET toapk.apk171  = '24'
        WHEN (toapk.apk171 = '28')
          LET toapk.apk171  = '29'
        WHEN (toapk.apk171 = 'XX')
          LET toapk.apk171  = 'XX'
     END CASE 
    #-MOD-AC0128-end- 
 
     IF toapk.apk06 > o_apk06 THEN  #取最大金額的項次為調整尾差用No.B096
        LET o_apk02=toapk.apk02
        LET o_apk06=toapk.apk06
     END IF

     LET toapk.apk172  = toa.apa172
     LET toapk.apk173  = 0
     LET toapk.apk174  = 0
    #LET toapk.apk175  = 0       #MOD-A30142 mark
     LET toapk.apk175  = NULL    #MOD-A30142 add
     LET toapk.apk22   = ' '
     LET toapk.apk25   = tob.apb12
     LET toapk.apk26   = l_apb.apb01
     LET toapk.apk27   = l_apb.apb02
     LET toapk.apkacti = 'Y'
     LET toapk.apkuser = g_user
     LET toapk.apkgrup = g_grup
     LET toapk.apkdate = today
    #FUN-990014--Begin
    ##FUN-970108---Begin
    #IF NOT cl_null(g_apa.apa77) THEN 
    #   LET toapk.apk32 = g_apa.apa77
    #ELSE 
    #	  LET toapk.apk32 = g_apz.apz63
    #END IF 	  
    ##FUN-970108---End

    IF NOT cl_null(g_apa.apa77) THEN 
       LET toapk.apk32 = g_apa.apa77
    ELSE
       CALL s_get_doc_no(toapk.apk01) RETURNING g_t1
       SELECT apyvcode INTO toapk.apk32  FROM apy_file WHERE apyslip = g_t1   
        IF cl_null(toapk.apk32) THEN 
           LET toapk.apk32 = g_apz.apz63  
        END IF
    END IF
    #FUN-990014---End     
     INSERT INTO apk_file VALUES (toapk.*)
        IF STATUS OR SQLCA.SQLCODE THEN
#          CALL cl_err('21_ins_apk(ckp#3):',SQLCA.sqlcode,1)   #No.FUN-660122
           CALL cl_err3("ins","apk_file",toapk.apk01,toapk.apk02,SQLCA.sqlcode,"","21_ins_apk(ckp#3):",1)  #No.FUN-660122
           LET g_success = 'N'
        END IF
   END FOREACH

   CLOSE WINDOW t110_21_w

   IF g_success = 'Y' THEN
      CALL t110_chkapk(tr_no,g_apa.apa01,'1')
   END IF

END FUNCTION

#FUNCTION t110_ins_apg(p_apa51)      #MOD-880080 增加傳入值   #TQC-890010 mark
FUNCTION t110_ins_apg()                                       #TQC-890010
 #DEFINE p_apa51        LIKE apa_file.apa51      #MOD-880080 add   #TQC-890010 mark
  DEFINE l_apg          RECORD LIKE apg_file.*
  DEFINE l_apa00        LIKE apa_file.apa00      #No.TQC-5C0093 
  DEFINE l_api          RECORD LIKE api_file.*
  DEFINE l_amtf,l_amt   LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079

  #CALL t110_ins_apf()  #No:MOD-650063 Mark   #MOD-660142 mark回復   #MOD-680036

  IF g_success='N' THEN
     RETURN
  END IF

  DECLARE api_c CURSOR FOR
      SELECT * FROM api_file WHERE api01=m_apa.apa01 AND api02='2'

 #str MOD-880080 mod
  LET l_apg.apg02 = 0   #TQC-890010 mark回復
#str TQC-890010 mark
# IF p_apa51='UNAP' THEN
#    LET l_apg.apg02 = 1
# ELSE
#    LET l_apg.apg02 = 0
# END IF
#end TQC-890010 mark
 #end MOD-880080 mod

  FOREACH api_c INTO l_api.*
     LET l_apg.apg01 =m_apa.apa01
     LET l_apg.apg02 =l_apg.apg02+1
     LET l_apg.apg03 = g_plant #MOD-970197
     LET l_apg.apg04 =l_api.api26
     LET l_apg.apg06 =l_api.api40      #No.FUN-680027
#No.TQC-5C0093--BEGIN                                                                                                               
     LET l_apa00 = ''   #MOD-750048
     SELECT apa00 INTO l_apa00 FROM apa_file                                                                                        
      WHERE apa01 = l_api.api26                                                                                                     
     #IF l_apa00 = '21' THEN       #MOD-750056                                                                                                    
     IF l_apa00 = '26' THEN       #MOD-750056                                                                                                    
        IF l_api.api05f<0 THEN                                                                                                      
            LET l_api.api05f= l_api.api05f*(-1)                                                                                     
        END IF                                                                                                                      
        IF l_api.api05 <0 THEN                                                                                                      
            LET l_api.api05 = l_api.api05 *(-1)                                                                                     
        END IF                                                                                                                      
     END IF                                                                                                                         
#No.TQC-5C0093--END  
     LET l_apg.apg05f=l_api.api05f
     LET l_apg.apg05 =l_api.api05
     IF cl_null(l_apg.apg05f) THEN LET l_apg.apg05f=0 END IF   #MOD-960329 add
     IF cl_null(l_apg.apg05)  THEN LET l_apg.apg05 =0 END IF   #MOD-960329 add
     INSERT INTO apg_file VALUES(l_apg.*)
     IF STATUS OR SQLCA.SQLCODE THEN
#       CALL cl_err('ins apg:',SQLCA.SQLCODE,1)   #No.FUN-660122
        CALL cl_err3("ins","apg_file",l_apg.apg01,l_apg.apg02,SQLCA.sqlcode,"","ins apg:",1)  #No.FUN-660122
        LET g_success='N'
     END IF

     IF l_api.api26 <> 'DIFF' THEN   #MOD-720023 
        SELECT SUM(apg05f),SUM(apg05) INTO l_amtf,l_amt
          FROM apg_file,apf_file
         WHERE apg04=l_api.api26 AND apg01=apf01 AND apf41='Y'
        
        IF l_amtf IS NULL THEN
           LET l_amtf=0
        END IF
        
        IF l_amt  IS NULL THEN
           LET l_amt =0
        END IF
        
        #No.MOD-590312  --begin
        CALL t110_comp_oox(l_api.api26) RETURNING g_net
        UPDATE apa_file SET apa35f = l_amtf,
                            apa35 = l_amt,
                            apa73 = apa34-l_amt + g_net
         WHERE apa01 = l_api.api26
        #No.MOD-590312  --end
        #IF STATUS OR SQLCA.SQLCODE THEN   #MOD-720023
        IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN   #MOD-720023
#          CALL cl_err('upd apa35: ',SQLCA.SQLCODE,1)   #No.FUN-660122
           CALL cl_err3("upd","apa_file",l_api.api26,"",SQLCA.sqlcode,"","upd apa35:",1)  #No.FUN-660122
           LET g_success='N'
        END IF

        #No.FUN-680027--begin
        SELECT SUM(apg05f),SUM(apg05) INTO l_amtf,l_amt
          FROM apg_file,apf_file
         WHERE apg04=l_api.api26 AND apg01=apf01 AND apf41='Y'
           AND apg06=l_api.api40
        
        IF l_amtf IS NULL THEN
           LET l_amtf=0
        END IF
        
        IF l_amt  IS NULL THEN
           LET l_amt =0
        END IF
        
        #No.FUN-7B0055  --Begin
        #CALL t110_comp_oox(l_api.api26) RETURNING g_net
        CALL t110_comp_oox1(l_api.api26,l_api.api40) RETURNING g_net
        #No.FUN-7B0055  --End  
        UPDATE apc_file SET apc10 = l_amtf,
                            apc11 = l_amt,
                            apc13 = apc09-l_amt + g_net
         WHERE apc01 = l_api.api26
           AND apc02 = l_api.api40
        #IF STATUS OR SQLCA.SQLCODE THEN   #MOD-720023
        IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN   #MOD-720023
           CALL cl_err3("upd","apc_file",l_api.api26,"",SQLCA.sqlcode,"","",1) 
           LET g_success='N'
        END IF
        #No.FUN-680027--end
     END IF   #MOD-720023
  END FOREACH
END FUNCTION

FUNCTION t110_ins_apg0()
  DEFINE l_apg          RECORD LIKE apg_file.*
  DEFINE l_api          RECORD LIKE api_file.*
  DEFINE l_amtf,l_amt   LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
  DEFINE l_cnt1         LIKE type_file.num5      #No.TQC-7B0083

  #No.TQC-7B0083  --Begin
  LET l_cnt1 = 0 
  SELECT COUNT(*) INTO l_cnt1 FROM apb_file
   WHERE apb01 = m_apa.apa01
     AND apb34 = 'Y'
  #No.TQC-7B0083  --End  
  IF m_apa.apa51='UNAP' OR l_cnt1 > 0 THEN ELSE  #No.TQC-7B0083
     CALL t110_ins_apf()
     IF g_success='N' THEN
        RETURN
     END IF
  END IF

  LET l_apg.apg01 =m_apa.apa01
  LET l_apg.apg02 =0
  LET l_apg.apg03 = g_plant #MOD-970197
  LET l_apg.apg04 =m_apa.apa01

  SELECT SUM(aph05f) INTO l_apg.apg05f FROM aph_file WHERE aph01=m_apa.apa01

  SELECT SUM(aph05)  INTO l_apg.apg05  FROM aph_file WHERE aph01=m_apa.apa01

  IF l_apg.apg05f IS NULL THEN LET l_apg.apg05f = 0 END IF
  IF l_apg.apg05  IS NULL THEN LET l_apg.apg05  = 0 END IF

  INSERT INTO apg_file VALUES(l_apg.*)
  IF STATUS OR SQLCA.SQLCODE THEN
#    CALL cl_err('ins apg:',SQLCA.SQLCODE,1)   #No.FUN-660122
     CALL cl_err3("ins","apg_file",l_apg.apg01,l_apg.apg02,SQLCA.sqlcode,"","ins apg:",1)  #No.FUN-660122
     LET g_success='N'
  END IF

END FUNCTION

FUNCTION t110_ins_apf()
   DEFINE l_apf     RECORD LIKE apf_file.*
 
   INITIALIZE l_apf.* TO NULL
 
   #-----MOD-780274--------- 
   #LET l_apf.apf00 ='11'
   IF g_apa.apa51 = 'UNAP' THEN
      LET l_apf.apf00 = '11'
   ELSE
      LET l_apf.apf00 = '16'
   END IF
   #-----END MOD-780274-----
   LET l_apf.apf01 =m_apa.apa01
   LET l_apf.apf02 =m_apa.apa02
   LET l_apf.apf03 =m_apa.apa06
   LET l_apf.apf04 =m_apa.apa21
   LET l_apf.apf05 =m_apa.apa22
   LET l_apf.apf06 =m_apa.apa13
   LET l_apf.apf07 =m_apa.apa14
   #LET l_apf.apf08f=m_apa.apa31f   #MOD-8A0004   
   #LET l_apf.apf08 =m_apa.apa31    #MOD-8A0004
   LET l_apf.apf08f=m_apa.apa35f   #MOD-8A0004   
   LET l_apf.apf08 =m_apa.apa35    #MOD-8A0004
   LET l_apf.apf09f=0
   LET l_apf.apf09 =0
   #LET l_apf.apf10f=m_apa.apa31f   #MOD-8A0004
   #LET l_apf.apf10 =m_apa.apa31    #MOD-8A0004
   LET l_apf.apf10f=m_apa.apa35f   #MOD-8A0004
   LET l_apf.apf10 =m_apa.apa35    #MOD-8A0004
   LET l_apf.apf12 =m_apa.apa07
   LET l_apf.apf13 =m_apa.apa18
   LET l_apf.apf41 ='Y'
   LET l_apf.apfinpd=TODAY
   LET l_apf.apfmksg='N'
   LET l_apf.apfacti='Y'
   INSERT INTO apf_file VALUES(l_apf.*)
   IF STATUS OR SQLCA.SQLCODE THEN
#     CALL cl_err('ins apf:',SQLCA.SQLCODE,1)   #No.FUN-660122
      CALL cl_err3("ins","apf_file",l_apf.apf01,"",SQLCA.sqlcode,"","ins apf:",1)  #No.FUN-660122
      LET g_success='N' 
   END IF
END FUNCTION

FUNCTION t110_del_apg()
   DEFINE l_api          RECORD LIKE api_file.*
   DEFINE l_amtf,l_amt   LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
 
   DELETE FROM apf_file WHERE apf01=g_apa.apa01
   IF STATUS THEN
#     CALL cl_err('del apf:',STATUS,1)   #No.FUN-660122
      CALL cl_err3("del","apf_file",g_apa.apa01,"",STATUS,"","del apf:",1)  #No.FUN-660122
      LET g_success='N'
   END IF
 
   DELETE FROM apg_file WHERE apg01=g_apa.apa01
   IF STATUS THEN
#     CALL cl_err('del apg:',STATUS,1)   #No.FUN-660122
      CALL cl_err3("del","apg_file",g_apa.apa01,"",STATUS,"","del apg:",1)  #No.FUN-660122
      LET g_success='N'
   END IF

   DECLARE api_del_c CURSOR FOR
     #SELECT * FROM api_file WHERE api01=g_apa.apa01 AND api02='2'    #MOD-790010
     SELECT * FROM api_file WHERE api01=g_apa.apa01 AND api02='2' AND api26 <> 'DIFF'   #MOD-790010

   FOREACH api_del_c INTO l_api.*
      SELECT SUM(apg05f),SUM(apg05) INTO l_amtf,l_amt
        FROM apg_file,apf_file
       WHERE apg04=l_api.api26 AND apg01=apf01 AND apf41='Y'

      IF l_amtf IS NULL THEN
         LET l_amtf=0
      END IF

      IF l_amt  IS NULL THEN
         LET l_amt =0
      END IF

      #No.MOD-590312  --begin
      CALL t110_comp_oox(l_api.api26) RETURNING g_net
      UPDATE apa_file SET apa35f= l_amtf,
                          apa35 = l_amt,
                          apa73 = apa34 - l_amt + g_net
       WHERE apa01=l_api.api26
      #No.MOD-590312  --end
      #IF STATUS OR SQLCA.SQLCODE THEN   #MOD-730098
      IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
#        CALL cl_err('upd apa35',SQLCA.SQLCODE,1)   #No.FUN-660122
         CALL cl_err3("upd","apa_file",l_api.api26,"",SQLCA.sqlcode,"","upd apa35",1)  #No.FUN-660122
         LET g_success='N'
      END if
#No.FUN-680027--begin
      SELECT SUM(apg05f),SUM(apg05) INTO l_amtf,l_amt
        FROM apg_file,apf_file
       WHERE apg04=l_api.api26 AND apg01=apf01 AND apf41='Y'
         AND api40 =l_api.api40

      IF l_amtf IS NULL THEN
         LET l_amtf=0
      END IF

      IF l_amt  IS NULL THEN
         LET l_amt =0
      END IF

      #No.FUN-7B0055  --Begin
      #CALL t110_comp_oox(l_api.api26) RETURNING g_net
      CALL t110_comp_oox1(l_api.api26,l_api.api40) RETURNING g_net
      #No.FUN-7B0055  --End  
      UPDATE apc_file SET apc10 = l_amtf,
                          apc11 = l_amt,
                          apc13 = apc09 - l_amt + g_net
       WHERE apc01=l_api.api26
         AND apc02=l_api.api40
      IF STATUS OR SQLCA.SQLCODE THEN
         CALL cl_err3("upd","apc_file",l_api.api26,"",SQLCA.sqlcode,"","upd apc11",1) 
         LET g_success='N'
      END if
#No.FUN-680027--end
   END FOREACH
END FUNCTION

FUNCTION t110_del_apg0()

   DELETE FROM apf_file WHERE apf01=g_apa.apa01
   IF STATUS THEN
#     CALL cl_err('del apf:',STATUS,1)   #No.FUN-660122
      CALL cl_err3("del","apf_file",g_apa.apa01,"",STATUS,"","del apf:",1)  #No.FUN-660122
      LET g_success='N'
   END IF

END FUNCTION

FUNCTION t110_aph_upd(u_sw)
   DEFINE u_sw            LIKE type_file.num5      # No:FUN-690028 SMALLINT
   DEFINE l_amtf,l_amt    LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_amt3f,l_amt3  LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE t1,t2           LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079

   DECLARE t110_bu_c2 CURSOR FOR
        SELECT * FROM aph_file
        #WHERE aph01=m_apa.apa01 AND aph03 MATCHES '[26789]'   #MOD-740057
        WHERE aph01=m_apa.apa01 AND aph03 IN ('2','6','7','8','9','B')   #MOD-740057

   FOREACH t110_bu_c2 INTO m_aph.*
     IF m_aph.aph03 MATCHES '[6789]' THEN   #MOD-740057
#-----MOD-7B0180---------
{
        SELECT SUM(aph05f),SUM(aph05) INTO l_amtf,l_amt
          FROM aph_file,apf_file
         WHERE aph04=m_aph.aph04 AND aph01=apf01 AND apf41='Y'
           AND aph03 IN ('0','6','7','8','9')        #No:8620
           
        IF STATUS THEN
#          CALL cl_err('sum h05',STATUS,1)   #No.FUN-660122
           CALL cl_err3("sel","aph_file,apf_file",m_aph.aph04,"",STATUS,"","sum h05",1)  #No.FUN-660122
           LET g_success='N'
        END IF
        
        IF l_amtf IS NULL THEN
           LET l_amtf = 0
        END IF
        
        IF l_amt  IS NULL THEN
           LET l_amt  = 0
        END IF
        
        SELECT SUM(apv04f),SUM(apv04) into t1,t2
          FROM apv_file WHERE apv03=m_aph.aph04
        
        IF t1 IS NULL THEN
           LET t1 = 0
        END IF
        
        IF t2 IS NULL THEN
           LET t2 = 0
        END IF
        
        #No:8620
        #SELECT SUM(oob09),SUM(oob10) INTO l_amt3f,l_amt3
        #  FROM oob_file
        # WHERE oob06 = m_aph.aph04 AND oob03 = '1' AND oob04 = '9'
        
        IF cl_null(l_amt3f) THEN
           LET l_amt3f = 0
           LET l_amt3 = 0
        END IF
        
        #No.MOD-590312  --begin
        CALL t110_comp_oox(m_aph.aph04) RETURNING g_net
        UPDATE apa_file SET apa35f= l_amtf + t1 + l_amt3f,
                            apa35 = l_amt + t2 + l_amt3,
                            apa73 = apa34 - (l_amt + t2 + l_amt3) + g_net
          WHERE apa01=m_aph.aph04              #No:9695 #No:MOD-510184 當直接付款沖待抵時,科目存待抵帳款編號
        #No.MOD-590312  --end
        
        #IF STATUS OR SQLCA.SQLCODE THEN   #MOD-730098
        IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
#          CALL cl_err('u_apa35',SQLCA.SQLCODE,1)   #No.FUN-660122
           CALL cl_err3("upd","apa_file",m_aph.aph04,"",SQLCA.sqlcode,"","u_apa35",1)  #No.FUN-660122
           LET g_success='N'
        END if

#No.FUN-680027--begin     
        SELECT SUM(aph05f),SUM(aph05) INTO l_amtf,l_amt
         FROM aph_file,apf_file
        WHERE aph04=m_aph.aph04 AND aph01=apf01 AND apf41='Y'
          AND aph03 MATCHES "[06789]"        #No:8620
          AND aph17 =m_aph.aph17
        IF STATUS THEN
           CALL cl_err3("sel","aph_file,apf_file",m_aph.aph04,"",STATUS,"","sum h05",1) 
           LET g_success='N'
        END IF
        
        IF l_amtf IS NULL THEN
           LET l_amtf = 0
        END IF
        
        IF l_amt  IS NULL THEN
           LET l_amt  = 0
        END IF
        
        SELECT SUM(apv04f),SUM(apv04) into t1,t2
          FROM apv_file WHERE apv03=m_aph.aph04
                          AND apv05=m_aph.aph17
        
        IF t1 IS NULL THEN
           LET t1 = 0
        END IF
        
        IF t2 IS NULL THEN
           LET t2 = 0
        END IF
        
        
        IF cl_null(l_amt3f) THEN
           LET l_amt3f = 0
           LET l_amt3 = 0
        END IF
        
        #No.FUN-7B0055  --Begin 
        #CALL t110_comp_oox(m_aph.aph04) RETURNING g_net
        CALL t110_comp_oox1(m_aph.aph04,m_aph.aph17) RETURNING g_net
        #No.FUN-7B0055  --End   
        UPDATE apc_file SET apc10 = l_amtf + t1 + l_amt3f,
                            apc11 = l_amt + t2 + l_amt3,
                            apc13 = apc09 - (l_amt + t2 + l_amt3) + g_net
          WHERE apc01=m_aph.aph04              #No:9695 #No:MOD-510184 當直接付款沖待抵時,科目存待抵帳款編號
            AND apc02=m_aph.aph17
        
        IF STATUS OR SQLCA.SQLCODE THEN
        
           CALL cl_err3("upd","apc_file",m_aph.aph04,"",SQLCA.sqlcode,"","u_apc35",1)  
           LET g_success='N'
        END IF
#No.FUN-680027--end
}
#-----END MOD-7B0180-----
      ELSE    #MOD-740057
         IF u_sw=1 THEN
            CALL t110_ins_nme()
         END IF
      #-----MOD-740057---------
         #IF u_sw=-1 THEN   #MOD-750143
         #   CALL t110_del_nme()   #MOD-750143
         #END IF   #MOD-750143
      END IF
      #-----END MOD-740057-----

   END FOREACH

   #-----MOD-740057---------
   IF u_sw=-1 THEN   #MOD-750143 取消mark
      CALL t110_del_nme()   #MOD-750143 取消mark
   END IF   #MOD-750143 取消mark
   #-----END MOD-740057-----

   SELECT COUNT(*) INTO g_cnt FROM aph_file
    WHERE aph01 = m_apa.apa01 AND aph09 = 'Y'

   IF g_cnt > 0 THEN
      CALL cl_err(m_apa.apa01,'aap-228',0)
      LET g_success = 'N'
   END IF

END FUNCTION

FUNCTION t110_ins_nme()
   DEFINE l_nme          RECORD LIKE nme_file.*

   IF g_apz.apz04 = 'N' THEN
      RETURN
   END IF

   #IF m_aph.aph03 <> '2' THEN   #MOD-740057
   IF m_aph.aph03 NOT MATCHES  '[2B]'  THEN   #MOD-740057
      RETURN
   END IF

   display "ins_nme now...."
   LET l_nme.nme00=0
   LET l_nme.nme01=m_aph.aph08
   LET l_nme.nme02=m_apa.apa02   #MOD-560240   #MOD-880017 mark回復   #MOD-880222 mark #MOD-980029 mark 恢復
  #LET l_nme.nme02=m_apa.apa12   #MOD-560240   #MOD-880017 mark回復   #MOD-880222 #MOD-980029 mark
   #-----MOD-790038---------
   #LET l_nme.nme02=m_aph.aph07   #MOD-560240
  #str MOD-880017 mark
  #IF NOT cl_null(m_aph.aph07) THEN
  #   LET l_nme.nme02 = m_aph.aph07
  #ELSE
  #   LET l_nme.nme02 = m_apa.apa02
  #END IF
  #end MOD-880017 mark
   #-----END MOD-790038-----
   LET l_nme.nme03=m_aph.aph16
   LET l_nme.nme04=m_aph.aph05f
   LET l_nme.nme07=m_aph.aph14
   LET l_nme.nme08=m_aph.aph05
   LET l_nme.nme10=m_apa.apa44
   LET l_nme.nme12=m_apa.apa01
   LET l_nme.nme13=m_apa.apa07
   #bug No:9615 040527 DSC.Anny add---begin---
   SELECT nmc05 INTO l_nme.nme14
    FROM nmc_file
      WHERE nmc01=l_nme.nme03
   LET l_nme.nme15=m_apa.apa22
   #040527 DSC.Anny add---end-----
   LET l_nme.nme16=m_apa.apa02
   LET l_nme.nme17=""   #MOD-740057
   #LET l_nme.nme17=m_apa.apa01   #MOD-740057
   LET l_nme.nmeacti='Y'
   LET l_nme.nmeuser=g_user
   LET l_nme.nmegrup=g_grup
   LET l_nme.nmedate=TODAY
#No.FUN-730032--begin
   LET l_nme.nme21=m_aph.aph02
   LET l_nme.nme22='03'
   LET l_nme.nme23=m_aph.aph03
   LET l_nme.nme24='9'
   LET l_nme.nme25=m_apa.apa06
#No.FUN-730032--end
   LET l_nme.nme26 = 'N'   #FUN-870037 

   LET g_sql="INSERT INTO ",g_dbs_nm,"nme_file",
             "       (nme00,nme01,nme02,nme03,nme04,nme07,nme08,nme10,nme11,nme12,",
             "        nme13,nme14,nme15,nme16,nme17,nmeacti,nmeuser,nmegrup,nmedate,nme21,nme22,nme23,nme24,nme25,nme26)", #No.FUN-730032  #FUN-870037 add nme26
             " VALUES('",l_nme.nme00,"',",
                     "'",l_nme.nme01,"',",
                     "'",l_nme.nme02,"',",
                     "'",l_nme.nme03,"',",
                     "'",l_nme.nme04,"',",
                     "'",l_nme.nme07,"',",
                     "'",l_nme.nme08,"',",
                     "'",l_nme.nme10,"',",
                     "'",l_nme.nme11,"',",
                     "'",l_nme.nme12,"',",
                     "'",l_nme.nme13,"',",
                     "'",l_nme.nme14,"',",   #No:9615 040527 DSC.Anny add
                     "'",l_nme.nme15,"',",
                     "'",l_nme.nme16,"',",
                     "'",l_nme.nme17,"',",
                     "'",l_nme.nmeacti,"',",
                     "'",l_nme.nmeuser,"',",
                     "'",l_nme.nmegrup,"',",
#No.FUN-730032--begin
                     "'",l_nme.nmedate,"',",
                     "'",l_nme.nme21,"',",
                     "'",l_nme.nme22,"',",
                     "'",l_nme.nme23,"',",
                     "'",l_nme.nme24,"',",
                     "'",l_nme.nme25,"',",
                     "'",l_nme.nme26,"')"   #FUN-870037
#No.FUN-730032--end
	CALL cl_replace_sqldb(g_sql) RETURNING g_sql		#FUN-920032
   PREPARE t110_y_nme_p FROM g_sql
   IF STATUS THEN
      CALL cl_err('ins nme:',STATUS,1)   
      LET g_success='N'
      RETURN
   END IF

   EXECUTE t110_y_nme_p
   display "status",status
   IF STATUS THEN
      CALL cl_err('ins nme:',STATUS,1)
      LET g_success='N'
   END IF

   display "sqlca.sqlerrd[3]=",sqlca.sqlerrd[3]
   IF SQLCA.SQLERRD[3]=0 THEN
      CALL cl_err('ins nme: ',SQLCA.SQLCODE,1)
      LET g_success='N'
      RETURN
   END IF

END FUNCTION

FUNCTION t110_del_nme()
   DEFINE l_n     LIKE type_file.num5    #No.FUN-690028 SMALLINT
   DEFINE l_nme24      LIKE nme_file.nme24    #No.FUN-730032
   DEFINE l_aza73      LIKE aza_file.aza73    #No.MOD-740346

   IF g_apz.apz04 = 'N' THEN
      RETURN
   END IF
 
   SELECT COUNT(*) INTO l_n FROM aph_file
    #WHERE aph01=m_apa.apa01 AND aph03 = '2'   #MOD-740057
    WHERE aph01=m_apa.apa01 AND aph03 IN ('2','B')   #MOD-740057

   IF l_n = 0 THEN
      RETURN
   END IF

   #-----MOD-750143---------
   LET l_n = 0 
   LET g_sql="SELECT COUNT(*) FROM ",g_dbs_nm,"nme_file",
             " WHERE nme12='",m_apa.apa01,"'", 
             "   AND nme22 = '03' "                     #MOD-B50242 
   CALL cl_replace_sqldb(g_sql) RETURNING g_sql		#FUN-920032
   PREPARE t110_x_nme_p FROM g_sql
   EXECUTE t110_x_nme_p INTO l_n
   IF l_n = 0 THEN
      RETURN
   END IF
   #-----END MOD-750143-----

   #No.MOD-740346 --start--
   LET g_sql="SELECT aza73 FROM ",g_dbs_nm CLIPPED,"aza_file"
	CALL cl_replace_sqldb(g_sql) RETURNING g_sql		#FUN-920032
   PREPARE t741_aza_p1 FROM g_sql
   DECLARE t741_aza_c1 CURSOR FOR t741_aza_p1
   OPEN t741_aza_c1
   FETCH t741_aza_c1 INTO l_aza73
   IF l_aza73 = 'Y' THEN
   #No.MOD-740346 --end--
#No.FUN-730032--begin
      LET g_sql="SELECT nme24 FROM ",g_dbs_nm CLIPPED,"nme_file",
                " WHERE nme12='",m_apa.apa01,"'",   #MOD-B50242 mod nme17 -> nme12
                "   AND nme22 = '03' "              #MOD-B50242 
      CALL cl_replace_sqldb(g_sql) RETURNING g_sql		#FUN-920032
      PREPARE t110_z_nme_p1 FROM g_sql
      FOREACH t110_z_nme_p1 INTO l_nme24
         IF l_nme24 <> '9' THEN
            CALL cl_err('','anm-043',1)
            LET g_success='N'
            RETURN
         END IF
      END FOREACH
#No.FUN-730032--end
   END IF #No.MOD-740346

   LET g_sql="DELETE FROM ",g_dbs_nm,"nme_file",
             #" WHERE nme17='",m_apa.apa01,"'"   #MOD-740057
             " WHERE nme12='",m_apa.apa01,"'",   #MOD-740057
             "    AND nme22 = '03' "             #MOD-B50242 
	CALL cl_replace_sqldb(g_sql) RETURNING g_sql		#FUN-920032
   PREPARE t110_z_nme_p FROM g_sql

   EXECUTE t110_z_nme_p

   IF STATUS THEN
      CALL cl_err('del nme:',STATUS,1)
      LET g_success='N'
      RETURN
   END IF

   IF SQLCA.SQLERRD[3]=0 THEN
      CALL cl_err('no nme deleted:','aap-161',1)
      LET g_success='N'
      RETURN
   END IF
END FUNCTION

FUNCTION t110_up_gl()

   IF g_apa_t.apa51 != g_apa.apa51 OR g_apa_t.apa52 != g_apa.apa52 OR
      g_apa_t.apa53 != g_apa.apa53 OR g_apa_t.apa54 != g_apa.apa54 OR
      g_apa_t.apa31 != g_apa.apa31 OR g_apa_t.apa32 != g_apa.apa32 OR
      g_apa_t.apa33 != g_apa.apa33 OR g_apa_t.apa34 != g_apa.apa34 THEN
       #MOD-4A0143
     #FUN-D70132---add---S
      SELECT apa79 INTO g_apa.apa79 FROM apa_file WHERE apa01 =g_apa.apa01
      IF g_apa.apa79 = 'N' THEN
         RETURN 
      ELSE
     #FUN-D70132---add---E
         IF cl_confirm('aap-057') THEN
            CALL t110_gen_gl()
         END IF
      END IF   #FUN-D70132 add
   END IF

   IF g_apa_t.apa02 != g_apa.apa02 THEN
      UPDATE npp_file SET npp02=g_apa.apa02
       WHERE npp01=g_apa.apa01
         AND npp011=1
         AND nppsys = 'AP'
      IF STATUS THEN
#        CALL cl_err('upd npp02:',STATUS,1)   #No.FUN-660122
         CALL cl_err3("upd","npp_file",g_apa.apa01,"",STATUS,"","upd npp02:",1)  #No.FUN-660122
      END IF
   END IF

END FUNCTION

#-----MOD-740030---------
FUNCTION t110_v0()
   DEFINE g_t1 LIKE oay_file.oayslip

   IF g_apa.apa42 = 'Y' THEN RETURN END IF
   LET g_t1=g_apa.apa01[1,g_doc_len]
   SELECT apydmy3 INTO g_apy.apydmy3 FROM apy_file WHERE apyslip=g_t1
#  IF g_apy.apydmy3 <> 'Y' THEN RETURN END IF          #TQC-970296 Mark
#TQC-970296--Add--Begin--#
   IF g_apy.apydmy3 <> 'Y' THEN
      CALL cl_err('','aap-286',0)
      RETURN
   END IF
#TQC-970296--Add--End--#   

  #FUN-D70132---add---S
   IF g_apa.apa79 = 'N' THEN
      CALL cl_err('','aws-947',1)
      CALL t110_sheet('0')
      RETURN
   END IF
  #FUN-D70132---add---E

   IF cl_null(g_apa.apa99) THEN
      CALL t110_v()
   ELSE
      #多角貿易單據一次只產生一張分錄
      #且已確認但未拋轉傳票，可重新產生分錄
      CALL t110_v2()
   END IF
END FUNCTION

FUNCTION t110_v2()
   IF NOT cl_null(g_apa.apa44) THEN CALL cl_err('','aap-925',0) RETURN END IF
  #FUN-D70132 add str---
   SELECT apa79 INTO g_apa.apa79 FROM apa_file WHERE apa01 = g_apa.apa01
   IF g_apa.apa79 = 'N' THEN
      RETURN
   ELSE
  #FUN-D70132 add end---
      IF cl_confirm('axr-309') THEN
         CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'0')
         IF g_aza.aza63 ='Y' THEN
            CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'1')  
         END IF
      END IF
   END IF  #FUN-D70132 add
END FUNCTION
#-----END MOD-740030-----
FUNCTION t110_v()
   #DEFINE l_wc    LIKE type_file.chr1000 #No.FUN-690028 VARCHAR(100)   #MOD-720062
   DEFINE l_wc    STRING    #MOD-720062
   DEFINE l_apa00 LIKE apa_file.apa00
   DEFINE l_apa01 LIKE apa_file.apa01
   DEFINE l_apa58 LIKE apa_file.apa58    #85-09-26
   DEFINE only_one     LIKE type_file.chr1      # No:FUN-690028 VARCHAR(1)
   DEFINE l_t1         LIKE apy_file.apyslip    # No:FUN-690028 VARCHAR(5)                               #NO.FUN-550030
   DEFINE l_apa02       LIKE apa_file.apa02
   DEFINE l_apydmy3    LIKE type_file.chr1      # No:FUN-690028 VARCHAR(1)
   DEFINE g_t1          LIKE oay_file.oayslip                                #No.FUN-55030  #No.FUN-690028 VARCHAR(5)
   DEFINE l_cnt         LIKE type_file.num5     #FUN-530041  #No.FUN-690028 SMALLINT
   DEFINE l_cnt2        LIKE type_file.num5     #MOD-810168
 
   IF g_apa.apa41 = 'Y' THEN RETURN END IF   #MOD-720104
   IF g_apa.apa42 = 'Y' THEN RETURN END IF   #MOD-720104
 
   #No.FUN-690080 --Begin
   IF g_aptype = '13' OR g_aptype = '17' THEN
      IF g_apa.apa37f > 0 THEN
         IF cl_null(g_apa.apa101) OR cl_null(g_apa.apa102) THEN
            CALL cl_err(g_apa.apa01,'aap-095',1)
            CALL t110_upd_apa101()
            IF g_success = 'N' THEN RETURN END IF
         END IF
      END IF
   END IF
   #No.FUN-690080 --End

   OPEN WINDOW t110_w9 WITH FORM "aap/42f/aapt110_9"
      ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
   CALL cl_ui_locale("aapt110_9")

   LET only_one = '1'
   CALL cl_set_head_visible("","YES")     #No.FUN-6B0033

   INPUT BY NAME only_one WITHOUT DEFAULTS

      AFTER FIELD only_one
         IF NOT cl_null(only_one) THEN
            IF only_one NOT MATCHES "[12]" THEN
               NEXT FIELD only_one
            END IF
         END IF

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
       ON ACTION about         #MOD-4C0121
          CALL cl_about()      #MOD-4C0121
 
       ON ACTION help          #MOD-4C0121
          CALL cl_show_help()  #MOD-4C0121
 
       ON ACTION controlg      #MOD-4C0121
          CALL cl_cmdask()     #MOD-4C0121
 
   END INPUT

   IF INT_FLAG THEN
      LET INT_FLAG = 0
      CLOSE WINDOW t110_w9
      RETURN
   END IF

   IF only_one = '1' THEN
      LET l_wc = " apa01 = '",g_apa.apa01,"' "
   ELSE
      CALL cl_set_head_visible("","YES")     #No.FUN-6B0033

      CONSTRUCT BY NAME l_wc ON apa01,apa02,apa21,apa22,apa06

              #No:FUN-580031 --start--     HCN
              BEFORE CONSTRUCT
                 CALL cl_qbe_init()
              #No:FUN-580031 --end--       HCN
         ON ACTION CONTROLP
            CASE
               WHEN INFIELD(apa01) #查詢單据
#NO.FUN-550030--begin
                  LET g_t1=s_get_doc_no(g_apa.apa01)
                 #CALL q_apy(TRUE,FALSE,g_t1,g_aptype,g_sys) RETURNING g_t1  #TQC-670008
                  CALL q_apy(TRUE,FALSE,g_t1,g_aptype,'AAP') RETURNING g_t1  #TQC-670008
                  LET g_apa.apa01=g_t1
#NO.FUN-550030--end
                  DISPLAY BY NAME g_apa.apa01
                  NEXT FIELD apa01
               WHEN INFIELD(apa06) #PAY TO VENDOR
#                 CALL q_pmc1(0,0,g_apa.apa06) RETURNING g_apa.apa06
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
          #        LET g_qryparam.form ="q_pmc1"  #MOD-960121
                  LET g_qryparam.form ="q_pmc"  #MOD-960121
                  LET g_qryparam.default1 = g_apa.apa06
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apa06
                  CALL t110_apa06('d')
               WHEN INFIELD(apa21) # Employee CODE
#                 CALL q_gen(0,0,g_apa.apa21) RETURNING g_apa.apa21
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
                  LET g_qryparam.form ="q_gen"
                  LET g_qryparam.default1 = g_apa.apa21
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apa21
               WHEN INFIELD(apa22) # Dept CODE
#                 CALL q_gem(0,0,g_apa.apa22) RETURNING g_apa.apa22
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
                  LET g_qryparam.form ="q_gem"
                  LET g_qryparam.default1 = g_apa.apa22
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apa22
               OTHERWISE EXIT CASE
            END CASE

         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE CONSTRUCT
 
          ON ACTION about         #MOD-4C0121
             CALL cl_about()      #MOD-4C0121
 
          ON ACTION help          #MOD-4C0121
             CALL cl_show_help()  #MOD-4C0121
 
          ON ACTION controlg      #MOD-4C0121
             CALL cl_cmdask()     #MOD-4C0121
 
		#No:FUN-580031 --start--     HCN
                 ON ACTION qbe_select
         	   CALL cl_qbe_select()
                 ON ACTION qbe_save
		   CALL cl_qbe_save()
		#No:FUN-580031 --end--       HCN
      END CONSTRUCT

      IF INT_FLAG THEN
         LET INT_FLAG=0
         CLOSE WINDOW t110_w9
         RETURN
      END IF
   END IF

   CLOSE WINDOW t110_w9

   MESSAGE "WORKING !"
   LET g_success = 'Y'
   BEGIN WORK

   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa_rowid
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl v:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF

   FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
      CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF

   LET g_sql = "SELECT apa00,apa01,apa58,apa02 FROM apa_file ",
               " WHERE ",l_wc CLIPPED,
               "   AND apa00 = '",g_aptype,"'",
               "   AND (apa44 IS NULL OR apa44 = ' ')",
               "   AND apa41 !='Y' ",
               "   AND apa42 !='Y' "   #MOD-720104
               #-----MOD-810168---------
               #"   AND apa01 IN ",   #FUN-530041
               #"   (SELECT npq01 FROM npq_file",   #FUN-530041
               #"   WHERE npqsys = 'AP' AND npq00 = 1 AND npq011 = 1)"   #FUN-530041
               #-----END MOD-810168-----
   PREPARE t110_v_p FROM g_sql

   DECLARE t110_v_c CURSOR WITH HOLD FOR t110_v_p
   LET l_cnt = 0   #FUN-530041
   FOREACH t110_v_c INTO l_apa00,l_apa01,l_apa58,l_apa02
      IF STATUS THEN
         EXIT FOREACH
      END IF

      #-----MOD-810168---------
      LET l_cnt2 = 0 
      SELECT COUNT(*) INTO l_cnt2 FROM npq_file
        WHERE npqsys = 'AP' AND npq00 = 1 AND npq011 = 1 AND npq01 = l_apa01
      IF l_cnt2 = 0 THEN 
         CONTINUE FOREACH
      END IF
      #-----END MOD-810168-----  

      IF l_apa02 <= g_apz.apz57 THEN   #立帳日期小於關帳日期
         CALL cl_err(l_apa01,'aap-176',1)
         CONTINUE FOREACH
      END IF

      IF l_apa58='1' THEN             #請款折讓不產生
         IF only_one='1' THEN
            #CALL cl_err('','aap-227',0)    #TQC-C90065  mark
            CALL cl_err('','aap-260',0)     #TQC-C90065  add
            EXIT FOREACH
         END IF
         CONTINUE FOREACH
      END IF
#No.FUN-550030--begin
#     LET l_t1 = l_apa01[1,3]
      LET l_t1 = s_get_doc_no(l_apa01)
#No.FUN-550030--end
      LET l_apydmy3 = ''

      SELECT apydmy3 INTO l_apydmy3 FROM apy_file WHERE apyslip = l_t1
      IF SQLCA.sqlcode THEN
#        CALL cl_err('sel apy:',STATUS,0)   #No.FUN-660122
         CALL cl_err3("sel","apy_file",l_t1,"",STATUS,"","sel apy:",1)  #No.FUN-660122
      END IF

      IF l_apydmy3 = 'Y' THEN   #是否拋轉傳票
#FUN-530041
         IF l_cnt = 0 THEN
            IF NOT s_ask_entry(l_apa01) THEN EXIT FOREACH END IF
            DELETE FROM npq_file WHERE npqsys = 'AP' AND npq00 = 1
                                   AND npq01  = l_apa01 AND npq011 = 1
            CALL t110_g_gl(l_apa00,l_apa01,'0')   #No.FUN-680029
#No.FUN-680029--begin
            IF g_aza.aza63 ='Y' THEN
               CALL t110_g_gl(l_apa00,l_apa01,'1')  
            END IF
#No.FUN-680029--end
            LET l_cnt = l_cnt + 1
         ELSE
            DELETE FROM npq_file WHERE npqsys = 'AP' AND npq00 = 1
                                   AND npq01  = l_apa01 AND npq011 = 1
            CALL t110_g_gl(l_apa00,l_apa01,'0')   #No.FUN-680029
#No.FUN-680029--begin
            IF g_aza.aza63 ='Y' THEN
               CALL t110_g_gl(l_apa00,l_apa01,'1')  
            END IF
#No.FUN-680029--end
         END IF
#END FUN-530041
      ELSE
         CALL cl_err(l_apa00,'aap-286',0)
      END IF
   END FOREACH
#FUN-530041
   LET g_sql = "SELECT apa00,apa01,apa58,apa02 FROM apa_file ",
               " WHERE ",l_wc CLIPPED,
               "   AND apa00 = '",g_aptype,"'",
               "   AND (apa44 IS NULL OR apa44 = ' ')",
               "   AND apa41 !='Y' ",
               "   AND apa42 !='Y' "   #MOD-720104
               #-----MOD-810168---------
               #"   AND apa01 NOT IN ",   #FUN-530041
               #"   (SELECT npq01 FROM npq_file",   #FUN-530041
               #"   WHERE npqsys = 'AP' AND npq00 = 1 AND npq011 = 1)"   #FUN-530041
               #-----END MOD-810168-----
   PREPARE t110_v_p2 FROM g_sql

   DECLARE t110_v_c2 CURSOR WITH HOLD FOR t110_v_p2
   FOREACH t110_v_c2 INTO l_apa00,l_apa01,l_apa58,l_apa02
      IF STATUS THEN
          EXIT FOREACH
      END IF

      #-----MOD-810168---------
      LET l_cnt2 = 0 
      SELECT COUNT(*) INTO l_cnt2 FROM npq_file
        WHERE npqsys = 'AP' AND npq00 = 1 AND npq011 = 1 AND npq01 = l_apa01
      IF l_cnt2 <> 0 THEN
         CONTINUE FOREACH
      END IF
      #-----END MOD-810168----- 

      IF l_apa02 <= g_apz.apz57 THEN   #立帳日期小於關帳日期
         CALL cl_err(l_apa01,'aap-176',1)
         CONTINUE FOREACH
       END IF

      IF l_apa58='1' THEN             #請款折讓不產生
         IF only_one='1' THEN
            #CALL cl_err('','aap-227',0)    #TQC-C90065  mark
            CALL cl_err('','aap-260',0)     #TQC-C90065  add
            EXIT FOREACH
         END IF
         CONTINUE FOREACH
      END IF

      #LET l_t1 = l_apa01[1,3]   #FUN-530041
      LET l_t1 = s_get_doc_no(l_apa01)   #FUN-530041
      LET l_apydmy3 = ''

      SELECT apydmy3 INTO l_apydmy3 FROM apy_file WHERE apyslip = l_t1
      IF SQLCA.sqlcode THEN
#        CALL cl_err('sel apy:',STATUS,0)   #No.FUN-660122
         CALL cl_err3("sel","apy_file",l_t1,"",STATUS,"","sel apy:",1)  #No.FUN-660122
      END IF

      IF l_apydmy3 = 'Y' THEN   #是否拋轉傳票
         CALL t110_g_gl(l_apa00,l_apa01,'0')   #No.FUN-680029
        #TQC-9A0015---add---start---
         IF g_aza.aza63 ='Y' THEN
            CALL t110_g_gl(l_apa00,l_apa01,'1')  
         END IF
        #TQC-9A0015---add---end---
      ELSE
         CALL cl_err(l_apa00,'aap-286',0)
      END IF
   END FOREACH
#END FUN-530041

   MESSAGE ""
   IF g_success = 'Y' THEN
      COMMIT WORK
   ELSE
      ROLLBACK WORK
   END IF

END FUNCTION
 
FUNCTION t110_x()
#DEFINE  l_t1        VARCHAR(3),
 DEFINE  l_t1        LIKE apy_file.apyslip,    # No:FUN-690028 VARCHAR(5),                #No.FUN-550030
         l_apydmy3   LIKE apy_file.apydmy3   # No:FUN-690028 VARCHAR(1)
 
   IF cl_null(g_apa.apa44) THEN
      CALL cl_err(g_apa.apa01,'aap-256',0)
      RETURN
   END IF
  IF g_apa.apa63 MATCHES '[Ss1]' THEN      #FUN-540045 #FUN-550042
    CALL cl_err('','mfg3557',0)
    RETURN
  END IF

#No.FUN-550030--begin
#  LET l_t1 = g_apa.apa01[1,3]
   LET l_t1 = s_get_doc_no(g_apa.apa01)
#No.FUN-550030--end

   SELECT apydmy3 INTO l_apydmy3 FROM apy_file WHERE apyslip = l_t1
   IF SQLCA.sqlcode THEN
#     CALL cl_err('sel apy:',STATUS,0)   #No.FUN-660122
      CALL cl_err3("sel","apy_file","","",STATUS,"","sel apy:",1)  #No.FUN-660122
      RETURN
   END IF

   MESSAGE "WORKING !"

   IF l_apydmy3 = 'Y' THEN
      CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'0')    #No.FUN-680029
   END IF

   MESSAGE " "

END FUNCTION

FUNCTION t110_j()
   #DEFINE l_wc             LIKE type_file.chr1000 #No.FUN-690028 VARCHAR(100)   #MOD-720062
   DEFINE l_wc             STRING    #MOD-720062
   DEFINE i,j              LIKE type_file.num5    #No.FUN-690028 SMALLINT
   DEFINE l_apa60f         LIKE apa_file.apa60f
   DEFINE l_apa61f         LIKE apa_file.apa61f
   DEFINE l_apa61          LIKE apa_file.apa61
   DEFINE l_apa60          LIKE apa_file.apa60
   DEFINE apb14f_t         LIKE apb_file.apb14f
   DEFINE apb14_t,apb14_o  LIKE apb_file.apb14f
   DEFINE l_amt            LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_amtf           LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_apb            DYNAMIC ARRAY OF RECORD   #程式變數(Program Variables)
                              apb02    LIKE apb_file.apb02,
                              apb12    LIKE apb_file.apb12,
                              apb15    LIKE apb_file.apb15,
                              apb08    LIKE apb_file.apb08,
                              apb10    LIKE apb_file.apb10,
                              apb13f   LIKE apb_file.apb13f,
                              apb13    LIKE apb_file.apb13,
                              apb14f   LIKE apb_file.apb14f,
                              apb14    LIKE apb_file.apb14
                           END RECORD,
   l_allow_insert          LIKE type_file.num5,                #可新增否  #No.FUN-690028 SMALLINT
   l_allow_delete          LIKE type_file.num5                 #可刪除否  #No.FUN-690028 SMALLINT
#No.FUN-680027--begin
   DEFINE l_apc02  LIKE apc_file.apc02  
   DEFINE l_apc08  LIKE apc_file.apc08  
   DEFINE l_apc09  LIKE apc_file.apc09  
#No.FUN-680027--end

   IF g_apa.apa56 IS NULL OR g_apa.apa56 NOT MATCHES '[346]' THEN
      CALL cl_err('','aap-157',0)
      RETURN
   END IF

   IF g_apa.apa42 = 'Y' THEN
      CALL cl_err('','aap-165',0)
      RETURN
   END IF

   IF g_apa.apa75 = 'Y' THEN
      CALL cl_err('','aap-333',0)
      RETURN
   END IF

   OPEN WINDOW t110_wa WITH FORM "aap/42f/aapt110_a"
      ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
   CALL cl_ui_locale("aapt110_a")

   DISPLAY BY NAME g_apa.apa33f,g_apa.apa33

   SELECT SUM(apb14f),SUM(apb14) 
     INTO apb14f_t,apb14_t
     FROM apb_file
    WHERE apb01 = g_apa.apa01

   DISPLAY BY NAME apb14f_t,apb14_t

   LET l_apa60f=g_apa.apa60f
   LET l_apa61f=g_apa.apa61f
   LET l_apa60 =g_apa.apa60
   LET l_apa61 =g_apa.apa61
 
   IF cl_null(g_apa.apa60) OR g_apa.apa60=0 THEN
      LET g_apa.apa60 =apb14_t
   END IF

   IF cl_null(g_apa.apa60f) OR g_apa.apa60f=0 THEN
      LET g_apa.apa60f=apb14f_t
   END IF

   IF cl_null(g_apa.apa61f) OR g_apa.apa61f=0 THEN
      LET g_apa.apa61f=g_apa.apa60f*g_apa.apa16/100
     #LET g_apa.apa61f=cl_digcut(g_apa.apa61f,g_azi.azi04)   #MOD-6B0066
      LET g_apa.apa61f=cl_digcut(g_apa.apa61f,t_azi04)   #MOD-6B0066
   END IF

   IF cl_null(g_apa.apa61) OR g_apa.apa61=0 THEN
      LET g_apa.apa61 =g_apa.apa60 *g_apa.apa16/100
     #LET g_apa.apa61 =cl_digcut(g_apa.apa61,t_azi.azi04)   #MOD-6B0066
      LET g_apa.apa61 =cl_digcut(g_apa.apa61,g_azi04)   #MOD-6B0066
   END IF

   DISPLAY BY NAME g_apa.apa60f,g_apa.apa60
   DISPLAY BY NAME g_apa.apa61f,g_apa.apa61

   DECLARE t110_j_c CURSOR WITH HOLD FOR
      SELECT apb02,apb12,apb15,apb08,
             apb10,apb13f,apb13,apb14f,apb14
        FROM apb_file
       WHERE apb01 = g_apa.apa01
       ORDER BY apb02
   LET i = 1
   FOREACH t110_j_c INTO l_apb[i].*
      LET i = i + 1
   END FOREACH
   CALL l_apb.deleteElement(i)
   LET g_rec_b = i - 1

   LET l_allow_insert = cl_detail_input_auth("insert")
   LET l_allow_delete = cl_detail_input_auth("delete")

   INPUT ARRAY l_apb WITHOUT DEFAULTS FROM s_apb.*
         ATTRIBUTE(COUNT=g_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                   INSERT ROW=FALSE,DELETE ROW=FALSE,APPEND ROW=FALSE)

      BEFORE INPUT
         IF g_rec_b > 0 THEN
            CALL fgl_set_arr_curr(i)
         END IF

      BEFORE ROW
         LET i = ARR_CURR()
         CALL cl_show_fld_cont()     #FUN-550037(smin)

      AFTER FIELD apb15
         IF l_apb[i].apb14 = 0 THEN   #MOD-5B0255
            LET l_amt = l_apb[i].apb15 * l_apb[i].apb13
            LET l_apb[i].apb14 = l_amt
           #LET l_apb[i].apb14 = cl_digcut(l_apb[i].apb14,t_azi.azi04)   #MOD-6B0066
            LET l_apb[i].apb14 = cl_digcut(l_apb[i].apb14,g_azi04)   #MOD-6B0066
         END IF   #MOD-5B0255
#MOD-5B0255
         IF l_apb[i].apb14f = 0 THEN
            LET l_apb[i].apb14f = l_apb[i].apb15 * l_apb[i].apb13f
         END IF
#END MOD-5B0255
         LET l_apb[i].apb14 = cl_digcut(l_apb[i].apb14,g_azi04)  #MOD-9C0085 add

      AFTER FIELD apb13f
#MOD-5B0255
#        LET l_apb[i].apb14f = l_apb[i].apb15 * l_apb[i].apb13f
#        LET l_apb[i].apb13  = l_apb[i].apb13f * g_apa.apa14
#        LET l_amt = l_apb[i].apb14f * g_apa.apa14
#        LET l_apb[i].apb14  = l_amt
         IF l_apb[i].apb14f = 0 THEN
            LET l_apb[i].apb14f = l_apb[i].apb15 * l_apb[i].apb13f
         END IF
         LET l_apb[i].apb14f= cl_digcut(l_apb[i].apb14f,t_azi04)  #MOD-9C0085 add
         IF l_apb[i].apb13 = 0 THEN
            LET l_apb[i].apb13  = l_apb[i].apb13f * g_apa.apa14
         END IF
         IF l_apb[i].apb14 = 0 THEN
            LET l_amt = l_apb[i].apb14f * g_apa.apa14
            LET l_apb[i].apb14  = l_amt
         END IF
#END MOD-5B0255
         LET l_apb[i].apb14 = cl_digcut(l_apb[i].apb14,g_azi04)  #MOD-9C0085 add

      AFTER FIELD apb13
         IF g_apa.apa14 = 1 THEN
            LET l_apb[i].apb13f = l_apb[i].apb13
         END IF
#MOD-5B0255
      AFTER FIELD apb14f
         IF l_apb[i].apb14 = 0 THEN
            LET l_amt = l_apb[i].apb14f * g_apa.apa14
            LET l_apb[i].apb14  = l_amt
         END IF
#END MOD-5B0255
         LET l_apb[i].apb14 = cl_digcut(l_apb[i].apb14,g_azi04)  #MOD-9C0085 add

      AFTER FIELD apb14
         IF g_apa.apa14 = 1 THEN
            LET l_apb[i].apb14f = l_apb[i].apb14
         END IF
         LET l_apb[i].apb14f= cl_digcut(l_apb[i].apb14f,t_azi04)  #MOD-9C0085 add

      AFTER ROW
         IF INT_FLAG THEN
            EXIT INPUT
         END IF
         IF l_apb[i].apb02 IS NOT NULL THEN
            UPDATE apb_file SET apb12 = l_apb[i].apb12,
                                apb15 = l_apb[i].apb15,
                                apb13f= l_apb[i].apb13f,
                                apb13 = l_apb[i].apb13,
                                apb14f= l_apb[i].apb14f,
                                apb14 = l_apb[i].apb14
                          WHERE apb01 = g_apa.apa01
                            AND apb02 = l_apb[i].apb02
         END IF
         IF l_apb[i].apb02 IS NULL AND l_apb[i].apb14 != 0 THEN
            SELECT MAX(apb02)+1 INTO l_apb[i].apb02 FROM apb_file
             WHERE apb01 = g_apa.apa01
            IF l_apb[i].apb02 IS NULL THEN
               LET l_apb[i].apb02 = 1
            END IF
            INSERT INTO apb_file (apb01,apb02,apb12,apb08,apb09,apb10,
                                  apb13,apb14,apb15,apb930,apb34)  #FUN-670064   #No.TQC-7B0083
            VALUES (g_apa.apa01,l_apb[i].apb02,l_apb[i].apb12,
                    0,0,0,l_apb[i].apb13,l_apb[i].apb14,
                    l_apb[i].apb15,g_apa.apa930,'N')  #FUN-670064  #No.TQC-7B0083
         END IF

         SELECT SUM(apb14f),SUM(apb14)
           INTO apb14f_t,apb14_t
           FROM apb_file
          WHERE apb01 = g_apa.apa01
         DISPLAY BY NAME apb14f_t,apb14_t

      AFTER INPUT
         IF INT_FLAG THEN
            EXIT INPUT
         END IF

         IF apb14_t != g_apa.apa33 THEN
            CALL cl_err('','aap-159',0)
            NEXT FIELD apb13
         END IF

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
     
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033

   END INPUT

   IF NOT INT_FLAG THEN
      SELECT SUM(apb14f),SUM(apb14)
        INTO apb14f_t,apb14_t
        FROM apb_file
       WHERE apb01=g_apa.apa01
      IF apb14f_t IS NULL THEN LET apb14f_t = 0 END IF
      IF apb14_t IS NULL  THEN LET apb14_t  = 0 END IF

     #LET apb14f_t = cl_digcut(apb14f_t,g_azi.azi04)   #MOD-6B0066
     #LET apb14_t = cl_digcut(apb14_t,t_azi.azi04)   #MOD-6B0066
      LET apb14f_t = cl_digcut(apb14f_t,t_azi04)   #MOD-6B0066
      LET apb14_t = cl_digcut(apb14_t,g_azi04)   #MOD-6B0066
      LET g_apa.apa60f=apb14f_t
      LET g_apa.apa60 =apb14_t
      LET apb14f_t=g_apa.apa60f*g_apa.apa16/100
     #LET apb14f_t = cl_digcut(apb14f_t,g_azi.azi04)   #MOD-6B0066
      LET apb14f_t = cl_digcut(apb14f_t,t_azi04)   #MOD-6B0066
      LET apb14_t =g_apa.apa60 *g_apa.apa16/100
     #LET apb14_t = cl_digcut(apb14_t,t_azi.azi04)   #MOD-6B0066
      LET apb14_t = cl_digcut(apb14_t,g_azi04)   #MOD-6B0066
      LET g_apa.apa61f=apb14f_t
      LET g_apa.apa61 =apb14_t

      DISPLAY BY NAME g_apa.apa60f,g_apa.apa61f,g_apa.apa60,g_apa.apa61
      CALL cl_set_head_visible("","YES")     #No.FUN-6B0033

      INPUT BY NAME g_apa.apa61f,g_apa.apa61 WITHOUT DEFAULTS

         AFTER INPUT
            IF INT_FLAG THEN
               EXIT INPUT
            END IF

         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE INPUT
 
         ON ACTION about         #MOD-4C0121
            CALL cl_about()      #MOD-4C0121
 
         ON ACTION help          #MOD-4C0121
            CALL cl_show_help()  #MOD-4C0121
 
         ON ACTION controlg      #MOD-4C0121
            CALL cl_cmdask()     #MOD-4C0121
 
      END INPUT
   END IF

   IF INT_FLAG THEN
      LET INT_FLAG = 0
      LET g_apa.apa60f=l_apa60f
      LET g_apa.apa61f=l_apa61f
      LET g_apa.apa60 =l_apa60
      LET g_apa.apa61 =l_apa61
   END IF

   CLOSE WINDOW t110_wa

   UPDATE apa_file SET apa60f= g_apa.apa60f,
                       apa60 = g_apa.apa60,
                       apa61f= g_apa.apa61f,
                       apa61 = g_apa.apa61
                 WHERE apa01 = g_apa.apa01

   SELECT apa60f,apa61f,apa60,apa61
     INTO g_apa.apa60f,g_apa.apa61f,g_apa.apa60,g_apa.apa61
     FROM apa_file
    WHERE apa01=g_apa.apa01

   DISPLAY BY NAME g_apa.apa60f,g_apa.apa61f,g_apa.apa60,g_apa.apa61
#-----MOD-830089---------
##No.FUN-680027--begin
#  DECLARE t110_apc_j_cs CURSOR FOR
#    SELECT apc02,apc08,apc09 FROM apc_file WHERE apc01 =g_apa.apa01
#     ORDER BY apc02
#
#  SELECT count(*) g_cnt FROM apc_file WHERE apc01 = g_apa.apa01
#  IF g_cnt >0 THEN
#     LET l_apa60f =g_apa.apa60f
#     LET l_apa60  =g_apa.apa60
#     FOREACH t110_apc_j_cs INTO l_apc02,l_apc08,l_apc09
#         IF l_apc08 >=l_apa60f THEN
#            LET l_apc08 = l_apc08 - l_apa60f
#            LET l_apa60f = 0
#         ELSE 
#            LET l_apa60f = l_apa60f - l_apc08
#            LET l_apc08 = 0
#         END IF
#         IF l_apc09 >=l_apa60 THEN
#            LET l_apc09 = l_apc09 - l_apa60
#            LET l_apa60 = 0
#         ELSE 
#            LET l_apa60 = l_apa60 - l_apc09
#            LET l_apc09 = 0
#         END IF
#         UPDATE apc_file set apc08 =l_apc08,
#                             apc09 =l_apc09
#          WHERE apc01 = g_apa.apa01
#            AND apc02 = l_apc02
#         IF l_apa60 =0 OR l_apa60f =0 THEN
#            EXIT FOREACH
#         END IF
#     END FOREACH
#  END IF
##No.FUN-680027--end
#-----END MOD-830089-----
END FUNCTION

FUNCTION t110_21()
  DEFINE l_cnt    LIKE type_file.num5    #No.FUN-690028 SMALLINT
  DEFINE l_str    LIKE type_file.chr1000 # No:FUN-690028 VARCHAR(100)
  DEFINE l_apa01  LIKE apa_file.apa01
  DEFINE l_cmd    LIKE type_file.chr1000 #No.FUN-690028 VARCHAR(100)

   LET l_cnt=0
   #-----MOD-790046---------
   #DECLARE t110_21_c2 CURSOR FOR
   #  SELECT apa01 FROM apa_file WHERE apa08=g_apa.apa01 AND apa00='21'
   DECLARE t110_21_c2 CURSOR FOR
      SELECT apk01 FROM apk_file WHERE apk26=g_apa.apa01
   #-----END MOD-790046-----

   FOREACH t110_21_c2 INTO l_apa01
      LET l_cnt=l_cnt+1
      IF l_cnt=1 THEN
         LET l_str='("',l_apa01,'" '   #MOD-5C0123   #MOD-770081 取消mark
         #LET l_str=" '",l_apa01,"' "   #MOD-5C0123   #MOD-770081 mark
      ELSE
         LET l_str=l_str CLIPPED,',"',l_apa01,'"'   #MOD-5C0123   #MOD-770081 取消mark
         #LET l_str=l_str CLIPPED, ",'",l_apa01,"' "   #MOD-5C0123  #MOD-770081 mark
      END IF
   END FOREACH

   IF l_cnt > 0 THEN
      LET l_str = l_str CLIPPED,")"   #MOD-5C0123   #MOD-770081 取消mark
      #LET l_str = l_str CLIPPED    #MOD-5C0123   #MOD-770081 mark
      #LET l_cmd = "aapt210 ", "'", l_str CLIPPED,"' "   #MOD-5C0123
      #LET l_cmd = "aapt210 ", l_str CLIPPED   #MOD-5C0123   #MOD-770081
      LET l_cmd = "aapt210 '' '' ", "'", l_str CLIPPED,"' "   #MOD-770081
      #CALL cl_cmdrun(l_cmd CLIPPED)        #FUN-660216 remark
      CALL cl_cmdrun_wait(l_cmd CLIPPED)    #FUN-660216
   ELSE
      CALL cl_err('','mfg-032',0)
   END IF

END FUNCTION

FUNCTION t110_5()
    DEFINE l_api01    LIKE api_file.api01
    DEFINE l_cmd      LIKE type_file.chr1000 #No.FUN-690028 VARCHAR(100)
    #DEFINE l_str      VARCHAR(100)   #MOD-650085
    DEFINE l_str      STRING   #MOD-650085
    DEFINE l_cnt      LIKE type_file.num5    #No.FUN-690028 SMALLINT

    LET l_cnt=0
    DECLARE api_cus2 CURSOR FOR
      SELECT api01 FROM api_file WHERE api26=g_apa.apa01 AND api02='2' #FUN-680110   #TQC-7B0117取消mark
      #SELECT api26 FROM api_file WHERE api01=g_apa.apa01 AND api02='2' #FUN-680110   #TQC-7B0117mark

    FOREACH api_cus2 INTO l_api01
       LET l_cnt=l_cnt+1
       IF l_cnt=1 THEN
          LET l_str='("',l_api01,'" '
       ELSE
          LET l_str=l_str CLIPPED,',"',l_api01,'"'
       END IF
    END FOREACH

    IF l_cnt > 0 THEN
       LET l_str = l_str CLIPPED,")"
       #LET l_cmd = "aapt120 ", "'", l_str CLIPPED,"' "   #MOD-650085
       #LET l_cmd = "aapt160 '' '' ", "'", l_str CLIPPED,"' "   #MOD-650085 #FUN-680110   #TQC-7B0117
       LET l_cmd = "aapt110 '' '' ", "'", l_str CLIPPED,"' "   #MOD-650085 #FUN-680110   #TQC-7B0117
       #CALL cl_cmdrun(l_cmd)      #FUN-660216 remark
       CALL cl_cmdrun_wait(l_cmd)  #FUN-660216 add
    ELSE
       CALL cl_err('','mfg-032',0)
    END IF

END FUNCTION

FUNCTION t110_apa17(p_cmd)
   DEFINE p_cmd     LIKE type_file.chr1   # a:不必Update u:要Update  #No.FUN-690028 VARCHAR(1)
   DEFINE l_apa     RECORD LIKE apa_file.*
   DEFINE l_apa07   LIKE apa_file.apa07   #TQC-630164
   DEFINE l_apa09   LIKE apa_file.apa09   #MOD-9C0148 add
   DEFINE l_paydate LIKE type_file.dat    #MOD-9C0148 add
   DEFINE l_gec05   LIKE gec_file.gec05   #MOD-B50183
   DEFINE l_pma03   LIKE pma_file.pma03   #MOD-D10165 add
   DEFINE l_pma12   LIKE pma_file.pma12   #MOD-D10165 add

   IF g_apa.apa08 = 'MISC' THEN
      RETURN
   END IF

   LET l_apa.* = g_apa.*
   LET l_apa09 = l_apa.apa09   #MOD-9C0148 add

   OPEN WINDOW t110_apa17_w WITH FORM "aap/42f/aapt110_g"
        ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
   CALL cl_ui_locale("aapt110_g")

   #-----FUN-650068---------
   IF g_aza.aza26 <> '2' THEN
      CALL cl_set_comp_visible("apa46",FALSE)
   END IF
   #-----END FUN-650068-----

   #-----MOD-770050---------
   IF g_aza.aza26 = '2' THEN
      CALL cl_set_comp_visible("apa171",FALSE)
   END IF
   #-----END MOD-770050-----

   #No:MOD-510180 add apa41判斷
   IF g_apa.apa41='Y' OR g_apa.apa08 = 'UNAP' THEN     #No:MOD-530527
     #DISPLAY BY NAME l_apa.apa08,l_apa.apa18,l_apa.apa09,l_apa.apa171,              #FUN-650068
      DISPLAY BY NAME l_apa.apa46,l_apa.apa08,l_apa.apa18,l_apa.apa09,l_apa.apa171,  #FUN-650068
                      l_apa.apa17,l_apa.apa172,l_apa.apa173,l_apa.apa174
      MENU ""
         ON ACTION exit
            EXIT MENU
         COMMAND KEY(INTERRUPT)
            LET INT_FLAG=FALSE 		#MOD-570244	mars
            EXIT MENU
         ON ACTION controlg       #TQC-860021
            CALL cl_cmdask()      #TQC-860021
         ON IDLE g_idle_seconds   #TQC-860021
            CALL cl_on_idle()     #TQC-860021
            CONTINUE MENU         #TQC-860021
         ON ACTION about          #TQC-860021
            CALL cl_about()       #TQC-860021
         ON ACTION help           #TQC-860021
            CALL cl_show_help()   #TQC-860021
      END MENU
      CLOSE WINDOW t110_apa17_w
      RETURN
   ELSE
   # end add
     #CALL t110_ddd1('u')   #MOD-580079   #MOD-640446
      DISPLAY BY NAME l_apa.apa08
      CALL cl_set_head_visible("","YES")     #No.FUN-6B0033
     #INPUT BY NAME l_apa.apa08,l_apa.apa18,l_apa.apa09,l_apa.apa171,              #FUN-650068
      INPUT BY NAME l_apa.apa46,l_apa.apa08,l_apa.apa18,l_apa.apa09,l_apa.apa171,  #FUN-650068
                    l_apa.apa17,l_apa.apa172,l_apa.apa173,l_apa.apa174
                    WITHOUT DEFAULTS
 
         AFTER FIELD apa18
            IF NOT cl_null(l_apa.apa18) THEN
               IF (g_apz.apz14 = 'Y' OR g_aza.aza21 = 'Y') AND   #FUN-990053 mod #TQC-9A0017 add (  #TQC-9A0119 mod ()
                  NOT s_chkban(l_apa.apa18) THEN #MOD-9A0145 g_apk[i].apk04-->l_apa.apa18  #TQC-9A0119 mod
                  CALL cl_err('','aoo-080',0) NEXT FIELD apa18
               END IF
               IF l_apa.apa06='MISC' THEN
                  CALL t110_input_apl(l_apa.apa18)
                  LET l_apa07 = g_apa.apa07   #TQC-630164
                  LET l_apa.apa07 = g_apa.apa07   #MOD-880103 add
               END IF
            #-----TQC-630164---------
            ELSE
              IF g_aza.aza26 = '0' THEN                                          #MOD-BB0121 add
                 LET l_gec05 = ''                                                #MOD-B50183 
                 SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01=g_apa.apa15 #MOD-B50183
                #IF l_apa.apa06='MISC' THEN                          #MOD-880044 mark
                #IF l_apa.apa06='MISC' AND l_apa.apa171!='XX' THEN   #MOD-880044                          #MOD-880173 mark
                #IF l_apa.apa06='MISC' AND l_apa.apa171!='XX' AND l_apa.apa171!='28' THEN   #MOD-880044   #MOD-880173 #MOD-B50183 mark
                 IF l_apa.apa06='MISC' AND l_apa.apa171!='XX' AND l_apa.apa171!='28' #MOD-B50183 
                    AND l_apa.apa171!='29' AND l_gec05 NOT MATCHES '[4X]' THEN       #MOD-B50183
                    CALL cl_err('','aap-156',0)  #MOD-B10191 
                    NEXT FIELD apa18
                 END IF
                #str MOD-B40252 add
                #IF l_apa.apa171!='XX' THEN   #MOD-B50183 mark
                 IF l_apa.apa171 != 'XX' AND l_apa.apa171 !='28' AND l_apa.apa171 != '29' #MOD-B50183
                    AND l_gec05 NOT MATCHES '[4X]' THEN                                   #MOD-B50183
                    CALL cl_err('apa18 is null: ','aap-099',0)
                    NEXT FIELD apa18
                 END IF
                #end MOD-B40252 add
               #-----END TQC-630164-----
              END IF                                                                           #MOD-BB0121 add
            END IF
 
        #str MOD-9C0148 add
         AFTER FIELD apa09   #發票日期
            #當付款基準日為發票日時,調整發票日期需重算付款日及票到期日
            IF g_aptype[1,1] = '1' AND
               l_apa.apa11 IS NOT NULL AND
               l_apa.apa09 != l_apa09 AND l_apa09 IS NOT NULL THEN
              #---------------------MOD-D10165---------------------(S)
               SELECT pma03,pma12 INTO l_pma03,l_pma12
                 FROM pma_file
                WHERE pma01 = l_apa.apa11
               IF l_pma03 MATCHES "[25]" OR l_pma12 MATCHES "[25]" THEN
              #---------------------MOD-D10165---------------------(E)
                  IF g_aptype = '13' OR g_aptype = '17' THEN
                     CALL s_paydate('a','',l_apa.apa09,l_apa.apa02,l_apa.apa11,'EMPL')
                          RETURNING l_paydate,l_apa.apa64,l_apa.apa24
                  ELSE
                     CALL s_paydate('a','',l_apa.apa09,l_apa.apa02,l_apa.apa11,l_apa.apa06)
                          RETURNING l_paydate,l_apa.apa64,l_apa.apa24
                  END IF
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err(l_apa.apa01,g_errno,0)
                     LET l_apa.apa64 = g_apa.apa64
                     LET l_apa.apa24 = g_apa.apa24
                  ELSE
                     LET l_apa.apa12 = l_paydate
                  END IF
               END IF                                            #MOD-D10165 add
               #CHI-AB0017 add --start--
               IF g_apa.apa24 < 0 THEN
                  IF NOT cl_confirm('aap-142') THEN NEXT FIELD apa09 END IF
               END IF
               #CHI-AB0017 add --end--
            END IF
            LET l_apa09 = l_apa.apa09
        #end MOD-9C0148 add

         AFTER FIELD apa171
            IF l_apa.apa171 != '21' AND l_apa.apa171 != '22' AND
               l_apa.apa171 != '23' AND l_apa.apa171 != '24' AND
               l_apa.apa171 != '25' AND l_apa.apa171 != '26' AND
               l_apa.apa171 != '27' AND l_apa.apa171 != '28' AND
               l_apa.apa171 != 'XX' AND l_apa.apa171 != '29' THEN
               NEXT FIELD apa171
            END IF
 
         AFTER FIELD apa17
            IF NOT cl_null(l_apa.apa17) THEN
               IF l_apa.apa17 <>' ' AND l_apa.apa17 NOT MATCHES '[1234]' THEN    #No:MOD-4C0091 add 3,4
                  NEXT FIELD apa17
               END IF
            END IF

         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE INPUT
 
         ON ACTION about         #MOD-4C0121
            CALL cl_about()      #MOD-4C0121
 
         ON ACTION help          #MOD-4C0121
            CALL cl_show_help()  #MOD-4C0121
 
         ON ACTION controlg      #MOD-4C0121
            CALL cl_cmdask()     #MOD-4C0121
      END INPUT
   END IF
   CLOSE WINDOW t110_apa17_w
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF

   IF p_cmd='a' THEN
      LET g_apa.* = l_apa.*
      RETURN
   END IF

   UPDATE apa_file SET apa46 =l_apa.apa46,   #FUN-650068
                       apa18 =l_apa.apa18,
                       apa09 =l_apa.apa09,
                       apa07 =l_apa.apa07,   #MOD-880103 add
                       apa17 =l_apa.apa17,
                       apa171=l_apa.apa171,
                       apa172=l_apa.apa172,
                       apa173=l_apa.apa173,
                       apa174=l_apa.apa174,
                       apa24 =l_apa.apa24,   #MOD-9C0148 add
                       apa12 =l_apa.apa12,   #MOD-9C0148 add
                       apa64 =l_apa.apa64    #MOD-9C0148 add
                 WHERE apa01 =l_apa.apa01
   IF SQLCA.SQLERRD[3]=0 THEN
      RETURN
   END IF

   LET g_apa.* = l_apa.*
   IF NOT cl_null(l_apa07) THEN   #MOD-790124
      LET g_apa.apa07 = l_apa07   #TQC-630164
   END IF   #MOD-790124
 #MOD-990188---modify---start---                                                                                                              
   IF g_apa.apa08 != 'MISC' AND g_apa.apa08 != g_apa.apa01 AND
      NOT cl_null(g_apa.apa08) AND g_apa.apa08 !='UNAP' AND
      g_apa.apa00 != '21' THEN  
      CALL t110_ddd1('u')                                                                                                           
   END IF    
 #MOD-990188---modify---end---                                                                                                                       

END FUNCTION
 
FUNCTION t110_apa54()
 DEFINE  l_pja02   LIKE pja_file.pja02   #FUN-810045 gja02->pja02
 DEFINE  m_aag02   LIKE aag_file.aag02
 DEFINE  m_aag151   LIKE aag_file.aag151
 DEFINE  m_aag161   LIKE aag_file.aag161
 DEFINE  m_aag171   LIKE aag_file.aag171
 DEFINE  m_aag181   LIKE aag_file.aag181

   IF g_apa.apa41='Y' THEN
      RETURN
   END IF

   IF g_apa.apa42='Y' THEN
      RETURN
   END IF

   OPEN WINDOW t110_apa54_w WITH FORM "aap/42f/aapt110_h"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
    CALL cl_ui_locale("aapt110_h")
 
   SELECT aag02,aag151,aag161,aag171,aag181
     INTO m_aag02,m_aag151,m_aag161,m_aag171,m_aag181
     FROM aag_file WHERE aag01 = g_apa.apa54
                     AND aag00 = g_bookno1       #No.FUN-730064
                     AND aagacti = 'Y'           #No.MOD-B70280 add

   IF SQLCA.sqlcode THEN
      LET m_aag02 = ' '
   END IF

   DISPLAY m_aag02 TO FORMONLY.aag02
   DISPLAY BY NAME g_apa.apa66

   #SELECT gja02 INTO l_gja02 FROM gja_file WHERE gja01 =g_apa.apa66  #FUN-810045
   SELECT pja02 INTO l_pja02 FROM pja_file WHERE pja01 =g_apa.apa66   #FUN-810045
   IF SQLCA.sqlcode THEN
      LET l_pja02 = ' '  #FUN-810045 gja02->pja02
   END IF

   #DISPLAY l_gja02 TO FORMONLY.gja02   #FUN-810045
   DISPLAY l_pja02 TO FORMONLY.pja02    #FUN-810045
   CALL cl_set_head_visible("","YES")     #No.FUN-6B0033

   INPUT BY NAME g_apa.apa54,g_apa.apa67,g_apa.apa68,
                 g_apa.apa69,g_apa.apa70,g_apa.apa71
                 WITHOUT DEFAULTS

        AFTER FIELD apa67
           CALL t110_apa67(m_aag151,'1',g_apa.apa67)
           IF NOT cl_null(g_errno) THEN
              CALL cl_err('',g_errno,1)
              NEXT FIELD apa67
           END IF

        AFTER FIELD apa68
           CALL t110_apa67(m_aag161,'2',g_apa.apa68)
           IF NOT cl_null(g_errno) THEN
              CALL cl_err('',g_errno,1)
              NEXT FIELD apa68
           END IF

        AFTER FIELD apa69
           CALL t110_apa67(m_aag171,'3',g_apa.apa69)
           IF NOT cl_null(g_errno) THEN
              CALL cl_err('',g_errno,1)
              NEXT FIELD apa69
           END IF

        AFTER FIELD apa70
           CALL t110_apa67(m_aag181,'4',g_apa.apa70)
           IF NOT cl_null(g_errno) THEN
              CALL cl_err('',g_errno,1)
              NEXT FIELD apa70
           END IF

        ON ACTION CONTROLP
           CASE
              WHEN INFIELD(apa66)    #查詢專案編號
#                CALL q_pja(10,3,g_apa.apa66) RETURNING g_apa.apa66
                 CALL cl_init_qry_var()
                 #LET g_qryparam.form ="q_pja"    #FUN-810045
                 LET g_qryparam.form ="q_pja2"    #FUN-810045 
                 LET g_qryparam.default1 =g_apa.apa66
                 LET g_qryparam.arg1 = g_bookno1      #No.FUN-730064
                 CALL cl_create_qry() RETURNING g_apa.apa66
#                 CALL FGL_DIALOG_SETBUFFER( g_apa.apa66 )
                 DISPLAY BY NAME g_apa.apa66
              WHEN INFIELD(apa67)    #查詢異動碼-1
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_aee"
                 LET g_qryparam.default1 =g_apa.apa67
                 LET g_qryparam.arg1 =g_apa.apa54
                 LET g_qryparam.arg2 =1
                 CALL cl_create_qry() RETURNING g_apa.apa67
                 DISPLAY BY NAME g_apa.apa67
              WHEN INFIELD(apa68)    #查詢異動碼-2
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_aee"
                 LET g_qryparam.default1 =g_apa.apa68
                 LET g_qryparam.arg1 =g_apa.apa54
                 LET g_qryparam.arg2 =2
                 CALL cl_create_qry() RETURNING g_apa.apa68
                 DISPLAY BY NAME g_apa.apa68
              WHEN INFIELD(apa69)    #查詢異動碼-3
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_aee"
                 LET g_qryparam.default1 =g_apa.apa69
                 LET g_qryparam.arg1 =g_apa.apa54
                 LET g_qryparam.arg2 =3
                 CALL cl_create_qry() RETURNING g_apa.apa69
                 DISPLAY BY NAME g_apa.apa69
              WHEN INFIELD(apa70)    #查詢異動碼-4
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_aee"
                 LET g_qryparam.default1 =g_apa.apa70
                 LET g_qryparam.arg1 =g_apa.apa54
                 LET g_qryparam.arg2 =4
                 CALL cl_create_qry() RETURNING g_apa.apa70
                 DISPLAY BY NAME g_apa.apa70
            END CASE
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
 
   END INPUT

   CLOSE WINDOW t110_apa54_w

   IF INT_FLAG THEN
      LET INT_FLAG=0
      RETURN
   END IF

   LET g_apa.apa72=g_apa.apa14
   #No.MOD-590312  --begin
   CALL t110_comp_oox(g_apa.apa01) RETURNING g_net
   LET g_apa.apa73=g_apa.apa34-g_apa.apa35 + g_net
   #No.MOD-590312  --end

   UPDATE apa_file SET *=g_apa.* WHERE apa01=g_apa.apa01

END FUNCTION

FUNCTION t110_apa67(p_cmd,p_seq,p_key)
   DEFINE p_cmd      LIKE aag_file.aag151,    # 檢查否
          #p_seq      VARCHAR(1),             # 項      #FUN-660117 remark
          #p_key      VARCHAR(20),            # 異動碼  #FUN-660117 remark
          p_seq      LIKE aee_file.aee02,  # 項      #FUN-660117
          p_key      LIKE aee_file.aee03,  # 異動碼  #FUN-660117
          p_acno     LIKE aag_file.aag01,
          l_aeeacti  LIKE aee_file.aeeacti,
          l_aee04    LIKE aee_file.aee04

   LET g_errno = ' '
   SELECT aee04,aeeacti INTO l_aee04,l_aeeacti FROM aee_file
    WHERE aee01 = g_apa.apa54
      AND aee02 = p_seq
      AND aee03 = p_key

   CASE p_cmd
      WHEN '2'   #異動碼必須輸入不檢查
         IF p_key IS NULL OR p_key = ' ' THEN
            LET g_errno = 'agl-154'
         END IF
      WHEN '3'   #異動碼必須輸入要檢查
         CASE
            WHEN p_key IS NULL OR p_key = ' '
                 LET g_errno = 'agl-154'
            WHEN l_aeeacti = 'N' LET g_errno = '9027'
            WHEN SQLCA.sqlcode = 100 LET g_errno = 'agl-153'
            OTHERWISE  LET g_errno = SQLCA.sqlcode USING'-------'
         END CASE
      OTHERWISE EXIT CASE
   END CASE

END FUNCTION

FUNCTION t110_c()          # 將之結案
 DEFINE l_apa01 LIKE apa_file.apa01,
        l_cnt   LIKE type_file.num5     #MOD-620008  #No.FUN-690028 SMALLINT
#FUN-C80078 add str---
 DEFINE l_exe_void          LIKE type_file.chr1,
        l_exe_cancel_void   LIKE type_file.chr1
#FUN-C80078 add end---

   IF g_apa.apa01 IS NULL THEN
      RETURN
   END IF

  #FUN-C80078 add str---
   SELECT ROWID INTO g_apa_rowid FROM apa_file
    WHERE apa01 = g_apa.apa01
  #FUN-C80078 add end---

   SELECT * INTO g_apa.* FROM apa_file
   WHERE apa01=g_apa.apa01

  #FUN-C80078 add str---
   IF SQLCA.sqlcode = '100' THEN
      CALL cl_err('','aap-091',0)
      LET g_errno = 'aap-091'
      LET g_success = 'N'
      RETURN
   END IF
  #FUN-C80078 add end---

   IF g_apa.apa41 = 'Y' THEN
      CALL cl_err('','9023',0)
      LET g_errno = '9023'  #FUN-C80078 add
      LET g_success = 'N'   #FUN-C80078 add
      RETURN
   END IF
#FUN-540041
   IF g_apa.apa63 MATCHES '[Ss1]' THEN      #FUN-540045 #FUN-550042
      CALL cl_err('','mfg3557',0)
      LET g_errno = 'mfg3557'  #FUN-C80078 add
      LET g_success = 'N'      #FUN-C80078 add
      RETURN
   END IF
#END FUN-540041
   #-->為外購拋入的不可作廢
   IF g_apa.apa75 = 'Y' THEN
      CALL cl_err('','aap-332',1)
      LET g_errno = 'aap-332'  #FUN-C80078 add
      LET g_success = 'N'      #FUN-C80078 add
      RETURN
   END IF

  #FUN-C80078 add str---
   IF g_prog <> 'aws_ttsrv2' THEN
      IF g_apa.apa42 ='N' THEN
        #IF g_apa.apa79 = '3' THEN  #FUN-CC0142 mark
         IF g_apa.apa79 = 'N' THEN  #FUN-CC0142 add
            #單據來源為HRM,不可由TIPTOP直接作廢,需由HRM端發起作廢異動!
           #CALL cl_err('apa79=3','aws-456',1)  #FUN-CC0142 mark
            CALL cl_err('apa79=N','aws-456',1)  #FUN-CC0142 add
            RETURN
         END IF
      END IF
  #FUN-C80078 add end---
      #-->已有直接付款的資料時，不可作廢 modi 01/08/02
      SELECT COUNT(*) INTO g_cnt FROM aph_file
       WHERE aph01 = g_apa.apa01
      IF g_cnt > 0 THEN
         CALL cl_err('','aap-326',1)
         RETURN
      END IF
   END IF  #FUN-C80078 add

   #CHI-A80008 mark --start--
   ##---若已有發票資料，不可作廢
   #SELECT COUNT(*) INTO g_cnt FROM apk_file
   # WHERE apk01 = g_apa.apa01
   #IF g_cnt > 0 THEN
   #   CALL cl_err('','aap-327',0)
   #   RETURN
   #END IF
   #CHI-A80008 mark --end--

   #-----MOD-620008---------已有沖帳之資料不可作廢
   LET l_cnt=0
   SELECT COUNT(*) INTO l_cnt FROM aph_file,apf_file
     WHERE aph04 = g_apa.apa01 AND apf01=aph01
       AND apf41 != 'X'
    IF l_cnt > 0 THEN
       CALL cl_err(g_apa.apa01,'agl-906',0)
       LET g_errno = 'agl-906'  #FUN-C80078 add
       LET g_success = 'N'      #FUN-C80078 add
       RETURN
    END IF
   #-----END MOD-620008-----

   #-----MOD-680082---------
   #有直接沖帳金額存在時,不可以作廢
   LET l_cnt = 0
   SELECT COUNT(*) INTO l_cnt FROM apv_file
     WHERE apv01 = g_apa.apa01
   IF l_cnt > 0 THEN
      CALL cl_err(g_apa.apa01,'anm-538',0)
      LET g_errno = 'anm-538'  #FUN-C80078 add
      LET g_success = 'N'      #FUN-C80078 add
      RETURN
   END IF
   #-----END MOD-680082-----

   #CHI-A80008 mark --start--
   ##---若有輸入單身資料必須利用 F2 刪除單身資料後，才可作廢
   ##   (因為rvb06是on line update)
   #IF g_apa.apa00 = '11' OR g_apa.apa00 = '15' OR g_apa.apa00 = '16' OR   #MOD-8B0034 add 16
   #   g_apa.apa00 = '21' OR g_apa.apa00 = '17' THEN  #NO.FUN-690080
   #   SELECT COUNT(*) INTO g_cnt FROM apb_file
   #    WHERE apb01 = g_apa.apa01
   #      AND (apb21 IS NOT NULL OR apb06 IS NOT NULL)
   #   IF g_cnt > 0 THEN
   #      CALL cl_err('','aap-328',0)
   #      RETURN
   #   END IF
   #END IF
   #CHI-A80008 mark --end--
 
   LET g_apa_t.* = g_apa.*       #BACKUP  #MOD-B40036  
   LET g_success='Y'
   IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
      BEGIN WORK
   END IF  #FUN-C80078 add

   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa_rowid
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl c:", STATUS, 1)
      LET g_errno = 'aws-191'  #FUN-C80078 add
      LET g_success = 'N'      #FUN-C80078 add
      CLOSE t110_cl
      IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
         ROLLBACK WORK
      END IF  #FUN-C80078 add
      RETURN
   END IF

   FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
      CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
      LET g_errno = '-243'  #FUN-C80078 add 
      LET g_success = 'N'   #FUN-C80078 add
      CLOSE t110_cl
      IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
         ROLLBACK WORK
      END IF  #FUN-C80078 add
      RETURN
   END IF

  #FUN-C80078 add str---
   LET l_exe_void = 'N'
   LET l_exe_cancel_void = 'N'
   IF g_prog <> 'aws_ttsrv2' THEN
      IF cl_void(0,0,g_apa.apa42) THEN
         IF g_apa.apa42 ='N' THEN         #切換為作廢
            IF cl_confirm('aap-138') THEN
               LET l_exe_void = 'Y'     #執行作廢
            END IF
         ELSE
           #IF g_apa.apa79 = '3' THEN       #FUN-CC0142 mark
            IF g_apa.apa79 = 'N' THEN       #FUN-CC0142 add
                #單據來源為HRM,不可由TIPTOP直接作廢還原!
               #CALL cl_err('apa79=3','aws-454',1)   #FUN-CC0142 mark
                CALL cl_err('apa79=N','aws-454',1)   #FUN-CC0142 add
                RETURN
            ELSE
                LET l_exe_cancel_void = 'Y'  #執行取消作廢
            END IF
         END IF
      END IF
   ELSE
      IF g_apa.apa42 = 'N' THEN
         LET l_exe_void = 'Y'              #執行作廢
      ELSE
         LET l_exe_cancel_void = 'N'
         #若是走aws_ttsrv2通道，則告知此張單據已作廢,不可再作發還原!
         LET g_errno = 'aar-107'           #該單號已作廢
         LET g_success = 'N'
         RETURN
      END IF
   END IF
  #FUN-C80078 add end---

  #FUN-C80078 mark str---
  #IF cl_void(0,0,g_apa.apa42) THEN
  #   IF g_apa.apa42 ='N' THEN    #切換為作廢
  #      IF cl_confirm('aap-138') THEN #CHI-A80008 add
  #FUN-C80078 mark end---
   IF l_exe_void = 'Y' THEN #執行作廢  #FUN-C80078 add
      #CHI-A80008 add --start--
      #刪除發票資料
      DELETE FROM apk_file
       WHERE apk01 = g_apa.apa01
      IF SQLCA.sqlcode THEN
         CALL cl_err3("del","apk_file",g_apa.apa01,"",SQLCA.sqlcode,"","del apk_file",1)
         LET g_success = 'N'
      END IF

      DECLARE t110_r_cur11 CURSOR WITH HOLD FOR                                                                                    
      SELECT apb02,'',apb11,apb29,apb21,apb22,apb34,'',
             apb06,apb07,apb12,apb27,
             #apb09,apb28,'',apb25,apb26,apb23,apb24,apb08,apb10
             apb09,apb28,apb35,apb36,apb31,'','',apb25,'',apb251,
             '',apb26,'','','',apb23,apb24,apb08,apb10, 
             apbud01,apbud02,apbud03,apbud04,apbud05,              #TQC-B20109
             apbud06,apbud07,apbud08,apbud09,apbud10,              #TQC-B20109
             apbud11,apbud12,apbud13,apbud14,apbud15               #TQC-B20109
            ,apb04,apb05                                           #CHI-B30009 add
        FROM apb_file
       WHERE apb01 = g_apa.apa01
       ORDER BY apb02
  
      LET l_ac = 1

     #FOREACH t110_r_cur11 INTO g_apb[l_ac].*                      #CHI-B30009 mark
      FOREACH t110_r_cur11 INTO g_apb[l_ac].*,g_apb04_t,g_apb05_t  #CHI-B30009
         IF STATUS THEN
            CALL cl_err('for apb:',STATUS,1)
            LET g_success = 'N'
            EXIT FOREACH
         END IF

         LET g_apb_t.* = g_apb[l_ac].*  #BACKUP

         #正常請款,但是對應入庫/倉退單有做過衝暫估,則不能刪除
         IF cl_null(g_apb[l_ac].apb34) OR g_apb[l_ac].apb34 = 'N' THEN
            IF g_apa.apa00 <> '22' THEN                    #MOD-AA0061
               LET l_cnt = 0
               SELECT COUNT(*) INTO l_cnt FROM apb_file
                WHERE apb21 = g_apb_t.apb21
                  AND apb22 = g_apb_t.apb22
                  AND apb34 = 'Y'
               IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
               IF l_cnt > 0 THEN
                  CALL cl_err(g_apb_t.apb21,'aap-816',1)
                  LET g_errno = 'aap-816'  #FUN-C80078 add
                  LET g_success = 'N'
                  EXIT FOREACH
               END IF
            END IF                                        #MOD-AA0061
         END IF
         #刪除單身資料
         #CHI-B20007 add --start--
         IF g_apa.apa00 = '11' OR g_apa.apa00 = '15' OR g_apa.apa00 = '16' OR  
            g_apa.apa00 = '21' OR g_apa.apa00 = '12' THEN 
            LET g_cnt = 0
            SELECT COUNT(*) INTO g_cnt FROM apb_file
             WHERE apb01 = g_apa.apa01
               AND (apb21 IS NOT NULL OR apb06 IS NOT NULL)
            IF g_cnt > 0 THEN
         #CHI-B20007 add --end--
               DELETE FROM apb_file
                WHERE apb01 = g_apa.apa01 AND apb02 = g_apb_t.apb02
               IF SQLCA.sqlcode THEN
                  CALL cl_err3("del","apb_file",g_apa.apa01,g_apb_t.apb02,SQLCA.sqlcode,"","",1)
                  LET g_success = 'N'
                  EXIT FOREACH
               ELSE
                  IF g_apa.apa08 = 'UNAP' THEN
                     IF NOT cl_null(g_apb_t.apb21) AND
                        NOT cl_null(g_apb_t.apb22) THEN
                        UPDATE rvv_file SET rvv40 = 'N'
                           WHERE rvv01 = g_apb_t.apb21 AND rvv02 = g_apb_t.apb22
                        IF STATUS OR SQLCA.SQLERRD[3] = 0 THEN
                           CALL cl_err3("upd","rvv_file",g_apb_t.apb21,g_apb_t.apb22,STATUS,"","upd rvv40",1)  
                           LET g_success = 'N'
                           EXIT FOREACH
                        END IF
                     END IF
                  END IF
               END IF
               #CHI-B20007 add --start--
               LET g_apa.apa31=0
               LET g_apa.apa32=0
               LET g_apa.apa31f=0
               LET g_apa.apa32f=0
               LET g_apa.apa57=0
               LET g_apa.apa57f=0
               CALL t110_apa34f('0')
               CALL t110_unpay()
               #CHI-B20007 add --end--
               #若是衝暫估,則自動產生api資料
               IF g_apb_t.apb34 = 'Y' THEN
                  CALL t110_api_unap('d')
               END IF
            END IF #CHI-B20007 add
         END IF #CHI-B20007 add
         LET g_apb[l_ac].apb29 = g_apb_t.apb29  #t110_bu中用l_ac在判斷
         CALL t110_bu(0,1)
      END FOREACH
      
      LET g_apa.apa08=''
      #CHI-B20007 mark --start--
      #LET g_apa.apa31=0
      #LET g_apa.apa32=0
      #LET g_apa.apa31f=0
      #LET g_apa.apa32f=0
      #LET g_apa.apa57=0
      #LET g_apa.apa57f=0
      #CALL t110_apa34f('0')
      #CALL t110_unpay()
      #CHI-B20007 mark --end-- 
       #CHI-A80008 add --end--

      LET g_apa.apa42='Y'
#FUN-540041
      LET g_apa.apa63 = '9'
#     LET g_apa.apaacti = 'N'  #暫時mark
#END FUN-540041
      #-->刪除傳票
      DELETE FROM npp_file
       WHERE npp01 = g_apa.apa01
         AND nppsys = 'AP'
         AND npp00 = 1
         AND npp011 = 1
  
      DELETE FROM npq_file
       WHERE npq01 = g_apa.apa01
         AND npqsys = 'AP'
         AND npq00 = 1
         AND npq011 = 1

      #CHI-A80008 mark --start--
      ##No.TQC-740080 --start--
      #DECLARE t110_r_cur11 CURSOR WITH HOLD FOR                                                                                    
      #SELECT apb02,'',apb11,apb29,apb21,apb22,apb34,'',  #No.TQC-7B0083  #apb31/30移至apb36後
      #       apb06,apb07,apb12,apb27,
      #       #apb09,apb28,'',apb25,apb26,apb23,apb24,apb08,apb10   #MOD-770044
      #       apb09,apb28,apb35,apb36,apb31,'','',apb25,'',apb251,  #FUN-810045 add apb35/36
      #       '',apb26,'','','',apb23,apb24,apb08,apb10   #MOD-770044  
      #  FROM apb_file
      # WHERE apb01 = g_apa.apa01
      # ORDER BY apb02
      # 
      #LET l_ac = 1
      #
      #FOREACH t110_r_cur11 INTO g_apb[l_ac].*
      #  IF STATUS THEN
      #    CALL cl_err('for apb:',STATUS,1)
      #    LET g_success = 'N'
      #    EXIT FOREACH
      #  END IF
      #
      #  #No.TQC-7B0083  --Begin
      #  #apa00 = '16' / '26' rvv88 - apb09
      #  #apb34 = 'Y' rvv23 - apb09 & rvv88 + apb09
      #  #UPDATE rvv_file SET rvv23 = rvv23 - g_apb[l_ac].apb09
      #  # WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
      #  IF g_apa.apa00 = '16' OR g_apa.apa00 = '26' THEN
      #     UPDATE rvv_file SET rvv88 = rvv88 - g_apb[l_ac].apb09
      #      WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
      #  ELSE  
      #     IF g_apb[l_ac].apb34 = 'Y' THEN
      #        UPDATE rvv_file SET rvv88 = rvv88 + g_apb[l_ac].apb09
      #         WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
      #        IF STATUS THEN
      #           CALL cl_err3("upd","rvv_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","upd rvv88",1)
      #           LET g_success='N'
      #           EXIT FOREACH
      #        END IF
      #     END IF
      #     UPDATE rvv_file SET rvv23 = rvv23 - g_apb[l_ac].apb09
      #      WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
      #  END IF
      #  #No.TQC-7B0083  --End   
      #  IF STATUS THEN
      #     CALL cl_err3("upd","rvv_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","upd rvv23/rvv88",1)  #No.TQC-7B0083
      #     LET g_success='N'
      #     EXIT FOREACH
      #  END IF
      #END FOREACH
      ##No.TQC-740080 --end--
      #CHI-A80008 mark --end--

      #-->若已有相對應之折讓單，須先行刪除折讓單
      SELECT apa01 INTO l_apa01 FROM apa_file
       WHERE apa08 = g_apa.apa01 AND apa58 = '1'
      IF STATUS <> 100 THEN
         DELETE FROM apa_file WHERE apa01 = l_apa01
         IF STATUS THEN
#           CALL cl_err('del apa_21:',STATUS,0)   #No.FUN-660122
            CALL cl_err3("del","apa_file",l_apa01,"",STATUS,"","del apa_21:",1)  #No.FUN-660122
            LET g_success='N'
         END IF

#No.FUN-680027--begin
         DELETE FROM apc_file WHERE apc01 = l_apa01
         IF STATUS THEN
            CALL cl_err3("del","apc_file",l_apa01,"",STATUS,"","del apc_21:",1)  #No.FUN-660122
            LET g_success='N'
         END IF
#No.FUN-680027--end
         DELETE FROM apb_file WHERE apb01 = l_apa01
         IF STATUS THEN
#           CALL cl_err('del apb_21:',STATUS,0)   #No.FUN-660122
            CALL cl_err3("del","apb_file",l_apa01,"",STATUS,"","del apb_21:",1)  #No.FUN-660122
            LET g_success='N'
         END IF

         DELETE FROM apk_file WHERE apk01 = l_apa01
         IF STATUS THEN
#           CALL cl_err('del apk_21',STATUS,0)  #No.FUN-660122
            CALL cl_err3("del","apk_file",l_apa01,"",STATUS,"","del apk_21:",1)  #No.FUN-660122
            LET g_success = 'N'
         END IF
      END IF
   END IF  #CHI-A80008 add
  #ELSE                        #取消作廢  #FUN-C80078 mark
   IF l_exe_cancel_void = 'Y' THEN #執行取消作廢  #FUN-C80078 add
#FUN-540041
      LET g_apa.apa63 = '0'
#     LET g_apa.apaacti = 'Y'   #暫時mark
#END FUN-540041
      LET g_apa.apa42='N'

      #No.TQC-740080 --start--
      DECLARE t110_r_cur12 CURSOR WITH HOLD FOR                                                                                    
      SELECT apb02,'',apb11,apb29,apb21,apb22,apb34,'',   #No.TQC-7B0083
             apb06,apb07,apb12,apb27,
             #apb09,apb28,'',apb25,apb26,apb23,apb24,apb08,apb10   #MOD-770044
             apb09,apb28,apb35,apb36,apb31,'','',apb25,'',  #FUN-810034 add apb35/apb36
             apb251,'',apb26,'','','',apb23,apb24,apb08,apb10,   #MOD-770044
             apbud01,apbud02,apbud03,apbud04,apbud05,            #TQC-B20109
             apbud06,apbud07,apbud08,apbud09,apbud10,            #TQC-B20109
             apbud11,apbud12,apbud13,apbud14,apbud15             #TQC-B20109
        FROM apb_file
       WHERE apb01 = g_apa.apa01
       ORDER BY apb02

      LET l_ac = 1

      FOREACH t110_r_cur12 INTO g_apb[l_ac].*
        IF STATUS THEN
          CALL cl_err('for apb:',STATUS,1)
          LET g_success = 'N'
          EXIT FOREACH
        END IF

        #No.TQC-7B0083  --Begin
        #UPDATE rvv_file SET rvv23 = rvv23 + g_apb[l_ac].apb09
        # WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
        IF g_apa.apa00 = '16' OR g_apa.apa00 = '26' THEN
           UPDATE rvv_file SET rvv88 = rvv88 + g_apb[l_ac].apb09
            WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
        ELSE
           IF g_apb[l_ac].apb34 = 'Y' THEN
              UPDATE rvv_file SET rvv88 = rvv88 - g_apb[l_ac].apb09
               WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
              IF STATUS THEN
                 CALL cl_err3("upd","rvv_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","upd rvv88",1)
                 LET g_success='N'
                 EXIT FOREACH
              END IF
           END IF
           UPDATE rvv_file SET rvv23 = rvv23 + g_apb[l_ac].apb09
            WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
        END IF
        #No.TQC-7B0083  --End  
        IF STATUS THEN
           CALL cl_err3("upd","rvv_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","upd rvv23/rvv88",1) #No.TQC-7B0083
           LET g_success='N'
           EXIT FOREACH
        END IF
      END FOREACH
      #No.TQC-740080 --end--
   END IF

   IF l_exe_void = 'Y' OR l_exe_cancel_void = 'Y' THEN  #FUN-C80078 add
      #CHI-A80008 mod --start--
      #UPDATE apa_file SET (apa41,apa42,apa63,apaacti ) =
      #                    (g_apa.apa41,g_apa.apa42,g_apa.apa63,g_apa.apaacti) 
      UPDATE apa_file SET (apa41,apa42,apa63,apaacti,apa08,
                           apa31,apa32,apa31f,apa32f,apa57,apa57f,
                           apa33,apa33f,apa34,apa34f,apa37,apa37f) =  
                          (g_apa.apa41,g_apa.apa42,g_apa.apa63,g_apa.apaacti,g_apa.apa08,
                           g_apa.apa31,g_apa.apa32,g_apa.apa31f,g_apa.apa32f,g_apa.apa57,g_apa.apa57f,
                           g_apa.apa33,g_apa.apa33f,g_apa.apa34,g_apa.apa34f,g_apa.apa37,g_apa.apa37f)
      #CHI-A80008 mod --end--
       WHERE apa01 = g_apa.apa01
      #IF STATUS THEN   #MOD-730098
      IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
#        CALL cl_err('',STATUS,0)   #No.FUN-660122
         CALL cl_err3("upd","apa_file",g_apa.apa01,"",STATUS,"","",1)  #No.FUN-660122
         LET g_success='N'
      END IF

      IF SQLCA.sqlerrd[3] = 0 THEN
         CALL cl_err('','aap-161',0)
         LET g_errno = 'aap-161'  #FUN-C80078 add
         LET g_success='N'
      END IF
   END IF

   IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
      IF g_success='N' THEN
         ROLLBACK WORK
         LET g_apa.* = g_apa_t.*       #MOD-B40036
      ELSE
         COMMIT WORK
         CALL cl_flow_notify(g_apa.apa01,'V')
      END IF
  #FUN-C80078 add str---
   ELSE
      RETURN
   END IF
  #FUN-C80078 add end---

   IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
      DISPLAY BY NAME g_apa.apa41,g_apa.apa42,g_apa.apa63,g_apa.apaacti
                      ,g_apa.apa08,g_apa.apa31,g_apa.apa32,g_apa.apa31f,g_apa.apa32f,g_apa.apa57 #CHI-A80008 add
      CALL t110_b_fill(' 1=1') #CHI-A80008 add
   END IF  #FUN-C80078 add

END FUNCTION

FUNCTION t110_ins_apk()
 DEFINE l_azi04 LIKE azi_file.azi04
 DEFINE g_apk RECORD LIKE apk_file.*
 DEFINE h_apk RECORD LIKE apk_file.*     #原始發票之情況
 #DEFINE l_sql   LIKE type_file.chr1000  #MOD-590460  #No.FUN-690028 VARCHAR(500)   #MOD-720062
 DEFINE l_sql  STRING   #MOD-590460  #No.FUN-690028 VARCHAR(500)   #MOD-720062
 DEFINE g_t1    LIKE oay_file.oayslip   #FUN-990014 add
 
    INITIALIZE g_apk.* TO NULL
    #..讀取原始發票資料
    IF g_apb[l_ac].apb11 IS NULL OR g_apb[l_ac].apb11 = ' ' THEN
       SLEEP 0
    ELSE
#MOD-590460 只抓取發票檔的第一筆,避免有多筆相同發票號碼而導致新增發票錯誤.
#SELECT * INTO h_apk.* FROM apk_file
#WHERE apk03 = g_apb[l_ac].apb11
#AND (apk171 = '21' OR apk171 = '22' OR apk171 = '25' OR apk171='28')
 LET l_sql = " SELECT * FROM apk_file ",
 " WHERE apk03 = '",g_apb[l_ac].apb11,"'",
                    " AND (apk171 = '21' OR apk171 = '22' OR apk171 = '25' ",
                    " OR apk171='28')"
        PREPARE t110_ins_apk_p FROM l_sql
        DECLARE t110_ins_apk_c CURSOR FOR t110_ins_apk_p
        OPEN t110_ins_apk_c
        FETCH t110_ins_apk_c INTO h_apk.*
#END MOD-590460
       IF STATUS THEN
          RETURN TRUE
       END IF

       IF h_apk.apk171 = '21' OR  h_apk.apk171= '25' THEN
          LET g_apa.apa171 = '23'
       ELSE
          IF h_apk.apk171='28' THEN
             LET g_apa.apa171='29'
          ELSE
          LET g_apa.apa171 = '24'
          END IF
       END IF
    END IF

    LET g_apk.apk01=g_apa.apa01
    LET g_apk.apk02=g_apb[l_ac].apb02
    LET g_apk.apk03=g_apb[l_ac].apb11                      #發票號碼
    LET g_apk.apk04=g_apa.apa18                            #統一編號
    LET g_apk.apk05=h_apk.apk05                            #發票號碼
    LET g_apk.apk07=g_apb[l_ac].apb10 * g_apa.apa16 /100   #稅額
    LET g_apk.apk08=g_apb[l_ac].apb10                      #未稅金額
    LET g_apk.apk06=g_apk.apk07+g_apk.apk08
    #no.A010依本幣取位
    LET g_apk.apk06 = cl_digcut(g_apk.apk06,g_azi04)
    LET g_apk.apk07 = cl_digcut(g_apk.apk07,g_azi04)
    LET g_apk.apk08 = cl_digcut(g_apk.apk08,g_azi04)
    #no.5954 增加幣別等欄位
    LET g_apk.apk11 = g_apa.apa15
    LET g_apk.apk29 = g_apa.apa16
    LET g_apk.apk12 = g_apa.apa13
    LET g_apk.apk13 = g_apa.apa14
    LET g_apk.apk07f= g_apb[l_ac].apb24 * g_apk.apk29 / 100
    LET g_apk.apk08f= g_apb[l_ac].apb24
    LET g_apk.apk06f= g_apk.apk07f + g_apk.apk08f
    SELECT azi04 INTO l_azi04 FROM azi_file WHERE azi01 = g_apk.apk12
    LET g_apk.apk06f= cl_digcut(g_apk.apk06f,l_azi04)
    LET g_apk.apk07f= cl_digcut(g_apk.apk07f,l_azi04)
    LET g_apk.apk08f= cl_digcut(g_apk.apk08f,l_azi04)
    LET g_apk.apk09=' '
    LET g_apk.apk10=' '
    LET g_apk.apk17 =g_apa.apa17
    LET g_apk.apk171=g_apa.apa171
    LET g_apk.apk172=g_apa.apa172
    LET g_apk.apk173=0
    LET g_apk.apk174=0
   #LET g_apk.apk175=0      #MOD-A30142 mark
    LET g_apk.apk175=NULL   #MOD-A30142 add
    LET g_apk.apkacti='Y'
    LET g_apk.apkgrup=g_grup
    LET g_apk.apkuser=g_user
    LET g_apk.apkdate=g_today
   #FUN-990014---Begin
   ##FUN-970108---Begin
   #IF NOT cl_null(g_apa.apa77) THEN 
   #   LET g_apk.apk32 = g_apa.apa77
   #ELSE 
   #	 LET g_apk.apk32 = g_apz.apz63
   #END IF 	  
   ##FUN-970108---End
   IF NOT cl_null(g_apa.apa77) THEN 
      LET g_apk.apk32 = g_apa.apa77
   ELSE
      CALL s_get_doc_no(g_apk.apk01) RETURNING g_t1
      SELECT apyvcode INTO g_apk.apk32  FROM apy_file WHERE apyslip = g_t1   
       IF cl_null(g_apk.apk32) THEN 
          LET g_apk.apk32 = g_apz.apz63  
       END IF
   END IF
   #FUN-990014---End
    INSERT INTO apk_file VALUES (g_apk.*)
    IF STATUS THEN
       RETURN TRUE
    END IF

    RETURN FALSE

END FUNCTION

#-------------------------------------------------------------------------#
# 讀取驗收之請款單價 rvb10
#-------------------------------------------------------------------------#
FUNCTION t110_read_rvv_rvb10(f_apb21,f_apb22)
    DEFINE f_apb21        LIKE apb_file.apb21
    DEFINE f_apb22        LIKE apb_file.apb22
    DEFINE f_rvv   RECORD LIKE rvv_file.*
    DEFINE f_rvb   RECORD LIKE rvb_file.*

    SELECT * INTO f_rvv.* FROM rvv_file WHERE rvv01 = f_apb21
                           AND rvv02 = f_apb22
    IF STATUS THEN
       RETURN 0
    END IF

    IF f_rvv.rvv04 IS NULL OR f_rvv.rvv04 = ' ' THEN
       RETURN 0
    END IF
 
    SELECT * INTO f_rvb.* FROM rvb_file WHERE rvb01 = f_rvv.rvv04
                           AND rvb02 = f_rvv.rvv05

    IF STATUS THEN
       RETURN 0
    END IF

    IF f_rvb.rvb10 IS NULL THEN
       LET f_rvb.rvb10 = 0
    END IF

    RETURN f_rvb.rvb10

END FUNCTION

#檢查發票是否重覆
FUNCTION t110_duplicate(l_apk02,l_apk03,l_n)
    DEFINE l_apk03         LIKE apk_file.apk03,
           l_idx,l_n       LIKE type_file.num10,   #No.FUN-690028 INTEGER
           l_apk02         LIKE apk_file.apk02
    DEFINE l_gec08         LIKE gec_file.gec08     #MOD-AA0035
    DEFINE l_gec05         LIKE gec_file.gec05     #MOD-AA0035
    DEFINE l_idx2          LIKE type_file.num10    #MOD-AA0035 
    DEFINE l_year1,l_year2    LIKE  type_file.num5   #CHI-820005   Add

    LET g_errno = ''
    FOR l_idx=1 TO l_n
       #-MOD-AA0035-add-
        SELECT gec05,gec08 INTO l_gec05,l_gec08 FROM gec_file
         WHERE gec01 = g_apk[l_idx].apk11  AND gec011 = '1'
        IF status THEN LET l_gec05='' LET l_gec08='' END IF
        IF l_gec08 = 'XX' THEN CONTINUE FOR END IF
        IF l_gec08 = '22' THEN CONTINUE FOR END IF   
       #-MOD-B30622-mark-
       #IF l_gec05='2' OR l_gec05='3' THEN
       #   FOR l_idx2 = 3 TO 10
       #      IF cl_null(l_apk03[l_idx2,l_idx2]) THEN
       #         LET g_errno='aap-760'
       #         EXIT FOR
       #      END IF
       #   END FOR
       #END IF
       #-MOD-B30622-end-
       #-MOD-AA0035-end-
       IF g_apk[l_idx].apk03=l_apk03 THEN 
          LET g_errno='aap-034'
       END IF

       IF NOT cl_null(l_apk02) THEN
          IF g_apk_c[l_idx].apk02=l_apk02 AND g_apk_c[l_idx].apk03=l_apk03 THEN
             LET g_errno='aap-034'
          END IF
       END IF
    END FOR

    RETURN

END FUNCTION
 
FUNCTION t110_date()
    DEFINE l_date      LIKE type_file.num5    # No:FUN-690028 SMALLINT
    DEFINE l_flag      LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
    DEFINE l_paydate   LIKE type_file.dat     #No.FUN-690028 DATE
    DEFINE l_cnt       LIKE type_file.num5    #CHI-A50042 add
    DEFINE l_w         LIKE type_file.num5    #CHI-C10043 add
    DEFINE l_pma11     LIKE pma_file.pma11    #CHI-C10043 add
    DEFINE l_sme02     LIKE sme_file.sme02    #CHI-C10043 add
    DEFINE l_apa64     LIKE apa_file.apa64    #CHI-C10043 add

    IF s_aapshut(0) THEN
       RETURN
    END IF

    IF g_apa.apa01 IS NULL THEN
       CALL cl_err('',-400,0)
       RETURN
    END IF

    SELECT * INTO g_apa.* FROM apa_file WHERE apa01=g_apa.apa01

    IF g_apa.apaacti ='N' THEN
       CALL cl_err(g_apa.apa01,'9027',0)
       RETURN
    END IF

    IF g_apa.apa41='N' THEN
       CALL cl_err(g_apa.apa01,'aap-717',0)
       RETURN
    END IF
 
     #-----No:MOD-530307-----
    IF g_apa.apa41 = "Y" AND g_apa.apa55 = "2" THEN
       CALL cl_err(g_apa.apa01,'aap-997',0)
       RETURN
    END IF
     #-----No:MOD-530307 END-----
   
   #-MOD-AB0117-add-
    IF g_apa.apa00 = "13" AND (g_apa.apa34  - g_apa.apa35) = 0 THEN
       RETURN
    END IF
   #-MOD-AB0117-end-

    #CHI-A50042 add --start--
    LET l_cnt = 0
    SELECT COUNT(*) INTO l_cnt FROM apc_file WHERE apc01 = g_apa.apa01 
    IF l_cnt > 1 THEN
       LET g_modify_date = 'Y'
       CALL t110_account_period()
       LET g_modify_date = NULL
       RETURN  
    END IF
    #CHI-A50042 add --end--

    BEGIN WORK
    CALL t110_lock_cl()  #FUN-C80078 add
    OPEN t110_cl USING g_apa_rowid
    IF STATUS THEN
       CALL cl_err("OPEN t110_cl date:", STATUS, 1)
       CLOSE t110_cl
       ROLLBACK WORK
       RETURN
    END IF

    FETCH t110_cl INTO g_apa.*               # 對DB鎖定
    IF STATUS THEN
       CALL cl_err('Lock apa:',STATUS,0)
       ROLLBACK WORK
       RETURN
    END IF

    LET g_apa_t.*=g_apa.*
    LET g_apa_o.*=g_apa.*

    WHILE TRUE
       CALL cl_set_head_visible("","YES")     #No.FUN-6B0033

       INPUT BY NAME g_apa.apa11,g_apa.apa12,g_apa.apa24,g_apa.apa64
      # INPUT BY NAME g_apa.apa12,g_apa.apa24,g_apa.apa64,g_apa.apa11    #No:TQC-750041
              WITHOUT DEFAULTS

          AFTER FIELD apa11
             IF NOT cl_null(g_apa.apa11) THEN
                IF g_aptype[1,1] = '1' AND g_apa.apa11 IS NOT NULL THEN
                   SELECT pma11 INTO g_pma11 FROM pma_file WHERE pma01=g_apa.apa11
                   IF STATUS THEN
#                     CALL cl_err('sel pma:',STATUS,0)    #No.FUN-660122
                      CALL cl_err3("sel","pma_file",g_apa.apa01,"",STATUS,"","sel pma:",1)  #No.FUN-660122
                      NEXT FIELD apa11
                   END IF
                  #IF g_apa.apa00 != '11' THEN    #MOD-BA0132 mark
                   IF g_apa.apa00 = '11' THEN     #MOD-BA0132 add
                      IF g_pma11 MATCHES '[3-8]' THEN
                         CALL cl_err('pma11=3-8','aap-273',0) NEXT FIELD apa11
                      END IF
                   END IF
                   DISPLAY g_pma11 TO pma11
                   IF g_apa_o.apa11 IS NULL OR g_apa_o.apa11<>g_apa.apa11 THEN
                      #No.FUN-690080 --Begin
                      IF g_aptype = '13' OR g_aptype = '17' THEN
                         CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apa.apa11,'EMPL')
                             RETURNING l_paydate,g_apa.apa64,g_apa.apa24
                      ELSE
                         CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apa.apa11,
                                        g_apa.apa06)
                             RETURNING l_paydate,g_apa.apa64,g_apa.apa24
                      END IF
                      #No.FUN-690080 --End
                      IF NOT cl_null(g_errno) THEN
                         CALL cl_err(g_apa.apa11,g_errno,0)
                         LET g_apa.apa11 = g_apa_o.apa11
                         DISPLAY BY NAME g_apa.apa11
                      END IF
                      DISPLAY BY NAME g_apa.apa24
                      DISPLAY BY NAME g_apa.apa64
                      LET g_apa.apa12 = l_paydate
                      DISPLAY BY NAME g_apa.apa12
                      #CHI-AB0017 add --start--
                      IF g_apa.apa24 < 0 THEN
                         IF NOT cl_confirm('aap-142') THEN NEXT FIELD apa11 END IF
                      END IF
                      #CHI-AB0017 add --end--
#No.FUN-680027--begin
                      DELETE FROM apc_file WHERE apc01 =g_apa.apa01
                      CALL t110_ins_apc(g_apa.*)
#No.FUN-680027--end
                   END IF
                END IF
                LET g_apa_o.apa11 = g_apa.apa11
             END IF
 
          AFTER FIELD apa12
             IF NOT cl_null(g_apa.apa12) THEN
                IF g_apa_o.apa12 IS NULL OR g_apa_o.apa12<>g_apa.apa12 THEN  #CHI-B80054 add
                   #No.FUN-690080 --Begin
                   IF g_aptype = '13' OR g_aptype = '17' THEN
                     #CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apa.apa11,'EMPL')            #MOD-980148 mark
                      CALL s_paydate('a',g_apa.apa12,g_apa.apa09,g_apa.apa02,g_apa.apa11,'EMPL')   #MOD-980148 add
                          RETURNING l_paydate,g_apa.apa64,g_apa.apa24
                   ELSE
                     #CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apa.apa11,             #MOD-980148 mark
                      CALL s_paydate('a',g_apa.apa12,g_apa.apa09,g_apa.apa02,g_apa.apa11,    #MOD-980148 add
                                     g_apa.apa06)
                          RETURNING l_paydate,g_apa.apa64,g_apa.apa24
                   END IF
                   #No.FUN-690080 --End
                   DISPLAY BY NAME g_apa.apa24,g_apa.apa64
                END IF   #CHI-B80054 add
               #LET g_apa_o.apa12 = g_apa.apa12  #CHI-B80054 add  #MOD-C40158 mark
                #CHI-AB0017 add --start--
                IF g_apa.apa24 < 0 THEN
                   IF NOT cl_confirm('aap-142') THEN NEXT FIELD apa12 END IF
                END IF
                #CHI-AB0017 add --end--
#No.FUN-6800270--begin
                IF g_apa_o.apa12 IS NULL OR g_apa_o.apa12<>g_apa.apa12 THEN
                   CALL t110_upd_apc_date()   
                END IF
#No.FUN-6800270--end
                LET g_apa_o.apa12 = g_apa.apa12   #MOD-C40158
             END IF
#No.FUN-6800270--begin
      AFTER FIELD apa64
         IF g_apa.apa64 IS NOT NULL THEN
            IF g_apa_o.apa64 IS NULL OR g_apa_o.apa64<>g_apa.apa64 THEN
               CALL t110_upd_apc_date()   
            END IF
           #-----------------------CHI-C10043-----------------------------start
           #僅限於類別為轉帳(2)和電匯(C)時才需要檢核假日問題
            SELECT pma11 INTO l_pma11 FROM pma_file
             WHERE pma01 = g_apa.apa11
            IF l_pma11 = '2' OR l_pma11 = 'c' THEN
              #若為假日,找尋下一個工作日
               SELECT nph02 INTO g_buf1 FROM nph_file
                WHERE nph01 = g_apa.apa64
               IF STATUS = 0 THEN
                  SELECT MIN(sme01) INTO l_apa64 FROM sme_file
                   WHERE sme01 > g_apa.apa64 AND sme02 = 'Y'
                  IF STATUS = 100 THEN
                     CALL cl_err3("sel","sme_file","","","amr-533","","",1)
                  ELSE
                     CALL cl_err3("sel","sme_file","","","aap-803","","",1)
                     LET g_apa.apa64 = l_apa64
                  END IF
               END IF
               LET l_w = WEEKDAY(g_apa.apa64)
              #若為週日
               IF l_w = 0 THEN
                  SELECT sme02 INTO l_sme02 FROM sme_file
                   WHERE sme01 = g_apa.apa64
                  IF cl_null(l_sme02) THEN LET l_sme02 = 'N' END IF
                  IF l_sme02 = 'N' THEN
                     LET g_apa.apa64 = g_apa.apa64 + 1
                     CALL cl_err(g_apa.apa64,'aap-803',0)
                  ELSE
                     IF cl_confirm('aap-353') THEN
                        LET g_apa.apa64 = g_apa.apa64 + 1
                     END IF
                  END IF
                END IF
              #若為週六
               IF l_w = 6 THEN
                  LET l_sme02='N'
                  SELECT sme02 INTO l_sme02 FROM sme_file
                   WHERE sme01 = g_apa.apa64
                  IF cl_null(l_sme02) THEN LET l_sme02 = 'N' END IF
                  IF l_sme02 = 'N' THEN
                     LET g_apa.apa64 = g_apa.apa64 + 2
                     CALL cl_err(g_apa.apa64,'aap-803',0)
                  ELSE
                     IF cl_confirm('aap-353') THEN
                        LET g_apa.apa64 = g_apa.apa64 + 2
                     END IF
                  END IF
               END IF
            END IF
            DISPLAY BY NAME g_apa.apa64
           #-----------------------CHI-C10043-------------------------------end
         END IF
#No.FUN-6800270--end

          AFTER FIELD apa24
             IF g_aptype[1,1] = '1' AND g_apa.apa24 IS NOT NULL THEN
                IF g_apa_o.apa24 IS NULL OR g_apa_o.apa24<>g_apa.apa24 THEN
                   #CHI-AB0017 add --start--
                   IF g_apa.apa24 < 0 THEN
                      IF NOT cl_confirm('aap-142') THEN NEXT FIELD apa24 END IF
                   END IF
                   #CHI-AB0017 add --end--
                   CALL s_duedate(g_apa.apa06,g_apa.apa12,g_apa.apa24)
                        RETURNING g_apa.apa64
                   DISPLAY BY NAME g_apa.apa64
                   CALL t110_upd_apc_date()      #No.FUN-680027
                END IF
             END IF
             LET g_apa_o.apa24 = g_apa.apa24
 
        AFTER INPUT
           LET l_flag='N'
           IF INT_FLAG THEN
              LET INT_FLAG = 0
              LET g_apa.*=g_apa_t.*
              DISPLAY BY NAME g_apa.apa11,g_apa.apa12,g_apa.apa24,
                              g_apa.apa64,g_apa.apa24
              CALL cl_err('',9001,0)
              EXIT WHILE
           END IF

           IF cl_null(g_apa.apa11) THEN
              LET l_flag='Y'
              DISPLAY BY NAME g_apa.apa11
           END IF

           IF cl_null(g_apa.apa12) THEN
              LET l_flag='Y'
              DISPLAY BY NAME g_apa.apa12
           END IF

           IF cl_null(g_apa.apa64) THEN
              LET l_flag='Y'
              DISPLAY BY NAME g_apa.apa64
           END IF

           IF l_flag='Y' THEN
              CALL cl_err('','9033',0)
              NEXT FIELD apa11
           END IF

           UPDATE apa_file SET apa11=g_apa.apa11,
                               apa12=g_apa.apa12,
                               apa24=g_apa.apa24,
                               apa64=g_apa.apa64,
                               apamodu=g_user,
                               apadate=g_today
             WHERE apa01=g_apa.apa01

           #IF STATUS OR SQLCA.SQLCODE THEN   #MOD-730098
           IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
#             CALL cl_err('upd apa01',STATUS,1)   #No.FUN-660122
              CALL cl_err3("upd","apa_file",g_apa.apa01,"",STATUS,"","upd apa01",1)  #No.FUN-660122
              LET g_apa.*=g_apa_t.*
              DISPLAY BY NAME g_apa.apa12,g_apa.apa64
              ROLLBACK WORK
              RETURN
           ELSE
              LET g_apa_o.*=g_apa.*
              LET g_apa_t.*=g_apa.*
           END IF

        ON ACTION CONTROLP
           CASE
              WHEN INFIELD(apa11) # PAY TERM
#                CALL q_pma(0,0,g_apa.apa11) RETURNING g_apa.apa11
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_pma"
                 LET g_qryparam.default1 =g_apa.apa11
                 CALL cl_create_qry() RETURNING g_apa.apa11
#                 CALL FGL_DIALOG_SETBUFFER( g_apa.apa11 )
                 DISPLAY BY NAME g_apa.apa11
              OTHERWISE EXIT CASE
        END CASE

           ON IDLE g_idle_seconds
              CALL cl_on_idle()
              CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
 
        END INPUT

        EXIT WHILE
    END WHILE

    COMMIT WORK

END FUNCTION

FUNCTION t110_sum_apa()
    DEFINE l_apa31  LIKE apa_file.apa31,
           l_apa32  LIKE apa_file.apa32,
           l_apa31f LIKE apa_file.apa31f,
           l_apa32f LIKE apa_file.apa32f    #No.MOD-B80140 add
 
    LET g_cnt = 0

    SELECT COUNT(*) INTO g_cnt FROM apb_file
     WHERE apb01 = g_apa.apa01
   #IF g_cnt = 0 THEN                                              #MOD-A30248 mark
    IF g_cnt = 0 AND g_apz.apz61<>'1' AND g_apz.apz61<>'3' THEN   #MOD-A30248 add
       CALL t110_apa34f('0')    #TQC-750140
       RETURN
    END IF

    SELECT SUM(apb24),SUM(apb10) INTO l_apa31f,l_apa31 FROM apb_file
     WHERE apb01 = g_apa.apa01

    IF cl_null(l_apa31f) THEN
       LET l_apa31f = 0
    END IF

    IF cl_null(l_apa31) THEN
       LET l_apa31 = 0
    END IF

   #LET l_apa32 = g_apa.apa32f * g_apa.apa14      #MOD-6C0178
   #LET l_apa32 = cl_digcut(l_apa32 ,t_azi.azi04)        #No:MOD-510106   #MOD-6B0066
   
    LET g_apa.apa31f = l_apa31f
    LET g_apa.apa31  = l_apa31
   #LET g_apa.apa32  = l_apa32   #TQC-630285

    LET g_apa.apa32f = g_apa.apa31f * g_apa.apa16 / 100  #TQC-630285
    CALL t110_apa32f() RETURNING l_apa32f                   #No.MOD-B80140 add
    LET g_apa.apa32f = l_apa32f                             #No.MOD-B80140 add
    LET g_apa.apa32 = g_apa.apa31 * g_apa.apa16 / 100    #TQC-630285
    CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
    LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
    LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)   #MOD-6B0066
    LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)     #MOD-6B0066
    DISPLAY BY NAME g_apa.apa31,g_apa.apa32,g_apa.apa31f,g_apa.apa32f

    CALL t110_apa34f('0')    #TQC-750140

END FUNCTION

#CHI-A40005 add start---
FUNCTION t110_sum_apa32()
DEFINE l_tot2     LIKE apa_file.apa31,
       l_tot21    LIKE apa_file.apa31,
       l_tot2f    LIKE apa_file.apa31,
       l_tot21f   LIKE apa_file.apa31,
       l_apa32    LIKE apa_file.apa32,
       l_apa32f   LIKE apa_file.apa32f,
       l_apk12   LIKE apk_file.apk12
DEFINE l_pmb02    LIKE pmb_file.pmb02
DEFINE l_cnt      LIKE type_file.num5

  LET i = ARR_CURR()
 
  SELECT SUM(apk07),SUM(apk07f)
    INTO l_tot2,l_tot2f
    FROM apk_file
   WHERE apk01 = g_apa.apa01 AND apk171 NOT IN ('23','24')
     AND apk02 <> g_apk[i].apk02  
  
  IF cl_null(l_tot2)  THEN LET l_tot2 = 0 END IF
  IF cl_null(l_tot2f) THEN LET l_tot2f = 0 END IF

   IF g_apk[i].apk171 ='23' OR g_apk[i].apk171 ='24' THEN
      LET l_tot2 = l_tot2 + g_apk[i].apk07
      LET l_tot2f = l_tot2f + g_apk[i].apk07f
   END IF 

  SELECT SUM(apk07),SUM(apk07f)
    INTO l_tot21,l_tot21f
    FROM apk_file
   WHERE apk01 = g_apa.apa01 AND apk171 IN ('23','24','29')
     AND apk02 <> g_apk[i].apk02  

  IF cl_null(l_tot21) THEN LET l_tot21 = 0 END IF
  IF cl_null(l_tot21f) THEN LET l_tot21f = 0 END IF
 
   IF g_apk[i].apk171 ='23' OR g_apk[i].apk171 ='24' OR g_apk[i].apk171 ='29' THEN
      LET l_tot21 = l_tot21 + g_apk[i].apk07
      LET l_tot21f = l_tot21f + g_apk[i].apk07f
   END IF 

  IF g_aptype MATCHES '1*' THEN
     LET l_tot2 = l_tot2 - l_tot21
     LET l_tot2f= l_tot2f- l_tot21f
  ELSE
     LET l_tot2 = l_tot21
     LET l_tot2f= l_tot21f
  END IF
  
  LET l_apa32 = l_tot2
 
  #no.5954判斷單身是否皆為本國幣別
  DECLARE apk12_32_cs CURSOR FOR
   SELECT UNIQUE(apk12) FROM apk_file WHERE apk01 = g_apa.apa01

  FOREACH apk12_32_cs INTO l_apk12
      LET g_cnt = g_cnt + 1
  END FOREACH

  IF g_aza.aza17 = l_apk12 AND g_cnt = 1 THEN
     LET l_apa32f = l_tot2
  ELSE
     LET l_apa32f = cl_digcut(l_tot2f,t_azi04)
  END IF

  RETURN l_apa32,l_apa32f

END FUNCTION
#CHI-A40005 add end---
#No.TQC-AC0367  --Begin
FUNCTION t110_sum_apa32_1()
DEFINE l_tot2     LIKE apa_file.apa31,
       l_tot21    LIKE apa_file.apa31,
       l_tot2f    LIKE apa_file.apa31,
       l_tot21f   LIKE apa_file.apa31,
       l_apa32    LIKE apa_file.apa32,
       l_apa32f   LIKE apa_file.apa32f,
       l_apk12   LIKE apk_file.apk12
DEFINE l_cnt      LIKE type_file.num5


  SELECT SUM(apk07),SUM(apk07f)
    INTO l_tot2,l_tot2f
    FROM apk_file
   WHERE apk01 = g_apa.apa01 AND apk171 NOT IN ('23','24')

  IF cl_null(l_tot2)  THEN LET l_tot2 = 0 END IF
  IF cl_null(l_tot2f) THEN LET l_tot2f = 0 END IF

  
  SELECT SUM(apk07),SUM(apk07f)
    INTO l_tot21,l_tot21f
    FROM apk_file
   WHERE apk01 = g_apa.apa01 AND apk171 IN ('23','24','29')
  
  IF cl_null(l_tot21) THEN LET l_tot21 = 0 END IF
  IF cl_null(l_tot21f) THEN LET l_tot21f = 0 END IF

  
  IF g_aptype MATCHES '1*' THEN
     LET l_tot2 = l_tot2 - l_tot21
     LET l_tot2f= l_tot2f- l_tot21f
  ELSE
     LET l_tot2 = l_tot21
     LET l_tot2f= l_tot21f
  END IF

  LET l_apa32 = l_tot2

  #no.5954判斷單身是否皆為本國幣別
  DECLARE apk12_32_cs1 CURSOR FOR
   SELECT UNIQUE(apk12) FROM apk_file WHERE apk01 = g_apa.apa01

  FOREACH apk12_32_cs1 INTO l_apk12
      LET g_cnt = g_cnt + 1
  END FOREACH

  IF g_aza.aza17 = l_apk12 AND g_cnt = 1 THEN
     LET l_apa32f = l_tot2
  ELSE
     LET l_apa32f = cl_digcut(l_tot2f,t_azi04)
  END IF

  RETURN l_apa32,l_apa32f

END FUNCTION
#No.TQC-AC0367  --End

FUNCTION t110_ddd_c(p_seq)
   #DEFINE l_depno     VARCHAR(10),            #FUN-660117 remark
   DEFINE l_depno     LIKE apa_file.apa22,  #FUN-660117
          l_tot28,l_tot1,l_tot2,l_tot3    LIKE apa_file.apa31,
          l_tot1f,l_tot2f,l_tot3f LIKE apa_file.apa31f,    #No.MOD-580365
          l_azi            RECORD LIKE azi_file.*,         #No.MOD-580365
          l_apk08f_t       LIKE apk_file.apk08,            #No.MOD-580365
          l_apk08f_o       LIKE apk_file.apk08,            #No.MOD-580365
          apk08f_t         LIKE apk_file.apk08,            #No.MOD-580365
          i,j,k,u_sign     LIKE type_file.num5,      # No:FUN-690028 SMALLINT,
          l_n,l_nochk      LIKE type_file.num5,      # No:FUN-690028 SMALLINT,
          apk03_t     LIKE apk_file.apk03,
          l_tax            LIKE type_file.num20_6,   # No:FUN-690028 DEC(20,6),  #FUN-4B0079
          l_flag1,l_flag   LIKE type_file.chr1,    #No.FUN-690028 VARCHAR(1)
          l_chk            LIKE type_file.chr1,      # No:FUN-690028 VARCHAR(1),
          l_opensw         LIKE type_file.chr1,      # No:FUN-690028 VARCHAR(01),
          apk08_t       LIKE apk_file.apk08,
          l_gec05       LIKE gec_file.gec05,
          l_cnt         LIKE type_file.num5,    #No.FUN-690028 SMALLINT
          p_seq         LIKE type_file.num5,      # No:FUN-690028 SMALLINT,
          l_apk02       LIKE apk_file.apk02,
          l_apb10       LIKE apb_file.apb10,
          #l_sql         LIKE type_file.chr1000, #No.FUN-690028 VARCHAR(600)   #MOD-720062
          l_sql         STRING,   #MOD-720062
          l_azi04       LIKE azi_file.azi04,
          l_apk11       LIKE apk_file.apk11,
          l_apk12       LIKE apk_file.apk12,
          l_apk13       LIKE apk_file.apk13,
          l_apk06f      LIKE apk_file.apk06f,
          l_apk07f      LIKE apk_file.apk07f,
          l_apk08f      LIKE apk_file.apk08f,
          l_apk08_t     LIKE apk_file.apk08,       #No.MOD-530687
          l_apk08_o     LIKE apk_file.apk08,       #No.MOD-530687
          l_apk29       LIKE apk_file.apk29,  #CHI-B10017 add
          l_apk172      LIKE apk_file.apk172, #CHI-B10017 add
          apk11_t       LIKE apk_file.apk11,  #CHI-B10017 add
          l1_ac         LIKE type_file.num5,      # No:FUN-690028 SMALLINT,                  #No.MOD-540169
          g_rec_b1      LIKE type_file.num5,                    #No.MOD-540169   #為了不與單身g_rec_b衝突,新定義  #No.FUN-690028 SMALLINT
   l_allow_insert  LIKE type_file.num5,                #可新增否  #No.FUN-690028 SMALLINT
   l_allow_delete  LIKE type_file.num5                 #可刪除否  #No.FUN-690028 SMALLINT
DEFINE    p_cmd          LIKE type_file.chr1                 #CHI-940018 
DEFINE    l_lock_sw      LIKE type_file.chr1                 #CHI-940018
DEFINE g_t1              LIKE oay_file.oayslip  #FUN-990014 add

   IF g_aza.aza26 != '2' THEN
      RETURN
   END IF

#  IF g_aza.aza25 = 'N' AND g_apa.apa08 != 'MISC' THEN
   #IF g_aza.aza46 = 'N' AND g_apa.apa08 != 'MISC' THEN   #No.FUN-580006   #MOD-720064
   IF (g_aza.aza46 = 'N' AND g_apa.apa08 != 'MISC') OR g_apa.apa08='UNAP' THEN   #No.FUN-580006   #MOD-720064
      RETURN
   END IF

   IF g_apa.apa42='Y' THEN
      RETURN
   END IF

   LET g_apa_t.* = g_apa.*       #BACKUP  #MOD-B40036
  #-TQC-B10096-add-          
   IF g_apa.apa41 = 'Y' THEN                    #MOD-C20048 add
      BEGIN WORK
      CALL t110_lock_cl()  #FUN-C80078 add
      OPEN t110_cl USING g_apa_rowid
      IF STATUS THEN
         CALL cl_err("OPEN t110_cl b:", STATUS, 1)
         CLOSE t110_cl
         ROLLBACK WORK
         RETURN
      END IF
      FETCH t110_cl INTO g_apa_t.*    # 鎖住將被更改或取消的資料   
      IF SQLCA.sqlcode THEN
         CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
         CLOSE t110_cl
         ROLLBACK WORK
         RETURN
      END IF       
   END IF                                        #MOD-C20048 add
  #-TQC-B10096-end-          
   OPEN WINDOW t110_ddd_wc WITH FORM "aap/42f/aapt110_j"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
    CALL cl_ui_locale("aapt110_j")
 
   #No.MOD-580365  --begin
   SELECT * INTO l_azi.* FROM azi_file WHERE azi01=g_apa.apa13
  #CHI-B10017 mod --start--
  #LET l_sql = "SELECT apk02,apk28,apk03,apk04,apl02,apk05,apk29,apk08f,",  
  #            "       apk08,apk07f,apk07,apk06f,apk06,apk171,apk172,apk30,apk32",   #FUN-970108 add apk32 
   LET l_sql = "SELECT apk02,apk11,apk172,apk28,apk03,apk04,apl02,apk05,apk29,apk08f,",  
               "       apk08,apk07f,apk07,apk06f,apk06,apk171,apk30,apk32",  
  #CHI-B10017 mod --end--
               "  FROM apk_file,OUTER apl_file ",
               " WHERE apk01 = '",g_apa.apa01,"'",
               "   AND apk04 = apl_file.apl01 "
   #No.MOD-580365  --end

#  IF g_apa.apa08 = 'MISC' AND NOT cl_null(p_seq) THEN
    IF NOT cl_null(p_seq) THEN    #No.MOD-540169
      LET l_sql = l_sql CLIPPED," AND apk02 = ",p_seq
   END IF

   LET l_sql = l_sql CLIPPED," ORDER BY apk02,apk03 "

   PREPARE t110_ddd_p2 FROM l_sql
   IF STATUS THEN
      CALL cl_err('t110_ddd_p2',STATUS,1)
      CLOSE WINDOW t110_ddd_wc
      RETURN
   END IF

   DECLARE t110_ddd_c2 CURSOR FOR t110_ddd_p2
 
#  CALL g_apk.clear()    #MOD-5B0340
   CALL g_apk_c.clear()  #MOD-5B0340
   LET k = 1
   LET l_tot1 = 0
   LET l_tot2 = 0
   LET l_tot3 = 0
   #No.MOD-580365  --begin
   LET l_tot1f = 0
   LET l_tot2f = 0
   LET l_tot3f = 0
   #No.MOD-580365  --end
   LET i=1
   LET l_opensw = 'N'

   FOREACH t110_ddd_c2 INTO g_apk_c[k].*
      IF g_apk_c[k].apk171='23' THEN
         LET u_sign = -1
      ELSE
         LET u_sign = 1
      END IF

      #紅字發票(折讓)以負值顯示
      LET g_apk_c[k].apk08 = g_apk_c[k].apk08 * u_sign
      LET g_apk_c[k].apk07 = g_apk_c[k].apk07 * u_sign
      LET g_apk_c[k].apk06 = g_apk_c[k].apk06 * u_sign
      LET l_tot1 = l_tot1 + g_apk_c[k].apk08
      LET l_tot2 = l_tot2 + g_apk_c[k].apk07
      LET l_tot3 = l_tot3 + g_apk_c[k].apk06
      #No.MOD-580365  --begin
      LET g_apk_c[k].apk08f= g_apk_c[k].apk08f* u_sign
      LET g_apk_c[k].apk07f= g_apk_c[k].apk07f* u_sign
      LET g_apk_c[k].apk06f= g_apk_c[k].apk06f* u_sign
      LET l_tot1f= l_tot1f+ g_apk_c[k].apk08f
      LET l_tot2f= l_tot2f+ g_apk_c[k].apk07f
      LET l_tot3f= l_tot3f+ g_apk_c[k].apk06f
      #No.MOD-580365  --end
      LET k = k + 1
     #IF k > 300 THEN          #MOD-A80051 mark
      IF k > g_max_rec THEN    #MOD-A80051
         EXIT FOREACH
      END IF
   END FOREACH

   CALL g_apk_c.deleteElement(k)
   #LET g_rec_b = k - 1   #MOD-730092
   LET g_rec_b1 = k - 1   #MOD-730092
   DISPLAY BY NAME l_tot1,l_tot2,l_tot3
   DISPLAY BY NAME l_tot1f,l_tot2f,l_tot3f  #MOD-580365

   IF g_apa.apa41 = 'Y' THEN
      CALL cl_set_act_visible("accept,cancel", FALSE)

     #DISPLAY ARRAY g_apk_c TO s_apk.*  ATTRIBUTE(COUNT=g_rec_b)      #MOD-730092
      DISPLAY ARRAY g_apk_c TO s_apk.*  ATTRIBUTE(COUNT=g_rec_b1)      #MOD-730092
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE DISPLAY
         ON ACTION about         #MOD-4C0121
            CALL cl_about()      #MOD-4C0121
         ON ACTION help          #MOD-4C0121
            CALL cl_show_help()  #MOD-4C0121
         ON ACTION controlg      #MOD-4C0121
            CALL cl_cmdask()     #MOD-4C0121
         ON ACTION controls                       #No.FUN-6B0033                                                                       
            CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
      END DISPLAY
      IF INT_FLAG THEN   #MOD-6B0035
         LET INT_FLAG = 0   #MOD-6B0035
         CLOSE WINDOW t110_ddd_wc
         RETURN
      END IF   #MOD-6B0035
   ELSE
#CHI-940018 --add begin--                          
     #CHI-B10017 mod --start--
     #LET g_forupd_sql = "SELECT apk02,apk28,apk03,apk04,'',apk05,apk29,apk08f,",        #MOD-9A0155 apl02 modify '' 
     #                   "       apk08,apk07f,apk07,apk06f,apk06,apk171,apk172,apk30,apk32",   #FUN-970108 add apk32
      LET g_forupd_sql = "SELECT apk02,apk11,apk172,apk28,apk03,apk04,'',apk05,apk29,apk08f,",     
                         "       apk08,apk07f,apk07,apk06f,apk06,apk171,apk30,apk32", 
     #CHI-B10017 mod --end--
                         "  FROM apk_file ",                     #MOD-9A0155 add
                        #"  FROM apk_file,apl_file ",            #MOD-9A0155 mark
                         " WHERE apk01 = '",g_apa.apa01,"'",
                        #"   AND apk04 = apl_file.apl01 ",                #MOD-9A0155 mark
#                        "   AND apk02 = ? AND apk03 = ? ORDER BY apk02,apk03 FOR UPDATE NOWAIT"          #MOD-970145
                         "   AND apk02 = ? AND apk03 = ? FOR UPDATE NOWAIT"            #MOD-970145  
      DECLARE ddd_c_bcl CURSOR FROM g_forupd_sql      # LOCK CURSOR          
#CHI-940018 --add end--   	
      LET l_allow_insert = cl_detail_input_auth("insert")
      LET l_allow_delete = cl_detail_input_auth("delete")
 
      INPUT ARRAY g_apk_c WITHOUT DEFAULTS FROM s_apk.*
            #ATTRIBUTE(COUNT=g_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,   #MOD-730092
            ATTRIBUTE(COUNT=g_rec_b1,MAXCOUNT=g_max_rec,UNBUFFERED,   #MOD-730092
                      INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)

      BEFORE INPUT
#CHI-940018 --BEGIN--      
#        #No.MOD-540169 --start--
#        LET l_ac = ARR_CURR()     #FUN-580012
#        LET l1_ac = l_ac
#        IF g_apb[l1_ac].apb02 > g_apk_c[l_ac].apk02 THEN
#           LET l_ac = l_ac + 1
#        END IF
#CHI-940018 --END         
         IF NOT cl_null(p_seq) THEN
            LET i = 1                         #CHI-940018 l_ac->i
         END IF
         IF g_rec_b1 != 0 THEN                #CHI-940018
            CALL fgl_set_arr_curr(i)          #CHI-940018 l_ac->i
         END IF                               #CHI-940018
#        LET l_ac = l1_ac                    #CHI-940018
         #No.MOD-540169 --end--
#CHI-940018  --BEGIN--    
#        LET g_before_input_done = FALSE
#        CALL t110_set_entry_apk()
#        CALL t110_set_no_entry_apk()
#        LET g_before_input_done = TRUE
#CHI-940018  --END--  

      BEFORE ROW
         LET i = ARR_CURR()
         LET j = SCR_LINE()
#CHI-940018  --add begin-- 
         LET p_cmd = ''
         LET l_opensw = 'N'
         LET g_success = 'Y'        
         BEGIN WORK 
         INITIALIZE g_apk_c_t.* TO NULL
        #-TQC-B10096-mark-          
        #OPEN t110_cl USING g_apa_rowid
        #IF STATUS THEN
        #   CALL cl_err("OPEN t110_cl b:", STATUS, 1)
        #   CLOSE t110_cl
        #   ROLLBACK WORK
        #   CLOSE WINDOW t110_ddd_wc
        #   RETURN
        #END IF
        #FETCH t110_cl INTO g_apa_t.*    # 鎖住將被更改或取消的資料   #MOD-9A0070 mod
        #IF SQLCA.sqlcode THEN
        #   CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
        #   CLOSE t110_cl
        #   ROLLBACK WORK
        #   CLOSE WINDOW t110_ddd_wc
        #   RETURN
        #END IF       
        #-TQC-B10096-end-          
#CHI-940018  --add end--        
         
         LET apk11_t = g_apk_c[i].apk11 #CHI-B10017 add
        #IF g_rec_b != 0 THEN   #No.MOD-490459   #MOD-730092
         IF g_rec_b1 != 0 THEN   #No.MOD-490459   #MOD-730092
            LET apk03_t = g_apk_c[i].apk03
         ELSE
            LET apk03_t = ''  #No.MOD-490459
         END IF
         #No.TQC-A30079  --Begin
         ##str MOD-9B0200 add
         # IF g_apk[i].apk02 IS NULL THEN
         #    CALL cl_show_fld_cont()
         #    NEXT FIELD apk02
         # END IF
         ##end MOD-9B0200 add
         #No.TQC-A30079  --End  
#CHI-940018  --add begin--  
         IF g_rec_b1 >= i THEN
            LET p_cmd='u'
            LET g_apk_c_t.* = g_apk_c[i].*  #BACKUP
            IF NOT cl_null(p_seq) THEN 
               OPEN ddd_c_bcl USING p_seq,g_apk_c_t.apk03
            ELSE
               OPEN ddd_c_bcl USING g_apk_c_t.apk02,g_apk_c_t.apk03
            END IF  	   
            IF STATUS THEN
               CALL cl_err("OPEN ddd_c_bcl:", STATUS, 1)
               LET l_opensw = "Y"
            END IF
            FETCH ddd_c_bcl INTO g_apk_c[i].*
            IF SQLCA.sqlcode THEN
               CALL cl_err(g_apk_c_t.apk02,SQLCA.sqlcode,1)
               LET l_opensw = "Y"
            END IF
            #MOD-9A0155---add---start---
            SELECT apl02 INTO g_apk_c[i].apl02
              FROM apl_file
             WHERE apl01 = g_apk_c[i].apk04
            #MOD-9A0155---add---end---
            LET g_before_input_done = FALSE
            CALL t110_set_entry_apk_120(p_cmd)
            CALL t110_set_no_entry_apk_120(p_cmd)
            LET g_before_input_done = TRUE
         END IF
#CHI-940018  --add end--                         
         CALL cl_show_fld_cont()     #FUN-550037(smin)
         CALL t110_set_no_apk_required()  #FUN-970108 
         CALL t110_set_apk_required()     #FUN-970108
         
#CHI-940018  --add begin-- 
      BEFORE INSERT
         LET p_cmd='a'
         INITIALIZE g_apk_c[i].* TO NULL          
         LET g_apk_c_t.* = g_apk_c[i].*         #新輸入資料
         LET apk11_t = '' #CHI-B10017 add
         LET g_before_input_done = FALSE
         CALL t110_set_entry_apk_120(p_cmd)
         CALL t110_set_no_entry_apk_120(p_cmd)
         LET g_before_input_done = TRUE
         CALL cl_show_fld_cont()     
         NEXT FIELD apk02
           
      AFTER INSERT
        #MOD-A30140---add---start---
         IF g_apk_c[i].apk07=0 AND g_apk_c[i].apk08=0 THEN
            CANCEL INSERT
         END IF
         IF cl_null(g_apk_c[i].apk28) AND g_aza.aza46 = 'Y'
            AND NOT cl_null(g_apk_c[i].apk07) AND NOT cl_null(g_apk_c[i].apk08) 
            AND NOT INT_FLAG THEN
            CALL cl_err('','gap-142',0)
            NEXT FIELD apk28
         END IF
         LET l_tot1 = l_tot1 + g_apk_c[i].apk08           #未稅
         LET l_tot2 = l_tot2 + g_apk_c[i].apk07           #稅
         LET l_tot3 = l_tot3 + g_apk_c[i].apk06           #含稅
         LET l_tot1f= l_tot1f+ g_apk_c[i].apk08f  
         LET l_tot2f= l_tot2f+ g_apk_c[i].apk07f  
         LET l_tot3f= l_tot3f+ g_apk_c[i].apk06f  
         DISPLAY BY NAME l_tot1,l_tot2,l_tot3
         DISPLAY BY NAME l_tot1f,l_tot2f,l_tot3f     
        #MOD-A30140---add---end---
         IF INT_FLAG THEN
           CALL cl_err('',9001,0)
           LET INT_FLAG = 0
           CANCEL INSERT
         END IF
         IF g_apk_c[i].apk06 IS NULL OR g_apk_c[i].apk06 = 0 THEN
            NEXT FIELD apk02 
            CANCEL INSERT 
         END IF    
         IF g_apk_c[i].apk06 < 0 THEN  #以負值顯示, 正值存放
            LET g_apk_c[i].apk08 = g_apk_c[i].apk08 * -1
            LET g_apk_c[i].apk07 = g_apk_c[i].apk07 * -1
            LET g_apk_c[i].apk06 = g_apk_c[i].apk06 * -1
         END IF
         #幣別、稅別等欄位
         LET l_apk11 = g_apa.apa15
         LET l_apk12 = g_apa.apa13
         LET l_apk13 = g_apa.apa14
        #str MOD-9B0202 mark
        #LET l_apk06f= g_apk_c[i].apk06 / l_apk13
        #LET l_apk07f= g_apk_c[i].apk07 / l_apk13
        #LET l_apk08f= g_apk_c[i].apk08 / l_apk13
        #SELECT azi04 INTO l_azi04 FROM azi_file WHERE azi01 = l_apk12   
        #LET l_apk06f= cl_digcut(l_apk06f,l_azi04)
        #LET l_apk07f= cl_digcut(l_apk07f,l_azi04)
        #LET l_apk08f= cl_digcut(l_apk08f,l_azi04)
        #end MOD-9B0202 mark
         LET g_apk_c[i].apk06 = cl_digcut(g_apk_c[i].apk06 ,g_azi04)
         LET g_apk_c[i].apk07 = cl_digcut(g_apk_c[i].apk07 ,g_azi04)
         LET g_apk_c[i].apk08 = cl_digcut(g_apk_c[i].apk08 ,g_azi04)
         #FUN-990014--Begin
         #No.TQC-A30070  --Begin
         #IF NOT cl_null(g_apa.apa77) THEN
         #   LET g_apk_c[i].apk32 = g_apa.apa77
         #ELSE
         #   CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1
         #   SELECT apyvcode INTO g_apk_c[i].apk32  FROM apy_file WHERE apyslip = g_t1   
         #   IF cl_null(g_apk_c[i].apk32) THEN 
         #      LET g_apk_c[i].apk32 = g_apz.apz63  #FUN-970108 add
         #   END IF     
         #END IF
         #No.TQC-A30070  --End  
         #FUN-990014---End
         INSERT INTO apk_file(apk01,apk02,apk03,apk04,apk05, 
                              apk06,apk07,apk08,apk171,apk172,
                              apk173,apk174,apk22,apk25,apk28,
                              apk29,apk30,apk11,apk12,apk13,
                              apk06f,apk07f,apk08f,apk32,   #FUN-970108 add apk32
                              apkacti,apkgrup,apkuser,apkdate)   
         VALUES(g_apa.apa01,g_apk_c[i].apk02,g_apk_c[i].apk03, 
                g_apk_c[i].apk04,g_apk_c[i].apk05,
                g_apk_c[i].apk06,g_apk_c[i].apk07,
                g_apk_c[i].apk08,g_apk_c[i].apk171,
                g_apk_c[i].apk172,g_apa.apa173,g_apa.apa174,
                g_apa.apa22,g_apa.apa25,g_apk_c[i].apk28,
                g_apk_c[i].apk29,g_apk_c[i].apk30,
               #l_apk11,l_apk12,l_apk13,          #CHI-B10017 mark
                g_apk_c[i].apk11,l_apk12,l_apk13, #CHI-B10017
               #l_apk06f,l_apk07f,l_apk08f,                             #MOD-9B0202 mark
                g_apk_c[i].apk06f,g_apk_c[i].apk07f,g_apk_c[i].apk08f,  #MOD-9B0202
                g_apk_c[i].apk32,'Y',g_grup,g_user,g_today)       #FUN-970108 add apk32              
         IF SQLCA.sqlcode THEN
            CALL cl_err3("ins","apk_file",g_apa.apa01,g_apk_c[i].apk03,SQLCA.sqlcode,"","",1)  
            CANCEL INSERT
         ELSE
            MESSAGE 'INSERT O.K'            
            LET g_rec_b1=g_rec_b1+1
            IF g_success='Y' THEN
               COMMIT WORK
            ELSE
               ROLLBACK WORK
               LET g_apa.* = g_apa_t.*       #MOD-B40036
            END IF
         END IF
#CHI-940018  --add end--          

      BEFORE FIELD apk02
         IF p_cmd = 'a' OR g_apk_c[i].apk02 IS NULL THEN    #CHI-940018      
            IF g_apk_c[i].apk06 IS NULL THEN
               INITIALIZE g_apk_c[i].* TO NULL
               IF i = 1 THEN
                  LET g_apk_c[i].apk04 = g_apa.apa18
                  #FUN-990014--Begin
                  IF NOT cl_null(g_apa.apa77) THEN
                     LET g_apk_c[i].apk32 = g_apa.apa77
                  ELSE
                     CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1
                     SELECT apyvcode INTO g_apk_c[i].apk32  FROM apy_file WHERE apyslip = g_t1   
                     IF cl_null(g_apk_c[i].apk32) THEN 
                        LET g_apk_c[i].apk32 = g_apz.apz63  #FUN-970108 add
                     END IF     
                  END IF
               #FUN-990014---End
               END IF
               IF i > 1 THEN
                  LET g_apk_c[i].apk04 = g_apk_c[i-1].apk04
                  LET g_apk_c[i].apk05 = g_apk_c[i-1].apk05
                  LET g_apk_c[i].apk171= g_apk_c[i-1].apk171
                  LET g_apk_c[i].apk172= g_apk_c[i-1].apk172
                  LET g_apk_c[i].apk28 = g_apk_c[i-1].apk28
                  LET g_apk_c[i].apk32 = g_apk_c[i-1].apk32      #FUN-970108 add
               END IF
               LET g_apk_c[i].apk06 = 0
               LET g_apk_c[i].apk07 = 0
               LET g_apk_c[i].apk08 = 0
               #No.MOD-580365  --begin
               LET g_apk_c[i].apk06f= 0
               LET g_apk_c[i].apk07f= 0
               LET g_apk_c[i].apk08f= 0
               #No.MOD-580365  --end
               IF g_aptype MATCHES '1*' THEN
                  LET g_apk_c[i].apk171 = '21'
               ELSE
                  LET g_apk_c[i].apk171 = '23'
               END IF
               LET g_apk_c[i].apk29 = g_apa.apa16
               LET g_apk_c[i].apk30 = 0
               SELECT gec05 INTO g_apk_c[i].apk172 FROM gec_file
                WHERE gec01 = g_apa.apa15
               IF g_apa.apa08 != 'MISC' THEN
                  LET g_apk_c[i].apk03 = g_apa.apa08
               END IF
#              IF g_aza.aza25 = 'N' THEN
               IF g_aza.aza46 = 'N' THEN   #No.FUN-580006
                  SELECT MAX(apk02) INTO l_apk02 FROM apk_file
                   WHERE apk01 = g_apa.apa01
                  IF cl_null(l_apk02) THEN
                     LET l_apk02 = 0
                  END IF
                  LET g_apk_c[i].apk02 = l_apk02 + 1
               END IF
            END IF
#           IF g_aza.aza25 = 'N' THEN
           #IF g_aza.aza46 = 'N' THEN   #No.FUN-580006  #No.TQC-720045 mark
            IF g_aza.aza46 = 'Y' THEN   #No.TQC-720045
#              IF g_apa.apa08 = 'MISC' AND NOT cl_null(p_seq) THEN
               IF NOT cl_null(p_seq) THEN      #No.MOD-540169
                  LET g_apk_c[i].apk02 = p_seq
               END IF
            END IF
         END IF        #CHI-940018 
       
#CHI-940018 --add begin--
      AFTER FIELD apk02
         IF cl_null(g_apk_c[i].apk02) THEN 
            CALL cl_err('','aqc-052',0)          
            NEXT FIELD apk02
       #MOD-B30214--add--str--
        #MOD-BB0121------------------------------------------mark
        #ELSE
        #  IF g_apk_c[i].apk171 = 'XX' THEN
        #     CALL cl_set_comp_required("apk04",FALSE)
        #  ELSE
        #     CALL cl_set_comp_required("apk04",TRUE)
        #  END IF
        #MOD-BB0121------------------------------------------mark
       #MOD-B30214--add--end--
         END IF 
#CHI-940018 --add end--

      #CHI-B10017 add --start--
      AFTER FIELD apk11
         IF NOT cl_null(g_apk_c[i].apk11) THEN
            IF cl_null(apk11_t) OR g_apk_c[i].apk11 != apk11_t THEN
               SELECT gec04,gec05,gec08                                    #MOD-BB0121 add gec08
                #INTO l_apk29,g_apk_c[i].apk172                            #MOD-B10104 mark
                 INTO g_apk_c[i].apk29,g_apk_c[i].apk172,g_apk_c[i].apk171 #MOD-B10104 #MOD-BB0121 add apk171
                 FROM gec_file
                WHERE gec01 = g_apk_c[i].apk11 AND gec011='1'  #進項
                  AND gecacti = 'Y'
               IF STATUS THEN
                  CALL cl_err3("sel","gec_file", g_apk_c[i].apk11,"","mfg3044","","",1)  
                  NEXT FIELD apk11
               END IF
               DISPLAY g_apk_c[i].apk172 TO apk172 
               DISPLAY g_apk_c[i].apk29 TO apk29           #MOD-B10104   
            END IF
         END IF
        #--------------------MOD-BB0121-------------mark
        ##MOD-B30214--add--str--
        #IF g_apk[i].apk171 <> 'XX' THEN        
        #   LET g_apk[i].apk17 = '1'           
        #END IF
        ##MOD-B30214--add--end--
        #--------------------MOD-BB0121-------------mark
      #CHI-B10017 add --end--
       
      BEFORE FIELD apk28
#        IF g_aza.aza25 = 'N' THEN
        #IF g_aza.aza46 = 'N' THEN   #No.FUN-580006  #No.TQC-720045 mark
         IF g_aza.aza46 = 'Y' THEN   #No.TQC-720045
            IF cl_null(g_apk_c[i].apk02) THEN NEXT FIELD apk02 END IF
            SELECT COUNT(*) INTO l_cnt FROM apb_file
             WHERE apb01 = g_apa.apa01 AND apb02 = g_apk_c[i].apk02
            IF l_cnt = 0 THEN
               CALL cl_err(g_apk_c[i].apk02,'axm-141',0)
               NEXT FIELD apk02
            END IF
         END IF

      AFTER FIELD apk28
         IF cl_null(g_apk_c[i].apk28) AND g_apk_c[i].apk172 MATCHES '[SN]' THEN
            CALL cl_err('','tis-001',0)
            NEXT FIELD apk28
         END IF
         #No.FUN-580006 --start--
         IF cl_null(g_apk_c[i].apk28) AND g_aza.aza46 = 'Y' THEN
            CALL cl_err('','gap-142',0)
            NEXT FIELD apk28
         END IF
         #No.FUN-580006 --end--

      AFTER FIELD apk03
         IF NOT cl_null(g_apk_c[i].apk03) THEN
            IF g_apk_c[i].apk03 IS NOT NULL AND
               (apk03_t IS NULL OR g_apk_c[i].apk03 != apk03_t) THEN
               LET g_errno = ''
              #str MOD-9B0190 add
               IF g_apa.apa00='11' OR g_apa.apa00='12' OR 
                  g_apa.apa00='13' OR g_apa.apa00='15' THEN
                  #CALL t110_invoice_chk(g_apk_c[i].apk03,g_apa.apa15)
                 #CALL t110_invoice_chk(g_apk_c[i].apk03,g_apa.apa15,g_apk_c[i].apk05)   #CHI-820005   #No.TQC-CB0066   Mark
                  CALL t110_invoice_chk(g_apk_c[i].apk03,g_apa.apa15,g_apk_c[i].apk05,g_apk_c[i].apk28)#No.TQC-CB0066   Add
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err(g_apk_c[i].apk03,g_errno,0)
                     NEXT FIELD apk03
                  END IF
               END IF
              #end MOD-9B0190 add
               IF i > 1 THEN
                  CALL t110_duplicate(g_apk_c[i].apk02,g_apk_c[i].apk03,i-1)
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('duplicate:',g_errno,0)
                  NEXT FIELD apk03
               END IF
            END IF
       #MOD-A30140---mark---start---
       ##CHI-940018 --BEGIN--
       # ELSE
       #    CALL cl_err('','aqc-052',0)
       #    NEXT FIELD apk03
       ##CHI-940018 --END--         
       #MOD-A30140---mark---end---          
        #str MOD-B30691 add
         ELSE
           #當發票聯數(gec05)不為4或X時,aapt120的發票欄位(apk03)為必輸
            IF g_aptype ='12' OR g_aptype ='13' OR g_aptype ='15' THEN   #MOD-B30179 add 15 #MOD-B40108 add 13
               LET l_gec05 = ''
               SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01=g_apk_c[i].apk11
               IF l_gec05 NOT MATCHES '[4X]' AND cl_null(g_apk_c[i].apk03) THEN
                  CALL cl_err('apk03 is null: ','aap-099',0)
                  NEXT FIELD apk03
               ELSE
                  IF cl_null(g_apk_c[i].apk03) THEN   #MOD-B10070  
                     LET g_apk_c[i].apk03 = ' '     
                  END IF                            #MOD-B10070
               END IF
            END IF
        #end MOD-B30691 add
         END IF

      AFTER FIELD apk04
         #-----TQC-630164---------
         IF NOT cl_null(g_apk_c[i].apk04) THEN
            IF (g_apz.apz14 = 'Y' OR g_aza.aza21 = 'Y') AND   #FUN-990053 mod #TQC-9A0017 add (  #TQC-9A0119 mod ()
               NOT s_chkban(g_apk_c[i].apk04) THEN #MOD-9A0145 g_apk[i].apk04-->l_apa.apa18  #TQC-9A0119 mod
               CALL cl_err('','aoo-080',0) NEXT FIELD apk04
            END IF
            IF g_apa.apa06='MISC' THEN
               CALL t110_input_apl(g_apk_c[i].apk04)
               LET g_apk_c[i].apl02 = g_apa.apa07
               DISPLAY BY NAME g_apk_c[i].apl02
            END IF
        #-------------------------------------MOD-BB0121-----------------------------------mark
        #ELSE
        #   LET l_gec05 = ''                                                #MOD-B50183 
        #   SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01=g_apa.apa15 #MOD-B50183
        #  #str MOD-B30214 add
        #  #IF g_apk[i].apk171!='XX' THEN   #MOD-B50183 mark
        #  #IF g_apk[i].apk171!='XX' AND g_apk[i].apk171!='28' AND g_apk[i].apk171!='29'       #MOD-B50183 #MOD-BB0121 mark
        #   IF g_apk_c[i].apk171!='XX' AND g_apk_c[i].apk171!='28' AND g_apk_c[i].apk171!='29' #MOD-BB0121 add
        #      AND l_gec05 NOT MATCHES '[4X]' THEN                                             #MOD-B50183
        #      CALL cl_err('apk04 is null: ','aap-099',0)
        #      NEXT FIELD apk04
        #   END IF
        #  #end MOD-B30214 add
        #  #IF g_apa.apa06='MISC' THEN      #MOD-870232 mark
        #  #IF g_apk[i].apk171!='XX' THEN   #MOD-870232            #MOD-880044 mark
        #  #IF g_apa.apa06='MISC' AND g_apk[i].apk171!='XX' THEN   #MOD-880044                           #MOD-880173 mark
        #  #IF g_apa.apa06='MISC' AND g_apk[i].apk171!='XX' AND g_apk[i].apk171!='28' THEN   #MOD-880044 #MOD-880173  #MOD-B50183 mark
        #  #IF g_apa.apa06='MISC' AND g_apk[i].apk171!='XX' AND g_apk[i].apk171!='28'        #MOD-B50183 #MOD-BB0121 mark  
        #   IF g_apa.apa06='MISC' AND g_apk_c[i].apk171!='XX' AND g_apk_c[i].apk171!='28'    #MOD-BB0121 
        #     #AND g_apk[i].apk171!='29' AND l_gec05 NOT MATCHES '[4X]' THEN                 #MOD-B50183 #MOD-BB0121 mark
        #      AND g_apk_c[i].apk171!='29' AND l_gec05 NOT MATCHES '[4X]' THEN               #MOD-BB0121 add
        #      NEXT FIELD apk04
        #   END IF
        #-------------------------------------MOD-BB0121-----------------------------------mark
         END IF

         #LET g_apk_c[i].apl02 = NULL
         #IF g_apa.apa08 ='MISC' OR g_apa.apa05 ='EMPL' THEN
         #   DECLARE a_curs2 CURSOR FOR
         #    SELECT pmc03 FROM pmc_file
         #     WHERE pmc24 = g_apk_c[i].apk04 and pmcacti='Y'
         #
         #   OPEN a_curs2
         #
         #   FETCH a_curs2 INTO g_apk_c[i].apl02
         #
         #   CLOSE a_curs2
         #
         #   IF g_apk_c[i].apl02 IS NULL THEN
         #      SELECT apl02 INTO g_apk_c[i].apl02 FROM apl_file
         #      WHERE apl01 = g_apk_c[i].apk04
         #   END IF
         #
         #   IF g_apk_c[i].apl02 IS NULL THEN
         #      CALL t110_input_apl(g_apk_c[i].apk04)
         #      SELECT apl02 INTO g_apk_c[i].apl02 FROM apl_file
         #       WHERE apl01 = g_apk_c[i].apk04
         #   END IF
         #ELSE
         #   LET g_apk_c[i].apl02=g_apa.apa07
         #END IF
         #-----END TQC-630164-----

 #NO.MOD-530687--begin
#     AFTER FIELD apk29
#        IF NOT cl_null(g_apk_c[i].apk29) THEN
#           IF g_apk_c[i].apk29 > 0 THEN
#              LET g_apk_c[i].apk172 = 'S'
#           END IF
#        END IF
#end

      BEFORE FIELD apk08
         LET apk08_t = g_apk_c[i].apk08
 #NO.MOD-530687--begin
         IF g_apk_c[i].apk172 = 'T' THEN
            CALL cl_err('','aoo-009',0)
         END IF
         LET l_apk08_o = g_apk_c[i].apk08
#end

      AFTER FIELD apk08
         IF NOT cl_null(g_apk_c[i].apk08) THEN
            IF g_apk_c[i].apk08 = 0 THEN
                CALL cl_err('','agl-006',0)  #MOD-4A0001
               NEXT FIELD apk08
            END IF
            IF g_apk_c[i].apk08 < 0 THEN     #紅字發票:折讓
               LET g_apk_c[i].apk171 = '23'
            END IF
 #NO.MOD-530687--begin
           #str MOD-850283 mod
           #已經在AFTER FIELD apk08f段計算過(IF g_apk_c[i].apk172 = 'T')
           #這邊直接做取位、DISPLAY即可
            LET g_apk_c[i].apk08 = cl_digcut(g_apk_c[i].apk08,g_azi04)
            DISPLAY g_apk_c[i].apk08 TO s_apk[j].apk08
           #IF g_apk_c[i].apk172 = 'T' THEN
           #   IF g_apk_c[i].apk08 != l_apk08_o THEN
           #      LET l_apk08_t = g_apk_c[i].apk08
           #     #LET g_apk_c[i].apk08 = g_apk_c[i].apk08 * (1-g_apk_c[i].apk29/100)  #No.TQC-710097 mark
           #      LET g_apk_c[i].apk08 = g_apk_c[i].apk08 / (1+g_apk_c[i].apk29/100)  #No.TQC-710097
           #      #LET g_apk_c[i].apk08 = cl_digcut(g_apk_c[i].apk08,t_azi.azi04)   #MOD-6B0066
           #      LET g_apk_c[i].apk08 = cl_digcut(g_apk_c[i].apk08,g_azi04)   #MOD-6B0066
           #      LET l_tax = l_apk08_t * (g_apk_c[i].apk29/100)
           #      DISPLAY g_apk_c[i].apk08 TO s_apk[j].apk08
           #   END IF
           #ELSE
           #   LET l_tax = g_apk_c[i].apk08 * (g_apk_c[i].apk29/100)
           #END IF
           #end MOD-850283 mod
            LET l_tax = g_apk_c[i].apk08 * (g_apk_c[i].apk29/100)   #MOD-850283 add
            LET l_apk08_o = g_apk_c[i].apk08
            IF apk08_t IS NULL OR apk08_t<>g_apk_c[i].apk08 THEN
              #LET g_apk_c[i].apk07 = cl_digcut(l_tax,t_azi.azi04)   #MOD-6B0066
               LET g_apk_c[i].apk07 = cl_digcut(l_tax,g_azi04)   #MOD-6B0066
            END IF
            LET g_apk_c[i].apk06 = g_apk_c[i].apk08 + g_apk_c[i].apk07
         END IF
#end

      AFTER FIELD apk07
         IF NOT cl_null(g_apk_c[i].apk07) THEN
            LET g_apk_c[i].apk07 = cl_digcut(g_apk_c[i].apk07,g_azi04)  #MOD-9B0203 add
            DISPLAY g_apk_c[i].apk07 TO s_apk[j].apk07                  #MOD-9B0203 add
            LET g_apk_c[i].apk06 = g_apk_c[i].apk08 + g_apk_c[i].apk07
            LET u_sign = 1
            IF g_apk_c[i].apk171 = '23' THEN
               LET u_sign = -1
            END IF
            CALL t110_sum(g_apk_c[i].apk02,g_apk_c[i].apk03,
                          g_apk_c[i].apk06*u_sign,g_apk_c[i].apk07*u_sign,
                          g_apk_c[i].apk08*u_sign,g_apk_c[i].apk171)
         END IF
      #No.MOD-580365  --begin
      BEFORE FIELD apk08f
         LET apk08f_t = g_apk_c[i].apk08f
         IF g_apk_c[i].apk172 = 'T' THEN
            CALL cl_err('','aoo-009',0)
         END IF
         LET l_apk08f_o = g_apk_c[i].apk08f
 
      AFTER FIELD apk08f
         IF NOT cl_null(g_apk_c[i].apk08f) THEN
            IF g_apk_c[i].apk08f = 0 THEN
                CALL cl_err('','agl-006',0)  #MOD-4A0001
               NEXT FIELD apk08f
            END IF
            IF g_apk_c[i].apk08f < 0 THEN     #紅字發票:折讓
               LET g_apk_c[i].apk171 = '23'
            END IF
            IF g_apk_c[i].apk172 = 'T' THEN
               IF g_apk_c[i].apk08f != l_apk08f_o THEN
                  LET l_apk08f_t = g_apk_c[i].apk08f
                 #LET g_apk_c[i].apk08f = g_apk_c[i].apk08f * (1-g_apk_c[i].apk29/100)   #No.TQC-710097 mark
                 #LET g_apk_c[i].apk08f = g_apk_c[i].apk08f / (1+g_apk_c[i].apk29/100)   #No.TQC-710097 #TQC-960012 Mark
                  LET g_apk_c[i].apk08f = g_apk_c[i].apk08f * (1-g_apk_c[i].apk29/100)                  #TQC-960012 Add 
                  LET g_apk_c[i].apk08f = cl_digcut(g_apk_c[i].apk08f,l_azi.azi04)
                 #LET l_tax = l_apk08f_t * (g_apk_c[i].apk29/100)          #MOD-850283 mark
                  LET l_tax = l_apk08f_t * (g_apk_c[i].apk29/100)          #TQC-960012 Add       
                  DISPLAY g_apk_c[i].apk08f TO s_apk[j].apk08f
               END IF
            ELSE                                                           #TQC-960012                                             
               LET g_apk_c[i].apk08f = cl_digcut(g_apk_c[i].apk08f,l_azi.azi04)               #No.MOD-B40183 
               LET l_tax = g_apk_c[i].apk08f * (g_apk_c[i].apk29/100)     #TQC-960012
            END IF
#           LET l_tax = g_apk_c[i].apk08f * (g_apk_c[i].apk29/100)   #MOD-850283  #TQC-960012 Mark
            LET l_apk08f_o = g_apk_c[i].apk08f
            IF apk08f_t IS NULL OR apk08f_t<>g_apk_c[i].apk08f THEN
               LET g_apk_c[i].apk07f = cl_digcut(l_tax,l_azi.azi04)
               #MOD-580365  --begin
               LET g_apk_c[i].apk08=g_apk_c[i].apk08f*g_apa.apa14
               LET l_tax = g_apk_c[i].apk08 * (g_apk_c[i].apk29/100)
              #LET g_apk_c[i].apk07 = cl_digcut(l_tax,t_azi.azi04)   #MOD-6B0066
               LET g_apk_c[i].apk07 = cl_digcut(l_tax,g_azi04)   #MOD-6B0066
               #MOD-580365  --end
            END IF
            LET g_apk_c[i].apk06f = g_apk_c[i].apk08f + g_apk_c[i].apk07f
         END IF
 
      AFTER FIELD apk07f
         IF NOT cl_null(g_apk_c[i].apk07f) THEN
            LET g_apk_c[i].apk07f= cl_digcut(g_apk_c[i].apk07f,g_azi04)  #MOD-9B0203 add
            DISPLAY g_apk_c[i].apk07f TO s_apk[j].apk07f                 #MOD-9B0203 add
            LET g_apk_c[i].apk06f = g_apk_c[i].apk08f + g_apk_c[i].apk07f
            LET u_sign = 1
            IF g_apk_c[i].apk171 = '23' THEN
               LET u_sign = -1
            END IF
            CALL t110_sumf(g_apk_c[i].apk02,g_apk_c[i].apk03,
                           g_apk_c[i].apk06f*u_sign,g_apk_c[i].apk07f*u_sign,
                           g_apk_c[i].apk08f*u_sign,g_apk_c[i].apk171)
            #MOD-580365  --begin
            LET g_apk_c[i].apk07=g_apk_c[i].apk07f*g_apa.apa14
            #MOD-580365  --end
            LET g_apk_c[i].apk07 = cl_digcut(g_apk_c[i].apk07,g_azi04)  #MOD-9B0203 add
            DISPLAY g_apk_c[i].apk07 TO s_apk[j].apk07                  #MOD-9B0203 add
         END IF
 
      #No.MOD-580365  --end

      AFTER FIELD apk172
         #CHI-B10017 add --start--
         SELECT gec05
           INTO l_apk172
           FROM gec_file
          WHERE gec01 = g_apk_c[i].apk11 AND gec011='1'  #進項
            AND gecacti = 'Y'
         IF g_apk_c[i].apk172 != l_apk172 THEN
            CALL cl_err('','axr-127',0)
            NEXT FIELD apk28
         END IF
         #CHI-B10017 add --end--
         IF g_apk_c[i].apk172 MATCHES '[SN]' AND cl_null(g_apk_c[i].apk28) THEN
            CALL cl_err('','tis-001',0)
            NEXT FIELD apk28
         END IF

      AFTER FIELD apk30
         #海關代征完稅憑證
         IF g_apk_c[i].apk172 = 'G' AND cl_null(g_apk_c[i].apk30) THEN
            NEXT FIELD apk30
         END IF


      #FUN-970108---Begin
      AFTER FIELD apk32
         IF NOT cl_null(g_apk_c[i].apk32) THEN   
           SELECT COUNT(*) INTO g_cnt FROM ama_file
            WHERE ama02 = g_apk_c[i].apk32
             IF g_cnt = 0 THEN 
                IF g_aza.aza26 = '0' THEN              #MOD-A10127 add
                   CALL cl_err("","amd-028",1) 
                END IF                                 #MOD-A10127 add
             END IF
            #IF g_aza.aza21 = 'Y' OR NOT s_chkban(g_apk_c[i].apk32) THEN #FUN-990053 mod   #TQC-9A0017 mark
             IF g_aza.aza21 = 'Y' AND NOT s_chkban(g_apk_c[i].apk32) THEN #FUN-990053 mod  #TQC-9A0017
                CALL cl_err("","mfg7015",1)
                NEXT FIELD apk32
             END IF
         ELSE
            IF g_aza.aza94 = 'Y' THEN
                CALL cl_err('apk32 is null: ','aap-099',0)  
                NEXT FIELD apk32 
            END IF
         END IF
      #FUN-970108---End
      
      BEFORE DELETE                            #是否取消單身
        #MOD-A30140---add---start---
         LET l_tot1 = l_tot1 - g_apk_c[i].apk08           #未稅
         LET l_tot2 = l_tot2 - g_apk_c[i].apk07           #稅
         LET l_tot3 = l_tot3 - g_apk_c[i].apk06           #含稅
         LET l_tot1f= l_tot1f- g_apk_c[i].apk08f  
         LET l_tot2f= l_tot2f- g_apk_c[i].apk07f  
         LET l_tot3f= l_tot3f- g_apk_c[i].apk06f  
        #MOD-A30140---add---end---
         DELETE FROM apk_file
          WHERE apk01 = g_apa.apa01 AND apk02 = g_apk_c[i].apk02
            AND apk03 = g_apk_c[i].apk03
         IF SQLCA.sqlcode THEN
#           CALL cl_err(g_apk_c[i].apk03,SQLCA.sqlcode,0)   #No.FUN-660122
            CALL cl_err3("del","apk_file",g_apa.apa01,g_apk_c[i].apk02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
            LET g_success = 'N'
            ROLLBACK WORK
            LET g_apa.* = g_apa_t.*       #MOD-B40036
            CANCEL DELETE
         ELSE                               #CHI-940018 
            LET g_rec_b1 = g_rec_b1 - 1     #CHI-940018                
         END IF
         DISPLAY BY NAME l_tot1,l_tot2,l_tot3                 #MOD-A30140 add 
         DISPLAY BY NAME l_tot1f,l_tot2f,l_tot3f              #MOD-A30140 add  

#CHI-940018 --add begin--
      ON ROW CHANGE
         IF INT_FLAG THEN
            CALL cl_err('',9001,0)
            LET INT_FLAG = 0
            LET g_apk_c[i].* = g_apk_c_t.*
            CLOSE ddd_c_bcl
            ROLLBACK WORK
            LET g_apa.* = g_apa_t.*       #MOD-B40036
            EXIT INPUT
         END IF
         IF l_opensw = 'Y' THEN
            CALL cl_err(g_apk_c[i].apk03,-263,1)
            LET g_apk_c[i].* = g_apk_c_t.*
         ELSE
            IF g_apk_c[i].apk06 IS NULL OR g_apk_c[i].apk06 = 0 THEN
               NEXT FIELD apk02 
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               ROLLBACK WORK
               LET g_apa.* = g_apa_t.*       #MOD-B40036
               EXIT INPUT 
            END IF    
            IF g_apk_c[i].apk06 < 0 THEN  #以負值顯示, 正值存放
               LET g_apk_c[i].apk08 = g_apk_c[i].apk08 * -1
               LET g_apk_c[i].apk07 = g_apk_c[i].apk07 * -1
               LET g_apk_c[i].apk06 = g_apk_c[i].apk06 * -1
            END IF
            #幣別、稅別等欄位
            LET l_apk11 = g_apa.apa15
            LET l_apk12 = g_apa.apa13
            LET l_apk13 = g_apa.apa14
           #str MOD-9B0202 mark
           #LET l_apk06f= g_apk_c[i].apk06 / l_apk13
           #LET l_apk07f= g_apk_c[i].apk07 / l_apk13
           #LET l_apk08f= g_apk_c[i].apk08 / l_apk13
           #SELECT azi04 INTO l_azi04 FROM azi_file WHERE azi01 = l_apk12   
           #LET l_apk06f= cl_digcut(l_apk06f,l_azi04)
           #LET l_apk07f= cl_digcut(l_apk07f,l_azi04)
           #LET l_apk08f= cl_digcut(l_apk08f,l_azi04)
           #end MOD-9B0202 mark
            LET g_apk_c[i].apk06 = cl_digcut(g_apk_c[i].apk06 ,g_azi04)
            LET g_apk_c[i].apk07 = cl_digcut(g_apk_c[i].apk07 ,g_azi04)
            LET g_apk_c[i].apk08 = cl_digcut(g_apk_c[i].apk08 ,g_azi04)
            IF NOT cl_null(p_seq) THEN 
             # UPDATE apb_file SET apk02 = i,     #MOD-970145
               UPDATE apk_file SET apk02 = i,     #MOD-970145  
                                   apk03 = g_apk_c[i].apk03,
                                   apk04 = g_apk_c[i].apk04,
                                   apk05 = g_apk_c[i].apk05,
                                   apk06 = g_apk_c[i].apk06,
                                   apk07 = g_apk_c[i].apk07,
                                   apk08 = g_apk_c[i].apk08,
                                   apk171= g_apk_c[i].apk171,
                                   apk172= g_apk_c[i].apk172, 
                                   apk28 = g_apk_c[i].apk28,
                                   apk29 = g_apk_c[i].apk29,
                                   apk30 = g_apk_c[i].apk30,
                                  #apk11 = l_apk11,          #CHI-B10017 mark
                                   apk11 = g_apk_c[i].apk11, #CHI-B10017 
                                   apk12 = l_apk12,
                                   apk13 = l_apk13,
                                   apk06f= g_apk_c[i].apk06f,  #MOD-9B0202 mod
                                   apk07f= g_apk_c[i].apk07f,  #MOD-9B0202 mod
                                   apk08f= g_apk_c[i].apk08f,  #MOD-9B0202 mod
                                   apk32 = g_apk_c[i].apk32    #FUN-970108 add
                             WHERE apk01 = g_apa.apa01 
                               AND apk02 = p_seq
                               AND apk03 = g_apk_c_t.apk03
            ELSE
    #          UPDATE apb_file SET apk02 = i,   #MOD-970145
               UPDATE apk_file SET apk02 = i,   #MOD-970145
                                   apk03 = g_apk_c[i].apk03,
                                   apk04 = g_apk_c[i].apk04,
                                   apk05 = g_apk_c[i].apk05,
                                   apk06 = g_apk_c[i].apk06,
                                   apk07 = g_apk_c[i].apk07,
                                   apk08 = g_apk_c[i].apk08,
                                   apk171= g_apk_c[i].apk171,
                                   apk172= g_apk_c[i].apk172, 
                                   apk28 = g_apk_c[i].apk28,
                                   apk29 = g_apk_c[i].apk29,
                                   apk30 = g_apk_c[i].apk30,
                                  #apk11 = l_apk11,          #CHI-B10017 mark
                                   apk11 = g_apk_c[i].apk11, #CHI-B10017 
                                   apk12 = l_apk12,
                                   apk13 = l_apk13,
                                   apk06f= g_apk_c[i].apk06f,  #MOD-9B0202 mod
                                   apk07f= g_apk_c[i].apk07f,  #MOD-9B0202 mod
                                   apk08f= g_apk_c[i].apk08f,  #MOD-9B0202 mod
                                   apk32 = g_apk_c[i].apk32    #FUN-970108 add
                             WHERE apk01 = g_apa.apa01 
                               AND apk02 = g_apk_c_t.apk02
                               AND apk03 = g_apk_c_t.apk03                 	
            END IF 
            IF SQLCA.sqlcode THEN
               CALL cl_err3("upd","apk_file",g_apa.apa01,g_apk_c_t.apk03,SQLCA.sqlcode,"","",1)  
               LET g_apk_c[i].* = g_apk_c_t.*
            ELSE               
               MESSAGE 'UPDATE O.K'
               IF g_success='Y' THEN          
                  COMMIT WORK
               ELSE
                  ROLLBACK WORK
                  LET g_apa.* = g_apa_t.*       #MOD-B40036
               END IF
            END IF
         END IF          
#CHI-940018 --add end--

      AFTER ROW
        #MOD-A30140---mark---start---      #移到ON ROW CHANGE
        #IF g_apk_c[i].apk07=0 AND g_apk_c[i].apk08=0 THEN
        #   INITIALIZE g_apk_c[i].* TO NULL
        #END IF
        ##No.FUN-580006 --start--
        #IF cl_null(g_apk_c[i].apk28) AND g_aza.aza46 = 'Y'
        #   AND NOT cl_null(g_apk_c[i].apk07) AND NOT cl_null(g_apk_c[i].apk08)  #No.TQC-740067
        #   AND NOT INT_FLAG THEN
        #   CALL cl_err('','gap-142',0)
        #   NEXT FIELD apk28
        #END IF
        ##No.FUN-580006 --end--
        #
        #LET l_tot1 = 0   LET l_tot2 = 0   LET l_tot3 = 0
        #LET l_tot1f= 0   LET l_tot2f= 0   LET l_tot3f= 0   #MOD-9A0188 add
        #FOR k = 1 TO g_apk_c.getLength()        
        #   IF g_apk_c[k].apk06 IS NULL OR g_apk_c[k].apk06=0 THEN
        #      CONTINUE FOR
        #   END IF
        #   LET l_tot1 = l_tot1 + g_apk_c[k].apk08           #未稅
        #   LET l_tot2 = l_tot2 + g_apk_c[k].apk07           #稅
        #   LET l_tot3 = l_tot3 + g_apk_c[k].apk06           #含稅
        #   LET l_tot1f= l_tot1f+ g_apk_c[k].apk08f   #MOD-9A0188 add
        #   LET l_tot2f= l_tot2f+ g_apk_c[k].apk07f   #MOD-9A0188 add
        #   LET l_tot3f= l_tot3f+ g_apk_c[k].apk06f   #MOD-9A0188 add
        #END FOR
        #DISPLAY BY NAME l_tot1,l_tot2,l_tot3
        #DISPLAY BY NAME l_tot1f,l_tot2f,l_tot3f       #MOD-9A0188 add
        #MOD-A30140---mark---end---
         LET i = ARR_CURR()             #MOD-A30140 add
#CHI-940018 --begin--          
         IF INT_FLAG THEN                                                                                                         
            CALL cl_err('',9001,0)                                                                                                
            LET INT_FLAG = 0                                                                                                                    
            IF p_cmd = 'u' THEN                                                                                                   
               LET g_apk_c[i].* = g_apk_c_t.*                                                                                      
            END IF                                                                                                                
            CLOSE ddd_c_bcl                                                                                                        
            ROLLBACK WORK        
            LET g_apa.* = g_apa_t.*       #MOD-B40036
            LET g_success  = 'N'                                                                                                 
            EXIT INPUT                                                                                                            
         END IF                                                                                                                   
         CLOSE ddd_c_bcl                                                                                                           
         COMMIT WORK            
#CHI-940018  --end  

      AFTER INPUT
#CHI-940018 --begin--
        #str MOD-9B0200 mark
        #IF cl_null(g_apk_c[i].apk02) THEN 
        #   NEXT FIELD apk02
        #END IF 
        #IF cl_null(g_apk_c[i].apk03) THEN 
        #   NEXT FIELD apk03
        #END IF               
        #end MOD-9B0200 mark
#CHI-940018  --end           
#        IF g_apa.apa08 = 'MISC' AND NOT cl_null(p_seq) THEN
         IF NOT cl_null(p_seq) THEN     #No.MOD-540169
            SELECT apb10 INTO l_apb10 FROM apb_file
             WHERE apb01 = g_apa.apa01 AND apb02 = p_seq
            IF cl_null(l_apb10) THEN
               LET l_apb10 = 0
            END IF
            IF l_tot1 > l_apb10 THEN
               CALL cl_err('','tis-005',0)
            END IF
         END IF
          
      #FUN-970108---Begin
      ON ACTION CONTROLP
         IF INFIELD(apk32) THEN
            CALL cl_init_qry_var()
            LET g_qryparam.form     = "q_ama02"
            LET g_qryparam.default1 = g_apk_c[i].apk32
            CALL cl_create_qry() RETURNING g_apk_c[i].apk32
            DISPLAY g_apk_c[i].apk32 TO apk32 
         END IF
      #FUN-970108---End
         #CHI-B10017 add --start--
         IF INFIELD(apk11) THEN
            CALL cl_init_qry_var()
            LET g_qryparam.form     = "q_gec"
            LET g_qryparam.default1 = g_apk_c[i].apk11
            LEt g_qryparam.arg1     = '1'
            CALL cl_create_qry() RETURNING g_apk_c[i].apk11
            DISPLAY g_apk_c[i].apk11 TO apk11
         END IF
         #CHI-B10017 add --end--
         
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033

   END INPUT
 END IF

   IF INT_FLAG THEN
      LET INT_FLAG = 0
      CLOSE WINDOW t110_ddd_wc
      RETURN
   END IF

   LET j = ARR_COUNT()
#CHI-940018 --mark--
#   WHILE TRUE
##     IF g_apa.apa08 = 'MISC' AND NOT cl_null(p_seq) THEN
#       IF NOT cl_null(p_seq) THEN      #No.MOD-540169
#         DELETE FROM apk_file WHERE apk01 = g_apa.apa01 AND apk02 = p_seq
#      ELSE
#         DELETE FROM apk_file WHERE apk01 = g_apa.apa01
#      END IF
#
#      IF STATUS THEN
#         CALL cl_err('t110_ddd(ckp#1):',STATUS,1)
#         LET g_success = 'N'
#         EXIT WHILE
#      END IF
#
#      FOR k = 1 TO g_apk_c.getLength()
#          IF g_apk_c[k].apk06 IS NULL OR g_apk_c[k].apk06=0 THEN
#             CONTINUE FOR
#          END IF
#
#          IF g_apk_c[k].apk06 < 0 THEN  #以負值顯示, 正值存放
#             LET g_apk_c[k].apk08 = g_apk_c[k].apk08 * -1
#             LET g_apk_c[k].apk07 = g_apk_c[k].apk07 * -1
#             LET g_apk_c[k].apk06 = g_apk_c[k].apk06 * -1
#          END IF
#
#          #no.5954 增加幣別、稅別等欄位
#          LET l_apk11 = g_apa.apa15
#          LET l_apk12 = g_apa.apa13
#          LET l_apk13 = g_apa.apa14
#          LET l_apk06f= g_apk_c[k].apk06 / l_apk13
#          LET l_apk07f= g_apk_c[k].apk07 / l_apk13
#          LET l_apk08f= g_apk_c[k].apk08 / l_apk13
#          SELECT azi04 INTO l_azi04 FROM azi_file WHERE azi01 = l_apk12    #No:9318
#          LET l_apk06f= cl_digcut(l_apk06f,l_azi04)
#          LET l_apk07f= cl_digcut(l_apk07f,l_azi04)
#          LET l_apk08f= cl_digcut(l_apk08f,l_azi04)
#         #No.MOD-840046--begin-- 
#          LET g_apk_c[k].apk06 = cl_digcut(g_apk_c[k].apk06 ,g_azi04)  
#          LET g_apk_c[k].apk07 = cl_digcut(g_apk_c[k].apk07 ,g_azi04) 
#          LET g_apk_c[k].apk08 = cl_digcut(g_apk_c[k].apk08 ,g_azi04)
#         #No.MOD-840046---end--- 
# 
#        INSERT INTO apk_file(apk01,apk02,apk03,apk04,apk05,
#                             apk06,apk07,apk08,apk171,apk172,
#                             apk173,apk174,apk22,apk25,apk28,
#                             apk29,apk30,apk11,apk12,apk13,
#                             apk06f,apk07f,apk08f,
#                             apkacti,apkgrup,apkuser,apkdate)   #MOD-870029 add
#                      VALUES(g_apa.apa01,g_apk_c[k].apk02,g_apk_c[k].apk03,
#                             g_apk_c[k].apk04,g_apk_c[k].apk05,
#                             g_apk_c[k].apk06,g_apk_c[k].apk07,
#                             g_apk_c[k].apk08,g_apk_c[k].apk171,
#                             g_apk_c[k].apk172,g_apa.apa173,g_apa.apa174,
#                             g_apa.apa22,g_apa.apa25,g_apk_c[k].apk28,
#                             g_apk_c[k].apk29,g_apk_c[k].apk30,
#                             l_apk11,l_apk12,l_apk13,l_apk06f,l_apk07f,
#                             l_apk08f,
#                             'Y',g_grup,g_user,g_today)   #MOD-870029 add
#          IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
##            CALL cl_err('t110_ddd(ckp#2):',SQLCA.sqlcode,1)   #No.FUN-660122
#             CALL cl_err3("ins","apk_file",g_apa.apa01,g_apk_c[k].apk02,SQLCA.sqlcode,"","t110_ddd(ckp#2):",1)  #No.FUN-660122
#          END IF
#      END FOR
#      EXIT WHILE
#   END WHILE
##CHI-940018 --mark--
    CLOSE ddd_c_bcl            #CHI-940018
    COMMIT WORK               #CHI-940018
    CLOSE WINDOW t110_ddd_wc  #MOD-4A0001
  IF g_success = 'Y' THEN     #CHI-940018
     CALL t110_apz08(p_seq)
  END IF                      #CHI-940018

END FUNCTION

FUNCTION t110_apz08(p_seq)
   DEFINE l_tot1,l_tot2,l_tot3       LIKE apa_file.apa31,
          l_tot11,l_tot21,l_tot31    LIKE apa_file.apa31,
          l_tot1f,l_tot2f,l_tot3f    LIKE apa_file.apa31,
          l_tot11f,l_tot21f,l_tot31f LIKE apa_file.apa31,
          l_chk     LIKE type_file.chr1,      # No:FUN-690028 VARCHAR(1),
          l_ans     LIKE type_file.chr1,      # No:FUN-690028 VARCHAR(01),
          l_ans1,l_opensw    LIKE type_file.chr1,      # No:FUN-690028 VARCHAR(01),           #85-09-23
          l_apa31   LIKE apa_file.apa31,
          l_apa31f  LIKE apa_file.apa31f,
          l_apa32   LIKE apa_file.apa32,
          l_apa32f  LIKE apa_file.apa32f,
          l_apa34f  LIKE apa_file.apa34f,
          l_apa34   LIKE apa_file.apa34,
          l_tot28   LIKE apa_file.apa31,
          l_tot28f  LIKE apa_file.apa31,
          l_apk12   LIKE apk_file.apk12,
          p_seq     LIKE type_file.num5      # No:FUN-690028 SMALLINT
   DEFINE l_pmb02   LIKE pmb_file.pmb02      #No.TQC-740067
   DEFINE l_cnt     LIKE type_file.num5   #MOD-840079

   IF NOT cl_null(p_seq) THEN
      CLOSE WINDOW t110_ddd_wc
      RETURN
   END IF

   #若無發票編號，則不更新單頭
   SELECT COUNT(*) INTO g_cnt FROM apk_file WHERE apk01 = g_apa.apa01
   IF g_cnt = 0 THEN RETURN END IF
 
   #No.TQC-A30079  --Begin
   IF g_apz.apz08 = '3' THEN RETURN END IF
   #No.TQC-A30079  --End  
 
   SELECT SUM(apk08),SUM(apk07),SUM(apk06),SUM(apk08f),SUM(apk07f),SUM(apk06f)
     INTO l_tot1,l_tot2,l_tot3,l_tot1f,l_tot2f,l_tot3f
     FROM apk_file
    WHERE apk01 = g_apa.apa01 AND apk171 NOT IN ('23','24')

   IF cl_null(l_tot1)  THEN LET l_tot1 = 0 END IF
   IF cl_null(l_tot2)  THEN LET l_tot2 = 0 END IF
   IF cl_null(l_tot3)  THEN LET l_tot3 = 0 END IF
   IF cl_null(l_tot1f) THEN LET l_tot1f = 0 END IF
   IF cl_null(l_tot2f) THEN LET l_tot2f = 0 END IF
   IF cl_null(l_tot3f) THEN LET l_tot3f = 0 END IF

   SELECT SUM(apk08),SUM(apk08f) INTO l_tot28,l_tot28f FROM apk_file  #No.8394
    WHERE apk01 = g_apa.apa01 AND (apk171 ='28' OR apk171='29')

   IF cl_null(l_tot28) THEN LET l_tot28 = 0 END IF

   IF cl_null(l_tot28f) THEN LET l_tot28f = 0 END IF                  #No.8394

   IF NOT cl_null(l_tot28) AND l_tot28<>0  THEN
      LET l_tot1=l_tot1-l_tot28
      LET l_tot3=l_tot1+l_tot2
      LET l_tot1f=l_tot1f-l_tot28f #No.8394
      LET l_tot3f=l_tot1f+l_tot2f  #No.8394
   END IF

   SELECT SUM(apk08),SUM(apk07),SUM(apk06),SUM(apk08f),SUM(apk07f),SUM(apk06f)
     INTO l_tot11,l_tot21,l_tot31,l_tot11f,l_tot21f,l_tot31f
     FROM apk_file
    WHERE apk01 = g_apa.apa01 AND apk171 IN ('23','24','29')
 
   IF cl_null(l_tot11) THEN
      LET l_tot11 = 0
   END IF

   IF cl_null(l_tot21) THEN
      LET l_tot21 = 0
   END IF

   IF cl_null(l_tot31) THEN
      LET l_tot31 = 0
   END IF

   IF cl_null(l_tot11f) THEN
      LET l_tot11f = 0
   END IF

   IF cl_null(l_tot21f) THEN
      LET l_tot21f = 0
   END IF

   IF cl_null(l_tot31f) THEN
      LET l_tot31f = 0
   END IF

   IF g_aptype MATCHES '1*' THEN
      LET l_tot1 = l_tot1 - l_tot11
      LET l_tot2 = l_tot2 - l_tot21
      LET l_tot3 = l_tot3 - l_tot31
      LET l_tot1f= l_tot1f- l_tot11f
      LET l_tot2f= l_tot2f- l_tot21f
      LET l_tot3f= l_tot3f- l_tot31f
   ELSE
      LET l_tot1 = l_tot11
      LET l_tot2 = l_tot21
      LET l_tot3 = l_tot31
      LET l_tot1f= l_tot11f
      LET l_tot2f= l_tot21f
      LET l_tot3f= l_tot31f
   END IF
 
   LET l_ans  = 'Y'
   LET l_ans1 = 'Y'
   LET l_apa31 = l_tot1
   LET l_apa32 = l_tot2
   LET l_apa34 = l_tot3
   LET g_cnt = 0

   #no.5954判斷單身是否皆為本國幣別

   DECLARE apk12_cs CURSOR FOR
    SELECT UNIQUE(apk12) FROM apk_file WHERE apk01 = g_apa.apa01

   FOREACH apk12_cs INTO l_apk12
       LET g_cnt = g_cnt + 1
   END FOREACH

   IF g_aza.aza17 = l_apk12 AND g_cnt = 1 THEN
      LET l_apa31f = l_tot1
      LET l_apa32f = l_tot2
      LET l_apa34f = l_tot3
   ELSE
      #LET l_apa31f = cl_digcut(l_tot1f,g_azi.azi04)   #MOD-6B0066
      #LET l_apa32f = cl_digcut(l_tot2f,g_azi.azi04)   #MOD-6B0066
      LET l_apa31f = cl_digcut(l_tot1f,t_azi04)   #MOD-6B0066
      LET l_apa32f = cl_digcut(l_tot2f,t_azi04)   #MOD-6B0066
      LET l_apa34f = l_apa31f+l_apa32f
   END IF

   #-->詢問是否更新帳款金額(apz08參數)
   IF g_apz.apz08='2' OR l_opensw = 'Y' THEN
      WHILE TRUE

         OPEN WINDOW t110_ddd_w2 WITH FORM "aap/42f/aapt110_f"
            ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
         CALL cl_ui_locale("aapt110_f")
 
         DISPLAY l_tot28 TO FORMONLY.tot28
         #No:8593
         DISPLAY l_apa31f TO FORMONLY.apa31f #ATTRIBUTE(YELLOW)   #TQC-8C0076
         DISPLAY l_apa32f TO FORMONLY.apa32f #ATTRIBUTE(YELLOW)   #TQC-8C0076
         DISPLAY l_apa34f TO FORMONLY.apa34f #ATTRIBUTE(YELLOW)   #TQC-8C0076
         DISPLAY l_apa31 TO FORMONLY.apa31 #ATTRIBUTE(YELLOW)     #TQC-8C0076
         DISPLAY l_apa32 TO FORMONLY.apa32 #ATTRIBUTE(YELLOW)     #TQC-8C0076
         DISPLAY l_apa34 TO FORMONLY.apa34 #ATTRIBUTE(YELLOW)     #TQC-8C0076
         #---
         CALL cl_set_head_visible("","YES")     #No.FUN-6B0033

         INPUT l_ans1,l_ans,l_apa31f,l_apa32f,l_apa34f,l_apa31,l_apa32,l_apa34
               WITHOUT DEFAULTS
          FROM ans1,ans,apa31f,apa32f,apa34f,apa31,apa32,apa34

           BEFORE FIELD ans1
              CALL t110_set_entry_ans()

           AFTER FIELD ans1
             IF cl_null(l_ans1) OR l_ans1 NOT MATCHES '[YN]' THEN
                NEXT FIELD ans1
             END IF
             CALL t110_set_no_entry_ans(l_ans1)

           AFTER FIELD ans
             IF cl_null(l_ans) OR l_ans NOT MATCHES '[YN]' THEN
                NEXT FIELD ans
             ELSE
                IF l_ans='N' AND l_ans1='N' THEN
                   EXIT INPUT
                END IF
             END IF

           AFTER FIELD apa31f
             IF l_apa31f IS NULL THEN
                #LET l_apa31f=cl_digcut(l_tot1/g_apa.apa14,g_azi.azi04)   #MOD-6B0066
                LET l_apa31f=cl_digcut(l_tot1/g_apa.apa14,t_azi04)   #MOD-6B0066
                DISPLAY l_apa31f TO FORMONLY.apa31f
                NEXT FIELD apa31f
             ELSE
                LET l_apa34f= l_apa31f+ l_apa32f
                DISPLAY l_apa34f TO FORMONLY.apa34f
             END IF

           AFTER FIELD apa32f
             #no.6053 若為零稅率，稅額不可大於零
             IF g_apa.apa32 > 0 AND g_apa.apa16 = 0 THEN
                CALL cl_err('','aap-902',1)
                NEXT FIELD apa32
             END IF
             IF l_apa32f IS NULL THEN
                #LET l_apa32f = cl_digcut(l_tot2/g_apa.apa14,g_azi.azi04)   #MOD-6B0066
                LET l_apa32f = cl_digcut(l_tot2/g_apa.apa14,t_azi04)   #MOD-6B0066
                DISPLAY l_apa32f TO FORMONLY.apa32f
                NEXT FIELD apa32f
             ELSE
                LET l_apa34f = l_apa31f + l_apa32f
                DISPLAY l_apa34f TO FORMONLY.apa34f
             END IF

           AFTER FIELD apa31
             IF l_apa31 IS NULL THEN
                LET l_apa31 = l_tot1
                DISPLAY l_apa31 TO FORMONLY.apa31
                NEXT FIELD apa31
             ELSE
                LET l_apa34 = l_apa31 + l_apa32
                DISPLAY l_apa34 TO FORMONLY.apa34
             END IF

           AFTER FIELD apa32
             IF l_apa32 IS NULL THEN
                LET l_apa32 = l_tot2
                DISPLAY l_apa32 TO FORMONLY.apa32
                NEXT FIELD apa32
             ELSE
                LET l_apa34 = l_apa31 + l_apa32
                DISPLAY l_apa34 TO FORMONLY.apa34
             END IF

           AFTER INPUT
             IF INT_FLAG THEN EXIT INPUT END IF
             IF cl_null(l_ans) OR l_ans NOT MATCHES '[YN]' THEN
                NEXT FIELD ans
             END IF
             IF cl_null(l_ans1) OR l_ans1 NOT MATCHES '[YN]' THEN
                NEXT FIELD ans1
             END IF
            #str CHI-850025 add
            #當匯率為1時,需檢核原幣與本幣的稅額、金額需相同
            #IF g_apa.apa14 = 1 THEN                                 #MOD-880041 mark
             IF g_apa.apa14 = 1 AND g_aza.aza17 = g_apa.apa13 THEN   #MOD-880041
                IF l_apa31f!=l_apa31 OR l_apa32f!=l_apa32 OR
                   l_apa34f!=l_apa34 THEN
                   CALL cl_err('','apm-988',1)
                   NEXT FIELD apa31f
                END IF
             END IF
            #end CHI-850025 add

            ON ACTION controlg       #TQC-860021
               CALL cl_cmdask()      #TQC-860021

            ON IDLE g_idle_seconds   #TQC-860021
               CALL cl_on_idle()     #TQC-860021
               CONTINUE INPUT        #TQC-860021

            ON ACTION about          #TQC-860021
               CALL cl_about()       #TQC-860021

            ON ACTION help           #TQC-860021
               CALL cl_show_help()   #TQC-860021
       END INPUT

       IF INT_FLAG THEN
          LET INT_FLAG = 0
          CLOSE WINDOW t110_ddd_w2
          IF g_aza.aza26 = '2' THEN
             CLOSE WINDOW t110_ddd_wc
          ELSE
             CLOSE WINDOW t110_ddd_w
          END IF
          RETURN
       END IF

       CLOSE WINDOW t110_ddd_w2
       EXIT WHILE
    END WHILE
  ELSE
    LET l_ans='Y'
    LET l_ans1 = 'Y'    #No.TQC-A30079
  END IF

  #No.TQC-A30079  --Begin
  IF l_ans = 'N' AND l_ans1 = 'N' THEN RETURN END IF
  #No.TQC-A30079  --End  

  IF g_aza.aza26 = '2' THEN
     CLOSE WINDOW t110_ddd_wc
  ELSE
     CLOSE WINDOW t110_ddd_w
  END IF

  IF g_apa.apa41 = 'Y' THEN
     RETURN
  END IF

   CASE
      WHEN g_aptype = '11'
         CURRENT WINDOW IS t110_w11
      WHEN g_aptype = '12'
         CURRENT WINDOW IS t110_w12
      WHEN g_aptype = '15'
         CURRENT WINDOW IS t110_w15
      #No.FUN-690080 --Begin
      WHEN g_aptype = '13'
         CURRENT WINDOW IS t110_w13
      WHEN g_aptype = '17'
         CURRENT WINDOW IS t110_w17
      #No.FUN-690080 --End
   END CASE

   IF l_ans = 'Y' THEN
      LET g_apa.apa31 = l_apa31
      LET g_apa.apa32 = l_apa32
      LET g_apa.apa34 = l_apa34 - g_apa.apa60 - g_apa.apa61 - g_apa.apa65 + g_apa.apa37 #MOD-B50143 add apa37
      CALL t110_unpay()
   END IF

   IF l_ans1 = 'Y' THEN
      LET g_apa.apa31f= l_apa31f
      LET g_apa.apa32f= l_apa32f
      LET g_apa.apa34f= l_apa34f - g_apa.apa60f - g_apa.apa61f - g_apa.apa65f + g_apa.apa37f #MOD-B50143 add apa37f
      CALL t110_unpay()
   END IF

   #No.MOD-590312  --begin
   CALL t110_comp_oox(g_apa.apa01) RETURNING g_net
   LET g_apa.apa73=g_apa.apa34-g_apa.apa35 + g_net
   #No.MOD-590312  --end

   #-----MOD-840079---------
   LET l_cnt = 0 
   SELECT COUNT(*) INTO l_cnt FROM apb_file WHERE apb01 = g_apa.apa01
   #-----END MOD-840079-----
   IF l_ans = 'Y' THEN
      #IF g_apb_sarrno = 0 THEN   #MOD-840079
     #str MOD-890177 mod
      IF l_cnt !=0 OR g_apa.apa00='11' THEN
         UPDATE apa_file SET apa31 = l_apa31,
                             apa32 = l_apa32,
                             apa34 = g_apa.apa34,
                             apa73 = g_apa.apa73
          WHERE apa01 = g_apa.apa01
         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
#           CALL cl_err('t110_ddd_apa2',SQLCA.sqlcode,1)   #No.FUN-660122
            CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_ddd_apa2",1)  #No.FUN-660122
         END IF
      ELSE
         UPDATE apa_file SET apa31 = l_apa31,
                             apa32 = l_apa32,
                             apa34 = g_apa.apa34,
                             apa57 = g_apa.apa31,
                             apa73 = g_apa.apa73
          WHERE apa01 = g_apa.apa01
         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
#           CALL cl_err('t110_ddd_apa1',SQLCA.sqlcode,1)   #No.FUN-660122
            CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_ddd_apa1",1)  #No.FUN-660122
         END IF
      END IF
     #end MOD-890177 mod
   END IF

   IF l_ans1 = 'Y' THEN
      #IF g_apb_sarrno = 0 THEN   #MOD-840079
     #str MOD-890177 mod
      IF l_cnt !=0 OR g_apa.apa00='11' THEN
         UPDATE apa_file SET apa31f = l_apa31f,
                             apa32f = l_apa32f,
                             apa34f = g_apa.apa34f
          WHERE apa01 = g_apa.apa01
         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
#           CALL cl_err('t110_ddd_apa21',SQLCA.sqlcode,1)   #No.FUN-660122
            CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_ddd_apa21",1)  #No.FUN-660122
         END IF
      ELSE
         UPDATE apa_file SET apa31f = l_apa31f,
                             apa32f = l_apa32f,
                             apa34f = g_apa.apa34f,
                             apa57f = g_apa.apa31f
          WHERE apa01 = g_apa.apa01
         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
#           CALL cl_err('t110_ddd_apa11',SQLCA.sqlcode,1)   #No.FUN-660122
            CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_ddd_apa11",1)  #No.FUN-660122
         END IF
      END IF
     #end MOD-890177 mod
   END IF
  
  #MOD-990239   ---start
   IF l_apa32 <>0 THEN 
      SELECT gec03 INTO g_apa.apa52 FROM gec_file WHERE gec01=g_apa.apa15 AND gec011='1' 
      UPDATE apa_file SET apa52=g_apa.apa52 
       WHERE apa01=g_apa.apa01
      IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN   
         CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_ddd_apa52",1)
      END IF                                                                                                                     
   END IF  
  #MOD-990239   ---end

   SELECT apa31,apa32,apa34,apa31f,apa32f,apa34f,apa52,apa57,apa57f   #MOD-840079 增加apa57/apa57f   #MOD-990239 add apa52
     INTO g_apa.apa31,g_apa.apa32,g_apa.apa34,
          g_apa.apa31f,g_apa.apa32f,g_apa.apa34f,g_apa.apa52,g_apa.apa57,g_apa.apa57f   #MOD-840079 增加apa57/apa57f #MOD-990239 add apa52 
     FROM apa_file
    WHERE apa01=g_apa.apa01

   DISPLAY BY NAME g_apa.apa31,g_apa.apa32,g_apa.apa34,
                   g_apa.apa31f,g_apa.apa32f,g_apa.apa34f,
                   g_apa.apa52,  #MOD-990239 
                   g_apa.apa57   #MOD-840079

   #-----MOD-830213---------
   IF g_apa.apa57 > 0 AND g_apa.apa00 = '11' THEN   #MOD-840134
      LET g_apa.apa33 = g_apa.apa31 - g_apa.apa57
      LET g_apa.apa33f = g_apa.apa31f - g_apa.apa57f        
      LET g_apa.apa33 = cl_digcut(g_apa.apa33,g_azi04)   
      LET g_apa.apa33f= cl_digcut(g_apa.apa33f,t_azi04)  
      UPDATE apa_file SET apa33 = g_apa.apa33,
                          apa33f= g_apa.apa33f
       WHERE apa01 = g_apa.apa01
      IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
         CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","",1)  
      END IF
      DISPLAY BY NAME g_apa.apa33
      #-----MOD-840668---------
      IF g_apa.apa33 = 0 THEN
         LET g_apa.apa56 = '0'
         LET g_apa.apa20 = 0                      #MOD-C50242 add
         UPDATE apa_file SET apa56 = g_apa.apa56,
                             apa20 = g_apa.apa20  #MOD-C50242 add
          WHERE apa01 = g_apa.apa01
         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
            CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","",1)  
         END IF
         DISPLAY BY NAME g_apa.apa56
         DISPLAY BY NAME g_apa.apa20               #MOD-C50242 add
         CALL t110_apa56()
     #MOD-A40103---add---start---
      ELSE                           
         LET g_apa.apa56 = '1'       
         UPDATE apa_file SET apa56 = g_apa.apa56
          WHERE apa01 = g_apa.apa01
         DISPLAY BY NAME g_apa.apa56 
         CALL t110_apa56()       
     #MOD-A40103---add---end---    
      END IF
      #-----END MOD-840668-----
   END IF   #MOD-840134
   #-----END MOD-830213-----

#No.FUN-680027--begin
   IF g_apa.apa31 <>g_apa_t.apa31 OR g_apa.apa32 <> g_apa_t.apa32
      OR g_apa.apa34 <> g_apa_t.apa34 OR g_apa.apa57 <> g_apa_t.apa57
      OR g_apa.apa57 <> g_apa_t.apa57 OR g_apa.apa73 <> g_apa_t.apa73
      OR g_apa.apa31f <> g_apa_t.apa31f OR g_apa.apa32f <> g_apa_t.apa32f
      OR g_apa.apa34f <> g_apa_t.apa34f OR g_apa.apa57f <> g_apa_t.apa57f THEN
      #No.TQC-740067 --start--
#     CALL cl_err('','aap-919',0)   #No.TQC-740067 mark
      SELECT DISTINCT(pmb02) INTO l_pmb02 FROM pmb_file
       WHERE pmb01 = g_apa.apa11
      #IF l_pmb02 = 1 THEN   #MOD-7A0049
      IF l_pmb02 = 1 OR cl_null(l_pmb02) THEN   #MOD-7A0049
         DELETE FROM apc_file WHERE apc01 = g_apa.apa01
         CALL t110_ins_apc(g_apa.*)
      ELSE
         CALL t110_account_period()
      END IF
      #No.TQC-740067 --end--
   END IF

   #-----MOD-920182---------
   IF l_ans = 'Y' AND l_ans1 = 'Y' THEN
      CALL t110_gen_gl()
   END IF
   #-----END MOD-920182-----

   #CALL t110_apc_check()  #TQC-790167   #MOD-830059
   CALL t110_apc_check('')  #TQC-790167   #MOD-830059
#No.FUN-680027--end

END FUNCTION

FUNCTION t110_set_entry(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)

   IF p_cmd = 'a' AND ( NOT g_before_input_done ) THEN
      #CALL cl_set_comp_entry("apa01,apa05",TRUE)     #MOD-7A0116
      CALL cl_set_comp_entry("apa01",TRUE)     #MOD-7A0116
   END IF

   CALL cl_set_comp_entry("apa05",TRUE)     #MOD-7A0116

   IF INFIELD(apa06) THEN
      CALL cl_set_comp_entry("apa07",TRUE)
   END IF

   IF INFIELD(apa08) THEN
      CALL cl_set_comp_entry("apa31,apa31f,apa32,apa32f",TRUE)
   END IF

    #-----No:MOD-530307-----
   IF INFIELD(apa16) THEN
      CALL cl_set_comp_entry("apa52",TRUE)
      CALL cl_set_comp_entry("apa521",TRUE)         #No.FUN-680029
   END IF
    #-----No:MOD-530307 END-----
 
    CALL cl_set_comp_entry("apa08",TRUE)   #MOD-610143

    IF p_cmd = 'a' AND ( NOT g_before_input_done ) AND g_aza.aza53='Y' THEN
       CALL cl_set_comp_entry("apa100",TRUE)  #FUN-630043
    END IF

  #TQC-770027.....begin
    IF g_sn = 'y' THEN
       CALL cl_set_comp_entry("apc10,apc11",TRUE)
    END IF
  #TQC-770027.....end
  

END FUNCTION

#FUN-8A0075--BEGIN--
FUNCTION t110_set_entry_1() 
   CASE
     WHEN g_aptype = '11' OR  g_aptype = '16'
          CALL cl_set_comp_entry("apa01,apa02,apa05,apa06,apa07,apa08,apa77,apa100,apa101,apa102,      #FUN-970108 add apa77
                                  apa12,apa13,apa31,apa14,apa15,apa21,apa22,apa24,                     #MOD-AC0116
                                  apa25,apa31f,apa32f,apa36,apa11,apa32,apa57,apa64,                   #MOD-AC0116 add apa32,apa57,apa64 
                                  apa66,apa930",TRUE)
     WHEN g_aptype = '12' OR  g_aptype = '15'
          CALL cl_set_comp_entry("apa01,apa02,apa05,apa06,apa07,apa08,apa77,apa100,apa101,apa102,      #FUN-970108 add apa77 
                                  apa12,apa13,apa31,apa14,apa15,apa21,apa22,apa24,                     #MOD-AC0116   #TQC-D10016 del apa16
                                  apa25,apa31f,apa32f,apa36,apa11,apa32,apa57,apa64,                   #MOD-AC0116 add apa32,apa57,apa64 
                                  apa66,apa930",TRUE)
     WHEN g_aptype = '26' OR  g_aptype = '21'OR  g_aptype = '22'
          CALL cl_set_comp_entry("apa01,apa02,apa05,apa06,apa07,apa08,apa77,apa100,apa101,apa102,      #FUN-970108 add apa77
                                  apa12,apa13,apa31,apa14,apa15,apa21,apa22,apa24,                     #MOD-AC0116   #TQC-D10016 del apa16
                                  apa25,apa31f,apa32f,apa36,apa58,apa11,apa32,apa57,apa64,             #MOD-AC0116 add apa32,apa57,apa64 
                                  apa66,apa930",TRUE)
     WHEN g_aptype = '13'
          CALL cl_set_comp_entry("apa01,apa02,apa06,apa08,apa77,apa100,apa101,apa102,                  #FUN-970108 add apa77
                                  apa12,apa13,apa31,apa14,apa22,apa24,                                 #MOD-AC0116 
                                  apa25,apa31f,apa36,apa58,apa11,apa57,apa64,                          #MOD-AC0116 add apa57,apa64
                                  apa15,apa32f,apa34f,  #FUN-950094         #TQC-D10016 del apa16
                                  apa32,apa34,apa52,apa521,   #FUN-950094
                                  apa66,apa930",TRUE)
    WHEN g_aptype = '17'
          CALL cl_set_comp_entry("apa01,apa02,apa06,apa07,apa08,apa77,apa100,apa101,apa102,            #FUN-970108 add apa77 
                                  apa12,apa13,apa31,apa14,apa22,apa24,                                 #MOD-AC0116
                                  apa25,apa31f,apa36,apa58,apa11,apa57,apa64,                          #MOD-AC0116 add apa57,apa64
                                  apa66,apa930",TRUE) 
     END CASE
END FUNCTION
#FUN-8A0075--END--

#FUN-8A0075--BEGIN--
FUNCTION t110_set_no_entry_1() 
IF g_apa.apa63 matches '[Ss]' THEN
   CASE
     WHEN g_aptype = '11' OR  g_aptype = '16'
          CALL cl_set_comp_entry("apa01,apa02,apa05,apa06,apa07,apa08,apa77,apa100,apa101,apa102,      #FUN-970108 add apa77
                                  apa12,apa13,apa31,apa14,apa15,apa21,apa22,apa24,                     #MOD-AC0116
                                  apa25,apa31f,apa32f,apa36,apa11,apa32,apa57,apa64,                   #MOD-AC0116 add apa32,apa57,apa64 
                                  apa66,apa930",FALSE)
     WHEN g_aptype = '12' OR  g_aptype = '15'
          CALL cl_set_comp_entry("apa01,apa02,apa05,apa06,apa07,apa08,apa77,apa100,apa101,apa102,      #FUN-970108 add apa77
                                  apa12,apa13,apa31,apa14,apa15,apa21,apa22,apa24,                     #MOD-AC0116  #TQC-D10016 del apa16
                                  apa25,apa31f,apa32f,apa36,apa11,apa32,apa57,apa64,                   #MOD-AC0116 add apa32,apa57,apa64 
                                  apa66,apa930",FALSE)
     WHEN g_aptype = '26' OR  g_aptype = '21'OR  g_aptype = '22'
          CALL cl_set_comp_entry("apa01,apa02,apa05,apa06,apa07,apa08,apa77,apa100,apa101,apa102,      #FUN-970108 add apa77
                                  apa12,apa13,apa31,apa14,apa15,apa21,apa22,apa24,                     #MOD-AC0116  #TQC-D10016 del apa16
                                  apa25,apa31f,apa32f,apa36,apa58,apa11,apa32,apa57,apa64,             #MOD-AC0116 add apa32,apa57,apa64 
                                  apa66,apa930",FALSE)
     WHEN g_aptype = '13'
          CALL cl_set_comp_entry("apa01,apa02,apa06,apa08,apa77,apa100,apa101,apa102,                  #FUN-970108 add apa77
                                  apa12,apa13,apa31,apa14,apa22,apa24,                                 #MOD-AC0116 
                                  apa25,apa31f,apa36,apa58,apa11,apa57,apa64,                          #MOD-AC0116 add apa57,apa64
                                  apa66,apa930",FALSE)
    WHEN g_aptype = '17'
          CALL cl_set_comp_entry("apa01,apa02,apa06,apa07,apa08,apa77,apa100,apa101,apa102,            #FUN-970108 add apa77
                                  apa12,apa13,apa31,apa14,apa22,apa24,                                 #MOD-AC0116
                                  apa25,apa31f,apa36,apa58,apa11,apa57,apa64,                          #MOD-AC0116 add apa57,apa64
                                  apa66,apa930",FALSE) 
     END CASE
END IF
END FUNCTION
#FUN-8A0075--END--
FUNCTION t110_set_no_entry(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_n     LIKE type_file.num5    #MOD-860148 add
   DEFINE l_pmc913  LIKE pmc_file.pmc913     #No:FUN-880094
   DEFINE l_pmc14   LIKE pmc_file.pmc14  #FUN-A40036 Add
   DEFINE l_flag    LIKE type_file.chr1  #FUN-A40036 Add
   
   IF (p_cmd = 'u' AND g_chkey = 'N') AND ( NOT g_before_input_done ) THEN
      CALL cl_set_comp_entry("apa01",FALSE)
   END IF
 
  #start FUN-680110 add
   IF g_aptype='16' OR g_aptype='26' THEN
      CALL cl_set_comp_entry("apa08,apa77",FALSE)   #FUN-970108 add apa77
   END IF
  #end FUN-680110 add

   #IF g_apb_sarrno > 0 AND (g_aptype<>'12' OR g_aptype<>'22' OR g_aptype<>'13')  #No:MOD-650127  #No.FUN-690080   #MOD-7A0116
   IF g_apb_sarrno > 0 AND (g_aptype<>'12' AND g_aptype<>'22' AND g_aptype<>'13')  #MOD-7A0116
     #AND NOT cl_null(g_apa.apa05) AND g_apa.apa57 > 0 THEN   #MOD-860148 mark
      AND NOT cl_null(g_apa.apa05) THEN                       #MOD-860148
     #str MOD-860148 add
     #不判斷apa57是否>0,改判斷單身有資料才卡不可以改apa05
     #CALL cl_set_comp_entry("apa05",FALSE)
      LET l_n = 0
     #-MOD-B60156-add-
      IF g_aptype = '15' THEN
         SELECT COUNT(*) INTO l_n 
           FROM apb_file 
          WHERE apb01=g_apa.apa01
            AND apb06 IS NOT NULL
      ELSE
     #-MOD-B60156-end-
         SELECT COUNT(*) INTO l_n 
           FROM apb_file 
          WHERE apb01=g_apa.apa01
            AND apb21 IS NOT NULL #MOD-B60156
      END IF                      #MOD-B60156
      IF l_n > 0 THEN
         CALL cl_set_comp_entry("apa05",FALSE)
      END IF
     #end MOD-860148 add
   END IF

   #-----MOD-7A0116---------
   IF g_apb_sarrno > 0 AND (g_aptype = '12' AND g_apa.apa51 = 'UNAP') 
     #AND NOT cl_null(g_apa.apa05) AND g_apa.apa57 > 0 THEN   #MOD-860148 mark
      AND NOT cl_null(g_apa.apa05) THEN                       #MOD-860148
     #str MOD-860148 add
     #不判斷apa57是否>0,改判斷單身有資料才卡不可以改apa05
     #CALL cl_set_comp_entry("apa05",FALSE)
      LET l_n = 0
         SELECT COUNT(*) INTO l_n FROM apb_file WHERE apb01=g_apa.apa01
      IF l_n > 0 THEN
         CALL cl_set_comp_entry("apa05",FALSE)
      END IF
     #end MOD-860148 add
   END IF
   #-----END MOD-7A0116-----

   #FUN-A40036--Add--Begin
   LET l_flag = 'N'
   IF g_aptype = '12' THEN      
      SELECT pmc14 INTO l_pmc14
        FROM pmc_file
       WHERE pmc01 = g_apa.apa06
      IF l_pmc14 = '3' THEN
         LET l_flag = 'Y'
      END IF    
   END IF  
   #FUN-A40036--Add--End

   IF INFIELD(apa06) THEN
#     IF g_apa.apa06 != 'MISC' AND g_apa.apa06 != 'EMPL' THEN                    #FUN-A40036 Mark
      IF g_apa.apa06 != 'MISC' AND g_apa.apa06 != 'EMPL' AND l_flag = 'N'  THEN  #FUN-A40036 Add
         CALL cl_set_comp_entry("apa07",FALSE)
      END IF
   END IF

   IF INFIELD(apa08) THEN
     #IF g_apa.apa08 = 'MISC' OR (g_apa.apa08='UNAP' AND g_apa.apa00 !='12' AND g_apa.apa00 !='13') THEN  #No.FUN-690080                              #MOD-9C0012 mark
     #IF (g_apa.apa08 = 'MISC' AND g_aptype MATCHES '1*') OR (g_apa.apa08='UNAP' AND g_apa.apa00 !='12' AND g_apa.apa00 !='13') THEN  #No.FUN-690080  #MOD-9C0012 add  #No.TQC-A30079
      IF (g_apa.apa08 = 'MISC' AND g_aptype MATCHES '1*' AND g_apz.apz08 <> '3' ) OR (g_apa.apa08='UNAP' AND g_apa.apa00 !='12' AND g_apa.apa00 !='13') THEN  #No.FUN-690080  #MOD-9C0012 add  #No.TQC-A30079
         CALL cl_set_comp_entry("apa31,apa31f,apa32,apa32f",FALSE)
      END IF
   END IF
 
    #-----No:MOD-530307-----
   IF INFIELD(apa16) THEN
      IF g_apa.apa16 = 0 THEN
         CALL cl_set_comp_entry("apa52",FALSE)
         CALL cl_set_comp_entry("apa521",FALSE)     #No.FUN-680029
      END IF
   END IF
    #-----No:MOD-530307 END-----

    #-----MOD-610143---------
    #IF g_apa.apa08 = 'UNAP' THEN   #MOD-750002
    IF g_aptype='11' AND g_apa.apa08 = 'UNAP' THEN   #MOD-750002
       CALL cl_set_comp_entry("apa08,apa77",FALSE)   #FUN-970108 add apa77
    END IF
    #-----END MOD-610143-----
    IF p_cmd = 'u' OR (p_cmd='a' AND g_aza.aza53='N') THEN  #FUN-630043
       CALL cl_set_comp_entry("apa100",FALSE)
    END IF
  #TQC-770027.....begin
    IF g_sn = 'y' THEN
       CALL cl_set_comp_entry("apc03,apc03_pm,apc04,apc05,apc06,apc07,apc08,apc09,apc12,apc16",FALSE)
    END IF
  #TQC-770027.....end

  #str MOD-880080 add
  #若為直接付款,修改時不可修改金額欄位
   IF p_cmd = 'u' AND g_apa.apa55 = '2' THEN
      CALL cl_set_comp_entry("apa31,apa31f,apa32,apa32f",FALSE)
   END IF
  #end MOD-880080 add
  
  #No:FUN-880094---Begin
  IF g_aptype = '15' THEN
  SELECT pmc913 INTO l_pmc913 FROM pmc_file 
   WHERE pmc01 = g_apa.apa05
  IF g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y') THEN
     CALL cl_set_comp_entry("apa31,apa32,apa31f,apa32f",FALSE)
  END IF 
  END IF
  #No:FUN-880094---End

   #FUN-G70013 add str---
   IF g_aptype = '12' AND g_aza.aza97 = 'Y' AND g_apa.apa79 = 'N' THEN
      CALL cl_set_comp_entry("apa31,apa31f",FALSE)
   END IF
   #FUN-G70013 add end---

END FUNCTION

FUNCTION t110_set_entry_b(p_cmd)
   DEFINE p_cmd     LIKE type_file.chr1      #No.FUN-690028 VARCHAR(1)
   DEFINE l_aag05   LIKE aag_file.aag05      #NO.MOD-5B0083
   DEFINE l_no      LIKE apy_file.apyslip    #No.TQC-770056
   DEFINE l_apydmy5 LIKE apy_file.apydmy5    #No.TQC-770056
   DEFINE l_pmc913  LIKE pmc_file.pmc913     #No:FUN-880094
    
   #No.TQC-770056--begin--
   #IF NOT cl_null(g_apa.apa66) THEN        #FUN-810045
   IF NOT cl_null(g_apb[l_ac].apb35) THEN   #FUN-810045
      CALL cl_set_comp_entry("apb31",TRUE)
   END IF 
   #No.FUN-830161  --Begin
   #LET l_no = g_apa.apa01[1,g_doc_len]
   #SELECT apydmy5 INTO l_apydmy5 FROM apy_file
   # WHERE apyslip = l_no
   #IF l_apydmy5 = 'Y' THEN
   #   CALL cl_set_comp_entry("apb30",TRUE)
   #END IF 
   #No.FUN-830161  --End  
   #No.TQC-770056--end--

#MOD-5B0005
   CALL cl_set_comp_entry("apb21",TRUE)
   CALL cl_set_comp_entry("apb22",TRUE)   #FUN-7A0050 add
#END MOD-5B0005

   IF p_cmd = 'a' AND ( NOT g_before_input_done ) THEN
      CALL cl_set_comp_entry("apb11,apb08,apb10,apb23,apb24",TRUE)
   END IF

   IF g_apa.apa00='15' OR g_apa.apa00='17' OR g_apa.apa00='16'THEN   #No.FUN-690080   #MOD-850302 add apa00='16'
      CALL cl_set_comp_entry("apb12,apb27,apb09,apb28,apb25,apb251,          #No.FUN-680029
                              apb26,apb23,apb24,apb08,apb10,apb930",TRUE)  #MOD-910109 add apb930
   END IF
  
   CALL cl_set_comp_entry("apb12,apb27,apb09,apb28,apb25,apb251,apb26,apb930",TRUE)  #MOD-910109 add apb930

   #No:FUN-880094---Begin
   IF g_aptype = '15' THEN
      SELECT pmc913 INTO l_pmc913 FROM pmc_file 
       WHERE pmc01 = g_apa.apa05
      IF g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y') THEN
         CALL cl_set_comp_entry("apb23,apb24,apb08,apb10",TRUE)
      END IF 
   END IF
   #No:FUN-880094---End

   IF INFIELD(apb21) THEN
      CALL cl_set_comp_entry("apb12,apb27",TRUE)
   END IF

    #No:MOD-510035
   IF INFIELD(api04) THEN
      CALL cl_set_comp_entry("api07",TRUE)
   END IF
#No.FUN-680029--begin
   IF INFIELD(api041) THEN
      CALL cl_set_comp_entry("api07",TRUE)
   END IF
#No.FUN-680029--end

   #NO.MOD-5B0083 START---
    SELECT aag05 INTO l_aag05 FROM aag_file
     #WHERE aag01 = g_apa.apa51
     WHERE aag01 = g_apb[l_ac].apb25
        AND aag00 = g_bookno1     #No.FUN-730064
        AND aagacti = 'Y'        #No.MOD-B70280 add
    IF STATUS OR SQLCA.SQLCODE THEN
       LET l_aag05=''
    END IF
#No.FUN-680029--begin
    IF l_aag05 = 'Y' THEN
       #使用多帳別功能時,才需判斷第二部門是否要做部門管控
       IF g_aza.aza63 = 'Y' THEN   #CHI-7A0039 add 
          SELECT aag05 INTO l_aag05 FROM aag_file
           WHERE aag01 = g_apb[l_ac].apb251
             AND aag00 = g_bookno2      #No.FUN-730064
             AND aagacti = 'Y'          #No.MOD-B70280 add
          IF STATUS OR SQLCA.SQLCODE THEN
             LET l_aag05=''
          END IF
       END IF   #CHI-7A0039 add
    END IF
#No.FUN-680029--end
    #IF l_aag05 = 'Y' THEN   #CHI-840046
    IF l_aag05 = 'Y' OR    #CHI-840046
       (cl_null(g_apb[l_ac].apb25) AND cl_null(g_apb[l_ac].apb251)) THEN   #CHI-840046
       CALL cl_set_comp_entry("apb26,apb930",TRUE)  #MOD-910109 add apb930
    END IF
   #NO.MOD-5B0083 END-----
   #-----MOD-690134---------
   IF g_apa.apa00 = '11' THEN
      CALL cl_set_comp_entry("apb12,apb27",TRUE)
   END IF
   #-----END MOD-690134-----

   CALL cl_set_comp_entry("apb251",TRUE)   #MOD-7B0257

   CALL cl_set_comp_entry("apb35,apb36",TRUE)   #FUN-810045
   
END FUNCTION

#No:FUN-8A0075--BEGIN-- 
FUNCTION t110_set_entry_b_1()
   CASE
      WHEN g_aptype = '11' OR  g_aptype = '16'
         CALL cl_set_comp_entry("apb02,apb33,apb21,apb31,apb30,
                                 apb22,apb09,apb32,apb35,apb36,
                                 apb930,apb23,apb24,apb08,apb10",TRUE)
      WHEN g_aptype = '12' OR g_aptype = '13' OR g_aptype = '17'
        CALL cl_set_comp_entry("apb02,apb33,apb21,apb31,apb30,
                                apb12,apb09,apb28,apb32,apb22,apb35,apb36,
                                apb930,apb23,apb24,apb08,apb10",TRUE)
       WHEN g_aptype = '15'
        CALL cl_set_comp_entry("apb02,apb33,apb21,apb31,apb30,apb06,apb07,
                                apb12,apb09,apb28,apb32,apb35,apb36,
                                apb930,apb23,apb24,apb08,apb10",TRUE)
       WHEN g_aptype = '21' OR g_aptype = '26'
        CALL cl_set_comp_entry("apb02,apb33,apb11,apb22,apb21,apb31,apb30,
                                ,apb09,apb32,apb35,apb36,
                                apb930,apb23,apb24,apb08,apb10",TRUE)
       WHEN g_aptype = '22'
         CALL cl_set_comp_entry("apb02,apb33,apb11,apb21,apb31,apb30,
                                 apb12,apb28,apb22,apb09,apb32,apb35,apb36,
                                 apb930,apb23,apb24,apb08,apb10",TRUE)
   END CASE
END FUNCTION 

FUNCTION t110_set_no_entry_b_1()
IF g_apa.apa63 matches '[Ss]' THEN
   CASE
      WHEN g_aptype = '11' OR  g_aptype = '16'
         CALL cl_set_comp_entry("apb02,apb33,apb21,apb31,apb30,
                                 apb22,apb09,apb32,apb35,apb36,
                                 apb930,apb23,apb24,apb08,apb10",FALSE)
      WHEN g_aptype = '12' OR g_aptype = '13' OR g_aptype = '17' 
        CALL cl_set_comp_entry("apb02,apb33,apb21,apb31,apb30,
                                apb12,apb09,apb28,apb32,apb22,apb35,apb36,
                                apb930,apb23,apb24,apb08,apb10",FALSE)
       WHEN g_aptype = '15'
        CALL cl_set_comp_entry("apb02,apb33,apb21,apb31,apb30,apb06,apb07,
                                apb12,apb09,apb28,apb32,apb35,apb36,
                                apb930,apb23,apb24,apb08,apb10",FALSE)
       WHEN g_aptype = '21' OR g_aptype = '26'
        CALL cl_set_comp_entry("apb02,apb33,apb11,apb22,apb21,apb31,apb30,
                                ,apb09,apb32,apb35,apb36,
                                apb930,apb23,apb24,apb08,apb10",FALSE)
       WHEN g_aptype = '22'
         CALL cl_set_comp_entry("apb02,apb33,apb11,apb21,apb31,apb30,
                                 apb12,apb28,apb22,apb09,apb32,apb35,apb36,
                                 apb930,apb23,apb24,apb08,apb10",FALSE)
   END CASE
END IF
END FUNCTION  
#No:FUN-8A0075--END--
FUNCTION t110_set_no_entry_b(p_cmd)
   DEFINE p_cmd     LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_aag05   LIKE aag_file.aag05
   DEFINE l_no      LIKE apy_file.apyslip  #No.TQC-770056
   DEFINE l_apydmy5 LIKE apy_file.apydmy5  #No.TQC-770056
   DEFINE l_pmc913        LIKE pmc_file.pmc913  #No:FUN-880094

  #FUN-810045 remark begin
   #No.TQC-770056--begin--
   #IF cl_null(g_apa.apa66) THEN       
   #   CALL cl_set_comp_entry("apb31",FALSE)
   #END IF 
  #FUN-810045 remark end

 #FUN-810045 begin
   IF NOT cl_null(g_apb[l_ac].apb06)  THEN
      CALL cl_set_comp_entry("apb35,apb36",FALSE)
   END IF
 #FUN-810045 end

   #No.FUN-830161  --Begin
   #LET l_no = g_apa.apa01[1,g_doc_len]
   #SELECT apydmy5 INTO l_apydmy5 FROM apy_file
   # WHERE apyslip = l_no
   #IF l_apydmy5 = 'N' THEN
   #   CALL cl_set_comp_entry("apb30",FALSE)
   #END IF 
   #No.FUN-830161  --End  
   #No.TQC-770056--end--

   IF g_aza.aza26 = '2' THEN
      CALL cl_set_comp_entry("apb11",FALSE)
   END IF

   #IF (g_aptype='11' OR g_aptype='21') AND g_apz.apz16 = 'N' THEN      #No:BUG-510014  #No:MOD-510091   #MOD-660093
   IF (g_aptype='11' OR (g_aptype='21' AND g_apa.apa58='2')) AND g_apz.apz16 = 'N' THEN    #MOD-660093
       CALL cl_set_comp_entry("apb08,apb10,apb23,apb24",FALSE)
   END IF

   IF (g_apa.apa00 = '15' OR g_apa.apa00 = '17') AND NOT cl_null(g_apb[l_ac].apb06) THEN  #No.FUN-690080
     #str MOD-920170 add
      IF cl_null(g_apa.apa51) THEN
         CALL cl_set_comp_entry("apb12,apb27,apb28",FALSE)   #CHI-B70013 remove apb09
      ELSE
     #end MOD-920170 add
         CALL cl_set_comp_entry("apb12,apb27,apb28,apb25,apb251",FALSE)   #MOD-920170 mod  #CHI-B70013 remove apb09
      #  CALL cl_set_comp_entry("apb12,apb27,apb09,apb28,apb25,apb251,apb26,apb930",FALSE)  #No.FUN-680029  #MOD-910109 add apb930
      #                          apb26,apb23,apb24,apb08,apb10",FALSE)     #FUN-880093 mark 
      #                          apb26",FALSE)                             #FUN-880094 mark
      END IF   #MOD-920170 add
   END IF
   
   #--NO.FUN-880094 start---
   IF (g_apa.apa00 = '17') AND NOT cl_null(g_apb[l_ac].apb06) THEN 
      CALL cl_set_comp_entry("apb23,apb24,apb08,apb10",FALSE)
   END IF

  #MOD-A30230---mark---start---
  #IF g_apa.apa00 = '15' THEN
  #   SELECT pmc913 INTO l_pmc913 FROM pmc_file 
  #    WHERE pmc01 = g_apa.apa05
  #  #IF g_apz.apz61 = '2' OR (g_apz.apz61 = '3' AND l_pmc913 ='N') THEN     #MOD-A30045 mark
  #   IF g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='N') THEN     #MOD-A30045 add 
  #      CALL cl_set_comp_entry("apb23,apb24,apb08,apb10",FALSE)
  #   END IF
  #END IF 
  #MOD-A30230---mark---end---
   #---NO.FUN-880094 end-----

  #CALL cl_set_comp_entry("apb12,apb27,apb09,apb28,apb25,apb251,apb26",FALSE)   #No.FUN-680029   #MOD-8C0224 mark

  #str MOD-850302 add
  #執行aapt160,當單身入庫單號(apb21)有值,單身欄位(由入庫單帶入)不可修改,
  #但當apz16='Y'時,單價、金額等欄位要開放可修改
   IF g_apa.apa00 = '16' AND NOT cl_null(g_apb[l_ac].apb21) THEN
      CALL cl_set_comp_entry("apb12,apb27,apb09,apb28",FALSE)
      IF g_apz.apz16 = 'N' THEN
         CALL cl_set_comp_entry("apb23,apb24,apb08,apb10",FALSE)
      END IF
   END IF
  #end MOD-850302 add

   IF INFIELD(apb21) THEN
      IF g_aptype = '21' AND NOT cl_null(g_apb[l_ac].apb21) THEN
         CALL cl_set_comp_entry("apb12,apb27",FALSE)
      END IF

#FUN-810045 remark begin
##MOD-5B0005
#     #IF (g_aptype = '12' OR g_aptype = '15' OR g_aptype = '13' OR g_aptype = '17') AND cl_null(g_apa.apa66) THEN  #No.FUN-690080       
#     IF (g_aptype = '12' OR g_aptype = '15' OR g_aptype = '13' OR g_aptype = '17') AND cl_null(g_apb[l_ac].apb35) THEN  #No.FUN-690080  #FUN-810045
#        #CALL cl_set_comp_entry("apb21",FALSE) #FUN-630055 remark
#        CALL cl_set_comp_entry("apb31",FALSE)  #FUN-630055 add
#     END IF
##END MOD-5B0005
#FUN-810045 remark end

   END IF

   #NO.MOD-5B0083 START---
    SELECT aag05 INTO l_aag05 FROM aag_file
     #WHERE aag01 = g_apa.apa51
     WHERE aag01 = g_apb[l_ac].apb25
       AND aag00 = g_bookno1       #No.FUN-730064
       AND aagacti = 'Y'     #No.MOD-B70280 add
    IF STATUS OR SQLCA.SQLCODE THEN
       LET l_aag05=''
    END IF
    #-----CHI-840046---------
    IF l_aag05 = 'Y' THEN
       #使用多帳別功能時,才需判斷第二部門是否要做部門管控
       IF g_aza.aza63 = 'Y' THEN    
          SELECT aag05 INTO l_aag05 FROM aag_file
           WHERE aag01 = g_apb[l_ac].apb251
             AND aag00 = g_bookno2    
             AND aagacti = 'Y'     #No.MOD-B70280 add
          IF STATUS OR SQLCA.SQLCODE THEN
             LET l_aag05=''
          END IF
       END IF   
    END IF
    #-----END CHI-840046-----
    IF l_aag05 = 'N' THEN    #MOD-840119   #CHI-840046 取消mark
    #IF l_aag05 = 'N' OR cl_null(g_apb[l_ac].apb25) THEN    #MOD-840119   #CHI-840046 mark
        #FUN-710078---mod---str---
         CALL cl_set_comp_entry("apb26,b26,apb930",FALSE)   #MOD-910109 add apb930
         LET g_apb[l_ac].apb26 = NULL
         LET g_apb[l_ac].b26 = NULL
         LET g_apb[l_ac].apb930= NULL   #MOD-910109 add
         DISPLAY BY NAME g_apb[l_ac].apb26,g_apb[l_ac].b26
         DISPLAY BY NAME g_apb[l_ac].apb930   #MOD-910109 add
        #CALL cl_set_comp_entry("apb26",FALSE)
        #LET g_apb[l_ac].apb26 = NULL
        #DISPLAY BY NAME g_apb[l_ac].apb26
        #FUN-710078---mod---end---
    END IF
   #NO.MOD-5B0083 END-----
   #-----MOD-690134---------
   IF g_apa.apa00 = '11' THEN
      CALL cl_set_comp_entry("apb12,apb27",FALSE)
   END IF
   #-----END MOD-690134-----
   #-----MOD-7B0257---------
   IF g_aza.aza63 ='N' THEN
      CALL cl_set_comp_entry("apb251",FALSE)   
   END IF
   #-----END MOD-7B0257-----
   
END FUNCTION

FUNCTION t110_set_entry_api(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)

    IF INFIELD(api04) OR INFIELD(api041) OR (p_cmd = 'a' AND (NOT g_before_input_done)) THEN       #No:MOD-530494  No.FUN-680029
     #CALL cl_set_comp_entry("api07,api21,api22,api23,api24,api25,api26",TRUE)  #No.FUN-830161
      CALL cl_set_comp_entry("api07,api21,api22,api23,api24,api26",TRUE)        #No.FUN-830161

      #FUN-5C0015 BY GILL --START
      CALL cl_set_comp_entry("api31,api32,api33,api34,api35,api36,api37",TRUE)
      #FUN-5C0015 BY GILL --END

   END IF

END FUNCTION

#FUN-5C0015 BY GILL --START
#FUNCTION t110_set_no_entry_api(m_aag05,m_aag21,m_aag23,m_aag151,m_aag161,m_aag171,m_aag181)
FUNCTION t110_set_no_entry_api(m_aag05,m_aag21,m_aag23,m_aag151,m_aag161,
         m_aag171,m_aag181,m_aag311,m_aag321,m_aag331,m_aag341,m_aag351,
         m_aag361,m_aag371)

#FUN-5C0015 BY GILL --END

   DEFINE m_aag05       LIKE aag_file.aag05
   DEFINE m_aag21       LIKE aag_file.aag21
   DEFINE m_aag23       LIKE aag_file.aag23
   DEFINE m_aag151      LIKE aag_file.aag151
   DEFINE m_aag161      LIKE aag_file.aag161
   DEFINE m_aag171      LIKE aag_file.aag171
   DEFINE m_aag181      LIKE aag_file.aag181

   #FUN-5C0015 BY GILL --START
   DEFINE m_aag311       LIKE aag_file.aag311
   DEFINE m_aag321       LIKE aag_file.aag321
   DEFINE m_aag331       LIKE aag_file.aag331
   DEFINE m_aag341       LIKE aag_file.aag341
   DEFINE m_aag351       LIKE aag_file.aag351
   DEFINE m_aag361       LIKE aag_file.aag361
   DEFINE m_aag371       LIKE aag_file.aag371
   #FUN-5C0015 BY GILL --END

   IF m_aag05 = 'N' THEN
      CALL cl_set_comp_entry("api07",FALSE)
   END IF

   #No.FUN-830161  --Begin
    IF m_aag21 = 'N' OR cl_null(m_aag21) THEN  #MOD-B10093 remark
   #   CALL cl_set_comp_entry("api25",FALSE)
       CALL cl_set_comp_entry("api36",FALSE)   #MOD-B10093 
    END IF                                     #MOD-B10093 remark
   #No.FUN-830161  --End  

   IF m_aag23 = 'N' OR cl_null(m_aag23) THEN
      CALL cl_set_comp_entry("api26",FALSE)
      CALL cl_set_comp_entry("api35",FALSE)    #MOD-B10093
   END IF

   IF cl_null(m_aag151) THEN
      CALL cl_set_comp_entry("api21",FALSE)
   END IF

   IF cl_null(m_aag161) THEN
      CALL cl_set_comp_entry("api22",FALSE)
   END IF

   IF cl_null(m_aag171) THEN
      CALL cl_set_comp_entry("api23",FALSE)
   END IF

   IF cl_null(m_aag181) THEN
      CALL cl_set_comp_entry("api24",FALSE)
   END IF

   #FUN-5C0015 BY GILL --START
   IF cl_null(m_aag311) THEN
      CALL cl_set_comp_entry("api31",FALSE)
   END IF
   IF cl_null(m_aag321) THEN
      CALL cl_set_comp_entry("api32",FALSE)
   END IF
   IF cl_null(m_aag331) THEN
      CALL cl_set_comp_entry("api33",FALSE)
   END IF
   IF cl_null(m_aag341) THEN
      CALL cl_set_comp_entry("api34",FALSE)
   END IF
  #-MOD-B10093-mark-
  #IF cl_null(m_aag351) THEN
  #   CALL cl_set_comp_entry("api35",FALSE)
  #END IF
  #IF cl_null(m_aag361) THEN
  #   CALL cl_set_comp_entry("api36",FALSE)
  #END IF
  #-MOD-B10093-end-
   IF cl_null(m_aag371) THEN
      CALL cl_set_comp_entry("api37",FALSE)
   END IF
   #FUN-5C0015 BY GILL --END
   
   #NO.FUN-950053 --begin--
   IF g_pmc903 = 'N' AND m_aag371 MATCHES '[4]'  THEN    
    CALL cl_set_comp_entry("api37",FALSE)
   END IF
   #No.FUN-950053 --end--

END FUNCTION

FUNCTION t110_set_entry_apv(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)

   CALL cl_set_comp_entry("apv03",TRUE)
   #No.MOD-580365  --begin
   IF p_cmd = 'F' THEN
      CALL cl_set_comp_entry("apv04f",TRUE)
   END IF
   #No.MOD-580365  --end
   #-----MOD-680029---------
   IF p_cmd = 'D' THEN
      CALL cl_set_comp_entry("apv04f,apv04",TRUE)
   END IF
   #-----END MOD-680029-----
END FUNCTION

FUNCTION t110_set_no_entry_apv(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)

   IF p_cmd = 'u' THEN
      CALL cl_set_comp_entry("apv03",FALSE)
   END IF
   #No.MOD-580365  --begin
   IF p_cmd = 'F' THEN
      CALL cl_set_comp_entry("apv04f",FALSE)
   END IF
   #No.MOD-580365  --end
   #-----MOD-680029---------
   IF p_cmd = 'D' THEN
      CALL cl_set_comp_entry("apv04f,apv04",FALSE)
   END IF
   #-----END MOD-680029-----
END FUNCTION

#CHI-940018  mark->t110_set_entry_apk_120()
#FUNCTION t110_set_entry_apk()
#
#   CALL cl_set_comp_entry("apk03",TRUE)
#   CALL cl_set_comp_entry("apk12,apk13",TRUE)   #TQC-620113
#
#END FUNCTION
#
##CHI-940018  mark->t110_set_entry_apk_120()
#FUNCTION t110_set_no_entry_apk()
#
##No.CHI-5A0001-begin
##  IF g_apa.apa08 != 'MISC' THEN
##     CALL cl_set_comp_entry("apk03",FALSE)
##  END IF
# 
# IF g_aptype MATCHES '1*' THEN
#   IF g_apa.apa08 != 'MISC' THEN
#      CALL cl_set_comp_entry("apk03",FALSE)
#   END IF
# END IF
# 
# IF g_aptype MATCHES '2*' THEN
#   IF g_apb[l_ac].apb11 != 'MISC' THEN
#      CALL cl_set_comp_entry("apk03",FALSE)
#   END IF
# END IF
#
# CALL cl_set_comp_entry("apk12,apk13",FALSE)   #TQC-620113
##No.CHI-5A0001-end
#
#END FUNCTION
##CHI-940018  mark->t110_set_entry_apk_120()

FUNCTION t110_set_entry_ans()

   IF INFIELD(ans1) THEN
      CALL cl_set_comp_entry("apa31f,apa32f",TRUE)
   END IF

END FUNCTION

FUNCTION t110_set_no_entry_ans(l_ans1)
   DEFINE l_ans1     LIKE type_file.chr1      # No:FUN-690028 VARCHAR(01)

   IF INFIELD(ans1) THEN
      IF l_ans1='N' THEN
         CALL cl_set_comp_entry("apa31f,apa32f",FALSE)
      END IF
   END IF

END FUNCTION

 #MOD-490018
FUNCTION t110_set_attr()
   DEFINE lw_window      ui.Window
   DEFINE lf_form        ui.Form
   DEFINE lnode_root     om.DomNode
   DEFINE lnode_frm      om.DomNode
 
   WHENEVER ERROR CALL cl_err_msg_log
 
   LET lnode_root = ui.Interface.getRootNode()
   LET lw_window = ui.Window.getCurrent()
   LET lf_form = lw_window.getForm()
   LET lnode_frm = lf_form.getNode()

   CALL t110_set_attr2(lnode_frm)

  #str FUN-7A0050 add
   IF g_aptype = '12' THEN
      CALL cl_set_comp_visible("apb11,apb29,apb06,apb07, 
                                apb24,apb08,apb10",FALSE)
   ELSE
  #end FUN-7A0050 add
      CALL cl_set_comp_visible("apb11,apb29,apb21,apb22,apb06,apb07, 
                                apb24,apb08,apb10",FALSE)
   ENd IF   #FUN-7A0050 add

END FUNCTION

FUNCTION t110_set_attr2(pnode_frm)
   DEFINE pnode_frm        om.DomNode
   DEFINE lnode_child      om.DomNode
   DEFINE ls_tagName       STRING
   DEFINE ls_name          STRING
   DEFINE ls_text          LIKE ze_file.ze03    # No:FUN-690028 VARCHAR(255)
   DEFINE ls_elementList   STRING
   DEFINE l_str            STRING   #MOD-750064
 
   LET ls_text=cl_getmsg('aap-400',g_lang)
 
   LET ls_elementList = "Page, Group, Label, FormField, Matrix, Button, TableColumn"
 
   LET lnode_child = pnode_frm.getFirstChild()
   WHILE lnode_child IS NOT NULL
      LET ls_tagName = lnode_child.getTagName()
     #DISPLAY ls_tagName
      IF ls_elementList.getIndexOf(ls_tagName, 1) THEN
         LET ls_name = lnode_child.getAttribute("colName")

         IF cl_null(ls_name) THEN
            LET ls_name = lnode_child.getAttribute("name")
         END IF

         IF NOT cl_null(ls_name) THEN
            IF ls_tagName="TableColumn" THEN
              #DISPLAY ls_name
               CALL lnode_child.setAttribute("text","---")


           #FUN-920077---add---start--------------------------------
           #當aaps100參數設定為apz59="N"時，單身的欄位名稱會到此來抓取
           #所以要在這裡設定單身欄位名稱                            
           #若沒設定到，畫面上單身欄位名稱會顯示為"---"             
           #
              IF ls_name.equals("apb35") THEN
                 LET l_str = cl_getmsg('aap-426',g_lang)
                 CALL lnode_child.setAttribute("text",l_str) #專案代號
              END IF
            
              IF ls_name.equals("apb36") THEN
                 LET l_str = cl_getmsg('aap-427',g_lang)
                 CALL lnode_child.setAttribute("text",l_str) #WBS編號
              END IF
            
              IF ls_name.equals("b25") THEN
                 LET l_str = cl_getmsg('aap-428',g_lang)
                 CALL lnode_child.setAttribute("text",l_str) #科目名稱
              END IF
            
              IF ls_name.equals("b26") THEN
                 LET l_str = cl_getmsg('aap-429',g_lang)
                 CALL lnode_child.setAttribute("text",l_str) #部門名稱
              END IF
            
              IF ls_name.equals("apb930") THEN
                 LET l_str = cl_getmsg('aap-430',g_lang)
                 CALL lnode_child.setAttribute("text",l_str) #成本中心
              END IF
            
              IF ls_name.equals("gem02c") THEN
                 LET l_str = cl_getmsg('aap-431',g_lang)
                 CALL lnode_child.setAttribute("text",l_str) #部門名稱
              END IF
            
              IF ls_name.equals("apb21") THEN
                 LET l_str = cl_getmsg('aap-432',g_lang)
                 CALL lnode_child.setAttribute("text",l_str) #暫估單號
              END IF
            
              IF ls_name.equals("apb22") THEN
                 LET l_str = cl_getmsg('aap-433',g_lang)
                 CALL lnode_child.setAttribute("text",l_str) #暫估項次
              END IF
           #FUN-920077---add---end-------------------------------------


               IF ls_name.equals("apb12") THEN
                  #-----MOD-750064---------
                 #LET l_str = cl_getmsg('aap-411',g_lang)   #TQC-910032 mark
                  LET l_str = cl_getmsg('aap-404',g_lang)   #TQC-910032
                  #CALL lnode_child.setAttribute("text",ls_text[1,8]) #品號
                  CALL lnode_child.setAttribute("text",l_str) #品號
                  #-----END MOD-750064----- 
               END IF

               IF ls_name.equals("apb27") THEN
                  #-----MOD-750064---------
                  LET l_str = cl_getmsg('aap-412',g_lang)   
                  #CALL lnode_child.setAttribute("text",ls_text[9,16]) #統一編號
                  CALL lnode_child.setAttribute("text",l_str) #統一編號
                  #-----END MOD-750064----- 
               END IF

               IF ls_name.equals("apb09") THEN
                  #-----MOD-750064---------
                  LET l_str = cl_getmsg('aap-413',g_lang)   
                  #CALL lnode_child.setAttribute("text",ls_text[17,24]) #未稅金額
                  CALL lnode_child.setAttribute("text",l_str) #未稅金額
                  #-----END MOD-750064----- 
               END IF

               IF ls_name.equals("apb28") THEN
                  #-----MOD-750064---------
                  LET l_str = cl_getmsg('aap-414',g_lang)   
                  #CALL lnode_child.setAttribute("text",ls_text[25,28]) #格式
                  CALL lnode_child.setAttribute("text",l_str) #格式
                  #-----END MOD-750064----- 
               END IF

               IF ls_name.equals("apb25") THEN
                  #-----MOD-750064---------
                  LET l_str = cl_getmsg('aap-415',g_lang)   
                  #CALL lnode_child.setAttribute("text",ls_text[29,36]) #科目編號
                  CALL lnode_child.setAttribute("text",l_str) #科目編號
                  #-----END MOD-750064----- 
               END IF

               IF ls_name.equals("apb26") THEN
                  #-----MOD-750064---------
                  LET l_str = cl_getmsg('aap-416',g_lang)  
                  #CALL lnode_child.setAttribute("text",ls_text[37,40]) #部門
                  CALL lnode_child.setAttribute("text",l_str) #部門
                  #-----END MOD-750064----- 
               END IF

               IF ls_name.equals("apb23") THEN
                  #-----MOD-750064---------
                  LET l_str = cl_getmsg('aap-413',g_lang)   
                  #CALL lnode_child.setAttribute("text",ls_text[17,24]) #未稅金額
                  CALL lnode_child.setAttribute("text",l_str) #未稅金額
                  #-----END MOD-750064----- 
               END IF

               IF ls_name.equals("apb02") THEN
                  #-----MOD-750064---------
                  LET l_str = cl_getmsg('aap-417',g_lang)   
                  #CALL lnode_child.setAttribute("text",ls_text[41,44]) #項次
                  CALL lnode_child.setAttribute("text",l_str) #項次
                  #-----END MOD-750064----- 
               END IF

               #-----MOD-750064---------
               IF ls_name.equals("apb31") THEN
                  LET l_str = cl_getmsg('aap-418',g_lang)   
                  CALL lnode_child.setAttribute("text",l_str) #專案費用代號
               END IF
               IF ls_name.equals("apb251") THEN
                  LET l_str = cl_getmsg('aap-421',g_lang)   
                  CALL lnode_child.setAttribute("text",l_str) #科目編號二
               END IF
               #No.FUN-830161  --Begin
               #IF ls_name.equals("apb30") THEN
               #   LET l_str = cl_getmsg('aap-422',g_lang)   
               #   CALL lnode_child.setAttribute("text",l_str) #預算編號
               #END IF
               #No.FUN-830161  --End  
               IF ls_name.equals("apb32") THEN
                  LET l_str = cl_getmsg('aap-423',g_lang)   
                  CALL lnode_child.setAttribute("text",l_str) #員工編號
               END IF
               IF ls_name.equals("apb33") THEN
                  LET l_str = cl_getmsg('aap-424',g_lang)   
                  CALL lnode_child.setAttribute("text",l_str) #報銷明細說明
               END IF
               #-----END MOD-750064-----

            END IF
         END IF
      END IF

      CALL t110_set_attr2(lnode_child)
      LET lnode_child = lnode_child.getNext()
   END WHILE

END FUNCTION
#--
 ### MOD-4A0253 ###
#FUN-550042
FUNCTION t110_ef()

    CALL s_showmsg_init() #CHI-A80031 add
    CALL t110_firm1_chk()     #CALL 原確認的 check 段   #FUN-580114
    CALL s_showmsg()             #MOD-C10214 add
    IF g_success = "N" THEN
        RETURN
    END IF
   #CALL s_showmsg()            #CHI-A80031 add #MOD-C10214 mark

   CALL aws_condition()      #判斷送簽資料
   IF g_success = 'N' THEN
       RETURN
   END IF
##########
# CALL aws_efcli2()
# 傳入參數: (1)單頭資料, (2-6)單身資料
# 回傳值  : 0 開單失敗; 1 開單成功
##########
   IF aws_efcli2(base.TypeInfo.create(g_apa),base.TypeInfo.create(g_apb),'','','','')
   THEN
      LET g_success = 'Y'
      LET g_apa.apa63 = 'S'   #開單成功, 更新狀態碼為 'S. 送簽中'
      DISPLAY BY NAME g_apa.apa63
   ELSE
      LET g_success = 'N'
   END IF

END FUNCTION
 ### END MOD-4A0253 ###


 #MOD-4B0308
FUNCTION t110_21_ins2(l_apa)
   DEFINE l_apa   RECORD LIKE apa_file.*,
          l_apb   RECORD LIKE apb_file.*,
          toapk   RECORD LIKE apk_file.*,
          l_azi04        LIKE azi_file.azi04,
          l_tax          LIKE apb_file.apb10,
          l_taxf         LIKE apb_file.apb10,
          l_cnt          LIKE type_file.num5    #FUN-890128
   DEFINE g_t1           LIKE oay_file.oayslip  #FUN-990014 add
   
   INITIALIZE toapk.* TO NULL

   SELECT azi04 INTO l_azi04 FROM azi_file WHERE azi01 = l_apa.apa13

  #str CHI-850032 add
  #在確認段寫入apk_file前,先檢核apk_file是否存在,若是則先刪除再新增
  SELECT COUNT(*) INTO l_cnt FROM apk_file WHERE apk01=l_apa.apa01  #FUN-890128
  If l_cnt > 0 THEN   #FUN-890128
     DELETE FROM apk_file WHERE apk01=l_apa.apa01
     IF SQLCA.SQLCODE OR STATUS THEN
       #CALL cl_err('del 21_apk:',SQLCA.SQLCODE,1)   #No.FUN-660122
        CALL cl_err3("del","apk_file",l_apa.apa01,"",SQLCA.sqlcode,"","del 21_apk:",1)  #No.FUN-660122
        LET g_success = 'N'   #FUN-890128
     END IF
  END IF   #FUN-890128
  #end CHI-850032 add

   DECLARE t110_21_ins2 CURSOR FOR SELECT * FROM apb_file
                                    WHERE apb01 = l_apa.apa01

   FOREACH t110_21_ins2 INTO l_apb.*
      IF STATUS THEN
         CALL cl_err('foreach 21',STATUS,1)  
         LET g_success='N'
         EXIT FOREACH
      END IF
      LET toapk.apk01 = l_apb.apb01                    #折讓單
      LET toapk.apk02 = l_apb.apb02                    #項次
      LET toapk.apk03 = l_apb.apb11                    #發票號碼
      LET toapk.apk04 = l_apa.apa18                    #統一編號
      LET toapk.apk05 = NULL                           #MOD-AC0124
      #-----MOD-750014---------
      #LET toapk.apk05 = l_apa.apa09                    #發票日期
      DECLARE t110_apk05_c SCROLL CURSOR FOR 
        SELECT apk05 FROM apk_file WHERE apk03=toapk.apk03
      OPEN t110_apk05_c
      FETCH FIRST t110_apk05_c INTO toapk.apk05
      CLOSE t110_apk05_c
      #-----END MOD-750014-----
     #-MOD-AC0124-add-
      IF cl_null(toapk.apk05) THEN
         DECLARE t110_amd05_c SCROLL CURSOR FOR 
           SELECT amd05 FROM amd_file WHERE amd03=toapk.apk03
         OPEN t110_amd05_c
         FETCH FIRST t110_amd05_c INTO toapk.apk05
         CLOSE t110_amd05_c
      END IF 
     #-MOD-AC0124-end-
      LET l_tax = l_apb.apb10 * l_apa.apa16 /100
     #CALL cl_digcut(l_tax ,l_azi04) RETURNING l_tax   #No.TQC-CC0035   Mark
      CALL cl_digcut(l_tax ,g_azi04) RETURNING l_tax   #No.TQC-CC0035   Add
      LET toapk.apk07 = l_tax                        #稅額
      LET toapk.apk08 = l_apb.apb10                    #未稅金額
      LET toapk.apk06 = toapk.apk07 + toapk.apk08    #含稅金額
      LET toapk.apk06 = cl_digcut(toapk.apk06,g_azi04)
      LET toapk.apk07 = cl_digcut(toapk.apk07,g_azi04)
      LET toapk.apk08 = cl_digcut(toapk.apk08,g_azi04)
      LET toapk.apk11 = l_apa.apa15
      LET toapk.apk29 = l_apa.apa16
      LET toapk.apk12 = l_apa.apa13
      LET toapk.apk13 = l_apa.apa14
      LET toapk.apk07f = l_apb.apb24 * toapk.apk29 / 100
      LET toapk.apk08f = l_apb.apb24
      LET toapk.apk06f = toapk.apk07f + toapk.apk08f
      LET toapk.apk06f = cl_digcut(toapk.apk06f,l_azi04)
      LET toapk.apk07f = cl_digcut(toapk.apk07f,l_azi04)
      LET toapk.apk08f = cl_digcut(toapk.apk08f,l_azi04)
      LET toapk.apk09 = ' '
      LET toapk.apk10 = ' '
      #-----MOD-5B0040---------
      #LET toapk.apk17 = l_apa.apa17
      SELECT DISTINCT apk17 INTO toapk.apk17 FROM apk_file
        WHERE apk03 = l_apb.apb11
      #-----END MOD-5B0040-----

      #-----MOD-6B0051---------
      #IF l_apa.apa171 = '21' THEN
      #   LET toapk.apk171 = '23'
      #ELSE
      #   LET toapk.apk171 = '24'
      #END IF
      LET toapk.apk171  = l_apa.apa171    #MOD-AC0128 
     #str MOD-B40050 mod
     #CASE l_apa.apa171
     #   WHEN '21'
     #     LET toapk.apk171 = '23'
     #   WHEN '26'                   #MOD-850320 add  #MOD-AC0128 mod  
     #     LET toapk.apk171 = '23'   #MOD-850320 add
     #   WHEN '25'                   #MOD-860179 add
     #     LET toapk.apk171 = '23'   #MOD-860179 add
     #   WHEN '28'
     #     LET toapk.apk171 = '29'
     #   WHEN 'XX'
     #     LET toapk.apk171 = 'XX'
     #   OTHERWISE
     #     LET toapk.apk171 = '24'
     #END CASE
      CASE 
         WHEN (l_apa.apa171 = '21' OR l_apa.apa171 = '25' OR l_apa.apa171 = '26')
           LET toapk.apk171  = '23' 
         WHEN (l_apa.apa171 = '22' OR l_apa.apa171 = '27')
           LET toapk.apk171  = '24'
         WHEN (l_apa.apa171 = '28')
           LET toapk.apk171  = '29'
         WHEN (l_apa.apa171 = 'XX')
           LET toapk.apk171  = 'XX'
      END CASE 
     #end MOD-B40050 mod
      #-----END MOD-6B0051-----
 
      LET toapk.apk172 = l_apa.apa172
      LET toapk.apk173 = 0
      LET toapk.apk174 = 0
     #LET toapk.apk175 = 0      #MOD-A30142 mark
      LET toapk.apk175 = NULL   #MOD-A30142 add
      LET toapk.apk22 = ' '
      LET toapk.apk25 = l_apb.apb12
      LET toapk.apk26 = ''
      LET toapk.apk27 = ''
      LET toapk.apkacti = 'Y'
      LET toapk.apkuser = g_user
      LET toapk.apkgrup = g_grup
      LET toapk.apkdate = today
      #FUN-990014--Begin
     ##FUN-970108---Begin
     #IF NOT cl_null(g_apa.apa77) THEN 
     #   LET toapk.apk32 = g_apa.apa77
     #ELSE 
     #	 LET toapk.apk32 = g_apz.apz63
     #END IF 	  
     ##FUN-970108---End
      CALL s_get_doc_no(toapk.apk01) RETURNING g_t1
      SELECT apyvcode INTO toapk.apk32  FROM apy_file WHERE apyslip = g_t1   
        IF cl_null(toapk.apk32) THEN 
           LET toapk.apk32 = g_apz.apz63  
        END IF     
     #FUN-990014---End
     
      INSERT INTO apk_file VALUES (toapk.*)
     
      IF STATUS OR SQLCA.SQLCODE THEN
     #    CALL cl_err('21_ins2_apk:',SQLCA.sqlcode,1)   #No.FUN-660122
         CALL cl_err3("ins","apk_file",toapk.apk01,toapk.apk02,SQLCA.sqlcode,"","21_ins2_apk:",1)  #No.FUN-660122
         LET g_success = 'N'
      END IF

   END FOREACH

END FUNCTION
#--

#MOD-580365  --begin
FUNCTION t110_sumf(p_apk02,p_apk03,p_apk06f,p_apk07f,p_apk08f,p_apk171)
DEFINE p_i         LIKE type_file.num5      # No:FUN-690028 SMALLINT
DEFINE l_tot1      LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)
DEFINE l_tot2      LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)
DEFINE l_tot3      LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)
DEFINE l_tot28     LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)
DEFINE l_totl1     LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)
DEFINE l_totl2     LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)
DEFINE l_totl3     LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)
DEFINE l_totl11    LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)
DEFINE l_totl21    LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)
DEFINE l_totl31    LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)
DEFINE l_totl28    LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)
DEFINE l_apk08f    LIKE apk_file.apk08f
DEFINE l_t028      LIKE apk_file.apk08f
DEFINE l_apk07f    LIKE apk_file.apk07f
DEFINE l_apk06f    LIKE apk_file.apk06f
DEFINE p_apk02     LIKE apk_file.apk02
DEFINE p_apk03     LIKE apk_file.apk03
DEFINE p_apk06f    LIKE apk_file.apk06f
DEFINE p_apk07f    LIKE apk_file.apk07f
DEFINE p_apk08f    LIKE apk_file.apk08f
DEFINE p_apk171    LIKE apk_file.apk171
 
   SELECT SUM(apk08f),SUM(apk07f),SUM(apk06f) INTO l_totl1,l_totl2,l_totl3
     FROM apk_file
    WHERE apk01=g_apa.apa01 AND apk171 NOT IN ('23','24')
 
   IF cl_null(l_totl1) THEN
      LET l_totl1 = 0
   END IF
 
   IF cl_null(l_totl2) THEN
      LET l_totl2 = 0
   END IF
 
   IF cl_null(l_totl3) THEN
      LET l_totl3 = 0
   END IF
 
   SELECT SUM(apk08f),SUM(apk07f),SUM(apk06f) INTO l_totl11,l_totl21,l_totl31
     FROM apk_file
    WHERE apk01=g_apa.apa01 AND apk171 IN ('23','24')
 
   IF cl_null(l_totl11) THEN
      LET l_totl11 = 0
   END IF
 
   IF cl_null(l_totl21) THEN
      LET l_totl21 = 0
   END IF
 
   IF cl_null(l_totl31) THEN
      LET l_totl31 = 0
   END IF
 
   IF g_aptype MATCHES '1*' THEN
      LET l_totl1 = l_totl1 - l_totl11
      LET l_totl2 = l_totl2 - l_totl21
      LET l_totl3 = l_totl3 - l_totl31
   ELSE
      LET l_totl1 = l_totl11
      LET l_totl2 = l_totl21
      LET l_totl3 = l_totl31
   END IF
   IF p_apk08f < 0 THEN
      LET p_apk08f = p_apk08f * -1
      LET p_apk07f = p_apk07f * -1
      LET p_apk06f = p_apk06f * -1
   END IF
 
   IF cl_null(p_apk02) THEN
      SELECT apk08f,apk07f,apk06f INTO l_apk08f,l_apk07f,l_apk06f FROM apk_file
       WHERE apk01=g_apa.apa01
         AND apk03=p_apk03
   ELSE
      SELECT apk08f,apk07f,apk06f INTO l_apk08f,l_apk07f,l_apk06f FROM apk_file
       WHERE apk01=g_apa.apa01
         AND apk02=p_apk02
         AND apk03=p_apk03
   END IF
 
   IF SQLCA.SQLCODE=100 THEN
      LET l_apk08f=p_apk08f
      LET l_apk07f=p_apk07f
      LET l_apk06f=p_apk06f
      LET l_totl1=l_totl1+l_apk08f
      LET l_totl2=l_totl2+l_apk07f
      LET l_totl3=l_totl3+l_apk06f
   ELSE
      LET l_totl1=l_totl1-l_apk08f
      LET l_totl2=l_totl2-l_apk07f
      LET l_totl3=l_totl3-l_apk06f
      LET l_totl1=l_totl1+p_apk08f
      LET l_totl2=l_totl2+p_apk07f
      LET l_totl3=l_totl3+p_apk06f
   END IF
 
   LET l_tot1=l_totl1
   LET l_tot2=l_totl2
   LET l_tot3=(l_totl1+l_totl2)
 
   IF g_aptype MATCHES '2*' THEN
      LET l_tot1=l_totl1 * -1
      LET l_tot2=l_totl2 * -1
      LET l_tot3=(l_totl1+l_totl2) * -1
   END IF
   SELECT SUM(apk08f) INTO l_totl28 FROM apk_file
    WHERE apk01=g_apa.apa01
      AND (apk171='28' OR apk171='29')
 
   IF cl_null(l_totl28) THEN
      LET l_totl28 = 0
   END IF
 
   IF p_apk171='28' OR p_apk171='29' THEN
      SELECT apk08f INTO l_t028 FROM apk_file
       WHERE apk01=g_apa.apa01
         AND apk03=p_apk03
         AND (apk171='28' OR apk171='29')
       IF SQLCA.SQLCODE=100 THEN
          LET l_t028=p_apk08f
          LET l_totl28=l_totl1+l_t028
       ELSE
          LET l_totl28=l_totl28-l_t028
          LET l_totl28=l_totl28+p_apk08f
       END IF
   END IF
   LET l_tot28=l_totl28
   IF g_aza.aza26 = '2' THEN
      DISPLAY l_tot1 TO FORMONLY.l_tot1f
      DISPLAY l_tot2 TO FORMONLY.l_tot2f
      DISPLAY l_tot3 TO FORMONLY.l_tot3f
   END IF
 
END FUNCTION
#MOD-580365  --end

#No.MOD-590312  --begin
FUNCTION t110_comp_oox(p_apv03)
DEFINE l_net     LIKE apv_file.apv04
DEFINE p_apv03   LIKE apv_file.apv03
DEFINE l_apa00   LIKE apa_file.apa00
 
    LET l_net = 0
    IF g_apz.apz27 = 'Y' THEN
       SELECT SUM(oox10) INTO l_net FROM oox_file
        WHERE oox00 = 'AP' AND oox03 = p_apv03
       IF cl_null(l_net) THEN
          LET l_net = 0
       END IF
    END IF
    SELECT apa00 INTO l_apa00 FROM apa_file WHERE apa01=p_apv03
    IF l_apa00 MATCHES '1*' THEN LET l_net = l_net * ( -1) END IF
 
    RETURN l_net
END FUNCTION
#No.MOD-590312  --end

#No.FUN-7B0055  --Begin
#detail至多帳期
FUNCTION t110_comp_oox1(p_apv03,p_apv05)
DEFINE l_net     LIKE apv_file.apv04
DEFINE p_apv03   LIKE apv_file.apv03
DEFINE p_apv05   LIKE apv_file.apv05
DEFINE l_apa00   LIKE apa_file.apa00
 
    LET l_net = 0
    IF g_apz.apz27 = 'Y' THEN
       SELECT SUM(oox10) INTO l_net FROM oox_file
        WHERE oox00 = 'AP' AND oox03 = p_apv03
          AND oox041 = p_apv05
       IF cl_null(l_net) THEN
          LET l_net = 0
       END IF
    END IF
    SELECT apa00 INTO l_apa00 FROM apa_file WHERE apa01=p_apv03
    IF l_apa00 MATCHES '1*' THEN LET l_net = l_net * ( -1) END IF
 
    RETURN l_net
END FUNCTION
#No.FUN-7B0055  --End  

#FUN-5C0015 BY TSD.GILL --START
FUNCTION  t110_ccc_show_filed()
#依參數決定異動碼的多寡
 
  DEFINE l_field     STRING

#FUN-B50105   ---start   Mark
# IF g_aaz.aaz88 = 10 THEN
#    RETURN
# END IF

# IF g_aaz.aaz88 = 0 THEN
#    LET l_field  = "api21,api22,api23,api24,api31,api32,api33,api34,", 
#                   "api35"                                              #MOD-B10093 remove api36 
# END IF

# IF g_aaz.aaz88 = 1 THEN
#    LET l_field  = "api22,api23,api24,api31,api32,api33,api34,",      
#                   "api35"                                              #MOD-B10093 remove api36 
# END IF

# IF g_aaz.aaz88 = 2 THEN
#    LET l_field  = "api23,api24,api31,api32,api33,api34,",            
#                   "api35"                                              #MOD-B10093 remove api36 
# END IF

# IF g_aaz.aaz88 = 3 THEN
#    LET l_field  = "api24,api31,api32,api33,api34,",                   
#                   "api35"                                              #MOD-B10093 remove api36 
# END IF

# IF g_aaz.aaz88 = 4 THEN
#    LET l_field  = "api31,api32,api33,api34,",                          
#                   "api35"                                              #MOD-B10093 remove api36 
# END IF

# IF g_aaz.aaz88 = 5 THEN
#    LET l_field  = "api32,api33,api34,",                              
#                   "api35"                                              #MOD-B10093 remove api36 
# END IF

# IF g_aaz.aaz88 = 6 THEN
#    LET l_field  = "api33,api34,api35"                                  #MOD-B10093 remove api36 
# END IF

# IF g_aaz.aaz88 = 7 THEN
#    LET l_field  = "api34,api35"                                        #MOD-B10093 remove api36 
# END IF

# IF g_aaz.aaz88 = 8 THEN
#    LET l_field  = "api35"                                              #MOD-B10093 remove api36
# END IF
#FUN-B50105   ---end     Mark

 #-MOD-B10093-mark-
 #IF g_aaz.aaz88 = 9 THEN
 #   LET l_field  = "api36"
 #END IF
 #-MOD-B10093-end-

#FUN-B50105   ---start   Add
   IF g_aaz.aaz88 = 0 THEN
      LET l_field = "api21,api22,api23,api24"
   END IF
   IF g_aaz.aaz88 = 1 THEN
      LET l_field = "api22,api23,api24"
   END IF
   IF g_aaz.aaz88 = 2 THEN
      LET l_field = "api23,api24"
   END IF
   IF g_aaz.aaz88 = 3 THEN
      LET l_field = "api24"
   END IF
   IF g_aaz.aaz88 = 4 THEN
      LET l_field = ""
   END IF

   IF NOT cl_null(l_field) THEN
       LET l_field = l_field,','
   END IF

   IF g_aaz.aaz125 = 5 THEN
      LET l_field = l_field,"api32,api33,api34,api35"
   END IF
   IF g_aaz.aaz125 = 6 THEN
      LET l_field = l_field,"api33,api34,api35"
   END IF
   IF g_aaz.aaz125 = 7 THEN
      LET l_field = l_field,"api34,api35"
   END IF
   IF g_aaz.aaz125 = 8 THEN
      LET l_field = l_field,"api35"
   END IF
#FUN-B50105   ---end     Add

  CALL cl_set_comp_visible(l_field,FALSE)
#No.FUN-680029--begin
  IF g_aza.aza63='N' THEN
     CALL cl_set_comp_visible("api041,aag021",FALSE)
  END IF
#No.FUN-680029--begin
 #CALL cl_set_comp_visible("api26,api35,api36",g_aza.aza08 = 'Y') #FUN-810045 #MOD-B10093 mark
  CALL cl_set_comp_visible("api26,api35",g_aza.aza08 = 'Y') #FUN-810045       #MOD-B10093
END FUNCTION

FUNCTION t110_set_no_required()
   CALL cl_set_comp_required("api21,api22,api23,api24,api31,api32,api33,api34,
                              api35,api36,api37",FALSE)
END FUNCTION

FUNCTION t110_set_required(l_aag151,l_aag161,l_aag171,l_aag181,
                           l_aag311,l_aag321,l_aag331,l_aag341,
                           l_aag351,l_aag361,l_aag371,l_aag05,    
                           l_aag21,l_aag23)                       #MOD-B10093
DEFINE    l_aag151 LIKE aag_file.aag151,
          l_aag161 LIKE aag_file.aag161,
          l_aag171 LIKE aag_file.aag171,
          l_aag181 LIKE aag_file.aag181,
          l_aag311 LIKE aag_file.aag311,
          l_aag321 LIKE aag_file.aag321,
          l_aag331 LIKE aag_file.aag331,
          l_aag341 LIKE aag_file.aag341,
          l_aag351 LIKE aag_file.aag351,
          l_aag361 LIKE aag_file.aag361,
          l_aag371 LIKE aag_file.aag371,
          l_aag05  LIKE aag_file.aag05,   #TQC-750121
          l_aag21  LIKE aag_file.aag21,   #MOD-B10093
          l_aag23  LIKE aag_file.aag23    #MOD-B10093

   #TQC-750121 begin
    IF l_aag05 = 'Y' THEN
      CALL cl_set_comp_required("api07",TRUE)
    END IF
   #TQC-750121 end

   #-MOD-B10093-add-
    IF l_aag21 = 'Y' THEN 
       CALL cl_set_comp_required("api36",TRUE)
    END IF 
 
    IF l_aag23 = 'Y' THEN
       CALL cl_set_comp_required("api26,api35",TRUE)  
    END IF
   #-MOD-B10093-end-

   IF l_aag151 MATCHES '[23]' THEN
      CALL cl_set_comp_required("api21",TRUE)
   END IF
   IF l_aag161 MATCHES '[23]' THEN
      CALL cl_set_comp_required("api22",TRUE)
   END IF
   IF l_aag171 MATCHES '[23]' THEN
      CALL cl_set_comp_required("api23",TRUE)
   END IF
   IF l_aag181 MATCHES '[23]' THEN
      CALL cl_set_comp_required("api24",TRUE)
   END IF
   IF l_aag311 MATCHES '[23]' THEN
      CALL cl_set_comp_required("api31",TRUE)
   END IF
   IF l_aag321 MATCHES '[23]' THEN
      CALL cl_set_comp_required("api32",TRUE)
   END IF
   IF l_aag331 MATCHES '[23]' THEN
      CALL cl_set_comp_required("api33",TRUE)
   END IF
   IF l_aag341 MATCHES '[23]' THEN
      CALL cl_set_comp_required("api34",TRUE)
   END IF
  #-MOD-B10093-mark-
  #IF l_aag351 MATCHES '[23]' THEN
  #   CALL cl_set_comp_required("api35",TRUE)
  #END IF
  #IF l_aag361 MATCHES '[23]' THEN
  #   CALL cl_set_comp_required("api36",TRUE)
  #END IF
  #-MOD-B10093-end-
   IF l_aag371 MATCHES '[23]' THEN
      CALL cl_set_comp_required("api37",TRUE)
   END IF
   
   #NO.FUN-950053--begin--
   IF l_aag371 MATCHES '[4]' AND g_pmc903='Y' THEN
      CALL cl_set_comp_required("api37",TRUE)
   END IF
   #No.FUN-950053 --end--
   
END FUNCTION

#FUN-5C0023 add--start
FUNCTION t110_appor_expense()
  DEFINE l_cmd  LIKE type_file.chr1000 #No.FUN-690028 VARCHAR(200)
  DEFINE l_type  LIKE apy_file.apyslip      # No:FUN-690028 VARCHAR(4)   #MOD-7A0143
  DEFINE l_date  LIKE aqa_file.aqa02  
  DEFINE l_aqb01 LIKE aqb_file.aqb01
  DEFINE l_aqa  RECORD LIKE aqa_file.*
  DEFINE l_aqb  RECORD LIKE aqb_file.* 
  DEFINE li_result LIKE type_file.num5,    #No.FUN-690028 SMALLINT
         g_t1   LIKE oay_file.oayslip  #No.FUN-690028 VARCHAR(5)
  DEFINE l_cnt  LIKE type_file.num5,    #TQC-750121
         l_wc   STRING,
         l_sql  STRING

    IF s_aapshut(0) THEN
       RETURN
    END IF

    IF g_apa.apa01 IS NULL THEN
       CALL cl_err('',-400,0)
       RETURN
    END IF

    SELECT * INTO g_apa.* FROM apa_file WHERE apa01=g_apa.apa01

    IF g_apa.apaacti ='N' THEN
       CALL cl_err(g_apa.apa01,'9027',0)
       RETURN
    END IF

    IF g_apa.apa41='N' THEN
       CALL cl_err(g_apa.apa01,'aap-717',0)
       RETURN
    END IF

    #-----MOD-820050---------
    LET l_cnt = 0
    SELECT COUNT(*) INTO l_cnt FROM apb_file
      WHERE apb01=g_apa.apa01
        AND apb21 IS NOT NULL
    IF l_cnt > 0 THEN
       CALL cl_err(g_apa.apa01,'aap-610',0)
       RETURN
    END IF
    #-----END MOD-820050-----

   INITIALIZE l_aqa.* TO NULL
   INITIALIZE l_aqb.* TO NULL

   #TQC-750121 begin
    LET l_cnt = 0
    LET l_wc = NULL
   
    SELECT COUNT(*) INTO l_cnt FROM aqb_file  WHERE aqb02 = g_apa.apa01

   IF l_cnt > 1 THEN
      LET l_sql = "SELECT aqb01 FROM aqb_file WHERE aqb02 ='",g_apa.apa01,"'"
      PREPARE aqb_pre FROM l_sql
      DECLARE aqb_curs CURSOR FOR aqb_pre
      FOREACH aqb_curs INTO l_aqb01
        IF cl_null(l_wc) THEN
           LET l_wc = " aqa01 IN('", l_aqb01,"'"
        ELSE
           LET l_wc = l_wc CLIPPED, ",'",l_aqb01,"'"
        END IF
      END FOREACH
      IF NOT cl_null(l_wc) THEN 
         LET l_wc = l_wc CLIPPED,")"
         LET l_wc = cl_replace_str(l_wc ,"'" ,"\"")
      END IF
   ELSE 
     LET l_aqb01 = ""
     SELECT aqb01 INTO l_aqb01 FROM aqb_file  WHERE aqb02 = g_apa.apa01
   END IF
  #TQC-750121 end
  
   IF cl_null(l_aqb01) THEN

      OPEN WINDOW t120_w2 WITH FORM "aap/42f/aapt1202"
            ATTRIBUTE (STYLE = g_win_style CLIPPED) 
      CALL cl_ui_locale("aapt1202")

      LET l_date = g_today
      DISPLAY l_date TO FORMONLY.date
      CALL cl_set_head_visible("","YES")     #No.FUN-6B0033

      INPUT l_type,l_date WITHOUT DEFAULTS FROM FORMONLY.ship,FORMONLY.date 
        AFTER FIELD ship
           IF NOT cl_null(l_type) THEN
                  CALL s_check_no("aap",l_type,'',"41","aqa_file","aqa01","")
                  RETURNING li_result,l_type
              DISPLAY l_type TO FORMONLY.ship
              IF (NOT li_result) THEN
                 LET l_type=""
                 NEXT FIELD ship
              END IF
           ELSE 
             NEXT FIELD ship
           END IF


        AFTER FIELD date
           IF NOT cl_null(l_date) THEN
              IF l_date <= g_apz.apz57 THEN
                 CALL cl_err(l_aqa.aqa02,'aap-176',0)
                 NEXT FIELD date
              END IF
           ELSE 
              NEXT FIELD date
           END IF
          
        ON ACTION CONTROLP
          CASE
            WHEN INFIELD(ship) #查詢單据
                 LET g_t1=s_get_doc_no(l_type)      
                #CALL q_apy(FALSE,FALSE,g_t1,'41',g_sys) RETURNING g_t1  #TQC-670008
                 CALL q_apy(FALSE,FALSE,g_t1,'41','AAP') RETURNING g_t1  #TQC-670008
                 LET l_type = g_t1
                 DISPLAY l_type TO FORMONLY.ship
                 NEXT FIELD ship
            END CASE

            ON ACTION controlg       #TQC-860021
               CALL cl_cmdask()      #TQC-860021

            ON IDLE g_idle_seconds   #TQC-860021
               CALL cl_on_idle()     #TQC-860021
               CONTINUE INPUT        #TQC-860021

            ON ACTION about          #TQC-860021
               CALL cl_about()       #TQC-860021

            ON ACTION help           #TQC-860021
               CALL cl_show_help()   #TQC-860021
      END INPUT
      
      IF INT_FLAG THEN
         LET INT_FLAG=0
         CLOSE WINDOW t120_w2
         RETURN
      ELSE

         CLOSE WINDOW t120_w2
      END IF


      LET l_aqa.aqa01 = l_type
      LET l_aqa.aqa02 = l_date
      LET l_aqa.aqa03 = g_apa.apa31   #MOD-6B0034
      LET l_aqa.aqaacti = 'Y'
      LET l_aqa.aqaconf = 'N'
      LET l_aqa.aqagrup = g_grup
      LET l_aqa.aqainpd = g_today
      LET l_aqa.aqauser = g_user

      BEGIN WORK

      CALL s_auto_assign_no("aap",l_aqa.aqa01,l_aqa.aqa02,"41","aqa_file","aqa01","","","")
      RETURNING li_result,l_aqa.aqa01
      
      INSERT INTO aqa_file VALUES (l_aqa.*)
      IF SQLCA.sqlcode THEN
#        CALL cl_err(l_apa.apa01,SQLCA.sqlcode,1) #FUN-660122
         CALL cl_err3("ins","aqa_file",l_aqa.aqa01,"",SQLCA.sqlcode,"","app_exp_aqa:",1)
         ROLLBACK WORK
         RETURN
      END IF

      LET l_aqb.aqb01 = l_aqa.aqa01
      LET l_aqb.aqb02 = g_apa.apa01
      LET l_aqb.aqb03 = g_apa.apa31
      LET l_aqb.aqb04 = g_apa.apa31

      INSERT INTO aqb_file VALUES (l_aqb.*) 
      IF SQLCA.sqlcode THEN
#        CALL cl_err(l_apb.apb01,SQLCA.sqlcode,1) #FUN-660122
         CALL cl_err3("ins","aqb_file",l_aqb.aqb01,l_aqb.aqb02,SQLCA.sqlcode,"","app_exp_aqb:",1)
              ROLLBACK WORK
              RETURN
      END IF
      
      COMMIT WORK
      LET l_aqb01 = l_aqa.aqa01
   END IF

   IF l_cnt > 1 THEN                          #TQC-750121
     LET l_cmd = "aapt900 '' '' '",l_wc,"'"   #TQC-750121
   ELSE                                       #TQC-750121
     LET l_cmd = "aapt900 '", l_aqb01 CLIPPED ,"'"
   END IF
   #CALL cl_cmdrun(l_cmd)      #FUN-660216 remark
   CALL cl_cmdrun_wait(l_cmd)  #FUN-660216 add
     
END FUNCTION
#FUN-5C0023 add--end

#FUN-670064...............begin
FUNCTION t110_set_apa930(p_apa930)
DEFINE p_apa930 LIKE apa_file.apa930
DEFINE l_gem02  LIKE gem_file.gem02

   IF cl_null(p_apa930) THEN
      RETURN NULL
   END IF
   SELECT gem02 INTO l_gem02 FROM gem_file
                            WHERE gem01=p_apa930
   IF SQLCA.sqlcode THEN
      LET l_gem02=NULL
   END IF
   RETURN l_gem02
END FUNCTION

#start FUN-680110 add
FUNCTION t110_set_rvv34(p_apb21,p_apb22)  #No.TQC-7B0083
DEFINE  p_apb21  LIKE apb_file.apb21,
        p_apb22  LIKE apb_file.apb22,
        l_rvv40  LIKE rvv_file.rvv40,
        l_apb01  LIKE apb_file.apb01,     #MOD-7A0069 add
        l_n      LIKE type_file.num5,     #MOD-7A0069 add
        l_apb    RECORD LIKE apb_file.*   #MOD-7A0069 add

  #No.TQC-7B0083  --Begin
  ##str FUN-7B0024 add
  # IF g_apa.apa51!='UNAP' THEN
  #    RETURN 'N'
  # END IF
  ##end FUN-7B0024 add
  #No.TQC-7B0083  --End  

   IF cl_null(p_apb21) OR cl_null(p_apb22) THEN
      RETURN 'N'
   END IF

   #抓暫估單號
   SELECT apb01 INTO l_apb01 FROM apb_file,apa_file
    WHERE apb21=p_apb21 AND apb22=p_apb22 
      AND (apa00='16' OR apa00='26')
      AND apb01=apa01
      AND apa42 = 'N'  #No.TQC-7B0083
      AND apa41 = 'Y'  #No.TQC-7B0083

  #No.TQC-7B0083  --Begin
  IF g_aptype = '12' AND cl_null(l_apb01) THEN
     SELECT UNIQUE apb01 INTO l_apb01 FROM apb_file,apa_file
      WHERE (apa00='16' OR apa00='26')
        AND apb01=apa01
        AND apa42 = 'N'  #No.TQC-7B0083
        AND apa41 = 'Y'  #No.TQC-7B0083
        AND apb01=p_apb21 AND apb02=p_apb22 
  END IF
  ##str FUN-7B0024 add
  # IF g_aza.aza26 = '2' THEN   #大陸版功能
  #    #當沖暫估裡沒有資料時,單身的沖暫估否就不應該顯示
  #    SELECT * INTO l_apb.* FROM apb_file
  #     WHERE apb01 = g_apa.apa01 AND apb21 = p_apb21 AND apb22 = p_apb22
  #    LET l_n = 0
  #    SELECT COUNT(*) INTO l_n FROM api_file
  #     WHERE api01 = g_apa.apa01 AND api02= '2'
  #       AND api26 = l_apb01
  #       AND api05f= l_apb.apb24 AND api05= l_apb.apb10
  #    IF l_n = 0 THEN 
  #       RETURN 'N'
  #    END IF
  # END IF
  ##end FUN-7B0024 add

  # SELECT rvv40 INTO l_rvv40 FROM rvv_file
  #  WHERE rvv01=p_apb21 AND rvv02=p_apb22
  # IF SQLCA.sqlcode THEN LET l_rvv40='N' END IF
  # IF cl_null(l_rvv40) THEN LET l_rvv40='N' END IF
  # RETURN l_rvv40
  IF cl_null(l_apb01) THEN RETURN 'N' ELSE RETURN 'Y' END IF
  #No.TQC-7B0083  --End  
END FUNCTION

FUNCTION t110_set_apb01_unap(p_apb21,p_apb22,p_apb34)  #No.TQC-7B0083  add apb34
DEFINE  p_apb21  LIKE apb_file.apb21,
        p_apb22  LIKE apb_file.apb22,
        p_apb34  LIKE apb_file.apb34,     #No.TQC-7B0083
        l_apb01  LIKE apb_file.apb01,
        l_n      LIKE type_file.num5,     #MOD-7A0069 add
        l_apb    RECORD LIKE apb_file.*   #MOD-7A0069 add

   #No.TQC-7B0083  --Begin
   IF p_apb34 = 'N' THEN
      RETURN NULL
   END IF
   ##str FUN-7B0024 add
   # IF g_apa.apa51!='UNAP' THEN
   #    RETURN NULL
   # END IF
   ##end FUN-7B0024 add
   #No.TQC-7B0083  --End

   IF cl_null(p_apb21) OR cl_null(p_apb22) THEN
      RETURN NULL
   END IF

   #抓暫估單號
  #str MOD-850316 add
   IF g_apa.apa58 ='3' THEN
      LET l_apb01=p_apb21
   ELSE
  #end MOD-850316 add
      SELECT apb01 INTO l_apb01 FROM apb_file,apa_file
       WHERE apb21=p_apb21 AND apb22=p_apb22 
         AND (apa00='16' OR apa00='26')
         AND apb01=apa01
         AND apa42 = 'N'  #No.TQC-7B0083
         AND apa41 = 'Y'  #No.TQC-7B0083
   END IF   #MOD-850316 add
   IF SQLCA.sqlcode THEN
      LET l_apb01=NULL
   END IF

   #No.TQC-7B0083  --Begin
   IF g_aptype = '12' AND cl_null(l_apb01) THEN
      SELECT UNIQUE apb01 INTO l_apb01 FROM apb_file,apa_file
       WHERE (apa00='16' OR apa00='26')
         AND apb01=apa01
         AND apa42 = 'N'  #No.TQC-7B0083
         AND apa41 = 'Y'  #No.TQC-7B0083
         AND apb01=p_apb21 AND apb02=p_apb22 
   END IF
   ##str FUN-7B0024 add
   # IF g_aza.aza26 = '2' THEN   #大陸版功能
   #    #當沖暫估裡沒有資料時,單身的沖暫估單號就不應該顯示
   #    SELECT * INTO l_apb.* FROM apb_file
   #     WHERE apb01 = g_apa.apa01 AND apb21 = p_apb21 AND apb22 = p_apb22
   #    LET l_n = 0
   #    SELECT COUNT(*) INTO l_n FROM api_file
   #     WHERE api01 = g_apa.apa01 AND api02= '2'
   #       AND api26 = l_apb01
   #       AND api05f= l_apb.apb24 AND api05= l_apb.apb10
   #    IF l_n = 0 THEN 
   #       RETURN NULL 
   #    END IF
   # END IF
   ##end FUN-7B0024 add
   #No.TQC-7B0083  --End  

   RETURN l_apb01
END FUNCTION
#end FUN-680110 add

#在每個 CALL cl_ui_init() 之後,要接此函數
FUNCTION t110_set_form_default()
  CALL cl_set_comp_visible("apb35,apb36,apa66",g_aza.aza08='Y')  #FUN-810045 add
  CALL cl_set_comp_visible("apa930,gem02b,apb930,gem02c,api930",g_aaz.aaz90='Y')   #CHI-8C0005 add api930
  #CALL cl_set_comp_visible("page04,apb051",g_aza.aza63='Y')         #No.FUN-680029 #No.FUN-690080
  CALL cl_set_comp_visible("apa511,apa521,apa541,apb251",g_aza.aza63='Y')  #No.FUN-690080 #CHI-750003 add apb251
  CALL cl_set_comp_visible("a511,a521,a541,b251",g_aza.aza63='Y') #FUN-710078 add 
  #No.FUN-690080 --Begin
  CASE g_aptype
     WHEN "11"                                         #MOD-AB0133 
        CALL cl_set_comp_visible("apa58",FALSE)        #MOD-AB0133
        CALL cl_set_comp_visible("page05,apa37f,apa37",FALSE)       #MOD-AC0237
     WHEN "12"                                         #MOD-AB0133 
        CALL cl_set_comp_visible("apa58",FALSE)        #MOD-AB0133
        CALL cl_set_comp_visible("page05,apa37f,apa37",FALSE)       #MOD-AC0237
     WHEN "13"
        CALL cl_set_comp_visible("page06",FALSE)
        CALL cl_set_comp_visible("apa58",FALSE)        #MOD-AB0133
     WHEN "15"                                         #MOD-A70006 
        CALL cl_set_comp_visible("apa58",FALSE)        #MOD-A70006
        CALL cl_set_comp_visible("page05",FALSE)       #MOD-A90089
        CALL cl_set_comp_visible("apa37f,apa37",FALSE)              #MOD-AC0237
     WHEN "17"
        CALL cl_set_comp_visible("page05,page06,apa37f,apa37",FALSE)
        CALL cl_set_comp_visible("apa58",FALSE)        #MOD-AB0133
     WHEN "21"
        CALL cl_set_comp_visible("apb32,apb33",FALSE) #CHI-750003
        CALL cl_set_comp_visible("page05,apa37f,apa37",FALSE)       #MOD-AC0237
     WHEN "22"
        CALL cl_set_comp_visible("apb32,apb33",FALSE) #CHI-750003
        CALL cl_set_comp_visible("page05,apa37f,apa37",FALSE)       #MOD-AC0237
     WHEN "25"
        CALL cl_set_comp_visible("page05",FALSE)
        CALL cl_set_comp_visible("apa05,pmc03,apa21,gen02,apa15,apa16,apa58,
                                  apa32f,apa60f,apa61f,apa37f,apa37,apa32,apa60,apa61,
                                  apa56,apa56_name,apa33,apa52,a52,apa521,a521",FALSE) #FUN-710078 mod
                                 #apa56,apa56_name,apa33,apa52,apa521",FALSE)          #FUN-710078 mark
        CALL cl_set_comp_visible("apa541,a541",FALSE)                                  #TQC-980068
     WHEN "26"
        CALL cl_set_comp_visible("apb32,apb33",FALSE) #CHI-750003
        CALL cl_set_comp_visible("page05",FALSE) #CHI-750011
        CALL cl_set_comp_visible("apa37f,apa37",FALSE)              #MOD-AC0237
     OTHERWISE
        CALL cl_set_comp_visible("page05,apa37f,apa37,apa101,apa102",FALSE)
  END CASE
  #No.FUN-690080 --End
 #start FUN-680110 add
  IF g_aptype !='11' AND g_aptype !='21' THEN  #No.TQC-7B0083 add 21
    #CALL cl_set_comp_visible("rvv40,apb01_unap",FALSE)  #No.TQC-7B0083
     CALL cl_set_comp_visible("apb34,apb01_unap",FALSE)  #No.TQC-7B0083
  END IF
 #end FUN-680110 add
END FUNCTION
#FUN-670064...............end

#No.FUN-670060  --Begin
FUNCTION t110_gen_glcr(p_apa,p_apy)
  DEFINE p_apa     RECORD LIKE apa_file.*
  DEFINE p_apy     RECORD LIKE apy_file.*

    IF cl_null(p_apy.apygslp) THEN
       CALL cl_err(p_apa.apa01,'axr-070',1)
       LET g_success = 'N'
       RETURN
    END IF       
    IF g_apa.apa58 <> '1' THEN   #TQC-C90078 add
       CALL t110_g_gl(p_apa.apa00,p_apa.apa01,'0')    #No.FUN-680029
    END IF                       #TQC-C90078 add
    IF g_success = 'N' THEN RETURN END IF

END FUNCTION

FUNCTION t110_carry_voucher()
  DEFINE l_apygslp    LIKE apy_file.apygslp
  DEFINE li_result    LIKE type_file.num5     #No.FUN-690028 SMALLINT
  DEFINE g_t1         LIKE oay_file.oayslip  #No.FUN-690028 VARCHAR(5)
  DEFINE l_dbs        STRING
  DEFINE l_sql        STRING
  DEFINE l_n          LIKE type_file.num5    #No.FUN-690028 SMALLINT
  DEFINE l_wc         STRING                 #No.MOD-7A0006

    #No:FUN-860107---Begin
    IF NOT cl_null(g_apa.apa44) OR g_apa.apa44 IS NOT NULL THEN
       CALL cl_err(g_apa.apa44,'aap-618',1)
       RETURN
    END IF   
    #No:FUN-860107---End
    
    IF NOT cl_confirm('aap-989') THEN RETURN END IF

    CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1
    SELECT * INTO g_apy.* FROM apy_file WHERE apyslip=g_t1
    IF g_apy.apydmy3 = 'N' THEN RETURN END IF
    #IF g_apy.apyglcr = 'Y' THEN  #No:FUN-860107
     IF g_apy.apyglcr = 'Y' OR (g_apy.apyglcr ='N' AND NOT cl_null(g_apy.apygslp)) THEN #No:FUN-860107
       LET g_plant_new=g_apz.apz02p CALL s_getdbs() LET l_dbs=g_dbs_new
       LET l_sql = " SELECT COUNT(aba00) FROM ",l_dbs,"aba_file",
                   "  WHERE aba00 = '",g_apz.apz02b,"'",
                   "    AND aba01 = '",g_apa.apa44,"'"
	CALL cl_replace_sqldb(l_sql) RETURNING l_sql		#FUN-920032
       PREPARE aba_pre2 FROM l_sql
       DECLARE aba_cs2 CURSOR FOR aba_pre2
       OPEN aba_cs2
       FETCH aba_cs2 INTO l_n
       IF l_n > 0 THEN
          CALL cl_err(g_apa.apa44,'aap-991',1)
          RETURN
       END IF

       LET l_apygslp = g_apy.apygslp
    ELSE
    	 #CALL cl_err('','aap-992',1)   #No:FUN-860107
    	 CALL cl_err('','aap-936',1)    #No:FUN-860107 
       RETURN

#      #開窗作業
#      LET g_plant_new= g_apz.apz02p
#      CALL s_getdbs()
#      LET g_dbs_gl=g_dbs_new      # 得資料庫名稱

#      OPEN WINDOW t200p WITH FORM "axr/42f/axrt200_p" 
#           ATTRIBUTE (STYLE = g_win_style CLIPPED)
#      CALL cl_ui_locale("axrt200_p")
#       
#      INPUT l_apygslp WITHOUT DEFAULTS FROM FORMONLY.gl_no
#   
#         AFTER FIELD gl_no
#            CALL s_check_no("agl",l_apygslp,"","1","aac_file","aac01",g_dbs_gl) 
#                  RETURNING li_result,l_apygslp
#            IF (NOT li_result) THEN
#               NEXT FIELD gl_no
#            END IF
#    
#         AFTER INPUT
#            IF INT_FLAG THEN
#               EXIT INPUT 
#            END IF
#            IF cl_null(l_apygslp) THEN
#               CALL cl_err('','9033',0)
#               NEXT FIELD gl_no  
#            END IF
#   
#         ON ACTION CONTROLZ
#            CALL cl_show_req_fields()
#         ON ACTION CONTROLG
#            CALL cl_cmdask()
#         ON ACTION CONTROLP
#            IF INFIELD(gl_no) THEN
#               CALL q_m_aac(FALSE,TRUE,g_dbs_gl,l_apygslp,'1',' ',' ','AGL') 
#               RETURNING l_apygslp
#               DISPLAY l_apygslp TO FORMONLY.gl_no
#               NEXT FIELD gl_no
#            END IF
#   
#         ON IDLE g_idle_seconds
#            CALL cl_on_idle()
#            CONTINUE INPUT
#    
#         ON ACTION about         #MOD-4C0121
#            CALL cl_about()      #MOD-4C0121
#    
#         ON ACTION help          #MOD-4C0121
#            CALL cl_show_help()  #MOD-4C0121
#    
#         ON ACTION exit  #加離開功能genero
#            LET INT_FLAG = 1
#            EXIT INPUT

#      END INPUT
#      CLOSE WINDOW t200p  
    END IF
    IF cl_null(l_apygslp) OR (cl_null(g_apy.apygslp1) AND g_aza.aza63 = 'Y') THEN #FUN-680029
       CALL cl_err(g_apa.apa01,'axr-070',1)
       RETURN
    END IF
   #No.MOD-7A0006-----begin
   #LET g_wc_gl = 'npp01 = "',g_apa.apa01,'" AND npp011 = 1'
   #LET g_str="aapp400 '",g_wc_gl CLIPPED,"' '",g_user,"' '",g_user,"' '",g_apz.apz02p,"' '",g_apz.apz02b,"' '",l_apygslp,"' '",g_apa.apa02,"' 'Y' '0' 'Y' '",g_apz.apz02c,"' '",g_apy.apygslp1,"'" #FUN-680029
   #CALL cl_cmdrun_wait(g_str)
    LET g_wc_gl = " npp01='",g_apa.apa01,"'"
    LET l_wc = g_wc_gl clipped," AND npp011 = 1 "
    LET g_str = "aapp400" ,
                ' "',l_wc CLIPPED,'"',
                #' "',g_user,'"',   #MOD-7B0159
                #' "',g_user,'"',   #MOD-7B0159
                ' "',g_apa.apauser,'"',   #MOD-7B0159
                ' "',g_apa.apauser,'"',   #MOD-7B0159
                ' "',g_apz.apz02p,'" ',
                ' "',g_apz.apz02b,'" ',
                ' "',l_apygslp,'" ',
                ' "',g_apa.apa02,'" ',
                ' "Y" ',
               #' "0" ',     #No.MOD-860075
                ' "1" ',     #No.MOD-860075
                ' "Y" ',
                ' "',g_apz.apz02c,'" ',
                ' "',g_apy.apygslp1,'" ',
                ' "Y" '                    #MOD-B10041
    CALL cl_wait()
    #CALL cl_cmdrun(g_str CLIPPED)   #MOD-7B0209
       CALL cl_cmdrun_wait(g_str CLIPPED)   #MOD-7B0209
       #No.MOD-7A0006-----end
       SELECT apa44,apa43 INTO g_apa.apa44,g_apa.apa43 FROM apa_file
        WHERE apa01 = g_apa.apa01
         DISPLAY BY NAME g_apa.apa44
END FUNCTION

FUNCTION t110_undo_carry_voucher() 
  DEFINE l_aba19    LIKE aba_file.aba19
  DEFINE l_dbs      STRING
  DEFINE l_sql      STRING
  DEFINE g_t1       LIKE oay_file.oayslip  #No.FUN-690028 VARCHAR(5)
  
    #No:FUN-860107---Begin
    IF  cl_null(g_apa.apa44) OR g_apa.apa44 IS  NULL THEN
       CALL cl_err(g_apa.apa44,'aap-619',1)
       RETURN
    END IF   
    #No:FUN-860107---End
 
    IF NOT cl_confirm('aap-988') THEN RETURN END IF

    CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1
    SELECT * INTO g_apy.* FROM apy_file WHERE apyslip=g_t1
    IF g_apy.apydmy3 = 'N' THEN RETURN END IF   #TQC-7B0051
    #IF g_apy.apyglcr = 'N' THEN     #No:FUN-860107
    IF g_apy.apyglcr = 'N' AND cl_null(g_apy.apygslp)THEN #No:FUN-860107
       #CALL cl_err('','aap-990',1)   #No:FUN-860107
    	 CALL cl_err('','aap-936',1)    #No:FUN-860107
       RETURN
    END IF

    LET g_plant_new=g_apz.apz02p CALL s_getdbs() LET l_dbs=g_dbs_new
    LET l_sql = " SELECT aba19 FROM ",l_dbs,"aba_file",
                "  WHERE aba00 = '",g_apz.apz02b,"'",
                "    AND aba01 = '",g_apa.apa44,"'"
	CALL cl_replace_sqldb(l_sql) RETURNING l_sql		#FUN-920032
    PREPARE aba_pre1 FROM l_sql
    DECLARE aba_cs1 CURSOR FOR aba_pre1
    OPEN aba_cs1
    FETCH aba_cs1 INTO l_aba19
    IF l_aba19 = 'Y' THEN
       CALL cl_err(g_apa.apa44,'axr-071',1)
       RETURN
    END IF
    LET g_str="aapp409 '",g_apz.apz02p,"' '",g_apz.apz02b,"' '",g_apa.apa44,"' 'Y'"
    CALL cl_cmdrun_wait(g_str)
    SELECT apa44,apa43 INTO g_apa.apa44,g_apa.apa43 FROM apa_file
     WHERE apa01 = g_apa.apa01
      DISPLAY BY NAME g_apa.apa44
   #-------------------------MOD-BB0106----------------start
    IF  NOT cl_null(g_apa.apa44) THEN
       CALL cl_err(g_apa.apa44,'aap-929',1)
       RETURN
    END IF
   #------------------------MOD-BB0106------------------end
END FUNCTION
#No.FUN-670060  --End   

#No.FUN-680027--begin
FUNCTION t110_account_period()
   #DEFINE l_sql      LIKE type_file.chr1000 #No.FUN-690028 VARCHAR(600)   #MOD-720062
   DEFINE l_sql      STRING    #MOD-720062
   DEFINE p_cmd      LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_pmb05   LIKE pmb_file.pmb05
   DEFINE l_apc02   LIKE apc_file.apc02
   DEFINE l_apc08   LIKE apc_file.apc08
   DEFINE l_apc09   LIKE apc_file.apc09
#MOD-980002  ---start
  #DEFINE l_apc13   LIKE apc_file.apc13
  #DEFINE l_apc14   LIKE apc_file.apc14
  #DEFINE l_apc15   LIKE apc_file.apc15
   DEFINE g_apc1 DYNAMIC ARRAY OF RECORD
                 apc13 LIKE apc_file.apc13    
                #apc14 LIKE apc_file.apc14,      #MOD-B70047 mark                                                                                    
                #apc15 LIKE apc_file.apc15       #MOD-B70047 mark 
                 END RECORD
#MOD-980002   ---end
   DEFINE l_amt,l_net  LIKE apc_file.apc08
   DEFINE l_lock_sw       LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_modify_flag   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE g_temp          STRING  
   DEFINE
   l_allow_insert  LIKE type_file.num5,                #可新增否  #No.FUN-690028 SMALLINT
   l_allow_delete  LIKE type_file.num5,                #可刪除否  #No.FUN-690028 SMALLINT
   l_allow_update  LIKE type_file.num5                 #可刪除否  #No.FUN-690028 SMALLINT
   DEFINE l_rec_apc_b   LIKE type_file.num10     # No:FUN-690028 INTEGER
   DEFINE l_n,l_i       LIKE type_file.num10     # No:FUN-690028 INTEGER
   DEFINE l_sum,l_sumf  LIKE  apc_file.apc08     
   DEFINE l_max_rec     LIKE type_file.num5      # No.TQC-6B0066
   DEFINE l_apc08_sum   LIKE apc_file.apc08      # No.TQC-740159
   DEFINE l_apc09_sum   LIKE apc_file.apc09      # No.TQC-740159
   DEFINE l_apc10_sum   LIKE apc_file.apc10      # No.TQC-790128
   DEFINE l_apc11_sum   LIKE apc_file.apc11      # No.TQC-790128
#No.MOD-740369--begin
   DEFINE l_apc10   LIKE apc_file.apc10
   DEFINE l_apc11   LIKE apc_file.apc11
#No.MOD-740369--end
   DEFINE m_apa         RECORD LIKE apa_file.*   #MOD-780152 add
   DEFINE l_n1          LIKE type_file.num5      #FUN-880113
   DEFINE l_msg         LIKE type_file.chr1000   #MOD-AC0066

   #SELECT * INTO g_apa.* FROM apa_file  #MOD-780152 mark
   # WHERE apa01=g_apa.apa01             #MOD-780152 mark

   #No.TQC-7B0083  --Begin
   ##No.MOD-780152 --begin
   #   SELECT COUNT(*) INTO l_n FROM pmb_file
   #    WHERE pmb01 =g_apa.apa11
   #   IF l_n =0 THEN
   #      RETURN
   #   END IF
   ##No.MOD-780152 --end
   #No.TQC-7B0083  --End  

   IF g_modify_date IS NULL THEN  #CHI-A50042 add
      IF g_apa.apa41 = 'Y' THEN
         CALL cl_err(g_apa.apa01,'aap-005',0)
      END IF
      IF g_apa.apa63 MATCHES '[Ss1]' THEN 
         CALL cl_err('','mfg3557',0)
      END IF
   END IF  #CHI-A50042 add

   #-----MOD-840087---------
   ##No.TQC-7C0094--begin--
   #SELECT COUNT(*) INTO l_n FROM apv_file 
   # WHERE apv01 =g_apa.apa01
   #IF l_n >0 THEN
   #   CALL cl_err(g_apa.apa01,'aap-340',0)
   #   RETURN
   #END IF 
   ##No.TQC-7C0094---end---
   #-----END MOD-840087-----

   LET g_success='Y'
   #LET g_apa_t.* = g_apa.*   #MOD-810013
   BEGIN WORK 
   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa_rowid
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl k:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK 
      RETURN
   END IF
  #FETCH t110_cl INTO g_apa.*    # 鎖住將被更改或取消的資料   #MOD-780152 mark
   FETCH t110_cl INTO m_apa.*    # 鎖住將被更改或取消的資料   #MOD-780152 mod
   IF SQLCA.sqlcode THEN
       CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
       CLOSE t110_cl
       ROLLBACK WORK  
       RETURN
   END IF
   COMMIT WORK    #No.MOD-780152

   OPEN WINDOW t110_apc_w WITH FORM "aap/42f/aapt110_k"
      ATTRIBUTE (STYLE = g_win_style CLIPPED) 
    CALL cl_ui_locale("aapt110_k")

   CALL g_apc.clear()
   LET g_cnt =1
 
   LET l_sql ="SELECT apc02,apc03,'',apc04,apc05,apc06,apc07,apc08,apc09,apc10,apc11,apc16,apc12,apc14,apc15",  #MOD-B70047 add apc14/apc15
              "  FROM apc_file",
              " WHERE apc01 = ?",
              "   AND apc02 = ?",
              " ORDER BY apc02"
      PREPARE t110_apc_pb_bcl FROM l_sql                                                                                                       
   DECLARE apc_curs_bcl CURSOR FOR t110_apc_pb_bcl
  #LET l_sql ="SELECT apc02,apc03,'',apc04,apc05,apc06,apc07,apc08,apc09,apc10,apc11,apc16,apc12,apc13,apc14,apc15",  #MOD-B70047 mark
   LET l_sql ="SELECT apc02,apc03,'',apc04,apc05,apc06,apc07,apc08,apc09,apc10,apc11,apc16,apc12,apc14,apc15,apc13",  #MOD-B70047
              "  FROM apc_file",
              " WHERE apc01 = ?",
              " ORDER BY apc02"
      PREPARE t110_apc_pb FROM l_sql                                                                                                       
   DECLARE apc_curs CURSOR FOR t110_apc_pb
 
   LET l_sum =0
   LET l_sumf =0
  #FOREACH apc_curs USING g_apa.apa01 INTO g_apc[g_cnt].*,l_apc13,l_apc14,l_apc15 #MOD-980002
   FOREACH apc_curs USING g_apa.apa01 INTO g_apc[g_cnt].*,g_apc1[g_cnt].*         #MOD-980002
      IF SQLCA.sqlcode THEN                                                                                                         
         CALL cl_err('foreach:',SQLCA.sqlcode,1)                                                                                    
         EXIT FOREACH                                                                                                               
      END IF      
      LET i= g_cnt                                                                                                                  
      CALL t110_apc03('d')
      IF cl_null(g_apc[g_cnt].apc09) THEN
         LET g_apc[g_cnt].apc09 =0
      END IF
      IF cl_null(g_apc[g_cnt].apc08) THEN
         LET g_apc[g_cnt].apc08 =0
      END IF
     #-MOD-B60066-add-
      IF cl_null(g_apc[g_cnt].apc14) THEN   #MOD-B70047 mod g_apc1 -> g_apc
         LET g_apc[g_cnt].apc14 =0          #MOD-B70047 mod g_apc1 -> g_apc
      END IF
      IF cl_null(g_apc[g_cnt].apc15) THEN   #MOD-B70047 mod g_apc1 -> g_apc
         LET g_apc[g_cnt].apc15 =0          #MOD-B70047 mod g_apc1 -> g_apc
      END IF
     #-MOD-B60066-end-
      LET l_sum =l_sum + g_apc[g_cnt].apc09 - g_apc[g_cnt].apc15   #MOD-B60066   #TQC-B60291 mod #MOD-B70047 mod g_apc1 -> g_apc
      LET l_sumf=l_sumf+ g_apc[g_cnt].apc08 - g_apc[g_cnt].apc14   #MOD-B60066   #TQC-B60291 mod #MOD-B70047 mod g_apc1 -> g_apc
      LET g_cnt = g_cnt + 1                                                                                                         
      IF g_cnt > g_max_rec THEN                                                                                                     
         CALL cl_err( '', 9035, 0 )                                                                                                 
         EXIT FOREACH                                                                                                               
      END IF                                                                                                                        
   END FOREACH
   CALL g_apc.deleteElement(g_cnt)                                                                                                  
                                                                                                                                    
   LET l_rec_apc_b = g_cnt -1                                                                                       
   DISPLAY l_rec_apc_b TO FORMONLY.cnk
   IF g_apa.apa34 <> l_sum OR g_apa.apa34f <> l_sumf THEN
     #-MOD-AC0066-add-
     #CALL cl_getmsg('aap-984',g_lang) RETURNING g_msg  
      IF g_apa.apa41 = 'Y' THEN
         CALL cl_getmsg('aap-701',g_lang) RETURNING l_msg
         CALL cl_getmsg('aap-918',g_lang) RETURNING g_msg
         LET g_msg = g_msg,l_msg
      ELSE
         CALL cl_getmsg('aap-984',g_lang) RETURNING g_msg
      END IF
     #-MOD-AC0066-add-
      WHILE TRUE
         LET g_chr=' '
         LET INT_FLAG = 0
         #CHI-750003..............begin
         IF g_apa.apa08='MISC' THEN
            LET g_chr='2'
         ELSE
         #CHI-750003..............end
            PROMPT g_msg CLIPPED FOR CHAR g_chr
               ON IDLE g_idle_seconds
                  CALL cl_on_idle()

               ON ACTION about         #TQC-860021
                  CALL cl_about()      #TQC-860021

               ON ACTION help          #TQC-860021
                  CALL cl_show_help()  #TQC-860021

               ON ACTION controlg      #TQC-860021
                  CALL cl_cmdask()     #TQC-860021
            END PROMPT
            IF INT_FLAG THEN LET INT_FLAG = 0 EXIT WHILE END IF
         END IF
        #IF g_chr ='2' THEN                #MOD-AC0066 mark 
         IF g_chr ='2' OR g_chr ='Y' THEN  #MOD-AC0066
           DELETE FROM apc_file
            WHERE apc01 = g_apa.apa01 
           IF SQLCA.sqlcode THEN
              CALL cl_err3("del","apc_file",g_apa.apa01,g_apc_t.apc02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
              RETURN
           END IF
            CALL t110_ins_apc(g_apa.*)
            #CALL t110_apc_check()  #TQC-790167   #MOD-830059
            CALL t110_apc_check('')  #TQC-790167   #MOD-830059
            CALL g_apc.clear()
            LET g_cnt =1
           #FOREACH apc_curs USING g_apa.apa01 INTO g_apc[g_cnt].*,l_apc13,l_apc14,l_apc15 #MOD-980002                                       
            FOREACH apc_curs USING g_apa.apa01 INTO g_apc[g_cnt].*,g_apc1[g_cnt].*         #MOD-980002 
               IF SQLCA.sqlcode THEN                                                                                                         
                  CALL cl_err('foreach:',SQLCA.sqlcode,1)                                                                                    
                  EXIT FOREACH                                                                                                               
               END IF      
               LET i= g_cnt                                                                                                                  
               CALL t110_apc03('d')
               IF cl_null(g_apc[g_cnt].apc09) THEN
                  LET g_apc[g_cnt].apc09 =0
               END IF
               IF cl_null(g_apc[g_cnt].apc08) THEN
                  LET g_apc[g_cnt].apc08 =0
               END IF
               LET g_cnt = g_cnt + 1                                                                                                         
               IF g_cnt > g_max_rec THEN                                                                                                     
                  CALL cl_err( '', 9035, 0 )                                                                                                 
                  EXIT FOREACH                                                                                                               
               END IF                                                                                                                        
            END FOREACH
            CALL g_apc.deleteElement(g_cnt)                                                                                                  
            LET l_rec_apc_b = g_cnt -1                                                                                       
            DISPLAY l_rec_apc_b TO FORMONLY.cnk
            EXIT WHILE
         END IF                                                                                                                                 
        #IF g_chr MATCHES "[12]" THEN EXIT WHILE END IF    #MOD-AC0066 mark
        #-MOD-AC0066-add-
         IF g_apa.apa41 = 'Y' THEN
            IF g_chr MATCHES "[YN]" THEN EXIT WHILE END IF   
         ELSE
            IF g_chr MATCHES "[12]" THEN EXIT WHILE END IF  
         END IF
        #-MOD-AC0066-add-
      END WHILE
   END IF                                                                                                                                 

   LET i= 1
   LET l_allow_insert = cl_detail_input_auth("insert")
   LET l_allow_delete = cl_detail_input_auth("delete")
   LET l_allow_update = TRUE
#No.MOD-780152--begin
   IF g_hold ='2' THEN
      LET l_allow_insert = FALSE
      LET l_allow_delete = FALSE
      CALL cl_set_comp_entry("apc02,apc03,apc03_pma02,apc04,apc05,apc06,apc07,apc08,apc09,apc10,apc11,apc12",FALSE)
      CALL cl_set_comp_entry("apc62",TRUE)
   END IF
#No.MOD-780152--end
   #CHI-A50042 add --start--
   IF g_modify_date ='Y' THEN
      LET l_allow_insert = FALSE
      LET l_allow_delete = FALSE
      CALL cl_set_comp_entry("apc02,apc03_pma02,apc06,apc07,apc08,apc09,apc10,apc11,apc16,apc12",FALSE)
      CALL cl_set_comp_entry("apc03,apc04,apc05",TRUE)
   END IF
   #CHI-A50042 add --end--
   #FUN-880113--begin--                                                                                                             
   LET g_sn1 = 'N'
   IF g_aptype = '11' OR g_aptype = '12' OR g_aptype = '13' OR g_aptype = '15' OR
      g_aptype = '17' OR g_aptype = '21' OR g_aptype = '22' THEN                       #No.MOD-B90020 add
     #g_aptype = '17' OR g_aptype = '16' OR g_aptype = '21' OR g_aptype = '22' THEN    #No.MOD-B90020 mark
      SELECT count(*) INTO l_n1 FROM pmb_file
       WHERE pmb01 = g_apa.apa11 
      IF l_n1 <= 0 THEN 
         LET g_sn1 = 'Y'
      END  IF
   END IF
   #FUN-880113--end-- 
#No.TQC-6B0066--begin
   IF g_aptype MATCHES '1*'  THEN                                                                           
      LET l_max_rec=g_max_rec                                                                                              
   END IF                                                                                                    
   IF g_aptype MATCHES '2*'  THEN                                                                              
      LET l_max_rec = 1                                                                                     
   END IF   
#No.TQC-6B0066--end
#No.MOD-740369--begin
   SELECT SUM(apc08),SUM(apc09),SUM(apc10),SUM(apc11) 
     INTO l_apc08,l_apc09,l_apc10,l_apc11 FROM apc_file 
    WHERE apc01 =g_apa.apa01
   DISPLAY l_apc08 TO amt1
   DISPLAY l_apc09 TO amt2
   DISPLAY l_apc10 TO pay1
   DISPLAY l_apc11 TO pay2
#No.MOD-740369--end
  #IF g_apa.apa63 <> '0' OR g_apa.apa41 <> 'N' OR g_prog ='aapq230' OR g_prog ='aapq240' #CHI-A50042 mark
  #   OR g_sn1 = 'Y' THEN   #FUN-880113  #CHI-A50042 mark
  #IF (g_apa.apa63 <> '0' OR g_apa.apa41 <> 'N' OR g_prog ='aapq230' OR g_prog ='aapq240'                        #CHI-A50042    #No.MOD-B90020 mark                 
   IF (g_apa.apa63 <> '0' OR g_apa.apa41 <> 'N' OR g_prog ='aapq230' OR g_prog ='aapq240' OR g_prog = 'aapt160'  #MOD-B90020 add                   
     #OR g_sn1 = 'Y' ) AND g_modify_date IS NULL THEN   #FUN-880113  #CHI-A50042                                 #MOD-AA0187 mark
     #OR g_sn1 = 'Y' ) AND g_modify_date IS NULL AND g_hold <> '2' THEN   #FUN-880113  #CHI-A50042               #MOD-AA0187                      #MOD-AB0162 mark
      OR g_sn1 = 'Y' ) AND g_modify_date IS NULL AND (g_hold IS NULL OR g_hold <> '2') THEN   #FUN-880113  #CHI-A50042  #MOD-AA0187  #MOD-AB0162
      DISPLAY ARRAY g_apc TO s_apc.* ATTRIBUTE(COUNT=g_rec_b,UNBUFFERED) 
   ELSE
      INPUT ARRAY g_apc WITHOUT DEFAULTS FROM s_apc.*
#            ATTRIBUTE(COUNT=l_rec_apc_b,MAXCOUNT=g_max_rec,UNBUFFERED,
            ATTRIBUTE(COUNT=l_rec_apc_b,MAXCOUNT=l_max_rec,UNBUFFERED,             #No.TQC-6B0066
                      INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)

         BEFORE INSERT
            LET i = ARR_CURR()
            LET p_cmd='a'
            INITIALIZE g_apc[i].* TO NULL
            LET g_apc_t.* = g_apc[i].*
            NEXT FIELD apc02
 
         AFTER INSERT
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
            INSERT INTO apc_file(apc01,apc02,apc03,apc04,apc05,apc06,apc07,apc08,apc09,apc10,apc11,apc16,apc12,apc13,apc14,apc15)
             VALUES(g_apa.apa01,g_apc[i].apc02,g_apc[i].apc03,
                    g_apc[i].apc04,g_apc[i].apc05,g_apc[i].apc06,
                    g_apc[i].apc07,g_apc[i].apc08,g_apc[i].apc09,
                   #g_apc[i].apc10,g_apc[i].apc11,g_apc[i].apc16,g_apc[i].apc12,l_apc13,l_apc14,l_apc15) #MOD-980002
                    g_apc[i].apc10,g_apc[i].apc11,g_apc[i].apc16,g_apc[i].apc12,g_apc1[i].apc13,g_apc[i].apc14,g_apc[i].apc15) #MOD-980002 #MOD-B70047 mod g_apc1 -> g_apc
            IF SQLCA.sqlcode THEN
               CALL cl_err3("ins","apc_file",g_apa.apa01,g_apc[i].apc02,SQLCA.sqlcode,"","ins apc:",1)  
               LET g_success = 'N'
               CANCEL INSERT
            ELSE
               LET l_rec_apc_b = l_rec_apc_b + 1
               MESSAGE "insert ok"
               DISPLAY l_rec_apc_b TO FORMONLY.cnk
            END IF

         BEFORE INPUT
            IF l_rec_apc_b != 0 THEN
               CALL fgl_set_arr_curr(i)
            END IF
          #TQC-770027.....begin
            CALL t110_set_entry(p_cmd)
            CALL t110_set_entry_1()     #No:FUN-8A0075
            CALL t110_set_no_entry(p_cmd)
            CALL t110_set_entry_1()     #No:FUN-8A0075
          #TQC-770027.....end

         BEFORE ROW
            LET p_cmd = ''
            LET i = ARR_CURR()
            LET l_lock_sw = 'N'
            IF l_rec_apc_b >= i THEN
               LET p_cmd='u'
               LET g_apc_t.* = g_apc[i].*
               OPEN apc_curs_bcl USING g_apa.apa01,g_apc_t.apc02                                                                          
               IF STATUS THEN                                                                                                          
                  CALL cl_err("OPEN i010_bcl:", STATUS, 1)                                                                             
                  LET l_lock_sw = "Y"                                                                                                  
               ELSE                                                                                                                    
                  FETCH apc_curs_bcl INTO g_apc[i].*                                                                                    
                  IF SQLCA.sqlcode THEN                                                                                                
                     CALL cl_err(g_apa.apa01,SQLCA.sqlcode,1)                                                                      
                     LET l_lock_sw = "Y"                                                                                               
                  END IF                                                                                                               
                  CALL t110_apc03('d')
               END IF        
            END IF

         BEFORE FIELD apc02
            IF cl_null(g_apc[i].apc02) OR g_apc[i].apc02 = 0 THEN
               SELECT MAX(apc02)+1 INTO g_apc[i].apc02 FROM apc_file
                WHERE apc01 = g_apa.apa01
               IF cl_null(g_apc[i].apc02)  THEN
                  LET g_apc[i].apc02 = 1
               END IF
            END IF

         AFTER FIELD apc02
            IF g_apc_t.apc02 IS NULL OR
               g_apc_t.apc02 != g_apc[i].apc02 THEN
               SELECT COUNT(*) INTO g_cnt FROM apc_file
                   WHERE apc01 = g_apa.apa01 AND apc02 = g_apc[i].apc02
               IF g_cnt > 0 THEN
                  CALL cl_err('',-239,0)
                  NEXT FIELD apc02
               END IF
            END IF


         AFTER FIELD apc03
            IF NOT cl_null(g_apc[i].apc03) THEN
               CALL t110_apc03('a') 
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apc[i].apc03,g_errno,1)
                  LET g_apc[i].apc03 =NULL
                  NEXT FIELD apc03
               END IF
               IF p_cmd ='a' OR (p_cmd ='u' AND (g_apc[i].apc03 !=g_apc_t.apc03
                                                 OR g_apc_t.apc03 IS NULL)) THEN
                  SELECT COUNT(apc01) INTO l_n 
                    FROM apc_file 
                   WHERE apc01 =g_apa.apa01
                     AND apc03 =g_apc[i].apc03
                  IF l_n >0 THEN
                     CALL cl_err(g_apc[i].apc03,'aap-917',1)
                     LET g_apc[i].apc03 =null
                     NEXT FIELD apc03
                  END IF 
                  #No.FUN-690080 --Begin
                  IF g_aptype = '13' OR g_aptype = '17' THEN
                     CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apc[i].apc03,'EMPL')
                          RETURNING g_apc[i].apc04,g_apc[i].apc05,g_temp
                  ELSE
                     CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apc[i].apc03,g_apa.apa06)
                          RETURNING g_apc[i].apc04,g_apc[i].apc05,g_temp
                  END IF
                  #No.FUN-690080 --End
                  SELECT pmb05 INTO l_pmb05 FROM pmb_file
                   WHERE pmb01 =g_apa.apa11
                     AND pmb04 =g_apc[i].apc03
                  IF cl_null(l_pmb05) THEN
                     LET l_pmb05 =100   #MOD-920034 mod 0->100
                  END IF
                  LET g_apc[i].apc06 = g_apa.apa14
                  LET g_apc[i].apc07 = g_apa.apa72
                  LET g_apc[i].apc08 = g_apa.apa34f*l_pmb05/100
                  LET g_apc[i].apc09 = g_apa.apa34*l_pmb05/100
                  LET g_apc[i].apc10 = 0
                  LET g_apc[i].apc11 = 0
                  LET g_apc[i].apc12 = g_apa.apa08
                  LET g_apc1[i].apc13 = g_apc[i].apc09 -g_apc[i].apc11 #l_acp13-->g_apc1[i].apc13
                  LET g_apc[i].apc14 = 0 #MOD-980002 l_apc14-->g_apc1[i].apc14 #MOD-B70047 mod g_apc1 -> g_apc 
                  LET g_apc[i].apc15 = 0 #MOD-980002 l_apc15-->g_apc1[i].apc15 #MOD-B70047 mod g_apc1 -> g_apc 
                  LET g_apc[i].apc16 = 0
               END IF
            ELSE
               DISPLAY ' ' TO FORMONLY.apc03_pma02
            END IF

           AFTER FIELD apc08
             #LET g_apc[i].apc08 = cl_digcut(g_apc[i].apc08,g_azi.azi04)   #MOD-6B0066
             LET g_apc[i].apc08 = cl_digcut(g_apc[i].apc08,t_azi04)   #MOD-6B0066
             LET g_apc[i].apc09 = g_apc[i].apc08*g_apc[i].apc06      
             #LET g_apc[i].apc09 = cl_digcut(g_apc[i].apc09,t_azi.azi04)   #MOD-6B0066
             LET g_apc[i].apc09 = cl_digcut(g_apc[i].apc09,g_azi04)   #MOD-6B0066
             LET g_apc1[i].apc13 = cl_digcut(g_apc[i].apc09,g_azi04)   #MOD-AB0256
       
           AFTER FIELD apc09
             #LET g_apc[i].apc09 = cl_digcut(g_apc[i].apc09,t_azi.azi04)   #MOD-6B0066
             LET g_apc[i].apc09 = cl_digcut(g_apc[i].apc09,g_azi04)   #MOD-6B0066
             LET g_apc1[i].apc13 = cl_digcut(g_apc[i].apc09,g_azi04)   #MOD-AB0256
             #LET g_apc[i].apc08 = g_apc[i].apc09/g_apc[i].apc06      #MOD-8A0079
             #LET g_apc[i].apc08 = cl_digcut(g_apc[i].apc08,g_azi.azi04)   #MOD-6B0066
             #LET g_apc[i].apc08 = cl_digcut(g_apc[i].apc08,t_azi04)   #MOD-6B0066  #MOD-8A0079

         #TQC-770027.....begin
           AFTER FIELD apc10
             IF NOT cl_null(g_apc[i].apc10) THEN
#               LET l_apc10 = l_apc10 + g_apc[i].apc10   #TQC-790128
                IF l_apc10 > g_apc[i].apc08 THEN
                   CALL cl_err(g_apc[i].apc10,'aap-931',0)
                   LET g_apc[i].apc10 = NULL
                   NEXT FIELD apc10
                END IF
                IF l_apc10 > g_apa.apa35f THEN
                   CALL cl_err(g_apc[i].apc10,'aap-930',0)
                   LET g_apc[i].apc10 = NULL
                   NEXT FIELD apc10
                END IF
                LET g_apc[i].apc10 = cl_digcut(g_apc[i].apc10,g_azi04) 
                LET g_apc[i].apc11 = g_apc[i].apc10*g_apc[i].apc06
                LET g_apc[i].apc11 = cl_digcut(g_apc[i].apc11,g_azi04) 
             END IF

           AFTER FIELD apc11
             IF NOT cl_null(g_apc[i].apc11) THEN
#               LET l_apc11 = l_apc11 + g_apc[i].apc11  #TQC-790128
                IF l_apc11 > g_apc[i].apc09 THEN
                   CALL cl_err(g_apc[i].apc11,'aap-933',0)
                   LET g_apc[i].apc11 = NULL
                   NEXT FIELD apc11
                END IF
                IF l_apc11 > g_apa.apa35 THEN
                   CALL cl_err(g_apc[i].apc11,'aap-932',0)
                   LET g_apc[i].apc11 = NULL
                   NEXT FIELD apc11
                END IF
                LET g_apc[i].apc11 = cl_digcut(g_apc[i].apc11,g_azi04) 
                LET g_apc[i].apc10 = g_apc[i].apc11/g_apc[i].apc06
                LET g_apc[i].apc10 = cl_digcut(g_apc[i].apc10,g_azi04) 
             END IF
          #TQC-770027.....end

           AFTER FIELD apc16
             IF NOT cl_null(g_apc[i].apc16) THEN
                IF g_apc[i].apc16 > g_apc[i].apc08 -g_apc[i].apc10 THEN
                   CALL cl_err(g_apc[i].apc16,'aap-922',0)
                   LET g_apc[i].apc16 =NULL
                   NEXT FIELD apc16
                END IF
             END IF

         ON ACTION CONTROLP
              CASE
                WHEN INFIELD(apc03)
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_pma"
                   LET g_qryparam.default1 =g_apc[i].apc03
                   CALL cl_create_qry() RETURNING g_apc[i].apc03
                   DISPLAY g_apc[i].apc03 TO apc03
                   NEXT FIELD apc03
              END CASE

           BEFORE DELETE                            #是否取消單身
              IF g_apc[i].apc02 > 0 AND g_apc_t.apc02 IS NOT NULL THEN
                 IF NOT cl_delb(0,0) THEN
                    CANCEL DELETE
                 END IF
                 DELETE FROM apc_file
                  WHERE apc01 = g_apa.apa01 AND apc02 = g_apc_t.apc02
                 IF SQLCA.sqlcode THEN
                    CALL cl_err3("del","apc_file",g_apa.apa01,g_apc_t.apc02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
                    CANCEL DELETE
                 END IF
                 LET l_rec_apc_b = l_rec_apc_b - 1
                 MESSAGE "delete ok"
              END IF


         ON ROW CHANGE
             IF INT_FLAG THEN
                CALL cl_err('',9001,0)
                LET INT_FLAG = 0
                LET g_apc[i].* = g_apc_t.*
                LET g_success = 'N'
                EXIT INPUT
             END IF
             IF l_lock_sw = 'Y' THEN
                CALL cl_err(g_apc[l_ac].apc02,-263,1)
                LET g_apc[l_ac].* = g_apc_t.*
             ELSE
                IF l_allow_update = TRUE THEN
                   UPDATE apc_file SET apc02 = g_apc[i].apc02,
                                       apc03 = g_apc[i].apc03,
                                       apc04 = g_apc[i].apc04,
                                       apc05 = g_apc[i].apc05,
                                       apc06 = g_apc[i].apc06,
                                       apc07 = g_apc[i].apc07,
                                       apc08 = g_apc[i].apc08,
                                       apc09 = g_apc[i].apc09,
                                       apc10 = g_apc[i].apc10,
                                       apc11 = g_apc[i].apc11,
                                       apc12 = g_apc[i].apc12,
                                       apc16 = g_apc[i].apc16,
                                       apc13 = g_apc1[i].apc13,  #MOD-980002 l_apc13-->g_apc1[i].apc13
                                       apc14 = g_apc[i].apc14,  #MOD-980002 l_apc14-->g_apc1[i].apc14 #MOD-B70047 mod g_apc1 -> g_apc 
                                       apc15 = g_apc[i].apc15   #MOD-980002 l_apc15-->g_apc1[i].apc15 #MOD-B70047 mod g_apc1 -> g_apc
                    WHERE apc01 = g_apa.apa01
                      AND apc02 = g_apc_t.apc02
                   IF STATUS OR SQLCA.SQLCODE THEN
                      CALL cl_err3("upd","apc_file",g_apa.apa01,g_apc_t.apc02,SQLCA.sqlcode,"","upd apc:",1)  #No.FUN-660122
                      LET g_success = 'N'
                      LET g_apc[i].* = g_apc_t.*
                      ELSE MESSAGE "update ok"  
                   END IF
                END IF
             END IF

         AFTER ROW
#No.MOD-740369--begin
             SELECT SUM(apc08),SUM(apc09),SUM(apc10),SUM(apc11) 
               INTO l_apc08,l_apc09,l_apc10,l_apc11 FROM apc_file 
              WHERE apc01 =g_apa.apa01
             DISPLAY l_apc08 TO amt1
             DISPLAY l_apc09 TO amt2
             DISPLAY l_apc10 TO pay1
             DISPLAY l_apc11 TO pay2
#No.MOD-740369--end
             LET l_ac = ARR_CURR()
             IF INT_FLAG THEN
                CALL cl_err('',9001,0)
                LET INT_FLAG = 0
                IF p_cmd = 'u' THEN
                   LET g_apc[l_ac].* = g_apc_t.*
                END IF
                LET g_success = 'N'
                EXIT INPUT
             END IF

         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE INPUT
 
         ON ACTION about         #MOD-4C0121
            CALL cl_about()      #MOD-4C0121
 
         ON ACTION help          #MOD-4C0121
            CALL cl_show_help()  #MOD-4C0121
 
         ON ACTION controlg      #MOD-4C0121
            CALL cl_cmdask()     #MOD-4C0121
  
         ON ACTION controls                       #No.FUN-6B0033                                                                       
            CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033

         #No.MOD-580365  --begin
      END INPUT
   END IF
   IF INT_FLAG THEN
      LET g_success='N'
      LET INT_FLAG = 0
   END IF

   IF g_success = 'Y' THEN
      COMMIT WORK
      MESSAGE "Commit"
   ELSE
      ROLLBACK WORK
      MESSAGE "RollBack"
   END IF

#No.TQC-740159--BEGIN 
   LET l_apc08_sum = 0
   LET l_apc09_sum = 0
   LET l_apc10_sum = 0  #TQC-790128
   LET l_apc11_sum = 0  #TQC-790128
#No.MOD-A50183 --begin
   SELECT apa34,apa34f,apa35,apa35f 
     INTO g_apa.apa34,g_apa.apa34f,g_apa.apa35,g_apa.apa35f
     FROM apa_file
    WHERE apa01 = g_apa.apa01
#No.MOD-A50183 --end
  #SELECT SUM(apc08),SUM(apc09),SUM(apc10),SUM(apc11) #TQC-790128 add apc10,apc11             #MOD-B60066 mark 
   SELECT SUM(apc08-apc14),SUM(apc09-apc15),SUM(apc10),SUM(apc11) #TQC-790128 add apc10,apc11 #MOD-B60066
     INTO l_apc08_sum,l_apc09_sum,l_apc10_sum,l_apc11_sum #TQC-790128 add l_apc10_sum,l_apc11_sum
     FROM apc_file WHERE apc01 =g_apa.apa01
  #IF l_apc08_sum <> g_apa.apa34f OR l_apc09_sum <> g_apa.apa34 OR                          #MOD-AC0066 mark 
  #   l_apc10_sum <> g_apa.apa35f OR l_apc11_sum <> g_apa.apa35 THEN  #TQC-790128 add       #MOD-AC0066 mark
  IF g_apa.apa63 MATCHES '[0]' THEN         #MOD-D90164
   IF (l_apc08_sum <> g_apa.apa34f OR l_apc09_sum <> g_apa.apa34 OR                         #MOD-AC0066 
      l_apc10_sum <> g_apa.apa35f OR l_apc11_sum <> g_apa.apa35) AND g_apa.apa41 = 'N' THEN #MOD-AC0066
     #str TQC-B60291 add
     IF g_apa.apa41='Y' THEN
        CALL cl_err('','aap-918',0)
     ELSE
     #end TQC-B60291 add
        CALL cl_err('','aap-918',1)
        COMMIT WORK
        CLOSE WINDOW t110_apc_w
        CALL t110_account_period()
     END IF  #TQC-B60291 add
   END IF
 END IF              #MOD-D90164
#No.TQC-740159--END

   CLOSE WINDOW t110_apc_w

   SELECT MAX(apc04),MAX(apc05) INTO g_apa.apa12,g_apa.apa64 FROM apc_file
    WHERE apc01 =g_apa.apa01
   IF NOT cl_null(g_apa.apa12) AND NOT cl_null(g_apa.apa64) THEN    #No.MOD-740369
      UPDATE apa_file SET apa12 =g_apa.apa12,
                          apa64 =g_apa.apa64
                    WHERE apa01 =g_apa.apa01
      #CALL t110_show()   #MOD-810013
      DISPLAY BY NAME g_apa.apa12,g_apa.apa64   #MOD-810013
   END IF                                                           #No.MOD-740369
#No.MOD-740369--begin
   SELECT SUM(apc16) INTO g_apa.apa20 FROM apc_file 
    WHERE apc01 =g_apa.apa01
  #MOD-990200   ---start
  #UPDATE apa_file SET apa20 =g_apa.apa20
  # WHERE apa01 =g_apa.apa01
   IF g_apa.apa20 > 0  THEN
      IF cl_null(g_apa.apa19) THEN  #MOD-B30233 add
         LET g_apa.apa19 = g_apz.apz12
      END IF                        #MOD-B30233 add
      UPDATE apa_file SET apa20 = g_apa.apa20,
                         #apa19 = g_apz.apz12   #MOD-B30233 mark
                          apa19 = g_apa.apa19   #MOD-B30233 add
       WHERE apa01 =g_apa.apa01
      DISPLAY BY NAME g_apa.apa19,g_apa.apa20
      CALL t110_apa19('d')
   END IF
  #MOD-990200   ---end
#No.MOD-740369--end
   IF l_lock_sw = 'Y' THEN
      RETURN
   END IF
END FUNCTION
#TQC-790128.....begin
#FUNCTION t110_apc_check()   #MOD-830059
FUNCTION t110_apc_check(l_flag)   #MOD-830059
   DEFINE l_sql      STRING    
   DEFINE l_m       LIKE type_file.chr1    
   DEFINE l_apc02   LIKE apc_file.apc02
   DEFINE l_apc08   LIKE apc_file.apc08
   DEFINE l_apc09   LIKE apc_file.apc09
   DEFINE l_apc13   LIKE apc_file.apc13
   DEFINE l_apc14   LIKE apc_file.apc14
   DEFINE l_apc15   LIKE apc_file.apc15
   DEFINE l_amt     LIKE apc_file.apc08
   DEFINE l_amtf    LIKE apc_file.apc09      #No.TQC-7B0100
   DEFINE l_sum,l_sumf  LIKE  apc_file.apc08     
   DEFINE l_apc08_sum   LIKE apc_file.apc08     
   DEFINE l_apc09_sum   LIKE apc_file.apc09   
   DEFINE l_apc10_sum   LIKE apc_file.apc10   
   DEFINE l_apc11_sum   LIKE apc_file.apc11 
   DEFINE l_apc10   LIKE apc_file.apc10
   DEFINE l_apc11   LIKE apc_file.apc11
   DEFINE l_apg05f  LIKE apg_file.apg05f
   DEFINE l_apg05   LIKE apg_file.apg05
   DEFINE l_flag    LIKE type_file.chr1   #MOD-830059
   DEFINE l_i,l_n   LIKE type_file.num5   #MOD-830059

   CALL g_apc.clear()
   LET g_cnt =1

  #LET l_sql ="SELECT apc02,apc03,'',apc04,apc05,apc06,apc07,apc08,apc09,apc10,apc11,apc16,apc12,apc13,apc14,apc15",#TQC-C50047 add
   LET l_sql ="SELECT apc02,apc03,'',apc04,apc05,apc06,apc07,apc08,apc09,apc10,apc11,apc16,apc12,apc14,apc15,apc13",#TQC-C50047 add
              "  FROM apc_file",
              " WHERE apc01 = ?",
              " ORDER BY apc02"
   PREPARE t110_apc_pb1 FROM l_sql                                                                                                       
   DECLARE apc_curs1 CURSOR FOR t110_apc_pb1
 
   LET l_sum =0
   LET l_sumf =0
   LET l_amt  =0   LET l_amtf =0   #MOD-880080 add
  #str MOD-880080 mod
   LET l_amtf = g_apa.apa35f                        #MOD-880222 mark回復
   LET l_amt  = g_apa.apa35      #No.TQC-7B0100     #MOD-880222 mark回復
 # SELECT SUM(aph05f),SUM(aph05) INTO l_amtf,l_amt  #MOD-880222 mark
 #   FROM aph_file WHERE aph01=g_apa.apa01          #MOD-880222 mark
  #end MOD-880080 mod
   LET l_m = 'y'
   UPDATE apc_file SET apc10=0,
                       apc11=0,
                       apc13=apc09      #MOD-830059 add
                 WHERE apc01=g_apa.apa01
 #str MOD-880080 mark回復---
  #str MOD-860245 mark
   #-----MOD-830059---------
   IF l_flag = 'w' THEN
      DELETE FROM apg_file WHERE apg01 = g_apa.apa01
      LET l_i = 1
   END IF
   #-----END MOD-830059-----
  #end MOD-860245 mark
 #end MOD-880080 mark回復---
  #FOREACH apc_curs1 USING g_apa.apa01 INTO g_apc[g_cnt].*,l_apc13,l_apc14,l_apc15 #MOD-B70047 mark
   FOREACH apc_curs1 USING g_apa.apa01 INTO g_apc[g_cnt].*,l_apc13                 #MOD-B70047
      IF SQLCA.sqlcode THEN                                                                                                         
         CALL cl_err('foreach:',SQLCA.sqlcode,1)                                                                                    
         EXIT FOREACH                                                                                                               
      END IF      
      IF cl_null(g_apc[g_cnt].apc09) THEN
         LET g_apc[g_cnt].apc09 =0
      END IF
      IF cl_null(g_apc[g_cnt].apc08) THEN
         LET g_apc[g_cnt].apc08 =0
      END IF
      IF cl_null(g_apc[g_cnt].apc10) THEN
         LET g_apc[g_cnt].apc10 =0
      END IF
      IF cl_null(g_apc[g_cnt].apc11) THEN
         LET g_apc[g_cnt].apc11 =0
      END IF
     #IF cl_null(l_apc15) THEN   #MOD-B60066 #MOD-B70047 mark
     #   LET l_apc15 =0          #MOD-B60066 #MOD-B70047 mark
      IF cl_null(g_apc[g_cnt].apc15) THEN    #MOD-B70047 
         LET g_apc[g_cnt].apc15 =0           #MOD-B70047
      END IF                     #MOD-B60066
      LET l_sum =l_sum + g_apc[g_cnt].apc09
      LET l_sumf=l_sumf+ g_apc[g_cnt].apc08
#     IF l_amt <= g_apc[g_cnt].apc08 THEN
      IF l_amtf <= g_apc[g_cnt].apc08 THEN     #No.TQC-7B0100
#No.TQC-7B0100 --begin
         UPDATE apc_file SET apc10=l_amtf,
#                            apc11=l_amt*g_apc[g_cnt].apc06,
#                            apc13=g_apc[g_cnt].apc09-(l_amt*g_apc[g_cnt].apc06)  #No.MOD-7B0096
                             apc11=l_amt,
                             #apc13=g_apc[g_cnt].apc09-l_amt   #MOD-830059
                            #apc13=apc13-l_amt-l_apc15   #MOD-830059 #MOD-B60066 #MOD-B70047 mark
                             apc13=apc13-l_amt-g_apc[g_cnt].apc15    #MOD-B70047 
#No.TQC-7B0100 --end
          WHERE apc01 = g_apa.apa01
            AND apc02 = g_apc[g_cnt].apc02
         IF SQLCA.sqlcode THEN
            CALL cl_err3("del","apc_file",g_apa.apa01,g_apc_t.apc02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
            RETURN
         END IF
       #str MOD-880080 mark回復---
        #str MOD-860245 mark
         #-----MOD-830059---------
         IF l_flag = 'w' THEN
            INSERT INTO apg_file(apg01,apg02,apg03,apg04,apg05f,apg05,apg06)
                VALUES(g_apa.apa01,l_i,g_plant,g_apa.apa01,l_amtf,l_amt,g_apc[g_cnt].apc02)
            IF SQLCA.sqlcode OR SQLCA.SQLERRD[3] = 0 THEN
               CALL cl_err3("ins","apg_file",g_apa.apa01, g_apc[g_cnt].apc02,SQLCA.sqlcode,"","",1)  
               RETURN
            END IF
            LET l_i = l_i + 1
         END IF
         #-----END MOD-830059-----
        #end MOD-860245 mark
       #end MOD-880080 mark回復---
         EXIT FOREACH
      ELSE
#No.TQC-7B0100 --begin
         IF l_amt >=g_apc[g_cnt].apc09 THEN
            UPDATE apc_file SET apc10=g_apc[g_cnt].apc08,
                                apc11=g_apc[g_cnt].apc09,
                                apc13= 0
             WHERE apc01=g_apa.apa01
               AND apc02 = g_apc[g_cnt].apc02
            IF SQLCA.sqlcode THEN
               CALL cl_err3("del","apc_file",g_apa.apa01,g_apc_t.apc02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
               RETURN
            END IF
            LET l_amtf = l_amtf - g_apc[g_cnt].apc08  
            LET l_amt  = l_amt  - g_apc[g_cnt].apc09    
          #str MOD-880080 mark回復---
           #str MOD-860245 mark
            #-----MOD-830059---------
            IF l_flag = 'w' THEN
               INSERT INTO apg_file(apg01,apg02,apg03,apg04,apg05f,apg05,apg06)
                   VALUES(g_apa.apa01,l_i,g_plant,g_apa.apa01,g_apc[g_cnt].apc08,g_apc[g_cnt].apc09,g_apc[g_cnt].apc02)
               IF SQLCA.sqlcode OR SQLCA.SQLERRD[3] = 0 THEN
                  CALL cl_err3("ins","apg_file",g_apa.apa01, g_apc[g_cnt].apc02,SQLCA.sqlcode,"","",1)  
                  RETURN
               END IF
               LET l_i = l_i + 1
            END IF
            #-----END MOD-830059-----
           #end MOD-860245 mark
          #end MOD-880080 mark回復---
         ELSE
            UPDATE apc_file SET apc10=g_apc[g_cnt].apc08,
                                apc11=l_amt,
                                #apc13=g_apc[g_cnt].apc09-l_amt   #MOD-830059
                                apc13=apc13-l_amt   #MOD-830059
             WHERE apc01=g_apa.apa01
               AND apc02 = g_apc[g_cnt].apc02
            IF SQLCA.sqlcode THEN
               CALL cl_err3("del","apc_file",g_apa.apa01,g_apc_t.apc02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
               RETURN
            END IF
            LET l_amtf = l_amtf - g_apc[g_cnt].apc08  
            LET l_amt =0
          #str MOD-880080 mark回復---
           #str MOD-860245 mark
            #-----MOD-830059---------
            IF l_flag = 'w' THEN
               INSERT INTO apg_file(apg01,apg02,apg03,apg04,apg05f,apg05,apg06)
                   VALUES(g_apa.apa01,l_i,g_plant,g_apa.apa01,g_apc[g_cnt].apc08,l_amt,g_apc[g_cnt].apc02)
               IF SQLCA.sqlcode OR SQLCA.SQLERRD[3] = 0 THEN
                  CALL cl_err3("ins","apg_file",g_apa.apa01, g_apc[g_cnt].apc02,SQLCA.sqlcode,"","",1)  
                  RETURN
               END IF
               LET l_i = l_i + 1
            END IF
            #-----END MOD-830059-----
           #end MOD-860245 mark
          #end MOD-880080 mark回復---
         END IF
#No.TQC-7B0100 --end
      END IF
      LET g_cnt = g_cnt + 1                                                                                                         
      IF g_cnt > g_max_rec THEN                                                                                                     
         CALL cl_err( '', 9035, 0 )                                                                                                 
         EXIT FOREACH                                                                                                               
      END IF                                                                                                                        
   END FOREACH
 #str MOD-880080 mark回復---
  #str MOD-860245 mark
   #-----MOD-830059---------
   IF l_flag = 'w' THEN
      SELECT COUNT(*) INTO l_n FROM aph_file WHERE aph01 =g_apa.apa01
      IF l_n =0 THEN
         DELETE FROM apg_file WHERE apg01 =g_apa.apa01
      END IF
   END IF
   #-----END MOD-830059-----
  #end MOD-860245 mark
 #end MOD-880080 mark回復---
   CALL g_apc.deleteElement(g_cnt)                                                                                                  
END FUNCTION
#TQC-790128.....end

#-----CHI-820015---------
FUNCTION t110_apc_check2()   
   DEFINE l_sql      STRING    
   DEFINE l_amtf    LIKE apc_file.apc09      
   DEFINE l_amt     LIKE apc_file.apc08
   DEFINE l_apc13   LIKE apc_file.apc13   #MOD-C60060

   CALL g_apc.clear()
   LET g_cnt =1

   LET l_sql ="SELECT apc02,apc03,'',apc04,apc05,apc06,apc07,apc08,apc09,apc10,apc11,apc16,apc12,apc14,apc15", #MOD-B70047 add apc14/apc15
              "  FROM apc_file",
              " WHERE apc01 = ?",
              " ORDER BY apc02"
   PREPARE t110_apc_pb2 FROM l_sql                                                                                                       
   DECLARE apc_curs2 CURSOR FOR t110_apc_pb2
 
   LET l_amtf = g_apa.apa65f
   LET l_amt = g_apa.apa65    
   UPDATE apc_file SET apc14=0,apc15=0 WHERE apc01=g_apa.apa01 
   FOREACH apc_curs2 USING g_apa.apa01 INTO g_apc[g_cnt].* 
      IF SQLCA.sqlcode THEN                                                                                                         
         CALL cl_err('foreach:',SQLCA.sqlcode,1)                                                                                    
         EXIT FOREACH                                                                                                               
      END IF      
      IF cl_null(g_apc[g_cnt].apc08) THEN
         LET g_apc[g_cnt].apc08 =0
      END IF
      IF cl_null(g_apc[g_cnt].apc09) THEN
         LET g_apc[g_cnt].apc09 =0
      END IF
      LET l_apc13 =  g_apc[g_cnt].apc09 - l_amt   #MOD-C60060 
      IF l_amtf <= g_apc[g_cnt].apc08 THEN  
         UPDATE apc_file SET apc14=l_amtf,
                             apc15=l_amt,       
                            #apc13=apc13-l_amt   #MOD-B60066  #MOD-C60060 mark
                             apc13=l_apc13       #MOD-C60060  
          WHERE apc01 = g_apa.apa01
            AND apc02 = g_apc[g_cnt].apc02
         IF SQLCA.sqlcode THEN
            CALL cl_err3("upd","apc_file",g_apa.apa01,g_apc[g_cnt].apc02,SQLCA.sqlcode,"","",1)  
            RETURN
         END IF
         EXIT FOREACH
      ELSE
         IF l_amt >=g_apc[g_cnt].apc09 THEN
            UPDATE apc_file SET apc14=g_apc[g_cnt].apc08,
                                apc15=g_apc[g_cnt].apc09,
                                apc13=apc13-g_apc[g_cnt].apc09  #MOD-B60066
             WHERE apc01=g_apa.apa01
               AND apc02 = g_apc[g_cnt].apc02
            IF SQLCA.sqlcode THEN
               CALL cl_err3("upd","apc_file",g_apa.apa01,g_apc[g_cnt].apc02,SQLCA.sqlcode,"","",1)  
               RETURN
            END IF
            LET l_amtf = l_amtf - g_apc[g_cnt].apc08  
            LET l_amt  = l_amt  - g_apc[g_cnt].apc09    
         ELSE
            UPDATE apc_file SET apc14=g_apc[g_cnt].apc08,
                                apc15=l_amt,
                                apc13=apc13-g_apc[g_cnt].apc09  #MOD-B60066
             WHERE apc01=g_apa.apa01
               AND apc02 = g_apc[g_cnt].apc02
            IF SQLCA.sqlcode THEN
               CALL cl_err3("upd","apc_file",g_apa.apa01,g_apc[g_cnt].apc02,SQLCA.sqlcode,"","",1)  
               RETURN
            END IF
            LET l_amtf = l_amtf - g_apc[g_cnt].apc08  
            LET l_amt =0
         END IF
      END IF
      LET g_cnt = g_cnt + 1                                                                                                         
      IF g_cnt > g_max_rec THEN                                                                                                     
         CALL cl_err( '', 9035, 0 )                                                                                                 
         EXIT FOREACH                                                                                                               
      END IF                                                                                                                        
   END FOREACH
   CALL g_apc.deleteElement(g_cnt)                                                                                                  
END FUNCTION
#-----END CHI-820015-----

FUNCTION t110_apc03(p_cmd)
 DEFINE p_cmd    LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
 DEFINE p_apc03  LIKE apc_file.apc03
 DEFINE l_pma02     LIKE pma_file.pma02
 DEFINE l_pmaacti   LIKE pma_file.pmaacti

 LET g_errno =' '
 SELECT pma02,pmaacti INTO l_pma02,l_pmaacti FROM pma_file 
  WHERE pma01 = g_apc[i].apc03

   CASE                                                                                                                             
       WHEN SQLCA.sqlcode=100   LET g_errno='100'                                                                               
                                LET l_pma02=NULL                                                                                    
       WHEN l_pmaacti='N'       LET g_errno='9028'                                                                                  
       OTHERWISE                                                                                                                    
            LET g_errno=SQLCA.sqlcode USING '------'                                                                                
   END CASE                                                                                                                         
   IF p_cmd='d' OR cl_null(g_errno)THEN   
      LET g_apc[i].apc03_pma02 =l_pma02                                                                                          
      IF SQLCA.sqlcode THEN 
         LET g_apc[i].apc03_pma02 =null                                                                                             
      END IF    
   END IF    
END FUNCTION

FUNCTION t110_ins_apc(m_apa)
DEFINE m_apa     RECORD LIKE apa_file.*
DEFINE l_cnt     LIKE type_file.num5    #No.FUN-690028 SMALLINT
DEFINE g_apc     RECORD LIKE apc_file.*
DEFINE g_pmb     RECORD LIKE pmb_file.*
DEFINE g_temp    STRING
DEFINE l_apc02   LIKE apc_file.apc02    #No.TQC-6B0066
DEFINE l_apc08   LIKE apc_file.apc08    #No.TQC-6B0066
DEFINE l_apc09   LIKE apc_file.apc09    #No.TQC-6B0066
DEFINE l_pmb02   LIKE pmb_file.pmb02    #TQC-770027
DEFINE l_apa20   LIKE apa_file.apa20    #MOD-A20091 add
DEFINE l_sumamtf LIKE apa_file.apa34f   #MOD-B60066
DEFINE l_sumamt  LIKE apa_file.apa34    #MOD-B60066

   SELECT COUNT(*) INTO l_cnt 
     FROM apc_file
    WHERE apc01 =m_apa.apa01    

   IF l_cnt >0 THEN
#     CALL cl_err('','aap-919',0)  #No.MOD-780152
      RETURN
   END IF

   LET l_cnt =0
#No.TQC-6B0066--begin
   SELECT azi04 INTO t_azi04 FROM azi_file                                                                                          
      #WHERE azi01 = g_apa.apa13   #TQC-C80061  mark
      WHERE azi01 = m_apa.apa13    #TQC-C80061  add
#No.TQC-6B0066--end   
   
  #IF NOT (g_aptype = '15' ) THEN   #No.TQC-7A0095
  #IF NOT (m_apa.apa00 = '23' ) THEN   #No.TQC-7C0094               #No.MOD-B90020 mark
   IF NOT (m_apa.apa00 = '23' ) AND NOT (m_apa.apa00 = '16') THEN   #No.TQC-7C0094 #No.MOD-B90020 add
      LET g_sql = " SELECT pmb01,pmb02,pmb03,pmb04,pmb05",
                  "   FROM pmb_file ",
                  "  WHERE pmb01 = '",m_apa.apa11,"'"
      PREPARE p110_p1 FROM g_sql
      DECLARE p110_c1 CURSOR FOR p110_p1
      #LET l_apa20 = g_apa.apa20        #MOD-A20091 add    #TQC-C80061  mark
      LET l_apa20 = m_apa.apa20                            #TQC-C80061  add
      IF cl_null(l_apa20) THEN LET l_apa20 = 0 END IF      #MOD-A30209 add
      FOREACH p110_c1 INTO g_pmb.pmb01,g_pmb.pmb02,g_pmb.pmb03,
                           g_pmb.pmb04,g_pmb.pmb05
         IF cl_null(g_pmb.pmb02) THEN CONTINUE FOREACH END IF 
         IF g_aptype MATCHES '2*' THEN CONTINUE FOREACH END IF   #MOD-810064 add
         IF g_pmb.pmb02 = 1 AND g_aptype MATCHES '1*' THEN          #No.TQC-6B0066
            LET g_apc.apc01 = m_apa.apa01
            LET g_apc.apc02 = g_pmb.pmb03
            LET g_apc.apc03 = g_pmb.pmb04
            #No.FUN-690080 --Begin
            IF g_aptype = '13' OR g_aptype = '17' THEN
               CALL s_paydate('a','',m_apa.apa09,m_apa.apa02,g_apc.apc03,'EMPL')
                    RETURNING g_apc.apc04,g_apc.apc05,g_temp
            ELSE
               CALL s_paydate('a','',m_apa.apa09,m_apa.apa02,g_apc.apc03,m_apa.apa06)
                    RETURNING g_apc.apc04,g_apc.apc05,g_temp
            END IF
           #str MOD-920034 add
            IF cl_null(g_pmb.pmb05) THEN 
               LET g_pmb.pmb05 =100
            END IF
           #end MOD-920034 add
            #No.FUN-690080 --End
            LET g_apc.apc06 = m_apa.apa14
            LET g_apc.apc07 = m_apa.apa72
            LET g_apc.apc08 = (m_apa.apa34f+m_apa.apa65f)*g_pmb.pmb05/100 #TQC-B60206 add apa65f 
            LET g_apc.apc09 = (m_apa.apa34+m_apa.apa65)*g_pmb.pmb05/100   #TQC-B60206 add apa65
   #TQC-770027.....begin
   #        LET g_apc.apc10 = 0
   #        LET g_apc.apc11 = 0
            IF g_apc.apc10 IS NULL THEN LET g_apc.apc10 = 0 END IF
            IF g_apc.apc11 IS NULL THEN LET g_apc.apc11 = 0 END IF
            #LET g_apc.apc10 = g_apa.apa35f*g_pmb.pmb05/100     #TQC-C80061  mark
            #LET g_apc.apc11 = g_apa.apa35*g_pmb.pmb05/100      #TQC-C80061  mark
            LET g_apc.apc10 = m_apa.apa35f*g_pmb.pmb05/100      #TQC-C80061  add
            LET g_apc.apc11 = m_apa.apa35*g_pmb.pmb05/100       #TQC-C80061  add
   #TQC-770027.....end
            LET g_apc.apc12 = m_apa.apa08
            LET g_apc.apc13 = g_apc.apc09-g_apc.apc11
           #LET g_apc.apc14 = 0                                #No.MOD-B90002 mark
            LET g_apc.apc14 = m_apa.apa65f*g_pmb.pmb05/100     #No.MOD-B90002 add
           #LET g_apc.apc15 = 0                                #No.MOD-B90002 mark
            LET g_apc.apc15 = m_apa.apa65*g_pmb.pmb05/100      #No.MOD-B90002 add
           #MOD-A20091---modify---start---
           #LET g_apc.apc16 = 0             
            IF l_apa20 >=(g_apc.apc08-g_apc.apc10) THEN
               LET g_apc.apc16 =g_apc.apc08-g_apc.apc10
               LET l_apa20 =l_apa20-g_apc.apc16
            ELSE  
               LET g_apc.apc16 =l_apa20
               LET l_apa20 =0
            END IF
           #MOD-A20091---modify---end---
         END IF
         IF g_pmb.pmb02 = 2  AND g_aptype MATCHES '1*' THEN          #No.TQC-6B0066
            LET g_apc.apc01 = m_apa.apa01
            LET g_apc.apc02 = 1
            LET g_apc.apc03 = m_apa.apa11
            LET g_apc.apc04 = m_apa.apa12
            LET g_apc.apc05 = m_apa.apa64
            LET g_apc.apc06 = m_apa.apa14
            LET g_apc.apc07 = m_apa.apa72
            LET g_apc.apc08 = m_apa.apa34f + m_apa.apa65f #TQC-B60206 add apa65f
            LET g_apc.apc09 = m_apa.apa34  + m_apa.apa65  #TQC-B60206 add apa65
           #MOD-9A0100   ---start
           #LET g_apc.apc10 = 0
           #LET g_apc.apc11 = 0
            LET g_apc.apc10 = m_apa.apa35f
            LET g_apc.apc11 = m_apa.apa35 
           #MOD-9A0100   ---end
            LET g_apc.apc12 = m_apa.apa08
            LET g_apc.apc13 = g_apc.apc09-g_apc.apc11
           #LET g_apc.apc14 = 0                       #No.MOD-B90002 mark
            LET g_apc.apc14 = m_apa.apa65f            #No.MOD-B90002 add
           #LET g_apc.apc15 = 0                       #No.MOD-B90002 mark
            LET g_apc.apc15 = m_apa.apa65             #No.MOD-B90002 add
           #MOD-A20091---modify---start---
           #LET g_apc.apc16 = 0             
            IF l_apa20 >=(g_apc.apc08-g_apc.apc10) THEN
               LET g_apc.apc16 =g_apc.apc08-g_apc.apc10
               LET l_apa20 =l_apa20-g_apc.apc16
            ELSE  
               LET g_apc.apc16 =l_apa20
              #LET g_apa.apa20 =0      #TQC-A30003 mark
               LET l_apa20 =0          #TQC-A30003 add
            END IF
           #MOD-A20091---modify---end---
         END IF
   #No.TQC-6B0066--begin
         LET g_apc.apc08 = cl_digcut(g_apc.apc08,t_azi04)
         LET g_apc.apc09 = cl_digcut(g_apc.apc09,g_azi04)
         LET g_apc.apc13 = cl_digcut(g_apc.apc13,g_azi04)
   #No.TQC-6B0066--end
  
         INSERT INTO apc_file VALUES(g_apc.*)
         IF SQLCA.sqlcode THEN
            CALL cl_err3("ins","apc_file","apc01","apc02",SQLCA.sqlcode,"","",1)
            LET g_success ='N'
            RETURN
         ELSE
            LET l_cnt =1
            #SELECT MAX(apc04),MAX(apc05) INTO g_apa.apa12,g_apa.apa64 FROM apc_file   #TQC-C80061  mark
            # WHERE apc01 =g_apa.apa01                                                 #TQC-C80061  mark
            SELECT MAX(apc04),MAX(apc05) INTO m_apa.apa12,m_apa.apa64 FROM apc_file    #TQC-C80061  add
              WHERE apc01 =m_apa.apa01                                                 #TQC-C80061  add
            #UPDATE apa_file SET apa12 =g_apa.apa12,    #TQC-C80061  mark
            #                    apa64 =g_apa.apa64     #TQC-C80061  mark
            UPDATE apa_file SET apa12 =m_apa.apa12,     #TQC-C80061  add
                                apa64 =m_apa.apa64      #TQC-C80061  add
             WHERE apa01 =g_apc.apc01
         END IF
         IF g_pmb.pmb02 = 2  THEN 
             EXIT FOREACH
         END IF
      END FOREACH
   ELSE                               #MOD-A70037 
      LET l_apa20 =0                  #MOD-A70037
   END IF #No.TQC-7A0095
   IF l_cnt = 0 OR g_aptype MATCHES '2*' THEN          #No.TQC-6B0066
      LET g_apc.apc01 = m_apa.apa01
      LET g_apc.apc02 = 1
      LET g_apc.apc03 = m_apa.apa11
      LET g_apc.apc04 = m_apa.apa12
      LET g_apc.apc05 = m_apa.apa64
      LET g_apc.apc06 = m_apa.apa14
      LET g_apc.apc07 = m_apa.apa72
      LET g_apc.apc14 = 0                       #No.MOD-B90002 add
      LET g_apc.apc15 = 0                       #No.MOD-B90002 add
     #-MOD-B60066-add-
      IF g_aptype MATCHES '1*' THEN
         LET g_apc.apc08 = m_apa.apa34f + m_apa.apa65f
         LET g_apc.apc09 = m_apa.apa34  + m_apa.apa65
         LET g_apc.apc14 = m_apa.apa65f         #No.MOD-B90002 add
         LET g_apc.apc15 = m_apa.apa65          #No.MOD-B90002 add
      ELSE
     #-MOD-B60066-end-
         LET g_apc.apc08 = m_apa.apa34f
         LET g_apc.apc09 = m_apa.apa34
      END IF   #MOD-B60066
      LET l_sumamtf = g_apc.apc08   #MOD-B60066 
      LET l_sumamt  = g_apc.apc09   #MOD-B60066
     #MOD-9A0100   ---start
     #LET g_apc.apc10 = 0
     #LET g_apc.apc11 = 0
      LET g_apc.apc10 = m_apa.apa35f
      LET g_apc.apc11 = m_apa.apa35
     #MOD-9A0100   ---end
      LET g_apc.apc12 = m_apa.apa08
      LET g_apc.apc13 = g_apc.apc09-g_apc.apc11
     #LET g_apc.apc14 = 0                       #No.MOD-B90002 mark
     #LET g_apc.apc15 = 0                       #No.MOD-B90002 mark
     #MOD-A20091---modify---start---
     #LET g_apc.apc16 = 0             
      IF l_apa20 >=(g_apc.apc08-g_apc.apc10) THEN
         LET g_apc.apc16 =g_apc.apc08-g_apc.apc10
         LET l_apa20 =l_apa20-g_apc.apc16
      ELSE  
         LET g_apc.apc16 =l_apa20
        #LET g_apa.apa20 =0      #TQC-A30003 mark
         LET l_apa20 =0          #TQC-A30003 add
      END IF
     #MOD-A20091---modify---end---
#No.TQC-6B0066--begin
      LET g_apc.apc08 = cl_digcut(g_apc.apc08,t_azi04)
      LET g_apc.apc09 = cl_digcut(g_apc.apc09,g_azi04)
      LET g_apc.apc13 = cl_digcut(g_apc.apc13,g_azi04)
#No.TQC-6B0066--end
      INSERT INTO apc_file VALUES(g_apc.*)
      IF SQLCA.sqlcode THEN
         CALL cl_err3("ins","apc_file","apc01","apc02",SQLCA.sqlcode,"","",1)
         LET g_success ='N'
         RETURN
      END IF
      #SELECT MAX(apc04),MAX(apc05) INTO g_apa.apa12,g_apa.apa64 FROM apc_file    #TQC-C80061  mark
      # WHERE apc01 =g_apa.apa01                                                  #TQC-C80061  mark  
      SELECT MAX(apc04),MAX(apc05) INTO m_apa.apa12,m_apa.apa64 FROM apc_file     #TQC-C80061  add
       WHERE apc01 =m_apa.apa01                                                   #TQC-C80061  add
      #UPDATE apa_file SET apa12 =g_apa.apa12,                                    #TQC-C80061  mark   
      #                    apa64 =g_apa.apa64                                     #TQC-C80061  mark    
      #              WHERE apa01 =g_apa.apa01                                     #TQC-C80061  mark             
      UPDATE apa_file SET apa12 =m_apa.apa12,                                     #TQC-C80061  add
                          apa64 =m_apa.apa64                                      #TQC-C80061  add
                    WHERE apa01 =m_apa.apa01                                      #TQC-C80061  add
   END IF

   #No.TQC-6B0066 --start-- 為了消除小數位數四舍五入引起的誤差，將產生的誤差加入最后一筆數據
   SELECT SUM(apc08),SUM(apc09),MAX(apc02) INTO l_apc08,l_apc09,l_apc02
     FROM apc_file
    WHERE apc01 = g_apc.apc01
   IF SQLCA.sqlcode THEN
      CALL cl_err3("sel","apc_file",g_apc.apc01,"",SQLCA.sqlcode,"","",1)
      LET g_success ='N'
      RETURN
   END IF
   IF cl_null(l_apc08) THEN
      LET l_apc08 = 0
   END IF
   IF cl_null(l_apc09) THEN
      LET l_apc09 = 0
   END IF
  #IF l_apc08 <> m_apa.apa34f THEN  #MOD-B60066 mark
   IF l_apc08 <> l_sumamtf THEN     #MOD-B60066
      UPDATE apc_file SET apc08 = apc08-(l_apc08-m_apa.apa34f)   #No.TQC-740159
       WHERE apc01 = g_apc.apc01
         AND apc02 = l_apc02
      IF SQLCA.sqlcode THEN
         CALL cl_err3("upd","apc_file",g_apc.apc01,l_apc02,SQLCA.sqlcode,"","",1)
         LET g_success ='N'
         RETURN
      END IF
   END IF       
  #IF l_apc09 <> m_apa.apa34 THEN  #MOD-B60066 mark
   IF l_apc09 <> l_sumamt THEN     #MOD-B60066
      CALL t110_comp_oox1(g_apc.apc01,l_apc02) RETURNING g_net      #MOD-940090
      UPDATE apc_file SET apc09 = apc09-(l_apc09-m_apa.apa34),    #No.TQC-740159
                          apc13 = apc09-(l_apc09-m_apa.apa34) - apc11 + g_net   #MOD-940090
       WHERE apc01 = g_apc.apc01
         AND apc02 = l_apc02
      IF SQLCA.sqlcode THEN
         CALL cl_err3("upd","apc_file",g_apc.apc01,l_apc02,SQLCA.sqlcode,"","",1)
         LET g_success ='N'
         RETURN
      END IF
   END IF       
   #No.TQC-6B0066 --end--

END FUNCTION
FUNCTION t110_upd_apc_date()
   SELECT COUNT(*) INTO g_cnt FROM apc_file WHERE apc01 =g_apa.apa01
   IF g_cnt >1 THEN
      RETURN
   END IF
   IF g_cnt =1 THEN
      UPDATE apc_file SET apc04 =g_apa.apa12,
                          apc05 =g_apa.apa64
       WHERE apc01 =g_apa.apa01
   END IF
END FUNCTION
#No.FUN-680027--end   

#No.FUN-690080 --Begin
#No.CHI-780046---Begin
#FUNCTION t110_cpf(p_cpf01,p_flag)
#   DEFINE p_cpf01   LIKE cpf_file.cpf01,
#          l_cpf02   LIKE cpf_file.cpf02,
#          l_cpf29   LIKE cpf_file.cpf29,
#          l_cpfacti LIKE cpf_file.cpfacti,
#          p_flag    LIKE type_file.chr1  

#   LET g_errno = NULL
#   SELECT cpf02,cpf29,cpfacti
#     INTO l_cpf02,l_cpf29,l_cpfacti
#     FROM cpf_file
#    WHERE cpf01 = p_cpf01

#   CASE WHEN SQLCA.SQLCODE = 100 LET g_errno = 'aap-038'
#        WHEN l_cpfacti = 'N'     LET g_errno = '9028'
#        WHEN SQLCA.SQLCODE != 0  LET g_errno = SQLCA.SQLCODE USING '-----'
#   END CASE
#   IF cl_null(g_errno) THEN
#      IF p_flag = '1' THEN
#         LET g_apb[l_ac].apb26 = l_cpf29
#         DISPLAY BY NAME g_apb[l_ac].apb26
#      ELSE 
#         LET g_apa.apa07 = l_cpf02
#         LET g_apa.apa22 = l_cpf29
#         DISPLAY BY NAME g_apa.apa07,g_apa.apa22
#      END IF
#   END IF
   
#END FUNCTION

FUNCTION t110_gen(p_gen01,p_flag)                                               
   DEFINE p_gen01   LIKE gen_file.gen01,                                        
          l_gen02   LIKE gen_file.gen02,                                        
          l_gen03   LIKE gen_file.gen03,                                        
          l_genacti LIKE gen_file.genacti,                                      
          p_flag    LIKE type_file.chr1                                         
                                                                                
   LET g_errno = NULL                                                           
   SELECT gen02,gen03,genacti                                                   
     INTO l_gen02,l_gen03,l_genacti                                             
     FROM gen_file                                                              
    WHERE gen01 = p_gen01                                                       
                                                                                
   CASE WHEN SQLCA.SQLCODE = 100 LET g_errno = 'aap-038'                        
        WHEN l_genacti = 'N'     LET g_errno = '9028'                           
        WHEN SQLCA.SQLCODE != 0  LET g_errno = SQLCA.SQLCODE USING '-----'      
   END CASE                                                                     
   IF cl_null(g_errno) THEN                                                     
      IF p_flag = '1' THEN                                                      
         LET g_apb[l_ac].apb26 = l_gen03 
         #FUN-990025--Begin
         LET g_apb[l_ac].b32 = l_gen02   
         DISPLAY l_gen02 TO FORMONLY.b32
         #FUN-990025---End                                    
         DISPLAY BY NAME g_apb[l_ac].apb26                                      
      ELSE                                                                      
         LET g_apa.apa07 = l_gen02                
         LET g_apa.apa22 = l_gen03                                             
         DISPLAY BY NAME g_apa.apa07,g_apa.apa22                                
      END IF                                                                    
   END IF                                                                       
                                                                                
END FUNCTION  
#No:FUN-780046---End
   
FUNCTION t110_apa101(p_cmd)
   DEFINE p_cmd     LIKE type_file.chr1  
   DEFINE l_nma10   LIKE nma_file.nma10     #No.TQC-6C0074
   DEFINE l_nma28   LIKE nma_file.nma28     #No.TQC-6C0074
   DEFINE l_nma37   LIKE nma_file.nma37     #No.TQC-6C0074
   DEFINE l_nmaacti LIKE nma_file.nmaacti

   LET g_errno = ' '
   SELECT nma10,nma28,nma37,nmaacti INTO l_nma10,l_nma28,l_nma37,l_nmaacti    #No.TQC-6C0074
     FROM nma_file 
    WHERE nma01 = g_apa.apa101

   CASE WHEN SQLCA.SQLCODE = 100     LET g_errno = 'aap-007'
        WHEN l_nmaacti = 'N'         LET g_errno = 'anm-017'
        WHEN l_nma28 ='1' OR l_nma37  ='0'                           #No.TQC-6C0074
                                     LET g_errno = 'aap-601'         #No.TQC-6C0074
        WHEN l_nma10 != g_apa.apa13                                  #No.TQC-6C0074
                                     LET g_errno = 'aap-602'         #No.TQC-6C0074
        WHEN SQLCA.SQLCODE != 0  LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE

END FUNCTION

FUNCTION t110_apa102(p_cmd)
   DEFINE p_cmd     LIKE type_file.chr1  
   DEFINE l_nmc03   LIKE nmc_file.nmc03
   DEFINE l_nmcacti LIKE nmc_file.nmcacti

   LET g_errno = ' '
   SELECT nmc03,nmcacti INTO l_nmc03,l_nmcacti
     FROM nmc_file 
    WHERE nmc01 = g_apa.apa102

   CASE WHEN SQLCA.SQLCODE = 100 LET g_errno = 'anm-024'
        WHEN l_nmc03 = '2'       LET g_errno = 'anm-019'
        WHEN l_nmcacti = 'N'     LET g_errno = '9028'
        WHEN SQLCA.SQLCODE != 0  LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE

END FUNCTION

#還款
FUNCTION t110_k_1()
   DEFINE l_totf    LIKE apc_file.apc09
   DEFINE l_amtf    LIKE apc_file.apc09
   DEFINE l_tot     LIKE apc_file.apc09
   DEFINE l_amt     LIKE apc_file.apc09
   DEFINE l_apx04   LIKE apx_file.apx04
   DEFINE cnt1      LIKE type_file.num5  
   DEFINE cnt2      LIKE type_file.num5  
   DEFINE i,j,k     LIKE type_file.num5  
   #DEFINE l_sql     LIKE type_file.chr1000   #MOD-720062
   DEFINE l_sql     STRING     #MOD-720062
   DEFINE p_cmd     LIKE type_file.chr1  
   DEFINE g_apx     DYNAMIC ARRAY OF RECORD
            apx02   LIKE apx_file.apx02,
            apx03   LIKE apx_file.apx03,
            apa07   LIKE apa_file.apa07,
            apa08   LIKE apa_file.apa08,
            apa14   LIKE apa_file.apa14,
            apx04f  LIKE apx_file.apx04,
            apx04   LIKE apx_file.apx04,
            apa73f  LIKE apa_file.apa73,  #No.TQC-7C0094
            apa73   LIKE apa_file.apa73   #No.TQC-7C0094
                END RECORD
   DEFINE g_apx_t   RECORD
            apx02   LIKE apx_file.apx02,
            apx03   LIKE apx_file.apx03,
            apa07   LIKE apa_file.apa07,
            apa08   LIKE apa_file.apa08,
            apa14   LIKE apa_file.apa14,
            apx04f  LIKE apx_file.apx04,
            apx04   LIKE apx_file.apx04,
            apa73f  LIKE apa_file.apa73,  #No.TQC-7C0094
            apa73   LIKE apa_file.apa73   #No.TQC-7C0094
                END RECORD
   #No.MOD-580365  --begin
   DEFINE m_apa     DYNAMIC ARRAY OF RECORD
            apa13   LIKE apa_file.apa13,
            apa72   LIKE apa_file.apa72,
            apa73   LIKE apa_file.apa73
                END RECORD
   DEFINE m_apa_t   RECORD
                    apa13     LIKE apa_file.apa13,
                    apa72     LIKE apa_file.apa72,
                    apa73     LIKE apa_file.apa73
                    END RECORD
   DEFINE m_apa34f  LIKE apa_file.apa34f
   DEFINE m_apa34   LIKE apa_file.apa34    #No.MOD-590312
   DEFINE m_apa73   LIKE apa_file.apa73
   DEFINE m_amt     LIKE apc_file.apc09
   DEFINE l_apa     RECORD LIKE apa_file.*
   DEFINE l_net     LIKE apx_file.apx04
   DEFINE l_apa14   LIKE apa_file.apa14
   DEFINE l_apx02   LIKE apx_file.apx02
   DEFINE l_i       LIKE type_file.num5  
   #No.MOD-580365  --end
   DEFINE l_apa13   LIKE apa_file.apa13
   DEFINE l_apa41   LIKE apa_file.apa41
   DEFINE l_apx04f  LIKE apx_file.apx04f
   DEFINE l_apa35f,l_apa35 LIKE apa_file.apa35
   DEFINE l_difff,l_diff   LIKE apa_file.apa34
   DEFINE l_sumf,l_sum     LIKE apa_file.apa34
   DEFINE l_sumf_h,l_sum_h LIKE apa_file.apa34
   DEFINE l_total          LIKE apa_file.apa34
   DEFINE l_lock_sw        LIKE type_file.chr1  
   DEFINE l_modify_flag    LIKE type_file.chr1  
   DEFINE l_k,l_over       LIKE type_file.num5,  
   l_allow_insert   LIKE type_file.num5,   #可新增否
   l_allow_delete   LIKE type_file.num5    #可刪除否
   DEFINE ls_rec_b  LIKE type_file.num10  
   DEFINE l_apa06   LIKE apa_file.apa06    #MOD-580079
   DEFINE l_apa73f  LIKE apa_file.apa73    #No.TQC-7C0094 原幣未還金額
   DEFINE l_apa73   LIKE apa_file.apa73    #No.TQC-7C0094 本幣未還金額

   IF g_apa.apa01 IS NULL THEN
      CALL cl_err('apa01 null',-400,0)
      RETURN
   END IF
   SELECT * INTO g_apa.* FROM apa_file
    WHERE apa01=g_apa.apa01
#  IF g_apa.apa34f > g_apa.apa35f THEN
   IF g_apa.apa34f >= g_apa.apa35f AND g_apa.apa31f > 0 THEN     #No.MOD-780123 #TQC-790128
      CALL cl_err(g_apa.apa01,'aap-096',0)
      RETURN
   END IF

   IF g_apa.apa00[1,1] = '2' THEN
      RETURN
   END IF
   IF g_apa.apa41 = 'Y' THEN
      CALL cl_err(g_apa.apa01,'aap-005',0)
      RETURN
   END IF
   IF g_apa.apa63 MATCHES '[Ss1]' THEN      #FUN-540045 #FUN-550042
      CALL cl_err('','mfg3557',0)
      RETURN
   END IF

   LET g_success='Y'
   LET g_apa_t.* = g_apa.*
   BEGIN WORK
   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa_rowid
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl k:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF
   FETCH t110_cl INTO g_apa.*                   # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
      CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)  # 資料被他人LOCK
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF

   OPEN WINDOW t110_xxx_w WITH FORM "aap/42f/aapt110_l"
      ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
   CALL cl_ui_locale("aapt110_l")

   #-----MOD-660095---------
#No.CHI-6A0004-----begin----
#   SELECT azi04 INTO g_azi04 FROM azi_file
#    WHERE azi01 = g_aza.aza17
#No.CHI-6A0004-----End----
   SELECT azi04 INTO t_azi04 FROM azi_file
    WHERE azi01 = g_apa.apa13
   #-----END MOD-660095-----
 
   SELECT COUNT(*) INTO cnt1 FROM apx_file WHERE apx01 = g_apa.apa01

   IF cnt1 > 0 THEN
      DECLARE t110_xxx_c0 CURSOR FOR
        SELECT apx02,apx03,apa07,apa08,apa14,apx04f,apx04,apa13,'','',apa72,apa73
          FROM apx_file,apa_file
         WHERE apx01 = apa01
           AND apa01 = g_apa.apa01

      CALL g_apx.clear()
      LET i = 1

      FOREACH t110_xxx_c0 INTO g_apx[i].apx02,g_apx[i].apx03,g_apx[i].apa07,g_apx[i].apa08,
                               g_apx[i].apa14,g_apx[i].apx04f,g_apx[i].apx04,
                               g_apx[i].apa73f,g_apx[i].apa73,                   #No.TQC-7C0094
                               #No.MOD-580365  --begin
                               m_apa[i].apa13,m_apa[i].apa72,m_apa[i].apa73
                               #No.MOD-580365  --end

         #No.MOD-580365  --begin
         IF g_apz.apz27 = 'Y' AND m_apa[i].apa13 !=g_aza.aza17 THEN
             LET g_apx[i].apa14  = m_apa[i].apa72
         END IF
         #No.MOD-580365  --end
         IF g_apa.apa00='11' THEN
            DROP TABLE x

            SELECT apb06 po_no FROM apb_file,apa_file      
             WHERE apa01=g_msg AND apa01=apb01 AND apa41='Y' AND apa42!='Y'
              INTO TEMP x

            SELECT COUNT(*) INTO g_cnt FROM x     # 如果原預付有指定 P/O No

            IF g_cnt > 0 THEN
               SELECT MAX(po_no) INTO g_msg FROM x
               SELECT COUNT(*) INTO g_cnt FROM apb_file, x
                WHERE apb01=g_apa.apa01 AND apb06=po_no
               IF g_cnt=0 THEN
                  INITIALIZE g_apx[i].* TO NULL CONTINUE FOREACH
               END IF
            END IF
         END IF

        #No.TQC-7C0094--begin--
         CALL t110_apx03_unpay(g_apx[i].apx03) 
           RETURNING g_apx[i].apa73f,g_apx[i].apa73
        #No.TQC-7C0094---end---

         LET i = i + 1
         IF i > g_max_rec THEN     #No:MOD-480131
            EXIT FOREACH
         END IF
      END FOREACH
      CALL g_apx.deleteElement(i)
      LET ls_rec_b = i - 1

     #No.TQC-7C0094--begin--
      SELECT SUM(apx04f),SUM(apx04) INTO l_sumf_h,l_sum_h FROM apx_file
       WHERE apx01= g_apa.apa01
      IF cl_null(l_sumf_h) THEN LET l_sumf_h = 0 END IF
      IF cl_null(l_sum_h)  THEN LET l_sum_h  = 0 END IF
      DISPLAY l_sumf_h TO FORMONLY.apa65f
      DISPLAY l_sum_h  TO FORMONLY.apa65
     #No.TQC-7C0094---end---
   END IF
   

 # LET l_sumf_h = g_apa.apa37f   #No.TQC-7C0094
 # LET l_sum_h  = g_apa.apa37    #No.TQC-7C0094

#  DISPLAY BY NAME g_apa.apa37f,g_apa.apa37
 
   LET l_allow_insert = cl_detail_input_auth("insert")
   LET l_allow_delete = cl_detail_input_auth("delete")

   LET i = 1
   INPUT ARRAY g_apx WITHOUT DEFAULTS FROM s_apx.*
         ATTRIBUTE(COUNT=ls_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                   INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)

      BEFORE INSERT
         LET i = ARR_CURR()
         LET p_cmd='a'
         INITIALIZE g_apx[i].* TO NULL
         LET g_apx_t.* = g_apx[i].*
         LET g_apx[i].apa14 = g_apa.apa14
         LET g_apx[i].apa07 = g_apa.apa07
         NEXT FIELD apx02
 
      AFTER INSERT
         IF INT_FLAG THEN
            CALL cl_err('',9001,0)
            LET INT_FLAG = 0
            CANCEL INSERT
         END IF
         INSERT INTO apx_file(apx01,apx02,apx03,apx04f,apx04)
          VALUES(g_apa.apa01,g_apx[i].apx02,g_apx[i].apx03,
                 g_apx[i].apx04f,g_apx[i].apx04)
         IF SQLCA.sqlcode THEN
            CALL cl_err3("ins","apx_file",g_apa.apa01,g_apx[i].apx02,SQLCA.sqlcode,"","ins apx:",1)  #No.FUN-660122
            LET g_success = 'N'
            CANCEL INSERT
         ELSE
            LET ls_rec_b = ls_rec_b + 1
            MESSAGE "insert ok"
            IF g_success = 'Y' THEN
           #No.TQC-7C0094--begin-- mark
           #   SELECT SUM(apx04f),SUM(apx04) INTO g_apa.apa37f,g_apa.apa37
           #     FROM apx_file WHERE apx01=g_apa.apa01
 
           #   IF cl_null(g_apa.apa37f) THEN
           #      LET g_apa.apa37f = 0
           #   END IF
 
           #   IF cl_null(g_apa.apa37 ) THEN
           #      LET g_apa.apa37 = 0
           #   END IF
 
           #   DISPLAY BY NAME g_apa.apa37f,g_apa.apa37
 
           #   UPDATE apa_file SET apa37f=g_apa.apa37f,apa37=g_apa.apa37
           #    WHERE apa01 = g_apa.apa01
           #   IF STATUS OR SQLCA.SQLCODE THEN
#          #      CALL cl_err('upd apa1:',SQLCA.SQLCODE,1)   #No.FUN-660122
           #      CALL cl_err3("upd","apa_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
           #      LET g_success='N'
           #      IF p_cmd = 'u' THEN
           #         LET g_apx[i].*=g_apx_t.*
           #      END IF
           #   END IF

           #   IF g_amt1f IS NULL THEN
           #      LET g_amt1f = 0
           #      LET g_amt1 = 0
           #   END IF
 
           #   IF g_amt2f IS NULL THEN
           #      LET g_amt2f = 0
           #      LET g_amt2 = 0
           #   END IF
 
           #   IF cl_null(g_amt3f) THEN
           #      LET g_amt3f = 0
           #      LET g_amt3 = 0
           #   END IF
 
           #   LET g_amt1f=g_amt1f+g_amt2f+g_amt3f
           #   LET g_amt1=g_amt1+g_amt2+g_amt3
           #No.TQC-7C0094---end--- mark
           #No.TQC-7C0094--begin--
              SELECT SUM(apx04f),SUM(apx04) INTO l_sumf_h,l_sum_h FROM apx_file
               WHERE apx01=g_apa.apa01
              IF cl_null(l_sumf_h) THEN LET l_sumf_h = 0 END IF
              IF cl_null(l_sum_h)  THEN LET l_sum_h  = 0 END IF
              DISPLAY l_sumf_h TO FORMONLY.apa65f
              DISPLAY l_sum_h  TO FORMONLY.apa65
           #No.TQC-7C0094---end---
            END IF
         END IF

      BEFORE INPUT
         IF ls_rec_b != 0 THEN
            CALL fgl_set_arr_curr(i)
         END IF
         LET g_before_input_done = FALSE
         CALL t110_set_entry_apx('a')
         CALL t110_set_no_entry_apx('a')
         LET g_before_input_done = TRUE

      BEFORE ROW
         LET p_cmd = ''
         LET i = ARR_CURR()
         LET l_lock_sw = 'N'
         IF ls_rec_b >= i THEN
            LET p_cmd='u'
            LET g_apx_t.* = g_apx[i].*
            # LET g_success = 'Y'              #No:MOD-510148
            CALL cl_show_fld_cont()     #FUN-550037(smin)
         END IF

      BEFORE FIELD apx02
         IF cl_null(g_apx[i].apx02) OR g_apx[i].apx02 = 0 THEN
            SELECT MAX(apx02)+1 INTO g_apx[i].apx02 FROM apx_file
             WHERE apx01 = g_apa.apa01
            IF cl_null(g_apx[i].apx02)  THEN
               LET g_apx[i].apx02 = 1
            END IF
            LET g_apx[i].apx04f= 0
            LET g_apx[i].apx04 = 0
         END IF
          CALL t110_set_entry_apx(p_cmd)  #MOD-4A0288

      AFTER FIELD apx02
         IF g_apx_t.apx02 IS NULL OR
            g_apx_t.apx02 != g_apx[i].apx02 THEN
            SELECT COUNT(*) INTO k FROM apx_file
                WHERE apx01 = g_apa.apa01 AND apx02 = g_apx[i].apx02
            IF k > 0 THEN
               CALL cl_err('',-239,0)
               NEXT FIELD apx02
            END IF
         END IF
         DISPLAY BY NAME g_apx[i].apx02
         CALL t110_set_no_entry_apx(p_cmd)  #MOD-4A0288

     #No.TQC-7C0094--begin--
      AFTER FIELD apx03
        IF NOT cl_null(g_apx[i].apx03) THEN
           SELECT COUNT(apa01) INTO l_i FROM apa_file 
            WHERE apa00 = '25' AND apa06 = g_apa.apa06
              AND apa01 = g_apx[i].apx03
              AND apa34f-apa35f > 0
           IF cl_null(l_i) THEN LET l_i = 0 END IF
           IF l_i = 0 THEN 
              CALL cl_err(g_apx[i].apx03,'aap-114',0)
              NEXT FIELD apx03
           END IF 
           IF p_cmd='a' OR (p_cmd='u' AND g_apx[i].apx03 <> g_apx_t.apx03) THEN
              SELECT COUNT(apx03) INTO l_i FROM apx_file
               WHERE apx01= g_apa.apa01
                 AND apx03=g_apx[i].apx03
              IF l_i > 0 THEN 
                 CALL cl_err(g_apx[i].apx03,'atm-310',0)
                 NEXT FIELD apx03
              END IF
           END IF
           CALL t110_apx03_unpay(g_apx[i].apx03) 
             RETURNING g_apx[i].apa73f,g_apx[i].apa73
        END IF
     #No.TQC-7C0094---end---

      AFTER FIELD apx04f
         #No.MOD-580365  --begin
         IF NOT cl_null(g_apx[i].apx04f) THEN
            IF g_apx[i].apx04f < 0 THEN
               CALL cl_err('','mfg4012',0)
               NEXT FIELD apx04f
            END IF
           #No.TQC-7C0094--begin--
            IF g_apx[i].apx04f > g_apx[i].apa73f THEN
               CALL cl_err(g_apx[i].apx04f,'aap-113',1)
               NEXT FIELD apx04f
            END IF
           #No.TQC-7C0094---end---
            LET l_apx04 = g_apx[i].apx04f * g_apx[i].apa14
            LET g_apx[i].apx04 = l_apx04
         END IF
         IF cl_null(g_apx_t.apx04f) THEN
            LET g_apx_t.apx04f = 0
         END IF
 
         LET l_total = l_difff + g_apx_t.apx04f
 
         IF  g_apx[i].apx04f > l_total THEN
            LET g_apx[i].apx04f = 0
            LET g_apx[i].apx04 = 0
            CALL cl_err(g_apa.apa01,'aap-194',0)
            NEXT FIELD apx04f
         END IF
         #-----END MOD-5B0132-----
         LET g_apx[i].apx04f = cl_digcut(g_apx[i].apx04f,t_azi04) #MOD-660095
         LET g_apx[i].apx04 = cl_digcut(g_apx[i].apx04,g_azi04) #MOD-660095

      AFTER FIELD apx04
         IF NOT cl_null(g_apx[i].apx04) THEN
            IF g_apx[i].apx04 < 0 THEN
               CALL cl_err('','mfg4012',0)
               NEXT FIELD apx04
            END IF
            LET l_sum = 0
            LET l_sumf = 0
            LET l_over = 0
            IF cl_null(g_apx_t.apx04f) THEN
               LET g_apx_t.apx04f = 0
               LET g_apx_t.apx04 = 0
            END IF
            LET l_total = l_diff + g_apx_t.apx04
            IF  g_apx[i].apx04 > l_total THEN
               LET g_apx[i].apx04f = 0
               LET g_apx[i].apx04 = 0
               CALL cl_err(g_apa.apa01,'aap-194',0)
               LET l_over = 1
            END IF
            IF l_over=1 THEN
               NEXT FIELD apx04f
            END IF
         END IF
         LET g_apx[i].apx04 = cl_digcut(g_apx[i].apx04,g_azi04) #MOD-660095

        BEFORE DELETE                            #是否取消單身
           IF g_apx[i].apx02 > 0 AND g_apx_t.apx02 IS NOT NULL THEN
              IF NOT cl_delb(0,0) THEN
                 CANCEL DELETE
              END IF
              DELETE FROM apx_file
               WHERE apx01 = g_apa.apa01 AND apx02 = g_apx_t.apx02
              IF SQLCA.sqlcode THEN
#                CALL cl_err(g_apx_t.apx02,SQLCA.sqlcode,0)   #No.FUN-660122
                 CALL cl_err3("del","apx_file",g_apa.apa01,g_apx_t.apx02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
                 CANCEL DELETE
              END IF
              LET ls_rec_b = ls_rec_b - 1
              MESSAGE "delete ok"
              IF g_success = 'Y' THEN #No.MOD-580365
             #No.TQC-7C0094--begin-- mark
             #   SELECT SUM(apx04f),SUM(apx04) INTO g_apa.apa37f,g_apa.apa37
             #     FROM apx_file WHERE apx01=g_apa.apa01
             #   IF cl_null(g_apa.apa37f) THEN LET g_apa.apa37f = 0 END IF
             #   IF cl_null(g_apa.apa37 ) THEN LET g_apa.apa37 = 0 END IF
             #   DISPLAY BY NAME g_apa.apa37f,g_apa.apa37
             #   UPDATE apa_file SET apa37f=g_apa.apa37f,apa37=g_apa.apa37
             #    WHERE apa01 = g_apa.apa01
             #   IF STATUS OR SQLCA.SQLCODE THEN
#            #      CALL cl_err('upd apa1:',SQLCA.SQLCODE,1)   #No.FUN-660122
             #      CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
             #      LET g_success='N'
             #   END IF
             #   LET g_amt1f=g_amt1f+g_amt2f+g_amt3f
             #   LET g_amt1=g_amt1+g_amt2+g_amt3
             #No.TQC-7C0094---end--- mark
             #No.TQC-7C0094--begin--
                 SELECT SUM(apx04f),SUM(apx04) INTO l_sumf_h,l_sum_h
                   FROM apx_file WHERE apx01=g_apa.apa01
                 IF cl_null(l_sumf_h) THEN LET l_sumf_h = 0 END IF
                 IF cl_null(l_sum_h)  THEN LET l_sum_h  = 0 END IF
                 DISPLAY l_sumf_h TO FORMONLY.apa65f
                 DISPLAY l_sum_h  TO FORMONLY.apa65
             #No.TQC-7C0094---end---
              END IF
           END IF
           #--

      ON ROW CHANGE
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             LET g_apx[l_ac].* = g_apx_t.*
             CLOSE t110_loc2_cr
             LET g_success = 'N'
             EXIT INPUT
          END IF
          IF l_lock_sw = 'Y' THEN
             CALL cl_err(g_apx[l_ac].apx02,-263,1)
             LET g_apx[l_ac].* = g_apx_t.*
          ELSE
             UPDATE apx_file SET apx02 = g_apx[i].apx02,
                                 apx04f= g_apx[i].apx04f,
                                 apx04 = g_apx[i].apx04 
                           WHERE apx01 = g_apa.apa01
                             AND apx02 = g_apx_t.apx02
             IF STATUS OR SQLCA.SQLCODE THEN
#               CALL cl_err('upd apx:',SQLCA.SQLCODE,1)   #No.FUN-660122
                CALL cl_err3("upd","apx_file",g_apa.apa01,g_apx_t.apx02,SQLCA.sqlcode,"","upd apx:",1)  #No.FUN-660122
                LET g_success = 'N'
                LET g_apx[i].* = g_apx_t.*
                ELSE MESSAGE "update ok"
             END IF
             IF g_success = 'Y' THEN #No.MOD-580365
            #No.TQC-7C0094--begin-- mark
            #   SELECT SUM(apx04f),SUM(apx04) INTO g_apa.apa37f,g_apa.apa37
            #     FROM apx_file WHERE apx01=g_apa.apa01
 
            #   IF cl_null(g_apa.apa37f) THEN
            #      LET g_apa.apa37f = 0
            #   END IF
 
            #   IF cl_null(g_apa.apa37 ) THEN
            #      LET g_apa.apa37 = 0
            #   END IF
 
            #   DISPLAY BY NAME g_apa.apa37f,g_apa.apa37
 
            #   UPDATE apa_file SET apa37f=g_apa.apa37f,apa37=g_apa.apa37
            #    WHERE apa01 = g_apa.apa01
            #   IF STATUS OR SQLCA.SQLCODE THEN
#           #      CALL cl_err('upd apa1:',SQLCA.SQLCODE,1)   #No.FUN-660122
            #      CALL cl_err3("upd","apa_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
            #      LET g_success='N'
            #      IF p_cmd = 'u' THEN
            #         LET g_apx[i].*=g_apx_t.*
            #      END IF
            #   END IF
 
            #   LET g_amt1f=g_amt1f+g_amt2f+g_amt3f
            #   LET g_amt1=g_amt1+g_amt2+g_amt3
            #No.TQC-7C0094---end--- mark
            #No.TQC-7C0094--begin--
                 SELECT SUM(apx04f),SUM(apx04) INTO l_sumf_h,l_sum_h
                   FROM apx_file WHERE apx01=g_apa.apa01
                 IF cl_null(l_sumf_h) THEN LET l_sumf_h = 0 END IF
                 IF cl_null(l_sum_h)  THEN LET l_sum_h  = 0 END IF
                 DISPLAY l_sumf_h TO FORMONLY.apa65f
                 DISPLAY l_sum_h  TO FORMONLY.apa65
            #No.TQC-7C0094---end---
             END IF
          END IF

      AFTER ROW
          LET l_ac = ARR_CURR()
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             IF p_cmd = 'u' THEN
                LET g_apx[l_ac].* = g_apx_t.*
             END IF
             CLOSE t110_loc2_cr
             LET g_success = 'N'
             EXIT INPUT
          END IF
          CLOSE t110_loc2_cr
 
#MOD-740500--begin
      ON ACTION CONTROLP
         CASE
            WHEN INFIELD(apx03) 
               CALL cl_init_qry_var()
              #LET g_qryparam.form ="q_apx"
              #LET g_qryparam.arg1 = g_apa.apa01
               LET g_qryparam.form ="q_apx01"
               LET g_qryparam.arg1 = g_apa.apa06
               LET g_qryparam.default1 = g_apx[i].apx03
               CALL cl_create_qry() RETURNING g_apx[i].apx03 
         END CASE
#MOD-740500--end

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
      #No.MOD-580365  --begin
     #計算匯差
     AFTER INPUT
        LET l_net = 0
        FOR l_i = 1 TO g_apx.getLength()
            IF g_apx[l_i].apa14 <> g_apa.apa14 THEN
               #LET l_amt=g_apx[l_i].apx04f*(g_apa.apa14-g_apx[l_i].apa14)
               LET l_amt=g_apx[l_i].apx04f*g_apa.apa14-g_apx[l_i].apx04
               IF cl_null(l_amt) THEN LET l_amt=0 END IF
               LET l_net = l_net + l_amt
            END IF
        END FOR
     ON ACTION controls                       #No.FUN-6B0033                                                                       
        CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033

   END INPUT

   IF INT_FLAG THEN
      LET g_success='N'
      LET INT_FLAG = 0
   END IF

   SELECT SUM(apx04f),SUM(apx04) INTO g_apa.apa37f,g_apa.apa37
     FROM apx_file WHERE apx01=g_apa.apa01

   IF cl_null(g_apa.apa37f) THEN
      LET g_apa.apa37f = 0
   END IF

   IF cl_null(g_apa.apa37 ) THEN
      LET g_apa.apa37 = 0
   END IF

#  DISPLAY BY NAME g_apa.apa37f,g_apa.apa37

   UPDATE apa_file SET apa37f=g_apa.apa37f,apa37=g_apa.apa37
    WHERE apa01 = g_apa.apa01

   IF STATUS OR SQLCA.SQLCODE THEN
#     CALL cl_err('upd apa37:',SQLCA.SQLCODE,1)   #No.FUN-660122
      CALL cl_err3("upd","apa_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apa37:",1)  #No.FUN-660122
   END IF

   CLOSE WINDOW t110_xxx_w

   DISPLAY BY NAME g_apa.apa37f,g_apa.apa37

   IF l_lock_sw = 'Y' THEN
      RETURN
   END IF

  #CALL t110_apa34f('0')    #TQC-750140   #No.TQC-7C0094 mark 還款應更新衝借款欄位和還款欄位.
   
   CALL t110_apa65f(g_apa.apa37f,g_apa.apa37)        #No.TQC-7C0094

   LET g_apa.apa72 = g_apa.apa14
   CALL t110_comp_oox(g_apa.apa01) RETURNING g_net       #CHI-890017 add
  #LET g_apa.apa73 = g_apa.apa34 - g_apa.apa35           #CHI-890017 mark
   LET g_apa.apa73 = g_apa.apa34 - g_apa.apa35 + g_net   #CHI-890017

   UPDATE apa_file set * = g_apa.* WHERE apa01 = g_apa.apa01

   CALL t110_up_gl()
   CALL t110_unpay()

   DELETE FROM apx_file WHERE apx01 = g_apa.apa01 AND apx04 = 0

   CALL t110_diff_rtn('0')   #TQC-750140
   CALL t110_api_diff()      #No.TQC-7B0083
   IF g_apa.apa37f > 0 THEN
      IF cl_null(g_apa.apa101) OR cl_null(g_apa.apa102) THEN
         CALL cl_err(g_apa.apa01,'aap-095',1)
         CALL t110_upd_apa101()
      END IF
   END IF
   IF g_success = 'Y' THEN
      COMMIT WORK
      MESSAGE "Commit"
      CLOSE t110_cl
   ELSE
      ROLLBACK WORK
      MESSAGE "RollBack"
      LET g_apa.* = g_apa_t.*       #MOD-B40036
      CLOSE t110_cl
   END IF

END FUNCTION

FUNCTION t110_set_entry_apx(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1  

   CALL cl_set_comp_entry("apx03",TRUE)
   #No.MOD-580365  --begin
   IF p_cmd = 'F' THEN
      CALL cl_set_comp_entry("apx04f",TRUE)
   END IF
   #No.MOD-580365  --end
END FUNCTION

FUNCTION t110_set_no_entry_apx(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1  

  #No.TQC-7C0094--begin--
  #IF p_cmd = 'u' THEN
  #   CALL cl_set_comp_entry("apx03",FALSE)
  #END IF
  #No.TQC-7C0094---end---
   #No.MOD-580365  --begin
   IF p_cmd = 'F' THEN
      CALL cl_set_comp_entry("apx04f",FALSE)
   END IF
   #No.MOD-580365  --end
END FUNCTION

FUNCTION t110_upd_apa101()

   LET g_success = 'Y'
   CALL cl_set_head_visible("","YES")     #No.FUN-6B0033

   INPUT g_apa.apa101,g_apa.apa102 WITHOUT DEFAULTS FROM apa101,apa102
      BEFORE INPUT 
         LET g_apa_o.apa101 = g_apa.apa101
         LET g_apa_o.apa102 = g_apa.apa102
         CALL cl_set_comp_required("apa101,apa102",TRUE)

      AFTER FIELD apa101       #還款銀行
         IF NOT cl_null(g_apa.apa101) THEN
            IF g_apa_o.apa101 IS NULL OR g_apa.apa101 != g_apa_o.apa101 THEN
               CALL t110_apa101('a')
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa101,g_errno,0)
                  NEXT FIELD apa101
               END IF
            END IF
            LET g_apa_o.apa101 = g_apa.apa101
         END IF

      AFTER FIELD apa102       #還款異動碼
         IF NOT cl_null(g_apa.apa102) THEN
            IF g_apa_o.apa102 IS NULL OR g_apa.apa102 != g_apa_o.apa102 THEN
               CALL t110_apa102('a')
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa102,g_errno,0)
                  NEXT FIELD apa102
               END IF
            END IF
         END IF

      AFTER INPUT
         CALL cl_set_comp_required("apa101,apa102",FALSE)

      ON ACTION CONTROLP
         CASE
            WHEN INFIELD(apa101)   #還款銀行
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_nma"
         #No.TQC-6C0074--begin
               IF g_aptype='13' THEN
                  LET g_qryparam.where ="nma28 !=1 and nma37 !=0 and nma10='",g_apa.apa13,"'" 
               END IF
         #No.TQC-6C0074--end
               LET g_qryparam.default1 = g_apa.apa101
               CALL cl_create_qry() RETURNING g_apa.apa101
               DISPLAY BY NAME g_apa.apa101
            WHEN INFIELD(apa102)   #還款異動碼
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_nmc"
         #No.TQC-6C0074--begin
               IF g_aptype='13' THEN
                  LET g_qryparam.where =" nmc03=1"
               END IF
         #No.TQC-6C0074--end
               LET g_qryparam.default1 = g_apa.apa102
               CALL cl_create_qry() RETURNING g_apa.apa102
               DISPLAY BY NAME g_apa.apa102
            OTHERWISE EXIT CASE
         END CASE

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121

      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121

      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
   END INPUT
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      LET g_success = 'N'
      RETURN
   ELSE
      UPDATE apa_file SET apa101 = g_apa.apa101,
                          apa102 = g_apa.apa102
                    WHERE apa01 = g_apa.apa01
      IF SQLCA.sqlcode THEN
         CALL cl_err3("upd","apa_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)
         LET g_success = 'N'
         RETURN
      END IF
   END IF
END FUNCTION

FUNCTION t110_pay_record_1()
   DEFINE i,j      LIKE type_file.num5  
   DEFINE l_amtf   LIKE apx_file.apx04f
   DEFINE l_amt    LIKE apx_file.apx04
   DEFINE tmp_prog LIKE type_file.chr1000
   DEFINE l_ape    RECORD
          no       LIKE apx_file.apx01,
          sq       LIKE type_file.num5,  
          amtf     LIKE apx_file.apx04f,
          amt      LIKE apx_file.apx04f,
          nmd02    LIKE nmd_file.nmd02,  #FUN-660117
          nmd05    LIKE type_file.dat,   
          nmd04    LIKE nmd_file.nmd04   #FUN-4B0079
               END RECORD
   DEFINE l_msg    LIKE ze_file.ze03   #MOD-7C0020

   CALL g_ape.clear()
   IF g_apa.apa01 IS NULL THEN
      CALL cl_err('apa01 null',-400,0)
      RETURN
   END IF

   OPEN WINDOW t110_pay_record_w WITH FORM "aap/42f/aapt110_4"
      ATTRIBUTE(STYLE = g_win_style)
   CALL cl_ui_locale('aapt110_4')
   
   #-----MOD-7C0020---------
   CALL cl_getmsg('aap-820',g_lang) RETURNING l_msg
   CALL cl_chg_win_title(l_msg)  
   CALL cl_getmsg('aap-821',g_lang) RETURNING l_msg
   CALL cl_set_comp_att_text("amtf",l_msg CLIPPED)   
   CALL cl_getmsg('aap-822',g_lang) RETURNING l_msg
   CALL cl_set_comp_att_text("amt",l_msg CLIPPED)   
   CALL cl_getmsg('aap-823',g_lang) RETURNING l_msg
   CALL cl_set_comp_lab_text("group01",l_msg CLIPPED)   
   CALL cl_getmsg('aap-824',g_lang) RETURNING l_msg
   CALL cl_set_comp_lab_text("group02",l_msg CLIPPED)   
   #-----END MOD-7C0020-----

   LET l_amtf = 0 LET l_amt  = 0
   LET i = 1
#  IF g_aptype MATCHES '1*' THEN     #No.MOD-A80123
      DECLARE t110_pay_c12 CURSOR FOR
       SELECT apx03,apx02,apx04f,apx04,'','',''
         FROM apx_file
        WHERE apx01 = g_apa.apa01
#No.MOD-A80123 --begin
       UNION
       SELECT apx03,apx02,apx04f,apx04,'','',''
        FROM apx_file
       WHERE apx01 IN (SELECT apv01 FROM apv_file WHERE apv03 = g_apa.apa01)
#No.MOD-A80123 --end


      FOREACH t110_pay_c12 INTO g_ape[i].*
         LET l_amtf = l_amtf + g_ape[i].amtf
         LET l_amt  = l_amt  + g_ape[i].amt
         LET i = i + 1
         IF i > g_max_rec THEN    #No:MOD-480131
            EXIT FOREACH
         END IF
      END FOREACH
#  END IF                          #No.MOD-A80123

   LET g_rec_b = i - 1
   DISPLAY l_amtf TO FORMONLY.totf
   DISPLAY l_amt  TO FORMONLY.tot
   DISPLAY ARRAY g_ape TO s_ape.* ATTRIBUTE(COUNT=g_rec_b)
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE DISPLAY
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033

   END DISPLAY
   IF INT_FLAG THEN
      LET INT_FLAG = 0
   END IF

   CLOSE WINDOW t110_pay_record_w
END FUNCTION

#產生銀行異動記錄檔
FUNCTION t110_ins_nme_1()
   DEFINE l_nme   RECORD LIKE nme_file.*

   IF g_apz.apz04 = 'N' THEN
      RETURN
   END IF

   DISPLAY "ins_nme now...."
   IF g_success = 'N' THEN RETURN END IF
   LET l_nme.nme00 = 0
   LET l_nme.nme01 = g_apa.apa101
   LET l_nme.nme02 = g_apa.apa02
   LET l_nme.nme03 = g_apa.apa102
   LET l_nme.nme07 = g_apa.apa14
   LET l_nme.nme10 = g_apa.apa44
   LET l_nme.nme12 = g_apa.apa01
   LET l_nme.nme13 = g_apa.apa07
   SELECT nmc05 INTO l_nme.nme14
     FROM nmc_file
    WHERE nmc01 = l_nme.nme03
   LET l_nme.nme15 = g_apa.apa22
   LET l_nme.nme16 = g_apa.apa02
   LET l_nme.nme17 = g_apa.apa01
   LET l_nme.nmeacti = 'Y'
   LET l_nme.nmeuser = g_user
   LET l_nme.nmegrup = g_grup
   LET l_nme.nmedate = g_today
   LET l_nme.nme21='0'            #MOD-740500
#No.FUN-730032--begin
   LET l_nme.nme22='04'   #CHI-B60066 mod '02'->'04'
   LET l_nme.nme24='9'
   LET l_nme.nme25 = g_apa.apa06
#No.FUN-730032--end
   LET l_nme.nme26 = 'N'   #FUN-870037 add
   SELECT SUM(apx04f),SUM(apx04)
     INTO l_nme.nme04,l_nme.nme08
     FROM apx_file
    WHERE apx01 = g_apa.apa01
   IF cl_null(l_nme.nme04) THEN LET l_nme.nme04 = 0 END IF
   IF cl_null(l_nme.nme08) THEN LET l_nme.nme08 = 0 END IF

#str MOD-850268 mark 
##No.FUN-730032--begin
#  DECLARE t110_sel_apb02 CURSOR FOR
#   SELECT apb02 FROM apb_file
#    WHERE apb01 =g_apa.apa01
#  
#  FOREACH t110_sel_apb02 INTO l_nme.nme21  
#      LET g_sql="INSERT INTO ",g_dbs_nm,"nme_file ",
#                "      (nme00,nme01,nme02,nme03, ",
#                "       nme04,nme07,nme08,nme10, ",
#                "       nme11,nme12,nme13,nme14, ",   #No:9615 add nme14
#                "       nme15,nme16,nme17,nmeacti, ",
#                "       nmeuser,nmegrup,nmedate,nme21,nme22,nme23,nme24,nme25)", #No.FUN-730032
#                "VALUES('",l_nme.nme00,"','",l_nme.nme01,"','",l_nme.nme02,"','",l_nme.nme03,"', ",
#                "       '",l_nme.nme04,"','",l_nme.nme07,"','",l_nme.nme08,"','",l_nme.nme10,"', ",
#                "       '",l_nme.nme11,"','",l_nme.nme12,"','",l_nme.nme13,"','",l_nme.nme14,"', ",
#                "       '",l_nme.nme15,"','",l_nme.nme16,"','",l_nme.nme17,"','",l_nme.nmeacti,"', ",
#                "       '",l_nme.nmeuser,"','",l_nme.nmegrup,"','",l_nme.nmedate,"', ",   
#                "       '",l_nme.nme21,"','",l_nme.nme22,"','",l_nme.nme23,"','",l_nme.nme24,"','",l_nme.nme25,"') "
#      PREPARE t110_y_nme_p1 FROM g_sql
#      IF STATUS THEN
#         CALL cl_err('ins nme:',STATUS,1)   
#         LET g_success='N'
#         RETURN
#      END IF
#      
#      EXECUTE t110_y_nme_p1
#      DISPLAY "status",STATUS
#      IF STATUS THEN
#         CALL cl_err('ins nme:',STATUS,1)
#         LET g_success='N'
#      END IF
#      
#      DISPLAY "SQLCA.sqlerrd[3]=",SQLCA.SQLERRD[3]
#      IF SQLCA.SQLERRD[3]=0 THEN
#         CALL cl_err('ins nme: ',SQLCA.SQLCODE,1)
#         LET g_success='N'
#         RETURN
#      END IF
#  END FOREACH
##MOD-740500--begin      
#end MOD-850268 mark
   IF l_nme.nme21='0' THEN
       LET g_sql="INSERT INTO ",g_dbs_nm,"nme_file ",
                 "      (nme00,nme01,nme02,nme03, ",
                 "       nme04,nme07,nme08,nme10, ",
                 "       nme11,nme12,nme13,nme14, ",   #No:9615 add nme14
                 "       nme15,nme16,nme17,nmeacti, ",
                 "       nmeuser,nmegrup,nmedate,nme21,nme22,nme23,nme24,nme25,nme26)", #No.FUN-730032
                 "VALUES('",l_nme.nme00,"','",l_nme.nme01,"','",l_nme.nme02,"','",l_nme.nme03,"', ",
                 "       '",l_nme.nme04,"','",l_nme.nme07,"','",l_nme.nme08,"','",l_nme.nme10,"', ",
                 "       '",l_nme.nme11,"','",l_nme.nme12,"','",l_nme.nme13,"','",l_nme.nme14,"', ",
                 "       '",l_nme.nme15,"','",l_nme.nme16,"','",l_nme.nme17,"','",l_nme.nmeacti,"', ",
                 "       '",l_nme.nmeuser,"','",l_nme.nmegrup,"','",l_nme.nmedate,"', ",   
                 "       '0','",l_nme.nme22,"','",l_nme.nme23,"','",l_nme.nme24,"','",l_nme.nme25,"','",l_nme.nme26,"') "
	CALL cl_replace_sqldb(g_sql) RETURNING g_sql		#FUN-920032
       PREPARE t110_y_nme_p2 FROM g_sql
       IF STATUS THEN
          CALL cl_err('ins nme:',STATUS,1)   
          LET g_success='N'
          RETURN
       END IF
       
       EXECUTE t110_y_nme_p2
       DISPLAY "status",STATUS
       IF STATUS THEN
          CALL cl_err('ins nme:',STATUS,1)
          LET g_success='N'
       END IF
       
       DISPLAY "SQLCA.sqlerrd[3]=",SQLCA.SQLERRD[3]
       IF SQLCA.SQLERRD[3]=0 THEN
          CALL cl_err('ins nme: ',SQLCA.SQLCODE,1)
          LET g_success='N'
          RETURN
       END IF
   END IF 
#MOD-740500--end      
END FUNCTION

#刪除還款銀行異動記錄檔
FUNCTION t110_del_nme_1()
   DEFINE l_n     LIKE type_file.num5  
   DEFINE l_nme24      LIKE nme_file.nme24    #No.FUN-730032
   DEFINE l_aza73      LIKE aza_file.aza73    #No.MOD-740346

   IF g_apz.apz04 = 'N' THEN
      RETURN
   END IF

   LET g_success = 'Y' 

   #No.MOD-740346 --start--
   LET g_sql="SELECT aza73 FROM ",g_dbs_nm CLIPPED,"aza_file"
	CALL cl_replace_sqldb(g_sql) RETURNING g_sql		#FUN-920032
   PREPARE t741_aza_p2 FROM g_sql
   DECLARE t741_aza_c2 CURSOR FOR t741_aza_p2
   OPEN t741_aza_c2
   FETCH t741_aza_c2 INTO l_aza73
   IF l_aza73 = 'Y' THEN
   #No.MOD-740346 --end--
#No.FUN-730032--begin
      LET g_sql="SELECT nme24 FROM ",g_dbs_nm CLIPPED,"nme_file",
                " WHERE nme12='",m_apa.apa01,"'",        #MOD-B50242 mod nme17 -> nme12
                "   AND nme22 = '04' "                   #MOD-B50242   #CHI-B60066 mod '02'->'04'
      CALL cl_replace_sqldb(g_sql) RETURNING g_sql		#FUN-920032
      PREPARE t110_z_nme_p2 FROM g_sql
      FOREACH t110_z_nme_p2 INTO l_nme24
         IF l_nme24 <> '9' THEN
            CALL cl_err('','anm-043',1)
            LET g_success='N'
            RETURN
         END IF
      END FOREACH
#No.FUN-730032--end
   END IF #No.MOD-740346
   LET g_sql =" DELETE FROM ",g_dbs_nm,"nme_file ",
              "  WHERE nme12 = '",m_apa.apa01,"' ",     #MOD-B50242 mod nme17 -> nme12
              "    AND nme22 = '04' "                   #MOD-B50242   #CHI-B60066 mod '02'->'04'
   CALL cl_replace_sqldb(g_sql) RETURNING g_sql		#FUN-920032
   PREPARE t110_z_nme_p3 FROM g_sql

   EXECUTE t110_z_nme_p3

   IF STATUS THEN
      CALL cl_err('del nme:',STATUS,1)
      LET g_success='N'
      RETURN
   END IF

   IF SQLCA.SQLERRD[3]=0 THEN
      CALL cl_err('no nme deleted:','aap-161',1)
      LET g_success='N'
      RETURN
   END IF
END FUNCTION

FUNCTION t110_k_2()
   DEFINE l_totf,l_amtf LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_tot,l_amt   LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_apv04       LIKE apv_file.apv04      #FUN-4B0079
   DEFINE cnt1,cnt2     LIKE type_file.num5      # No:FUN-690028 SMALLINT
   DEFINE i,j,k         LIKE type_file.num5      #No.FUN-690028 SMALLINT
   #DEFINE l_sql         LIKE type_file.chr1000   #No.FUN-690028 VARCHAR(600)   #MOD-720062
   DEFINE l_sql         STRING    #MOD-720062
   DEFINE p_cmd         LIKE type_file.chr1      #No.FUN-690028 VARCHAR(1)
   DEFINE g_apv DYNAMIC ARRAY OF RECORD
                apv02   LIKE apv_file.apv02,
                apv03   LIKE apv_file.apv03,
                apa07   LIKE apa_file.apa07,
                apv05   LIKE apv_file.apv05,         #No.FUN-680027
                apa08   LIKE apa_file.apa08,
                apa14   LIKE apa_file.apa14,
#No.FUN-680027--begin
#               apa34f_b LIKE apa_file.apa34,
#               apa34_b LIKE apa_file.apa34,
                apc08   LIKE apc_file.apc08,
                apc09   LIKE apc_file.apc09,
#No.FUN-680027--end
                un_payf LIKE apv_file.apv04,
                un_pay  LIKE apv_file.apv04,
                apv04f  LIKE apv_file.apv04,
                apv04   LIKE apv_file.apv04,
                apx04f  LIKE apx_file.apx04f,
                apx04   LIKE apx_file.apx04
            END RECORD
   DEFINE g_apv_t   RECORD
                apv02   LIKE apv_file.apv02,
                apv03   LIKE apv_file.apv03,
                apa07   LIKE apa_file.apa07,
                apv05   LIKE apv_file.apv05,         #No.FUN-680027
                apa08   LIKE apa_file.apa08,
                apa14   LIKE apa_file.apa14,
#No.FUN-680027--begin
#               apa34f_b LIKE apa_file.apa34,
#               apa34_b LIKE apa_file.apa34,
                apc08   LIKE apc_file.apc08,
                apc09   LIKE apc_file.apc09,
#No.FUN-680027--end
                un_payf LIKE apv_file.apv04,
                un_pay  LIKE apv_file.apv04,
                apv04f  LIKE apv_file.apv04,
                apv04   LIKE apv_file.apv04,
                apx04f  LIKE apx_file.apx04f,
                apx04   LIKE apx_file.apx04
                END RECORD
   #No.MOD-580365  --begin
   DEFINE m_apa     DYNAMIC ARRAY OF RECORD
                    apa13     LIKE apa_file.apa13,
                    apa72     LIKE apa_file.apa72,
                    apa73     LIKE apa_file.apa73
                    END RECORD
   DEFINE m_apa_t   RECORD
                    apa13     LIKE apa_file.apa13,
                    apa72     LIKE apa_file.apa72,
                    apa73     LIKE apa_file.apa73
                    END RECORD
   DEFINE m_apa34f  LIKE apa_file.apa34f
   DEFINE m_apa34   LIKE apa_file.apa34    #No.MOD-590312
   DEFINE m_apa73   LIKE apa_file.apa73
   DEFINE m_amt     LIKE type_file.num20_6   # No:FUN-690028 DEC(20,6)
   DEFINE l_apa     RECORD LIKE apa_file.*
   DEFINE l_net     LIKE apv_file.apv04
   DEFINE l_apa14   LIKE apa_file.apa14
   DEFINE l_apv02   LIKE apv_file.apv02
   DEFINE l_i       LIKE type_file.num5    #No.FUN-690028 SMALLINT
   #No.MOD-580365  --end
   DEFINE l_apa13   LIKE apa_file.apa13
   DEFINE l_apa41   LIKE apa_file.apa41
   DEFINE l_apv04f  LIKE apv_file.apv04f
   DEFINE l_apa35f,l_apa35 LIKE apa_file.apa35
   DEFINE l_difff,l_diff   LIKE apa_file.apa34
   DEFINE l_sumf,l_sum     LIKE apa_file.apa34
   DEFINE l_sumf_h,l_sum_h LIKE apa_file.apa34
   DEFINE l_sum_apx04f    LIKE apx_file.apx04f
   DEFINE l_sum_apx04     LIKE apx_file.apx04 
   DEFINE l_total   LIKE apa_file.apa34
   DEFINE l_lock_sw       LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_modify_flag   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_k,l_over      LIKE type_file.num5,   # No:FUN-690028 SMALLINT,
   l_allow_insert  LIKE type_file.num5,                #可新增否  #No.FUN-690028 SMALLINT
   l_allow_delete  LIKE type_file.num5                 #可刪除否  #No.FUN-690028 SMALLINT
   DEFINE ls_rec_b        LIKE type_file.num10     # No:FUN-690028 INTEGER
    DEFINE l_apa06  LIKE apa_file.apa06   #MOD-580079
#No.FUN-680027--begin
   DEFINE l_apc     RECORD LIKE apc_file.*   #No.FUN-680027
   DEFINE m_apc13   LIKE apc_file.apc13    #No.FUN-680027
   DEFINE l_apa65  LIKE apa_file.apa65  
   DEFINE l_apa65f LIKE apa_file.apa65f 
   DEFINE l_apc02  LIKE apc_file.apc02  
   DEFINE l_apc14  LIKE apc_file.apc14  
   DEFINE l_apc15  LIKE apc_file.apc15  
#No.FUN-680027--end
   DEFINE l_pmb02  LIKE pmb_file.pmb02  #TQC-770027

    SELECT * INTO g_apa.* FROM apa_file
     WHERE apa01=g_apa.apa01

   IF g_apa.apa00[1,1] = '2' THEN
      RETURN
   END IF
   IF g_apa.apa41 = 'Y' THEN
      CALL cl_err(g_apa.apa01,'aap-005',0)
      RETURN
   END IF
   IF g_apa.apa63 MATCHES '[Ss1]' THEN      #FUN-540045 #FUN-550042
      CALL cl_err('','mfg3557',0)
      RETURN
   END IF

   LET g_success='Y'
   LET g_apa_t.* = g_apa.*
   BEGIN WORK
   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa_rowid
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl k:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF
   FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
       CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
       CLOSE t110_cl
       ROLLBACK WORK
       RETURN
   END IF

   OPEN WINDOW t110_kkk_w2 WITH FORM "aap/42f/aapt110_m"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN
    CALL cl_ui_locale("aapt110_m")

   #-----MOD-660095---------
#No.CHI-6A0004---Begin----
#   SELECT azi04 INTO g_azi04 FROM azi_file
#      WHERE azi01 = g_aza.aza17
#No.CHI-6A0004---End----
   SELECT azi04 INTO t_azi04 FROM azi_file
      WHERE azi01 = g_apa.apa13
   #-----END MOD-660095-----

 
   SELECT COUNT(*) INTO cnt1 FROM apv_file WHERE apv01 = g_apa.apa01

   IF cnt1 = 0 THEN
      DECLARE t110_kkk2_c0 CURSOR FOR
#No.FUN-680027--begin
#       SELECT apa01,apa07,apa08,apa14,
#              apa34f,(apa34f-apa35f),0,
#              apa34,(apa34-apa35),0,apa13,apa72,apa73 #No.MOD-580365
#         FROM apa_file
#        WHERE apa06=g_apa.apa06 AND apa07=g_apa.apa07
#          AND apa00 MATCHES "2*"
#          AND apa13 = g_apa.apa13          # 幣別必須相同
#          AND apa08 != g_apa.apa01            # 不可沖自已產生的預付
#          AND apa41 = 'Y' AND apa42 != 'Y'
#          AND (apa58 = '2' OR apa58 ='3' OR apa58 IS NULL)
#          AND apa34 > apa35

        SELECT apc01,apa07,apa08,apc06,apc02,
                  apc08,(apc08-apc10),0,
                  apc09,(apc09-apc11),0,0,0,apa13,apa07,apc13  #No.MOD-580365
             FROM apa_file,apc_file 
          WHERE apa06 = g_apa.apa06
            AND apa07 = g_apa.apa07
            AND apa00 ='25' 
            AND apa13 = g_apa.apa13          # 幣別必須相同
            AND apa08 != g_apa.apa01         # 不可沖自已產生的預付
            AND apa41 = 'Y' AND apa42 != 'Y' 
            AND (apa58 = '2' OR apa58 ='3' OR apa58 IS NULL)
            AND apa34 > apa35 
            AND apa01 =apc01
#No.FUN-680027--end    
      CALL g_apv.clear()
      LET i = 1

      FOREACH t110_kkk2_c0 INTO g_apv[i].apv03,g_apv[i].apa07,g_apv[i].apa08,    #No.FUN-680027 #No.FUN-690080
                               g_apv[i].apa14,g_apv[i].apv05,g_apv[i].apc08,    #No.FUN-680027 #No.FUN-690080
                               g_apv[i].un_payf,g_apv[i].apv04f, #No.FUN-690080
                               g_apv[i].apc09,g_apv[i].un_pay,g_apv[i].apv04,   #No.FUN-680027
                               g_apv[i].apx04f,g_apv[i].apx04,
                               #No.MOD-580365  --begin
                               m_apa[i].apa13,m_apa[i].apa72,m_apa[i].apa73
                               #No.MOD-580365  --end

         #No.MOD-580365  --begin
         IF g_apz.apz27 = 'Y' AND m_apa[i].apa13 !=g_aza.aza17 THEN
             LET g_apv[i].un_pay = m_apa[i].apa73
             LET g_apv[i].apa14  = m_apa[i].apa72
         END IF
         #No.MOD-580365  --end
         IF cl_null(g_apv[i].apv03) THEN
            EXIT FOREACH
         END IF
         IF g_apa.apa00='11' THEN
            DROP TABLE x

            SELECT apa08 INTO g_msg FROM apa_file WHERE apa01=g_apv[i].apv03

            SELECT apb06 po_no FROM apb_file,apa_file
             WHERE apa01=g_msg AND apa01=apb01 AND apa41='Y' AND apa42!='Y'
              INTO TEMP x

            SELECT COUNT(*) INTO g_cnt FROM x     # 如果原預付有指定 P/O No

            IF g_cnt > 0 THEN
               SELECT MAX(po_no) INTO g_msg FROM x
               SELECT COUNT(*) INTO g_cnt FROM apb_file, x
                WHERE apb01=g_apa.apa01 AND apb06=po_no
               IF g_cnt=0 THEN
                  INITIALIZE g_apv[i].* TO NULL CONTINUE FOREACH
               END IF
            END IF
         END IF

         LET g_apv[i].apv02 = i

         INSERT INTO apv_file(apv01,apv02,apv03,apv04f,apv04,apv05)     #No.FUN-680027
           VALUES (g_apa.apa01,i,g_apv[i].apv03,0,0,g_apv[i].apv05)     #No.FUN-680027
 
         LET i = i + 1
          IF i > g_max_rec THEN     #No:MOD-480131
            EXIT FOREACH
         END IF
      END FOREACH
      CALL g_apv.deleteElement(i)
      LET ls_rec_b = i - 1
   END IF

   IF cnt1 > 0 THEN
      DECLARE t110_kkk2_c CURSOR FOR
#No.FUN-680027--begin
#        SELECT apv02,apv03,apa07,apa08,apa14,
#           apa34f,apa34,(apa34f-apa35f),(apa34-apa35 ),apv04f,apv04,#MOD-4A0288
#           apa13,apa72,apa73  #No.MOD-580365
#          FROM apv_file, OUTER apa_file
#         WHERE apv01 = g_apa.apa01 AND apv03 = apa_file.apa01
#         ORDER BY apv02
         SELECT apv02,apv03,apa07,apc02,apa08,apc06,
            apc08,apc09,(apc08-apc10),(apc09-apc11),apv04f,apv04,0,0, #MOD-4A0288
            apa13,apc07,apc13  #No.MOD-580365
           FROM apv_file,OUTER apc_file,OUTER apa_file
          WHERE apv01 = g_apa.apa01 AND apv03 = apa_file.apa01
            AND  apc_file.apc01 =apv03
            AND  apc_file.apc01 =apa_file.apa01
            AND  apc_file.apc02 =apv05
          ORDER BY apv02
#No.FUN-680027--end   

      CALL g_apv.clear()
      LET k = 1
     #LET g_apa.apa65f= 0   #MOD-860251 mark
     #LET g_apa.apa65 = 0   #MOD-860251 mark

      FOREACH t110_kkk2_c INTO g_apv[k].*,m_apa[k].* #No.MOD-580365
        #str MOD-860251 mark
        #SELECT apx04f,apx04 INTO g_apv[k].apx04f,g_apv[k].apx04
        #  FROM apx_file
        # WHERE apx01 = g_apa.apa01
        #   AND apx02 = g_apv[k].apv02
        #   AND apx03 = g_apv[k].apv03
        #LET g_apa.apa65f = g_apa.apa65f + g_apv[k].apv04f
        #LET g_apa.apa65  = g_apa.apa65  + g_apv[k].apv04
        #end MOD-860251 mark
         LET k = k + 1
         IF k > g_max_rec THEN         #No:MOD-480131
            EXIT FOREACH
         END IF
      END FOREACH
      CALL g_apv.deleteElement(k)
     #str MOD-860251 add
     #重新計算沖帳視窗中的匯差
      LET l_net = 0
      FOR l_i = 1 TO g_apv.getLength()
          IF cl_null(g_apv[l_i].apv03) THEN CONTINUE FOR END IF
          IF g_apv[l_i].apv03 = 'DIFF' THEN CONTINUE FOR END IF
          SELECT apa14 INTO l_apa14 FROM apa_file
           WHERE apa01=g_apv[l_i].apv03
          IF l_apa14 <> g_apv[l_i].apa14 THEN
             LET l_amt=cl_digcut(g_apv[l_i].apv04f*g_apa.apa14,g_azi04)
                      -g_apv[l_i].apv04
             IF cl_null(l_amt) THEN LET l_amt=0 END IF
             LET l_net = l_net + l_amt
             LET l_net = cl_digcut(l_net,g_azi04)
          ELSE
             IF g_apv[l_i].apa14 <> g_apa.apa14 THEN
                LET l_amt=cl_digcut(g_apv[l_i].apv04f*g_apa.apa14,g_azi04)
                         -g_apv[l_i].apv04
                IF cl_null(l_amt) THEN LET l_amt=0 END IF
                LET l_net = l_net + l_amt
                LET l_net = cl_digcut(l_net,g_azi04)
             END IF
          END IF
      END FOR
      DELETE FROM apv_file WHERE apv01=g_apa.apa01 AND apv03='DIFF'
      IF SQLCA.sqlcode THEN
         CALL cl_err3("del","apv_file", g_apa.apa01,"",SQLCA.sqlcode,"","delete diff",1)
      END IF
      IF l_net <> 0 THEN
         SELECT MAX(apv02)+1 INTO l_apv02 FROM apv_file
          WHERE apv01 = g_apa.apa01
         IF cl_null(l_apv02)  THEN
            LET l_apv02 = 1
         END IF
         INSERT INTO apv_file (apv01,apv02,apv03,apv04f,apv04)
                       VALUES (g_apa.apa01,l_apv02,'DIFF',0,l_net)
         IF SQLCA.sqlcode THEN
            CALL cl_err3("ins","apv_file",g_apa.apa01,l_apv02,SQLCA.sqlcode,"","insert diff",1)
         END IF
      END IF

      DECLARE t110_kkk2_c1 CURSOR FOR
         SELECT apv02,apv03,apa07,apc02,apa08,apc06,
                apc08,apc09,(apc08-apc10),(apc09-apc11),apv04f,apv04,0,0,
                apa13,apc07,apc13
           FROM apv_file,OUTER apc_file,OUTER apa_file
          WHERE apv01 = g_apa.apa01 AND apv03 = apa_file.apa01
            AND apc_file.apc01 =apv03
            AND apc_file.apc02 =apv05
          ORDER BY apv02

      CALL g_apv.clear()
      LET k = 1
      LET g_apa.apa65f = 0
      LET g_apa.apa65 = 0

      FOREACH t110_kkk2_c1 INTO g_apv[k].*,m_apa[k].*
         SELECT apx04f,apx04 INTO g_apv[k].apx04f,g_apv[k].apx04
           FROM apx_file
          WHERE apx01 = g_apa.apa01
            AND apx02 = g_apv[k].apv02
            AND apx03 = g_apv[k].apv03
         LET g_apa.apa65f = g_apa.apa65f + g_apv[k].apv04f
         LET g_apa.apa65  = g_apa.apa65  + g_apv[k].apv04
         LET k = k + 1
         IF k > g_max_rec THEN
            EXIT FOREACH
         END IF
      END FOREACH
      CALL g_apv.deleteElement(k)
     #end MOD-860251 add
      LET ls_rec_b = k - 1
   END IF

   LET l_sumf_h = g_apa.apa65f
   LET l_sum_h  = g_apa.apa65

   DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
 
   LET l_allow_insert = cl_detail_input_auth("insert")
   LET l_allow_delete = cl_detail_input_auth("delete")

   LET i = 1
   INPUT ARRAY g_apv WITHOUT DEFAULTS FROM s_apv.*
         ATTRIBUTE(COUNT=ls_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                   INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)

      BEFORE INSERT
         LET i = ARR_CURR()
         LET p_cmd='a'
         INITIALIZE g_apv[i].* TO NULL
         LET g_apv_t.* = g_apv[i].*
         NEXT FIELD apv02
 
      AFTER INSERT
         IF INT_FLAG THEN
            CALL cl_err('',9001,0)
            LET INT_FLAG = 0
            CANCEL INSERT
         END IF
         IF g_apv[i].apv03 IS NULL THEN
            CALL g_apv.deleteElement(i)
            NEXT FIELD apv02
            CANCEL INSERT
         END IF
         IF g_apv[i].apx04f > 0 OR g_apv[i].apx04 >0 THEN
            INSERT INTO apx_file(apx01,apx02,apx03,apx04f,apx04)      #No.FUN-680027
             VALUES(g_apa.apa01,g_apv[i].apv02,g_apv[i].apv03,
                    g_apv[i].apx04f,g_apv[i].apx04)          #No.FUN-680027
             SELECT SUM(apx04f),SUM(apx04) INTO g_apa.apa37f,g_apa.apa37
               FROM apx_file WHERE apx01=g_apa.apa01
             IF cl_null(g_apa.apa37f) THEN LET g_apa.apa37f = 0 END IF
             IF cl_null(g_apa.apa37 ) THEN LET g_apa.apa37 = 0 END IF
             DISPLAY BY NAME g_apa.apa37f,g_apa.apa37
             UPDATE apa_file SET apa37f=g_apa.apa37f,apa37=g_apa.apa37
              WHERE apa01 = g_apa.apa01
             IF STATUS OR SQLCA.SQLCODE THEN
                CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                LET g_success='N'
             END IF
         END IF
         INSERT INTO apv_file(apv01,apv02,apv03,apv04f,apv04,apv05)      #No.FUN-680027
          VALUES(g_apa.apa01,g_apv[i].apv02,g_apv[i].apv03,
                 g_apv[i].apv04f,g_apv[i].apv04,g_apv[i].apv05)          #No.FUN-680027
         IF SQLCA.sqlcode THEN
#           CALL cl_err('ins apv:',SQLCA.SQLCODE,1)   #No.FUN-660122
            CALL cl_err3("ins","apv_file",g_apa.apa01,g_apv[i].apv02,SQLCA.sqlcode,"","ins apv:",1)  #No.FUN-660122
            LET g_success = 'N'
            CANCEL INSERT
         ELSE
            LET ls_rec_b = ls_rec_b + 1
            MESSAGE "insert ok"
            IF g_success = 'Y' THEN
               SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa65f,g_apa.apa65
                 FROM apv_file WHERE apv01=g_apa.apa01
 
               IF cl_null(g_apa.apa65f) THEN
                  LET g_apa.apa65f = 0
               END IF
 
               IF cl_null(g_apa.apa65 ) THEN
                  LET g_apa.apa65 = 0
               END IF
 
               DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
 
               UPDATE apa_file SET apa65f=g_apa.apa65f,apa65=g_apa.apa65
                WHERE apa01 = g_apa.apa01
               IF STATUS OR SQLCA.SQLCODE THEN
#                 CALL cl_err('upd apa1:',SQLCA.SQLCODE,1)   #No.FUN-660122
                  CALL cl_err3("upd","apa_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                  LET g_success='N'
                  IF p_cmd = 'u' THEN
                     LET g_apv[i].*=g_apv_t.*
                  END IF
               END IF

#str MOD-8C0082 mark
##No.FUN-680027--begin
#            DECLARE t110_apc_cs22 CURSOR FOR
#              SELECT apc02,apc14,apc15 FROM apc_file WHERE apc01 =g_apa.apa01 ORDER BY apc02
#
#            SELECT count(*) g_cnt FROM apc_file 
#             WHERE apc01 = g_apa.apa01
#            IF g_cnt >0 THEN
#               LET l_apa65  =g_apa.apa65
#               LET l_apa65f =g_apa.apa65f
#               FOREACH t110_apc_cs22 INTO l_apc02,l_apc14,l_apc15
#                   IF l_apc14 >=l_apa65f THEN
#                      LET l_apc14 = l_apc14 - l_apa65f
#                      LET l_apa65f = 0
#                   ELSE 
#                      LET l_apa65f = l_apa65f - l_apc14
#                      LET l_apc14 = 0
#                   END IF
#                   IF l_apc15 >=l_apa65f THEN
#                      LET l_apc15 = l_apc15 - l_apa65
#                      LET l_apa65 = 0
#                   ELSE 
#                      LET l_apa65 = l_apa65 - l_apc15
#                      LET l_apc15 = 0
#                   END IF
#                   UPDATE apc_file set apc14 =l_apc14,
#                                       apc15 =l_apc15
#                    WHERE apc01 = g_apa.apa01
#                      AND apc02 = l_apc02
#                   IF l_apa65 =0 OR l_apa65f = 0 THEN
#                      EXIT FOREACH
#                   END IF
#               END FOREACH
#            END IF
##No.FUN-680027--end
#end MOD-8C0082 mark
 
               SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                 FROM aph_file,apf_file
                WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                  AND aph03 IN ('6','7','8','9')
 
               IF g_amt1f IS NULL THEN
                  LET g_amt1f = 0
                  LET g_amt1 = 0
               END IF
 
               SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                 FROM apv_file Where apv03=g_apv[i].apv03
 
               IF g_amt2f IS NULL THEN
                  LET g_amt2f = 0
                  LET g_amt2 = 0
               END IF
 
               SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                 FROM oob_file,ooa_file
                WHERE oob01 = ooa01
                  AND oob06 = g_apv[i].apv03
                  AND oob03 = '2' AND oob04 = '9'
                  AND ooaconf = 'Y' #須為已確認
 
               IF cl_null(g_amt3f) THEN
                  LET g_amt3f = 0
                  LET g_amt3 = 0
               END IF

              #str MOD-8C0082 add
               #成本分攤
               SELECT SUM(aqb04) INTO g_amt4 FROM aqa_file,aqb_file
                WHERE aqa01 = aqb01 AND aqa04='Y' AND aqaconf = 'Y'
                  AND aqb02=g_apv[i].apv03
               IF cl_null(g_amt4) THEN
                  LET g_amt4=0
                  LET g_amt4f=0
               END IF
               LET g_amt4f=g_amt4/g_apv[i].apa14
              #end MOD-8C0082 add

              #str MOD-8C0082 mod
               #LET g_amt1f=g_amt1f+g_amt2f+g_amt3f
               #LET g_amt1=g_amt1+g_amt2+g_amt3
               LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f
               LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4
              #end MOD-8C0082 mod
               #No.MOD-580365  --begin
               #LET g_apa.apa72=g_apa.apa14
               #LET g_apa.apa73=g_apa.apa34-g_apa.apa35
               SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
               #No.MOD-590312  --begin
               CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
               #No.MOD-640537  --Begin
               #SELECT apa34 INTO m_apa34 FROM apa_file
               #WHERE apa01 = g_apv[i].apv03
               #LET g_apa.apa73 = m_apa34 - g_amt1 + g_net
               LET l_apa.apa73 = l_apa.apa34 - g_amt1 + g_net
               #No.MOD-640537  --End  
               #No.MOD-590312  --end
 
               UPDATE apa_file SET apa35f= g_amt1f,
                                   apa35 = g_amt1,
               #                   apa72 = g_apa.apa72,
                                   apa73 = l_apa.apa73  #No.MOD-640537
                WHERE apa01 = g_apv[i].apv03
               #No.MOD-580365  --end

#No.FUN-680027--begin
               SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                 FROM aph_file,apf_file
                WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                  AND aph03 IN ('6','7','8','9')
                  AND aph17 = g_apv[i].apv05             #No.FUN-680027
 
               IF g_amt1f IS NULL THEN
                  LET g_amt1f = 0
                  LET g_amt1 = 0
               END IF
 
               SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                 FROM apv_file Where apv03=g_apv[i].apv03
                                #AND aph04=g_apv[i].apv05   #No.FUN-680027   #MOD-860272 mark
                                 AND apv05=g_apv[i].apv05   #No.FUN-680027   #MOD-860272
 
               IF g_amt2f IS NULL THEN
                  LET g_amt2f = 0
                  LET g_amt2 = 0
               END IF
 
               SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                 FROM oob_file,ooa_file
                WHERE oob01 = ooa01
                  AND oob06 = g_apv[i].apv03
                  AND oob03 = '2' AND oob04 = '9'
                  AND ooaconf = 'Y' #須為已確認
                  AND oob19 = g_apv[i].apv05             #No.FUN-680027
 
               IF cl_null(g_amt3f) THEN
                  LET g_amt3f = 0
                  LET g_amt3 = 0
               END IF
 
               LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f    #TQC-C70079  add   g_amt4f
               LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4         #TQC-C70079  add   g_amt4
               SELECT * INTO l_apc.* FROM apc_file WHERE apc01=g_apv[i].apv03 AND apc02 =g_apv[i].apv05
               #No.FUN-7B0055  --Begin 
               #CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
               CALL t110_comp_oox1(g_apv[i].apv03,g_apv[i].apv05) RETURNING g_net
               #No.FUN-7B0055  --End   
               LET l_apc.apc13 = l_apc.apc09 - g_amt1 + g_net
               UPDATE apc_file set apc10=g_amt1f,
                                   apc11=g_amt1,
                                  #apc14=apc10,    #No.TQC-7C0094   #MOD-8C0082 mark
                                  #apc15=apc11,    #No.TQC-7C0094   #MOD-8C0082 mark
                                   apc13=l_apc.apc13
                WHERE apc01 =g_apv[i].apv03
                  AND apc02 =g_apv[i].apv05
#No.FUN-680027--end
            END IF
         END IF


      BEFORE INPUT
         IF ls_rec_b != 0 THEN
            CALL fgl_set_arr_curr(i)
         END IF
         LET g_before_input_done = FALSE
         CALL t110_set_entry_apv('a')
         CALL t110_set_no_entry_apv('a')
         LET g_before_input_done = TRUE

      BEFORE ROW
         LET p_cmd = ''
         LET i = ARR_CURR()
         LET l_lock_sw = 'N'
         IF ls_rec_b >= i THEN
            LET p_cmd='u'
            LET g_apv_t.* = g_apv[i].*
            # LET g_success = 'Y'              #No:MOD-510148
            #-->鎖住待抵沖帳資料
            #No.MOD-580365  --begin
            IF g_apv_t.apv03 <> 'DIFF' THEN
               LET g_forupd_sql = "SELECT apa07,apc12,apc06,apc08,(apc08-apc10),",      #No.FUN-680027
                                  "       apc09,(apc09-apc11),apa13,apc07,apc13",      #No.FUN-680027
                                  "  FROM apa_file,apc_file",       #No.FUN-680027
                                  " WHERE apa01 =apc01 ",           #No.FUN-680027
#                                 "   AND apa01=? FOR UPDATE NOWAIT"       #No.FUN-680027     #No.TQC-850001
                                  "   AND apa01=? "                 #No.FUN-680027     #No.TQC-850001
               #No.MOD-580365  --end
               DECLARE t110_loc_cr2 CURSOR FROM g_forupd_sql
 
               OPEN t110_loc_cr2 USING g_apv_t.apv03
               IF STATUS THEN
                  CALL cl_err("OPEN t110_loc_cr2:", STATUS, 1)
                  LET l_lock_sw = "Y"
               END IF
 
               FETCH t110_loc_cr2 INTO g_apv[i].apa07,g_apv[i].apa08,g_apv[i].apa14,
                                      g_apv[i].apc08,g_apv[i].un_payf,      #No.FUN-680027
                                      g_apv[i].apc09,g_apv[i].un_pay,       #No.FUN-680027
                                      m_apa[i].*  #No.MOD-580365
               IF SQLCA.sqlcode THEN
                  CALL cl_err(g_apv_t.apv02,SQLCA.sqlcode,1)
                  LET l_lock_sw = "Y"
               END IF
             #No.MOD-580365  --begin
               IF g_apz.apz27 = 'Y' AND g_aza.aza17 ! = m_apa[i].apa13 THEN
                  LET g_apv[i].un_pay = m_apa[i].apa73
                  LET g_apv[i].apa14  = m_apa[i].apa72
               END IF
            END IF
            #No.MOD-580365  --end
            CALL cl_show_fld_cont()     #FUN-550037(smin)
         END IF

      BEFORE FIELD apv02
         IF cl_null(g_apv[i].apv02) OR g_apv[i].apv02 = 0 THEN
            SELECT MAX(apv02)+1 INTO g_apv[i].apv02 FROM apv_file
             WHERE apv01 = g_apa.apa01
            IF cl_null(g_apv[i].apv02)  THEN
               LET g_apv[i].apv02 = 1
            END IF
            LET g_apv[i].apv04f= 0
            LET g_apv[i].apv04 = 0
         END IF
          CALL t110_set_entry_apv(p_cmd)  #MOD-4A0288

      AFTER FIELD apv02
         IF g_apv_t.apv02 IS NULL OR
            g_apv_t.apv02 != g_apv[i].apv02 THEN
            SELECT COUNT(*) INTO k FROM apv_file
                WHERE apv01 = g_apa.apa01 AND apv02 = g_apv[i].apv02
            IF k > 0 THEN
               CALL cl_err('',-239,0)
               NEXT FIELD apv02
            END IF
         END IF
          CALL t110_set_no_entry_apv(p_cmd)  #MOD-4A0288


      AFTER FIELD apv03
         #No.MOD-580365  --begin
         #IF NOT cl_null(g_apv[i].apv03) THEN
         IF NOT cl_null(g_apv[i].apv03) AND g_apv[i].apv03 <> 'DIFF' THEN
            CALL t110_set_entry_apv('F')
         #No.MOD-580365  --end
#No.FUN-680027--begin  mark起來的內容放在AFTER FIELD apv05內處理
#           LET g_forupd_sql = "SELECT apa07,apa08,apa13,apa14,apa34f,",
#                              "       (apa34f-apa35f),apa34,(apa34-apa35),",
#                              #No.MOD-580365  --begin
#                              "       apa41,apa13,apa72,apa73 FROM apa_file",
#                              #No.MOD-580365  --end
#                              " WHERE apa01 = ? AND apa00 LIKE '2%'",
#                              "   AND (apa58='2' OR apa58='3' OR apa58 IS NULL)",
#                              "   AND apa41 = 'Y' AND apa42 != 'Y' FOR UPDATE NOWAIT"
#           DECLARE t110_loc2_cr CURSOR FROM g_forupd_sql

#           OPEN t110_loc2_cr USING g_apv[i].apv03
#           IF STATUS THEN
#              CALL cl_err("OPEN t110_loc2_cr:", STATUS, 1)
#              CLOSE t110_loc2_cr
#              ROLLBACK WORK
#              RETURN
#           END IF

#           FETCH t110_loc2_cr INTO g_apv[i].apa07,g_apv[i].apa08,l_apa13,
#                                   g_apv[i].apa14,g_apv[i].apa34f_b,l_amtf,
#                                   g_apv[i].apa34_b,l_amt,l_apa41,
#                                   m_apa[i].apa13,m_apa[i].apa72,m_apa[i].apa73 #No.MOD-580365
#           IF SQLCA.sqlcode THEN
#              CALL cl_err(g_apv[i].apv03,SQLCA.sqlcode,0)
#              LET g_apv[i].apv03 = g_apv_t.apv03
#              CLOSE t110_loc2_cr
#              NEXT FIELD apv03
#           END IF
 #MOD-580079
            SELECT apa06 INTO l_apa06 FROM apa_file
               WHERE apa01= g_apv[i].apv03
            IF g_apa.apa06 <> l_apa06 THEN
               CALL cl_err('','aap-098',1)
            END IF
 #END MOD-580079
#           #-->此帳款尚未確認
#           IF l_apa41 != 'Y' THEN
#              CALL cl_err(g_apv[i].apv03,'aap-141',0)
#              NEXT FIELD apv03
#           END IF

#           #-->不可沖不同幣別
#           IF l_apa13 != g_apa.apa13 THEN
#              CALL cl_err(g_apv[i].apv03,'aap-014',0)
#              NEXT FIELD apv03
#           END IF

#           #-->無金額可沖帳
#           IF l_amtf <=0 AND l_amt <=0 THEN
#              CALL cl_err(g_apv[i].apv03,'aap-203',0)
#              NEXT FIELD apv03
#           END IF
#           LET g_apv[i].un_payf= l_amtf
#           LET g_apv[i].un_pay = l_amt
#           #No.MOD-580365  --begin
#           SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
#           IF g_apz.apz27 = 'Y' AND g_aza.aza17 != m_apa[i].apa13 THEN
#               LET g_apv[i].un_pay = m_apa[i].apa73
#               LET g_apv[i].apa14  = m_apa[i].apa72
#           END IF
#           #No.MOD-580365  --end
#No.FUN-680027--end
         END IF

      AFTER FIELD apv04f
         #No.MOD-580365  --begin
         IF NOT cl_null(g_apv[i].apv04f) THEN
            IF g_apv[i].apv04f < 0 THEN
               NEXT FIELD apv04f
            END IF
            LET l_apv04 = g_apv[i].apv04f * g_apv[i].apa14
            IF g_apv[i].apv03 <> 'DIFF' THEN
               LET g_apv[i].apv04 = l_apv04
            END IF
         END IF
         #原幣是否已經衝平，如果原幣已經衝平，則本幣也應衝平
         SELECT apa34f,apa73 INTO m_apa34f,m_apa73 FROM apa_file
         WHERE apa01 = g_apv[i].apv03
         SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
           FROM aph_file,apf_file
          WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
            AND aph03 IN ('6','7','8','9')
         IF g_amt1f IS NULL THEN
            LET g_amt1f = 0
            LET g_amt1 = 0
         END IF
 
         SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
           FROM apv_file Where apv03=g_apv[i].apv03
         IF g_amt2f IS NULL THEN
            LET g_amt2f = 0
            LET g_amt2 = 0
         END IF
 
         SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
           FROM oob_file,ooa_file
          WHERE oob01 = ooa01
            AND oob06 = g_apv[i].apv03
            AND oob03 = '2' AND oob04 = '9'
            AND ooaconf = 'Y' #須為已確認
         IF cl_null(g_amt3f) THEN
            LET g_amt3f = 0
            LET g_amt3 = 0
         END IF
         LET m_amt=g_amt1f+g_amt2f+g_amt3f
         IF p_cmd = 'a' THEN
            LET m_amt=m_amt+g_apv[i].apv04f
         ELSE
            LET m_amt=m_amt+g_apv[i].apv04f-g_apv_t.apv04f
         END IF
         IF m_amt = m_apa34f THEN
            LET g_apv[i].apv04 = m_apa73
            #LET g_apv[i].apv04 = g_apv[i].apc08*g_apv[i].apa14    #No.FUN-680027
         END IF
         #No.MOD-580365  --end
         #-----MOD-5B0132---------
         SELECT (apa34f-apa35f) INTO l_difff
           FROM apa_file WHERE apa01 = g_apv[i].apv03
 
         IF cl_null(g_apv_t.apv04f) THEN
            LET g_apv_t.apv04f = 0
         END IF
 
         LET l_total = l_difff + g_apv_t.apv04f
 
         IF  g_apv[i].apv04f > l_total THEN
            LET g_apv[i].apv04f = 0
            LET g_apv[i].apv04 = 0
            CALL cl_err(g_apa.apa01,'aap-194',0)
            NEXT FIELD apv04f
         END IF
         #-----END MOD-5B0132-----
         LET g_apv[i].apv04f = cl_digcut(g_apv[i].apv04f,t_azi04) #MOD-660095
         LET g_apv[i].apv04 = cl_digcut(g_apv[i].apv04,g_azi04) #MOD-660095


      AFTER FIELD apv04
         IF NOT cl_null(g_apv[i].apv04) THEN
            #No.MOD-580365  --begin
            #IF g_apv[i].apv04 < 0 THEN
            IF g_apv[i].apv04 < 0 AND g_apv[i].apv03 <> 'DIFF' THEN
               NEXT FIELD apv04
            END IF

            #No.MOD-580365  --begin
            IF g_apv[i].apv03 != 'DIFF' THEN
            #-->check 沖帳金額是否超過
              #不用控制本幣了，
              #因為有可能本幣會超過請款的金額，超過部分要確認匯兌損溢
            #No.MOD-580365  --end
               LET l_sum = 0
               LET l_sumf = 0
               LET l_over = 0
                FOR l_k =1 TO g_apv.getLength()   #No:MOD-480131
                  IF cl_null(g_apv[l_k].apv03) THEN
                     EXIT FOR
                  END IF
                  LET l_sumf= l_sumf+ g_apv[l_k].apv04f
                  LET l_sum = l_sum + g_apv[l_k].apv04
                  #No.MOD-580365  --begin
                  #IF l_sumf > (g_apa.apa34f + l_sumf_h) OR
                  #   l_sum > (g_apa.apa34 + l_sum_h) THEN
               END FOR

               IF l_over=1 THEN
                  NEXT FIELD apv04f
               END IF

               #No.MOD-580365  --begin
               #SELECT (apa34f-apa35f),(apa34-apa35) INTO l_difff,l_diff
               SELECT (apa34f-apa35f),apa73 INTO l_difff,l_diff
                 FROM apa_file WHERE apa01 = g_apv[i].apv03
               #No.MOD-580365  --end

               IF cl_null(g_apv_t.apv04f) THEN
                  LET g_apv_t.apv04f = 0
                  LET g_apv_t.apv04 = 0
               END IF

               LET l_total = l_diff + g_apv_t.apv04

               IF  g_apv[i].apv04 > l_total THEN
                  LET g_apv[i].apv04f = 0
                  LET g_apv[i].apv04 = 0
                  CALL cl_err(g_apa.apa01,'aap-194',0)
                  LET l_over = 1
               END IF

               IF l_over=1 THEN
                  NEXT FIELD apv04f
               END IF
             END IF #No.MOD-580365
         END IF
         LET g_apv[i].apv04 = cl_digcut(g_apv[i].apv04,g_azi04) #MOD-660095

#No.FUN-680027--begin
      AFTER FIELD apv05
          IF NOT cl_null(g_apv[i].apv05) THEN
           #MOD-A30008---modify---start---
           #LET g_forupd_sql = "SELECT apa07,apa08,apa13,apc06,apc08,",
           #                   "       (apc08-apc10),apc09,(apc09-apc11),",
           #                   "       apa41,apa13,apc07,apc13 FROM apa_file,apc_file",
           #                   " WHERE apa01 = ? AND apa00 = '25'",
           #                   "   AND (apa58='2' OR apa58='3' OR apa58 IS NULL)",
           #                   "   AND apc01=apa01 AND apc02 ='",g_apv[i].apv05,"'",
           #                   "   AND apa41 = 'Y' AND apa42 != 'Y' FOR UPDATE NOWAIT"
            LET g_forupd_sql = "SELECT '','','',apc06,apc08,",
                               "       (apc08-apc10),apc09,(apc09-apc11),",
                               "       '','',apc07,apc13 FROM apc_file",
                               " WHERE apc01 = ? ",
                               "   AND apc02 ='",g_apv[i].apv05,"' FOR UPDATE NOWAIT"
           #MOD-A30008---modify---end---
            DECLARE t110_loc22_cr CURSOR FROM g_forupd_sql

            OPEN t110_loc22_cr USING g_apv[i].apv03
            IF STATUS THEN
               CALL cl_err("OPEN t110_loc2_cr:", STATUS, 1)
               CLOSE t110_loc22_cr
               ROLLBACK WORK
               RETURN
            END IF

            FETCH t110_loc22_cr INTO g_apv[i].apa07,g_apv[i].apa08,l_apa13,
                                    g_apv[i].apa14,g_apv[i].apc08,l_amtf,
                                    g_apv[i].apc09,l_amt,l_apa41,
                                    m_apa[i].apa13,m_apa[i].apa72,m_apa[i].apa73 #No.MOD-580365
            IF SQLCA.sqlcode THEN
               CALL cl_err(g_apv[i].apv05,SQLCA.sqlcode,0)
               LET g_apv[i].apv05 = g_apv_t.apv05
               CLOSE t110_loc22_cr
               NEXT FIELD apv05
           #MOD-A30008---add---start---
            ELSE
               SELECT apa07,apa08,apa13,apa41,apa13 INTO g_apv[i].apa07,g_apv[i].apa08,l_apa13,l_apa41,m_apa[i].apa13
                 FROM apa_file
                WHERE apa01 = g_apv[i].apv03 AND apa00 = '25'
                  AND (apa58='2' OR apa58='3' OR apa58 IS NULL)
                  AND apa41 = 'Y' AND apa42 != 'Y' 
           #MOD-A30008---add---end--- 
            END IF
            #-->此帳款尚未確認
            IF l_apa41 != 'Y' THEN
               CALL cl_err(g_apv[i].apv03,'aap-141',0)
               NEXT FIELD apv05
            END IF

            #-->不可沖不同幣別
            IF l_apa13 != g_apa.apa13 THEN
               CALL cl_err(g_apv[i].apv03,'aap-014',0)
               NEXT FIELD apv05
            END IF

            #-->無金額可沖帳
            IF l_amtf <=0 AND l_amt <=0 AND g_apa.apa41 <> 'N' THEN  #No.FUN-690080
               CALL cl_err(g_apv[i].apv03,'aap-203',0)
               NEXT FIELD apv05
            END IF
            LET g_apv[i].un_payf= l_amtf
            LET g_apv[i].un_pay = l_amt
            #No.MOD-580365  --begin
            SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
            IF g_apz.apz27 = 'Y' AND g_aza.aza17 != m_apa[i].apa13 THEN
                LET g_apv[i].un_pay = m_apa[i].apa73
                LET g_apv[i].apa14  = m_apa[i].apa72
            END IF
            #No.MOD-580365  --end
         END IF

      AFTER FIELD apx04f
         IF NOT cl_null(g_apv[i].apx04f) THEN
            IF g_apv[i].apx04f < 0 THEN
               CALL cl_err('','mfg4012',0)
               NEXT FIELD apx04f
            END IF
            IF NOT cl_null(g_apv[i].apa14) THEN
               LET g_apv[i].apx04 = g_apv[i].apx04f * g_apv[i].apa14
            END IF
         END IF

      AFTER FIELD apx04
         IF NOT cl_null(g_apv[i].apx04) THEN
            IF g_apv[i].apx04 < 0 THEN
               CALL cl_err('','mfg4012',0)
               NEXT FIELD apx04
            END IF
         END IF
#No.FUN-680027--begin


      ON ACTION CONTROLP
           CASE
          #FUN-580012  --begin
          #   WHEN INFIELD(apv02)
          #      CALL cl_init_qry_var()
          #      LET g_qryparam.form ="q_apa1"
          #      LET g_qryparam.default1 =g_apv[i].apa08
          #      CALL cl_create_qry() RETURNING g_apv[i].apa08
          #       DISPLAY g_apv[i].apa08 TO apa08                 #No:MOD-490344
          #      NEXT FIELD apv02
          #FUN-580012  --end
              WHEN INFIELD(apv03)
#                 CALL q_apa2(FALSE,TRUE,' ','1') RETURNING g_apv[i].apv03,g_apv[i].apv05    #FUN-580012 #MOD-740500 mark
#                 DISPLAY g_apv[i].apv03,g_apv[i].apv05 TO apv03,apv05                       #No:MOD-490344  #MOD-740500 mark
                  #CALL q_apa2(FALSE,TRUE,' ','1') RETURNING g_apv[i].apv03      #MOD-740500 #TQC-750140
                  #CALL q_apa2(FALSE,TRUE,' ','3') RETURNING g_apv[i].apv03                   #TQC-750140   #MOD-820002
                  CALL q_apa2(FALSE,TRUE,' ','3',g_apa.apa06) RETURNING g_apv[i].apv03                   #TQC-750140   #MOD-820002
                 DISPLAY g_apv[i].apv03 TO apv03                                             #MOD-740500
                 NEXT FIELD apv03
              OTHERWISE EXIT CASE
           END CASE

         #MOD-4A0288
        BEFORE DELETE                            #是否取消單身
           IF g_apv[i].apv02 > 0 AND g_apv_t.apv02 IS NOT NULL THEN
              IF NOT cl_delb(0,0) THEN
                 CANCEL DELETE
              END IF
              IF g_apv[i].apx04f > 0 OR g_apv[i].apx04 >0 THEN
                 DELETE FROM apx_file
                  WHERE apx01 = g_apa.apa01 AND apx02 = g_apv_t.apv02
              END IF
              DELETE FROM apv_file
               WHERE apv01 = g_apa.apa01 AND apv02 = g_apv_t.apv02
              IF SQLCA.sqlcode THEN
#                CALL cl_err(g_apv_t.apv02,SQLCA.sqlcode,0)   #No.FUN-660122
                 CALL cl_err3("del","apv_file",g_apa.apa01,g_apv_t.apv02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
                 CANCEL DELETE
              END IF
              LET ls_rec_b = ls_rec_b - 1
              MESSAGE "delete ok"
              IF g_success = 'Y' AND g_apv[i].apv03 <> 'DIFF' THEN #No.MOD-580365
                 SELECT SUM(apx04f),SUM(apx04) INTO g_apa.apa37f,g_apa.apa37
                   FROM apx_file WHERE apx01=g_apa.apa01
                 IF cl_null(g_apa.apa37f) THEN LET g_apa.apa37f = 0 END IF
                 IF cl_null(g_apa.apa37 ) THEN LET g_apa.apa37 = 0 END IF
                 DISPLAY BY NAME g_apa.apa37f,g_apa.apa37
                 UPDATE apa_file SET apa37f=g_apa.apa37f,apa37=g_apa.apa37
                  WHERE apa01 = g_apa.apa01
                 IF STATUS OR SQLCA.SQLCODE THEN
                    CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                    LET g_success='N'
                 END IF
                 SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa65f,g_apa.apa65
                   FROM apv_file WHERE apv01=g_apa.apa01
                 IF cl_null(g_apa.apa65f) THEN LET g_apa.apa65f = 0 END IF
                 IF cl_null(g_apa.apa65 ) THEN LET g_apa.apa65 = 0 END IF
                 DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
                 UPDATE apa_file SET apa65f=g_apa.apa65f,apa65=g_apa.apa65
                  WHERE apa01 = g_apa.apa01
                 IF STATUS OR SQLCA.SQLCODE THEN
#                   CALL cl_err('upd apa1:',SQLCA.SQLCODE,1)   #No.FUN-660122
                    CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                    LET g_success='N'
                 END IF
                 SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                   FROM aph_file,apf_file
                  WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                    AND aph03 IN ('6','7','8','9')
                 IF g_amt1f IS NULL THEN
                    LET g_amt1f = 0
                    LET g_amt1 = 0
                 END IF
                 SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                   FROM apv_file Where apv03=g_apv[i].apv03
                 IF g_amt2f IS NULL THEN
                    LET g_amt2f = 0
                    LET g_amt2 = 0
                 END IF
                 SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                   FROM oob_file,ooa_file
                  WHERE oob01 = ooa01
                    AND oob06 = g_apv[i].apv03
                    AND oob03 = '2' AND oob04 = '9'
                    AND ooaconf = 'Y' #須為已確認
                 IF cl_null(g_amt3f) THEN
                    LET g_amt3f = 0
                    LET g_amt3 = 0
                 END IF
                #str MOD-8C0082 add
                 #成本分攤
                 SELECT SUM(aqb04) INTO g_amt4 FROM aqa_file,aqb_file
                  WHERE aqa01 = aqb01 AND aqa04='Y' AND aqaconf = 'Y'
                    AND aqb02=g_apv[i].apv03
                 IF cl_null(g_amt4) THEN
                    LET g_amt4=0
                    LET g_amt4f=0
                 END IF
                 LET g_amt4f=g_amt4/g_apv[i].apa14
                #end MOD-8C0082 add
                #str MOD-8C0082 mod
                 #LET g_amt1f=g_amt1f+g_amt2f+g_amt3f
                 #LET g_amt1=g_amt1+g_amt2+g_amt3
                 LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f
                 LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4
                #end MOD-8C0082 mod
                 #No.MOD-580365  --begin
                 #LET g_apa.apa72=g_apa.apa14
                 #LET g_apa.apa73=g_apa.apa34-g_apa.apa35
                 SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
                 #No.MOD-590312  --begin
                 CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
                 #No.MOD-640537  --Begin
                 #SELECT apa34 INTO m_apa34 FROM apa_file
                 # WHERE apa01 = g_apv[i].apv03
                 #LET g_apa.apa73 = m_apa34 - g_amt1 + g_net
                 LET l_apa.apa73 = l_apa.apa34 - g_amt1 + g_net
                 #No.MOD-640537  --End  
                 #No.MOD-590312  --end
                 #No.MOD-580365  --end
                 UPDATE apa_file SET apa35f= g_amt1f,
                                     apa35 = g_amt1,
                                    #apa72 = g_apa.apa72,   No.MOD-580365
                                     apa73 = l_apa.apa73   #No.MOD-640537
                  WHERE apa01 = g_apv[i].apv03
                 #No.FUN-680027--begin
               SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                 FROM aph_file,apf_file
                WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                  AND aph03 IN ('6','7','8','9')
                  AND aph17 = g_apv[i].apv05             #No.FUN-680027
 
               IF g_amt1f IS NULL THEN
                  LET g_amt1f = 0
                  LET g_amt1 = 0
               END IF
 
               SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                 FROM apv_file Where apv03=g_apv[i].apv03
                                #AND aph04=g_apv[i].apv05   #No.FUN-680027   #MOD-860272 mark
                                 AND apv05=g_apv[i].apv05   #No.FUN-680027   #MOD-860272
 
               IF g_amt2f IS NULL THEN
                  LET g_amt2f = 0
                  LET g_amt2 = 0
               END IF
 
               SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                 FROM oob_file,ooa_file
                WHERE oob01 = ooa01
                  AND oob06 = g_apv[i].apv03
                  AND oob03 = '2' AND oob04 = '9'
                  AND ooaconf = 'Y' #斗   w T {
                  AND oob19 = g_apv[i].apv05             #No.FUN-680027
 
               IF cl_null(g_amt3f) THEN
                  LET g_amt3f = 0
                  LET g_amt3 = 0
               END IF
 
               LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f       #TQC-C70079  add   g_amt4f
               LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4            #TQC-C70079  add   g_amt4
               SELECT * INTO l_apc.* FROM apc_file WHERE apc01=g_apv[i].apv03 AND apc02 =g_apv[i].apv05
               #No.FUN-7B0055  --Begin 
               #CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
               CALL t110_comp_oox1(g_apv[i].apv03,g_apv[i].apv05) RETURNING g_net
               #No.FUN-7B0055  --End   
               LET l_apc.apc13 = l_apc.apc09 - g_amt1 + g_net
               UPDATE apc_file set apc10=g_amt1f,
                                   apc11=g_amt1,
                                  #apc14=apc10,    #No.TQC-7C0094   #MOD-8C0082 mark
                                  #apc15=apc11,    #No.TQC-7C0094   #MOD-8C0082 mark
                                   apc13=l_apc.apc13
                WHERE apc01 =g_apv[i].apv03
                  AND apc02 =g_apv[i].apv05
#No.FUN-680027--end
              END IF
           END IF
           #--

      ON ROW CHANGE
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             LET g_apv[l_ac].* = g_apv_t.*
             CLOSE t110_loc2_cr
             LET g_success = 'N'
             EXIT INPUT
          END IF
          IF l_lock_sw = 'Y' THEN
             CALL cl_err(g_apv[l_ac].apv02,-263,1)
             LET g_apv[l_ac].* = g_apv_t.*
          ELSE
#            IF g_apv[i].apx04f > 0 AND g_apv[i].apx04 > 0 THEN
             IF g_apv[i].apx04f > 0 OR g_apv[i].apx04 > 0 THEN   #No.TQC-950113
                UPDATE apx_file SET apx03 = g_apv[i].apv03,
                                    apx04f= g_apv[i].apx04f,
                                    apx04 = g_apv[i].apx04
                 WHERE apx01 = g_apa.apa01
                   AND apx02 = g_apv_t.apv02
                IF STATUS OR SQLCA.SQLCODE THEN
                   CALL cl_err3("upd","apx_file",g_apa.apa01,g_apv_t.apv02,SQLCA.sqlcode,"","upd apx:",1)  #No.FUN-660122
                   LET g_success = 'N'
                END IF
                IF SQLCA.sqlerrd[3] = 0 THEN
                   INSERT INTO apx_file(apx01,apx02,apx03,apx04f,apx04)      #No.FUN-680027
                    VALUES(g_apa.apa01,g_apv_t.apv02,g_apv[i].apv03,
                           g_apv[i].apx04f,g_apv[i].apx04)          #No.FUN-680027
                END IF
             ELSE
                DELETE FROM apx_file
                 WHERE apx01 = g_apa.apa01 AND apx02 = g_apv_t.apv02
                IF STATUS OR SQLCA.SQLCODE THEN
                   CALL cl_err3("del","apx_file",g_apa.apa01,g_apv_t.apv02,SQLCA.sqlcode,"","upd apx:",1)  #No.FUN-660122
                   LET g_success = 'N'
                END IF
             END IF
             SELECT SUM(apx04f),SUM(apx04) INTO g_apa.apa37f,g_apa.apa37
               FROM apx_file WHERE apx01=g_apa.apa01
             IF cl_null(g_apa.apa37f) THEN LET g_apa.apa37f = 0 END IF
             IF cl_null(g_apa.apa37 ) THEN LET g_apa.apa37 = 0 END IF
             DISPLAY BY NAME g_apa.apa37f,g_apa.apa37
             UPDATE apa_file SET apa37f=g_apa.apa37f,apa37=g_apa.apa37
              WHERE apa01 = g_apa.apa01
             IF STATUS OR SQLCA.SQLCODE THEN
                CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                LET g_success='N'
             END IF
             UPDATE apv_file SET apv02 = g_apv[i].apv02,
                                 apv03 = g_apv[i].apv03,
                                 apv04f= g_apv[i].apv04f,
                                 apv04 = g_apv[i].apv04,
                                 apv05 = g_apv[i].apv05      #No.FUN-680027
              WHERE apv01 = g_apa.apa01
                AND apv02 = g_apv_t.apv02
             IF STATUS OR SQLCA.SQLCODE THEN
#               CALL cl_err('upd apv:',SQLCA.SQLCODE,1)   #No.FUN-660122
                CALL cl_err3("upd","apv_file",g_apa.apa01,g_apv_t.apv02,SQLCA.sqlcode,"","upd apv:",1)  #No.FUN-660122
                LET g_success = 'N'
                LET g_apv[i].* = g_apv_t.*
                ELSE MESSAGE "update ok"
             END IF
             IF g_success = 'Y' AND g_apv[i].apv03 <> 'DIFF' THEN #No.MOD-580365
               #str MOD-8C0011 add
               #當修改了待抵編號,應將舊待抵編號的已沖金額扣回(參考刪除段),
               #                 再UPDATE新待抵編號的已沖金額
                IF g_apv_t.apv03 != g_apv[i].apv03 THEN
                   SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                     FROM aph_file,apf_file
                    WHERE aph04=g_apv_t.apv03 AND aph01=apf01 AND apf41='Y'
                      AND aph03 IN ('6','7','8','9')
                   IF g_amt1f IS NULL THEN
                      LET g_amt1f = 0
                      LET g_amt1 = 0
                   END IF
                   SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                     FROM apv_file Where apv03=g_apv_t.apv03
                   IF g_amt2f IS NULL THEN
                      LET g_amt2f = 0
                      LET g_amt2 = 0
                   END IF
                   SELECT SUM(apv04f),SUM(apv04) INTO g_amt5f,g_amt5
                     FROM apv_file Where apv01=g_apv_t.apv03
                   IF g_amt5f IS NULL THEN
                      LET g_amt5f = 0
                      LET g_amt5 = 0
                   END IF
                   SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                     FROM oob_file,ooa_file
                    WHERE oob01 = ooa01
                      AND oob06 = g_apv_t.apv03
                      AND oob03 = '2' AND oob04 = '9'
                      AND ooaconf = 'Y' #須為已確認
                   IF cl_null(g_amt3f) THEN
                      LET g_amt3f = 0
                      LET g_amt3 = 0
                   END IF
                   LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt5f
                   LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt5
                   SELECT * INTO l_apa.* FROM apa_file
                    WHERE apa01 = g_apv_t.apv03
                   LET l_apa.apa34 = l_apa.apa31 + l_apa.apa32 - g_amt1
                   LET l_apa.apa34f= l_apa.apa31f+ l_apa.apa32f- g_amt1f
                   CALL t110_comp_oox(g_apv_t.apv03) RETURNING g_net
                   SELECT apa34 INTO m_apa34 FROM apa_file
                    WHERE apa01 = g_apv_t.apv03
                   LET g_apa.apa73 = m_apa34 - g_amt1 + g_net
                   UPDATE apa_file SET apa65f= g_amt1f,
                                       apa65 = g_amt1,
                                       apa34 = l_apa.apa34,
                                       apa34f= l_apa.apa34f,
                                       apa73 = g_apa.apa73
                    WHERE apa01 = g_apv_t.apv03
                   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
                      CALL cl_err3("upd","apa_file",g_apv_t.apv03,"",STATUS,"","upd apa",1)
                      LET g_success='N'
                   END IF
                END IF
               #end MOD-8C0011 add

                SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa65f,g_apa.apa65
                  FROM apv_file WHERE apv01=g_apa.apa01
 
                IF cl_null(g_apa.apa65f) THEN
                   LET g_apa.apa65f = 0
                END IF
 
                IF cl_null(g_apa.apa65 ) THEN
                   LET g_apa.apa65 = 0
                END IF
 
                DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
 
                UPDATE apa_file SET apa65f=g_apa.apa65f,apa65=g_apa.apa65
                 WHERE apa01 = g_apa.apa01
                IF STATUS OR SQLCA.SQLCODE THEN
#                  CALL cl_err('upd apa1:',SQLCA.SQLCODE,1)   #No.FUN-660122
                   CALL cl_err3("upd","apa_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                   LET g_success='N'
                   IF p_cmd = 'u' THEN
                      LET g_apv[i].*=g_apv_t.*
                   END IF
                END IF
 
                SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                  FROM aph_file,apf_file
                 WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                   AND aph03 IN ('6','7','8','9')
 
                IF g_amt1f IS NULL THEN
                   LET g_amt1f = 0
                   LET g_amt1 = 0
                END IF
 
                SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                  FROM apv_file Where apv03=g_apv[i].apv03
 
                IF g_amt2f IS NULL THEN
                   LET g_amt2f = 0
                   LET g_amt2 = 0
                END IF
 
                SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                  FROM oob_file,ooa_file
                 WHERE oob01 = ooa01
                   AND oob06 = g_apv[i].apv03
                   AND oob03 = '2' AND oob04 = '9'
                   AND ooaconf = 'Y' #須為已確認
 
                IF cl_null(g_amt3f) THEN
                   LET g_amt3f = 0
                   LET g_amt3 = 0
                END IF
 
                LET g_amt1f=g_amt1f+g_amt2f+g_amt3f
                LET g_amt1=g_amt1+g_amt2+g_amt3
                #No.MOD-580365  --begin
                #LET g_apa.apa72=g_apa.apa14
                #LET g_apa.apa73=g_apa.apa34-g_apa.apa35
                SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
                #No.MOD-590312  --begin
                CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
                #No.MOD-640537  --Begin
                #SELECT apa34 INTO m_apa34 FROM apa_file
                # WHERE apa01 = g_apv[i].apv03
                #LET g_apa.apa73 = m_apa34 - g_amt1 + g_net
                LET l_apa.apa73 = l_apa.apa34 - g_amt1 + g_net
                #No.MOD-640537  --End  
                #No.MOD-590312  --end
                #No.MOD-580365  --end
 
                UPDATE apa_file SET apa35f= g_amt1f,
                                    apa35 = g_amt1,
                                    #apa72 = g_apa.apa72, #No.MOD-580365
                                    apa73 = l_apa.apa73   #No.MOD-640537
                 WHERE apa01 = g_apv[i].apv03
#No.FUN-680027--begin
               SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                 FROM aph_file,apf_file
                WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                  AND aph03 IN ('6','7','8','9')
                  AND aph17 = g_apv[i].apv05             #No.FUN-680027
 
               IF g_amt1f IS NULL THEN
                  LET g_amt1f = 0
                  LET g_amt1 = 0
               END IF
 
               SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                 FROM apv_file Where apv03=g_apv[i].apv03
                                #AND aph04=g_apv[i].apv05   #No.FUN-680027   #MOD-860272 mark
                                 AND apv05=g_apv[i].apv05   #No.FUN-680027   #MOD-860272
 
               IF g_amt2f IS NULL THEN
                  LET g_amt2f = 0
                  LET g_amt2 = 0
               END IF
 
               SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                 FROM oob_file,ooa_file
                WHERE oob01 = ooa01
                  AND oob06 = g_apv[i].apv03
                  AND oob03 = '2' AND oob04 = '9'
                  AND ooaconf = 'Y' #須為已確認
                  AND oob19 = g_apv[i].apv05             #No.FUN-680027
 
               IF cl_null(g_amt3f) THEN
                  LET g_amt3f = 0
                  LET g_amt3 = 0
               END IF
 
               LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f     #TQC-C70079  add   g_amt4f
               LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4          #TQC-C70079  add   g_amt4
               SELECT * INTO l_apc.* FROM apc_file WHERE apc01=g_apv[i].apv03 AND apc02 =g_apv[i].apv05
               #No.FUN-7B0055  --Begin
               #CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
               CALL t110_comp_oox1(g_apv[i].apv03,g_apv[i].apv05) RETURNING g_net
               #No.FUN-7B0055  --End  
               LET l_apc.apc13 = l_apc.apc09 - g_amt1 + g_net
               UPDATE apc_file set apc10=g_amt1f,
                                   apc11=g_amt1,
                                  #apc14=apc10,    #No.TQC-7C0094   #MOD-8C0082 mark
                                  #apc15=apc11,    #No.TQC-7C0094   #MOD-8C0082 mark
                                   apc13=l_apc.apc13
                WHERE apc01 =g_apv[i].apv03
                  AND apc02 =g_apv[i].apv05
#No.FUN-680027--end
            END IF
          END IF

      AFTER ROW
          LET l_ac = ARR_CURR()
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             IF p_cmd = 'u' THEN
                LET g_apv[l_ac].* = g_apv_t.*
             END IF
             CLOSE t110_loc2_cr
             LET g_success = 'N'
             EXIT INPUT
          END IF
          CLOSE t110_loc2_cr

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
      #No.MOD-580365  --begin
     #計算匯差
     AFTER INPUT
        LET l_net = 0
        FOR l_i = 1 TO g_apv.getLength()
            IF cl_null(g_apv[l_i].apv03) THEN CONTINUE FOR END IF
            IF g_apv[l_i].apv03 = 'DIFF' THEN CONTINUE FOR END IF
            SELECT apa14 INTO l_apa14 FROM apa_file
             WHERE apa01=g_apv[l_i].apv03
            IF l_apa14 <> g_apv[l_i].apa14 THEN
               #LET l_amt=g_apv[l_i].apv04f*(l_apa14-g_apv[l_i].apa14)
               #-----MOD-760089---------
               #LET l_amt=g_apv[l_i].apv04f*g_apa.apa14-g_apv[l_i].apv04
               LET l_amt=cl_digcut(g_apv[l_i].apv04f*g_apa.apa14,g_azi04)
                         - g_apv[l_i].apv04
               #-----END MOD-760089-----
               IF cl_null(l_amt) THEN LET l_amt=0 END IF
               LET l_net = l_net + l_amt
            ELSE
               IF g_apv[l_i].apa14 <> g_apa.apa14 THEN
                  #LET l_amt=g_apv[l_i].apv04f*(g_apa.apa14-g_apv[l_i].apa14)
                  #-----MOD-760089---------
                  #LET l_amt=g_apv[l_i].apv04f*g_apa.apa14-g_apv[l_i].apv04
                  LET l_amt=cl_digcut(g_apv[l_i].apv04f*g_apa.apa14,g_azi04)
                            - g_apv[l_i].apv04
                  #-----END MOD-760089-----
                  IF cl_null(l_amt) THEN LET l_amt=0 END IF
                  LET l_net = l_net + l_amt
               END IF
            END IF
        END FOR
        DELETE FROM apv_file
         WHERE apv01=g_apa.apa01
           AND apv03='DIFF'
        IF SQLCA.sqlcode THEN
#          CALL cl_Err('delete diff',SQLCA.sqlcode,1)  #No.FUN-660122
           CALL cl_err3("del","apv_file", g_apa.apa01,"",SQLCA.sqlcode,"","delete diff",1)  #No.FUN-660122
           NEXT FIELD apv04
        END IF
        IF l_net <> 0 THEN
            SELECT MAX(apv02)+1 INTO l_apv02 FROM apv_file
             WHERE apv01 = g_apa.apa01
            IF cl_null(l_apv02)  THEN
               LET l_apv02 = 1
            END IF
            INSERT INTO apv_file(apv01,apv02,apv03,apv04f,apv04)
            VALUES(g_apa.apa01,l_apv02,'DIFF',0,l_net)
            IF SQLCA.sqlcode THEN
#              CALL cl_err('insert diff',SQLCA.sqlcode,1)   #No.FUN-660122
               CALL cl_err3("ins","apv_file",g_apa.apa01,l_apv02,SQLCA.sqlcode,"","insert diff",1)  #No.FUN-660122
               NEXT FIELD apv04
            END IF
         END IF
      #No.MOD-580365  --end
  
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033

   END INPUT

   IF INT_FLAG THEN
      LET g_success='N'
      LET INT_FLAG = 0
   END IF

   IF g_success = 'Y' THEN
      COMMIT WORK
      MESSAGE "Commit"
   ELSE
      ROLLBACK WORK
      MESSAGE "RollBack"
   END IF

   SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa65f,g_apa.apa65
     FROM apv_file WHERE apv01=g_apa.apa01

   IF cl_null(g_apa.apa65f) THEN
      LET g_apa.apa65f = 0
   END IF

   IF cl_null(g_apa.apa65 ) THEN
      LET g_apa.apa65 = 0
   END IF

   DISPLAY BY NAME g_apa.apa65f,g_apa.apa65

   UPDATE apa_file SET apa65f=g_apa.apa65f,apa65=g_apa.apa65
    WHERE apa01 = g_apa.apa01

   IF STATUS OR SQLCA.SQLCODE THEN
#     CALL cl_err('upd apa65:',SQLCA.SQLCODE,1)   #No.FUN-660122
      CALL cl_err3("upd","apa_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apa65:",1)  #No.FUN-660122
   END IF

   CLOSE WINDOW t110_kkk_w2

   DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
   CLOSE t110_loc_cr
   CLOSE t110_loc2_cr

   IF l_lock_sw = 'Y' THEN
      RETURN
   END IF

   CALL t110_apa34f('1')   #TQC-750140
  #IF g_apa.apa65f < g_apa.apa31f+g_apa.apa37f THEN               #MOD-B60218 mark
   IF g_apa.apa65f < g_apa.apa31f+g_apa.apa32f+g_apa.apa37f THEN  #MOD-B60218
     #IF g_apa.apa65f < g_apa.apa31f THEN                #MOD-B60218 mark
      IF g_apa.apa65f < g_apa.apa31f+g_apa.apa32f THEN   #MOD-B60218
         LET g_apa.apa37f = 0
         LET g_apa.apa37 = 0
         DELETE FROM apx_file WHERE apx01 = g_apa.apa01
      ELSE 
         DELETE FROM apx_file WHERE apx01 = g_apa.apa01
        #str MOD-B60218 mod
        #LET g_apa.apa37f = g_apa.apa65f - g_apa.apa31f
        #LET g_apa.apa37  = g_apa.apa65  - g_apa.apa31
         LET g_apa.apa37f = g_apa.apa65f - g_apa.apa31f - g_apa.apa32f
         LET g_apa.apa37  = g_apa.apa65  - g_apa.apa31  - g_apa.apa32
        #end MOD-B60218 mod
         INSERT INTO apx_file(apx01,apx02,apx03,apx04f,apx04)
              VALUES (g_apa.apa01,1,NULL,g_apa.apa37f,g_apa.apa37)
         IF SQLCA.sqlcode THEN
            CALL cl_err3("ins","apx_file",g_apa.apa01,"",SQLCA.sqlcode,"",SQLCA.sqlcode,1)
         END IF
      END IF
   END IF
   CALL t110_apa34f('1')    #TQC-750140
   IF g_apa.apa34f  < 0 OR g_apa.apa34 < 0 THEN
      IF cl_null(g_apa.apa101) OR cl_null(g_apa.apa102) THEN
         CALL cl_err(g_apa.apa01,'aap-095',1)
         CALL t110_upd_apa101()
      END IF
      LET l_sum_apx04f = -g_apa.apa34f
      LET l_sum_apx04  = -g_apa.apa34
      LET g_apa.apa34f = 0
      LET g_apa.apa34  = 0
      IF l_sum_apx04f <> 0 OR l_sum_apx04 <> 0 THEN
         LET cnt2 = 0 
         SELECT COUNT(*) INTO cnt2 FROM apx_file WHERE apx01 = g_apa.apa01 
         LET cnt2 = cnt2 + 1
         INSERT INTO apx_file(apx01,apx02,apx03,apx04f,apx04)
              VALUES (g_apa.apa01,cnt2+1,NULL,l_sum_apx04f,l_sum_apx04)
         IF SQLCA.sqlcode THEN
            CALL cl_err3("ins","apx_file",g_apa.apa01,"",SQLCA.sqlcode,"",SQLCA.sqlcode,1)
         END IF
      END IF
      SELECT SUM(apx04f),SUM(apx04) INTO g_apa.apa37f,g_apa.apa37
        FROM apx_file WHERE apx01=g_apa.apa01
      IF cl_null(g_apa.apa37f) THEN LET g_apa.apa37f = 0 END IF
      IF cl_null(g_apa.apa37 ) THEN LET g_apa.apa37 = 0 END IF
      DISPLAY BY NAME g_apa.apa37f,g_apa.apa37
      UPDATE apa_file SET apa37f=g_apa.apa37f,apa37=g_apa.apa37
       WHERE apa01 = g_apa.apa01
      IF STATUS OR SQLCA.SQLCODE THEN
         CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
         LET g_success='N'
      END IF
   END IF

   LET g_apa.apa72 = g_apa.apa14
   CALL t110_comp_oox(g_apa.apa01) RETURNING g_net       #CHI-890017 add
  #LET g_apa.apa73 = g_apa.apa34 - g_apa.apa35           #CHI-890017 mark
   LET g_apa.apa73 = g_apa.apa34 - g_apa.apa35 + g_net   #CHI-890017

   UPDATE apa_file set * = g_apa.* WHERE apa01 = g_apa.apa01
#TQC-770027.....begin
   IF g_apa.apa31 <>g_apa_t.apa31 OR g_apa.apa32 <> g_apa_t.apa32
      OR g_apa.apa34 <> g_apa_t.apa34 OR g_apa.apa57 <> g_apa_t.apa57
      OR g_apa.apa57 <> g_apa_t.apa57 OR g_apa.apa73 <> g_apa_t.apa73
      OR g_apa.apa31f <> g_apa_t.apa31f OR g_apa.apa32f <> g_apa_t.apa32f
      OR g_apa.apa34f <> g_apa_t.apa34f OR g_apa.apa57f <> g_apa_t.apa57f THEN
     SELECT DISTINCT(pmb02) INTO l_pmb02 FROM pmb_file
      WHERE pmb01 = g_apa.apa11
     #IF l_pmb02 = 1 THEN   #MOD-810156
     IF l_pmb02 = 1 OR cl_null(l_pmb02) THEN   #MOD-810156
        DELETE FROM apc_file WHERE apc01 = g_apa.apa01
        CALL t110_ins_apc(g_apa.*)
     ELSE
        IF g_apa.apa35 <> g_apa_t.apa35 OR g_apa.apa35f <> g_apa_t.apa35f THEN
           LET g_sn = 'y'
        END IF
        CALL t110_account_period()
        LET g_sn = 'n'
     END IF
    END IF
#TQC-770027.....end

   CALL t110_up_gl()
   CALL t110_unpay()

#  DELETE FROM apv_file WHERE apv01 = g_apa.apa01 AND apv04 = 0
   DELETE FROM apv_file WHERE apv01 = g_apa.apa01 AND apv04 = 0 AND apv04f =0   #No.TQC-950113

   CALL t110_diff_rtn('1') ##TQC-750140
   CALL t110_api_diff()    #No.TQC-7B0083
   DISPLAY BY NAME g_apa.apa34f,g_apa.apa34,g_apa.apa37f,g_apa.apa37   #No.FUN-690080

END FUNCTION
#No.FUN-690080 --End   
#FUN-5C0015 BY TSD.GILL --END
#No.FUN-730064  --Begin                                                                                                             
FUNCTION t110_bookno()                                                                                                              
   IF g_apz.apz02='Y' THEN          #No.TQC-740093                                                                                                
      LET g_db1 = g_apz.apz02p      #No.TQC-740093                                                                                                       
   ELSE                                                                                                                             
      LET g_db1 = g_plant                                                                                                           
   END IF
   SELECT azp03 INTO g_azp03 FROM azp_file                                                                                          
    WHERE azp01=g_db1                                                                                                               
   LET g_db_type1=cl_db_get_database_type()  #FUN-C80078  g_db_type-->g_db_type1                                                                                           

#TQC-940178  MARK&ADD START-------------
#  IF g_db_type="IFX" THEN                                                                                                          
#     LET g_dbsm = g_azp03 CLIPPED,":"                                                                                              
#  ELSE                                                                                                                             
#     LET g_dbsm = g_azp03 CLIPPED,"."                                                                                              
#  END IF               
   LET g_dbsm = s_dbstring(g_azp03)
#TQC-940178 END------------------------
   CALL s_get_bookno1(YEAR(g_apa.apa02),g_dbsm) #No.TQC-740042
        RETURNING g_flag1,g_bookno1,g_bookno2                                                                                        
   IF g_flag1 =  '1' THEN  #抓不到帳別                                                                                               
      CALL cl_err(g_dbsm,'aoo-081',1)                                                                                               
      EXIT PROGRAM                                                                                                                  
   END IF                                                                                                                           
END FUNCTION                                                                                                                        
#No.FUN-730064  --end 
#Patch....NO:MOD-5A0095 <001,002,003,004,005,006,011,015,016,019> #
#Patch....NO:TQC-610035 <001> #
#TQC-750244

##No.TQC-770056--begin--
#FUNCTION t110_apb22_chk16()
#DEFINE   p_apb21          LIKE apb_file.apb21
#DEFINE   p_apb
#
#END FUNCTION
##No.TQC-770056--end--

#No.TQC-7B0083  --Begin                                                   
FUNCTION t110_rvb06_1(p_apb04,p_apb05)
  DEFINE p_apb04            LIKE apb_file.apb04
  DEFINE p_apb05            LIKE apb_file.apb05
  DEFINE l_qty_rvv88        LIKE rvv_file.rvv23
  DEFINE l_qty_rvv23_rvv88  LIKE rvv_file.rvv23

      #暫估數量                                                                 
      LET l_qty_rvv88 = 0                                                       
      SELECT SUM(apb09) INTO l_qty_rvv88 FROM apb_file,apa_file                 
       WHERE apb04 = p_apb04 AND apb05 = p_apb05 
         AND apb01 = apa01   AND apa00 = '16'
         AND apa42 = 'N'                                                        
                                                                                
      IF l_qty_rvv88 IS NULL THEN                                               
         LET l_qty_rvv88 = 0                                                    
      END IF                                                                    
                                                                                
      #衝暫估數量                                                               
      LET l_qty_rvv23_rvv88 = 0                                                 
      SELECT SUM(apb09) INTO l_qty_rvv23_rvv88 FROM apb_file,apa_file           
       WHERE apb04 = p_apb04 AND apb05 = p_apb05
         AND apb01 = apa01   AND apa00 = '11'                                     
         AND apa42 = 'N'                                                        
         AND apb34 = 'Y'                                                        
         AND apb29 = '1'
                                                                                
      IF l_qty_rvv23_rvv88 IS NULL THEN                                         
         LET l_qty_rvv23_rvv88 = 0                                              
      END IF                                   

      RETURN l_qty_rvv88,l_qty_rvv23_rvv88
                                                                                
END FUNCTION

FUNCTION t110_rvv23_rvv88(p_apb21,p_apb22,p_apa00_1,p_apa00_2)
  DEFINE p_apb21            LIKE apb_file.apb21
  DEFINE p_apb22            LIKE apb_file.apb22
  DEFINE p_apa00_1          LIKE apa_file.apa00
  DEFINE p_apa00_2          LIKE apa_file.apa00
  DEFINE l_qty_rvv88        LIKE rvv_file.rvv23
  DEFINE l_qty_rvv23_rvv88  LIKE rvv_file.rvv23

      #暫估數量                                                                 
      LET l_qty_rvv88 = 0                                                       
      SELECT SUM(apb09) INTO l_qty_rvv88 FROM apb_file,apa_file                 
       WHERE apb21 = p_apb21 AND apb22 = p_apb22
         AND apb01 = apa01   AND apa00 = p_apa00_2
         AND apa42 = 'N'                                                        
                                                                                
      IF l_qty_rvv88 IS NULL THEN                                               
         LET l_qty_rvv88 = 0                                                    
      END IF                                                                    

      IF l_qty_rvv88 < 0 THEN
         LET l_qty_rvv88 = l_qty_rvv88 * -1
      END IF
                                                                                
      #衝暫估數量                                                               
      LET l_qty_rvv23_rvv88 = 0                                                 
      SELECT SUM(apb09) INTO l_qty_rvv23_rvv88 FROM apb_file,apa_file           
       WHERE apb21 = p_apb21 AND apb22 = p_apb22
         AND apb01 = apa01   AND apa00 = p_apa00_1
         AND apa42 = 'N'                                                        
         AND apb34 = 'Y'                                                        
                                                                                
      IF l_qty_rvv23_rvv88 IS NULL THEN                                         
         LET l_qty_rvv23_rvv88 = 0                                              
      END IF                               

      IF l_qty_rvv23_rvv88 < 0 THEN
         LET l_qty_rvv23_rvv88 = l_qty_rvv23_rvv88 * -1
      END IF
                                                                                
      RETURN l_qty_rvv88,l_qty_rvv23_rvv88
END FUNCTION

FUNCTION t110_api_unap(p_cmd)
  DEFINE p_cmd         LIKE type_file.chr1
  DEFINE l_api         RECORD LIKE api_file.*
  DEFINE l_apa01       LIKE apa_file.apa01
  DEFINE l_apa54       LIKE apa_file.apa54
  DEFINE l_apa541      LIKE apa_file.apa541
  DEFINE l_apa22       LIKE apa_file.apa22
  DEFINE l_apb08       LIKE apb_file.apb08
  DEFINE l_apb09       LIKE apb_file.apb09    #MOD-930030 add
  DEFINE l_apb23       LIKE apb_file.apb23
  DEFINE l_apb10       LIKE apb_file.apb10    #MOD-960266 add
  DEFINE l_apb24       LIKE apb_file.apb24    #MOD-960266 add
  DEFINE l_apb10_unap  LIKE apb_file.apb10    #MOD-960266 add
  DEFINE l_apb24_unap  LIKE apb_file.apb24    #MOD-960266 add
  DEFINE l_apb10_unap1 LIKE apb_file.apb10    #MOD-960266 add
  DEFINE l_apb24_unap1 LIKE apb_file.apb24    #MOD-960266 add
  DEFINE l_apa35f_u    LIKE apa_file.apa35f   #No.MOD-8A0220
  DEFINE l_apa35_u     LIKE apa_file.apa35    #No.MOD-8A0220
  DEFINE l_apa930      LIKE apa_file.apa930   #CHI-8C0005 add
  DEFINE l_apa72       LIKE apa_file.apa72    #MOD-930169 add
  DEFINE l_apa14       LIKE apa_file.apa14    #TQC-940171 add
  DEFINE l_gec07       LIKE gec_file.gec07    #MOD-B90164 add 
  DEFINE l_gec04       LIKE gec_file.gec04    #MOD-B90164 add 
  DEFINE l_rvv38t      LIKE rvv_file.rvv38t   #MOD-B90164 add 

  IF p_cmd = 'u' AND g_apb_t.apb34 = 'Y' AND g_apb[l_ac].apb34 = 'N' THEN
     LET p_cmd = 'd'
  END IF
  IF p_cmd = 'u' AND g_apb_t.apb34 = 'N' AND g_apb[l_ac].apb34 = 'Y' THEN
     LET p_cmd = 'a'
  END IF
  
  IF p_cmd = 'a' THEN
     LET l_apa01=t110_set_apb01_unap(g_apb[l_ac].apb21,g_apb[l_ac].apb22,'Y')
     IF g_aptype = '12' OR 
       (g_aptype='21' AND g_apa.apa58='3') THEN   #MOD-850316 add
        SELECT apa54,apa541,apa22,apb08,apb09,apb23,apa930,apa14  #CHI-8C0005 add apa930                 #MOD-930030 add apb09  #MOD-9B0054 add apa14
          INTO l_apa54,l_apa541,l_apa22,l_apb08,l_apb09,l_apb23,l_apa930,l_apa14 #CHI-8C0005 add apa930  #MOD-930030 add apb09  #MOD-9B0054 add apa14
          FROM apa_file,apb_file
         WHERE apa01 = apb01 AND apa01=l_apa01
           AND apb02 = g_apb[l_ac].apb22
        LET l_apb09=g_apb[l_ac].apb09   #數量       #MOD-9B0054 add
        LET l_apb23=g_apb[l_ac].apb23   #原幣單價   #MOD-9B0054 add
        LET l_apb08=g_apb[l_ac].apb08   #本幣單價   #MOD-9B0054 add
     ELSE
        SELECT apa54,apa541,apa22,apb08,apb09,apb23,apa930,apa14   #CHI-8C0005 add apa930                 #MOD-930030 add apb09  #MOD-AA0120 add apa14
          INTO l_apa54,l_apa541,l_apa22,l_apb08,l_apb09,l_apb23,l_apa930,l_apa14   #CHI-8C0005 add apa930  #MOD-930030 add apb09 #MOD-AA0120 add apa14
          FROM apa_file,apb_file
         WHERE apa01 = apb01 AND apa01=l_apa01
           AND apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
     END IF
     IF cl_null(l_apb08) THEN LET l_apb08 = 0 END IF
     IF cl_null(l_apb09) THEN LET l_apb09 = 0 END IF   #MOD-930030 add
     IF cl_null(l_apb23) THEN LET l_apb23 = 0 END IF
     IF cl_null(l_apa930) THEN LET l_apa930= ' ' END IF   #CHI-8C0005 add
     INITIALIZE l_api.* TO NULL
     LET l_api.api01 =g_apa.apa01
     LET l_api.api02 ='2'
     LET l_api.api03 =g_apb[l_ac].apb02
     LET l_api.api04 =l_apa54
     LET l_api.api041=l_apa541
     #-----MOD-820103---------  
     #LET l_api.api05f=g_apb[l_ac].apb09 * l_apb08
     #LET l_api.api05 =g_apb[l_ac].apb09 * l_apb23
     #-----No:MOD-910014-----
     IF cl_null(g_apb[l_ac].apb09) OR g_apb[l_ac].apb09 = 0 OR  #MOD-930030 mod
        l_apb09 = g_apb[l_ac].apb09 THEN   #MOD-930030 add
        LET l_api.api05f = g_apb[l_ac].apb24
       #str MOD-960328 mod
       #LET l_api.api05  = g_apb[l_ac].apb10
       #寫入api_file的api05時,應該寫入aapt160的原始本幣金額
       #IF g_aptype = '11' OR g_aptype='16' THEN       #MOD-C20104 mark
        IF g_aptype = '11' AND g_apz.apz27 = 'N' THEN  #MOD-C20104
           SELECT apb10 INTO l_api.api05 FROM apa_file,apb_file
            WHERE apa01 = apb01             AND (apa00 = '16' OR apa00 = '26')
              AND apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
        END IF
       #IF g_aptype = '12' THEN                            #CHI-A30023 mark
        IF g_aptype = '12' OR g_aptype = '21' THEN         #CHI-A30023 add  
          #str MOD-9B0054 mod
          #SELECT apb10 INTO l_api.api05 FROM apa_file,apb_file
          # WHERE apa01 = apb01             AND (apa00 = '16' OR apa00 = '26')
          #   AND apb01 = g_apb[l_ac].apb21 AND apb02 = g_apb[l_ac].apb22
           LET l_api.api05 =l_api.api05f * l_apa14
          #end MOD-9B0054 mod
        END IF
        IF cl_null(l_api.api05) THEN
           LET l_api.api05  = g_apb[l_ac].apb10
        END IF
       #end MOD-960328 mod
     ELSE
      #---------------------------------MOD-B90164-------------------------start
        LET l_gec04 = 0   LET l_gec07 = ''
        IF g_apb[l_ac].apb06 <> '' OR NOT cl_null(g_apb[l_ac].apb06) THEN  
           SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file,pmm_file
            WHERE gec01 = pmm21 AND pmm01=g_apb[l_ac].apb06
        ELSE
           SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file
            WHERE gec01 = g_apa.apa15
        END IF      
        IF cl_null(l_gec04) THEN LET l_gec04=0   END IF
        IF cl_null(l_gec07) THEN LET l_gec07='N' END IF
        LET l_rvv38t = 0
        IF l_gec07='Y' THEN        #含稅單價*數量=含稅金額
           SELECT rvv38t INTO l_rvv38t FROM rvv_file
            WHERE rvv01 = g_apb[l_ac].apb21
              AND rvv02 = g_apb[l_ac].apb22
           LET l_api.api05f = l_rvv38t*g_apb[l_ac].apb09
           LET l_api.api05f = cl_digcut(l_api.api05f,t_azi04)
           LET l_api.api05f = l_api.api05f/(1+l_gec04/100)
           LET l_api.api05 =l_api.api05f * l_apa14 
           LET l_api.api05 = cl_digcut(l_api.api05,g_azi04)
        ELSE                      
      #---------------------------------MOD-B90164---------------------------end
          LET l_api.api05f=g_apb[l_ac].apb09 * l_apb23
         #LET l_api.api05 =g_apb[l_ac].apb09 * l_apb08   #MOD-8B0149 mark
         #LET l_api.api05 =l_api.api05f * g_apa.apa14    #MOD-8B0149 #MOD-9B0054 mark
          LET l_api.api05 =l_api.api05f * l_apa14        #MOD-8B0149      #MOD-9B0054 
        END IF                                            #MOD-B90164 add
     END IF
     #-----No:MOD-910014 END-----
     #-----END MOD-820103-----
     #No.MOD-8A0220--begin--
   #str MOD-960266 mod
   # #抓取暫估單未付金額
   # LET l_apa35f_u = 0
   # LET l_apa35_u  = 0
   # SELECT apa34f-apa35f,apa34-apa35 INTO l_apa35f_u,l_apa35_u FROM apa_file 
   #  WHERE apa01 = l_apa01
   # IF SQLCA.sqlcode THEN    
   #    LET l_apa35f_u = 0
   #    LET l_apa35_u  = 0
   # END IF 
   # IF NOT cl_null(l_apa35f_u) AND l_api.api05f > l_apa35f_u THEN 
   #    LET l_api.api05f = l_apa35f_u
   # END IF 
   # IF NOT cl_null(l_apa35_u) AND l_api.api05 > l_apa35_u THEN 
   #    LET l_api.api05 = l_apa35_u
   # END IF 
     IF g_aptype = '11' OR g_aptype='16' THEN   #MOD-960328 add
        #aapt160/aapt260暫估金額
        SELECT apb10,apb24 INTO l_apb10_unap1,l_apb24_unap1
          FROM apa_file,apb_file
         WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
           AND (apa00 = '16' OR apa00 = '26') AND apa01 = apb01
        IF cl_null(l_apb10_unap1) THEN LET l_apb10_unap1 = 0 END IF     
        IF cl_null(l_apb24_unap1) THEN LET l_apb24_unap1 = 0 END IF          
       
        #aapt110/aapt120已確認沖暫估金額
       #str MOD-960328 mod
       #寫入api_file的api05時,應該寫入aapt160的原始本幣金額
       #SELECT SUM(apb10),SUM(apb24) INTO l_apb10_unap,l_apb24_unap
       #  FROM apa_file,apb_file
       # WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
       #   AND (apa00 = '11' OR apa00 = '12') AND apa01 = apb01 AND apa41 = 'Y'
        SELECT SUM(apb24) INTO l_apb24_unap
          FROM apa_file,apb_file
         WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
           AND (apa00 = '11' OR apa00 = '12') AND apa01 = apb01 AND apa41 = 'Y'
           AND apb34='Y' #MOD-9A0147        
        #抓原先暫估單的匯率
        SELECT apa14 INTO l_apa14 FROM apa_file,apb_file
         WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
           AND (apa00 = '16' OR apa00 = '26') AND apa01 = apb01
        IF cl_null(l_apa14) THEN LET l_apa14 = 1 END IF
        LET l_apb10_unap = l_apb24_unap * l_apa14
       #end MOD-960328 mod
        IF cl_null(l_apb10_unap) THEN LET l_apb10_unap = 0 END IF     
        IF cl_null(l_apb24_unap) THEN LET l_apb24_unap = 0 END IF     
     END IF   #MOD-960328 add
    #str MOD-960328 add
    #IF g_aptype = '12' THEN                              #CHI-A30023 mark  
     IF g_aptype = '12' OR g_aptype = '21' THEN           #CHI-A30023 add    
       #aapt160/aapt260暫估金額
       #----------------------MOD-D30078-------------------(S)
       #-MOD-D30078-mark-
       #SELECT apb10,apb24 INTO l_apb10_unap1,l_apb24_unap1
       #  FROM apa_file,apb_file
       # WHERE apb01 = g_apb[l_ac].apb21 AND apb02 = g_apb[l_ac].apb22 
       #   AND (apa00 = '16' OR apa00 = '26') AND apa01 = apb01
       #-MOD-D30078-mark-
        IF g_apa.apa58 = '2' THEN
           SELECT apa14,apb10,apb24 
             INTO l_apa14,l_apb10_unap1,l_apb24_unap1 
             FROM apa_file,apb_file 
            WHERE apa00 IN ('16','26') 
              AND apa01 = apb01 
              AND apb21 = g_apb[l_ac].apb21
              AND apb22 = g_apb[l_ac].apb22
        END IF
        IF g_apa.apa58 = '3' OR g_aptype = '12' THEN
           SELECT apa14,apb10,apb24 
             INTO l_apa14,l_apb10_unap1,l_apb24_unap1 
             FROM apa_file,apb_file 
            WHERE apa00 IN ('16','26') 
              AND apa01 = apb01 
              AND apb01 = g_apb[l_ac].apb21
              AND apb02 = g_apb[l_ac].apb22
        END IF
        IF cl_null(l_apa14) THEN LET l_apa14 = 1 END IF
       #----------------------MOD-D30078-------------------(E)
        IF cl_null(l_apb10_unap1) THEN LET l_apb10_unap1 = 0 END IF     
        IF cl_null(l_apb24_unap1) THEN LET l_apb24_unap1 = 0 END IF          
       
        #aapt120/aapt210已確認沖暫估金額
        SELECT SUM(apb24) INTO l_apb24_unap
          FROM apa_file,apb_file
        #WHERE apb01 = g_apb[l_ac].apb21 AND apb02 = g_apb[l_ac].apb22      #MOD-D30078 mark
        #  AND apa00 = '12' AND apa01 = apb01 AND apa41 = 'Y'               #MOD-D30078 mark
         WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22      #MOD-D30078 add
           AND apa00 IN ('12','21') AND apa01 = apb01 AND apa41 = 'Y'       #MOD-D30078 add
           AND apb34='Y'                                                    #MOD-9A0147        
       #抓原先暫估單的匯率
       #-MOD-D30078-mark-
       #SELECT apa14 INTO l_apa14 FROM apa_file,apb_file
       # WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
       #   AND (apa00 = '16' OR apa00 = '26') AND apa01 = apb01
       #IF cl_null(l_apa14) THEN LET l_apa14 = 1 END IF
       #-MOD-D30078-mark-
        LET l_apb10_unap = l_apb24_unap * l_apa14
        IF cl_null(l_apb10_unap) THEN LET l_apb10_unap = 0 END IF     
        IF cl_null(l_apb24_unap) THEN LET l_apb24_unap = 0 END IF     
     END IF
    #end MOD-960328 add
     #aapt160/aapt260的金額-aapt110/aapt120已確認的金額
     LET l_apb10 = l_apb10_unap1 - l_apb10_unap
     LET l_apb24 = l_apb24_unap1 - l_apb24_unap

     IF cl_null(l_apb10) THEN LET l_apb10 = 0 END IF     
     IF cl_null(l_apb24) THEN LET l_apb24 = 0 END IF          

     IF NOT cl_null(l_apb24) AND l_api.api05f > l_apb24 THEN 
        LET l_api.api05f = l_apb24
     END IF 
     IF NOT cl_null(l_apb10) AND l_api.api05 > l_apb10 THEN 
        LET l_api.api05 = l_apb10
     END IF 
   #end MOD-960266 mod
     #No.MOD-8A0220---end---
    #str MOD-930169 add
     SELECT azi04 INTO t_azi04 FROM azi_file WHERE azi01=g_apa.apa13
     LET l_api.api05f= cl_digcut(l_api.api05f,t_azi04)
     IF g_apz.apz27 = 'Y' AND g_aza.aza17 != g_apa.apa13 THEN
        #應抓取暫估單aapt160的重評價匯率，而非沖暫估單的重評價匯率
        SELECT apa72 INTO l_apa72 FROM apa_file WHERE apa01=l_apa01
        IF cl_null(l_apa72) THEN LET l_apa72=1 END IF
        LET l_api.api05=l_api.api05f*l_apa72
        LET l_api.api05=cl_digcut(l_api.api05,g_azi04)
     END IF
    #end MOD-930169 add
    #str TQC-940171 add
     IF g_apz.apz27 != 'Y' AND g_aza.aza17 != g_apa.apa13 THEN
        #應抓取暫估單aapt160的匯率
        SELECT apa14 INTO l_apa14 FROM apa_file WHERE apa01=l_apa01
        IF cl_null(l_apa14) THEN LET l_apa14=1 END IF
        LET l_api.api05=l_api.api05f*l_apa14
        LET l_api.api05=cl_digcut(l_api.api05,g_azi04)
     END IF
    #end TQC-940171 add
     LET l_api.api06 = 'UNAP:',l_apa01
     LET l_api.api07 =l_apa22
     LET l_api.api930=l_apa930   #CHI-8C0005 add
     LET l_api.api26 =l_apa01
     LET l_api.api40 =1
    #FUN-810045 begin
     LET l_api.api35 = g_apb[l_ac].apb36
     LET l_api.api36 = g_apb[l_ac].apb31
    #FUN-810045 end
     INSERT INTO api_file VALUES(l_api.*)
     IF STATUS OR SQLCA.SQLCODE THEN
        CALL cl_err3("ins","api_file",l_api.api01,l_api.api02,SQLCA.sqlcode,"","ins api",1)
        LET g_success='N'
     END IF
  END IF

  IF p_cmd = 'd' THEN
     DELETE FROM api_file
      WHERE api01=g_apa.apa01 AND api02='2' AND api03=g_apb_t.apb02
     IF STATUS OR SQLCA.SQLCODE THEN
        CALL cl_err3("del","api_file",g_apa.apa01,g_apb_t.apb02,SQLCA.sqlcode,"","del api",1)
        LET g_success='N'
     END IF
  END IF
  
  IF p_cmd = 'u' THEN
     SELECT * INTO l_api.* FROM api_file
      WHERE api01=g_apa.apa01 AND api02='2' AND api03=g_apb_t.apb02
   #MOD-9B0054---modify---
    #沖暫估可以修改金額而非只能修改單身項次
    #IF g_apb[l_ac].apb21 = g_apb_t.apb21 AND
    #   g_apb[l_ac].apb22 = g_apb_t.apb22 AND
    #   g_apb[l_ac].apb09 = g_apb_t.apb09 THEN   #僅是項次值變化
        LET l_api.api03 = g_apb[l_ac].apb02
    #ELSE
     LET l_apa01=t110_set_apb01_unap(g_apb[l_ac].apb21,g_apb[l_ac].apb22,'Y')
     IF g_aptype = '12' OR 
       (g_aptype='21' AND g_apa.apa58='3') THEN  
        SELECT apa54,apa541,apa22,apb08,apb09,apb23,apa930,apa14
          INTO l_apa54,l_apa541,l_apa22,l_apb08,l_apb09,l_apb23,l_apa930,l_apa14
          FROM apa_file,apb_file
         WHERE apa01 = apb01 AND apa01 = l_apa01
           AND apb01 = g_apb[l_ac].apb21           #MOD-D30078 add
           AND apb02 = g_apb[l_ac].apb22
        LET l_apb09=g_apb[l_ac].apb09   #數量
        LET l_apb23=g_apb[l_ac].apb23   #原幣單價
        LET l_apb08=g_apb[l_ac].apb08   #本幣單價
     ELSE
   #MOD-9B0054---modify---
        SELECT apa54,apa541,apa22,apb08,apb23,apa14
          INTO l_apa54,l_apa541,l_apa22,l_apb08,l_apb23,l_apa14
          FROM apa_file,apb_file
         WHERE apa01 = apb01 AND apa01=l_apa01
           AND apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
     END IF                                     #MOD-9B0054
        IF cl_null(l_apb08) THEN LET l_apb08 = 0 END IF
        IF cl_null(l_apb23) THEN LET l_apb23 = 0 END IF

        INITIALIZE l_api.* TO NULL
        LET l_api.api01 =g_apa.apa01
        LET l_api.api02 ='2'
        LET l_api.api03 =g_apb[l_ac].apb02
        LET l_api.api04 =l_apa54
        LET l_api.api041=l_apa541
        #-----MOD-820103---------  
        #LET l_api.api05f=g_apb[l_ac].apb09 * l_apb08
        #LET l_api.api05 =g_apb[l_ac].apb09 * l_apb23
        #-----No:MOD-910014-----
        IF cl_null(g_apb[l_ac].apb09) OR g_apb[l_ac].apb09 = 0 THEN
           LET l_api.api05f = g_apb[l_ac].apb24
          #str MOD-960328 mod
          #LET l_api.api05  = g_apb[l_ac].apb10
          #寫入api_file的api05時,應該寫入aapt160的原始本幣金額
           IF g_aptype = '11' OR g_aptype='16' THEN
              SELECT apb10 INTO l_api.api05 FROM apa_file,apb_file
               WHERE apa01 = apb01             AND (apa00 = '16' OR apa00 = '26')
                 AND apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
           END IF
           IF g_aptype = '12' THEN
              SELECT apb10 INTO l_api.api05 FROM apa_file,apb_file
               WHERE apa01 = apb01             AND (apa00 = '16' OR apa00 = '26')
                 AND apb01 = g_apb[l_ac].apb21 AND apb02 = g_apb[l_ac].apb22
           END IF
           IF cl_null(l_api.api05) THEN
              LET l_api.api05  = g_apb[l_ac].apb10
           END IF
          #end MOD-960328 mod
        ELSE
           LET l_api.api05f=g_apb[l_ac].apb09 * l_apb23
          #LET l_api.api05 =g_apb[l_ac].apb09 * l_apb08  #MOD-8B0149 mark
          #LET l_api.api05 =l_api.api05f * g_apa.apa14   #MOD-8B0149  #MOD-9B0054 mark
           LET l_api.api05 =l_api.api05f * l_apa14       #MOD-8B0149  #MOD-9B0054
        END IF
        #-----No:MOD-910014 END-----
        #-----END MOD-820103-----
        #No.MOD-8A0220--begin--
      #str MOD-960266 mod
      # #抓取暫估單未付金額
      # LET l_apa35f_u = 0
      # LET l_apa35_u  = 0
      # SELECT apa34f-apa35f,apa34-apa35 INTO l_apa35f_u,l_apa35_u FROM apa_file 
      #  WHERE apa01 = l_apa01
      # IF SQLCA.sqlcode THEN    
      #    LET l_apa35f_u = 0
      #    LET l_apa35_u  = 0
      # END IF 
      # IF NOT cl_null(l_apa35f_u) AND l_api.api05f > l_apa35f_u THEN 
      #    LET l_api.api05f = l_apa35f_u
      # END IF 
      # IF NOT cl_null(l_apa35_u) AND l_api.api05 > l_apa35_u THEN 
      #    LET l_api.api05 = l_apa35_u
      # END IF 
        IF g_aptype = '11' OR g_aptype='16' THEN   #MOD-960328 add
           #aapt160/aapt260暫估金額
           SELECT apb10,apb24 INTO l_apb10_unap1,l_apb24_unap1
             FROM apa_file,apb_file
            WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
              AND (apa00 = '16' OR apa00 = '26') AND apa01 = apb01
           IF cl_null(l_apb10_unap1) THEN LET l_apb10_unap1 = 0 END IF     
           IF cl_null(l_apb24_unap1) THEN LET l_apb24_unap1 = 0 END IF          
          
           #aapt110/aapt120已確認沖暫估金額
          #str MOD-960328 mod
          #寫入api_file的api05時,應該寫入aapt160的原始本幣金額
          #SELECT SUM(apb10),SUM(apb24) INTO l_apb10_unap,l_apb24_unap
          #  FROM apa_file,apb_file
          # WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
          #   AND (apa00 = '11' OR apa00 = '12') AND apa01 = apb01 AND apa41 = 'Y'
           SELECT SUM(apb24) INTO l_apb24_unap
             FROM apa_file,apb_file
            WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
              AND (apa00 = '11' OR apa00 = '12') AND apa01 = apb01 AND apa41 = 'Y'
              AND apb34='Y' #MOD-9A0147        
           #抓原先暫估單的匯率
           SELECT apa14 INTO l_apa14 FROM apa_file,apb_file
            WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
              AND (apa00 = '16' OR apa00 = '26') AND apa01 = apb01
           IF cl_null(l_apa14) THEN LET l_apa14 = 1 END IF
           LET l_apb10_unap = l_apb24_unap * l_apa14
          #end MOD-960328 mod
           IF cl_null(l_apb10_unap) THEN LET l_apb10_unap = 0 END IF     
           IF cl_null(l_apb24_unap) THEN LET l_apb24_unap = 0 END IF     
        END IF   #MOD-960328 add
       #str MOD-960328 add
       #--------------------------MOD-D30078-------------------(S)
       #--MOD-D30078--mark
       #IF g_aptype = '12' THEN
       #  #aapt160/aapt260暫估金額
       #   SELECT apb10,apb24 INTO l_apb10_unap1,l_apb24_unap1
       #     FROM apa_file,apb_file
       #    WHERE apb01 = g_apb[l_ac].apb21 AND apb02 = g_apb[l_ac].apb22
       #      AND (apa00 = '16' OR apa00 = '26') AND apa01 = apb01
       #--MOD-D30078--mark
        IF g_aptype = '12' OR g_aptype = '21' THEN
          #aapt160/aapt260暫估金額
           IF g_apa.apa58 = '2' THEN
              SELECT apa14,apb10,apb24 
                INTO l_apa14,l_apb10_unap1,l_apb24_unap1
                FROM apa_file,apb_file 
               WHERE apa00 IN ('16','26') 
                 AND apa01 = apb01 
                 AND apb21 = g_apb[l_ac].apb21
                 AND apb22 = g_apb[l_ac].apb22
           END IF
           IF g_apa.apa58 = '3' OR g_aptype = '12' THEN
              SELECT apa14,apb10,apb24 
                INTO l_apa14,l_apb10_unap1,l_apb24_unap1
                FROM apa_file,apb_file 
               WHERE apa00 IN ('16','26') 
                 AND apa01 = apb01 
                 AND apb01 = g_apb[l_ac].apb21
                 AND apb02 = g_apb[l_ac].apb22
           END IF
           IF cl_null(l_apa14) THEN LET l_apa14 = 1 END IF
       #--------------------------MOD-D30078-------------------(E)
           IF cl_null(l_apb10_unap1) THEN LET l_apb10_unap1 = 0 END IF     
           IF cl_null(l_apb24_unap1) THEN LET l_apb24_unap1 = 0 END IF          
          
           #aapt110/aapt120已確認沖暫估金額
           SELECT SUM(apb24) INTO l_apb24_unap
             FROM apa_file,apb_file
           #WHERE apb01 = g_apb[l_ac].apb21 AND apb02 = g_apb[l_ac].apb22 #MOD-D30078 mark
            WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22 #MOD-D30078 add
              AND apa00 = '12' AND apa01 = apb01 AND apa41 = 'Y'
              AND apb34='Y' #MOD-9A0147        
           #抓原先暫估單的匯率
          #--MOD-D30078--mark
          #SELECT apa14 INTO l_apa14 FROM apa_file,apb_file
          # WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
          #   AND (apa00 = '16' OR apa00 = '26') AND apa01 = apb01
          #IF cl_null(l_apa14) THEN LET l_apa14 = 1 END IF
          #--MOD-D30078--mark
           LET l_apb10_unap = l_apb24_unap * l_apa14
           IF cl_null(l_apb10_unap) THEN LET l_apb10_unap = 0 END IF     
           IF cl_null(l_apb24_unap) THEN LET l_apb24_unap = 0 END IF     
        END IF
       #end MOD-960328 add
        #aapt160/aapt260的金額-aapt110/aapt120已確認的金額
        LET l_apb10 = l_apb10_unap1 - l_apb10_unap
        LET l_apb24 = l_apb24_unap1 - l_apb24_unap

        IF cl_null(l_apb10) THEN LET l_apb10 = 0 END IF     
        IF cl_null(l_apb24) THEN LET l_apb24 = 0 END IF          

        IF NOT cl_null(l_apb24) AND l_api.api05f > l_apb24 THEN 
           LET l_api.api05f = l_apb24
        END IF 
        IF NOT cl_null(l_apb10) AND l_api.api05 > l_apb10 THEN 
           LET l_api.api05 = l_apb10
        END IF 
      #end MOD-960266 mod
        #No.MOD-8A0220---end---
        LET l_api.api06 = 'UNAP:',l_apa01
        LET l_api.api07 =l_apa22
        LET l_api.api26 =l_apa01
        LET l_api.api40 =1
    #END IF              #MOD-9B0054 mark
     UPDATE api_file SET api_file.* = l_api.*
      WHERE api01 = g_apa.apa01
        AND api02 = '2'
        AND api03 = g_apb_t.apb02
     IF STATUS OR SQLCA.SQLCODE THEN
        CALL cl_err3("upd","api_file",l_api.api01,l_api.api02,SQLCA.sqlcode,"","upd api",1)
        LET g_success='N'
     END IF
  END IF
#No.MOD-AC0034 --begin
  CALL t110_api_upd()
#No.MOD-AC0034 --end
END FUNCTION

FUNCTION t110_api_diff()
  DEFINE l_apa60     LIKE apa_file.apa60
  DEFINE l_apa60f    LIKE apa_file.apa60f
  DEFINE l_apa31     LIKE apa_file.apa31
  DEFINE l_apa31f    LIKE apa_file.apa31f
  DEFINE l_apa33     LIKE apa_file.apa33
  DEFINE l_apa33f    LIKE apa_file.apa33f
  DEFINE l_apb10     LIKE apb_file.apb10
  DEFINE l_apb24     LIKE apb_file.apb24
  DEFINE l_amt       LIKE apa_file.apa31
  DEFINE l_amtf      LIKE apa_file.apa31f
  DEFINE l_api05     LIKE api_file.api05
  DEFINE l_api05f    LIKE api_file.api05f
  DEFINE l_api       RECORD LIKE api_file.*
  DEFINE l_cnt       LIKE type_file.num5

   IF g_apa.apa56 != '5' THEN   #CHI-930001 add
      #check 若單身沒有apb34='Y'的資料,則要delete完api02='2'的單據
      LET l_cnt = 0
      SELECT COUNT(*) INTO l_cnt FROM apb_file
       WHERE apb01 = g_apa.apa01
         AND apb34 = 'Y'
      #IF l_cnt = 0 AND g_apa.apa51 <> 'UNAP' THEN   #MOD-810242
     #IF l_cnt = 0 AND (g_apa.apa51 <> 'UNAP' OR cl_null(g_apa.apa51)) THEN   #MOD-810242  #MOD-920381 mark
      IF l_cnt = 0 THEN   #MOD-810242                                                      #MOD-920381
         DELETE FROM api_file WHERE api01=g_apa.apa01 AND api02='2'
         RETURN
      END IF
   END IF   #CHI-930001 add

   LET l_apa60  = 0 LET l_apa60f = 0 
   SELECT apa60f,apa60,apa31,apa31f,apa33,apa33f
     INTO l_apa60f,l_apa60,l_apa31,l_apa31f,l_apa33,l_apa33f
     FROM apa_file WHERE apa01 = g_apa.apa01
   IF cl_null(l_apa60f) THEN LET l_apa60f = 0 END IF
   IF cl_null(l_apa60)  THEN LET l_apa60 = 0 END IF
   LET l_apb10 = 0 LET l_apb24 = 0
   SELECT SUM(apb10),SUM(apb24) INTO l_apb10,l_apb24 FROM apb_file
    WHERE apb01=g_apa.apa01
      AND apb34='N'
   IF cl_null(l_apb10) THEN LET l_apb10=0 END IF
   IF cl_null(l_apb24) THEN LET l_apb24=0 END IF
  #str MOD-850081 mod
  #計算沖暫估單頭的金額時,不需扣掉差異金額
  #LET l_amt  = l_apa31 - l_apa60 - l_apb10 - l_apa33
  #LET l_amtf = l_apa31f- l_apa60f- l_apb24 - l_apa33f
   LET l_apa31 = g_apa.apa31                #MOD-C20206
   LET l_amt  = l_apa31 - l_apb10 - l_apa33
   LET l_amtf = l_apa31f- l_apb24 - l_apa33f
  #end MOD-850081 mod
   SELECT SUM(api05f),SUM(api05) INTO l_api05f,l_api05
     FROM api_file
    WHERE api01 = g_apa.apa01 AND api02 = '2'
   IF cl_null(l_api05)  THEN LET l_api05  = 0 END IF
   IF cl_null(l_api05f) THEN LET l_api05f = 0 END IF
   LET l_api05 = cl_digcut(l_api05 ,g_azi04)            #No.TQC-810091
   LET l_api05f= cl_digcut(l_api05f,t_azi04)            #No.TQC-810091
   IF l_api05 = l_amt AND l_api05f = l_amtf THEN
      RETURN
   ELSE
      DELETE FROM api_file
       WHERE api01=g_apa.apa01 AND api02='2' AND api26 = 'DIFF'
      SELECT SUM(api05f),SUM(api05) INTO l_api05f,l_api05
        FROM api_file
       WHERE api01 = g_apa.apa01 AND api02 = '2'
      IF cl_null(l_api05)  THEN LET l_api05  = 0 END IF
      IF cl_null(l_api05f) THEN LET l_api05f = 0 END IF
      LET l_api05 = cl_digcut(l_api05 ,g_azi04)            #No.TQC-810091
      LET l_api05f= cl_digcut(l_api05f,t_azi04)            #No.TQC-810091
      INITIALIZE l_api.* TO NULL
      SELECT MAX(api03)+1 INTO l_api.api03 FROM api_file
       WHERE api01=g_apa.apa01 AND api02='2'
      IF g_apz.apz13 = 'Y' THEN
         SELECT * INTO g_aps.* FROM aps_file WHERE aps01 = g_apa.apa22
      ELSE
         SELECT * INTO g_aps.* FROM aps_file WHERE (aps01 = ' ' OR aps01 IS NULL)
      END IF
      LET l_api.api01 =g_apa.apa01
      LET l_api.api02 ='2'
     #LET l_api.api04 =g_aps.aps44        #MOD-B40087 mark
     #LET l_api.api041=g_aps.aps441       #MOD-B40087 mark
      LET l_api.api05f=l_amtf - l_api05f
      LET l_api.api05 =l_amt - l_api05
     #-MOD-B40087-add-
      IF l_api.api05 > 0 THEN
         LET l_api.api04  = g_aps.aps43 
         LET l_api.api041 = g_aps.aps431
      END IF
      IF l_api.api05 < 0 THEN
         LET l_api.api04  = g_aps.aps42 
         LET l_api.api041 = g_aps.aps421
      END IF
     #-MOD-B40087-end-
      LET l_api.api06 = 'UNAP:DIFF'
      LET l_api.api07 =g_apa.apa22
      LET l_api.api930=g_apa.apa930   #CHI-8C0005 add
      LET l_api.api26 ='DIFF'
      LET l_api.api40 =NULL
      IF l_api.api05f = 0 AND l_api.api05 = 0 THEN
         RETURN
      END IF
      LET l_api05 = cl_digcut(l_api05 ,g_azi04)            #No.TQC-810091
      LET l_api05f= cl_digcut(l_api05f,t_azi04)            #No.TQC-810091
    #FUN-810045 begin
      LET l_api.api35 = ' '
      LET l_api.api36 = ' '
    #FUN-810045 end
      INSERT INTO api_file VALUES(l_api.*)
      IF STATUS OR SQLCA.SQLCODE THEN
         CALL cl_err3("ins","api_file",l_api.api01,l_api.api02,SQLCA.sqlcode,"","ins api",1)
         LET g_success='N'
      END IF
   END IF
      
END FUNCTION
#No.TQC-7B0083  --End 

#No.TQC-7C0094--begin-- 
FUNCTION t110_apa65f(p_apa37f,p_apa37)
DEFINE   p_apa37f         LIKE apa_file.apa37f
DEFINE   p_apa37          LIKE apa_file.apa37

    UPDATE apa_file SET apa65f = p_apa37f,apa65 = p_apa37
     WHERE apa01 = g_apa.apa01   
    LET g_apa.apa65f = p_apa37f
    LET g_apa.apa65  = p_apa37
    DISPLAY BY NAME g_apa.apa65f,g_apa.apa65

END FUNCTION
FUNCTION t110_apx03_unpay(p_apx03)
DEFINE   p_apx03         LIKE apx_file.apx03
DEFINE   l_apx04f        LIKE apx_file.apx04f
DEFINE   l_apx04         LIKE apx_file.apx04
DEFINE   l_apa73f        LIKE apa_file.apa73
DEFINE   l_apa73         LIKE apa_file.apa73

         SELECT SUM(apx04f),SUM(apx04) INTO l_apx04f,l_apx04 FROM apx_file,apa_file
          WHERE apa01 = apx01
            AND apx01 <> g_apa.apa01
            AND apx03 = p_apx03
            AND apa63 = '0'
         IF cl_null(l_apx04f) THEN LET l_apx04f = 0 END IF
         IF cl_null(l_apx04)  THEN LET l_apx04  = 0 END IF
         SELECT apa34f-apa35f,apa34-apa35 INTO l_apa73f,l_apa73
           FROM apa_file
          WHERE apa01 = p_apx03 
         IF cl_null(l_apa73f) THEN LET l_apa73f = 0 END IF
         IF cl_null(l_apa73)  THEN LET l_apa73  = 0 END IF
         LET l_apa73f = l_apa73f - l_apx04f 
         LET l_apa73  = l_apa73  - l_apx04  
         IF l_apa73f < 0 THEN LET l_apa73f = 0 END IF
         IF l_apa73  < 0 THEN LET l_apa73  = 0 END IF

         RETURN l_apa73f,l_apa73
END FUNCTION
#No.TQC-7C0094---end---

#FUN-810045 begin
FUNCTION t110_proj()
  DEFINE l_apb25   LIKE apb_file.apb25    #MOD-920170 add
  DEFINE l_apb251  LIKE apb_file.apb251   #MOD-920170 add

  IF cl_null(g_apb[l_ac].apb06) OR cl_null(g_apb[l_ac].apb07) THEN
     RETURN
  END IF

  #No.FUN-830161  --Begin
  #SELECT pmn122,pmn96,pmn98,pmn66,pmn40,pmn401 
  SELECT pmn122,pmn96,pmn98,pmn40,pmn401 
    INTO g_apb[l_ac].apb35,
         g_apb[l_ac].apb36,
         g_apb[l_ac].apb31,
  #      g_apb[l_ac].apb30,
         l_apb25,     #MOD-920170 mod  #g_apb[l_ac].apb25,
         l_apb251     #MOD-920170 mod  #g_apb[l_ac].apb251
  #No.FUN-830161  --End  
    FROM pmn_file
   WHERE pmn01 = g_apb[l_ac].apb06
     AND pmn02 = g_apb[l_ac].apb07
  IF SQLCA.sqlcode THEN
     LET g_apb[l_ac].apb35 = ' '
     LET g_apb[l_ac].apb36 = ' '
     LET g_apb[l_ac].apb31 = ' '
  END IF
  IF NOT cl_null(g_apb[l_ac].apb31) AND g_apb[l_ac].apb31 <> ' ' THEN
     IF cl_null(g_apb[l_ac].apb25) THEN
        SELECT azf14 INTO g_apb[l_ac].apb25
          FROM azf_file
        WHERE azf01=g_apb[l_ac].apb31 AND azf02='2' AND azfacti='Y'
     END IF
     IF g_aza.aza63='Y' AND cl_null(g_apb[l_ac].apb251) THEN
       LET g_apb[l_ac].apb251 = g_apb[l_ac].apb25
     END IF
     DISPLAY BY NAME g_apb[l_ac].apb25,g_apb[l_ac].apb251
  END IF
 #str MOD-920170 add
  IF cl_null(g_apb[l_ac].apb25) THEN
     LET g_apb[l_ac].apb25 = l_apb25
     DISPLAY BY NAME g_apb[l_ac].apb25
  END IF
  IF cl_null(g_apb[l_ac].apb251) THEN
     LET g_apb[l_ac].apb251 = l_apb251
     DISPLAY BY NAME g_apb[l_ac].apb251
  END IF
 #end MOD-920170 add
  IF NOT cl_null(g_apb[l_ac].apb25) THEN
     SELECT aag02 INTO g_apb[l_ac].b25 FROM aag_file 
     #WHERE aag01=g_apb[l_ac].apb25 AND aag00=g_bookno1                       #No.MOD-B70280 mark
      WHERE aag01=g_apb[l_ac].apb25 AND aag00=g_bookno1 AND aagacti = 'Y'     #No.MOD-B70280 add
     IF SQLCA.sqlcode THEN
        LET g_apb[l_ac].b25 = NULL 
     END IF
     DISPLAY BY NAME g_apb[l_ac].b25
  END IF
  IF NOT cl_null(g_apb[l_ac].apb251) THEN
     SELECT aag02 INTO g_apb[l_ac].b251 FROM aag_file 
     #WHERE aag01=g_apb[l_ac].apb251 AND aag00=g_bookno2                       #No.MOD-B70280 mark
      WHERE aag01=g_apb[l_ac].apb251 AND aag00=g_bookno2 AND aagacti = 'Y'     #No.MOD-B70280 add
     IF SQLCA.sqlcode THEN
        LET g_apb[l_ac].b251 = NULL 
     END IF
     DISPLAY BY NAME g_apb[l_ac].b251
  END IF

  DISPLAY BY NAME g_apb[l_ac].apb35,g_apb[l_ac].apb36,g_apb[l_ac].apb31
END FUNCTION

#-----FUN-830091---------
FUNCTION t110_sheet(l_cmd)
   DEFINE l_cmd LIKE type_file.chr1
   IF l_cmd = '0' THEN
      IF NOT cl_null(g_apa.apa99) AND cl_null(g_apa.apa44) THEN  
         CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02b,1,'N','0',g_apz.apz02p)    
      ELSE
         CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02b,1,g_apa.apa41,'0',g_apz.apz02p)    #No.FUN-680029
      END IF
   ELSE
      IF NOT cl_null(g_apa.apa99) AND cl_null(g_apa.apa44) THEN  
         CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02c,1,'N','1',g_apz.apz02p) 
      ELSE
         CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02c,1,g_apa.apa41,'1',g_apz.apz02p) 
      END IF
   END IF
END FUNCTION
#-----END FUN-830091-----
#FUN-810045 end
#MOD-810269

#No.FUN-830161  --Begin
FUNCTION t110_bud(p_cmd,p_flag)
  DEFINE p_cmd       LIKE type_file.chr1
  DEFINE p_flag      LIKE type_file.chr1
  DEFINE p_sum1      LIKE afc_file.afc06 
  DEFINE p_sum2      LIKE afc_file.afc06 
  DEFINE l_flag      LIKE type_file.num5
  DEFINE l_msg       LIKE ze_file.ze03
  DEFINE l_over      LIKE afc_file.afc07
  DEFINE l_afb07     LIKE afb_file.afb07
  DEFINE l_cmd       LIKE type_file.chr1
  DEFINE bamt1       LIKE afc_file.afc07
  DEFINE bamt2       LIKE afc_file.afc07
  DEFINE bamt3       LIKE afc_file.afc07
  DEFINE bamt4       LIKE afc_file.afc07
  DEFINE bamt5       LIKE afc_file.afc07
  DEFINE bamt6       LIKE afc_file.afc07
  DEFINE l_cnt       LIKE type_file.num5
  DEFINE l_year      LIKE type_file.num5  #MOD-A30113 add
  DEFINE l_month     LIKE type_file.num5  #MOD-A30113 add
  DEFINE l_aag21     LIKE aag_file.aag21  #MOD-AB0132  

  LET g_errno = ''
  #IF g_smy.smy59 <> 'Y' THEN RETURN END IF
 #IF cl_null(g_smy.smy59) or g_smy.smy59 = 'N' THEN RETURN END IF #MOD-8C0272  #No.MOD-910021 mark
 #IF cl_null(g_apy.apydmy5) or g_apy.apydmy5 = 'N' THEN RETURN END IF #MOD-8C0272  #No.MOD-910021 mark #CHI-AA0028 mark

  IF g_aza.aza08 = 'N' THEN
     LET g_apb[l_ac].apb36 = ' '
     LET g_apb[l_ac].apb35 = ' '
  END IF
  IF cl_null(g_apb[l_ac].apb26) THEN LET g_apb[l_ac].apb26=' ' END IF   #MOD-B40117 add
  IF g_bookno1 IS NULL OR g_apb[l_ac].apb31 IS NULL OR
     g_apb[l_ac].apb25 IS NULL OR YEAR(g_apa.apa02) IS NULL OR 
     g_apb[l_ac].apb36 IS NULL OR g_apb[l_ac].apb26 IS NULL OR 
     g_apb[l_ac].apb35 IS NULL OR MONTH(g_apa.apa02) IS NULL THEN
     RETURN
  END IF

  #-----MOD-950284---------
  IF g_aaz.aaz90 = 'Y' THEN
     IF g_apb[l_ac].apb930 IS NULL THEN 
        RETURN
     END IF
  END IF
  IF g_aza.aza63 = 'Y' THEN
     IF g_bookno2 IS NULL OR g_apb[l_ac].apb251 THEN
        RETURN
     END IF
  END IF
  #-----END MOD-950284-----

 #-MOD-B10016-add-
  IF cl_null(g_apb[l_ac].apb25) THEN
     RETURN
  END IF
 #-MOD-B10016-end-

 #-MOD-AB0132-add-
  SELECT aag21 INTO l_aag21 FROM aag_file
   WHERE aag01 = g_apb[l_ac].apb25 
     AND aag00 = g_bookno1    
     AND aagacti = 'Y'     #No.MOD-B70280 add
  IF l_aag21 = 'N' THEN       
     RETURN
  END IF
  IF g_aza.aza63 = 'Y' THEN
    #-MOD-B10016-add-
     IF cl_null(g_apb[l_ac].apb251) THEN
        RETURN
     END IF
    #-MOD-B10016-end-
     SELECT aag21 INTO l_aag21 FROM aag_file
      WHERE aag01 = g_apb[l_ac].apb251 
        AND aag00 = g_bookno2     
        AND aagacti = 'Y'     #No.MOD-B70280 add
     IF l_aag21 = 'N' THEN        
        RETURN
     END IF
  END IF
 #-MOD-AB0132-end-

  #新的預算
  IF g_apb[l_ac].apb31 <> g_apb_t.apb31  OR
     g_apb[l_ac].apb25 <> g_apb_t.apb25  OR
     g_apb[l_ac].apb36 <> g_apb_t.apb36  OR
     g_apb[l_ac].apb26 <> g_apb_t.apb26  OR
     g_apb[l_ac].apb35 <> g_apb_t.apb35  THEN
     LET l_cmd = 'a' 
  END IF

  #-----MOD-950284---------
  IF g_aaz.aaz90 = 'Y' THEN
     IF g_apb[l_ac].apb930 <> g_apb_t.apb930 THEN
        LET l_cmd = 'a'
     END IF
  END IF
  IF g_aza.aza63 = 'Y' THEN
     IF g_apb[l_ac].apb251 <> g_apb_t.apb251 THEN
        LET l_cmd = 'a'
     END IF
  END IF
  #-----END MOD-950284-----
  #和apmt540類似,因為KEYIN時,可能與'耗用3:PO已確認且PO未結案且未轉應付的金額'
  #           和'耗用4:PO已立帳(立AP),但未拋傳票(未到總帳)的金額' 有重疊
  #           故根據不同的情況,要把這些數量減掉
  IF cl_null(g_apb[l_ac].apb06) AND cl_null(g_apb[l_ac].apb07) THEN
     IF p_cmd = 'a' OR l_cmd = 'a' THEN
        LET p_sum1 = 0
        LET p_sum2 = g_apb[l_ac].apb10
     ELSE
        LET p_sum1 = 0
        LET p_sum2 = g_apb[l_ac].apb10 - g_apb_t.apb10
     END IF
  ELSE
     IF p_cmd = 'a' OR l_cmd = 'a' THEN
#No.FUN-850027--begin
        LET l_year = NULL     #MOD-A30113 add 
        LET l_month = NULL    #MOD-A30113 add 
        IF g_aaz.aaz90 = 'Y' THEN
          #MOD-A30113---modify---start---
          #CALL s_budamt1(g_bookno1,g_apb[l_ac].apb31,g_apb[l_ac].apb25,
          #               YEAR(g_apa.apa02),g_apb[l_ac].apb36,
          #               g_apb[l_ac].apb930,g_apb[l_ac].apb35,
          #               MONTH(g_apa.apa02),'0')
          #     RETURNING bamt1,bamt2,bamt3,bamt4,bamt5,bamt6
           CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
           CALL s_budamt1(g_bookno1,g_apb[l_ac].apb31,g_apb[l_ac].apb25,
                          l_year,g_apb[l_ac].apb36,
                          g_apb[l_ac].apb930,g_apb[l_ac].apb35,
                          l_month,'0')
                RETURNING bamt1,bamt2,bamt3,bamt4,bamt5,bamt6
          #MOD-A30113---modify---end---
        ELSE
          #MOD-A30113---modify---start---
          #CALL s_budamt1(g_bookno1,g_apb[l_ac].apb31,g_apb[l_ac].apb25,
          #               YEAR(g_apa.apa02),g_apb[l_ac].apb36,
          #               g_apb[l_ac].apb26,g_apb[l_ac].apb35,
          #               MONTH(g_apa.apa02),'0')
          #     RETURNING bamt1,bamt2,bamt3,bamt4,bamt5,bamt6
           CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
           CALL s_budamt1(g_bookno1,g_apb[l_ac].apb31,g_apb[l_ac].apb25,
                          l_year,g_apb[l_ac].apb36,
                          g_apb[l_ac].apb26,g_apb[l_ac].apb35,
                          l_month,'0')
                RETURNING bamt1,bamt2,bamt3,bamt4,bamt5,bamt6
          #MOD-A30113---modify---end---
        END IF
#No.FUN-850027--end
        IF cl_null(bamt3) THEN LET bamt3 = 0 END IF
        IF cl_null(bamt4) THEN LET bamt4 = 0 END IF
        #要確認目前是和耗用3還是耗用4重疊
        LET l_cnt = 0
        SELECT COUNT(*) INTO l_cnt FROM pmn_file,pmm_file,pmk_file,pml_file
         WHERE pmn01 = pmm01 
           AND pmn24 = pml01
           AND pmn25 = pml02
           AND pmk01 = pml01
           AND pmn01 = g_apb[l_ac].apb06
           AND pmn02 = g_apb[l_ac].apb07
        IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
        IF l_cnt > 0 THEN  #耗用3
           LET p_sum1 = 0
           LET p_sum2 = g_apb[l_ac].apb10 - bamt3
        ELSE
           LET p_sum1 = 0
           LET p_sum2 = g_apb[l_ac].apb10 - bamt4
        END IF
     ELSE
        LET p_sum1 = 0
        LET p_sum2 = g_apb[l_ac].apb10 - g_apb_t.apb10
     END IF
  END IF
  IF cl_null(p_sum1) THEN LET p_sum1 = 0 END IF
  IF cl_null(p_sum2) THEN LET p_sum2 = 0 END IF

  IF p_flag = '1' OR p_flag = '3' THEN
#No.FUN-850027--begin
     LET l_year = NULL     #MOD-A30113 add 
     LET l_month = NULL    #MOD-A30113 add 
     IF g_aaz.aaz90 = 'Y' THEN
       #MOD-A30113---modify---start---
       #CALL s_budchk1(g_bookno1,g_apb[l_ac].apb31,g_apb[l_ac].apb25,
       #               YEAR(g_apa.apa02),g_apb[l_ac].apb36,
       #               g_apb[l_ac].apb930,g_apb[l_ac].apb35,
       #               MONTH(g_apa.apa02),'0',p_cmd,p_sum1,p_sum2)
       #     RETURNING l_flag,l_afb07,l_over
        CALL s_yp(g_apa.apa02) RETURNING l_year,l_month    
        CALL s_budchk1(g_bookno1,g_apb[l_ac].apb31,g_apb[l_ac].apb25,
                       l_year,g_apb[l_ac].apb36,
                       g_apb[l_ac].apb930,g_apb[l_ac].apb35,
                       l_month,'0',p_cmd,p_sum1,p_sum2)
             RETURNING l_flag,l_afb07,l_over
       #MOD-A30113---modify---end---
        IF l_flag = FALSE THEN
           LET l_msg = g_bookno1,'/',g_apb[l_ac].apb31,'/',g_apb[l_ac].apb25,'/',
                       YEAR(g_apa.apa02),'/',g_apb[l_ac].apb36,'/',
                       g_apb[l_ac].apb930,'/',g_apb[l_ac].apb35,'/',
                       MONTH(g_apa.apa02),'/',l_over
           CALL cl_err(l_msg,g_errno,1)
           RETURN
        ELSE
           IF l_afb07 = '2' AND l_over < 0 THEN
              LET l_msg = g_bookno1,'/',g_apb[l_ac].apb31,'/',g_apb[l_ac].apb25,'/',
                          YEAR(g_apa.apa02),'/',g_apb[l_ac].apb36,'/',
                          g_apb[l_ac].apb930,'/',g_apb[l_ac].apb35,'/',
                          MONTH(g_apa.apa02),'/',l_over
              CALL cl_err(l_msg,g_errno,1)
              LET g_errno = ' '
              RETURN
           END IF
        END IF
     ELSE
#No.FUN-850027--end
       #MOD-A30113---modify---start---
       #CALL s_budchk1(g_bookno1,g_apb[l_ac].apb31,g_apb[l_ac].apb25,
       #               YEAR(g_apa.apa02),g_apb[l_ac].apb36,
       #               g_apb[l_ac].apb26,g_apb[l_ac].apb35,
       #               MONTH(g_apa.apa02),'0',p_cmd,p_sum1,p_sum2)
       #     RETURNING l_flag,l_afb07,l_over
        CALL s_yp(g_apa.apa02) RETURNING l_year,l_month    
        CALL s_budchk1(g_bookno1,g_apb[l_ac].apb31,g_apb[l_ac].apb25,
                       l_year,g_apb[l_ac].apb36,
                       g_apb[l_ac].apb26,g_apb[l_ac].apb35,
                       l_month,'0',p_cmd,p_sum1,p_sum2)
             RETURNING l_flag,l_afb07,l_over
       #MOD-A30113---modify---end---
        IF l_flag = FALSE THEN
           LET l_msg = g_bookno1,'/',g_apb[l_ac].apb31,'/',g_apb[l_ac].apb25,'/',
                       YEAR(g_apa.apa02),'/',g_apb[l_ac].apb36,'/',
                       g_apb[l_ac].apb26,'/',g_apb[l_ac].apb35,'/',
                       MONTH(g_apa.apa02),'/',l_over
           CALL cl_err(l_msg,g_errno,1)
           RETURN
        ELSE
           IF l_afb07 = '2' AND l_over < 0 THEN
              LET l_msg = g_bookno1,'/',g_apb[l_ac].apb31,'/',g_apb[l_ac].apb25,'/',
                          YEAR(g_apa.apa02),'/',g_apb[l_ac].apb36,'/',
                          g_apb[l_ac].apb26,'/',g_apb[l_ac].apb35,'/',
                          MONTH(g_apa.apa02),'/',l_over
              CALL cl_err(l_msg,g_errno,1)
              LET g_errno = ' '
              RETURN
           END IF
        END IF
     END IF
  END IF

  IF g_aza.aza63 = 'N' THEN RETURN END IF
  #和apmt540類似,因為KEYIN時,可能與'耗用3:PO已確認且PO未結案且未轉應付的金額'
  #           和'耗用4:PO已立帳(立AP),但未拋傳票(未到總帳)的金額' 有重疊
  #           故根據不同的情況,要把這些數量減掉
  IF cl_null(g_apb[l_ac].apb06) AND cl_null(g_apb[l_ac].apb07) THEN
     IF p_cmd = 'a' OR l_cmd = 'a' THEN
        LET p_sum1 = 0
        LET p_sum2 = g_apb[l_ac].apb10
     ELSE
        LET p_sum1 = 0
        LET p_sum2 = g_apb[l_ac].apb10 - g_apb_t.apb10
     END IF
  ELSE
     IF p_cmd = 'a' OR l_cmd = 'a' THEN
#No.FUN-850027--begin
        LET l_year = NULL     #MOD-A30113 add 
        LET l_month = NULL    #MOD-A30113 add 
        IF g_aaz.aaz90 = 'Y' THEN
          #MOD-A30113---modify---start---
          #CALL s_budamt1(g_bookno2,g_apb[l_ac].apb31,g_apb[l_ac].apb251,
          #               YEAR(g_apa.apa02),g_apb[l_ac].apb36,
          #               g_apb[l_ac].apb930,g_apb[l_ac].apb35,
          #               MONTH(g_apa.apa02),'1')
          #     RETURNING bamt1,bamt2,bamt3,bamt4,bamt5,bamt6
           CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
           CALL s_budamt1(g_bookno2,g_apb[l_ac].apb31,g_apb[l_ac].apb251,
                          l_year,g_apb[l_ac].apb36,
                          g_apb[l_ac].apb930,g_apb[l_ac].apb35,
                          l_month,'1')
                RETURNING bamt1,bamt2,bamt3,bamt4,bamt5,bamt6
           #MOD-A30113---modify---end---
        ELSE
          #MOD-A30113---modify---start---
          #CALL s_budamt1(g_bookno2,g_apb[l_ac].apb31,g_apb[l_ac].apb251,
          #               YEAR(g_apa.apa02),g_apb[l_ac].apb36,
          #               g_apb[l_ac].apb26,g_apb[l_ac].apb35,
          #               MONTH(g_apa.apa02),'1')
          #     RETURNING bamt1,bamt2,bamt3,bamt4,bamt5,bamt6
           CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
           CALL s_budamt1(g_bookno2,g_apb[l_ac].apb31,g_apb[l_ac].apb251,
                          l_year,g_apb[l_ac].apb36,
                          g_apb[l_ac].apb26,g_apb[l_ac].apb35,
                          l_month,'1')
                RETURNING bamt1,bamt2,bamt3,bamt4,bamt5,bamt6
          #MOD-A30113---modify---end---
        END IF
#No.FUN-850027--end
        IF cl_null(bamt3) THEN LET bamt3 = 0 END IF
        IF cl_null(bamt4) THEN LET bamt4 = 0 END IF
        #要確認目前是和耗用3還是耗用4重疊
        LET l_cnt = 0
        SELECT COUNT(*) INTO l_cnt FROM pmn_file,pmm_file,pmk_file,pml_file
         WHERE pmn01 = pmm01 
           AND pmn24 = pml01
           AND pmn25 = pml02
           AND pmk01 = pml01
           AND pmn01 = g_apb[l_ac].apb06
           AND pmn02 = g_apb[l_ac].apb07
        IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
        IF l_cnt > 0 THEN  #耗用3
           LET p_sum1 = 0
           LET p_sum2 = g_apb[l_ac].apb10 - bamt3
        ELSE
           LET p_sum1 = 0
           LET p_sum2 = g_apb[l_ac].apb10 - bamt4
        END IF
     ELSE
        LET p_sum1 = 0
        LET p_sum2 = g_apb[l_ac].apb10 - g_apb_t.apb10
     END IF
  END IF
  IF cl_null(p_sum1) THEN LET p_sum1 = 0 END IF
  IF cl_null(p_sum2) THEN LET p_sum2 = 0 END IF

  IF p_flag = '2' OR p_flag = '3' THEN
#No.FUN-850027 --begin
     LET l_year = NULL     #MOD-A30113 add 
     LET l_month = NULL    #MOD-A30113 add 
     IF g_aaz.aaz90 = 'Y' THEN
        IF g_bookno2 IS NULL OR g_apb[l_ac].apb31 IS NULL OR
           g_apb[l_ac].apb251 IS NULL OR YEAR(g_apa.apa02) IS NULL OR 
           g_apb[l_ac].apb36 IS NULL OR g_apb[l_ac].apb930 IS NULL OR 
           g_apb[l_ac].apb35 IS NULL OR MONTH(g_apa.apa02) IS NULL THEN
           RETURN
        END IF
       #MOD-A30113---modify---start---
       #CALL s_budchk1(g_bookno2,g_apb[l_ac].apb31,g_apb[l_ac].apb251,
       #               YEAR(g_apa.apa02),g_apb[l_ac].apb36, 
       #               g_apb[l_ac].apb930,g_apb[l_ac].apb35,
       #               MONTH(g_apa.apa02),'1',p_cmd,p_sum1,p_sum2)
       #     RETURNING l_flag,l_afb07,l_over
        CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
        CALL s_budchk1(g_bookno2,g_apb[l_ac].apb31,g_apb[l_ac].apb251,
                       l_year,g_apb[l_ac].apb36, 
                       g_apb[l_ac].apb930,g_apb[l_ac].apb35,
                       l_month,'1',p_cmd,p_sum1,p_sum2)
             RETURNING l_flag,l_afb07,l_over
       #MOD-A30113---modify---end---
        IF l_flag = FALSE THEN
           LET l_msg = g_bookno2,'/',g_apb[l_ac].apb31,'/',g_apb[l_ac].apb251,'/',
                       YEAR(g_apa.apa02),'/',g_apb[l_ac].apb36,'/',
                       g_apb[l_ac].apb930,'/',g_apb[l_ac].apb35,'/',
                       MONTH(g_apa.apa02),'/',l_over
           CALL cl_err(l_msg,g_errno,1)
           RETURN
        ELSE
           IF l_afb07 = '2' AND l_over < 0 THEN
              LET l_msg = g_bookno2,'/',g_apb[l_ac].apb31,'/',g_apb[l_ac].apb251,'/',
                          YEAR(g_apa.apa02),'/',g_apb[l_ac].apb36,'/',
                          g_apb[l_ac].apb930,'/',g_apb[l_ac].apb35,'/',
                          MONTH(g_apa.apa02),'/',l_over
              CALL cl_err(l_msg,g_errno,1)
              LET g_errno = ' '
              RETURN
           END IF 
        END IF
     ELSE
#No.FUN-850027--end
        IF g_bookno2 IS NULL OR g_apb[l_ac].apb31 IS NULL OR
           g_apb[l_ac].apb251 IS NULL OR YEAR(g_apa.apa02) IS NULL OR 
           g_apb[l_ac].apb36 IS NULL OR g_apb[l_ac].apb26 IS NULL OR 
           g_apb[l_ac].apb35 IS NULL OR MONTH(g_apa.apa02) IS NULL THEN
           RETURN
        END IF
       #MOD-A30113---modify---start---
       #CALL s_budchk1(g_bookno2,g_apb[l_ac].apb31,g_apb[l_ac].apb251,
       #               YEAR(g_apa.apa02),g_apb[l_ac].apb36, 
       #               g_apb[l_ac].apb26,g_apb[l_ac].apb35,
       #               MONTH(g_apa.apa02),'1',p_cmd,p_sum1,p_sum2)
       #     RETURNING l_flag,l_afb07,l_over
        CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
        CALL s_budchk1(g_bookno2,g_apb[l_ac].apb31,g_apb[l_ac].apb251,
                       l_year,g_apb[l_ac].apb36, 
                       g_apb[l_ac].apb26,g_apb[l_ac].apb35,
                       l_month,'1',p_cmd,p_sum1,p_sum2)
             RETURNING l_flag,l_afb07,l_over
       #MOD-A30113---modify---end---
        IF l_flag = FALSE THEN
           LET l_msg = g_bookno2,'/',g_apb[l_ac].apb31,'/',g_apb[l_ac].apb251,'/',
                       YEAR(g_apa.apa02),'/',g_apb[l_ac].apb36,'/',
                       g_apb[l_ac].apb26,'/',g_apb[l_ac].apb35,'/',
                       MONTH(g_apa.apa02),'/',l_over
           CALL cl_err(l_msg,g_errno,1)
           RETURN
        ELSE
           IF l_afb07 = '2' AND l_over < 0 THEN
              LET l_msg = g_bookno2,'/',g_apb[l_ac].apb31,'/',g_apb[l_ac].apb251,'/',
                          YEAR(g_apa.apa02),'/',g_apb[l_ac].apb36,'/',
                          g_apb[l_ac].apb26,'/',g_apb[l_ac].apb35,'/',
                          MONTH(g_apa.apa02),'/',l_over
              CALL cl_err(l_msg,g_errno,1)
              LET g_errno = ' '
              RETURN
           END IF 
        END IF
     END IF
  END IF
  RETURN

END FUNCTION

FUNCTION t110_bud_s(p_afc00,p_afc01,p_afc02,p_afc03,p_afc04,p_afc041,
                    p_afc042,p_afc05,p_flag,p_cmd,p_sum1,p_sum2,p_flag1)
  DEFINE p_afc00     LIKE afc_file.afc00  #帳套編號
  DEFINE p_afc01     LIKE afc_file.afc01  #費用原因
  DEFINE p_afc02     LIKE afc_file.afc02  #會計科目
  DEFINE p_afc03     LIKE afc_file.afc03  #會計年度
  DEFINE p_afc04     LIKE afc_file.afc04  #WBS
  DEFINE p_afc041    LIKE afc_file.afc041 #部門編號
  DEFINE p_afc042    LIKE afc_file.afc042 #項目編號
  DEFINE p_afc05     LIKE afc_file.afc05  #期別
  DEFINE p_flag      LIKE type_file.chr1  #0.第一科目 1.第二科目
  DEFINE p_flag1     LIKE type_file.chr1  #1.單筆檢查 2.單身total檢查
  DEFINE p_cmd       LIKE type_file.chr1
  DEFINE p_sum1      LIKE afc_file.afc06 
  DEFINE p_sum2      LIKE afc_file.afc06 
  DEFINE l_flag      LIKE type_file.num5
  DEFINE l_afb07     LIKE afb_file.afb07
  DEFINE l_over      LIKE afc_file.afc07
  DEFINE l_msg       LIKE ze_file.ze03    #FUN-890128

      CALL s_budchk1(p_afc00,p_afc01,p_afc02,p_afc03,p_afc04,        
                     p_afc041,p_afc042,p_afc05,p_flag,p_cmd,p_sum1,p_sum2)
          RETURNING l_flag,l_afb07,l_over
      IF l_flag = FALSE THEN
         LET g_success = 'N'
         LET g_showmsg = p_afc00,'/',p_afc01,'/',p_afc02,'/',
                         p_afc03 USING "<<<&",'/',p_afc04,'/',
                         p_afc041,'/',p_afc042,'/',
                         p_afc05 USING "<&",p_sum2,'/',l_over
         IF p_flag1 = '2' THEN
            LET g_errno = 'agl-232'
         END IF
         IF g_bgerr THEN
            CALL s_errmsg('afc00,afc01,afc02,afc03,afc04,afc041,afc042,afc05,npl05,npl05',g_showmsg,'t420sub_bud',g_errno,1)
         ELSE
            CALL cl_err(g_showmsg,g_errno,1)
         END IF
      ELSE
         IF l_afb07 = '2' AND l_over < 0 THEN
            IF p_flag1 = '2' THEN
               LET g_errno = 'agl-232'
            END IF
            LET g_showmsg = p_afc00,'/',p_afc01,'/',p_afc02,'/',
                            p_afc03 USING "<<<&",'/',p_afc04,'/',
                            p_afc041,'/',p_afc042,'/',
                            p_afc05 USING "<&",p_sum2,'/',l_over
            IF g_bgerr THEN
               CALL s_errmsg('afc00,afc01,afc02,afc03,afc04,afc041,afc042,afc05,npl05,npl05',g_showmsg,'t420sub_bud',g_errno,1)
            ELSE
               #-FUN-890128--start--
               #CALL cl_err(g_showmsg,g_errno,1)
               LET l_msg = cl_getmsg(g_errno,g_lang)
               LET l_msg = g_showmsg CLIPPED, l_msg CLIPPED
               CALL cl_msgany(10,20,l_msg)
               #-FUN-890128--end--
            END IF
            LET g_errno = ' '
         END IF
      END IF
END FUNCTION
#No.FUN-830161  --End  

#NO.FUN-970008--Begin--
FUNCTION t210_out1()
   DEFINE   t210_msg1        STRING 

   CALL cl_set_act_visible("accept,cancel", TRUE)
   
   MENU ""

       ON ACTION apdetail
           LET t210_msg1 = "aapr129 '' '' '",g_lang,"' 'Y' '' '' "," '",g_wc CLIPPED,"' '12 ' '   ' '   '" CLIPPED
           CALL cl_cmdrun(t210_msg1)       

       ON ACTION pay
           LET t210_msg1 = "aapr111 '' '' '",g_lang,"' 'Y' '' '' "," '",g_wc CLIPPED,"' '12' '  ' '  ' '  ' '  '  '  '" CLIPPED  
           CALL cl_cmdrun(t210_msg1)       

       ON ACTION exit
          EXIT MENU

       ON IDLE g_idle_seconds
          CALL cl_on_idle() 
          CONTINUE MENU 
 
       ON ACTION about 
          CALL cl_about()

       ON ACTION help 
          CALL cl_show_help()

       ON ACTION controlg 
          CALL cl_cmdask()

       COMMAND KEY(INTERRUPT)
          LET INT_FLAG=FALSE  
          LET g_action_choice = "exit" 
          EXIT MENU

   END MENU 
  CALL cl_set_act_visible("accept,cancel", FALSE)

END FUNCTION
#No.FUN-970008--End  

#NO.FUN-840132  --Begin--
FUNCTION t210_out()
   DEFINE t210_msg        STRING 
   DEFINE l_type          LIKE type_file.chr1   #MOD-9B0001 add 

   CALL cl_set_act_visible("accept,cancel", TRUE)
   
   MENU ""
       ON ACTION discount
           LET t210_msg = "aapr220 '' '' '",g_lang,"' 'Y' '' '' "," '",g_wc CLIPPED,"' '1'" CLIPPED    #FUN-640124
           CALL cl_cmdrun(t210_msg)       
        
       ON ACTION pay
           IF g_aptype = '21' THEN LET l_type='7' END IF  #MOD-9B0001 add
           IF g_aptype = '22' THEN LET l_type='8' END IF  #MOD-9B0001 add
           IF g_aptype = '26' THEN LET l_type='9' END IF  #CHI-A90037 add
          #LET t210_msg = "aapr111 '' '' '",g_lang,"' 'Y' '' '' '",g_wc CLIPPED,"' '12' ' ' ' ' ' ' ' ' ' '" CLIPPED                   #MOD-9B0001 mark
           LET t210_msg = "aapr111 '' '' '",g_lang,"' 'Y' '' '' '",g_wc CLIPPED,"' '12' ' ' ' ' ' ' ' ' '",l_type CLIPPED,"'" CLIPPED  #MOD-9B0001 
           CALL cl_cmdrun(t210_msg)       

#       ON ACTION both
#          LET t210_msg = "aapr111 '' '' '",g_lang,"' 'Y' '' '' "," '",g_wc CLIPPED,"' '12' '  ' '  ' '  ' '  '  '  '" CLIPPED  
#          CALL cl_cmdrun(t210_msg)       
#          LET t210_msg = "aapr220 '' '' '",g_lang,"' 'Y' '' '' "," '",g_wc CLIPPED,"' '1'" CLIPPED    #FUN-640124
#          CALL cl_cmdrun(t210_msg)       

#       ON ACTION cancel 
#          LET INT_FLAG=FALSE
#          LET g_action_choice="exit" 
#          EXIT MENU

       ON ACTION exit
          EXIT MENU

       ON IDLE g_idle_seconds
          CALL cl_on_idle() 
          CONTINUE MENU 
 
       ON ACTION about 
          CALL cl_about()

       ON ACTION help 
          CALL cl_show_help()

       ON ACTION controlg 
          CALL cl_cmdask()

       COMMAND KEY(INTERRUPT)
          LET INT_FLAG=FALSE  
          LET g_action_choice = "exit" 
          EXIT MENU

   END MENU 
  CALL cl_set_act_visible("accept,cancel", FALSE)

END FUNCTION
#NO.FUN-840132  --End--
#MOD-850206

#No.TQC-860014--begin--
#該函數的功能是，由人工指定需要更新哪些賬款單身資料，來維護差異金額。
FUNCTION t110_share2()
DEFINE   l_apb       DYNAMIC ARRAY OF RECORD
            apb02    LIKE apb_file.apb02,
            apb06    LIKE apb_file.apb06,
            apb07    LIKE apb_file.apb07,
            apb12    LIKE apb_file.apb12,
            apb27    LIKE apb_file.apb27,
            apb09    LIKE apb_file.apb09,
            apb23b   LIKE apb_file.apb23,
            apb24b   LIKE apb_file.apb23,
            apb24c   LIKE apb_file.apb24,
            apb23a   LIKE apb_file.apb23,
            apb24a   LIKE apb_file.apb24,
            apb08b   LIKE apb_file.apb08,
            apb10b   LIKE apb_file.apb10,
            apb10c   LIKE apb_file.apb10,
            apb08a   LIKE apb_file.apb08,
            apb10a   LIKE apb_file.apb10,
            apb29    LIKE apb_file.apb29
                     END RECORD
DEFINE   l_apb_t     RECORD
            apb02    LIKE apb_file.apb02,
            apb06    LIKE apb_file.apb06,
            apb07    LIKE apb_file.apb07,
            apb12    LIKE apb_file.apb12,
            apb27    LIKE apb_file.apb27,
            apb09    LIKE apb_file.apb09,
            apb23b   LIKE apb_file.apb23,
            apb24b   LIKE apb_file.apb23,
            apb24c   LIKE apb_file.apb24,
            apb23a   LIKE apb_file.apb23,
            apb24a   LIKE apb_file.apb24,
            apb08b   LIKE apb_file.apb08,
            apb10b   LIKE apb_file.apb10,
            apb10c   LIKE apb_file.apb10,
            apb08a   LIKE apb_file.apb08,
            apb10a   LIKE apb_file.apb10,
            apb29    LIKE apb_file.apb29
                     END RECORD
DEFINE   l_ac        LIKE type_file.num10
DEFINE   l_b         LIKE type_file.num10   #單身數量
DEFINE   l_wc        STRING
DEFINE   l_sql       STRING       
DEFINE   l_apa33     LIKE apa_file.apa33
DEFINE   l_apa33f    LIKE apa_file.apa33f
DEFINE   i           LIKE type_file.num10
DEFINE l_amt,l_amt2   LIKE type_file.num20_6     
DEFINE l_amtf,l_amt2f LIKE type_file.num20_6     
DEFINE l_apb02       LIKE apb_file.apb02
DEFINE l_n           LIKE type_file.num10
DEFINE l_apb10_t     LIKE apb_file.apb10
DEFINE l_apb24_t     LIKE apb_file.apb24
DEFINE l_apb34       LIKE apb_file.apb34
DEFINE tok           base.StringTokenizer

   LET l_apa33  = 0
   LET l_apa33f = 0
   LET l_apb10_t= 0
   LET l_apb24_t= 0
   
   OPEN WINDOW t110_share2_w WITH FORM "aap/42f/aapt110_n"
        ATTRIBUTE(STYLE = g_win_style CLIPPED)
     #CALL cl_ui_init()                 #MOD-C70268 mark
      CALL cl_ui_locale("aapt110_n")    #MOD-C70268 add
      
      CALL l_apb.clear()
      INITIALIZE l_apb_t TO NULL
      DISPLAY g_apa.apa01  TO FORMONLY.apa01
      DISPLAY g_apa.apa33  TO FORMONLY.apa33
      DISPLAY g_apa.apa33f TO FORMONLY.apa33f

      INPUT ARRAY l_apb WITHOUT DEFAULTS FROM s_apb_n.*
        ATTRIBUTE(COUNT=l_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                  INSERT ROW =TRUE,APPEND ROW=TRUE,DELETE ROW=TRUE)
        
        BEFORE INPUT 
          IF l_b != 0 THEN 
             CALL FGL_SET_ARR_CURR(l_ac)
          END IF 
        
        BEFORE ROW 
          LET l_ac = ARR_CURR()
          IF cl_null(l_apb[l_ac].apb10c) THEN 
             LET l_apb[l_ac].apb10c = 0
          END IF
          IF cl_null(l_apb[l_ac].apb24c) THEN 
             LET l_apb[l_ac].apb24c = 0
          END IF 
          LET l_apb_t.* = l_apb[l_ac].* 
          LET l_apb10_t = l_apb_t.apb10c
          LET l_apb24_t = l_apb_t.apb24c
          
        AFTER INSERT
          IF INT_FLAG THEN 
             CANCEL INSERT
          END IF 
      
        AFTER FIELD apb02
          IF NOT cl_null(l_apb[l_ac].apb02) THEN 
             #檢查項次是否存在
             SELECT COUNT(*) INTO l_n FROM apb_file 
              WHERE apb01 = g_apa.apa01 
                AND apb02 = l_apb[l_ac].apb02
             IF l_n = 0 THEN 
                CALL cl_err(l_apb[l_ac].apb02,'aap-615',0)
                NEXT FIELD apb02
             END IF 
             #取暫估標識
             LET l_apb34 = NULL
             SELECT apb34 INTO l_apb34 FROM apb_file
              WHERE apb01 = g_apa.apa01
                AND apb02 = l_apb[l_ac].apb02
             IF l_apb34 = 'Y' THEN 
                CALL cl_err(l_apb[l_ac].apb02,'aap-616',0)
                NEXT FIELD apb02
             END IF 
             IF l_apb[l_ac].apb02 <> l_apb_t.apb02 OR cl_null(l_apb_t.apb02) THEN 
                #FOR循環檢查數組變量中是否已存在相同項次。
                FOR i = 1 TO l_apb.getLength()
                    IF i = l_ac THEN 
                       CONTINUE FOR 
                    ELSE 
                    	 IF l_apb[i].apb02 = l_apb[l_ac].apb02 THEN 
                    	    CALL cl_err(l_apb[i].apb02,'aap-614',0)
                    	    NEXT FIELD apb02
                    	 END IF 
                    END IF 
                END FOR 
                #抓取資料
                SELECT apb02,apb06,apb07,apb12,apb27,apb09,
                       apb23,apb24,0,apb23,apb24, 
                       apb08,apb10,0,apb08,apb10,apb29  
                  INTO l_apb[l_ac].*
                  FROM apb_file 
                 WHERE apb01 = g_apa.apa01 AND apb02 = l_apb[l_ac].apb02
             END IF  
          END IF 
          
        ON CHANGE apb24c
           IF l_apb[l_ac].apb29 = '1' THEN 
              IF l_apb[l_ac].apb24c + l_apb[l_ac].apb24b < 0 THEN 
                 CALL cl_err(l_apb[l_ac].apb24c,'aap-617',0)
                 LET l_apb[l_ac].apb24c = l_apb_t.apb24c
                 NEXT FIELD apb24c
              END IF 
           ELSE 
              IF l_apb[l_ac].apb24c + l_apb[l_ac].apb24b > 0 THEN 
                 CALL cl_err(l_apb[l_ac].apb24c,'aap-620',0)
                 LET l_apb[l_ac].apb24c = l_apb_t.apb24c
                 NEXT FIELD apb24c
              END IF 
           END IF 
           LET l_apb[l_ac].apb24a = l_apb[l_ac].apb24b + l_apb[l_ac].apb24c
           LET l_apb[l_ac].apb23a = l_apb[l_ac].apb24a / l_apb[l_ac].apb09
           LET l_apb[l_ac].apb10a = l_apb[l_ac].apb24a * g_apa.apa14
           LET l_apb[l_ac].apb08a = l_apb[l_ac].apb10a / l_apb[l_ac].apb09
           LET l_apb[l_ac].apb10c = l_apb[l_ac].apb24c * g_apa.apa14
           LET l_apb[l_ac].apb24c = cl_digcut(l_apb[l_ac].apb24c,t_azi04)
           LET l_apb[l_ac].apb10c = cl_digcut(l_apb[l_ac].apb10c,g_azi04)
           LET l_apb[l_ac].apb24a = cl_digcut(l_apb[l_ac].apb24a,t_azi04)
           LET l_apb[l_ac].apb23a = cl_digcut(l_apb[l_ac].apb23a,t_azi03)
           LET l_apb[l_ac].apb10a = cl_digcut(l_apb[l_ac].apb10a,g_azi04)
           LET l_apb[l_ac].apb08a = cl_digcut(l_apb[l_ac].apb08a,g_azi03)
           LET l_apb10_t = l_apb[l_ac].apb10c
           LET l_apb24_t = l_apb[l_ac].apb24c
          
        ON CHANGE apb10c
           IF l_apb[l_ac].apb29  = '1' THEN 
              IF l_apb[l_ac].apb10c + l_apb[l_ac].apb10b < 0 THEN 
                 CALL cl_err(l_apb[l_ac].apb10c,'aap-617',0)
                 LET l_apb[l_ac].apb10c = l_apb_t.apb10c
                 NEXT FIELD apb10c
              END IF 
           ELSE
              IF l_apb[l_ac].apb10c + l_apb[l_ac].apb10b > 0 THEN 
                 CALL cl_err(l_apb[l_ac].apb10c,'aap-620',0)
                 LET l_apb[l_ac].apb10c = l_apb_t.apb10c
                 NEXT FIELD apb10c
              END IF 
           END IF 
           LET l_apb[l_ac].apb10a = l_apb[l_ac].apb10b + l_apb[l_ac].apb10c
           LET l_apb[l_ac].apb08a = l_apb[l_ac].apb10a / l_apb[l_ac].apb09
           LET l_apb[l_ac].apb10c = cl_digcut(l_apb[l_ac].apb10c,g_azi04)
           LET l_apb[l_ac].apb10a = cl_digcut(l_apb[l_ac].apb10a,g_azi04)
           LET l_apb[l_ac].apb08a = cl_digcut(l_apb[l_ac].apb08a,g_azi03)
           LET l_apb10_t = l_apb[l_ac].apb10c
        

        AFTER ROW
          LET l_apa33 = 0
          LET l_apa33f= 0
          FOR i = 1 TO l_apb.getLength() 
              IF cl_null(l_apb[i].apb02) THEN CONTINUE FOR END IF
              LET l_apa33 = l_apa33 + l_apb[i].apb10c
              LET l_apa33f= l_apa33f+ l_apb[i].apb24c
          END FOR
          LET l_apa33 = g_apa.apa33 - l_apa33
          LET l_apa33f= g_apa.apa33f- l_apa33f
          LET l_apa33 = cl_digcut(l_apa33 ,g_azi04)
          LET l_apa33f= cl_digcut(l_apa33f,t_azi04)
          DISPLAY l_apa33  TO FORMONLY.apa33
          DISPLAY l_apa33f TO FORMONLY.apa33f
          LET l_b = l_apb.getLength()
          DISPLAY l_b TO FORMONLY.cnt

        AFTER INPUT 
          IF INT_FLAG THEN
             EXIT INPUT
          END IF
          IF l_apa33 <> 0 OR l_apa33f <> 0 THEN 
             LET l_ac = 1
             CALL cl_err('','aap-613',0)
             CONTINUE INPUT
          END IF  
          
        
        ON ACTION CONTROLP
          CASE
            WHEN INFIELD(apb02)
              CALL cl_init_qry_var()
              LET g_qryparam.form = 'q_apb2'
              LET g_qryparam.state = 'c'
              LET l_wc = ''
              FOR i = 1 TO l_apb.getLength()
                  IF cl_null(l_apb[i].apb02) THEN 
                     CONTINUE FOR
                  END IF 
                  IF cl_null(l_wc) THEN 
                     LET l_wc = l_apb[i].apb02
                  ELSE 
                     LET l_wc = l_wc,',',l_apb[i].apb02
                  END IF 
              END FOR
              IF cl_null(l_wc) THEN 
                 LET g_qryparam.where = " apb01 = '",g_apa.apa01,"'"
              ELSE
                 LET g_qryparam.where = " apb01 = '",g_apa.apa01,"'",
                                        " AND apb02 NOT IN (",l_wc,")"
              END IF 
              LET g_qryparam.where = g_qryparam.where," AND apb34 <> 'Y' "
              LET g_qryparam.default1 = l_apb[l_ac].apb02
              CALL cl_create_qry() RETURNING g_qryparam.multiret
              LET l_wc = g_qryparam.multiret
          END CASE 
          IF NOT cl_null(l_wc) THEN 
             LET tok = base.StringTokenizer.create(l_wc,"|")
             LET l_wc = ''
             WHILE tok.hasMoreTokens()
                 IF cl_null(l_wc) THEN 
                    LET l_wc = tok.nextToken()
                 ELSE
                    LET l_wc = l_wc,',',tok.nextToken()
                 END IF 
             END WHILE
             LET l_wc = '(',l_wc,')'
             LET l_sql = "SELECT apb02,apb06,apb07,apb12,apb27,apb09, ",
                         "       apb23,apb24,0,apb23,apb24, ",
                         "       apb08,apb10,0,apb08,apb10,apb29 FROM apb_file ", 
                         " WHERE apb01 = '",g_apa.apa01,"'",
                         "   AND apb02 IN ",l_wc,
                         "  ORDER BY apb02 "
             PREPARE t110_share2_apb_prep FROM l_sql
             DECLARE t110_share2_apb_cs CURSOR FOR t110_share2_apb_prep
             LET i = 1
             IF l_ac <= l_b THEN 
                LET i = l_b + 1  
             END IF 
             FOREACH t110_share2_apb_cs INTO l_apb[i].*
                LET i = i + 1
             END FOREACH
             CALL l_apb.deleteElement(i)
             LET i = i - 1
             LET l_b = i
             CALL FGL_SET_ARR_CURR(i)
          END IF 
        
      END INPUT 
   CLOSE WINDOW t110_share2_w
   IF INT_FLAG THEN 
      RETURN 
   END IF 
 
   FOR i=1 TO l_apb.getLength()
     #若本幣與原幣異動皆為0，則此筆記錄不予更新。
     IF l_apb[i].apb10c = 0 AND l_apb[i].apb24c = 0 THEN 
        CONTINUE FOR
     END IF 
     UPDATE apb_file SET apb08 = l_apb[i].apb08a,
                         apb081= l_apb[i].apb08a,
                         apb10 = l_apb[i].apb10a,
                         apb101= l_apb[i].apb10a,
                         apb23 = l_apb[i].apb23a,
                         apb24 = l_apb[i].apb24a
      WHERE apb01 = g_apa.apa01 AND apb02 = l_apb[i].apb02
     IF SQLCA.sqlcode THEN 
        CALL cl_err('update apb_file:',SQLCA.sqlcode,1)
        RETURN 
     END IF 
   END FOR 
   
   SELECT SUM(apb10),SUM(apb24) INTO l_amt,l_amtf FROM apb_file
    WHERE apb01 = g_apa.apa01 AND apb29='1'

   IF l_amt IS NULL THEN
      LET l_amt = 0
   END IF

   IF l_amtf IS NULL THEN
      LET l_amtf = 0
   END IF

   SELECT SUM(apb10),SUM(apb24) INTO l_amt2,l_amt2f FROM apb_file
    WHERE apb01 = g_apa.apa01 AND apb29='3'

   IF l_amt2 IS NULL THEN
      LET l_amt2 = 0
   END IF

   IF l_amt2f IS NULL THEN
      LET l_amt2f = 0
   END IF

   IF g_aptype MATCHES '1*' THEN
      LET g_apa.apa57f= l_amtf+ l_amt2f  
      LET g_apa.apa57 = l_amt + l_amt2   
   ELSE
      LET g_apa.apa57f= l_amt2f- l_amtf
      LET g_apa.apa57 = l_amt2 - l_amt
   END IF

   IF g_apa.apa57 IS NULL THEN
      LET g_apa.apa57=0
   END IF

   LET g_apa.apa57f=cl_digcut(g_apa.apa57f,t_azi04)  
   LET g_apa.apa57=cl_digcut(g_apa.apa57,g_azi04)  

   DISPLAY BY NAME g_apa.apa57

   UPDATE apa_file SET apa56 =g_apa.apa56, 
                       apa57 =g_apa.apa57,
                       apa57f=g_apa.apa57f 
    WHERE apa01=g_apa.apa01

   IF g_apb_sarrno > 0 THEN
      CALL t110_b_fill(' 1=1')
   END IF   


END FUNCTION 
#No.TQC-860014---end---

#CHI-940018  --BEGIN--
FUNCTION t110_set_entry_apk_120(p_cmd)
DEFINE p_cmd    LIKE type_file.chr1

IF p_cmd = 'a' AND (NOT g_before_input_done) THEN 
   IF  g_prog = 'aapt210' THEN #CHI-A40005
     CALL cl_set_comp_entry("apk02,apk11,apk171,apk17,apk172,apk05,apk03,apk04,apk12,apk13,apk08f,apk06f,apk08,apk06,apk32",TRUE) #CHI-A40005
   ELSE #CHI-A40005
     CALL cl_set_comp_entry("apk02,apk03",TRUE)   #MOD-950226 add apk02
     CALL cl_set_comp_entry("apk12,apk13",TRUE)
   END IF  #CHI-A40005 
END IF 
END FUNCTION

FUNCTION t110_set_no_entry_apk_120(p_cmd)
DEFINE p_cmd    LIKE type_file.chr1

IF p_cmd = 'u' AND (NOT g_before_input_done) THEN  
   IF  g_prog = 'aapt210' THEN #CHI-A40005
     CALL cl_set_comp_entry("apk02,apk11,apk171,apk17,apk172,apk05,apk03,apk04,apk12,apk13,apk08f,apk06f,apk08,apk06,apk32",FALSE) #CHI-A40005
   ELSE #CHI-A40005
     IF g_aptype MATCHES '1*' THEN
        IF g_apa.apa08 != 'MISC' THEN
           CALL cl_set_comp_entry("apk03",FALSE)
        END IF
     END IF
 
     IF g_aptype MATCHES '2*' THEN
        IF g_apb[l_ac].apb11 != 'MISC' THEN
           CALL cl_set_comp_entry("apk03",FALSE)
        END IF
     END IF

     CALL cl_set_comp_entry("apk12,apk13",FALSE)
     CALL cl_set_comp_entry("apk02",FALSE)  #CHI-940018 add apk02  
   END IF #CHI-A40005
END IF    
END FUNCTION
#CHI-940018  --END--

#--FUN-970108 start-----
FUNCTION t110_set_no_apa_required()
  CALL cl_set_comp_required("apa77",FALSE)
END FUNCTION

FUNCTION t110_set_apa_required()
   IF g_aza.aza94 = 'Y' THEN
      CALL cl_set_comp_required("apa77",TRUE)
   END IF
END FUNCTION

FUNCTION t110_set_no_apk_required()
  CALL cl_set_comp_required("apk32",FALSE)
END FUNCTION

FUNCTION t110_set_apk_required()
   IF g_aza.aza94 = 'Y' THEN
      CALL cl_set_comp_required("apk32",TRUE)
   END IF
END FUNCTION
#--FUN-970108 end----------------

#No.TQC-A30076  --Begin
FUNCTION t110_show_multi_invoice()

   IF (g_aptype = '12' OR g_aptype = '13') AND l_apz59='N' THEN   #TQC-A40106 change g_apz.apz59->l_apz59
      CALL t110_misc_display() RETURN
   END IF

END FUNCTION
#No.TQC-A30076  --End  
#No.FUN-A30106 --begin
FUNCTION t110_drill_down()  

   IF cl_null(g_apa.apa44) THEN RETURN END IF
   LET g_msg = "aglt110 '",g_apa.apa44,"'"
   CALL cl_cmdrun(g_msg)
END FUNCTION
#No.FUN-A30106 --end
#No.MOD-AC0034 --begin
FUNCTION t110_api_upd()
DEFINE l_amt    LIKE apa_file.apa34
DEFINE l_amtf   LIKE apa_file.apa34f
DEFINE l_api05  LIKE api_file.api05
DEFINE l_api05f LIKE api_file.api05f
DEFINE l_api26  LIKE api_file.api26
DEFINE l_api03  LIKE api_file.api03

       IF g_apz.apz27 = 'Y' THEN RETURN END IF #MOD-C20104

       DECLARE upd_api26 CURSOR FOR
        SELECT  DISTINCT(api26) FROM api_file WHERE api01 =g_apa.apa01
       FOREACH upd_api26 INTO l_api26
          SELECT apa34,apa34f INTO l_amt,l_amtf FROM apa_file WHERE apa01 = l_api26
          SELECT SUM(api05),SUM(api05f) INTO l_api05,l_api05f FROM api_file WHERE api26 =l_api26
          IF l_api05f = l_amtf THEN 
             IF l_api05 <> l_amt THEN 
                SELECT MAX(api03) INTO l_api03 FROM api_file WHERE api01 = g_apa.apa01 AND api26 = l_api26
                UPDATE api_file SET api05 = api05 -l_api05 + l_amt
                 WHERE api01 = g_apa.apa01 
                   AND api26 = l_api26
                   AND api03 = l_api03
             END IF 
          END IF 
       END FOREACH        

END FUNCTION
#No.MOD-AC0034 --end

#--FUN-D30066 add start--
FUNCTION t110_undoapprove()

   IF g_apa.apamksg = 'N' THEN
      RETURN
   END IF

   IF g_apa.apa63 = '1' OR g_apa.apa42 = 'Y' OR g_apa.apa41 = 'Y' THEN
      RETURN
   END IF

   IF cl_confirm('alm-030') THEN

      LET g_apa.apa63 = '0'
      UPDATE apa_file
         SET apa63 = '0'
       WHERE apa01 = g_apa.apa01

      IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
         LET g_success = 'N'
         CALL cl_err3("upd","apa_file",g_apa.apa01,"",STATUS,"","upd apa:",1)
         RETURN
      END IF
      LET g_chr2 = 'N'
      CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,"")
      DISPLAY BY NAME g_apa.apa63
   END IF

END FUNCTION

FUNCTION t110_modaccount()
   DEFINE l_apt03         LIKE apt_file.apt03
   DEFINE l_apt04         LIKE apt_file.apt04
   DEFINE l_a51           LIKE aag_file.aag02
   DEFINE l_a52           LIKE aag_file.aag02
   DEFINE l_a54           LIKE aag_file.aag02

   IF g_apa.apamksg = 'N' OR g_apa.apa41 = 'Y' THEN
      RETURN
   END IF

   IF g_apy.apydmy3 <> 'Y' THEN
      RETURN
   END IF

   OPEN WINDOW t110_mod
        WITH FORM "aap/42f/aapt110_11"  ATTRIBUTE (STYLE = g_win_style CLIPPED)

   CALL cl_ui_init()
   CALL t110_apa51()
   CALL t110_apa52()
   CALL t110_apa54_2()

   INPUT BY NAME g_apa.apa36,g_apa.apa51,g_apa.apa52,g_apa.apa54
                 WITHOUT DEFAULTS

   BEFORE INPUT
      LET g_apa_o.apa36 = ''

   AFTER FIELD apa36
      IF NOT cl_null(g_apa.apa36) THEN
         IF (g_apa.apa36 != g_apa_o.apa36) THEN
            SELECT apt03,apt04 INTO l_apt03,l_apt04
              FROM apt_file
             WHERE apt01 = g_apa.apa36

            LET g_apa.apa51 = l_apt03
            LET g_apa.apa54 = l_apt04

            DISPLAY BY NAME g_apa.apa51,g_apa.apa54

            LET l_a51 = NULL
            LET l_a54 = NULL

            CALL t110_apa51()
            CALL t110_apa54_2()

          END IF
          LET g_apa_o.apa36 = g_apa.apa36
      END IF

   AFTER FIELD apa51
      IF NOT cl_null(g_apa.apa51) THEN
         IF (g_apa_o.apa51 IS NULL) OR (g_apa.apa51 != g_apa_o.apa51) THEN
            CALL t110_apa51()
         END IF
         LET g_apa_o.apa51 = g_apa.apa51
      END IF

   AFTER FIELD apa52
      IF NOT cl_null(g_apa.apa52) THEN
         IF (g_apa_o.apa52 IS NULL) OR (g_apa.apa52 != g_apa_o.apa52) THEN
            CALL t110_apa52()
         END IF
         LET g_apa_o.apa52 = g_apa.apa52
      END IF

   AFTER FIELD apa54
      IF NOT cl_null(g_apa.apa54) THEN
         IF (g_apa_o.apa54 IS NULL) OR (g_apa.apa54 != g_apa_o.apa54) THEN
            CALL t110_apa54_2()
         END IF
         LET g_apa_o.apa54 = g_apa.apa54
      END IF

   AFTER INPUT
      IF NOT INT_FLAG THEN
         SELECT aag02 INTO l_a51
           FROM aag_file
          WHERE aag01 = g_apa.apa51
            AND aag00 = g_bookno1
            AND aagacti = 'Y'

         SELECT aag02 INTO l_a52
           FROM aag_file
          WHERE aag01 = g_apa.apa52
            AND aag00 = g_bookno1
            AND aagacti = 'Y'

         SELECT aag02 INTO l_a54
           FROM aag_file
          WHERE aag01 = g_apa.apa54
            AND aag00 = g_bookno1
            AND aagacti = 'Y'
      ELSE
         LET g_apa.apa36 = g_apa_t.apa36
         LET g_apa.apa51 = g_apa_t.apa51
         LET g_apa.apa52 = g_apa_t.apa52
         LET g_apa.apa54 = g_apa_t.apa54
      END IF

   ON ACTION CONTROLP
      CASE
         WHEN INFIELD(apa36)
            CALL cl_init_qry_var()
            LET g_qryparam.form ="q_apr"
            LET g_qryparam.default1 = g_apa.apa36
            CALL cl_create_qry() RETURNING g_apa.apa36
            DISPLAY BY NAME g_apa.apa36

         WHEN INFIELD(apa51)
            CALL cl_init_qry_var()
            LET g_qryparam.form ="q_aag02"
            LET g_qryparam.default1 = g_apa.apa51
            LET g_qryparam.arg1 = g_bookno1
            CALL cl_create_qry() RETURNING g_apa.apa51
            DISPLAY BY NAME g_apa.apa51
            CALL t110_apa51()
            NEXT FIELD apa51

         WHEN INFIELD(apa52)
            CALL cl_init_qry_var()
            LET g_qryparam.form ="q_aag02"
            LET g_qryparam.default1 = g_apa.apa52
            LET g_qryparam.arg1 = g_bookno1
            CALL cl_create_qry() RETURNING g_apa.apa52
            DISPLAY BY NAME g_apa.apa52
            CALL t110_apa52()
            NEXT FIELD apa52

         WHEN INFIELD(apa54)
            CALL cl_init_qry_var()
            LET g_qryparam.form ="q_aag02"
            LET g_qryparam.default1 = g_apa.apa54
            LET g_qryparam.arg1 = g_bookno1
            CALL cl_create_qry() RETURNING g_apa.apa54
            DISPLAY BY NAME g_apa.apa54
            CALL t110_apa54_2()
            NEXT FIELD apa54
      END CASE
   END INPUT

   IF INT_FLAG THEN
      LET INT_FLAG = 0
      CLOSE WINDOW t110_mod
      RETURN
   END IF

   CLOSE WINDOW t110_mod

   BEGIN WORK

   UPDATE apa_file SET apa36 = g_apa.apa36,
                       apa51 = g_apa.apa51,
                       apa52 = g_apa.apa52,
                       apa54 = g_apa.apa54
    WHERE apa01 = g_apa.apa01

   IF STATUS OR SQLCA.SQLERRD[3] = 0 THEN
      CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa:",1)
      ROLLBACK WORK
      RETURN
   ELSE
      COMMIT WORK
      CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'0')
      IF g_aza.aza63 = 'Y' THEN
         CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'1')
      END IF
   END IF
   DISPLAY BY NAME g_apa.apa36,g_apa.apa51,g_apa.apa52,g_apa.apa54
   DISPLAY l_a51 TO FORMONLY.a51
   DISPLAY l_a52 TO FORMONLY.a52
   DISPLAY l_a54 TO FORMONLY.a54
END FUNCTION

FUNCTION t110_apa51()
   DEFINE p_cmd LIKE type_file.chr1,
          l_a51 LIKE aag_file.aag02

   LET g_errno = ' '
   IF g_apa.apa51 = "STOCK" THEN
      DISPLAY "" TO l_a51
      RETURN
   END IF
   IF g_apa.apa51 = "UNAP" THEN
      DISPLAY "" TO l_a51
      RETURN
   END IF
   CALL s_aapact(g_apz.apz11,g_bookno1,g_apa.apa51) RETURNING l_a51
   IF cl_null(g_errno) THEN
      DISPLAY l_a51 TO FORMONLY.a51
   END IF
END FUNCTION

FUNCTION t110_apa52()
    DEFINE p_cmd LIKE type_file.chr1,
           l_a52 LIKE aag_file.aag02

    LET g_errno = ' '
    CALL s_aapact(g_apz.apz11,g_bookno1,g_apa.apa52) RETURNING l_a52
    IF cl_null(g_errno) THEN
      DISPLAY l_a52 TO FORMONLY.a52
    END IF
END FUNCTION

FUNCTION t110_apa54_2()
   DEFINE p_cmd LIKE type_file.chr1,
          l_a54 LIKE aag_file.aag02

   LET g_errno = ' '
   CALL s_aapact(g_apz.apz11,g_bookno1,g_apa.apa54) RETURNING l_a54
   IF cl_null(g_errno) THEN
      DISPLAY l_a54 TO FORMONLY.a54
   END IF
END FUNCTION
#--FUN-D30066 add end--

