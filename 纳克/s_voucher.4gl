#該程式未解開Section, 採用最新樣板產出!
{<section id="s_voucher.description" >}
#應用 a00 樣板自動產生(Version:3)
#+ Standard Version.....: SD版次:0086(1900-01-01 00:00:00), PR版次:0086(2017-10-24 10:38:47)
#+ Customerized Version.: SD版次:0000(1900-01-01 00:00:00), PR版次:0000(1900-01-01 00:00:00)
#+ Build......: 000993
#+ Filename...: s_voucher
#+ Description: 傳票異動
#+ Creator....: 01258(2013-08-15 17:24:20)
#+ Modifier...: 00000 -SD/PR- 09773
 
{</section>}
 
{<section id="s_voucher.global" >}
#應用 p00 樣板自動產生(Version:6)
#add-point:填寫註解說明 name="main.memo"
#150429-00010#14 2015/05/08 By Reanna   新增afmt570傳票
#140804-00008#13 2015/05/18 By Hans     新增afmt555
#140804-00008#20 2015/05/21 By albireo  新增afmt595 平倉帳務單傳票
#140804-00008#18 2015/05/25 By Hans     新增afmt585 收息作業帳務单
#140804-00008#15 2015/05/27 By Reanna   新增afmt565傳票
#140804-00008#9  2015/05/27 By APO      新增afmt535傳票
#150803-00018#1  2015/08/07 By Reanna   增加ANM傳票缺補號
#150807-00007#2  2015/08/10 By yangtt   增加anmt311分錄產生從glbc_t抓資料；
#                                       anmt470，anmt530增加現金變動碼
#150817-00015#1  2015/08/17 By yangtt   anmt470,anmt530,anmt311拋轉憑證，科目為現金科目，插入glbc_t
#150812-00010#2  2015/08/17 By apo      少了ent條件
#150825-00004#9  2015/08/28 By Reanna   增加afmt570重評價依幣別彙總
#150924-00006#8  2015/09/27 By Reanna   增加AFM現金變動碼&傳票改寫(範圍afmt535、afmt585、afmt595)
#150918-00001#5  2015/10/06 By Reanna   調整ANM匯差納入傳票
#151015          2015/10/15 By 03538    kris:銀存科目仍要有現金變動碼帶出
#151013-00019#2  2015/10/16 By Reanna   anmt311傳票的摘要先從anmt540/anmt310帶進來，沒有在取agli040/agli050的摘要設定
#150814-00006#3  2015/10/27 By 02599    根據借貸方向預設現金變動碼值
#151013-00019#7  2015/10/28 By Reanna   修正：afmt535分錄產生錯誤/afmt565原幣金額未出現/afmt585原幣金額未出現
#151013-00016#6  2015/10/29 By RayHuang glbc_t新增狀態碼
#151105          2015/11/05 By Hans     修正afmt585費用科目 /當afmt565金額為0時不產生
#151112-00009#3  2015/11/15 By Reanna   規格調整(參考分鏡afmt595.v2)
#150703-00021#24 2015/11/18 By Hans     增加預算控管
#151117-00009#1  2015/11/18 By 02599    当有账套时，科目检查改为检查是否存在于glad_t中
#151117-00001#7  2015/11/24 By Hans     afmt585分路修改 不在參考afmt560 取多匯差科目判斷正負
#151130          2015/11/30 By Reanna   調整anmt530產生分錄要帶出現金變動碼
#151203          2015/12/03 By 03538    carol:afmt570分錄改為借:對方科目/貸:重評價科目
#151203-00013#3  2015/12/04 By Jessy    150825-00004#6/7/9三張單修改的段落,全數還原,因原來分錄底稿就已有依幣別匯總
#151204-00001#1  2015/12/04 By 02599    aglt410审计调整凭证不检查是否大于关帐日期
#151008-00009#4  2016/01/18 By Jessy    新增axrt470傳票
#160223-00009#1  2016/02/22 By 03538    afmt535分錄調整,差額改以本金+已到期未領取利息 + 已宣告未發放股利 -面額取得
#                2016/03/15 By yangtt   afmt075,afmt090作业废弃，mark相关逻辑
#151120-00004#1  2016/03/21 By 02097    红冲允许负数，因此不卡不可负数
#160321-00016#19 2016/03/30 By Jessy    將重複內容的錯誤訊息置換為公用錯誤訊息
#160408-00009#1  2016/04/12 By albireo  afmt595 分錄金額若為負數則需轉換借貸方
#160407-00019#2  2016/04/22 By 02599    修改AXR分录底稿中收款客户xrca005/xrda005/xrcf029/xreb010/xreq017对应核算项收付款客商glaq021,
#                                                       账款客户xrca004/xrda004/xrcf030/xreb009/xreq016对应核算项账款客商glaq022
#160322-00025#30 2016/04/22 By 01531    nmbcorga赋值
#160525-00021#1  2016/05/25 By Dido     拋轉傳票指定傳票時宣告單別長度不足問題
#160525-00026#1  2016/05/25 By 01727    弹性摘要设置传入的程序名称错误
#160526-00024#1  2016/05/26 By 01531    审核时，报科目做账款客商，不可为空！但实际账款客商有值
#160608-00023#1  2016/06/13 By 02599    品类检查修正为等级须等于aoos010中设置的品类管理等级E-CIR-0001
#160308-00010#25 2016/06/20 By Jessica  確認時報錯: agl-00052 單據不為確認狀態不可进行異動=>s_voucher
#160524-00055#3  2016/06/24 By 01531    规格调整
#151008-00009#8  2016/06/24 By 03538    正向遞延規格加入:金額除了首期沖轉金額仍視為[銷貨收入],剩餘認列為[遞延收入]
#160628-00002#1  2016/07/07 By 02599    直接冲账分录改成抓取未税金额和税额
#160704-00011#7  2016/07/25 By 02599    抓取科目核算项默认值时，当抓取不到资料，返回空格
#160803-00043#1  2016/08/04 By 01531    产生分录底稿时，当含保证金账户时，会报错-284
#160805-00027#1  2016/08/05 By 03538    待抵單切立遞延分錄時,所取得遞延檔的金額,必須也轉負數處理,避免金額與單頭應收金額差異
#160727-00019#31 2016/08/10 By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
#160802-00033#1  2016/08/10 By 01531    当账套没有勾选子系统采用分录底稿功能(glaa121=N)审核时对凭证的检核不完整,需要检核金额是否平衡/科目是否都有/科目的核算项是否都有值且有效
#160727-00019#35 2016/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_gen_tmp ——> s_vr_tmp01,s_voucher_ar1_gro ——> s_vr_tmp03,s_voucher_ar1_tmp ——> s_vr_tmp02
#                                                                       s_voucher_ar_tmp ——> s_vr_tmp04
#160727-00019#36 2016/08/15 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_group ——> s_vr_tmp05
#160727-00019#38 2016/08/15 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06,s_voucher_nm_group ——> s_vr_tmp07,s_voucher_fm_tmp ——> s_vr_tmp08
#160816-00014#1  2016/08/22 By 01727    含稅立沖暫估規格優化
#160912-00002#1  2016/09/12 By 01727    aapt300/axrt300  沖含稅待抵時, 沒有依資料 稅/稅額分別產生分錄底稿
#160912-00011#4  2016/09/19 By 01727    沖暫估規格修改
#160919-00060#1  2016/09/19 By 02599    aglt380审核检核时，取消限制‘借方金额glam003和贷方金额glam004借貸金額不可同時為0
#160902-00034#1  2016/09/23 By Hans     1.專案編號不檢核是否必輸
#160729-00009#1  2016/09/28 By 02599    14个固定核算增加检核，当agli060设限时，要满足设置条件：
#                                       当agli060中有维护核算项资料时，如果是正向(允许)，核算项只可以抓取agli060中维护的值；
#                                       如果是反向(拒绝)，核算项不可以抓取agli060中维护的值；如果没有维护agli060中的值，就按照原逻辑
#161005-00018#2  2016/10/19 By 01727    科目的核算项/摘要完全一致时,需要做合并
#161127-00007#1  2016/11/28 By wuxja    增加nmck044和nmck004空值判断，防止空值的时候不产生凭证
#160927-00008#1  2016/12/05 By 02599    取弹性摘要函数s_account_item的目的栏位参数改为glgb001
#161206-00023#1  2016/12/07 By 01531    anmt311产生分录底稿有误（把不同环境同一个单号的数据也产生了），产生分录底稿子函数 s_voucher没有加环境判断。
#161205-00025#4  2016/12/07 By 02599    程式优化：aglt310凭证审核、过账、过账还原
#161128-00061#7  2016/12/09 by 02481    标准程式定义采用宣告模式,弃用.*写法
#161212-00024#1  2016/12/12 By 01727    冲暂估资料的分录单独处理
#161207-00051#1  2016/12/12 By 02114    抛总账自动补缺号效能优化
#161223-00007#1  2016/12/23 By 02114    161212-00024#1此单修改的内容,有2处注释单号写错，导致服务追单无法追到
#161223-00028#1  2016/12/23 By 02114    产生分录段,插入明细临时表时，如果金额是0，则不再插入
#161208-00035#1  2016/12/30 By 02599    aglt370审核时，取消借贷平衡检核
#170103-00019#1  2017/01/04 By 02599    1.抛转产生凭证时，同步产生相关细项立账资料,2.凭证取消审核时，判断细项立账资料是否已被冲抵，已冲抵不可取消审核,
#                                       3.过账时，增加检核细项立账资料‘應立未立;應沖未沖’
#161229-00017#1  2017/01/05 By 02114    應收AXR的銷項稅額摘要取值 s_voucher 改為統一取GL的彈性摘要，不取axri011的设定。
#170110-00009#1  2017/01/10 By 02114    多角产生单据时,执行人员不一定有账套的权限,固产生分录时,不做账套权限检查
#170103-00019#22 2017/01/12 By Reanna   产生凭证时，应一并检核立冲否，并写入立冲明细表；为科目冲销时，明细操作的立冲处理需开放点选。
#170116-00074#4  2017/01/23 By Hans     aapp330拋轉不在異動bgbd
#161221-00054#1  2017/02/06 By Reanna   核算项开窗检核增加agli060相关联判断，当agli060中有维护核算项资料时，
#                                       如果是正向(允许)，核算项只可以抓取agli060中维护的值；如果是反向(拒绝)，核算项不可以抓取agli060中维护的值；
#                                       如果没有维护agli060中的值，就按照原逻辑
#170112-00050#1  2017/02/13 By 01531    由於開帳作業匯入(azzp660)可產生分錄底稿應用,於 s_voucher 中,如為 AXR 開帳作業(azzp660)進入時,當抓取彈性摘要時請將 l_prog 轉換為 axrt300
#170214-00033#1  2017/02/14 By 02599    aglt310 產生細項立沖及審核時檢核有無立沖資訊,  都排除AC應計、RA應計調整 類型
#170111-00005#1  2017/02/17 By 08729    科目做了核算项【项目管理】【WBS】管理，检核时统一用提示讯息。
#161222-00031#1  2017/02/22 By 07900    增加摘要栏位，放在作业单身[收支明细]页签下，‘科目’栏位前面。nmbt档增加摘要栏位nmbt005.
#170111-00055#1  2017/03/01 By 02114    axrp133效能优化
#170301-00030#8  2017/03/08 By 09257    g_prog整批調整
#170310-00049#1  170313     By albireo  倉退應收沖暫估,應考慮帳款單性質02 04應是反向
#170310-00016#1  2017/03/21 By 07900    直接收款有打現金變動碼, 但未帶到工作底稿的現金變動碼欄位; 收付款廠商沒有自動帶到工作底稿
#170322-00036#1  2017/03/23 By 01531    凭证里面没有核算项的栏位，没有赋值到空格，而是null。
#170324-00067#1  170324     By albireo  NM相關:底稿使用l_tmp.sum應給值
#170328-00085#1  2017/03/30 By Sabrina  暫估沖銷借貸方金額位置有誤
#170401-00012#1  2017/04/01 By 02599    在11907行增加glacent=glaaent 条件限制
#170329-00074#1  2017/04/10 By 08729    調整s_voucher_glaq019_chk()檢核責任中心類型ooeg003需再2~5類之間
#170410-00063#1  2017/04/20 By 05795    出貨有沖訂金預收,由aist310串axrp132產生應收帳款之分錄底稿稅額科目之原幣金額有錯,和本幣金額不同,稅額本幣是對的
#170411-00094#1  2017/04/24 By 07900    过账产生的资金异动逻辑，移到审核段；过账还原的资金异动逻辑，移动到取消审核段，过账和过账还原段的逻辑mark掉。
#170503-00055#1  2017/05/08 By 02599    当启用专案编号和WBS时，可不输入资料，凭证审核检核时，启用专案编号和WBS时，值为空格或对应有效的值
#170330-00057#3  2017/05/10 By 08729    專編編號(項目編號)的開窗。前端作業有更改開窗處理"q_pjab001_1專案編號開窗	。財務端亦須跟進修改 帳款單頭【專案編號】、單身核算項【專案編號】開窗都統一為 "q_pjab001_1專案編號開窗	"
#170427-00074#1  2017/05/10 By 07900     anmt470,不启用分录底稿时，底稿，总账排序也要和启用底稿时一致。并把生成总账改成汇总资料
#170428-00024#1  2017/05/11 By 02114    资金分录汇总时,银行编号也要当汇总条件
#170605-00007#1  170605     By albireo  axrt400分錄抓來源帳款單資訊時,帳款對象給xrce038
#170613-00041#1  2017/06/13 By 02114    产生分录时,检核agli060科目与核算项的设置
#170615-00061#25 2017/06/17 By 06821    AAP模組多表JOIN時 ent 缺失調整,select count(*)效能改善
#170620-00058#1  2017/06/23 By 02599    aglt370审核检核增加限制：当科目+核算项不存在于‘金额来源科目’中，科目对应单身的百分比之和要等于100
#170618-00294#1  2017/06/26 by 08172    汇总条件为2.依单据日期日期合并而成时要增加收付款客商和账款客户条件
#170618-00060#1  2017/06/26 by 08172    补上汇总条件为2.依单据日期日期合并而成时要增加收付款客商和账款客户条件未组入分组，修改单号#170618-00294#1防止漏搬程序导致错误
#170617-00334#1  2017/07/07 By 02599    凭证审核检查增加：当该科目为现金类科目要将是否有对应现金变动码资料，没有报错
#170617-00495#1  2017/07/07 By 02599    已回转凭证不可过账还原
#170723-00001#1  2017/07/24 by 08172    来源是13.员工缴款单时，需产生贷方分录
#170621-00052#1  2017/07/26 by 08172    axrt400分录抓来源账款单资讯时，账款对象给xrce038修正
#170509-00094#1  2017/08/08 by 06189    增加判断借方金额，贷方金额，原币金额可否为负的方法
#170821-00034#1  2017/08/22 By 05795    axrt300产生分录底稿时候销售税额的科目没有合并
#170901-00025#1  2017/09/01 By 05795    axrt400 凭证预览有摘要，抛转到总账后摘要丢失
#170509-00094#7  2017/09/20 By 05488    (AFM模組)當單別紅字傳票參數為'Y'且glad002='Y'時，傳票金額顯示在正常餘額方向且允許負數
#170509-00094#3  2017/09/21 By 01531    (AXR模組)當單別紅字傳票參數為'Y'且glad002='Y'時，傳票金額顯示在正常餘額方向且允許負數
#170509-00094#4  2017/09/25 By 05488    (ANM模組)當單別紅字傳票參數為'Y'且glad002='Y'時，傳票金額顯示在正常餘額方向且允許負數
#170920-00070#1  2017/09/27 By 05016    afmt555 分錄底稿 產生的時候 貸方不應該重抓幣別 (s_voucher_gen_fm_4_cs1)
#170509-00094#10 2017/10/02 By 05488    啟用底稿和不啟用底稿產生傳票邏輯應一致(ANM)
#170509-00094#11 2017/10/03 By 05488    啟用底稿和不啟用底稿產生傳票邏輯應一致(AFM)
#170509-00094#11 2017/10/03 By 05488    啟用底稿和不啟用底稿產生傳票邏輯應一致(AFM)
#170509-00094#12 2017/10/11 By 01531    不启用底稿时，合并抛总账时，需要再进行一次二次合并，且抛到总账，要按先借后贷的顺序显示
#171003-00005#2  2017/10/16 By 07900    aglt310产生nmbc时，nmbcstus 给'Y'
#170816-00007#130 2017/10/20 By 09773   調整公用元件錯誤訊息,顯示更明確的資訊內容
#end add-point
#add-point:填寫註解說明(客製用) name="main.memo_customerization"

#end add-point
#(ver:6) ---start---
#add-point:填寫註解說明(行業用) name="global.memo_industry"

#end add-point
#(ver:6) --- end ---
 
IMPORT os
#add-point:增加匯入項目 name="main.import"
IMPORT util #150703-00021#24
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc"
#add-point:增加匯入變數檔 name="global.inc"

#end add-point
 
{</section>}
 
{<section id="s_voucher.free_style_variable" >}
#add-point:free_style模組變數(Module Variable) name="free_style.variable"
 
#end add-point
 
{</section>}
 
{<section id="s_voucher.global_variable" >}
#add-point:自定義模組變數(Module Variable) name="global.variable"
#161128-00061#7---add---begin-----------
#DEFINE g_glaq     RECORD LIKE glaq_t.*
#DEFINE g_glam     RECORD LIKE glam_t.*
#DEFINE g_glax     RECORD LIKE glax_t.*
DEFINE g_glaq RECORD  #傳票憑證單身檔
       glaqent LIKE glaq_t.glaqent, #企業編號
       glaqcomp LIKE glaq_t.glaqcomp, #法人
       glaqld LIKE glaq_t.glaqld, #帳套
       glaqdocno LIKE glaq_t.glaqdocno, #單號
       glaqseq LIKE glaq_t.glaqseq, #項次
       glaq001 LIKE glaq_t.glaq001, #摘要
       glaq002 LIKE glaq_t.glaq002, #科目編號
       glaq003 LIKE glaq_t.glaq003, #借方金額
       glaq004 LIKE glaq_t.glaq004, #貸方金額
       glaq005 LIKE glaq_t.glaq005, #交易幣別
       glaq006 LIKE glaq_t.glaq006, #匯率
       glaq007 LIKE glaq_t.glaq007, #計價單位
       glaq008 LIKE glaq_t.glaq008, #數量
       glaq009 LIKE glaq_t.glaq009, #單價
       glaq010 LIKE glaq_t.glaq010, #原幣金額
       glaq011 LIKE glaq_t.glaq011, #票據編碼
       glaq012 LIKE glaq_t.glaq012, #票據日期
       glaq013 LIKE glaq_t.glaq013, #申請人
       glaq014 LIKE glaq_t.glaq014, #銀行帳號
       glaq015 LIKE glaq_t.glaq015, #款別編號
       glaq016 LIKE glaq_t.glaq016, #收支專案
       glaq017 LIKE glaq_t.glaq017, #營運據點
       glaq018 LIKE glaq_t.glaq018, #部門
       glaq019 LIKE glaq_t.glaq019, #利潤/成本中心
       glaq020 LIKE glaq_t.glaq020, #區域
       glaq021 LIKE glaq_t.glaq021, #收付款客商
       glaq022 LIKE glaq_t.glaq022, #帳款客戶
       glaq023 LIKE glaq_t.glaq023, #客群
       glaq024 LIKE glaq_t.glaq024, #產品類別
       glaq025 LIKE glaq_t.glaq025, #人員
       glaq026 LIKE glaq_t.glaq026, #no use
       glaq027 LIKE glaq_t.glaq027, #專案編號
       glaq028 LIKE glaq_t.glaq028, #WBS
       glaq029 LIKE glaq_t.glaq029, #自由核算項一
       glaq030 LIKE glaq_t.glaq030, #自由核算項二
       glaq031 LIKE glaq_t.glaq031, #自由核算項三
       glaq032 LIKE glaq_t.glaq032, #自由核算項四
       glaq033 LIKE glaq_t.glaq033, #自由核算項五
       glaq034 LIKE glaq_t.glaq034, #自由核算項六
       glaq035 LIKE glaq_t.glaq035, #自由核算項七
       glaq036 LIKE glaq_t.glaq036, #自由核算項八
       glaq037 LIKE glaq_t.glaq037, #自由核算項九
       glaq038 LIKE glaq_t.glaq038, #自由核算項十
       glaq039 LIKE glaq_t.glaq039, #匯率(本位幣二)
       glaq040 LIKE glaq_t.glaq040, #借方金額(本位幣二)
       glaq041 LIKE glaq_t.glaq041, #貸方金額(本位幣二)
       glaq042 LIKE glaq_t.glaq042, #匯率(本位幣三)
       glaq043 LIKE glaq_t.glaq043, #借方金額(本位幣三)
       glaq044 LIKE glaq_t.glaq044, #貸方金額(本位幣三)
       glaq051 LIKE glaq_t.glaq051, #經營方式
       glaq052 LIKE glaq_t.glaq052, #通路
       glaq053 LIKE glaq_t.glaq053, #品牌
       glaqud001 LIKE glaq_t.glaqud001, #自定義欄位(文字)001
       glaqud002 LIKE glaq_t.glaqud002, #自定義欄位(文字)002
       glaqud003 LIKE glaq_t.glaqud003, #自定義欄位(文字)003
       glaqud004 LIKE glaq_t.glaqud004, #自定義欄位(文字)004
       glaqud005 LIKE glaq_t.glaqud005, #自定義欄位(文字)005
       glaqud006 LIKE glaq_t.glaqud006, #自定義欄位(文字)006
       glaqud007 LIKE glaq_t.glaqud007, #自定義欄位(文字)007
       glaqud008 LIKE glaq_t.glaqud008, #自定義欄位(文字)008
       glaqud009 LIKE glaq_t.glaqud009, #自定義欄位(文字)009
       glaqud010 LIKE glaq_t.glaqud010, #自定義欄位(文字)010
       glaqud011 LIKE glaq_t.glaqud011, #自定義欄位(數字)011
       glaqud012 LIKE glaq_t.glaqud012, #自定義欄位(數字)012
       glaqud013 LIKE glaq_t.glaqud013, #自定義欄位(數字)013
       glaqud014 LIKE glaq_t.glaqud014, #自定義欄位(數字)014
       glaqud015 LIKE glaq_t.glaqud015, #自定義欄位(數字)015
       glaqud016 LIKE glaq_t.glaqud016, #自定義欄位(數字)016
       glaqud017 LIKE glaq_t.glaqud017, #自定義欄位(數字)017
       glaqud018 LIKE glaq_t.glaqud018, #自定義欄位(數字)018
       glaqud019 LIKE glaq_t.glaqud019, #自定義欄位(數字)019
       glaqud020 LIKE glaq_t.glaqud020, #自定義欄位(數字)020
       glaqud021 LIKE glaq_t.glaqud021, #自定義欄位(日期時間)021
       glaqud022 LIKE glaq_t.glaqud022, #自定義欄位(日期時間)022
       glaqud023 LIKE glaq_t.glaqud023, #自定義欄位(日期時間)023
       glaqud024 LIKE glaq_t.glaqud024, #自定義欄位(日期時間)024
       glaqud025 LIKE glaq_t.glaqud025, #自定義欄位(日期時間)025
       glaqud026 LIKE glaq_t.glaqud026, #自定義欄位(日期時間)026
       glaqud027 LIKE glaq_t.glaqud027, #自定義欄位(日期時間)027
       glaqud028 LIKE glaq_t.glaqud028, #自定義欄位(日期時間)028
       glaqud029 LIKE glaq_t.glaqud029, #自定義欄位(日期時間)029
       glaqud030 LIKE glaq_t.glaqud030  #自定義欄位(日期時間)030
       END RECORD

DEFINE g_glam RECORD  #常用分攤傳票單身檔
       glament LIKE glam_t.glament, #企業編號
       glamld LIKE glam_t.glamld, #帳套(套)編號
       glamcomp LIKE glam_t.glamcomp, #營運據點(法人
       glamdocno LIKE glam_t.glamdocno, #分攤編號
       glamseq LIKE glam_t.glamseq, #項次
       glam001 LIKE glam_t.glam001, #摘要
       glam002 LIKE glam_t.glam002, #科目編號
       glam003 LIKE glam_t.glam003, #借方金額/比率
       glam004 LIKE glam_t.glam004, #貸方金額/比率
       glam005 LIKE glam_t.glam005, #借方變動比率分子科目
       glam006 LIKE glam_t.glam006, #貸方變動比率分子科目
       glam007 LIKE glam_t.glam007, #營運據點
       glam008 LIKE glam_t.glam008, #部門
       glam009 LIKE glam_t.glam009, #利潤/成本中心
       glam010 LIKE glam_t.glam010, #區域
       glam011 LIKE glam_t.glam011, #收付款客商
       glam012 LIKE glam_t.glam012, #帳款客商
       glam013 LIKE glam_t.glam013, #客群
       glam014 LIKE glam_t.glam014, #產品類別
       glam015 LIKE glam_t.glam015, #人員
       glam016 LIKE glam_t.glam016, #no use
       glam017 LIKE glam_t.glam017, #專案編號
       glam018 LIKE glam_t.glam018, #WBS
       glam019 LIKE glam_t.glam019, #營運據點(借)
       glam020 LIKE glam_t.glam020, #部門(借)
       glam021 LIKE glam_t.glam021, #利潤/成本中心(借)
       glam022 LIKE glam_t.glam022, #區域(借)
       glam023 LIKE glam_t.glam023, #收付款客商(借)
       glam024 LIKE glam_t.glam024, #帳款客商(借)
       glam025 LIKE glam_t.glam025, #客群(借)
       glam026 LIKE glam_t.glam026, #產品類別(借)
       glam027 LIKE glam_t.glam027, #人員(借)
       glam028 LIKE glam_t.glam028, #no use
       glam029 LIKE glam_t.glam029, #專案編號(借)
       glam030 LIKE glam_t.glam030, #WBS(借)
       glam031 LIKE glam_t.glam031, #營運據點(貸)
       glam032 LIKE glam_t.glam032, #部門(貸)
       glam033 LIKE glam_t.glam033, #利潤/成本中心(貸)
       glam034 LIKE glam_t.glam034, #區域(貸)
       glam035 LIKE glam_t.glam035, #收付款客商(貸)
       glam036 LIKE glam_t.glam036, #帳款客商(貸)
       glam037 LIKE glam_t.glam037, #客群(貸)
       glam038 LIKE glam_t.glam038, #產品類別(貸)
       glam039 LIKE glam_t.glam039, #人員(貸)
       glam040 LIKE glam_t.glam040, #no use
       glam041 LIKE glam_t.glam041, #專案編號(貸)
       glam042 LIKE glam_t.glam042, #WBS(貸)
       glam043 LIKE glam_t.glam043, #匯率(本位幣二)
       glam044 LIKE glam_t.glam044, #借方金額(本位幣二)
       glam045 LIKE glam_t.glam045, #貸方金額(本位幣二)
       glam046 LIKE glam_t.glam046, #匯率(本位幣三)
       glam047 LIKE glam_t.glam047, #借方金額(本位幣三)
       glam048 LIKE glam_t.glam048, #貸方金額(本位幣三)
       glam051 LIKE glam_t.glam051, #經營方式
       glam052 LIKE glam_t.glam052, #通路
       glam053 LIKE glam_t.glam053, #品牌
       glam054 LIKE glam_t.glam054, #經營方式(借)
       glam055 LIKE glam_t.glam055, #通路(借)
       glam056 LIKE glam_t.glam056, #品牌(借)
       glam057 LIKE glam_t.glam057, #經營方式(貸)
       glam058 LIKE glam_t.glam058, #通路(貸)
       glam059 LIKE glam_t.glam059, #品牌(貸)
       glamud001 LIKE glam_t.glamud001, #自定義欄位(文字)001
       glamud002 LIKE glam_t.glamud002, #自定義欄位(文字)002
       glamud003 LIKE glam_t.glamud003, #自定義欄位(文字)003
       glamud004 LIKE glam_t.glamud004, #自定義欄位(文字)004
       glamud005 LIKE glam_t.glamud005, #自定義欄位(文字)005
       glamud006 LIKE glam_t.glamud006, #自定義欄位(文字)006
       glamud007 LIKE glam_t.glamud007, #自定義欄位(文字)007
       glamud008 LIKE glam_t.glamud008, #自定義欄位(文字)008
       glamud009 LIKE glam_t.glamud009, #自定義欄位(文字)009
       glamud010 LIKE glam_t.glamud010, #自定義欄位(文字)010
       glamud011 LIKE glam_t.glamud011, #自定義欄位(數字)011
       glamud012 LIKE glam_t.glamud012, #自定義欄位(數字)012
       glamud013 LIKE glam_t.glamud013, #自定義欄位(數字)013
       glamud014 LIKE glam_t.glamud014, #自定義欄位(數字)014
       glamud015 LIKE glam_t.glamud015, #自定義欄位(數字)015
       glamud016 LIKE glam_t.glamud016, #自定義欄位(數字)016
       glamud017 LIKE glam_t.glamud017, #自定義欄位(數字)017
       glamud018 LIKE glam_t.glamud018, #自定義欄位(數字)018
       glamud019 LIKE glam_t.glamud019, #自定義欄位(數字)019
       glamud020 LIKE glam_t.glamud020, #自定義欄位(數字)020
       glamud021 LIKE glam_t.glamud021, #自定義欄位(日期時間)021
       glamud022 LIKE glam_t.glamud022, #自定義欄位(日期時間)022
       glamud023 LIKE glam_t.glamud023, #自定義欄位(日期時間)023
       glamud024 LIKE glam_t.glamud024, #自定義欄位(日期時間)024
       glamud025 LIKE glam_t.glamud025, #自定義欄位(日期時間)025
       glamud026 LIKE glam_t.glamud026, #自定義欄位(日期時間)026
       glamud027 LIKE glam_t.glamud027, #自定義欄位(日期時間)027
       glamud028 LIKE glam_t.glamud028, #自定義欄位(日期時間)028
       glamud029 LIKE glam_t.glamud029, #自定義欄位(日期時間)029
       glamud030 LIKE glam_t.glamud030  #自定義欄位(日期時間)030
       END RECORD

DEFINE g_glax RECORD  #傳票項次立帳異動檔
       glaxent LIKE glax_t.glaxent, #企業編號
       glaxownid LIKE glax_t.glaxownid, #資料所有者
       glaxowndp LIKE glax_t.glaxowndp, #資料所屬部門
       glaxcrtid LIKE glax_t.glaxcrtid, #資料建立者
       glaxcrtdp LIKE glax_t.glaxcrtdp, #資料建立部門
       glaxcrtdt LIKE glax_t.glaxcrtdt, #資料創建日
       glaxmodid LIKE glax_t.glaxmodid, #資料修改者
       glaxmoddt LIKE glax_t.glaxmoddt, #最近修改日
       glaxcnfid LIKE glax_t.glaxcnfid, #資料確認者
       glaxcnfdt LIKE glax_t.glaxcnfdt, #資料確認日
       glaxstus LIKE glax_t.glaxstus, #狀態碼
       glaxld LIKE glax_t.glaxld, #帳套
       glaxcomp LIKE glax_t.glaxcomp, #法人
       glaxdocno LIKE glax_t.glaxdocno, #單號
       glaxseq LIKE glax_t.glaxseq, #項次
       glaxdocdt LIKE glax_t.glaxdocdt, #單據日期
       glax001 LIKE glax_t.glax001, #摘要
       glax002 LIKE glax_t.glax002, #科目編號
       glax003 LIKE glax_t.glax003, #本幣立帳金額
       glax005 LIKE glax_t.glax005, #交易幣別
       glax006 LIKE glax_t.glax006, #匯率
       glax007 LIKE glax_t.glax007, #計價單位
       glax008 LIKE glax_t.glax008, #立帳數量
       glax009 LIKE glax_t.glax009, #單價
       glax010 LIKE glax_t.glax010, #原幣立帳金額
       glax011 LIKE glax_t.glax011, #票據號碼
       glax012 LIKE glax_t.glax012, #票據日期
       glax013 LIKE glax_t.glax013, #申請人
       glax014 LIKE glax_t.glax014, #銀行帳號
       glax015 LIKE glax_t.glax015, #結算方式
       glax016 LIKE glax_t.glax016, #收支項目
       glax017 LIKE glax_t.glax017, #營運據點
       glax018 LIKE glax_t.glax018, #部門
       glax019 LIKE glax_t.glax019, #利潤/成本中心
       glax020 LIKE glax_t.glax020, #區域
       glax021 LIKE glax_t.glax021, #收付款客商
       glax022 LIKE glax_t.glax022, #帳款客商
       glax023 LIKE glax_t.glax023, #客群
       glax024 LIKE glax_t.glax024, #產品類別
       glax025 LIKE glax_t.glax025, #人員
       glax026 LIKE glax_t.glax026, #no use
       glax027 LIKE glax_t.glax027, #專案編號
       glax028 LIKE glax_t.glax028, #WBS
       glax029 LIKE glax_t.glax029, #自由核算項一
       glax030 LIKE glax_t.glax030, #自由核算項二
       glax031 LIKE glax_t.glax031, #自由核算項三
       glax032 LIKE glax_t.glax032, #自由核算項四
       glax033 LIKE glax_t.glax033, #自由核算項五
       glax034 LIKE glax_t.glax034, #自由核算項六
       glax035 LIKE glax_t.glax035, #自由核算項七
       glax036 LIKE glax_t.glax036, #自由核算項八
       glax037 LIKE glax_t.glax037, #自由核算項九
       glax038 LIKE glax_t.glax038, #自由核算項十
       glax041 LIKE glax_t.glax041, #本幣預沖金額
       glax042 LIKE glax_t.glax042, #本幣已沖金額
       glax043 LIKE glax_t.glax043, #預沖數量
       glax044 LIKE glax_t.glax044, #已沖數量
       glax045 LIKE glax_t.glax045, #原幣預沖金額
       glax046 LIKE glax_t.glax046, #原幣已沖金額
       glax047 LIKE glax_t.glax047, #資料來源
       glax048 LIKE glax_t.glax048, #原始憑證號碼
       glax049 LIKE glax_t.glax049, #會計年度
       glax050 LIKE glax_t.glax050, #會計期別
       glax051 LIKE glax_t.glax051, #匯率(本位幣二)
       glax052 LIKE glax_t.glax052, #立帳金額(本位幣二)
       glax053 LIKE glax_t.glax053, #預沖金額(本位幣二)
       glax054 LIKE glax_t.glax054, #已沖金額(本位幣二)
       glax055 LIKE glax_t.glax055, #匯率(本位幣三)
       glax056 LIKE glax_t.glax056, #立帳金額(本位幣三)
       glax057 LIKE glax_t.glax057, #預沖金額(本位幣三)
       glax058 LIKE glax_t.glax058, #已沖金額(本位幣三)
       glax061 LIKE glax_t.glax061, #經營方式
       glax062 LIKE glax_t.glax062, #通路
       glax063 LIKE glax_t.glax063, #品牌
       glaxud001 LIKE glax_t.glaxud001, #自定義欄位(文字)001
       glaxud002 LIKE glax_t.glaxud002, #自定義欄位(文字)002
       glaxud003 LIKE glax_t.glaxud003, #自定義欄位(文字)003
       glaxud004 LIKE glax_t.glaxud004, #自定義欄位(文字)004
       glaxud005 LIKE glax_t.glaxud005, #自定義欄位(文字)005
       glaxud006 LIKE glax_t.glaxud006, #自定義欄位(文字)006
       glaxud007 LIKE glax_t.glaxud007, #自定義欄位(文字)007
       glaxud008 LIKE glax_t.glaxud008, #自定義欄位(文字)008
       glaxud009 LIKE glax_t.glaxud009, #自定義欄位(文字)009
       glaxud010 LIKE glax_t.glaxud010, #自定義欄位(文字)010
       glaxud011 LIKE glax_t.glaxud011, #自定義欄位(數字)011
       glaxud012 LIKE glax_t.glaxud012, #自定義欄位(數字)012
       glaxud013 LIKE glax_t.glaxud013, #自定義欄位(數字)013
       glaxud014 LIKE glax_t.glaxud014, #自定義欄位(數字)014
       glaxud015 LIKE glax_t.glaxud015, #自定義欄位(數字)015
       glaxud016 LIKE glax_t.glaxud016, #自定義欄位(數字)016
       glaxud017 LIKE glax_t.glaxud017, #自定義欄位(數字)017
       glaxud018 LIKE glax_t.glaxud018, #自定義欄位(數字)018
       glaxud019 LIKE glax_t.glaxud019, #自定義欄位(數字)019
       glaxud020 LIKE glax_t.glaxud020, #自定義欄位(數字)020
       glaxud021 LIKE glax_t.glaxud021, #自定義欄位(日期時間)021
       glaxud022 LIKE glax_t.glaxud022, #自定義欄位(日期時間)022
       glaxud023 LIKE glax_t.glaxud023, #自定義欄位(日期時間)023
       glaxud024 LIKE glax_t.glaxud024, #自定義欄位(日期時間)024
       glaxud025 LIKE glax_t.glaxud025, #自定義欄位(日期時間)025
       glaxud026 LIKE glax_t.glaxud026, #自定義欄位(日期時間)026
       glaxud027 LIKE glax_t.glaxud027, #自定義欄位(日期時間)027
       glaxud028 LIKE glax_t.glaxud028, #自定義欄位(日期時間)028
       glaxud029 LIKE glax_t.glaxud029, #自定義欄位(日期時間)029
       glaxud030 LIKE glax_t.glaxud030  #自定義欄位(日期時間)030
       END RECORD

#161128-00061#7---add---end-----------
 TYPE type_g_glaq_d        RECORD
       docno       LIKE glaq_t.glaqdocno,
       docdt       LIKE glap_t.glapdocdt,
       sw          LIKE type_t.chr1,     
       glaqent     LIKE glaq_t.glaqent,  
       glaqcomp    LIKE glaq_t.glaqcomp, 
       glaqld      LIKE glaq_t.glaqld,   
       glaq001     LIKE glaq_t.glaq001,  
       glaq002     LIKE glaq_t.glaq002,  
       glaq005     LIKE glaq_t.glaq005,  
       glaq006     LIKE glaq_t.glaq006,  
       glaq007     LIKE glaq_t.glaq007,  
       glaq009     LIKE glaq_t.glaq009,  
       glaq011     LIKE glaq_t.glaq011,  
       glaq012     LIKE glaq_t.glaq012,  
       glaq013     LIKE glaq_t.glaq013,  
       glaq014     LIKE glaq_t.glaq014,  
       glaq015     LIKE glaq_t.glaq015,  
       glaq016     LIKE glaq_t.glaq016,  
       glaq017     LIKE glaq_t.glaq017,  
       glaq018     LIKE glaq_t.glaq018,  
       glaq019     LIKE glaq_t.glaq019,  
       glaq020     LIKE glaq_t.glaq020,  
       glaq021     LIKE glaq_t.glaq021,  
       glaq022     LIKE glaq_t.glaq022,  
       glaq023     LIKE glaq_t.glaq023,  
       glaq024     LIKE glaq_t.glaq024,  
       glaq025     LIKE glaq_t.glaq025,   
       glaq027     LIKE glaq_t.glaq027,  
       glaq028     LIKE glaq_t.glaq028,  
       glaq051     LIKE glaq_t.glaq051,  #經營方式
       glaq052     LIKE glaq_t.glaq052,  #渠道 
       glaq053     LIKE glaq_t.glaq053,  #品牌
       glaq029     LIKE glaq_t.glaq029,  
       glaq030     LIKE glaq_t.glaq030,  
       glaq031     LIKE glaq_t.glaq031,  
       glaq032     LIKE glaq_t.glaq032,  
       glaq033     LIKE glaq_t.glaq033,  
       glaq034     LIKE glaq_t.glaq034,  
       glaq035     LIKE glaq_t.glaq035,  
       glaq036     LIKE glaq_t.glaq036,  
       glaq037     LIKE glaq_t.glaq037,  
       glaq038     LIKE glaq_t.glaq038, 
       glbc004     LIKE glbc_t.glbc004,  #现金变动码            
       d           LIKE glaq_t.glaq003,  
       c           LIKE glaq_t.glaq004,  
       qty         LIKE glaq_t.glaq008,  
       sum         LIKE glaq_t.glaq010,
       glaq039     LIKE glaq_t.glaq039,
       glaq040     LIKE glaq_t.glaq040,
       glaq041     LIKE glaq_t.glaq041,
       glaq042     LIKE glaq_t.glaq042,
       glaq043     LIKE glaq_t.glaq043,
       glaq044     LIKE glaq_t.glaq044,
       seq         LIKE glaq_t.glaqseq,
       source      LIKE type_t.chr100,
       glaqseq     LIKE glaq_t.glaqseq,
       xrca039     LIKE xrca_t.xrca039,
       b_glaq021   LIKE glaq_t.glaq021,     #汇总时根据这2个值汇总,上面的根据设置清空
       b_glaq022   LIKE glaq_t.glaq022,
       red         LIKE type_t.chr1       #红冲否(待抵单使用) #20150612 add lujh 
       END RECORD
DEFINE g_glaq_d   DYNAMIC ARRAY OF type_g_glaq_d

TYPE type_g_glaq2_d        RECORD
       docno        LIKE glaq_t.glaqdocno,
       docdt        LIKE glap_t.glapdocdt,
       sw           LIKE type_t.chr1,     
       glaqent      LIKE glaq_t.glaqent,  
       glaqcomp     LIKE glaq_t.glaqcomp, 
       glaqld       LIKE glaq_t.glaqld,   
       glaq001      LIKE glaq_t.glaq001,  
       glaq002      LIKE glaq_t.glaq002,  
       glaq005      LIKE glaq_t.glaq005,  
       glaq006      LIKE glaq_t.glaq006,  
       glaq007      LIKE glaq_t.glaq007,  
       glaq009      LIKE glaq_t.glaq009,  
       glaq011      LIKE glaq_t.glaq011,  
       glaq012      LIKE glaq_t.glaq012,  
       glaq013      LIKE glaq_t.glaq013,  
       glaq014      LIKE glaq_t.glaq014,  
       glaq015      LIKE glaq_t.glaq015,  
       glaq016      LIKE glaq_t.glaq016,  
       glaq017      LIKE glaq_t.glaq017,  
       glaq018      LIKE glaq_t.glaq018,  
       glaq019      LIKE glaq_t.glaq019,  
       glaq020      LIKE glaq_t.glaq020,  
       glaq021      LIKE glaq_t.glaq021,  
       glaq022      LIKE glaq_t.glaq022,  
       glaq023      LIKE glaq_t.glaq023,  
       glaq024      LIKE glaq_t.glaq024,  
       glaq025      LIKE glaq_t.glaq025,  
       glaq027      LIKE glaq_t.glaq027,  
       glaq028      LIKE glaq_t.glaq028,  
       glaq051      LIKE glaq_t.glaq051,  #經營方式
       glaq052      LIKE glaq_t.glaq052,  #渠道 
       glaq053      LIKE glaq_t.glaq053,  #品牌
       glaq029      LIKE glaq_t.glaq029,  
       glaq030      LIKE glaq_t.glaq030,  
       glaq031      LIKE glaq_t.glaq031,  
       glaq032      LIKE glaq_t.glaq032,  
       glaq033      LIKE glaq_t.glaq033,  
       glaq034      LIKE glaq_t.glaq034,  
       glaq035      LIKE glaq_t.glaq035,  
       glaq036      LIKE glaq_t.glaq036,  
       glaq037      LIKE glaq_t.glaq037,  
       glaq038      LIKE glaq_t.glaq038,
       glbc004      LIKE glbc_t.glbc004,  #现金变动码         
       d            LIKE glaq_t.glaq003,  
       c            LIKE glaq_t.glaq004,  
       qty          LIKE glaq_t.glaq008,  
       sum          LIKE glaq_t.glaq010,
       glaq039      LIKE glaq_t.glaq039,
       glaq040      LIKE glaq_t.glaq040,
       glaq041      LIKE glaq_t.glaq041,
       glaq042      LIKE glaq_t.glaq042,
       glaq043      LIKE glaq_t.glaq043,
       glaq044      LIKE glaq_t.glaq044,
       seq          LIKE glaq_t.glaqseq,
       source       LIKE type_t.chr100,
       glaqseq      LIKE glaq_t.glaqseq,
       xrca039      LIKE xrca_t.xrca039,
       b_glaq021   LIKE glaq_t.glaq021,     #汇总时根据这2个值汇总,上面的根据设置清空
       b_glaq022   LIKE glaq_t.glaq022,
       red         LIKE type_t.chr1       #红冲否(待抵单使用) #20150612 add lujh 
       END RECORD
DEFINE g_glaq2_d   DYNAMIC ARRAY OF type_g_glaq2_d
# TYPE type_g_glaq_d        RECORD
#       docno   LIKE xrca_t.xrcadocno,
#       docdt   LIKE xrca_t.xrcadocdt,
#       glaq022 LIKE glaq_t.glaq022,
#       glaqseq LIKE glaq_t.glaqseq,
#       glaq001 LIKE glaq_t.glaq001,       
#       glaq002 LIKE glaq_t.glaq002,
#       lc_subject LIKE type_t.chr300,       
#       glaq003 LIKE glaq_t.glaq003, 
#       glaq004 LIKE glaq_t.glaq004,
#       edit1   LIKE type_t.chr80
#       END RECORD
#DEFINE g_glaq_d   DYNAMIC ARRAY OF type_g_glaq_d
DEFINE g_sql      STRING 
DEFINE g_ref_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
#150807-00007#2 add---str
TYPE type_g_glaq3_d        RECORD
   docno    LIKE glaq_t.glaqdocno,
   docdt    LIKE glap_t.glapdocdt, 
   sw       LIKE type_t.chr1,   
   glaqent  LIKE glaq_t.glaqent,
   glaqcomp LIKE glaq_t.glaqcomp,
   glaqld   LIKE glaq_t.glaqld,
   glaq001  LIKE glaq_t.glaq001,
   glaq002  LIKE glaq_t.glaq002,
   glaq005  LIKE glaq_t.glaq005,
   glaq006  LIKE glaq_t.glaq006,
   glaq007  LIKE glaq_t.glaq007,
   glaq009  LIKE glaq_t.glaq009,
   glaq011  LIKE glaq_t.glaq011,
   glaq012  LIKE glaq_t.glaq012,
   glaq013  LIKE glaq_t.glaq013,
   glaq014  LIKE glaq_t.glaq014,
   glaq015  LIKE glaq_t.glaq015,
   glaq016  LIKE glaq_t.glaq016,   
   glaq017  LIKE glaq_t.glaq017,
   glaq018  LIKE glaq_t.glaq018,
   glaq019  LIKE glaq_t.glaq019,
   glaq020  LIKE glaq_t.glaq020,
   glaq021  LIKE glaq_t.glaq021,
   glaq022  LIKE glaq_t.glaq022,
   glaq023  LIKE glaq_t.glaq023,
   glaq024  LIKE glaq_t.glaq024,
   glaq025  LIKE glaq_t.glaq025,
   #glaq026  LIKE glaq_t.glaq026, #151111-00001#1 mark lujh
   glaq027  LIKE glaq_t.glaq027,
   glaq028  LIKE glaq_t.glaq028,
   glaq051  LIKE glaq_t.glaq051,  #經營方式
   glaq052  LIKE glaq_t.glaq052,  #渠道 
   glaq053  LIKE glaq_t.glaq053,  #品牌
   glaq029  LIKE glaq_t.glaq029,
   glaq030  LIKE glaq_t.glaq030,
   glaq031  LIKE glaq_t.glaq031,
   glaq032  LIKE glaq_t.glaq032,
   glaq033  LIKE glaq_t.glaq033,
   glaq034  LIKE glaq_t.glaq034,
   glaq035  LIKE glaq_t.glaq035,
   glaq036  LIKE glaq_t.glaq036,
   glaq037  LIKE glaq_t.glaq037,
   glaq038  LIKE glaq_t.glaq038,
   d        LIKE glaq_t.glaq003,
   c        LIKE glaq_t.glaq004,
   qty      LIKE glaq_t.glaq008,
   sum      LIKE glaq_t.glaq010,
   glaq039  LIKE glaq_t.glaq039,
   glaq040  LIKE glaq_t.glaq040,
   glaq041  LIKE glaq_t.glaq041,
   glaq042  LIKE glaq_t.glaq042,
   glaq043  LIKE glaq_t.glaq043,
   glaq044  LIKE glaq_t.glaq044,
   seq      LIKE glaq_t.glaqseq,
   source   LIKE type_t.chr100,
   glaqseq  LIKE glaq_t.glaqseq,
   xrca039  LIKE xrca_t.xrca039,
   glgb055  LIKE glgb_t.glgb055   
END RECORD
DEFINE g_glaq3_d   DYNAMIC ARRAY OF type_g_glaq3_d
#150807-00007#2 add---end

#151111-00001#1--add--str--lujh
DEFINE g_free_m    RECORD
       free_item_1     LIKE nmbt_t.nmbt034, 
       free_item_2     LIKE nmbt_t.nmbt035,
       free_item_3     LIKE nmbt_t.nmbt036, 
       free_item_4     LIKE nmbt_t.nmbt037,
       free_item_5     LIKE nmbt_t.nmbt038, 
       free_item_6     LIKE nmbt_t.nmbt039,
       free_item_7     LIKE nmbt_t.nmbt040, 
       free_item_8     LIKE nmbt_t.nmbt041,
       free_item_9     LIKE nmbt_t.nmbt042,     
       free_item_10    LIKE nmbt_t.nmbt043            
       END RECORD

DEFINE g_field_m       RECORD
       field1     LIKE type_t.chr10, 
       field2     LIKE type_t.chr10,
       field3     LIKE type_t.chr10, 
       field4     LIKE type_t.chr10,
       field5     LIKE type_t.chr10, 
       field6     LIKE type_t.chr10,
       field7     LIKE type_t.chr10, 
       field8     LIKE type_t.chr10,
       field9     LIKE type_t.chr10,     
       field10    LIKE type_t.chr10            
       END RECORD
#151111-00001#1--add--end--lujh
DEFINE g_ooac004    LIKE ooac_t.ooac004    #170111-00055#1 add lujh axrp133效能优化
DEFINE g_seq        LIKE type_t.num10      #170613-00041#1 add lujh
DEFINE g_dfin1002   LIKE type_t.chr1       #170509-00094#7 add
#170816-00007#130 by 09773 add(S)
DEFINE g_colname_1   STRING   
DEFINE g_comment_1   STRING       
DEFINE g_msg         STRING   #錯誤訊息
#170816-00007#130 by 09773 add(E)

#end add-point
 
{</section>}
 
{<section id="s_voucher.other_dialog" >}

 
{</section>}
 
{<section id="s_voucher.other_function" readonly="Y" >}
# Descriptions...: 傳票憑證確認
# Memo...........:
# Usage..........: CALL s_voucher_conf_chk(p_glapld,p_glapdocno)
#                  RETURNING r_success
# Input parameter: p_ld           帐套
#                : p_glapdocno    傳票編號
# Return code....: r_success      成功否标识位
# Date & Author..: 2013/09/10 By minpp
# Modify.........:
#==========================
PUBLIC FUNCTION s_voucher_conf_chk(p_glapld,p_glapdocno)
   DEFINE p_glapld         LIKE glap_t.glapld         #帐别
   DEFINE p_glapdocno      LIKE glap_t.glapdocno      #傳票編號
   DEFINE r_success    LIKE type_t.num5           #檢核狀態
   DEFINE r_errno      LIKE type_t.chr80          #錯誤訊息
   DEFINE l_glapdocdt  LIKE glap_t.glapdocdt      #传票日期
   DEFINE l_glap010    LIKE glap_t.glap010        #借方金额
   DEFINE l_glap011    LIKE glap_t.glap011        #贷方金额
   DEFINE l_glaq003    LIKE glaq_t.glaq003        #单身借方金额
   DEFINE l_glaq004    LIKE glaq_t.glaq004        #单身贷方金额
   DEFINE l_cnt        LIKE type_t.num5
   DEFINE l_glapstus   LIKE glap_t.glapstus       #状态
   DEFINE l_glaqseq    LIKE glaq_t.glaqseq        #项次
   DEFINE l_glap006    LIKE glap_t.glap006        #单头科目
   DEFINE l_glaq002    LIKE glaq_t.glaq002        #单身科目
   DEFINE l_glac006    LIKE glac_t.glac006        #科目性质
   DEFINE l_glac003    LIKE glac_t.glac003        #统治/明细科目
   DEFINE l_sql        STRING
   DEFINE l_glaa004    LIKE glaa_t.glaa004        #会计科目参照表
   #固定核算项（agli030）
   DEFINE l_glad007       LIKE glad_t.glad007     #部門管理否
   DEFINE l_glad008       LIKE glad_t.glad008     #利潤成本中心管理
   DEFINE l_glad009       LIKE glad_t.glad009     #區域管理
   DEFINE l_glad010       LIKE glad_t.glad010     #交易客商管理
   DEFINE l_glad027       LIKE glad_t.glad027     #账款客商管理
   DEFINE l_glad011       LIKE glad_t.glad011     #客群管理否
   DEFINE l_glad012       LIKE glad_t.glad012     #產品類別
   DEFINE l_glad013       LIKE glad_t.glad013     #人員
#   DEFINE l_glad014       LIKE glad_t.glad014     #预算管理否
   DEFINE l_glad015       LIKE glad_t.glad015     #专案管理否
   DEFINE l_glad016       LIKE glad_t.glad016     #wbs管理
   DEFINE l_glad031       LIKE glad_t.glad031     #經營方式管理否
   DEFINE l_glad032       LIKE glad_t.glad032     #渠道管理否
   DEFINE l_glad033       LIKE glad_t.glad033     #品牌管理否
   #是否做自由科目核算项管理
   DEFINE l_glad017       LIKE glad_t.glad017
   DEFINE l_glad0171      LIKE glad_t.glad0171 
   DEFINE l_glad0172      LIKE glad_t.glad0172 
   DEFINE l_glad018       LIKE glad_t.glad018
   DEFINE l_glad0181      LIKE glad_t.glad0181
   DEFINE l_glad0182      LIKE glad_t.glad0182
   DEFINE l_glad019       LIKE glad_t.glad019
   DEFINE l_glad0191      LIKE glad_t.glad0191
   DEFINE l_glad0192      LIKE glad_t.glad0192
   DEFINE l_glad020       LIKE glad_t.glad020
   DEFINE l_glad0201      LIKE glad_t.glad0201
   DEFINE l_glad0202      LIKE glad_t.glad0202
   DEFINE l_glad021       LIKE glad_t.glad021
   DEFINE l_glad0211      LIKE glad_t.glad0211
   DEFINE l_glad0212      LIKE glad_t.glad0212
   DEFINE l_glad022       LIKE glad_t.glad022
   DEFINE l_glad0221      LIKE glad_t.glad0221
   DEFINE l_glad0222      LIKE glad_t.glad0222
   DEFINE l_glad023       LIKE glad_t.glad023
   DEFINE l_glad0231      LIKE glad_t.glad0231
   DEFINE l_glad0232      LIKE glad_t.glad0232
   DEFINE l_glad024       LIKE glad_t.glad024
   DEFINE l_glad0241      LIKE glad_t.glad0241
   DEFINE l_glad0242      LIKE glad_t.glad0242
   DEFINE l_glad025       LIKE glad_t.glad025
   DEFINE l_glad0251      LIKE glad_t.glad0251
   DEFINE l_glad0252      LIKE glad_t.glad0252
   DEFINE l_glad026       LIKE glad_t.glad026
   DEFINE l_glad0261      LIKE glad_t.glad0261
   DEFINE l_glad0262      LIKE glad_t.glad0262
   DEFINE l_errno         LIKE type_t.chr10
   DEFINE l_errmsg        STRING     #组合报错信息
   DEFINE l_msg           STRING     #组合报错信息
   DEFINE l_msg1          STRING     #组合报错信息
   DEFINE l_desc          LIKE type_t.chr80     #接受s_get_orga返回值
   DEFINE l_date          LIKE ooed_t.ooed006   #接受s_get_orga返回值
   DEFINE l_glaq017       LIKE glaq_t.glaq017  
   #本位幣二、三設置
   DEFINE l_glaa015       LIKE glaa_t.glaa015
   DEFINE l_glaa019       LIKE glaa_t.glaa019
   DEFINE l_glaq040       LIKE glaq_t.glaq040
   DEFINE l_glaq041       LIKE glaq_t.glaq041
   DEFINE l_glaq043       LIKE glaq_t.glaq043
   DEFINE l_glaq044       LIKE glaq_t.glaq044
   #現金變動碼設置
   DEFINE l_glap002       LIKE glap_t.glap002
   DEFINE l_glap004       LIKE glap_t.glap004
   DEFINE l_amt1          LIKE glaq_t.glaq003
   DEFINE l_amt2          LIKE glaq_t.glaq003
   DEFINE l_amt3          LIKE glaq_t.glaq003
   DEFINE l_sum1          LIKE glaq_t.glaq003
   DEFINE l_sum2          LIKE glaq_t.glaq003
   DEFINE l_sum3          LIKE glaq_t.glaq003
   DEFINE l_glbcseq       LIKE glbc_t.glbcseq
   DEFINE l_glbcseq1      LIKE glbc_t.glbcseq1
   DEFINE l_glbc004       LIKE glbc_t.glbc004
   DEFINE l_nmaistus      LIKE nmai_t.nmaistus
   DEFINE l_glaa005       LIKE glaa_t.glaa005
   DEFINE l_success       LIKE type_t.num5
   DEFINE l_red           LIKE type_t.chr1
   DEFINE l_slip          STRING
   DEFINE l_glapcomp      LIKE glap_t.glapcomp
   DEFINE l_glaa001       LIKE glaa_t.glaa001
   DEFINE l_glad034       LIKE glad_t.glad034
   DEFINE l_efin5001      LIKE type_t.chr1
   DEFINE l_ooba002       LIKE ooba_t.ooba002
   DEFINE l_glapcrtid     LIKE glap_t.glapcrtid
   DEFINE l_glap001       LIKE glap_t.glap001   #151204-00001#1 add
   #151223-00004#1--add--str--lujh
   DEFINE l_glap007       LIKE glap_t.glap007   
   DEFINE l_glaa122       LIKE glaa_t.glaa122   
   DEFINE l_glac016       LIKE glac_t.glac016
   #151223-00004#1--add--end--lujh
   DEFINE l_hsx           DYNAMIC ARRAY OF VARCHAR(30) #160729-00009#1 add
   DEFINE l_glaq002_o     LIKE glaq_t.glaq002   #161205-00025#4 add
   DEFINE l_glaq005_o     LIKE glaq_t.glaq005   #161205-00025#4 add
   DEFINE l_glaq017_o     LIKE glaq_t.glaq017   #161205-00025#4 add
   
   WHENEVER ERROR CONTINUE
   LET r_success = TRUE
   #初始化数组
   INITIALIZE g_glaq.* TO NULL
   #资料检查
   #(1).传入参数为空，返回
   #170816-00007#130 by 09773 mod(S)
#   IF cl_null(p_glapld) OR cl_null(p_glapdocno) THEN
#      LET r_success = FALSE
##      CALL cl_errmsg('conf_chk',p_glapdocno,'','sub-00110',1)
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.extend = p_glapdocno
#      LET g_errparam.code   = 'sub-00110'
#      LET g_errparam.popup  = TRUE 
#      CALL cl_err()
#   END IF
   #170816-00007#130 by 09773 mod(E)
   
   #170816-00007#130 by 09773 add(S)
   #修改錯誤訊息報錯內容
   LET g_msg = ''
   LET g_colname_1 = ''
   LET g_comment_1 = ''
   IF cl_null(p_glapld) THEN
      CALL s_azzi902_get_gzzd("aapi511","lbl_glabld") RETURNING g_colname_1,g_comment_1  #賬套 
      LET g_msg = g_colname_1   
   END IF
   IF cl_null(p_glapdocno) THEN
      LET g_colname_1 = ''
      LET g_comment_1 = ''    
      CALL s_azzi902_get_gzzd("aglt310_07","lbl_glapdocno") RETURNING g_colname_1,g_comment_1   #單號
      IF g_msg IS NULL THEN   
         LET g_msg = g_colname_1   
      ELSE   
         LET g_msg = g_msg,",",g_colname_1
      END IF        
   END IF
   IF NOT cl_null(g_msg) THEN
      LET r_success = FALSE
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code = 'sub-00788'  #%1傳入值為空(錯誤)
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_msg 
      CALL cl_err()
   END IF   
   #170816-00007#130 by 09773 add(E)
   
   #抓取状态码，科目，借贷金额   
   LET l_glapdocdt=''
   LET l_glapstus =''
   LET l_glap006=''
   LET l_glap010=''
   LET l_glap011=''
   SELECT glapcomp,glapdocdt,glapstus,glap006,glap010,glap011,glap002,glap004,glapcrtid
          ,glap001,glap007  #151204-00001#1 add glap001   
     INTO l_glapcomp,l_glapdocdt,l_glapstus,l_glap006,l_glap010,l_glap011,l_glap002,l_glap004,l_glapcrtid
          ,l_glap001,l_glap007 #151204-00001#1 add l_glap001    #151223-00004#1 add lujh
     FROM glap_t
    WHERE glapent = g_enterprise
      AND glapld = p_glapld
      AND glapdocno = p_glapdocno
   #(2).狀態碼=開立,才可進行確認動作   
   #IF l_glapstus <>'N' THEN              #160308-00010#25 mark
   IF l_glapstus NOT MATCHES '[NA]' THEN  #160308-00010#25 add
      LET r_success = FALSE
#      CALL cl_errmsg('glapstus',p_glapdocno,'','agl-00052',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code   = 'agl-00052'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
   END IF 
   
   #根據參數判斷，資料建立者和確認者為同一人才可確認
   #150602-00057#2 by 02291 add
   CALL s_aooi200_fin_get_slip(p_glapdocno) RETURNING l_success,l_ooba002
   CALL s_fin_chk_E5001(p_glapld,l_glapcomp,l_ooba002) RETURNING l_efin5001
   IF l_efin5001 = 'N' THEN
      IF l_glapcrtid = g_user THEN
         LET r_success = FALSE
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'axr-00346'
         LET g_errparam.extend = ''
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
   END IF   
   #150602-00057#2 by 02291 add
   
   #(3).借貸方金額應相等,并且需和单身借贷方金额总和相等
   SELECT SUM(glaq003),SUM(glaq004),SUM(glaq040),SUM(glaq041),SUM(glaq043),SUM(glaq044)
     INTO l_glaq003,l_glaq004,l_glaq040,l_glaq041,l_glaq043,l_glaq044
     FROM glaq_t
    WHERE glaqent = g_enterprise
      AND glaqld  = p_glapld
      AND glaqdocno = p_glapdocno
   
   IF l_glap010 <> l_glap011 OR l_glap010<>l_glaq003 OR l_glap011<>l_glaq004 THEN
      LET r_success = FALSE
#      CALL cl_errmsg('glapstus',p_glapdocno,'','agl-00033',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code   = 'agl-00033'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
   END IF
   #本位幣二、本位幣三借貸平衡檢查
#161205-00025#4--mod--str--
#   SELECT glaa004,glaa015,glaa019,glaa122 INTO l_glaa004,l_glaa015,l_glaa019,l_glaa122   #151223-00004#1 add l_glaa122 lujh
   SELECT glaa004,glaa015,glaa019,glaa122,glaa001,glaa005 
     INTO l_glaa004,l_glaa015,l_glaa019,l_glaa122,l_glaa001,l_glaa005
#161205-00025#4--mod--end
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald = p_glapld 
   IF l_glaa015='Y' AND l_glaq040<>l_glaq041 THEN
#      CALL cl_errmsg('glapstus',p_glapdocno,'','agl-00217',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code   = 'agl-00217'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      LET r_success = FALSE
   END IF
   IF l_glaa019='Y' AND l_glaq043<>l_glaq044 THEN
#      CALL cl_errmsg('glapstus',p_glapdocno,'','agl-00218',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code   = 'agl-00218'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      LET r_success = FALSE
   END IF 
   
   #檢查當單據日期小於等於關帳日期時，不可異動單據
   IF l_glap001 <> '6' THEN #151204-00001#1 add
      CALL s_fin_date_close_chk(p_glapld,'','AGL',l_glapdocdt) RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
      END IF
   END IF #151204-00001#1 add
   
  #(4).#单身存盘及确认时应判断, 营运组织核算项若为核算组织(ooef204='Y'),则本张凭证以该组织角度来看应借贷平衡
#161205-00025#4--mod--str--
#   LET l_sql = " SELECT DISTINCT glaq017 FROM glaq_t ",
   LET l_sql = " SELECT glaq017,SUM(glaq003),SUM(glaq004),SUM(glaq040),SUM(glaq041),SUM(glaq043),SUM(glaq044) ",
               "   FROM glaq_t ",
#161205-00025#4--mod--end
               "  WHERE glaqent = ",g_enterprise,"",
               "    AND glaqld = '",p_glapld,"'",
               "    AND glaqdocno = '",p_glapdocno,"'",
               "    AND glaq017 IN (SELECT ooef001 FROM ooef_t WHERE ooefent = ",g_enterprise," AND ooef204 = 'Y')"  
              ,"  GROUP BY glaq017 " #161205-00025#4 add
   PREPARE s_voucher_glaq017_pre  FROM l_sql
   DECLARE s_voucher_glaq017_cs CURSOR FOR s_voucher_glaq017_pre
   FOREACH s_voucher_glaq017_cs INTO l_glaq017
                                    ,l_glaq003,l_glaq004,l_glaq040,l_glaq041,l_glaq043,l_glaq044 #161205-00025#4 add
       IF SQLCA.SQLCODE THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code = sqlca.sqlcode
          LET g_errparam.extend = ''
          LET g_errparam.popup = FALSE
          CALL cl_err()

          EXIT FOREACH
       END IF
#161205-00025#4--mark--str--
#       LET l_glaq003 = 0 
#       LET l_glaq004 = 0
#       LET l_glaq040 = 0
#       LET l_glaq041 = 0
#       LET l_glaq043 = 0
#       LET l_glaq044 = 0
#       
#       SELECT SUM(glaq003),SUM(glaq004),SUM(glaq040),SUM(glaq041),SUM(glaq043),SUM(glaq044) 
#         INTO l_glaq003,l_glaq004,l_glaq040,l_glaq041,l_glaq043,l_glaq044  
#         FROM glaq_t
#        WHERE glaqent = g_enterprise
#          AND glaqld = g_glap_m.glapld
#          AND glaqdocno = g_glap_m.glapdocno 
#          AND glaq017 = l_glaq017
#161205-00025#4--mark--end
       IF l_glaq003 <> l_glaq004 THEN
#          CALL cl_errmsg('glaq017',l_glaq017,'','agl-00166',1)
          INITIALIZE g_errparam TO NULL
          LET g_errparam.extend = l_glaq017
          LET g_errparam.code   = 'agl-00166'
          LET g_errparam.popup  = TRUE 
          CALL cl_err()
          LET r_success = FALSE
       END IF
       #本位幣二
       IF l_glaa015='Y' THEN
          IF l_glaq040 <> l_glaq041 THEN
#             CALL cl_errmsg('glaq017',l_glaq017,'','agl-00225',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_glaq017
             LET g_errparam.code   = 'agl-00225'
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
             LET r_success = FALSE
          END IF
       END IF
       #本位幣三
       IF l_glaa019='Y' THEN
          IF l_glaq043 <> l_glaq044 THEN
#             CALL cl_errmsg('glaq017',l_glaq017,'','agl-00226',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_glaq017
             LET g_errparam.code   = 'agl-00226'
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
             LET r_success = FALSE
          END IF
       END IF
   END FOREACH
      
　 #(5).有單頭資料但無單身資料返回报错
   LET l_cnt = 0
#   SELECT count(*) INTO l_cnt FROM glaq_t #161205-00025#4 mark
   SELECT COUNT(1) INTO l_cnt FROM glaq_t #161205-00025#4 add
    WHERE glaqent = g_enterprise
      AND glaqld  = p_glapld
      AND glaqdocno = p_glapdocno
   IF l_cnt = 0  THEN
      LET r_success = FALSE
#      CALL cl_errmsg('',p_glapdocno,'','agl-00066',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code   = 'agl-00066'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
   END IF 

　 #(6).科目性質不為帳戶,不為明細或獨立帳戶,或者科目无效，则返回报错
   IF NOT cl_null(l_glap006) THEN
      CALL s_voucher_glaq002_chk(p_glapld,l_glap006)
      IF NOT cl_null(g_errno) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glap006',p_glapdocno,l_glap006,g_errno,1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = p_glapdocno,"/",l_glap006
         LET g_errparam.code   = g_errno
         #160321-00016#19 --s add
         LET g_errparam.replace[1] = 'agli030'
         LET g_errparam.replace[2] = cl_get_progname('agli030',g_lang,"2")
         LET g_errparam.exeprog = 'agli030'
         #160321-00016#19 --e add
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      END IF 
   END IF 
  
　 #(7).单身科目无效，性質不為帳戶,不為明細或獨立帳戶,则返回报错
   #業務信息頁籤的欄位,若有輸入值,應檢查其對應基本資料的合理性
   #固定核算項及自由核算的欄位,應檢查若科目有啟用該核算項時,其對應基本資料的合理性   
   LET l_glaq002 = ''
   #判斷是否採用紅字傳票，當採用紅字傳票時，金額才可以為負數
   LET l_red = 'N'
   CALL s_aooi200_fin_get_slip(p_glapdocno) RETURNING l_success,l_slip
   IF l_success = TRUE THEN
      #獲取單據別對應參數：紅字傳票否
      CALL cl_get_doc_para(g_enterprise,l_glapcomp,l_slip,'D-FIN-1002') RETURNING l_red
   END IF 
   #本幣
#   SELECT glaa001 INTO l_glaa001 FROM glaa_t WHERE glaaent=g_enterprise AND glaald=p_glapld #161205-00025#4 add
   LET l_sql = " SELECT glaqseq,glaq002,glaq003,glaq004,",
               "        glaq005,glaq006,glaq007,glaq008,glaq009,glaq010,",
               "        glaq011,glaq012,glaq013,glaq014,glaq015,glaq016,",
               "        glaq017,glaq018,glaq019,glaq020,glaq021,glaq022,",
               "        glaq023,glaq024,glaq025,glaq027,glaq028,",
               "        glaq029,glaq030,glaq031,glaq032,glaq033,glaq034,",
               "        glaq035,glaq036,glaq037,glaq038,glaq051,glaq052,glaq053 ",
               #161205-00025#4--add--str--
               "       ,glad034,glad007,glad008,glad009,glad010,glad027,glad011,",
               "        glad012,glad013,glad015,glad016,glad031,glad032,glad033, ", 
               "        glad017,glad0171,glad0172,glad018,glad0181,glad0182,glad019,glad0191,glad0192,",
               "        glad020,glad0201,glad0202,glad021,glad0211,glad0212,glad022,glad0221,glad0222,",
               "        glad023,glad0231,glad0232,glad024,glad0241,glad0242,glad025,glad0251,glad0252,",
               "        glad026,glad0261,glad0262",
               #161205-00025#4--add--end
               "       ,glac016 ", #170617-00334#1 add
               "  FROM glaq_t ",
               "  LEFT JOIN glad_t ON gladent=glaqent AND gladld=glaqld AND glad001=glaq002 ", #161205-00025#4 add
               "  LEFT JOIN glac_t ON glacent=glaqent AND glac001='",l_glaa004,"' AND glac002=glaq002 ", #170617-00334#1 add
               #" WHERE glaqent = '",g_enterprise,"'", #170615-00061#25 mark
               " WHERE glaqent = ",g_enterprise," ",   #170615-00061#25 add
               "   AND glaqld = '",p_glapld,"'",
               "   AND glaqdocno = '",p_glapdocno,"'"
              ," ORDER BY glaq002,glaq005,glaq017 " #161205-00025#4 add
   PREPARE s_voucher_pre1 FROM l_sql
   DECLARE s_voucher_cur1 CURSOR FOR s_voucher_pre1
   
   LET l_glaq002_o = '' #161205-00025#4 add
   LET l_glaq005_o = '' #161205-00025#4 add
   LET l_glaq017_o = '' #161205-00025#4 add
   
   FOREACH s_voucher_cur1 INTO l_glaqseq,l_glaq002,g_glaq.glaq003,g_glaq.glaq004,
                               g_glaq.glaq005,g_glaq.glaq006,g_glaq.glaq007,g_glaq.glaq008,g_glaq.glaq009,g_glaq.glaq010,
                               g_glaq.glaq011,g_glaq.glaq012,g_glaq.glaq013,g_glaq.glaq014,g_glaq.glaq015,g_glaq.glaq016,
                               g_glaq.glaq017,g_glaq.glaq018,g_glaq.glaq019,g_glaq.glaq020,g_glaq.glaq021,g_glaq.glaq022,
                               g_glaq.glaq023,g_glaq.glaq024,g_glaq.glaq025,g_glaq.glaq027,g_glaq.glaq028,
                               g_glaq.glaq029,g_glaq.glaq030,g_glaq.glaq031,g_glaq.glaq032,g_glaq.glaq033,g_glaq.glaq034,
                               g_glaq.glaq035,g_glaq.glaq036,g_glaq.glaq037,g_glaq.glaq038,
                               g_glaq.glaq051,g_glaq.glaq052,g_glaq.glaq053  
                               #161205-00025#4--add--str--
                              ,l_glad034,l_glad007,l_glad008,l_glad009,l_glad010,l_glad027,l_glad011,
                               l_glad012,l_glad013,l_glad015,l_glad016,l_glad031,l_glad032,l_glad033,
                               l_glad017,l_glad0171,l_glad0172,l_glad018,l_glad0181,l_glad0182,l_glad019,l_glad0191,l_glad0192,
                               l_glad020,l_glad0201,l_glad0202,l_glad021,l_glad0211,l_glad0212,l_glad022,l_glad0221,l_glad0222,
                               l_glad023,l_glad0231,l_glad0232,l_glad024,l_glad0241,l_glad0242,l_glad025,l_glad0251,l_glad0252,
                               l_glad026,l_glad0261,l_glad0262
                               #161205-00025#4--add--end
                              ,l_glac016 #170617-00334#1 add
       IF SQLCA.sqlcode THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code = SQLCA.sqlcode
          LET g_errparam.extend = 'foreach:'
          LET g_errparam.popup = TRUE
          CALL cl_err()

          EXIT FOREACH
       END IF
       
       #组合报错信息
       LET l_msg = p_glapdocno||'/'||l_glaqseq
       LET l_msg1 = p_glapdocno||'/'||l_glaqseq||'/'||l_glaq002
       #科目
       IF NOT cl_null(l_glaq002) THEN
          IF cl_null(l_glaq002_o) OR l_glaq002_o <> l_glaq002 THEN #161205-00025#4 add
             CALL s_voucher_glaq002_chk(p_glapld,l_glaq002)
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq002',l_errmsg,'',g_errno,1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code   = g_errno
                #160321-00016#19 --s add
                LET g_errparam.replace[1] = 'agli030'
                LET g_errparam.replace[2] = cl_get_progname('agli030',g_lang,"2")
                LET g_errparam.exeprog = 'agli030'
                #160321-00016#19 --e add
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
             LET l_glaq002_o = l_glaq002 #161205-00025#4 add 
          END IF #161205-00025#4 add           
       END IF
       
       #151223-00004#1--add--str--lujh
#       CALL s_voucher_glac016_get(l_glaa004,l_glaq002) RETURNING l_glac016 #170617-00334#1 mark
        
       IF l_glap007 = 'GL' AND l_glac016 = 'Y'  AND l_glaa122 = 'Y'  THEN 
          IF cl_null(g_glaq.glaq014) OR cl_null(g_glaq.glaq015) OR cl_null(g_glaq.glaq016) THEN 
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = 'agl-00417'
             LET g_errparam.extend = l_glaq002
             LET g_errparam.popup = TRUE
             CALL cl_err()
             LET r_success = FALSE
          END IF
       END IF
       #151223-00004#1--add--end--lujh
       
       #金額
       IF cl_null(g_glaq.glaq003) THEN LET g_glaq.glaq003 = 0 END IF
       IF cl_null(g_glaq.glaq004) THEN LET g_glaq.glaq004 = 0 END IF
       IF g_glaq.glaq003 = 0 AND g_glaq.glaq004 = 0 THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code = 'agl-00084'
          LET g_errparam.extend = l_msg
          LET g_errparam.popup = TRUE
          CALL cl_err()
          LET r_success = FALSE
       END IF
       #170509-00094#11---mark---start---
       #採用紅字傳票是由子系統判斷不該由總帳判斷
       ##當不採用紅字傳票時，金額不可為負數
       #IF l_red <> 'Y' AND (g_glaq.glaq003 <0 OR g_glaq.glaq004 <0) THEN
       #   INITIALIZE g_errparam TO NULL
       #   LET g_errparam.code = 'aim-00009'
       #   LET g_errparam.extend = l_msg
       #   LET g_errparam.popup = TRUE
       #   CALL cl_err()
       #   LET r_success = FALSE
       #END IF 
       #170509-00094#11---mark---end---
       #============================       
       #业务咨询检查
       #============================
       #币种
       IF NOT cl_null(g_glaq.glaq005) THEN 
          IF cl_null(l_glaq005_o) OR l_glaq005_o <> g_glaq.glaq005 THEN #161205-00025#4 add
             CALL s_voucher_glaq005_chk(g_glaq.glaq005)
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq005',l_errmsg,g_glaq.glaq005,g_errno,1)
                LET l_errmsg = l_msg||'/'||g_glaq.glaq005
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = g_errno
                #160321-00016#19 --s add
                LET g_errparam.replace[1] = 'aooi140'
                LET g_errparam.replace[2] = cl_get_progname('aooi140',g_lang,"2")
                LET g_errparam.exeprog = 'aooi140'
                #160321-00016#19 --e add
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF 
             LET l_glaq005_o = g_glaq.glaq005 #161205-00025#4 add 
          END IF #161205-00025#4 add 
          
          #當科目不採用多幣別時，幣別只可等於本幣
#161205-00025#4--mark--str--
#          SELECT glad034 INTO l_glad034 FROM glad_t 
#           WHERE gladent=g_enterprise AND gladld=p_glapld AND glad001=l_glaq002
#161205-00025#4--mark--end
          IF l_glad034 = 'N' AND g_glaq.glaq005 <> l_glaa001 THEN
             LET r_success = FALSE
             LET l_errmsg = l_msg||'/'||g_glaq.glaq005
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = 'agl-00316'
             LET g_errparam.extend = l_errmsg
             LET g_errparam.popup = TRUE
             CALL cl_err()
          END IF
          
       END IF 
       #汇率
       IF NOT cl_null(g_glaq.glaq006) THEN
          CALL s_voucher_num_chk(g_glaq.glaq006)
          IF NOT cl_null(g_errno) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glaq006',l_errmsg,g_glaq.glaq006,g_errno,1)
             LET l_errmsg = l_msg||'/'||g_glaq.glaq006
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_errmsg
             LET g_errparam.code   = g_errno
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
          #當幣別等於本幣時要求匯率必須等於1
          IF g_glaq.glaq005 = l_glaa001 AND g_glaq.glaq006 <> 1 THEN
             LET r_success = FALSE
             LET l_errmsg = l_msg||'/'||g_glaq.glaq006
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = 'agl-00327'
             LET g_errparam.extend = l_errmsg
             LET g_errparam.popup = TRUE
             CALL cl_err()
          END IF
       END IF 
       
       #计价单位
       IF NOT cl_null(g_glaq.glaq007) THEN 
          CALL s_voucher_glaq007_chk(g_glaq.glaq007)
          IF NOT cl_null(g_errno) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glaq007',l_errmsg,g_glaq.glaq007,g_errno,1)
             LET l_errmsg = l_msg||'/'||g_glaq.glaq007
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_errmsg
             LET g_errparam.code   = g_errno
             #160321-00016#19 --s add
             LET g_errparam.replace[1] = 'aooi250'
             LET g_errparam.replace[2] = cl_get_progname('aooi250',g_lang,"2")
             LET g_errparam.exeprog = 'aooi250'
             #160321-00016#19 --e add
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF 
       END IF 
       
       #数量
       IF NOT cl_null(g_glaq.glaq008) THEN
           CALL s_voucher_num_chk(g_glaq.glaq008)
           IF NOT cl_null(g_errno) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glaq008',l_errmsg,g_glaq.glaq008,g_errno,1)
             LET l_errmsg = l_msg||'/'||g_glaq.glaq008
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_errmsg
             LET g_errparam.code   = g_errno
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF 
        END IF 
       #单价
       IF NOT cl_null(g_glaq.glaq009) THEN
          CALL s_voucher_num_chk(g_glaq.glaq009)
          IF NOT cl_null(g_errno) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glaq009',l_errmsg,g_glaq.glaq009,g_errno,1)
             LET l_errmsg = l_msg||'/'||g_glaq.glaq009
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_errmsg
             LET g_errparam.code   = g_errno
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF 
        END IF 
       #金额
      #IF NOT cl_null(g_glaq.glaq010) THEN
      #   CALL s_voucher_num_chk(g_glaq.glaq010)
      #   IF NOT cl_null(g_errno) THEN
      #      LET r_success = FALSE
      #      CALL cl_errmsg('glaq010',l_errmsg,g_glaq.glaq010,g_errno,1)
      #   END IF 
      # END IF 
        
       #申请人
       IF NOT cl_null(g_glaq.glaq013) THEN 
          CALL s_voucher_glaq013_chk(g_glaq.glaq013)
          IF NOT cl_null(g_errno) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glaq013',l_errmsg,g_glaq.glaq013,g_errno,1)
             LET l_errmsg = l_msg||'/'||g_glaq.glaq013
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_errmsg
             LET g_errparam.code   = g_errno
             #160321-00016#19 --s add
             LET g_errparam.replace[1] = 'aooi130'
             LET g_errparam.replace[2] = cl_get_progname('aooi130',g_lang,"2")
             LET g_errparam.exeprog = 'aooi130'
             #160321-00016#19 --e add
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF 
       END IF
       #营运据点检查   
       IF NOT cl_null(g_glaq.glaq017) THEN 
          IF cl_null(l_glaq017_o) OR l_glaq017_o <> g_glaq.glaq017 THEN #161205-00025#4 add
             CALL s_voucher_glaq017_chk(g_glaq.glaq017)
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq017',l_errmsg,g_glaq.glaq017,g_errno,1)
                LET l_errmsg = l_msg||'/'||g_glaq.glaq017
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = g_errno
                LET g_errparam.popup  = TRUE 
                #160321-00016#1--s
                LET g_errparam.replace[1]='aooi100'
                LET g_errparam.replace[2] = cl_get_progname('aooi100',g_lang,"2")
                LET g_errparam.exeprog  = "aooi100"             
                #160321-00016#1--e
                CALL cl_err()
             END IF 
             LET l_glaq017_o = g_glaq.glaq017 #161205-00025#4 add
          END IF #161205-00025#4 add
       ELSE
          LET r_success = FALSE
#          CALL cl_errmsg('glaq017',l_errmsg,g_glaq.glaq017,'agl-00291',1)
          INITIALIZE g_errparam TO NULL
          LET g_errparam.extend = l_msg1
          LET g_errparam.code   = 'agl-00291'
          LET g_errparam.popup  = TRUE 
          CALL cl_err()
       END IF
       ################################################################################################
       #依據帳別，科目編號，判斷該科目是否启用
       #部門管理， 利潤成本中心管理，區域管理，交易客商管理，客群管理，產品類別，人員，預算，專案，wbs管理，账款客商管理，自由核算项1~10
#161205-00025#4--mark--str--
#       #1.清空核算项管理值
#       LET l_glad007 = ''  LET l_glad008 = ''  LET l_glad009 = ''  LET l_glad010 = ''  LET l_glad027 = ''   LET l_glad011 = ''
#       LET l_glad012 = ''  LET l_glad013 = ''  LET l_glad015 = ''  LET l_glad016 = ''  LET l_glad031 = ''   LET l_glad032 = ''  LET l_glad033 = ''   
#       LET l_glad017 = ''  LET l_glad0171 =''  LET l_glad0172 = '' LET l_glad018 = ''  LET l_glad0181 = ''  LET l_glad0182 = ''   
#       LET l_glad019 = ''  LET l_glad0191 =''  LET l_glad0192 = '' LET l_glad020 = ''  LET l_glad0201 = ''  LET l_glad0202 = ''
#       LET l_glad021 = ''  LET l_glad0211 =''  LET l_glad0212 = '' LET l_glad022 = ''  LET l_glad0221 = ''  LET l_glad0222 = ''
#       LET l_glad023 = ''  LET l_glad0231 =''  LET l_glad0232 = '' LET l_glad024 = ''  LET l_glad0241 = ''  LET l_glad0242 = ''
#       LET l_glad025 = ''  LET l_glad0251 =''  LET l_glad0252 = '' LET l_glad026 = ''  LET l_glad0261 = ''  LET l_glad0262 = ''
#       #2.重新依账套，科目抓取核算项管理值(细部核算项)
#       CALL s_voucher_fix_acc_open_chk(p_glapld,l_glaq002)
#       RETURNING l_glad007,l_glad008,l_glad009,l_glad010,l_glad027,l_glad011,l_glad012,l_glad013,l_glad015,l_glad016,l_glad031,l_glad032,l_glad033
#       
#       #自由核算项
#       SELECT glad017,glad0171,glad0172,glad018,glad0181,glad0182,glad019,glad0191,glad0192,
#              glad020,glad0201,glad0202,glad021,glad0211,glad0212,glad022,glad0221,glad0222,
#              glad023,glad0231,glad0232,glad024,glad0241,glad0242,glad025,glad0251,glad0252,
#              glad026,glad0261,glad0262              
#         INTO l_glad017,l_glad0171,l_glad0172,l_glad018,l_glad0181,l_glad0182,l_glad019,l_glad0191,l_glad0192,
#              l_glad020,l_glad0201,l_glad0202,l_glad021,l_glad0211,l_glad0212,l_glad022,l_glad0221,l_glad0222,
#              l_glad023,l_glad0231,l_glad0232,l_glad024,l_glad0241,l_glad0242,l_glad025,l_glad0251,l_glad0252,
#              l_glad026,l_glad0261,l_glad0262
#         FROM glad_t
#        WHERE gladent = g_enterprise
#          AND gladld = p_glapld
#          AND glad001 =l_glaq002
#161205-00025#4--mark--end                          
       #======================================
       #固定核算项检查
       #如果启用改固定核算项勾选，则对该核算项的值进行检查
       #======================================  
       #該科目做部門管理時，部門不可空白  
       IF l_glad007 = 'Y' THEN
          IF cl_null(g_glaq.glaq018) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glaq018',l_errmsg,'','agl-00043',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00043"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             #部门检查          
             CALL s_department_chk(g_glaq.glaq018,l_glapdocdt) RETURNING l_success
             IF l_success = FALSE THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq018',l_errmsg,'',g_errno,1)
#                LET l_errmsg = l_msg||'/'||g_glaq.glaq018
#                INITIALIZE g_errparam TO NULL
#                LET g_errparam.extend = l_errmsg
#                LET g_errparam.code   = g_errno
#                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
          END IF
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq018 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq018 <> ' ' OR g_glaq.glaq018 IS NULL THEN #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end
       END IF
      
       #該科目做利潤成本管理時，利潤成本不可空白  
       IF l_glad008 = 'Y'  THEN
          IF cl_null(g_glaq.glaq019) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glaq019',l_errmsg,'','agl-00044',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00044"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             #利润成本中心检查         
             CALL s_voucher_glaq019_chk(g_glaq.glaq019,l_glapdocdt) 
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq019',l_errmsg,'',g_errno,1)
                LET l_errmsg = l_msg||'/'||g_glaq.glaq019
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = g_errno
                #160321-00016#19 --s add
                LET g_errparam.replace[1] = 'aooi125'
                LET g_errparam.replace[2] = cl_get_progname('aooi125',g_lang,"2")
                LET g_errparam.exeprog = 'aooi125'
                #160321-00016#19 --e add
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
          END IF
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq019 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq019 <> ' ' OR g_glaq.glaq019 IS NULL THEN #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end
       END IF 
       
       #該科目做區域管理時，區域不可空白  
       IF l_glad009 = 'Y'  THEN
          IF cl_null(g_glaq.glaq020) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glaq020',l_errmsg,'','agl-00045',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00045"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE 
             #区域检查
             CALL s_azzi650_chk_exist('287',g_glaq.glaq020) RETURNING l_success
             IF NOT l_success THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq020',l_errmsg,'',g_errno,1)
#                LET l_errmsg = l_msg||'/'||g_glaq.glaq020
#                INITIALIZE g_errparam TO NULL
#                LET g_errparam.extend = l_errmsg
#                LET g_errparam.code   = g_errno
#                LET g_errparam.popup  = TRUE 
#                CALL cl_err()
             END IF
          END IF
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq020 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq020 <> ' ' OR g_glaq.glaq020 IS NULL THEN #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end
       END IF 
       
       #該科目做交易客商管理時，客商不可空白  
       IF l_glad010 = 'Y'  THEN
          IF cl_null(g_glaq.glaq021) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glaq021',l_errmsg,'','agl-00046',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00046"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             #客商检查
             CALL s_voucher_glaq021_chk(g_glaq.glaq021)
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq021',l_errmsg,'',g_errno,1)
                LET l_errmsg = l_msg||'/'||g_glaq.glaq021
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = g_errno
                #160321-00016#19 --s add
                LET g_errparam.replace[1] = 'apmm100'
                LET g_errparam.replace[2] = cl_get_progname('apmm100',g_lang,"2")
                LET g_errparam.exeprog = 'apmm100'
                #160321-00016#19 --e add
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF 
          END IF
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq021 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq021 <> ' ' OR g_glaq.glaq021 IS NULL THEN #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end
       END IF 
       
       #該科目做账款客商管理時，客商不可空白
       IF l_glad027 = 'Y'  THEN
          IF cl_null(g_glaq.glaq022) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glaq022',l_errmsg,'','axr-00215',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "axr-00215"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             #客商检查
             CALL s_voucher_glaq021_chk(g_glaq.glaq022)
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq022',l_errmsg,'',g_errno,1)
                LET l_errmsg = l_msg||'/'||g_glaq.glaq022
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = g_errno
                #160321-00016#19 --s add
                LET g_errparam.replace[1] = 'apmm100'
                LET g_errparam.replace[2] = cl_get_progname('apmm100',g_lang,"2")
                LET g_errparam.exeprog = 'apmm100'
                #160321-00016#19 --e add
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
          END IF
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq022 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq022 <> ' ' OR g_glaq.glaq022 IS NULL THEN #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end
       END IF 
       
       #該科目做客群管理時，客群不可空白  
       IF l_glad011 = 'Y'  THEN
          IF cl_null(g_glaq.glaq023) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glaq023',l_errmsg,'','agl-00047',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00047"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             #客群检查
             CALL s_azzi650_chk_exist('281',g_glaq.glaq023) RETURNING l_success
             IF NOT l_success THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq023',l_errmsg,'',g_errno,1)
#                LET l_errmsg = l_msg||'/'||g_glaq.glaq023
#                INITIALIZE g_errparam TO NULL
#                LET g_errparam.extend = l_errmsg
#                LET g_errparam.code   = g_errno
#                LET g_errparam.popup  = TRUE 
#                CALL cl_err()
             END IF
          END IF
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq023 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq023 <> ' ' OR g_glaq.glaq023 IS NULL THEN #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end
       END IF 
       
       #該科目做產品分類管理時，不可空白  
       IF l_glad012 = 'Y'  THEN
          IF cl_null(g_glaq.glaq024) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glaq024',l_errmsg,'','agl-00068',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00068"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             #产品分类检查 
             CALL s_voucher_glaq024_chk(g_glaq.glaq024)
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq024',l_errmsg,'',g_errno,1)
                LET l_errmsg = l_msg||'/'||g_glaq.glaq024
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = g_errno
                #160321-00016#19 --s add
                LET g_errparam.replace[1] = 'arti202'
                LET g_errparam.replace[2] = cl_get_progname('arti202',g_lang,"2")
                LET g_errparam.exeprog = 'arti202'
                #160321-00016#19 --e add
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
          END IF
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq024 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq024 <> ' ' OR g_glaq.glaq024 IS NULL THEN #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end
       END IF 
       
       #該科目做經營方式管理時，不可空白  
       IF l_glad031 = 'Y'  THEN
          IF cl_null(g_glaq.glaq051) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glaq051',l_errmsg,'','agl-00286',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00286"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             #經營方式检查
             CALL s_voucher_glaq051_chk(g_glaq.glaq051)
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq051',l_errmsg,'',g_errno,1)
                LET l_errmsg = l_msg||'/'||g_glaq.glaq051
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = g_errno
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
          END IF
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq051 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq051 <> ' ' OR g_glaq.glaq051 IS NULL THEN #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end
       END IF
       
       #該科目做渠道管理時，不可空白  
       IF l_glad032 = 'Y'  THEN
          IF cl_null(g_glaq.glaq052) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glaq052',l_errmsg,'','agl-00287',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00287"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             #渠道检查
             CALL s_voucher_glaq052_chk(g_glaq.glaq052)
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq052',l_errmsg,'',g_errno,1)
                LET l_errmsg = l_msg||'/'||g_glaq.glaq052
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = g_errno
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
         END IF
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq052 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq052 <> ' ' OR g_glaq.glaq052 IS NULL THEN #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end
       END IF
       
       #該科目做品牌管理時，不可空白  
       IF l_glad033 = 'Y'  THEN
          IF cl_null(g_glaq.glaq053) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glaq053',l_errmsg,'','agl-00288',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00288"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             #品牌检查
             CALL s_azzi650_chk_exist('2002',g_glaq.glaq053) RETURNING l_success
             IF NOT l_success THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq053',l_errmsg,'',g_errno,1)
#                LET l_errmsg = l_msg||'/'||g_glaq.glaq053
#                INITIALIZE g_errparam TO NULL
#                LET g_errparam.extend = l_errmsg
#                LET g_errparam.code   = g_errno
#                LET g_errparam.popup  = TRUE 
#                CALL cl_err()
             END IF 
          END IF
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq053 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq053 <> ' ' OR g_glaq.glaq053 IS NULL THEN #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end
       END IF
       
       #該科目做人員管理時，不可空白  
       IF l_glad013 = 'Y'  THEN
          IF cl_null(g_glaq.glaq025) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glaq025',l_errmsg,'','agl-00069',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00069"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             #人员检查
             CALL s_employee_chk(g_glaq.glaq025) RETURNING l_success
             IF NOT l_success THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq025',l_errmsg,'',g_errno,1)
#                LET l_errmsg = l_msg||'/'||g_glaq.glaq025
#                INITIALIZE g_errparam TO NULL
#                LET g_errparam.extend = l_errmsg
#                LET g_errparam.code   = g_errno
#                LET g_errparam.popup  = TRUE 
#                CALL cl_err()
             END IF 
          END IF
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq025 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq025 <> ' ' OR g_glaq.glaq025 IS NULL THEN #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end
       END IF 
       
#       #該科目做預算管理時，不可空白  
#       IF l_glad014 = 'Y'  THEN
#          IF cl_null(g_glaq.glaq026) THEN
#             LET r_success = FALSE
#            CALL cl_errmsg('glaq026',l_errmsg,'','agl-00070',1)
#          END IF
#          #预算检查
#          CALL s_voucher_glaq026_chk(g_glaq.glaq026)
#          IF NOT cl_null(g_errno) THEN
#             LET r_success = FALSE
#             CALL cl_errmsg('glaq026',l_errmsg,'',g_errno,1)
#          END IF           
#       END IF
       
       #該科目做專案管理時，不可空白  
       IF l_glad015 = 'Y'  THEN
          IF cl_null(g_glaq.glaq027) THEN
            #160902-00034#1---s---
            # LET r_success = FALSE
#           #  CALL cl_errmsg('glaq027',l_errmsg,'','agl-00071',1)
            # INITIALIZE g_errparam TO NULL
            # LET g_errparam.extend = l_msg1
            # LET g_errparam.code   = "agl-00071"
            # LET g_errparam.popup  = TRUE 
            # CALL cl_err()
            #160902-00034#1---e---
            
            #170503-00055#1--add--str--
            #当启用专案管理，但不控管是否输入值，如果没有输入值，要赋值给空格，以免过账错误
            #当为空格时，提示用户专案没有维护，但是不卡控
            IF g_glaq.glaq027 <> ' ' OR g_glaq.glaq027 IS NULL THEN
               LET r_success = FALSE
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = l_msg1
               LET g_errparam.code   = "agl-00548"
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
            ELSE
            #170503-00055#1--add--end
            
            #170111-00005#1 add(s)
            INITIALIZE g_errparam TO NULL
#            LET g_errparam.extend = ''    #170503-00055#1 mark
            LET g_errparam.extend = l_msg1 #170503-00055#1 add
            LET g_errparam.code   = "agl-00541" 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            #170111-00005#1 add(e) 
            
            END IF #170503-00055#1 add
          ELSE
             CALL s_aap_project_chk(g_glaq.glaq027) RETURNING l_success,g_errno
             IF NOT l_success THEN
                LET r_success = FALSE
                LET l_errmsg = l_msg||'/'||g_glaq.glaq027
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = g_errno
                LET g_errparam.extend = l_errmsg
                #160321-00016#19 --s add
                LET g_errparam.replace[1] = 'apjm200'
                LET g_errparam.replace[2] = cl_get_progname('apjm200',g_lang,"2")
                LET g_errparam.exeprog = 'apjm200'
                #160321-00016#19 --e add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF
          END IF 
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq027 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq027 <> ' ' OR g_glaq.glaq027 IS NULL THEN  #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end
       END IF 
       
       #該科目做WBS管理時，不可空白  
       IF l_glad016 = 'Y'  THEN
          IF cl_null(g_glaq.glaq028) THEN
             #LET r_success = FALSE #170111-00005#1 mark
#             CALL cl_errmsg('glaq028',l_errmsg,'','agl-00072',1)
             #170503-00055#1--add--str--
             #当启用专案管理，但不控管是否输入值，如果没有输入值，要赋值给空格，以免过账错误
             #当为空格时，提示用户专案没有维护，但是不卡控
             IF g_glaq.glaq028 <> ' ' OR g_glaq.glaq028 IS NULL THEN
                LET r_success = FALSE
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code   = "agl-00549"
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             ELSE
             #170503-00055#1--add--end

             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             #LET g_errparam.code   = "agl-00072" #170111-00005#1 mark
             LET g_errparam.code   = "agl-00542" #170111-00005#1 add
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
             
             END IF #170503-00055#1 add
          ELSE
             CALL s_voucher_glaq028_chk(g_glaq.glaq027,g_glaq.glaq028) 
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
                LET l_errmsg = l_msg||'/'||g_glaq.glaq028
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = g_errno
                LET g_errparam.extend = l_errmsg
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF
          END IF
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq028 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq028 <> ' ' OR g_glaq.glaq028 IS NULL THEN #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end  
       END IF
       
       #160729-00009#1--add--str--
       #对14个固定核算项进行检核是否满足agli060的设限条件
       LET l_hsx[1]=g_glaq.glaq017
       LET l_hsx[2]=g_glaq.glaq018
       LET l_hsx[3]=g_glaq.glaq019
       LET l_hsx[4]=g_glaq.glaq020
       LET l_hsx[5]=g_glaq.glaq021
       LET l_hsx[6]=g_glaq.glaq022
       LET l_hsx[7]=g_glaq.glaq023
       LET l_hsx[8]=g_glaq.glaq024
       LET l_hsx[9]=g_glaq.glaq051
       LET l_hsx[10]=g_glaq.glaq052
       LET l_hsx[11]=g_glaq.glaq053
       LET l_hsx[12]=g_glaq.glaq025
       LET l_hsx[13]=g_glaq.glaq027
       LET l_hsx[14]=g_glaq.glaq028
       CALL s_voucher_all_hsx_chk(p_glapld,l_glaq002,l_hsx) RETURNING l_success
       IF l_success = FALSE THEN
          LET r_success = FALSE
       END IF
       #160729-00009#1--add--end
       
       #===================================================
       #自由核算项检查
       #如果启用该核算项勾选，并且控制方式不为1：允许空白，则对核算项的值进行检查
       #===================================================
       #核算项一
       IF l_glad017 = 'Y' THEN
          IF l_glad0172<>'1' THEN
             IF cl_null(g_glaq.glaq029) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq029',l_errmsg,'','agl-00074',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code   = "agl-00074"
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
          END IF
          IF NOT cl_null(g_glaq.glaq029) THEN           
             CALL s_voucher_free_account_chk(l_glad0171,g_glaq.glaq029,l_glad0172) RETURNING l_errno
             IF NOT cl_null(l_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq029',l_errmsg,'',l_errno,1)
                LET l_errmsg = l_msg||'/'||g_glaq.glaq029
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = l_errno
                #160321-00016#19 --s add
                IF l_errno = 'sub-01302' THEN
                   LET g_errparam.replace[1] = 'agli041'
                   LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                   LET g_errparam.exeprog = 'agli041'
                END IF
                #160321-00016#19 --e add
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF 
           END IF
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq029 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq029 <> ' ' OR g_glaq.glaq029 IS NULL THEN  #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end
       END IF 
       #核算项二
       IF l_glad018 = 'Y'  THEN
          IF l_glad0182 <>'1' THEN 
             IF cl_null(g_glaq.glaq030) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq030',l_errmsg,'','agl-00075',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code   = "agl-00075"
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
          END IF          
          IF NOT cl_null(g_glaq.glaq030) THEN          
             CALL s_voucher_free_account_chk(l_glad0181,g_glaq.glaq030,l_glad0182) RETURNING l_errno
             IF NOT cl_null(l_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq030',l_errmsg,'',l_errno,1)
                LET l_errmsg = l_msg||'/'||g_glaq.glaq030
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = l_errno
                #160321-00016#19 --s add
                IF l_errno = 'sub-01302' THEN
                   LET g_errparam.replace[1] = 'agli041'
                   LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                   LET g_errparam.exeprog = 'agli041'
                END IF
                #160321-00016#19 --e add
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF 
          END IF 
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq030 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq030 <> ' ' OR g_glaq.glaq030 IS NULL THEN  #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end
       END IF
       #核算项三
       IF l_glad019 = 'Y'  THEN
          IF l_glad0192 <>'1'  THEN 
             IF cl_null(g_glaq.glaq031) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq031',l_errmsg,'','agl-00076',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code   = "agl-00076"
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
          END IF             
          IF NOT cl_null(g_glaq.glaq031) THEN        
             CALL s_voucher_free_account_chk(l_glad0191,g_glaq.glaq031,l_glad0192) RETURNING l_errno
             IF NOT cl_null(l_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq031',l_errmsg,'',l_errno,1)
                LET l_errmsg = l_msg||'/'||g_glaq.glaq031
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = l_errno
                #160321-00016#19 --s add
                IF l_errno = 'sub-01302' THEN
                   LET g_errparam.replace[1] = 'agli041'
                   LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                   LET g_errparam.exeprog = 'agli041'
                END IF
                #160321-00016#19 --e add
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF 
          END IF
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq031 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq031 <> ' ' OR g_glaq.glaq031 IS NULL THEN  #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end   
       END IF 
       #核算项四
       IF l_glad020 = 'Y' THEN
          IF l_glad0202 <>'1' THEN
             IF cl_null(g_glaq.glaq032) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq032',l_errmsg,'','agl-00077',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code   = "agl-00077"
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF   
          END IF
          IF NOT cl_null(g_glaq.glaq032) THEN
             CALL s_voucher_free_account_chk(l_glad0201,g_glaq.glaq032,l_glad0202) RETURNING l_errno
             IF NOT cl_null(l_errno) THEN
               LET r_success = FALSE
#               CALL cl_errmsg('glaq032',l_errmsg,'',l_errno,1)
               LET l_errmsg = l_msg||'/'||g_glaq.glaq032
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = l_errno
                #160321-00016#19 --s add
                IF l_errno = 'sub-01302' THEN
                   LET g_errparam.replace[1] = 'agli041'
                   LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                   LET g_errparam.exeprog = 'agli041'
                END IF
                #160321-00016#19 --e add
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF 
          END IF 
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq032 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq032 <> ' ' OR g_glaq.glaq032 IS NULL THEN  #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end  
       END IF
       #核算项五
       IF l_glad021 = 'Y'  THEN
          IF l_glad0212 <>'1' THEN
             IF cl_null(g_glaq.glaq033) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq033',l_errmsg,'','agl-00078',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code   = "agl-00078"
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
          END IF
          IF NOT cl_null(g_glaq.glaq033) THEN
             CALL s_voucher_free_account_chk(l_glad0211,g_glaq.glaq033,l_glad0212) RETURNING l_errno
             IF NOT cl_null(l_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq033',l_errmsg,'',l_errno,1)
                LET l_errmsg = l_msg||'/'||g_glaq.glaq033
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = l_errno
                #160321-00016#19 --s add
                IF l_errno = 'sub-01302' THEN
                   LET g_errparam.replace[1] = 'agli041'
                   LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                   LET g_errparam.exeprog = 'agli041'
                END IF
                #160321-00016#19 --e add
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF 
          END IF
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq033 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq033 <> ' ' OR g_glaq.glaq033 IS NULL THEN  #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end   
       END IF 
        #核算项六
       IF l_glad022 = 'Y'  THEN
          IF l_glad0222 <>'1' THEN
             IF cl_null(g_glaq.glaq034) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq034',l_errmsg,'','agl-00079',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code   = "agl-00079"
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
          END IF 
          IF NOT cl_null(g_glaq.glaq034) THEN          
             CALL s_voucher_free_account_chk(l_glad0221,g_glaq.glaq034,l_glad0222) RETURNING l_errno
             IF NOT cl_null(l_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq034',l_errmsg,'',l_errno,1)
                LET l_errmsg = l_msg||'/'||g_glaq.glaq034
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = l_errno
                #160321-00016#19 --s add
                IF l_errno = 'sub-01302' THEN
                   LET g_errparam.replace[1] = 'agli041'
                   LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                   LET g_errparam.exeprog = 'agli041'
                END IF
                #160321-00016#19 --e add
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
          END IF
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq034 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq034 <> ' ' OR g_glaq.glaq034 IS NULL THEN  #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end 
       END IF 
       #核算项七
       IF l_glad023 = 'Y'  THEN
          IF l_glad0232 <>'1' THEN 
             IF cl_null(g_glaq.glaq035) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq035',l_errmsg,'','agl-00080',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code   = "agl-00080"
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
          END IF  
          IF NOT cl_null(g_glaq.glaq035) THEN          
             CALL s_voucher_free_account_chk(l_glad0231,g_glaq.glaq035,l_glad0232) RETURNING l_errno
             IF NOT cl_null(l_errno) THEN
               LET r_success = FALSE
#               CALL cl_errmsg('glaq035',l_errmsg,'',l_errno,1)
               LET l_errmsg = l_msg||'/'||g_glaq.glaq035
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = l_errno
                #160321-00016#19 --s add
                IF l_errno = 'sub-01302' THEN
                   LET g_errparam.replace[1] = 'agli041'
                   LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                   LET g_errparam.exeprog = 'agli041'
                END IF
                #160321-00016#19 --e add
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
          END IF        
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq035 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq035 <> ' ' OR g_glaq.glaq035 IS NULL THEN  #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end  
       END IF
       #核算项八
       IF l_glad024 = 'Y'  THEN
          IF l_glad0242 <>'1' THEN 
             IF cl_null(g_glaq.glaq036) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq036',l_errmsg,'','agl-00081',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code   = "agl-00081"
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF 
          END IF
          IF NOT cl_null(g_glaq.glaq036) THEN         
             CALL s_voucher_free_account_chk(l_glad0241,g_glaq.glaq036,l_glad0242) RETURNING l_errno
             IF NOT cl_null(l_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq036',l_errmsg,'',l_errno,1)
                LET l_errmsg = l_msg||'/'||g_glaq.glaq036
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = l_errno
                #160321-00016#19 --s add
                IF l_errno = 'sub-01302' THEN
                   LET g_errparam.replace[1] = 'agli041'
                   LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                   LET g_errparam.exeprog = 'agli041'
                END IF
                #160321-00016#19 --e add
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF 
          END IF 
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq036 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq036 <> ' ' OR g_glaq.glaq036 IS NULL THEN  #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end
       END IF 
       #核算项九
       IF l_glad025 = 'Y'  THEN
          IF l_glad0252 <>'1' THEN
             IF cl_null(g_glaq.glaq037) THEN
                LET r_success = FALSE
#               CALL cl_errmsg('glaq037',l_errmsg,'','agl-00082',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code   = "agl-00082"
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF 
          END IF
          IF NOT cl_null(g_glaq.glaq037) THEN          
             CALL s_voucher_free_account_chk(l_glad0251,g_glaq.glaq037,l_glad0252) RETURNING l_errno
             IF NOT cl_null(l_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq037',l_errmsg,'',l_errno,1)
                LET l_errmsg = l_msg||'/'||g_glaq.glaq037
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = l_errno
                #160321-00016#19 --s add
                IF l_errno = 'sub-01302' THEN
                   LET g_errparam.replace[1] = 'agli041'
                   LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                   LET g_errparam.exeprog = 'agli041'
                END IF
                #160321-00016#19 --e add
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
          END IF 
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq037 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq037 <> ' ' OR g_glaq.glaq037 IS NULL THEN  #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end          
       END IF        
       #核算项十
       IF l_glad026 = 'Y'  THEN
          IF l_glad0262 <>'1' THEN
             IF cl_null(g_glaq.glaq038) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq038',l_errmsg,'','agl-00083',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code   = "agl-00083"
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF  
          END IF
          IF NOT cl_null(g_glaq.glaq038) THEN        
             CALL s_voucher_free_account_chk(l_glad0261,g_glaq.glaq038,l_glad0262) RETURNING l_errno
             IF NOT cl_null(l_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glaq038',l_errmsg,'',l_errno,1)
                LET l_errmsg = l_msg||'/'||g_glaq.glaq038
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = l_errno
                #160321-00016#19 --s add
                IF l_errno = 'sub-01302' THEN
                   LET g_errparam.replace[1] = 'agli041'
                   LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                   LET g_errparam.exeprog = 'agli041'
                END IF
                #160321-00016#19 --e add
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF 
          END IF 
       #2015/08/26--by--02599--add--str--
       ELSE
#          IF g_glaq.glaq038 <> ' ' THEN #161205-00025#4 mark
          IF g_glaq.glaq038 <> ' ' OR g_glaq.glaq038 IS NULL THEN  #161205-00025#4 add
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       #2015/08/26--by--02599--add--end
       END IF      

       #170617-00334#1--add--str--
       #现金类科目，判断是否有对应的现金变动码资料，如果没有，报错
       IF l_glac016 = 'Y' THEN
          LET l_cnt =0
          SELECT COUNT(1) INTO l_cnt FROM glbc_t
           WHERE glbcent=g_enterprise AND glbcld=p_glapld
             AND glbcdocno=p_glapdocno AND glbc001=l_glap002
             AND glbc002=l_glap004  AND glbcseq=l_glaqseq
          IF l_cnt = 0 THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00221"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       END IF
       #170617-00334#1--add--end
   END FOREACH
   
   #檢查現金變動碼設置是否正確
   LET l_amt1=0   LET l_amt2=0   LET l_amt3=0  
   LET l_sum1=0   LET l_sum2=0   LET l_sum3=0  
   SELECT SUM(glaq003+glaq004),SUM(glaq040+glaq041),SUM(glaq043+glaq044) 
     INTO l_amt1,l_amt2,l_amt3
     FROM glaq_t LEFT OUTER JOIN glac_t ON (glaqent=glacent AND glaq002=glac002 AND glac001=l_glaa004) 
    WHERE glaqent=g_enterprise  AND glaqld=p_glapld
      AND glaqdocno=p_glapdocno AND glac016='Y'
   IF cl_null(l_amt1) THEN LET l_amt1=0 END IF   
   IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
   IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
   
   IF l_amt1<>0 THEN
#      SELECT COUNT(*) INTO l_cnt FROM glbc_t #161205-00025#4 mark
      SELECT COUNT(1) INTO l_cnt FROM glbc_t  #161205-00025#4 add
       WHERE glbcent=g_enterprise AND glbcld=p_glapld
         AND glbcdocno=p_glapdocno AND glbc001=l_glap002
         AND glbc002=l_glap004
      IF l_cnt=0 THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glapdocno',p_glapdocno,'','agl-00221',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = p_glapdocno
         LET g_errparam.code   = 'agl-00221'
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      ELSE
         SELECT SUM(glbc009),SUM(glbc012),SUM(glbc014)
           INTO l_sum1,l_sum2,l_sum3
           FROM glbc_t
          WHERE glbcent=g_enterprise AND glbcld=p_glapld
            AND glbcdocno=p_glapdocno AND glbc001=l_glap002
            AND glbc002=l_glap004 
         IF cl_null(l_sum1) THEN LET l_sum1=0 END IF
         IF cl_null(l_sum2) THEN LET l_sum2=0 END IF
         IF cl_null(l_sum3) THEN LET l_sum3=0 END IF
#         IF l_amt1<0 THEN LET l_amt1=l_amt1*-1 END IF
#         IF l_amt2<0 THEN LET l_amt2=l_amt2*-1 END IF
#         IF l_amt3<0 THEN LET l_amt3=l_amt3*-1 END IF
         
         IF l_amt1<>l_sum1 THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glapdocno',p_glapdocno,'','agl-00215',1)
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = p_glapdocno
            LET g_errparam.code   = 'agl-00215'
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
         END IF
         IF l_glaa015='Y' AND l_amt2<>l_sum2 THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glapdocno',p_glapdocno,'','agl-00219',1)
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = p_glapdocno
            LET g_errparam.code   = 'agl-00219'
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
         END IF
         IF l_glaa019='Y' AND l_amt3<>l_sum3 THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glapdocno',p_glapdocno,'','agl-00220',1)
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = p_glapdocno
            LET g_errparam.code   = 'agl-00220'
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
         END IF
         #判斷現金變動碼設置是否正確
         #現金變動碼參考表號
#161205-00025#4--mark--str--
#         SELECT glaa005 INTO l_glaa005 FROM glaa_t 
#          WHERE glaaent=g_enterprise AND glaald=p_glapld
#161205-00025#4--mark--end
         LET l_sql = " SELECT glbcseq,glbcseq1,glbc004 FROM glbc_t ",
                     "  WHERE glbcent = ",g_enterprise,
                     "    AND glbcld = '",p_glapld,"'",
                     "    AND glbcdocno = '",p_glapdocno,"'",
                     "    AND glbc001=",l_glap002," AND glbc002=",l_glap004
         PREPARE s_voucher_glbc_pre  FROM l_sql
         DECLARE s_voucher_glbc_cs CURSOR FOR s_voucher_glbc_pre
         FOREACH s_voucher_glbc_cs INTO l_glbcseq,l_glbcseq1,l_glbc004
            IF SQLCA.SQLCODE THEN
#               CALL cl_errmsg('','','',sqlca.sqlcode,0)
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = "FOREACH"
               LET g_errparam.code   = sqlca.sqlcode
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               LET r_success = FALSE
               EXIT FOREACH
            END IF
            IF cl_null(l_glbc004) THEN 
               LET r_success = FALSE
#               CALL cl_errmsg('glapdocno',p_glapdocno,'','agl-00229',1)
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = p_glapdocno,"/",l_glbcseq USING "<<<<"
               LET g_errparam.code   = 'agl-00229'
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
            ELSE
               SELECT nmaistus INTO l_nmaistus FROM nmai_t 
                WHERE nmaient=g_enterprise AND nmai001=l_glaa005
                  AND nmai002=l_glbc004 
               IF SQLCA.sqlcode THEN
                  LET r_success = FALSE
#                  CALL cl_errmsg('glbc004',l_glbc004,'',SQLCA.sqlcode,1)
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = l_glbc004
                  LET g_errparam.code   = SQLCA.sqlcode
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
               END IF
               IF l_nmaistus<>'Y' THEN
                  LET r_success = FALSE
#                  CALL cl_errmsg('glbc004',l_glbc004,'','abg-00002',1)
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = l_glbc004
                  #LET g_errparam.code   = 'abg-00002'#160321-00016#19 mark
                  LET g_errparam.code   = 'sub-01302' #160321-00016#19 add
                  LET g_errparam.popup  = TRUE 
                  #160321-00016#19 --s add
                  LET g_errparam.replace[1] = 'anmi160'
                  LET g_errparam.replace[2] = cl_get_progname('anmi160',g_lang,"2")
                  LET g_errparam.exeprog = 'anmi160'
                  #160321-00016#19 --e add
                  CALL cl_err()
               END IF 
            END IF
         END FOREACH
      END IF
   END IF
   RETURN r_success
#+ 汇率，数量，单价，金额
END FUNCTION

PUBLIC FUNCTION s_voucher_num_chk(p_num)
   DEFINE p_num    LIKE type_t.num20_6

     IF p_num < 0  THEN
         LET g_errno = 'aim-00009'
      END IF 
 
#+ 科目检查
END FUNCTION

PUBLIC FUNCTION s_voucher_glaq002_chk(p_glapld,p_glaq002)
  DEFINE p_glapld     LIKE glap_t.glapld
  DEFINE p_glaq002    LIKE glaq_t.glaq002
  DEFINE l_glac006    LIKE glac_t.glac006
  DEFINE l_glac003    LIKE glac_t.glac003
#  DEFINE l_glacstus   LIKE glac_t.glacstus  #151117-00009#1 mark
  DEFINE l_gladstus   LIKE glad_t.gladstus   #151117-00009#1 add
  
   LET g_errno = ''
   LET l_glac003 = ''
   LET l_glac006 = ''
#   LET l_glacstus = ''  #151117-00009#1 mark
#   SELECT glacstus,glac003,glac006 INTO l_glacstus,l_glac003,l_glac006 FROM glac_t #151117-00009#1 mark
   SELECT glac003,glac006 INTO l_glac003,l_glac006 FROM glac_t #151117-00009#1 add
    WHERE glacent = g_enterprise
      AND glac001 = (SELECT glaa004 FROM glaa_t WHERE glaaent = g_enterprise
                        AND glaald = p_glapld)   #会计科目参照表
      AND glac002 = p_glaq002
      
   #151117-00009#1--add--str--
   #检查科目是否存在于glad_t中，是否有效
   LET l_gladstus = ''
   SELECT gladstus INTO l_gladstus FROM glad_t 
    WHERE gladent = g_enterprise
      AND gladld = p_glapld 
      AND glad001 = p_glaq002
   #151117-00009#1--add--end   
   CASE
#151117-00009#1--mod--str--
#      WHEN SQLCA.SQLCODE = 100   LET g_errno = 'agl-00011'
#      WHEN l_glacstus = 'N'      LET g_errno = 'agl-00012'  
      WHEN SQLCA.SQLCODE = 100   LET g_errno = 'ais-00045'
      #WHEN l_gladstus = 'N'      LET g_errno = 'ais-00046'#160321-00016#19 mark
      WHEN l_gladstus = 'N'      LET g_errno = 'sub-01302' #160321-00016#19 add
#151117-00009#1--mod--end
      WHEN l_glac003 = '1'       LET g_errno = 'agl-00013'  #必须为非统治类科目
      WHEN l_glac006 <>'1'       LET g_errno = 'agl-00030'  #须为账户性质   
   END CASE   
#+币种检查
END FUNCTION

PUBLIC FUNCTION s_voucher_glaq005_chk(p_glaq005)
   DEFINE p_glaq005    LIKE glaq_t.glaq005
   DEFINE l_ooaistus   LIKE ooai_t.ooaistus

     
     LET g_errno = ''
     SELECT ooaistus INTO l_ooaistus FROM ooai_t
      WHERE ooaient = g_enterprise
        AND ooai001 = p_glaq005
     CASE  
        WHEN SQLCA.sqlcode = 100   LET g_errno = 'aoo-00028'
        #WHEN l_ooaistus = 'N'      LET g_errno = 'aoo-00011' #160321-00016#19 mark
        WHEN l_ooaistus = 'N'      LET g_errno = 'sub-01302'  #160321-00016#19 add
     END CASE
   
#+ 计价单位检查
END FUNCTION

PUBLIC FUNCTION s_voucher_glaq007_chk(p_glaq007)
   DEFINE p_glaq007     LIKE glaq_t.glaq007
   DEFINE l_oocastus    LIKE ooca_t.oocastus
   
   LET g_errno = ''
   SELECT oocastus INTO l_oocastus FROM ooca_t
    WHERE oocaent = g_enterprise
      AND ooca001 = p_glaq007
    
    CASE  
        WHEN SQLCA.sqlcode = 100   LET g_errno = 'aim-00004'
        #WHEN l_oocastus = 'N'      LET g_errno = 'aim-00005'#160321-00016#19 mark
        WHEN l_oocastus = 'N'      LET g_errno = 'sub-01302' #160321-00016#19 add
     END CASE
   
#+申请人检查
END FUNCTION

PUBLIC FUNCTION s_voucher_glaq013_chk(p_glaq013)
   DEFINE p_glaq013    LIKE glaq_t.glaq013 
   DEFINE  l_ooagstus  LIKE ooag_t.ooagstus


   LET g_errno=''
   SELECT ooagstus INTO l_ooagstus FROM ooag_t
    WHERE ooagent = g_enterprise
      AND ooag001 = p_glaq013

   CASE
      WHEN SQLCA.SQLCODE=100   LET g_errno = 'aoo-00074'
      #WHEN l_ooagstus ='N'     LET g_errno = 'aoo-00071' #160321-00016#19 mark
      WHEN l_ooagstus ='N'     LET g_errno = 'sub-01302'  #160321-00016#19 add
   END CASE
#+ 营运据点检查
END FUNCTION

PUBLIC FUNCTION s_voucher_glaq017_chk(p_glaq017)
   DEFINE p_glaq017      LIKE glaq_t.glaq017
   DEFINE l_ooefstus     LIKE ooef_t.ooefstus
   
   LET g_errno = ''
   
   SELECT ooefstus INTO l_ooefstus FROM ooef_t
    WHERE ooefent = g_enterprise
      AND ooef001 = p_glaq017
      
   CASE
      WHEN SQLCA.SQLCODE = 100    LET g_errno = 'aoo-00088'
      #WHEN l_ooefstus = 'N'       LET g_errno = 'aoo-00089' #160321-00016#19 mark
      WHEN l_ooefstus = 'N'       LET g_errno = 'sub-01302'  #160321-00016#19 add
   END CASE
#+部门/利润成本中心
END FUNCTION

PUBLIC FUNCTION s_voucher_glaq018_chk(p_glaq018,p_glapdocdt)
   DEFINE p_glaq018      LIKE glaq_t.glaq018
   DEFINE p_glapdocdt    LIKE glap_t.glapdocdt    #传票日期
   #161128-00061#7---add---begin----------- 
   #DEFINE l_ooeg         RECORD LIKE ooeg_t.*    #为以后扩展新的检查做预留，目前检查ooegstus，ooeg006，ooeg007
   DEFINE l_ooeg RECORD  #部門資料檔
       ooegent LIKE ooeg_t.ooegent, #企業編號
       ooegownid LIKE ooeg_t.ooegownid, #資料所有者
       ooegowndp LIKE ooeg_t.ooegowndp, #資料所屬部門
       ooegcrtid LIKE ooeg_t.ooegcrtid, #資料建立者
       ooegcrtdp LIKE ooeg_t.ooegcrtdp, #資料建立部門
       ooegcrtdt LIKE ooeg_t.ooegcrtdt, #資料創建日
       ooegmodid LIKE ooeg_t.ooegmodid, #資料修改者
       ooegmoddt LIKE ooeg_t.ooegmoddt, #最近修改日
       ooegstus LIKE ooeg_t.ooegstus, #狀態碼
       ooeg001 LIKE ooeg_t.ooeg001, #部門編號
       ooeg002 LIKE ooeg_t.ooeg002, #上層部門
       ooeg003 LIKE ooeg_t.ooeg003, #責任中心類型
       ooeg004 LIKE ooeg_t.ooeg004, #所屬責任中心
       ooeg005 LIKE ooeg_t.ooeg005, #會計部門
       ooeg006 LIKE ooeg_t.ooeg006, #生效日期
       ooeg007 LIKE ooeg_t.ooeg007, #失效日期
       ooeg008 LIKE ooeg_t.ooeg008, #費用類別
       ooeg009 LIKE ooeg_t.ooeg009, #歸屬法人
       ooeg010 LIKE ooeg_t.ooeg010, #部門名稱
       ooegud001 LIKE ooeg_t.ooegud001, #自定義欄位(文字)001
       ooegud002 LIKE ooeg_t.ooegud002, #自定義欄位(文字)002
       ooegud003 LIKE ooeg_t.ooegud003, #自定義欄位(文字)003
       ooegud004 LIKE ooeg_t.ooegud004, #自定義欄位(文字)004
       ooegud005 LIKE ooeg_t.ooegud005, #自定義欄位(文字)005
       ooegud006 LIKE ooeg_t.ooegud006, #自定義欄位(文字)006
       ooegud007 LIKE ooeg_t.ooegud007, #自定義欄位(文字)007
       ooegud008 LIKE ooeg_t.ooegud008, #自定義欄位(文字)008
       ooegud009 LIKE ooeg_t.ooegud009, #自定義欄位(文字)009
       ooegud010 LIKE ooeg_t.ooegud010, #自定義欄位(文字)010
       ooegud011 LIKE ooeg_t.ooegud011, #自定義欄位(數字)011
       ooegud012 LIKE ooeg_t.ooegud012, #自定義欄位(數字)012
       ooegud013 LIKE ooeg_t.ooegud013, #自定義欄位(數字)013
       ooegud014 LIKE ooeg_t.ooegud014, #自定義欄位(數字)014
       ooegud015 LIKE ooeg_t.ooegud015, #自定義欄位(數字)015
       ooegud016 LIKE ooeg_t.ooegud016, #自定義欄位(數字)016
       ooegud017 LIKE ooeg_t.ooegud017, #自定義欄位(數字)017
       ooegud018 LIKE ooeg_t.ooegud018, #自定義欄位(數字)018
       ooegud019 LIKE ooeg_t.ooegud019, #自定義欄位(數字)019
       ooegud020 LIKE ooeg_t.ooegud020, #自定義欄位(數字)020
       ooegud021 LIKE ooeg_t.ooegud021, #自定義欄位(日期時間)021
       ooegud022 LIKE ooeg_t.ooegud022, #自定義欄位(日期時間)022
       ooegud023 LIKE ooeg_t.ooegud023, #自定義欄位(日期時間)023
       ooegud024 LIKE ooeg_t.ooegud024, #自定義欄位(日期時間)024
       ooegud025 LIKE ooeg_t.ooegud025, #自定義欄位(日期時間)025
       ooegud026 LIKE ooeg_t.ooegud026, #自定義欄位(日期時間)026
       ooegud027 LIKE ooeg_t.ooegud027, #自定義欄位(日期時間)027
       ooegud028 LIKE ooeg_t.ooegud028, #自定義欄位(日期時間)028
       ooegud029 LIKE ooeg_t.ooegud029, #自定義欄位(日期時間)029
       ooegud030 LIKE ooeg_t.ooegud030, #自定義欄位(日期時間)030
       ooeg011 LIKE ooeg_t.ooeg011, #部門主管員工編號
       ooeg012 LIKE ooeg_t.ooeg012  #部門核決層級
       END RECORD

   #161128-00061#7---add---end-----------
   
   WHENEVER ERROR CONTINUE
   INITIALIZE l_ooeg.* TO NULL

   LET g_errno =''
   #检查传入变量是否为空
   IF p_glaq018 IS NULL THEN
      LET g_errno = 'sub-00191'
      RETURN 
   END IF
    IF p_glapdocdt IS NULL THEN
      LET g_errno = 'sub-00265'
      RETURN 
   END IF
   
   #161128-00061#7---add---begin-----------
   #SELECT * INTO l_ooeg.* 
   SELECT ooegent,ooegownid,ooegowndp,ooegcrtid,ooegcrtdp,ooegcrtdt,ooegmodid,ooegmoddt,
          ooegstus,ooeg001,ooeg002,ooeg003,ooeg004,ooeg005,ooeg006,ooeg007,ooeg008,ooeg009,
          ooeg010,ooegud001,ooegud002,ooegud003,ooegud004,ooegud005,ooegud006,ooegud007,
          ooegud008,ooegud009,ooegud010,ooegud011,ooegud012,ooegud013,ooegud014,ooegud015,
          ooegud016,ooegud017,ooegud018,ooegud019,ooegud020,ooegud021,ooegud022,ooegud023,
          ooegud024,ooegud025,ooegud026,ooegud027,ooegud028,ooegud029,ooegud030,ooeg011,ooeg012 INTO l_ooeg.* 
   #161128-00061#7---add---end-----------
   FROM ooeg_t WHERE ooegent = g_enterprise AND ooeg001 = p_glaq018

   CASE WHEN SQLCA.SQLCODE = 100           LET g_errno = 'aoo-00008'
        #WHEN l_ooeg.ooegstus ='N'          LET g_errno = 'aoo-00029'#160321-00016#19 mark
        WHEN l_ooeg.ooegstus ='N'          LET g_errno = 'sub-01302' #160321-00016#19 add
        WHEN p_glapdocdt < l_ooeg.ooeg006  LET g_errno = 'sub-00266'
        WHEN l_ooeg.ooeg007 IS NOT NULL
             IF p_glapdocdt >= l_ooeg.ooeg007 THEN
                LET g_errno = 'sub-00267'
             END IF
        OTHERWISE                     LET g_errno = SQLCA.SQLCODE USING '-------' 
   END CASE
   
#区域客群检查
END FUNCTION
#=============================================
# Descriptions...: 更新审核状态
# Memo...........:
# Usage..........: CALL s_voucher_conf_upd(p_glapld,p_glapdocno)
#                  RETURNING r_success
# Input parameter: p_ld           帐套
#                : p_glapdocno    傳票編號
# Return code....: r_success      成功否标识位
# Date & Author..: 2013/09/10 By minpp
# Modify.........:
#===============================================
PUBLIC FUNCTION s_voucher_conf_upd(p_glapld,p_glapdocno)
   DEFINE p_glapld         LIKE glap_t.glapld         #帐别
   DEFINE p_glapdocno      LIKE glap_t.glapdocno      #傳票編號
   DEFINE r_success     LIKE type_t.num5
   DEFINE r_errno       LIKE type_t.chr80
   DEFINE l_today       DATETIME YEAR TO SECOND
   DEFINE l_glaqseq     LIKE glaq_t.glaqseq   #150703-00021#24
   DEFINE l_ap_slip     LIKE glap_t.glapdocno #150703-00021#24
   DEFINE l_dfin5002    LIKE type_t.chr1      #150703-00021#24
   DEFINE l_glap008     LIKE glap_t.glap008   #150703-00021#24
   DEFINE l_sql         STRING
   #170411-00094#1--add--s--xul 
   DEFINE l_glap007    LIKE glap_t.glap007
   DEFINE l_glapdocdt  LIKE glap_t.glapdocdt
   DEFINE l_glap002    LIKE glap_t.glap002
   DEFINE l_glap004    LIKE glap_t.glap004
   DEFINE l_glaa004    LIKE glaa_t.glaa004
   DEFINE l_glaa122    LIKE glaa_t.glaa122
   DEFINE l_glac016    LIKE glac_t.glac016
   DEFINE l_glaq RECORD  #傳票憑證單身檔
       glaqent LIKE glaq_t.glaqent, #企業編號
       glaqcomp LIKE glaq_t.glaqcomp, #法人
       glaqld LIKE glaq_t.glaqld, #帳套
       glaqdocno LIKE glaq_t.glaqdocno, #單號
       glaqseq LIKE glaq_t.glaqseq, #項次
       glaq001 LIKE glaq_t.glaq001, #摘要
       glaq002 LIKE glaq_t.glaq002, #科目編號
       glaq003 LIKE glaq_t.glaq003, #借方金額
       glaq004 LIKE glaq_t.glaq004, #貸方金額
       glaq005 LIKE glaq_t.glaq005, #交易幣別
       glaq006 LIKE glaq_t.glaq006, #匯率
       glaq007 LIKE glaq_t.glaq007, #計價單位
       glaq008 LIKE glaq_t.glaq008, #數量
       glaq009 LIKE glaq_t.glaq009, #單價
       glaq010 LIKE glaq_t.glaq010, #原幣金額
       glaq011 LIKE glaq_t.glaq011, #票據編碼
       glaq012 LIKE glaq_t.glaq012, #票據日期
       glaq013 LIKE glaq_t.glaq013, #申請人
       glaq014 LIKE glaq_t.glaq014, #銀行帳號
       glaq015 LIKE glaq_t.glaq015, #款別編號
       glaq016 LIKE glaq_t.glaq016, #收支專案
       glaq017 LIKE glaq_t.glaq017, #營運據點
       glaq018 LIKE glaq_t.glaq018, #部門
       glaq019 LIKE glaq_t.glaq019, #利潤/成本中心
       glaq020 LIKE glaq_t.glaq020, #區域
       glaq021 LIKE glaq_t.glaq021, #收付款客商
       glaq022 LIKE glaq_t.glaq022, #帳款客戶
       glaq023 LIKE glaq_t.glaq023, #客群
       glaq024 LIKE glaq_t.glaq024, #產品類別
       glaq025 LIKE glaq_t.glaq025, #人員
       glaq026 LIKE glaq_t.glaq026, #no use
       glaq027 LIKE glaq_t.glaq027, #專案編號
       glaq028 LIKE glaq_t.glaq028, #WBS
       glaq029 LIKE glaq_t.glaq029, #自由核算項一
       glaq030 LIKE glaq_t.glaq030, #自由核算項二
       glaq031 LIKE glaq_t.glaq031, #自由核算項三
       glaq032 LIKE glaq_t.glaq032, #自由核算項四
       glaq033 LIKE glaq_t.glaq033, #自由核算項五
       glaq034 LIKE glaq_t.glaq034, #自由核算項六
       glaq035 LIKE glaq_t.glaq035, #自由核算項七
       glaq036 LIKE glaq_t.glaq036, #自由核算項八
       glaq037 LIKE glaq_t.glaq037, #自由核算項九
       glaq038 LIKE glaq_t.glaq038, #自由核算項十
       glaq039 LIKE glaq_t.glaq039, #匯率(本位幣二)
       glaq040 LIKE glaq_t.glaq040, #借方金額(本位幣二)
       glaq041 LIKE glaq_t.glaq041, #貸方金額(本位幣二)
       glaq042 LIKE glaq_t.glaq042, #匯率(本位幣三)
       glaq043 LIKE glaq_t.glaq043, #借方金額(本位幣三)
       glaq044 LIKE glaq_t.glaq044, #貸方金額(本位幣三)
       glaq051 LIKE glaq_t.glaq051, #經營方式
       glaq052 LIKE glaq_t.glaq052, #通路
       glaq053 LIKE glaq_t.glaq053, #品牌
       glaqud001 LIKE glaq_t.glaqud001, #自定義欄位(文字)001
       glaqud002 LIKE glaq_t.glaqud002, #自定義欄位(文字)002
       glaqud003 LIKE glaq_t.glaqud003, #自定義欄位(文字)003
       glaqud004 LIKE glaq_t.glaqud004, #自定義欄位(文字)004
       glaqud005 LIKE glaq_t.glaqud005, #自定義欄位(文字)005
       glaqud006 LIKE glaq_t.glaqud006, #自定義欄位(文字)006
       glaqud007 LIKE glaq_t.glaqud007, #自定義欄位(文字)007
       glaqud008 LIKE glaq_t.glaqud008, #自定義欄位(文字)008
       glaqud009 LIKE glaq_t.glaqud009, #自定義欄位(文字)009
       glaqud010 LIKE glaq_t.glaqud010, #自定義欄位(文字)010
       glaqud011 LIKE glaq_t.glaqud011, #自定義欄位(數字)011
       glaqud012 LIKE glaq_t.glaqud012, #自定義欄位(數字)012
       glaqud013 LIKE glaq_t.glaqud013, #自定義欄位(數字)013
       glaqud014 LIKE glaq_t.glaqud014, #自定義欄位(數字)014
       glaqud015 LIKE glaq_t.glaqud015, #自定義欄位(數字)015
       glaqud016 LIKE glaq_t.glaqud016, #自定義欄位(數字)016
       glaqud017 LIKE glaq_t.glaqud017, #自定義欄位(數字)017
       glaqud018 LIKE glaq_t.glaqud018, #自定義欄位(數字)018
       glaqud019 LIKE glaq_t.glaqud019, #自定義欄位(數字)019
       glaqud020 LIKE glaq_t.glaqud020, #自定義欄位(數字)020
       glaqud021 LIKE glaq_t.glaqud021, #自定義欄位(日期時間)021
       glaqud022 LIKE glaq_t.glaqud022, #自定義欄位(日期時間)022
       glaqud023 LIKE glaq_t.glaqud023, #自定義欄位(日期時間)023
       glaqud024 LIKE glaq_t.glaqud024, #自定義欄位(日期時間)024
       glaqud025 LIKE glaq_t.glaqud025, #自定義欄位(日期時間)025
       glaqud026 LIKE glaq_t.glaqud026, #自定義欄位(日期時間)026
       glaqud027 LIKE glaq_t.glaqud027, #自定義欄位(日期時間)027
       glaqud028 LIKE glaq_t.glaqud028, #自定義欄位(日期時間)028
       glaqud029 LIKE glaq_t.glaqud029, #自定義欄位(日期時間)029
       glaqud030 LIKE glaq_t.glaqud030  #自定義欄位(日期時間)030
       END RECORD
   DEFINE l_nmbc RECORD  #銀存收支異動檔
       nmbcent LIKE nmbc_t.nmbcent, #企業編號
       nmbcownid LIKE nmbc_t.nmbcownid, #資料所有者
       nmbcowndp LIKE nmbc_t.nmbcowndp, #資料所屬部門
       nmbccrtid LIKE nmbc_t.nmbccrtid, #資料建立者
       nmbccrtdp LIKE nmbc_t.nmbccrtdp, #資料建立部門
       nmbccrtdt LIKE nmbc_t.nmbccrtdt, #資料創建日
       nmbcmodid LIKE nmbc_t.nmbcmodid, #資料修改者
       nmbcmoddt LIKE nmbc_t.nmbcmoddt, #最近修改日
       nmbccnfid LIKE nmbc_t.nmbccnfid, #資料確認者
       nmbccnfdt LIKE nmbc_t.nmbccnfdt, #資料確認日
       nmbcpstid LIKE nmbc_t.nmbcpstid, #資料過帳者
       nmbcpstdt LIKE nmbc_t.nmbcpstdt, #資料過帳日
       nmbcstus LIKE nmbc_t.nmbcstus, #狀態碼
       nmbccomp LIKE nmbc_t.nmbccomp, #法人
       nmbcsite LIKE nmbc_t.nmbcsite, #資金中心
       nmbcdocno LIKE nmbc_t.nmbcdocno, #來源單號
       nmbcseq LIKE nmbc_t.nmbcseq, #項次
       nmbc001 LIKE nmbc_t.nmbc001, #單據來源
       nmbc002 LIKE nmbc_t.nmbc002, #交易帳戶編碼
       nmbc003 LIKE nmbc_t.nmbc003, #交易對象
       nmbc004 LIKE nmbc_t.nmbc004, #交易對象識別碼
       nmbc005 LIKE nmbc_t.nmbc005, #銀行日期
       nmbc006 LIKE nmbc_t.nmbc006, #異動別
       nmbc007 LIKE nmbc_t.nmbc007, #存提碼
       nmbc008 LIKE nmbc_t.nmbc008, #調節碼
       nmbc009 LIKE nmbc_t.nmbc009, #對帳碼
       nmbc010 LIKE nmbc_t.nmbc010, #網銀媒體檔轉出日期
       nmbc011 LIKE nmbc_t.nmbc011, #網銀媒體檔轉出批號
       nmbc100 LIKE nmbc_t.nmbc100, #交易帳戶幣別
       nmbc101 LIKE nmbc_t.nmbc101, #主帳套匯率
       nmbc103 LIKE nmbc_t.nmbc103, #主帳套原幣金額
       nmbc113 LIKE nmbc_t.nmbc113, #主帳套本幣金額
       nmbc121 LIKE nmbc_t.nmbc121, #主帳套本位幣二匯率
       nmbc123 LIKE nmbc_t.nmbc123, #主帳套本位幣二金額
       nmbc131 LIKE nmbc_t.nmbc131, #主帳套本位幣三匯率
       nmbc133 LIKE nmbc_t.nmbc133, #主帳套本位幣三金額
       nmbcud001 LIKE nmbc_t.nmbcud001, #自定義欄位(文字)001
       nmbcud002 LIKE nmbc_t.nmbcud002, #自定義欄位(文字)002
       nmbcud003 LIKE nmbc_t.nmbcud003, #自定義欄位(文字)003
       nmbcud004 LIKE nmbc_t.nmbcud004, #自定義欄位(文字)004
       nmbcud005 LIKE nmbc_t.nmbcud005, #自定義欄位(文字)005
       nmbcud006 LIKE nmbc_t.nmbcud006, #自定義欄位(文字)006
       nmbcud007 LIKE nmbc_t.nmbcud007, #自定義欄位(文字)007
       nmbcud008 LIKE nmbc_t.nmbcud008, #自定義欄位(文字)008
       nmbcud009 LIKE nmbc_t.nmbcud009, #自定義欄位(文字)009
       nmbcud010 LIKE nmbc_t.nmbcud010, #自定義欄位(文字)010
       nmbcud011 LIKE nmbc_t.nmbcud011, #自定義欄位(數字)011
       nmbcud012 LIKE nmbc_t.nmbcud012, #自定義欄位(數字)012
       nmbcud013 LIKE nmbc_t.nmbcud013, #自定義欄位(數字)013
       nmbcud014 LIKE nmbc_t.nmbcud014, #自定義欄位(數字)014
       nmbcud015 LIKE nmbc_t.nmbcud015, #自定義欄位(數字)015
       nmbcud016 LIKE nmbc_t.nmbcud016, #自定義欄位(數字)016
       nmbcud017 LIKE nmbc_t.nmbcud017, #自定義欄位(數字)017
       nmbcud018 LIKE nmbc_t.nmbcud018, #自定義欄位(數字)018
       nmbcud019 LIKE nmbc_t.nmbcud019, #自定義欄位(數字)019
       nmbcud020 LIKE nmbc_t.nmbcud020, #自定義欄位(數字)020
       nmbcud021 LIKE nmbc_t.nmbcud021, #自定義欄位(日期時間)021
       nmbcud022 LIKE nmbc_t.nmbcud022, #自定義欄位(日期時間)022
       nmbcud023 LIKE nmbc_t.nmbcud023, #自定義欄位(日期時間)023
       nmbcud024 LIKE nmbc_t.nmbcud024, #自定義欄位(日期時間)024
       nmbcud025 LIKE nmbc_t.nmbcud025, #自定義欄位(日期時間)025
       nmbcud026 LIKE nmbc_t.nmbcud026, #自定義欄位(日期時間)026
       nmbcud027 LIKE nmbc_t.nmbcud027, #自定義欄位(日期時間)027
       nmbcud028 LIKE nmbc_t.nmbcud028, #自定義欄位(日期時間)028
       nmbcud029 LIKE nmbc_t.nmbcud029, #自定義欄位(日期時間)029
       nmbcud030 LIKE nmbc_t.nmbcud030, #自定義欄位(日期時間)030
       nmbc012 LIKE nmbc_t.nmbc012, #票據號碼
       nmbc013 LIKE nmbc_t.nmbc013, #款別
       nmbc014 LIKE nmbc_t.nmbc014, #到期日
       nmbc015 LIKE nmbc_t.nmbc015, #匯入銀行編號
       nmbc016 LIKE nmbc_t.nmbc016, #匯入帳號
       nmbc017 LIKE nmbc_t.nmbc017, #受款人全名
       nmbcorga LIKE nmbc_t.nmbcorga  #來源組織
       END RECORD
 
   DEFINE l_glbc RECORD  #現金變動碼明細檔
       glbcent LIKE glbc_t.glbcent, #企業編號
       glbcld LIKE glbc_t.glbcld, #帳套
       glbccomp LIKE glbc_t.glbccomp, #營運據點
       glbcdocno LIKE glbc_t.glbcdocno, #傳票編號
       glbcseq LIKE glbc_t.glbcseq, #項次
       glbcseq1 LIKE glbc_t.glbcseq1, #序號
       glbc001 LIKE glbc_t.glbc001, #年度
       glbc002 LIKE glbc_t.glbc002, #期別
       glbc003 LIKE glbc_t.glbc003, #借貸別
       glbc004 LIKE glbc_t.glbc004, #現金變動碼
       glbc005 LIKE glbc_t.glbc005, #交易客商
       glbc006 LIKE glbc_t.glbc006, #交易幣別
       glbc007 LIKE glbc_t.glbc007, #匯率
       glbc008 LIKE glbc_t.glbc008, #原幣金額
       glbc009 LIKE glbc_t.glbc009, #本幣金額
       glbc010 LIKE glbc_t.glbc010, #資料來源
       glbc011 LIKE glbc_t.glbc011, #匯率(本位幣二)
       glbc012 LIKE glbc_t.glbc012, #金額(本位幣二)
       glbc013 LIKE glbc_t.glbc013, #匯率(本位幣三)
       glbc014 LIKE glbc_t.glbc014, #金額(本位幣三)
       glbcud001 LIKE glbc_t.glbcud001, #自定義欄位(文字)001
       glbcud002 LIKE glbc_t.glbcud002, #自定義欄位(文字)002
       glbcud003 LIKE glbc_t.glbcud003, #自定義欄位(文字)003
       glbcud004 LIKE glbc_t.glbcud004, #自定義欄位(文字)004
       glbcud005 LIKE glbc_t.glbcud005, #自定義欄位(文字)005
       glbcud006 LIKE glbc_t.glbcud006, #自定義欄位(文字)006
       glbcud007 LIKE glbc_t.glbcud007, #自定義欄位(文字)007
       glbcud008 LIKE glbc_t.glbcud008, #自定義欄位(文字)008
       glbcud009 LIKE glbc_t.glbcud009, #自定義欄位(文字)009
       glbcud010 LIKE glbc_t.glbcud010, #自定義欄位(文字)010
       glbcud011 LIKE glbc_t.glbcud011, #自定義欄位(數字)011
       glbcud012 LIKE glbc_t.glbcud012, #自定義欄位(數字)012
       glbcud013 LIKE glbc_t.glbcud013, #自定義欄位(數字)013
       glbcud014 LIKE glbc_t.glbcud014, #自定義欄位(數字)014
       glbcud015 LIKE glbc_t.glbcud015, #自定義欄位(數字)015
       glbcud016 LIKE glbc_t.glbcud016, #自定義欄位(數字)016
       glbcud017 LIKE glbc_t.glbcud017, #自定義欄位(數字)017
       glbcud018 LIKE glbc_t.glbcud018, #自定義欄位(數字)018
       glbcud019 LIKE glbc_t.glbcud019, #自定義欄位(數字)019
       glbcud020 LIKE glbc_t.glbcud020, #自定義欄位(數字)020
       glbcud021 LIKE glbc_t.glbcud021, #自定義欄位(日期時間)021
       glbcud022 LIKE glbc_t.glbcud022, #自定義欄位(日期時間)022
       glbcud023 LIKE glbc_t.glbcud023, #自定義欄位(日期時間)023
       glbcud024 LIKE glbc_t.glbcud024, #自定義欄位(日期時間)024
       glbcud025 LIKE glbc_t.glbcud025, #自定義欄位(日期時間)025
       glbcud026 LIKE glbc_t.glbcud026, #自定義欄位(日期時間)026
       glbcud027 LIKE glbc_t.glbcud027, #自定義欄位(日期時間)027
       glbcud028 LIKE glbc_t.glbcud028, #自定義欄位(日期時間)028
       glbcud029 LIKE glbc_t.glbcud029, #自定義欄位(日期時間)029
       glbcud030 LIKE glbc_t.glbcud030, #自定義欄位(日期時間)030
       glbc015 LIKE glbc_t.glbc015 #狀態碼
       END RECORD 
   #170411-00094#1--add--e--xul
   WHENEVER ERROR CONTINUE

   LET r_success  = TRUE
   LET r_errno = ''
   LET l_today  = cl_get_current()
   #检查完毕，更新狀態碼=已確認,確認人=登入user,確認日期=g_today
   UPDATE glap_t SET glapstus = 'Y',
                     glapcnfid = g_user,
                     glapcnfdt = l_today
               WHERE glapent = g_enterprise
                 AND glapld = p_glapld
                 AND glapdocno = p_glapdocno
   IF SQLCA.SQLCODE OR SQLCA.sqlerrd[3] = 0 THEN
      LET r_success = FALSE
#      CALL cl_errmsg('glapstus',p_glapdocno,'Y',sqlca.sqlcode,1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code   = sqlca.sqlcode
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
   END IF
   #170411-00094#1--add--s--xul   
   SELECT glap007,glapdocdt,glap002,glap004 
     INTO l_glap007,l_glapdocdt,l_glap002,l_glap004
     FROM glap_t
    WHERE glapent = g_enterprise
      AND glapld = p_glapld
      AND glapdocno = p_glapdocno
   
   SELECT glaa122,glaa004 INTO l_glaa122,l_glaa004
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald = p_glapld    
      
   IF l_glap007 = 'GL' AND l_glaa122 = 'Y' THEN 
      LET l_sql = "SELECT glaqent,glaqcomp,glaqld,glaqdocno,glaqseq,glaq001,glaq002,glaq003,",
                  "glaq004,glaq005,glaq006,glaq007,glaq008,glaq009,glaq010,glaq011,glaq012,",
                  "glaq013,glaq014,glaq015,glaq016,glaq017,glaq018,glaq019,glaq020,glaq021,",
                  "glaq022,glaq023,glaq024,glaq025,glaq026,glaq027,glaq028,glaq029,glaq030,",
                  "glaq031,glaq032,glaq033,glaq034,glaq035,glaq036,glaq037,glaq038,glaq039,",
                  "glaq040,glaq041,glaq042,glaq043,glaq044,glaq051,glaq052,glaq053,glaqud001,",
                  "glaqud002,glaqud003,glaqud004,glaqud005,glaqud006,glaqud007,glaqud008,",
                  "glaqud009,glaqud010,glaqud011,glaqud012,glaqud013,glaqud014,glaqud015,",
                  "glaqud016,glaqud017,glaqud018,glaqud019,glaqud020,glaqud021,glaqud022,",
                  "glaqud023,glaqud024,glaqud025,glaqud026,glaqud027,glaqud028,glaqud029,glaqud030 FROM glaq_t ",

                  " WHERE glaqent = ",g_enterprise,
                  "   AND glaqld = '",p_glapld,"'",
                  "   AND glaqdocno = '",p_glapdocno,"'"
      PREPARE s_voucher_ins_nmbc_pre FROM l_sql
      DECLARE s_voucher_ins_nmbc_cs CURSOR FOR s_voucher_ins_nmbc_pre
      

      LET l_sql = "SELECT glbcent,glbcld,glbccomp,glbcdocno,glbcseq,glbcseq1,glbc001,glbc002,",
                  "glbc003,glbc004,glbc005,glbc006,glbc007,glbc008,glbc009,glbc010,glbc011,",
                  "glbc012,glbc013,glbc014,glbcud001,glbcud002,glbcud003,glbcud004,glbcud005,",
                  "glbcud006,glbcud007,glbcud008,glbcud009,glbcud010,glbcud011,glbcud012,",
                  "glbcud013,glbcud014,glbcud015,glbcud016,glbcud017,glbcud018,glbcud019,",
                  "glbcud020,glbcud021,glbcud022,glbcud023,glbcud024,glbcud025,glbcud026,",
                  "glbcud027,glbcud028,glbcud029,glbcud030,glbc015 FROM glbc_t  ",
                  " WHERE glbcent = ",g_enterprise,
                  "   AND glbcld = '",p_glapld,"'",
                  "   AND glbcdocno = ? ",
                  "   AND glbcseq = ? ",
                  "   AND glbc001 = '",l_glap002,"'",
                  "   AND glbc002 = '",l_glap004,"'",
                  "   AND glbc010 = '1' "
      PREPARE s_voucher_ins_glbc_pre FROM l_sql
      DECLARE s_voucher_ins_glbc_cs CURSOR FOR s_voucher_ins_glbc_pre
      
      FOREACH s_voucher_ins_nmbc_cs INTO l_glaq.*
         CALL s_voucher_glac016_get(l_glaa004,l_glaq.glaq002) RETURNING l_glac016
         IF l_glac016 = 'Y' THEN 
            LET l_nmbc.nmbcent   = g_enterprise
            LET l_nmbc.nmbcownid = g_user
            LET l_nmbc.nmbcowndp = g_dept
            LET l_nmbc.nmbccrtid = g_user
            LET l_nmbc.nmbccrtdp = g_dept 
            LET l_nmbc.nmbccrtdt = cl_get_current()
            LET l_nmbc.nmbcmodid = g_user
            LET l_nmbc.nmbcmoddt = cl_get_current()
            LET l_nmbc.nmbccnfid = g_user
            LET l_nmbc.nmbccnfdt = cl_get_current()
            LET l_nmbc.nmbcpstid = g_user
            LET l_nmbc.nmbcpstdt = cl_get_current()
            #171003-00005#2--mod--s--xul
           #LET l_nmbc.nmbcstus  = 'S'
            LET l_nmbc.nmbcstus  = 'Y' 
            #171003-00005#2--mod--e--xul
            LET l_nmbc.nmbccomp  = l_glaq.glaqcomp
            LET l_nmbc.nmbcsite  = l_glaq.glaqcomp
            LET l_nmbc.nmbcorga  = l_glaq.glaq017 
            LET l_nmbc.nmbcdocno = l_glaq.glaqdocno
            LET l_nmbc.nmbcseq   = l_glaq.glaqseq
            LET l_nmbc.nmbc001   = 'aglt310'
            
            SELECT nmas002 INTO l_nmbc.nmbc002
              FROM nmaa_t,nmas_t
             WHERE nmaaent = g_enterprise
               AND nmaaent = nmasent
               AND nmaa001 = nmas001
               AND nmaa005 = l_glaq.glaq014
               AND nmas003 = l_glaq.glaq005
               AND nmaa002 IN (SELECT ooef001 FROM ooef_t WHERE ooefent = g_enterprise
                                               AND ooef017 = l_glaq.glaqcomp) 
             ORDER BY nmaa001
            
            IF cl_null(l_nmbc.nmbc002) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = l_nmbc.nmbc002
               LET g_errparam.code   = 'agl-00546'
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               LET r_success = FALSE
               CONTINUE FOREACH 
            END IF            
            LET l_nmbc.nmbc003   = l_glaq.glaq022
            LET l_nmbc.nmbc005   = l_glapdocdt
            IF l_glaq.glaq003 <> 0 THEN 
               LET l_nmbc.nmbc006 = '1'
               LET l_nmbc.nmbc113 =  l_glaq.glaq003
               LET l_nmbc.nmbc123 =  l_glaq.glaq040
               LET l_nmbc.nmbc133 =  l_glaq.glaq043
            END IF
            IF l_glaq.glaq004 <> 0 THEN 
               LET l_nmbc.nmbc006 = '2'
               LET l_nmbc.nmbc113 =  l_glaq.glaq004
               LET l_nmbc.nmbc123 =  l_glaq.glaq041
               LET l_nmbc.nmbc133 =  l_glaq.glaq044
            END IF
            IF cl_null(l_nmbc.nmbc113) THEN LET l_nmbc.nmbc113 = 0 END IF
            IF cl_null(l_nmbc.nmbc123) THEN LET l_nmbc.nmbc123 = 0 END IF
            IF cl_null(l_nmbc.nmbc133) THEN LET l_nmbc.nmbc133 = 0 END IF
            LET l_nmbc.nmbc007 = l_glaq.glaq016
            LET l_nmbc.nmbc010 = ''
            LET l_nmbc.nmbc014 = ''
            LET l_nmbc.nmbc100 = l_glaq.glaq005
            LET l_nmbc.nmbc101 = l_glaq.glaq006
            LET l_nmbc.nmbc103 = l_glaq.glaq010
            LET l_nmbc.nmbc121 = l_glaq.glaq039
            LET l_nmbc.nmbc131 = l_glaq.glaq042
            LET l_nmbc.nmbc012 = l_glaq.glaq011
            LET l_nmbc.nmbc013 = l_glaq.glaq015
            

            INSERT INTO nmbc_t (nmbcent,nmbcownid,nmbcowndp,nmbccrtid,nmbccrtdp,nmbccrtdt,nmbcmodid,nmbcmoddt,
                                nmbccnfid,nmbccnfdt,nmbcpstid,nmbcpstdt,nmbcstus,nmbccomp,nmbcsite,nmbcdocno,
                                nmbcseq,nmbc001,nmbc002,nmbc003,nmbc004,nmbc005,nmbc006,nmbc007,nmbc008,nmbc009,
                                nmbc010,nmbc011,nmbc100,nmbc101,nmbc103,nmbc113,nmbc121,nmbc123,nmbc131,nmbc133,
                                nmbcud001,nmbcud002,nmbcud003,nmbcud004,nmbcud005,nmbcud006,nmbcud007,nmbcud008,
                                nmbcud009,nmbcud010,nmbcud011,nmbcud012,nmbcud013,nmbcud014,nmbcud015,nmbcud016,
                                nmbcud017,nmbcud018,nmbcud019,nmbcud020,nmbcud021,nmbcud022,nmbcud023,nmbcud024,
                                nmbcud025,nmbcud026,nmbcud027,nmbcud028,nmbcud029,nmbcud030,nmbc012,nmbc013,
                                nmbc014,nmbc015,nmbc016,nmbc017,nmbcorga)
             VALUES(l_nmbc.nmbcent,l_nmbc.nmbcownid,l_nmbc.nmbcowndp,l_nmbc.nmbccrtid,l_nmbc.nmbccrtdp,l_nmbc.nmbccrtdt,l_nmbc.nmbcmodid,l_nmbc.nmbcmoddt,
                    l_nmbc.nmbccnfid,l_nmbc.nmbccnfdt,l_nmbc.nmbcpstid,l_nmbc.nmbcpstdt,l_nmbc.nmbcstus,l_nmbc.nmbccomp,l_nmbc.nmbcsite,l_nmbc.nmbcdocno,
                    l_nmbc.nmbcseq,l_nmbc.nmbc001,l_nmbc.nmbc002,l_nmbc.nmbc003,l_nmbc.nmbc004,l_nmbc.nmbc005,l_nmbc.nmbc006,l_nmbc.nmbc007,l_nmbc.nmbc008,l_nmbc.nmbc009,
                    l_nmbc.nmbc010,l_nmbc.nmbc011,l_nmbc.nmbc100,l_nmbc.nmbc101,l_nmbc.nmbc103,l_nmbc.nmbc113,l_nmbc.nmbc121,l_nmbc.nmbc123,l_nmbc.nmbc131,l_nmbc.nmbc133,
                    l_nmbc.nmbcud001,l_nmbc.nmbcud002,l_nmbc.nmbcud003,l_nmbc.nmbcud004,l_nmbc.nmbcud005,l_nmbc.nmbcud006,l_nmbc.nmbcud007,l_nmbc.nmbcud008,
                    l_nmbc.nmbcud009,l_nmbc.nmbcud010,l_nmbc.nmbcud011,l_nmbc.nmbcud012,l_nmbc.nmbcud013,l_nmbc.nmbcud014,l_nmbc.nmbcud015,l_nmbc.nmbcud016,
                    l_nmbc.nmbcud017,l_nmbc.nmbcud018,l_nmbc.nmbcud019,l_nmbc.nmbcud020,l_nmbc.nmbcud021,l_nmbc.nmbcud022,l_nmbc.nmbcud023,l_nmbc.nmbcud024,
                    l_nmbc.nmbcud025,l_nmbc.nmbcud026,l_nmbc.nmbcud027,l_nmbc.nmbcud028,l_nmbc.nmbcud029,l_nmbc.nmbcud030,l_nmbc.nmbc012,l_nmbc.nmbc013,
                    l_nmbc.nmbc014,l_nmbc.nmbc015,l_nmbc.nmbc016,l_nmbc.nmbc017,l_nmbc.nmbcorga)

            IF SQLCA.SQLCODE THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = p_glapld
               LET g_errparam.code   = sqlca.sqlcode
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               LET r_success = FALSE
            END IF 
               
            FOREACH s_voucher_ins_glbc_cs USING l_glaq.glaqdocno,l_glaq.glaqseq INTO l_glbc.*
               LET l_glbc.glbc010 = '2'
               LET l_glbc.glbc015 = 'S'
               

                INSERT INTO glbc_t (glbcent,glbcld,glbccomp,glbcdocno,glbcseq,glbcseq1,glbc001,glbc002,glbc003,glbc004,glbc005,
                                    glbc006,glbc007,glbc008,glbc009,glbc010,glbc011,glbc012,glbc013,glbc014,glbcud001,glbcud002,
                                    glbcud003,glbcud004,glbcud005,glbcud006,glbcud007,glbcud008,glbcud009,glbcud010,glbcud011,
                                    glbcud012,glbcud013,glbcud014,glbcud015,glbcud016,glbcud017,glbcud018,glbcud019,glbcud020,
                                    glbcud021,glbcud022,glbcud023,glbcud024,glbcud025,glbcud026,glbcud027,glbcud028,glbcud029,
                                    glbcud030,glbc015)
                 VALUES(l_glbc.glbcent,l_glbc.glbcld,l_glbc.glbccomp,l_glbc.glbcdocno,l_glbc.glbcseq,l_glbc.glbcseq1,l_glbc.glbc001,l_glbc.glbc002,l_glbc.glbc003,l_glbc.glbc004,l_glbc.glbc005,
                        l_glbc.glbc006,l_glbc.glbc007,l_glbc.glbc008,l_glbc.glbc009,l_glbc.glbc010,l_glbc.glbc011,l_glbc.glbc012,l_glbc.glbc013,l_glbc.glbc014,l_glbc.glbcud001,l_glbc.glbcud002,
                        l_glbc.glbcud003,l_glbc.glbcud004,l_glbc.glbcud005,l_glbc.glbcud006,l_glbc.glbcud007,l_glbc.glbcud008,l_glbc.glbcud009,l_glbc.glbcud010,l_glbc.glbcud011,
                        l_glbc.glbcud012,l_glbc.glbcud013,l_glbc.glbcud014,l_glbc.glbcud015,l_glbc.glbcud016,l_glbc.glbcud017,l_glbc.glbcud018,l_glbc.glbcud019,l_glbc.glbcud020,
                        l_glbc.glbcud021,l_glbc.glbcud022,l_glbc.glbcud023,l_glbc.glbcud024,l_glbc.glbcud025,l_glbc.glbcud026,l_glbc.glbcud027,l_glbc.glbcud028,l_glbc.glbcud029,
                        l_glbc.glbcud030,l_glbc.glbc015)
               
               IF SQLCA.SQLCODE THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = p_glapld
                  LET g_errparam.code   = sqlca.sqlcode
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  LET r_success = FALSE
               END IF
            END FOREACH
         END IF
      END FOREACH 
   END IF
   #170411-00094#1--add--e--xul
#   IF g_prog MATCHES 'aapp330' THEN  #170116-00074#4   #170301-00030#8 by 09257 --mark
   IF g_prog MATCHES 'aapp330*' THEN  #170116-00074#4   #170301-00030#8 by 09257 --add
   ELSE                              #170116-00074#4
      #150703-00021#24 ---s--
      SELECT glap008 INTO l_glap008 FROM glap_t WHERE glapent = g_enterprise AND glapdocno = p_glapdocno AND glapld = p_glapld
     # IF l_glap008 = 'P10'  THEN       #170116-00074#4 mark
     IF cl_null(l_glap008) THEN         #170116-00074#4 add
         LET l_sql = "  SELECT glaqseq FROM glaq_t               ",
                     #"   WHERE glaqent = '",g_enterprise,"'      ", #170615-00061#25 mark
                     "   WHERE glaqent = ",g_enterprise,"      ",    #170615-00061#25 add
                     "     AND glaqdocno = '",p_glapdocno,"'     ",
                     "     AND glaqld ='",p_glapld,"'            "               
         PREPARE agl_prep01 FROM l_sql
         DECLARE agl_curs01 CURSOR FOR agl_prep01
         FOREACH agl_curs01 INTO l_glaqseq         
           #更新滾動檔狀態
           CALL s_aapp330_bgbd_upd(p_glapdocno,p_glapld,l_glaqseq,'Y','3')
                      RETURNING g_sub_success,g_errno
           IF NOT g_sub_success THEN
              INITIALIZE g_errparam TO NULL 
              LET g_errparam.extend = '' 
              LET g_errparam.code   = g_errno 
              LET g_errparam.popup  = TRUE 
              CALL cl_err()
              LET r_success = FALSE 
           END IF                       
         END FOREACH   
      END IF
      #150703-00021#24 ---e--
   END IF #170116-00074#4
   
   RETURN r_success
#===========================


END FUNCTION

PUBLIC FUNCTION s_voucher_glaq020_chk(p_oocq001,p_oocq002)
    DEFINE p_oocq001    LIKE oocq_t.oocq001
    DEFINE p_oocq002    LIKE oocq_t.oocq002
    
    DEFINE l_oocqstus     LIKE oocq_t.oocqstus

   LET g_errno = ''
   SELECT oocqstus INTO l_oocqstus FROM oocq_t
    WHERE oocqent = g_enterprise
      AND oocq001 = p_oocq001
      AND oocq002 = p_oocq002
   CASE
     WHEN SQLCA.SQLCODE = 100
        IF p_oocq001 = '287' THEN
          #LET g_errno = 'apm-00092'  #160321-00016#19 mark
           LET g_errno = 'sub-01303'  #160321-00016#19 
        END IF
        IF p_oocq001 = '281' THEN
           LET g_errno = 'axm-00003'
        END IF
        IF p_oocq001 = '2002' THEN
           LET g_errno = 'apr-00218'
        END IF

     WHEN l_oocqstus = 'N'
        IF p_oocq001 = '287' THEN
          #LET g_errno = 'apm-00093'  #160321-00016#19 mark
           LET g_errno = 'sub-01302'  #160321-00016#19 
        END IF
        IF p_oocq001 = '281' THEN
          #LET g_errno = 'axm-00004'  #160321-00016#19 mark
           LET g_errno = 'sub-01302'  #160321-00016#19 
        END IF
        IF p_oocq001 = '2002' THEN
           LET g_errno = 'apr-00233'
        END IF
   END CASE
#+客商检查
END FUNCTION

PUBLIC FUNCTION s_voucher_glaq021_chk(p_pmaa001)
   DEFINE p_pmaa001     LIKE pmaa_t.pmaa001
   DEFINE l_pmaastus    LIKE pmaa_t.pmaastus

   LET g_errno = ''
   SELECT pmaastus INTO l_pmaastus FROM pmaa_t
    WHERE pmaaent = g_enterprise
      AND pmaa001 = p_pmaa001

   CASE
      WHEN SQLCA.SQLCODE = 100   LET g_errno = 'apm-00028'
      #WHEN l_pmaastus = 'N'      LET g_errno = 'apm-00029' #160321-00016#19 mark
      WHEN l_pmaastus = 'N'      LET g_errno = 'sub-01302'  #160321-00016#19 add
   END CASE
#+产品分类检查
END FUNCTION

PUBLIC FUNCTION s_voucher_glaq024_chk(p_glaq024)
  DEFINE p_glaq024   LIKE glaq_t.glaq024
  DEFINE l_rtaxstus  LIKE rtax_t.rtaxstus
  DEFINE l_rtax005   LIKE rtax_t.rtax005
  DEFINE l_rtax004   LIKE rtax_t.rtax004  #160608-00023#1 add
  DEFINE l_ooaa002   LIKE ooaa_t.ooaa002  #160608-00023#1 add
  
  LET g_errno = ''
  SELECT rtaxstus,rtax005,rtax004 INTO l_rtaxstus,l_rtax005,l_rtax004 FROM rtax_t  #160608-00023#1 add rtax004
   WHERE rtaxent = g_enterprise
     AND rtax001 = p_glaq024
   
   #品类管理层级aoos010
   CALL cl_get_para(g_enterprise,'','E-CIR-0001') RETURNING l_ooaa002 #160608-00023#1 add
   
  CASE
     WHEN SQLCA.SQLCODE = 100   LET g_errno = 'aoo-00137'
     #WHEN l_rtaxstus = 'N'      LET g_errno = 'aoo-00138' #160321-00016#19 mark
     WHEN l_rtaxstus = 'N'      LET g_errno = 'sub-01302'  #160321-00016#19 add
#     WHEN l_rtax005 <> '0'      LET g_errno = 'art-00003' #160608-00023#1 mark
     WHEN l_rtax004 <> l_ooaa002 LET g_errno='agl-00460' #160608-00023#1
  END CASE
#+ 预算编码检查
END FUNCTION

PUBLIC FUNCTION s_voucher_glaq026_chk(p_glaq026)
    DEFINE p_glaq026     LIKE glaq_t.glaq026
    DEFINE l_bgaastus    LIKE bgaa_t.bgaastus
    
    LET g_errno = ''
     SELECT bgaastus INTO l_bgaastus FROM bgaa_t
   WHERE bgaaent = g_enterprise
     AND bgaa001 = p_glaq026

  CASE
     WHEN SQLCA.SQLCODE = 100   LET g_errno = 'abg-00007'
     #WHEN l_bgaastus = 'N'      LET g_errno = 'abg-00008' #160321-00016#19 mark
     WHEN l_bgaastus = 'N'      LET g_errno = 'sub-01302'  #160321-00016#19 add
  END CASE
#+ 自由核算项检查
END FUNCTION

PUBLIC FUNCTION s_voucher_free_account_chk(p_glaf001,p_glaf002,p_ctrl)
   DEFINE p_glaf001      LIKE glaf_t.glaf001    #自由核算项类型
   DEFINE p_glaf002      LIKE glaf_t.glaf002    #自由核算项值
   DEFINE p_ctrl         LIKE type_t.chr5       #控制方式
   DEFINE r_errno        LIKE type_t.chr10      #错误编号
   DEFINE l_glafstus     LIKE glaf_t.glafstus
   DEFINE l_glae002      LIKE glae_t.glae002
   DEFINE l_glae003      LIKE glae_t.glae003
   DEFINE l_glae004      LIKE glae_t.glae004
   DEFINE l_cnt          LIKE type_t.num5
   DEFINE l_sql          STRING  
   
   LET r_errno = '' 
   LET l_glae002 = ''
   LET l_glae003 = ''
   LET l_glae004 = ''
   #.抓出改类型对应的资料来源，来源档案，来源编号栏位
   SELECT glae002,glae003,glae004 INTO l_glae002,l_glae003,l_glae004 FROM glae_t
    WHERE glaeent = g_enterprise
      AND glae001 = p_glaf001
      #来源类型为1.‘基本资料’，則檢核來源編號欄位是否存在,並依核算项类型对应的控制方式，檢核核算项值的合理性  
   IF l_glae002 = '1' THEN
      #SELECT COUNT(*) INTO l_cnt FROM dzeb_t #170615-00061#25 mark
      SELECT COUNT(1) INTO l_cnt FROM dzeb_t  #170615-00061#25 add
       WHERE dzeb001 = l_glae003
         AND dzeb002 = l_glae004
      IF l_cnt = 0  THEN
         LET r_errno = 'agl-00073'
         RETURN r_errno 
      END IF 
      IF p_ctrl = '3'  THEN
         LET l_cnt = 0
         CALL s_voucher_make_sql(l_glae003,l_glae004,p_glaf002) RETURNING l_sql
         PREPARE s_voucher_chk  FROM l_sql
         EXECUTE s_voucher_chk INTO l_cnt             
         IF  l_cnt = 0  THEN
             LET r_errno = 'agl-00108'
             RETURN r_errno
          END IF
      END IF
   END IF   
      #来源类型为2.预设值，則輸入值應檢核是否存在自由核算項資料檔,並依核算项类型对应的控制方式，檢核核算项值的合理性  
      IF l_glae002 = '2' THEN
         SELECT glafstus INTO l_glafstus FROM glaf_t
             WHERE glafent = g_enterprise
               AND glaf001 = p_glaf001
               AND glaf002 = p_glaf002
         IF SQLCA.SQLCODE = 100  THEN
            LET r_errno = 'agl-00062'
            RETURN r_errno
          END IF
          IF p_ctrl = '3'  THEN 
             IF l_glafstus = 'N'  THEN
                #LET g_errno = 'agl-00063' #160321-00016#19 mark
                LET g_errno = 'sub-01302'  #160321-00016#19 add
                RETURN r_errno
             END IF                
          END IF 
      END IF 
      #若来源类型为3.'自行輸入'則user可任意輸入且不需檢核
      RETURN r_errno      
#组sql，检查自由核算项值
END FUNCTION

PUBLIC FUNCTION s_voucher_make_sql(p_glae003,p_glae004,p_glaf002)
   DEFINE p_glae003 LIKE glae_t.glae003    #来源档案
   DEFINE p_glae004 LIKE glae_t.glae004    #来源编号栏位
   DEFINE p_glaf002 LIKE glaf_t.glaf002    #核算项值
   DEFINE l_dzeb002 LIKE dzeb_t.dzeb002
   DEFINE l_dzeb006 LIKE dzeb_t.dzeb006
   DEFINE l_sql     STRING
   DEFINE r_sql     STRING

   #LET r_sql = " SELECT COUNT(*) FROM ",p_glae003 , #170615-00061#25 mark
   LET r_sql = " SELECT COUNT(1) FROM ",p_glae003 ,  #170615-00061#25 add
               "  WHERE ", p_glae004," = '",p_glaf002,"'"
               
   LET l_sql = "SELECT dzeb002,dzeb006 FROM dzeb_t ",
               " WHERE dzeb001 = '", p_glae003,"'"
   PREPARE s_voucher_make_sql_pre FROM l_sql
   DECLARE s_voucher_make_sql_cs CURSOR FOR s_voucher_make_sql_pre
   FOREACH s_voucher_make_sql_cs INTO l_dzeb002,l_dzeb006
      #判断是否有ent栏位
      IF l_dzeb006 = 'N802' THEN
         #LET r_sql = r_sql CLIPPED," AND ",l_dzeb002 ," ='",g_enterprise,"' " #170615-00061#25 mark
         LET r_sql = r_sql CLIPPED," AND ",l_dzeb002 ," = ",g_enterprise," "   #170615-00061#25 add
      END IF
      #判断是否有stus栏位
      IF l_dzeb002 LIKE '%stus'  THEN
         LET r_sql = r_sql CLIPPED," AND ",l_dzeb002 ," ='Y'"
      END IF
   END FOREACH
   RETURN r_sql
END FUNCTION
# Descriptions...: 傳票憑證過帳
# Memo...........:
# Usage..........: CALL s_voucher_post_chk(p_glapld,p_glapdocno)
#                  RETURNING r_success
# Input parameter: p_ld           帐套
#                : p_glapdocno    傳票編號
# Return code....: r_success      成功否标识位
# Date & Author..: 2013/09/10 By minpp
# Modify.........:
#=============================
PUBLIC FUNCTION s_voucher_post_chk(p_glapld,p_glapdocno)
   DEFINE p_glapld           LIKE glap_t.glapld              #帐别
   DEFINE p_glapdocno        LIKE glap_t.glapdocno           #传票编号
   DEFINE l_glap007          LIKE glap_t.glap007             #来源类型
   DEFINE r_success          LIKE type_t.num5                #檢核狀態
   DEFINE r_errno            LIKE type_t.chr80               #錯誤訊息
   DEFINE l_glapstus         LIKE glap_t.glapstus            #状态码
   DEFINE l_glapdocdt        LIKE glap_t.glapdocdt           #单据日期
   DEFINE l_glapcomp         LIKE glap_t.glapcomp            #法人 #161205-00025#4 add
   DEFINE l_glap002          LIKE glap_t.glap002             #年度
   DEFINE l_glap004          LIKE glap_t.glap004             #期别
   DEFINE l_glar004          LIKE glar_t.glar004             #组合要素
   DEFINE l_glar005          LIKE glar_t.glar005             #借方金额
   DEFINE l_glar006          LIKE glar_t.glar006             #贷方金额
   DEFINE l_glar007          LIKE glar_t.glar007             #借方笔数
   DEFINE l_glar008          LIKE glar_t.glar008             #贷方笔数
   DEFINE l_glar010          LIKE glar_t.glar010             #原币借方金额
   DEFINE l_glar011          LIKE glar_t.glar011             #原币贷方金额 
   DEFINE l_glar034          LIKE glar_t.glar034             #借方金額(本位幣二)
   DEFINE l_glar035          LIKE glar_t.glar035             #贷方金额（本位币二）
   DEFINE l_glar036          LIKE glar_t.glar036             #借方金額(本位幣三)
   DEFINE l_glar037          LIKE glar_t.glar037             #贷方金额（本位币三）
   DEFINE l_cnt              LIKE type_t.num5
   DEFINE l_sql              STRING
   DEFINE l_glaa004          LIKE glaa_t.glaa004
   DEFINE l_glac002          LIKE glac_t.glac002
   DEFINE l_glac004          LIKE glac_t.glac004
   DEFINE l_success          LIKE type_t.num5
   #写入日志文件
   DEFINE l_ch               base.Channel
   DEFINE l_logFile          STRING
   DEFINE l_path             STRING
   DEFINE l_str              STRING
   DEFINE l_glaa103          LIKE glaa_t.glaa103
   DEFINE l_glap012          LIKE glap_t.glap012
   DEFINE l_glap001          LIKE glap_t.glap001 #151204-00001#1 add
   
   WHENEVER ERROR CONTINUE
   LET r_errno = ''
   LET r_success = TRUE
   INITIALIZE g_glaq.* TO NULL
   #资料检查
   #(1).传入参数为空，返回
   #170816-00007#130 by 09773 mod(S)
#   IF cl_null(p_glapld) OR cl_null(p_glapdocno) THEN
#      LET r_success = FALSE
##      CALL cl_errmsg('post',p_glapdocno,'','sub-00110',1)
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.extend = p_glapdocno
#      LET g_errparam.code   = 'sub-00110'
#      LET g_errparam.popup  = TRUE 
#      CALL cl_err()
#   END IF
   #170816-00007#130 by 09773 mod(E)
   
   #170816-00007#130 by 09773 add(S)
   #修改錯誤訊息報錯內容
   LET g_msg = ''
   LET g_colname_1 = ''
   LET g_comment_1 = ''
   IF cl_null(p_glapld) THEN
      CALL s_azzi902_get_gzzd("aapi511","lbl_glabld") RETURNING g_colname_1,g_comment_1  #賬套 
      LET g_msg = g_colname_1   
   END IF
   IF cl_null(p_glapdocno) THEN
      LET g_colname_1 = ''
      LET g_comment_1 = ''    
      CALL s_azzi902_get_gzzd("aglt310_07","lbl_glapdocno") RETURNING g_colname_1,g_comment_1   #單號
      IF g_msg IS NULL THEN   
         LET g_msg = g_colname_1   
      ELSE   
         LET g_msg = g_msg,",",g_colname_1
      END IF        
   END IF
   IF NOT cl_null(g_msg) THEN
      LET r_success = FALSE
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code = 'sub-00788'  #%1傳入值為空(錯誤)
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_msg 
      CALL cl_err()
   END IF   
   #170816-00007#130 by 09773 add(E)
   
   #(2).狀態碼=确认,才可進行確認動作
   #161205-00025#4--mod--str--
#   SELECT glapstus,glapdocdt,glap012,glap001 INTO l_glapstus,l_glapdocdt,l_glap012,l_glap001 FROM glap_t   #151204-00001#1 add glap001
   SELECT glapstus,glapdocdt,glap012,glap001,glap002,
          glap004,glap007,glapcomp 
     INTO l_glapstus,l_glapdocdt,l_glap012,l_glap001,l_glap002,
          l_glap004,l_glap007,l_glapcomp
     FROM glap_t
   #161205-00025#4--mod--end
    WHERE glapent = g_enterprise
      AND glapld = p_glapld
      AND glapdocno = p_glapdocno
   IF l_glapstus <>'Y' THEN
      LET r_success = FALSE
#      CALL cl_errmsg('glapstus',p_glapdocno,'','agl-00053',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code   = 'agl-00053'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
   END IF 
    #(3).有單頭資料但無單身資料返回报错
   LET l_cnt = 0
#   SELECT count(*) INTO l_cnt FROM glaq_t #161205-00025#4 mark
   SELECT COUNT(1) INTO l_cnt FROM glaq_t  #161205-00025#4 add
    WHERE glaqent = g_enterprise
      AND glaqld  = p_glapld
      AND glaqdocno = p_glapdocno
   IF l_cnt = 0  THEN
      LET r_success = FALSE
#      CALL cl_errmsg('',p_glapdocno,'','agl-00066',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code   = 'agl-00066'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
   END IF 
   
   #(4).檢查當單據日期小於等於關帳日期時，不可異動單據
   IF l_glap001 <> '6' THEN #151204-00001#1 add
      CALL s_fin_date_close_chk(p_glapld,'','AGL',l_glapdocdt) RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
      END IF
   END IF   #151204-00001#1 add
   #2015/9/18--by--02599--add--str--
   #(5).判断账套对应参数:glaa103(未列印的傳票可否進行過帳)='N' 时,凭证没有打印过不可以过账
   #161205-00025#4--mod--str--
#   SELECT glaa103 INTO l_glaa103 FROM glaa_t WHERE glaaent=g_enterprise AND glaald=p_glapld   
   SELECT glaa004,glaa103 
     INTO l_glaa004,l_glaa103 
     FROM glaa_t 
    WHERE glaaent=g_enterprise AND glaald=p_glapld
   #161205-00025#4--mod--end  
   IF l_glaa103='N' AND (l_glap012=0 OR l_glap012 IS NULL) 
#      AND g_prog <> 'aglp535' AND g_prog <> 'aglp530' AND g_prog <> 'aglp570' THEN   #151103-00017#1 add 'aglp535 aglp530 aglp570'   #170301-00030#8 by 09257 --mark
      AND g_prog NOT MATCHES 'aglp535*' AND g_prog NOT MATCHES 'aglp530*' AND g_prog NOT MATCHES 'aglp570*' THEN   #151103-00017#1 add 'aglp535 aglp530 aglp570'   #170301-00030#8 by 09257 --add      
      LET r_success = FALSE
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code   = 'agl-00363'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
   END IF
   #2015/9/18--by--02599--add--end
   
   #170103-00019#1--add--str--
   #(6)检核细项立冲账资料
   IF l_glap001 MATCHES'[123]' AND l_glap007<>'AC' AND l_glap007<>'RA' THEN #170214-00033#1 add glap007限制条件
      LET l_success = TRUE
      CALL s_aglt310_glax_and_glay_chk(p_glapld,p_glapdocno) RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
      END IF
   END IF
   #170103-00019#1--add--end

   #当检核有错误时，返回
   IF r_success = FALSE THEN
      RETURN  r_success
   END IF
#161205-00025#4--mark--str--   
#   #更新会计科目余额档
#   #抓取单头该笔资料的年度期别,来源类型
#   SELECT glap002,glap004,glap007 INTO l_glap002,l_glap004,l_glap007 FROM glap_t
#    WHERE glapent = g_enterprise
#      AND glapld = p_glapld
#      AND glapdocno = p_glapdocno
#      
#   #抓會計參照表
#   SELECT glaa004 INTO l_glaa004 FROM glaa_t 
#    WHERE glaaent = g_enterprise AND glaald = p_glapld
#161205-00025#4--mark--end    
    #写入日志文件
    #先讀取$ERP, 若無則採用程序写死的路径
    LET l_path = FGL_GETENV("ERP")
    IF cl_null(l_path) THEN
       LET l_path = "/u1/t10dev/erp"
    END IF
    LET l_path = l_path,"/agl/4gl/log/"
#    #将log文件放在temp目录下
#    LET l_path = FGL_GETENV("TEMPDIR"),"/"
    LET l_logFile = l_path,g_today USING "YYYYMMDD","_",p_glapdocno,"_post",".log"
    LET l_ch = base.Channel.create()
    CALL l_ch.setDelimiter(NULL)
    CALL l_ch.openFile(l_logFile, "a")
    LET l_str = "#--------------------------- (", CURRENT YEAR TO SECOND,"'",p_glapdocno,"'", "post Start) ---------------------------#\n"
    CALL l_ch.write(l_str)
    LET l_str = "执行过账操作程序：",g_prog,"\n",
                "执行人员：",g_user,"\n"
    CALL l_ch.write(l_str)
    LET l_str="s_voucher_post_chk()写入glar_t Start","\n"
    CALL l_ch.write(l_str)
    LET l_str = "FOREACH抓出单身资料","\n"
    CALL l_ch.write(l_str)
    
   #抓取单身的资料
#161205-00025#4--mark--str--   
#   LET l_sql = " SELECT * FROM glaq_t ",
#               "  WHERE glaqent = '",g_enterprise,"'",
#               "    AND glaqld  = '",p_glapld,"'",
#               "    AND glaqdocno = '",p_glapdocno,"'"
#   PREPARE s_voucher_post_ins   FROM l_sql
#   DECLARE s_voucher_post_cs CURSOR FOR s_voucher_post_ins
#161205-00025#4--mark--end   
   #161205-00025#4--add--str--
   LET l_sql = " SELECT glaq002,glaq005,glaq017,glaq018,glaq019,glaq020,glaq021,",
               "        glaq022,glaq023,glaq024,glaq051,glaq052,glaq053,glaq025,glaq027,glaq028,",
               "        glaq029,glaq030,glaq031,glaq032,glaq033,glaq034,glaq035,glaq036,glaq037,glaq038,",
               "        SUM(CASE WHEN glaq003<>0 THEN glaq010 ELSE 0 END),",
               "        SUM(CASE WHEN glaq004<>0 THEN glaq010 ELSE 0 END),",
               "        SUM(glaq003),SUM(glaq004),SUM(glaq040),SUM(glaq041),SUM(glaq043),SUM(glaq044) ",
               "   FROM glaq_t ",
               "  WHERE glaqent = ",g_enterprise,
               "    AND glaqld  = '",p_glapld,"'",
               "    AND glaqdocno = '",p_glapdocno,"'",
               "  GROUP BY glaq002,glaq005,glaq017,glaq018,glaq019,glaq020,glaq021,",
               "        glaq022,glaq023,glaq024,glaq051,glaq052,glaq053,glaq025,glaq027,glaq028,",
               "        glaq029,glaq030,glaq031,glaq032,glaq033,glaq034,glaq035,glaq036,glaq037,glaq038 "
   PREPARE s_voucher_post_ins FROM l_sql
   DECLARE s_voucher_post_cs CURSOR FOR s_voucher_post_ins
   
   LET l_str = " SELECT COUNT(1) FROM glaq_t ",
               "  WHERE glaqent = ",g_enterprise,
               "    AND glaqld  = '",p_glapld,"'",
               "    AND glaqdocno = '",p_glapdocno,"'",
               "    AND glaq002=? AND glaq005=? AND glaq017=? AND glaq018=? AND glaq019=? ",
               "    AND glaq020=? AND glaq021=? AND glaq022=? AND glaq023=? AND glaq024=? ",
               "    AND glaq051=? AND glaq052=? AND glaq053=? AND glaq025=? AND glaq027=? ",
               "    AND glaq028=? AND glaq029=? AND glaq030=? AND glaq031=? AND glaq032=? ",
               "    AND glaq033=? AND glaq034=? AND glaq035=? AND glaq036=? AND glaq037=? ",
               "    AND glaq038=? "
   #借方笔数            
   LET l_sql = l_str," AND glaq003 <> 0 "
   PREPARE s_voucher_post_count_d_pr FROM l_sql   
   #贷方笔数
   LET l_sql = l_str," AND glaq004 <> 0 "
   PREPARE s_voucher_post_count_c_pr FROM l_sql 
   
   LET l_str = " WHERE glarent =",g_enterprise,
               "   AND glarld  = '",p_glapld,"'",
               "   AND glar002 = ",l_glap002,  
               "   AND glar003 = ",l_glap004,
               "   AND glar001 = ? AND glar009 = ? AND glar012 = ? AND glar013 = ? AND glar014 = ?",
               "   AND glar015 = ? AND glar016 = ? AND glar017 = ? AND glar018 = ? AND glar019 = ?",
               "   AND glar051 = ? AND glar052 = ? AND glar053 = ? AND glar020 = ? AND glar022 = ?",
               "   AND glar023 = ? AND glar024 = ? AND glar025 = ? AND glar026 = ? AND glar027 = ?",
               "   AND glar028 = ? AND glar029 = ? AND glar030 = ? AND glar031 = ? AND glar032 = ?",
               "   AND glar033 = ? "
   #检查该笔资料在余额档中是否存在
   LET l_sql = "SELECT COUNT(1) FROM glar_t ",l_str
   PREPARE s_voucher_post_count_pr FROM l_sql
   
   #更新glar
   LET l_sql = "UPDATE glar_t SET glar005 = glar005 + ?,",
               "                  glar006 = glar006 + ?,",
               "                  glar007 = glar007 + ?,",
               "                  glar008 = glar008 + ?,",
               "                  glar010 = glar010 + ?,",
               "                  glar011 = glar011 + ?,",
               "                  glar034 = glar034 + ?,",
               "                  glar035 = glar035 + ?,",
               "                  glar036 = glar036 + ?,",
               "                  glar037 = glar037 + ? ",
               l_str
   PREPARE s_voucher_post_upd_glar_pr FROM l_sql
   
   #插入余额档
   LET l_sql = "INSERT INTO glar_t (glarent,glarcomp,glarld,glar001,glar002,glar003,",
               "                    glar004,glar005,glar006,glar007,glar008,",
               "                    glar009,glar010,glar011,glar012,glar013,",
               "                    glar014,glar015,glar016,glar017,glar018,",
               "                    glar019,glar020,glar022,glar023,",
               "                    glar024,glar025,glar026,glar027,glar028,",
               "                    glar029,glar030,glar031,glar032,glar033,",
               "                    glar034,glar035,glar036,glar037,",
               "                    glar051,glar052,glar053) ",
               " VALUES(?,?,?,?,?,?,",
               "        ?,?,?,?,?,",
               "        ?,?,?,?,?,",
               "        ?,?,?,?,?,",
               "        ?,?,?,?,",
               "        ?,?,?,?,?,",
               "        ?,?,?,?,?,",
               "        ?,?,?,?,",
               "        ?,?,?)"
   PREPARE s_voucher_post_ins_glar_pr FROM l_sql
            
   #抓取上层科目
   LET l_sql = "SELECT glac004 FROM glac_t ",
               " WHERE glacent = ",g_enterprise,
               "   AND glac001 ='",l_glaa004,"' AND glac002=?"
   PREPARE s_voucher_post_sel_glac004_pr FROM l_sql
   #161205-00025#4--add--end
   
   #161205-00025#4--mod--str--
#   FOREACH s_voucher_post_cs INTO g_glaq.*
   FOREACH s_voucher_post_cs INTO g_glaq.glaq002,g_glaq.glaq005,g_glaq.glaq017,g_glaq.glaq018,g_glaq.glaq019,
                                  g_glaq.glaq020,g_glaq.glaq021,g_glaq.glaq022,g_glaq.glaq023,g_glaq.glaq024,
                                  g_glaq.glaq051,g_glaq.glaq052,g_glaq.glaq053,g_glaq.glaq025,g_glaq.glaq027,
                                  g_glaq.glaq028,g_glaq.glaq029,g_glaq.glaq030,g_glaq.glaq031,g_glaq.glaq032,
                                  g_glaq.glaq033,g_glaq.glaq034,g_glaq.glaq035,g_glaq.glaq036,g_glaq.glaq037,
                                  g_glaq.glaq038,l_glar010,l_glar011,g_glaq.glaq003,g_glaq.glaq004,
                                  g_glaq.glaq040,g_glaq.glaq041,g_glaq.glaq043,g_glaq.glaq044
   #161205-00025#4--mod--end
      #写入日志文件
      LET l_str = " FOREACH s_voucher_post_cs 执行结果：","\n",
                  " SQLCA.sqlcode = ",SQLCA.sqlcode,"\n"
      CALL l_ch.write(l_str)
      
      IF SQLCA.sqlcode THEN
#         CALL cl_errmsg('foreach',p_glapdocno,'',sqlca.sqlcode,1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = p_glapdocno
         LET g_errparam.code   = sqlca.sqlcode
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         LET r_success = FALSE
         EXIT FOREACH
      END IF
       
      #写入日志文件
      LET l_str = " 一次FOREACH 执行开始：glaqseq=",g_glaq.glaqseq,"\n",
                  " SQLCA.sqlcode = ",SQLCA.sqlcode,"\n"
      CALL l_ch.write(l_str)
      IF cl_null(l_glar010) THEN LET l_glar010 = 0  END IF #161205-00025#4 add
      IF cl_null(l_glar011) THEN LET l_glar011 = 0  END IF #161205-00025#4 add
      IF cl_null(g_glaq.glaq003) THEN LET g_glaq.glaq003 = 0  END IF
      IF cl_null(g_glaq.glaq004) THEN LET g_glaq.glaq004 = 0  END IF
      IF cl_null(g_glaq.glaq040) THEN LET g_glaq.glaq040 = 0  END IF
      IF cl_null(g_glaq.glaq041) THEN LET g_glaq.glaq041 = 0  END IF
      IF cl_null(g_glaq.glaq043) THEN LET g_glaq.glaq043 = 0  END IF
      IF cl_null(g_glaq.glaq044) THEN LET g_glaq.glaq044 = 0  END IF
      #依據單身key抓取對應餘額檔中的資料
#      #CE,YE类的凭证组合要素给空格
#      IF l_glap007 <>'CE' AND l_glap007 <> 'YE' THEN
         CALL s_voucher_glar004() RETURNING l_glar004
#      ELSE
#         LET l_glar004 = ' '
#      END IF

      #161205-00025#4--add--str--
      #借方笔数
      LET l_glar007 = 0
      EXECUTE s_voucher_post_count_d_pr 
        USING g_glaq.glaq002,g_glaq.glaq005,g_glaq.glaq017,g_glaq.glaq018,g_glaq.glaq019,
              g_glaq.glaq020,g_glaq.glaq021,g_glaq.glaq022,g_glaq.glaq023,g_glaq.glaq024,
              g_glaq.glaq051,g_glaq.glaq052,g_glaq.glaq053,g_glaq.glaq025,g_glaq.glaq027,
              g_glaq.glaq028,g_glaq.glaq029,g_glaq.glaq030,g_glaq.glaq031,g_glaq.glaq032,
              g_glaq.glaq033,g_glaq.glaq034,g_glaq.glaq035,g_glaq.glaq036,g_glaq.glaq037,
              g_glaq.glaq038
         INTO l_glar007
      #贷方笔数
      LET l_glar008 = 0
      EXECUTE s_voucher_post_count_c_pr 
        USING g_glaq.glaq002,g_glaq.glaq005,g_glaq.glaq017,g_glaq.glaq018,g_glaq.glaq019,
              g_glaq.glaq020,g_glaq.glaq021,g_glaq.glaq022,g_glaq.glaq023,g_glaq.glaq024,
              g_glaq.glaq051,g_glaq.glaq052,g_glaq.glaq053,g_glaq.glaq025,g_glaq.glaq027,
              g_glaq.glaq028,g_glaq.glaq029,g_glaq.glaq030,g_glaq.glaq031,g_glaq.glaq032,
              g_glaq.glaq033,g_glaq.glaq034,g_glaq.glaq035,g_glaq.glaq036,g_glaq.glaq037,
              g_glaq.glaq038
         INTO l_glar008
      #161205-00025#4--add--end
      
      LET l_glac002=g_glaq.glaq002 #會計科目
      
      #写入日志文件
      LET l_str = "WHILE循环，从底层科目向上层抓取统制科目产生对应的科目余额档：","\n"
      CALL l_ch.write(l_str)
      
      WHILE TRUE        
         #检查该笔资料在余额档中是否存在
         #161205-00025#4--mod--str--
#         SELECT COUNT(*) INTO l_cnt FROM glar_t
#          WHERE glarent = g_enterprise
#            AND glarld  = g_glaq.glaqld
#            AND glar001 = l_glac002
#            AND glar002 = l_glap002   
#            AND glar003 = l_glap004
##            AND glar004 = l_glar004
#            AND glar009 = g_glaq.glaq005
#            AND glar012 = g_glaq.glaq017
#            AND glar013 = g_glaq.glaq018
#            AND glar014 = g_glaq.glaq019
#            AND glar015 = g_glaq.glaq020
#            AND glar016 = g_glaq.glaq021
#            AND glar017 = g_glaq.glaq022
#            AND glar018 = g_glaq.glaq023
#            AND glar019 = g_glaq.glaq024
#            AND glar051 = g_glaq.glaq051
#            AND glar052 = g_glaq.glaq052
#            AND glar053 = g_glaq.glaq053
#            AND glar020 = g_glaq.glaq025
#            AND glar022 = g_glaq.glaq027
#            AND glar023 = g_glaq.glaq028
#            AND glar024 = g_glaq.glaq029
#            AND glar025 = g_glaq.glaq030
#            AND glar026 = g_glaq.glaq031
#            AND glar027 = g_glaq.glaq032
#            AND glar028 = g_glaq.glaq033
#            AND glar029 = g_glaq.glaq034
#            AND glar030 = g_glaq.glaq035
#            AND glar031 = g_glaq.glaq036
#            AND glar032 = g_glaq.glaq037
#            AND glar033 = g_glaq.glaq038
         LET l_cnt = 0
         EXECUTE s_voucher_post_count_pr 
           USING l_glac002,g_glaq.glaq005,g_glaq.glaq017,g_glaq.glaq018,g_glaq.glaq019,
                 g_glaq.glaq020,g_glaq.glaq021,g_glaq.glaq022,g_glaq.glaq023,g_glaq.glaq024,
                 g_glaq.glaq051,g_glaq.glaq052,g_glaq.glaq053,g_glaq.glaq025,g_glaq.glaq027,
                 g_glaq.glaq028,g_glaq.glaq029,g_glaq.glaq030,g_glaq.glaq031,g_glaq.glaq032,
                 g_glaq.glaq033,g_glaq.glaq034,g_glaq.glaq035,g_glaq.glaq036,g_glaq.glaq037,
                 g_glaq.glaq038
            INTO l_cnt
         #161205-00025#4--mod--end
         
         #写入日志文件
         LET l_str = "账套",g_glaq.glaqld," 科目",l_glac002,"年度",l_glap002,"期别",l_glap004,"\n",
                     "组合码",l_glar004,"\n",
                     "是否存在：count=",l_cnt,"\n"
         CALL l_ch.write(l_str)
         
         #余额档中没有资料则新增，否则更新 
#161205-00025#4--mod--str--         
#         IF l_cnt = 0   THEN         
#            #如果借方金额不为0，则新增借方金额=借方金额，借方笔数 =1，原币借放金额=借方金额/汇率，对应贷方为0
#            #如果贷方金额不为0，则新增带方金额=贷方金额，贷方笔数 =1，原币贷放金额=贷方金额/汇率，对应借方为0 
#            IF g_glaq.glaq003 <> 0  THEN          
#               LET l_glar007 = 1
#               LET l_glar008 = 0
#            ELSE 
#               LET l_glar007 = 0
#               LET l_glar008 = 1             
#            END IF          
#            IF g_glaq.glaq003<>0 THEN
#               LET l_glar010 = g_glaq.glaq010 
#               LET l_glar011 = 0
#            ELSE
#               LET l_glar010 = 0 
#               LET l_glar011 = g_glaq.glaq010
#            END IF
#            IF cl_null(l_glar010) THEN LET l_glar010 = 0 END IF 
#            IF cl_null(l_glar011) THEN LET l_glar011 = 0 END IF
#          
#            INSERT INTO glar_t (glarent,glarcomp,glarld,glar001,glar002,glar003,
#                                glar004,glar005,glar006,glar007,glar008,
#                                glar009,glar010,glar011,glar012,glar013,
#                                glar014,glar015,glar016,glar017,glar018,
#                                glar019,glar020,glar022,glar023,
#                                glar024,glar025,glar026,glar027,glar028,
#                                glar029,glar030,glar031,glar032,glar033,
#                                glar034,glar035,glar036,glar037,
#                                glar051,glar052,glar053)
#            VALUES(g_enterprise,g_glaq.glaqcomp,p_glapld,l_glac002,l_glap002,l_glap004,
#                   l_glar004,g_glaq.glaq003,g_glaq.glaq004,l_glar007,l_glar008,
#                   g_glaq.glaq005,l_glar010,l_glar011,g_glaq.glaq017,g_glaq.glaq018,
#                   g_glaq.glaq019,g_glaq.glaq020,g_glaq.glaq021,g_glaq.glaq022,g_glaq.glaq023,
#                   g_glaq.glaq024,g_glaq.glaq025,g_glaq.glaq027,g_glaq.glaq028,
#                   g_glaq.glaq029,g_glaq.glaq030,g_glaq.glaq031,g_glaq.glaq032,g_glaq.glaq033,
#                   g_glaq.glaq034,g_glaq.glaq035,g_glaq.glaq036,g_glaq.glaq037,g_glaq.glaq038,
#                   g_glaq.glaq040,g_glaq.glaq041,g_glaq.glaq043,g_glaq.glaq044,
#                   g_glaq.glaq051,g_glaq.glaq052,g_glaq.glaq053)   
#            
#            #写入日志文件
#            LET l_str = "账套",g_glaq.glaqld," 科目",l_glac002,"年度",l_glap002,"期别",l_glap004,"\n",
#                        "借方金额：",g_glaq.glaq003,"\n",
#                        "贷方金额：",g_glaq.glaq004,"\n",
#                        "insert glar_t 结果:","\n",
#                        "SQLCA.SQLCODE = ",SQLCA.SQLCODE,"\n",
#                        "SQLCA.sqlerrd[3] = ",SQLCA.sqlerrd[3],"\n"
#            CALL l_ch.write(l_str)            
#         ELSE
#            #如果資料存在，則更新餘額檔借方金额,借方笔数,原币借放金额,贷方金额,贷方笔数,原币贷方金额 
#            SELECT glar005,glar006,glar007,glar008,glar010,glar011,glar034,glar035,glar036,glar037 
#              INTO l_glar005,l_glar006,l_glar007,l_glar008,l_glar010,l_glar011,l_glar034,l_glar035,l_glar036,l_glar037
#              FROM glar_t
#             WHERE glarent = g_enterprise
#               AND glarld  = g_glaq.glaqld
#               AND glar001 = l_glac002
#               AND glar002 = l_glap002   
#               AND glar003 = l_glap004
##               AND glar004 = l_glar004
#               AND glar009 = g_glaq.glaq005
#               AND glar012 = g_glaq.glaq017
#               AND glar013 = g_glaq.glaq018
#               AND glar014 = g_glaq.glaq019
#               AND glar015 = g_glaq.glaq020
#               AND glar016 = g_glaq.glaq021
#               AND glar017 = g_glaq.glaq022
#               AND glar018 = g_glaq.glaq023
#               AND glar019 = g_glaq.glaq024
#               AND glar051 = g_glaq.glaq051
#               AND glar052 = g_glaq.glaq052
#               AND glar053 = g_glaq.glaq053
#               AND glar020 = g_glaq.glaq025
#               AND glar022 = g_glaq.glaq027
#               AND glar023 = g_glaq.glaq028
#               AND glar024 = g_glaq.glaq029
#               AND glar025 = g_glaq.glaq030
#               AND glar026 = g_glaq.glaq031
#               AND glar027 = g_glaq.glaq032
#               AND glar028 = g_glaq.glaq033
#               AND glar029 = g_glaq.glaq034
#               AND glar030 = g_glaq.glaq035
#               AND glar031 = g_glaq.glaq036
#               AND glar032 = g_glaq.glaq037
#               AND glar033 = g_glaq.glaq038
#               
#            #写入日志文件
#            LET l_str = "抓取已存在的余额档glar资料，根据凭证借贷方金额判断是更新借方金额还是贷方金额","\n",
#                        "余额档借方金额：",l_glar005,"\n",
#                        "余额档贷方金额：",l_glar006,"\n",
#                        "余额档借方笔数：",l_glar007,"\n",
#                        "余额档贷方笔数：",l_glar008,"\n",
#                        "凭证借方金额：",g_glaq.glaq003,"\n",
#                        "凭证贷方金额：",g_glaq.glaq004,"\n"
#            CALL l_ch.write(l_str)
#            
#            #如果是借方，则更新借方金额，借方笔数，原币借放金额
#            IF g_glaq.glaq003 <> 0  THEN 
#               IF cl_null(l_glar005) THEN LET l_glar005 = 0 END IF
#               IF cl_null(l_glar010) THEN LET l_glar010 = 0 END IF
#               IF cl_null(l_glar034) THEN LET l_glar034 = 0 END IF
#               IF cl_null(l_glar036) THEN LET l_glar036 = 0 END IF
#               
#               LET l_glar005 = l_glar005 + g_glaq.glaq003
#               LET l_glar034 = l_glar034 + g_glaq.glaq040
#               LET l_glar036 = l_glar036 + g_glaq.glaq043
#               LET l_glar010 = l_glar010 + g_glaq.glaq010
#               UPDATE glar_t SET glar005 = l_glar005,  
#                              glar007 = l_glar007 +1,
#                              glar010 = l_glar010,
#                              glar034 = l_glar034,
#                              glar036 = l_glar036
#               WHERE glarent = g_enterprise
#                 AND glarld  = g_glaq.glaqld
#                 AND glar001 = l_glac002
#                 AND glar002 = l_glap002   
#                 AND glar003 = l_glap004
##                 AND glar004 = l_glar004
#                 AND glar009 = g_glaq.glaq005
#                 AND glar012 = g_glaq.glaq017
#                 AND glar013 = g_glaq.glaq018
#                 AND glar014 = g_glaq.glaq019
#                 AND glar015 = g_glaq.glaq020
#                 AND glar016 = g_glaq.glaq021
#                 AND glar017 = g_glaq.glaq022
#                 AND glar018 = g_glaq.glaq023
#                 AND glar019 = g_glaq.glaq024
#                 AND glar051 = g_glaq.glaq051
#                 AND glar052 = g_glaq.glaq052
#                 AND glar053 = g_glaq.glaq053
#                 AND glar020 = g_glaq.glaq025
#                 AND glar022 = g_glaq.glaq027
#                 AND glar023 = g_glaq.glaq028
#                 AND glar024 = g_glaq.glaq029
#                 AND glar025 = g_glaq.glaq030
#                 AND glar026 = g_glaq.glaq031
#                 AND glar027 = g_glaq.glaq032
#                 AND glar028 = g_glaq.glaq033
#                 AND glar029 = g_glaq.glaq034
#                 AND glar030 = g_glaq.glaq035
#                 AND glar031 = g_glaq.glaq036
#                 AND glar032 = g_glaq.glaq037
#                 AND glar033 = g_glaq.glaq038
#                 
#               #写入日志文件
#               LET l_str = "账套",g_glaq.glaqld," 科目",l_glac002,"年度",l_glap002,"期别",l_glap004,"\n",
#                           "更新借方金额：",l_glar005,"\n",
#                           "更新借方笔数：",l_glar007 +1,"\n",
#                           "update glar_t 结果:","\n",
#                           "SQLCA.SQLCODE = ",SQLCA.SQLCODE,"\n",
#                           "SQLCA.sqlerrd[3] = ",SQLCA.sqlerrd[3],"\n"
#               CALL l_ch.write(l_str)
#            END IF
#            #如果是贷方，则更新贷方金额，贷方笔数，原币贷方金额  
#            IF g_glaq.glaq004 <> 0  THEN 
#               IF cl_null(l_glar006) THEN LET l_glar006 = 0 END IF
#               IF cl_null(l_glar011) THEN LET l_glar011 = 0 END IF
#               IF cl_null(l_glar035) THEN LET l_glar035 = 0 END IF
#               IF cl_null(l_glar037) THEN LET l_glar037 = 0 END IF
#               
#               LET l_glar006 = l_glar006 + g_glaq.glaq004
#               LET l_glar035 = l_glar035 + g_glaq.glaq041
#               LET l_glar037 = l_glar037 + g_glaq.glaq044
#               LET l_glar011 = l_glar011 + g_glaq.glaq010
#               UPDATE glar_t SET glar006 = l_glar006,  
#                              glar008 = l_glar008 +1,
#                              glar011 = l_glar011,
#                              glar035 = l_glar035,
#                              glar037 = l_glar037
#               WHERE glarent = g_enterprise
#                 AND glarld  = g_glaq.glaqld
#                 AND glar001 = l_glac002
#                 AND glar002 = l_glap002   
#                 AND glar003 = l_glap004
##                 AND glar004 = l_glar004
#                 AND glar009 = g_glaq.glaq005
#                 AND glar012 = g_glaq.glaq017
#                 AND glar013 = g_glaq.glaq018
#                 AND glar014 = g_glaq.glaq019
#                 AND glar015 = g_glaq.glaq020
#                 AND glar016 = g_glaq.glaq021
#                 AND glar017 = g_glaq.glaq022
#                 AND glar018 = g_glaq.glaq023
#                 AND glar019 = g_glaq.glaq024
#                 AND glar051 = g_glaq.glaq051
#                 AND glar052 = g_glaq.glaq052
#                 AND glar053 = g_glaq.glaq053
#                 AND glar020 = g_glaq.glaq025
#                 AND glar022 = g_glaq.glaq027
#                 AND glar023 = g_glaq.glaq028
#                 AND glar024 = g_glaq.glaq029
#                 AND glar025 = g_glaq.glaq030
#                 AND glar026 = g_glaq.glaq031
#                 AND glar027 = g_glaq.glaq032
#                 AND glar028 = g_glaq.glaq033
#                 AND glar029 = g_glaq.glaq034
#                 AND glar030 = g_glaq.glaq035
#                 AND glar031 = g_glaq.glaq036
#                 AND glar032 = g_glaq.glaq037
#                 AND glar033 = g_glaq.glaq038
#               
#               #写入日志文件
#               LET l_str = "账套",g_glaq.glaqld," 科目",l_glac002,"年度",l_glap002,"期别",l_glap004,"\n",
#                           "更新贷方金额：",l_glar006,"\n",
#                           "更新贷方笔数：",l_glar008 +1,"\n",
#                           "update glar_t 结果:","\n",
#                           "SQLCA.SQLCODE = ",SQLCA.SQLCODE,"\n",
#                           "SQLCA.sqlerrd[3] = ",SQLCA.sqlerrd[3],"\n"
#               CALL l_ch.write(l_str)
#            END IF
#            
#         END IF
         IF l_cnt = 0 THEN
            EXECUTE s_voucher_post_ins_glar_pr 
              USING g_enterprise,l_glapcomp,p_glapld,l_glac002,l_glap002,l_glap004,
                    l_glar004,g_glaq.glaq003,g_glaq.glaq004,l_glar007,l_glar008,
                    g_glaq.glaq005,l_glar010,l_glar011,g_glaq.glaq017,g_glaq.glaq018,
                    g_glaq.glaq019,g_glaq.glaq020,g_glaq.glaq021,g_glaq.glaq022,g_glaq.glaq023,
                    g_glaq.glaq024,g_glaq.glaq025,g_glaq.glaq027,g_glaq.glaq028,
                    g_glaq.glaq029,g_glaq.glaq030,g_glaq.glaq031,g_glaq.glaq032,g_glaq.glaq033,
                    g_glaq.glaq034,g_glaq.glaq035,g_glaq.glaq036,g_glaq.glaq037,g_glaq.glaq038,
                    g_glaq.glaq040,g_glaq.glaq041,g_glaq.glaq043,g_glaq.glaq044,
                    g_glaq.glaq051,g_glaq.glaq052,g_glaq.glaq053  
            
            #写入日志文件
            LET l_str = "账套",g_glaq.glaqld," 科目",l_glac002,"年度",l_glap002,"期别",l_glap004,"\n",
                        "借方金额：",g_glaq.glaq003,"\n",
                        "借方笔数：",l_glar007,"\n",
                        "贷方金额：",g_glaq.glaq004,"\n",
                        "贷方笔数：",l_glar008,"\n",
                        "insert glar_t 结果:","\n",
                        "SQLCA.SQLCODE = ",SQLCA.SQLCODE,"\n",
                        "SQLCA.sqlerrd[3] = ",SQLCA.sqlerrd[3],"\n"
            CALL l_ch.write(l_str)            
         ELSE
            EXECUTE s_voucher_post_upd_glar_pr
              USING g_glaq.glaq003,g_glaq.glaq004,l_glar007,l_glar008,l_glar010,l_glar011,
                    g_glaq.glaq040,g_glaq.glaq041,g_glaq.glaq043,g_glaq.glaq044,
                    l_glac002,g_glaq.glaq005,g_glaq.glaq017,g_glaq.glaq018,g_glaq.glaq019,
                    g_glaq.glaq020,g_glaq.glaq021,g_glaq.glaq022,g_glaq.glaq023,g_glaq.glaq024,
                    g_glaq.glaq051,g_glaq.glaq052,g_glaq.glaq053,g_glaq.glaq025,g_glaq.glaq027,
                    g_glaq.glaq028,g_glaq.glaq029,g_glaq.glaq030,g_glaq.glaq031,g_glaq.glaq032,
                    g_glaq.glaq033,g_glaq.glaq034,g_glaq.glaq035,g_glaq.glaq036,g_glaq.glaq037,
                    g_glaq.glaq038
                 
            #写入日志文件
            LET l_str = "账套",g_glaq.glaqld," 科目",l_glac002,"年度",l_glap002,"期别",l_glap004,"\n",
                        "更新借方增加金额：",g_glaq.glaq003,"\n",
                        "更新借方增加笔数：",l_glar007,"\n",
                        "更新贷方增加金额：",g_glaq.glaq004,"\n",
                        "更新贷方增加笔数：",l_glar008,"\n",
                        "update glar_t 结果:","\n",
                        "SQLCA.SQLCODE = ",SQLCA.SQLCODE,"\n",
                        "SQLCA.sqlerrd[3] = ",SQLCA.sqlerrd[3],"\n"
            CALL l_ch.write(l_str)
         END IF
#161205-00025#4--mod--end         
         IF SQLCA.SQLCODE OR SQLCA.sqlerrd[3] = 0 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = p_glapdocno
            LET g_errparam.code   = sqlca.sqlcode
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            LET r_success = FALSE
         END IF
         
         #写入日志文件
         LET l_str = "r_success：",r_success,"\n"
         CALL l_ch.write(l_str)
         
         #161205-00025#4--mod--str--
         #抓取上层科目
#         SELECT glac004 INTO l_glac004 FROM glac_t 
#          WHERE glacent = g_enterprise AND glac001 = l_glaa004 AND glac002=l_glac002
         EXECUTE s_voucher_post_sel_glac004_pr USING l_glac002 INTO l_glac004
         #161205-00025#4--mod--end
         #已經是最上層科目
         IF l_glac002 = l_glac004 OR cl_null(l_glac002) OR cl_null(l_glac004) THEN
            EXIT WHILE
         ELSE
            LET l_glac002=l_glac004
            
            #写入日志文件
            LET l_str = "更新上层统制科目：",l_glac004,"\n"
            CALL l_ch.write(l_str)
         END IF       
      END WHILE
      
      #写入日志文件
      LET l_str = "一次foreach结束：glaqseq=",g_glaq.glaqseq,"\n"
      CALL l_ch.write(l_str)
   END FOREACH
   
   LET l_str="过账更新glar最终结果 r_success",r_success,"\n"
   CALL l_ch.write(l_str)
   LET l_str="s_voucher_post_chk()写入glar_t END","\n"
   CALL l_ch.write(l_str)
   LET l_str = "#--------------------------- (", CURRENT YEAR TO SECOND,"'",p_glapdocno,"'", "post End) -----------------------------#\n"
   CALL l_ch.write(l_str)
   CALL l_ch.close()
         
   RETURN r_success
#===============================================
END FUNCTION
# Descriptions...: 傳票憑證過帳状态更新
# Memo...........:
# Usage..........: CALL s_voucher_post_upd(p_glapld,p_glapdocno)
#                  RETURNING r_success
# Input parameter: p_ld           帐套
#                : p_glapdocno    傳票編號
# Return code....: r_success      成功否标识位
# Date & Author..: 2013/09/10 By minpp
# Modify.........:
#=================================================
PUBLIC FUNCTION s_voucher_post_upd(p_glapld,p_glapdocno)
   DEFINE p_glapld         LIKE glap_t.glapld         #帐别
   DEFINE p_glapdocno      LIKE glap_t.glapdocno      #傳票編號
   DEFINE r_success     LIKE type_t.num5
   DEFINE r_errno       LIKE type_t.chr80
   DEFINE l_today       DATETIME YEAR TO SECOND
   #写入日志文件
   DEFINE l_ch         base.Channel
   DEFINE l_logFile    STRING
   DEFINE l_path       STRING
   DEFINE l_str        STRING
   #170411-00094#1--mark--s--xul 移动到 审核段
   #151223-00004#1--add--str--lujh
#   DEFINE l_sql        STRING   
#   DEFINE l_glap007    LIKE glap_t.glap007
#   DEFINE l_glapdocdt  LIKE glap_t.glapdocdt
#   DEFINE l_glap002    LIKE glap_t.glap002
#   DEFINE l_glap004    LIKE glap_t.glap004
#   DEFINE l_glaa004    LIKE glaa_t.glaa004
#   DEFINE l_glaa122    LIKE glaa_t.glaa122
#   DEFINE l_glac016    LIKE glac_t.glac016
#   #161128-00061#7---add---begin-----------
#   #DEFINE l_glaq       RECORD LIKE glaq_t.*
#   #DEFINE l_nmbc       RECORD LIKE nmbc_t.*
#   #DEFINE l_glbc       RECORD LIKE glbc_t.*
#   DEFINE l_glaq RECORD  #傳票憑證單身檔
#       glaqent LIKE glaq_t.glaqent, #企業編號
#       glaqcomp LIKE glaq_t.glaqcomp, #法人
#       glaqld LIKE glaq_t.glaqld, #帳套
#       glaqdocno LIKE glaq_t.glaqdocno, #單號
#       glaqseq LIKE glaq_t.glaqseq, #項次
#       glaq001 LIKE glaq_t.glaq001, #摘要
#       glaq002 LIKE glaq_t.glaq002, #科目編號
#       glaq003 LIKE glaq_t.glaq003, #借方金額
#       glaq004 LIKE glaq_t.glaq004, #貸方金額
#       glaq005 LIKE glaq_t.glaq005, #交易幣別
#       glaq006 LIKE glaq_t.glaq006, #匯率
#       glaq007 LIKE glaq_t.glaq007, #計價單位
#       glaq008 LIKE glaq_t.glaq008, #數量
#       glaq009 LIKE glaq_t.glaq009, #單價
#       glaq010 LIKE glaq_t.glaq010, #原幣金額
#       glaq011 LIKE glaq_t.glaq011, #票據編碼
#       glaq012 LIKE glaq_t.glaq012, #票據日期
#       glaq013 LIKE glaq_t.glaq013, #申請人
#       glaq014 LIKE glaq_t.glaq014, #銀行帳號
#       glaq015 LIKE glaq_t.glaq015, #款別編號
#       glaq016 LIKE glaq_t.glaq016, #收支專案
#       glaq017 LIKE glaq_t.glaq017, #營運據點
#       glaq018 LIKE glaq_t.glaq018, #部門
#       glaq019 LIKE glaq_t.glaq019, #利潤/成本中心
#       glaq020 LIKE glaq_t.glaq020, #區域
#       glaq021 LIKE glaq_t.glaq021, #收付款客商
#       glaq022 LIKE glaq_t.glaq022, #帳款客戶
#       glaq023 LIKE glaq_t.glaq023, #客群
#       glaq024 LIKE glaq_t.glaq024, #產品類別
#       glaq025 LIKE glaq_t.glaq025, #人員
#       glaq026 LIKE glaq_t.glaq026, #no use
#       glaq027 LIKE glaq_t.glaq027, #專案編號
#       glaq028 LIKE glaq_t.glaq028, #WBS
#       glaq029 LIKE glaq_t.glaq029, #自由核算項一
#       glaq030 LIKE glaq_t.glaq030, #自由核算項二
#       glaq031 LIKE glaq_t.glaq031, #自由核算項三
#       glaq032 LIKE glaq_t.glaq032, #自由核算項四
#       glaq033 LIKE glaq_t.glaq033, #自由核算項五
#       glaq034 LIKE glaq_t.glaq034, #自由核算項六
#       glaq035 LIKE glaq_t.glaq035, #自由核算項七
#       glaq036 LIKE glaq_t.glaq036, #自由核算項八
#       glaq037 LIKE glaq_t.glaq037, #自由核算項九
#       glaq038 LIKE glaq_t.glaq038, #自由核算項十
#       glaq039 LIKE glaq_t.glaq039, #匯率(本位幣二)
#       glaq040 LIKE glaq_t.glaq040, #借方金額(本位幣二)
#       glaq041 LIKE glaq_t.glaq041, #貸方金額(本位幣二)
#       glaq042 LIKE glaq_t.glaq042, #匯率(本位幣三)
#       glaq043 LIKE glaq_t.glaq043, #借方金額(本位幣三)
#       glaq044 LIKE glaq_t.glaq044, #貸方金額(本位幣三)
#       glaq051 LIKE glaq_t.glaq051, #經營方式
#       glaq052 LIKE glaq_t.glaq052, #通路
#       glaq053 LIKE glaq_t.glaq053, #品牌
#       glaqud001 LIKE glaq_t.glaqud001, #自定義欄位(文字)001
#       glaqud002 LIKE glaq_t.glaqud002, #自定義欄位(文字)002
#       glaqud003 LIKE glaq_t.glaqud003, #自定義欄位(文字)003
#       glaqud004 LIKE glaq_t.glaqud004, #自定義欄位(文字)004
#       glaqud005 LIKE glaq_t.glaqud005, #自定義欄位(文字)005
#       glaqud006 LIKE glaq_t.glaqud006, #自定義欄位(文字)006
#       glaqud007 LIKE glaq_t.glaqud007, #自定義欄位(文字)007
#       glaqud008 LIKE glaq_t.glaqud008, #自定義欄位(文字)008
#       glaqud009 LIKE glaq_t.glaqud009, #自定義欄位(文字)009
#       glaqud010 LIKE glaq_t.glaqud010, #自定義欄位(文字)010
#       glaqud011 LIKE glaq_t.glaqud011, #自定義欄位(數字)011
#       glaqud012 LIKE glaq_t.glaqud012, #自定義欄位(數字)012
#       glaqud013 LIKE glaq_t.glaqud013, #自定義欄位(數字)013
#       glaqud014 LIKE glaq_t.glaqud014, #自定義欄位(數字)014
#       glaqud015 LIKE glaq_t.glaqud015, #自定義欄位(數字)015
#       glaqud016 LIKE glaq_t.glaqud016, #自定義欄位(數字)016
#       glaqud017 LIKE glaq_t.glaqud017, #自定義欄位(數字)017
#       glaqud018 LIKE glaq_t.glaqud018, #自定義欄位(數字)018
#       glaqud019 LIKE glaq_t.glaqud019, #自定義欄位(數字)019
#       glaqud020 LIKE glaq_t.glaqud020, #自定義欄位(數字)020
#       glaqud021 LIKE glaq_t.glaqud021, #自定義欄位(日期時間)021
#       glaqud022 LIKE glaq_t.glaqud022, #自定義欄位(日期時間)022
#       glaqud023 LIKE glaq_t.glaqud023, #自定義欄位(日期時間)023
#       glaqud024 LIKE glaq_t.glaqud024, #自定義欄位(日期時間)024
#       glaqud025 LIKE glaq_t.glaqud025, #自定義欄位(日期時間)025
#       glaqud026 LIKE glaq_t.glaqud026, #自定義欄位(日期時間)026
#       glaqud027 LIKE glaq_t.glaqud027, #自定義欄位(日期時間)027
#       glaqud028 LIKE glaq_t.glaqud028, #自定義欄位(日期時間)028
#       glaqud029 LIKE glaq_t.glaqud029, #自定義欄位(日期時間)029
#       glaqud030 LIKE glaq_t.glaqud030  #自定義欄位(日期時間)030
#       END RECORD
#   DEFINE l_nmbc RECORD  #銀存收支異動檔
#       nmbcent LIKE nmbc_t.nmbcent, #企業編號
#       nmbcownid LIKE nmbc_t.nmbcownid, #資料所有者
#       nmbcowndp LIKE nmbc_t.nmbcowndp, #資料所屬部門
#       nmbccrtid LIKE nmbc_t.nmbccrtid, #資料建立者
#       nmbccrtdp LIKE nmbc_t.nmbccrtdp, #資料建立部門
#       nmbccrtdt LIKE nmbc_t.nmbccrtdt, #資料創建日
#       nmbcmodid LIKE nmbc_t.nmbcmodid, #資料修改者
#       nmbcmoddt LIKE nmbc_t.nmbcmoddt, #最近修改日
#       nmbccnfid LIKE nmbc_t.nmbccnfid, #資料確認者
#       nmbccnfdt LIKE nmbc_t.nmbccnfdt, #資料確認日
#       nmbcpstid LIKE nmbc_t.nmbcpstid, #資料過帳者
#       nmbcpstdt LIKE nmbc_t.nmbcpstdt, #資料過帳日
#       nmbcstus LIKE nmbc_t.nmbcstus, #狀態碼
#       nmbccomp LIKE nmbc_t.nmbccomp, #法人
#       nmbcsite LIKE nmbc_t.nmbcsite, #資金中心
#       nmbcdocno LIKE nmbc_t.nmbcdocno, #來源單號
#       nmbcseq LIKE nmbc_t.nmbcseq, #項次
#       nmbc001 LIKE nmbc_t.nmbc001, #單據來源
#       nmbc002 LIKE nmbc_t.nmbc002, #交易帳戶編碼
#       nmbc003 LIKE nmbc_t.nmbc003, #交易對象
#       nmbc004 LIKE nmbc_t.nmbc004, #交易對象識別碼
#       nmbc005 LIKE nmbc_t.nmbc005, #銀行日期
#       nmbc006 LIKE nmbc_t.nmbc006, #異動別
#       nmbc007 LIKE nmbc_t.nmbc007, #存提碼
#       nmbc008 LIKE nmbc_t.nmbc008, #調節碼
#       nmbc009 LIKE nmbc_t.nmbc009, #對帳碼
#       nmbc010 LIKE nmbc_t.nmbc010, #網銀媒體檔轉出日期
#       nmbc011 LIKE nmbc_t.nmbc011, #網銀媒體檔轉出批號
#       nmbc100 LIKE nmbc_t.nmbc100, #交易帳戶幣別
#       nmbc101 LIKE nmbc_t.nmbc101, #主帳套匯率
#       nmbc103 LIKE nmbc_t.nmbc103, #主帳套原幣金額
#       nmbc113 LIKE nmbc_t.nmbc113, #主帳套本幣金額
#       nmbc121 LIKE nmbc_t.nmbc121, #主帳套本位幣二匯率
#       nmbc123 LIKE nmbc_t.nmbc123, #主帳套本位幣二金額
#       nmbc131 LIKE nmbc_t.nmbc131, #主帳套本位幣三匯率
#       nmbc133 LIKE nmbc_t.nmbc133, #主帳套本位幣三金額
#       nmbcud001 LIKE nmbc_t.nmbcud001, #自定義欄位(文字)001
#       nmbcud002 LIKE nmbc_t.nmbcud002, #自定義欄位(文字)002
#       nmbcud003 LIKE nmbc_t.nmbcud003, #自定義欄位(文字)003
#       nmbcud004 LIKE nmbc_t.nmbcud004, #自定義欄位(文字)004
#       nmbcud005 LIKE nmbc_t.nmbcud005, #自定義欄位(文字)005
#       nmbcud006 LIKE nmbc_t.nmbcud006, #自定義欄位(文字)006
#       nmbcud007 LIKE nmbc_t.nmbcud007, #自定義欄位(文字)007
#       nmbcud008 LIKE nmbc_t.nmbcud008, #自定義欄位(文字)008
#       nmbcud009 LIKE nmbc_t.nmbcud009, #自定義欄位(文字)009
#       nmbcud010 LIKE nmbc_t.nmbcud010, #自定義欄位(文字)010
#       nmbcud011 LIKE nmbc_t.nmbcud011, #自定義欄位(數字)011
#       nmbcud012 LIKE nmbc_t.nmbcud012, #自定義欄位(數字)012
#       nmbcud013 LIKE nmbc_t.nmbcud013, #自定義欄位(數字)013
#       nmbcud014 LIKE nmbc_t.nmbcud014, #自定義欄位(數字)014
#       nmbcud015 LIKE nmbc_t.nmbcud015, #自定義欄位(數字)015
#       nmbcud016 LIKE nmbc_t.nmbcud016, #自定義欄位(數字)016
#       nmbcud017 LIKE nmbc_t.nmbcud017, #自定義欄位(數字)017
#       nmbcud018 LIKE nmbc_t.nmbcud018, #自定義欄位(數字)018
#       nmbcud019 LIKE nmbc_t.nmbcud019, #自定義欄位(數字)019
#       nmbcud020 LIKE nmbc_t.nmbcud020, #自定義欄位(數字)020
#       nmbcud021 LIKE nmbc_t.nmbcud021, #自定義欄位(日期時間)021
#       nmbcud022 LIKE nmbc_t.nmbcud022, #自定義欄位(日期時間)022
#       nmbcud023 LIKE nmbc_t.nmbcud023, #自定義欄位(日期時間)023
#       nmbcud024 LIKE nmbc_t.nmbcud024, #自定義欄位(日期時間)024
#       nmbcud025 LIKE nmbc_t.nmbcud025, #自定義欄位(日期時間)025
#       nmbcud026 LIKE nmbc_t.nmbcud026, #自定義欄位(日期時間)026
#       nmbcud027 LIKE nmbc_t.nmbcud027, #自定義欄位(日期時間)027
#       nmbcud028 LIKE nmbc_t.nmbcud028, #自定義欄位(日期時間)028
#       nmbcud029 LIKE nmbc_t.nmbcud029, #自定義欄位(日期時間)029
#       nmbcud030 LIKE nmbc_t.nmbcud030, #自定義欄位(日期時間)030
#       nmbc012 LIKE nmbc_t.nmbc012, #票據號碼
#       nmbc013 LIKE nmbc_t.nmbc013, #款別
#       nmbc014 LIKE nmbc_t.nmbc014, #到期日
#       nmbc015 LIKE nmbc_t.nmbc015, #匯入銀行編號
#       nmbc016 LIKE nmbc_t.nmbc016, #匯入帳號
#       nmbc017 LIKE nmbc_t.nmbc017, #受款人全名
#       nmbcorga LIKE nmbc_t.nmbcorga  #來源組織
#       END RECORD
# 
#   DEFINE l_glbc RECORD  #現金變動碼明細檔
#       glbcent LIKE glbc_t.glbcent, #企業編號
#       glbcld LIKE glbc_t.glbcld, #帳套
#       glbccomp LIKE glbc_t.glbccomp, #營運據點
#       glbcdocno LIKE glbc_t.glbcdocno, #傳票編號
#       glbcseq LIKE glbc_t.glbcseq, #項次
#       glbcseq1 LIKE glbc_t.glbcseq1, #序號
#       glbc001 LIKE glbc_t.glbc001, #年度
#       glbc002 LIKE glbc_t.glbc002, #期別
#       glbc003 LIKE glbc_t.glbc003, #借貸別
#       glbc004 LIKE glbc_t.glbc004, #現金變動碼
#       glbc005 LIKE glbc_t.glbc005, #交易客商
#       glbc006 LIKE glbc_t.glbc006, #交易幣別
#       glbc007 LIKE glbc_t.glbc007, #匯率
#       glbc008 LIKE glbc_t.glbc008, #原幣金額
#       glbc009 LIKE glbc_t.glbc009, #本幣金額
#       glbc010 LIKE glbc_t.glbc010, #資料來源
#       glbc011 LIKE glbc_t.glbc011, #匯率(本位幣二)
#       glbc012 LIKE glbc_t.glbc012, #金額(本位幣二)
#       glbc013 LIKE glbc_t.glbc013, #匯率(本位幣三)
#       glbc014 LIKE glbc_t.glbc014, #金額(本位幣三)
#       glbcud001 LIKE glbc_t.glbcud001, #自定義欄位(文字)001
#       glbcud002 LIKE glbc_t.glbcud002, #自定義欄位(文字)002
#       glbcud003 LIKE glbc_t.glbcud003, #自定義欄位(文字)003
#       glbcud004 LIKE glbc_t.glbcud004, #自定義欄位(文字)004
#       glbcud005 LIKE glbc_t.glbcud005, #自定義欄位(文字)005
#       glbcud006 LIKE glbc_t.glbcud006, #自定義欄位(文字)006
#       glbcud007 LIKE glbc_t.glbcud007, #自定義欄位(文字)007
#       glbcud008 LIKE glbc_t.glbcud008, #自定義欄位(文字)008
#       glbcud009 LIKE glbc_t.glbcud009, #自定義欄位(文字)009
#       glbcud010 LIKE glbc_t.glbcud010, #自定義欄位(文字)010
#       glbcud011 LIKE glbc_t.glbcud011, #自定義欄位(數字)011
#       glbcud012 LIKE glbc_t.glbcud012, #自定義欄位(數字)012
#       glbcud013 LIKE glbc_t.glbcud013, #自定義欄位(數字)013
#       glbcud014 LIKE glbc_t.glbcud014, #自定義欄位(數字)014
#       glbcud015 LIKE glbc_t.glbcud015, #自定義欄位(數字)015
#       glbcud016 LIKE glbc_t.glbcud016, #自定義欄位(數字)016
#       glbcud017 LIKE glbc_t.glbcud017, #自定義欄位(數字)017
#       glbcud018 LIKE glbc_t.glbcud018, #自定義欄位(數字)018
#       glbcud019 LIKE glbc_t.glbcud019, #自定義欄位(數字)019
#       glbcud020 LIKE glbc_t.glbcud020, #自定義欄位(數字)020
#       glbcud021 LIKE glbc_t.glbcud021, #自定義欄位(日期時間)021
#       glbcud022 LIKE glbc_t.glbcud022, #自定義欄位(日期時間)022
#       glbcud023 LIKE glbc_t.glbcud023, #自定義欄位(日期時間)023
#       glbcud024 LIKE glbc_t.glbcud024, #自定義欄位(日期時間)024
#       glbcud025 LIKE glbc_t.glbcud025, #自定義欄位(日期時間)025
#       glbcud026 LIKE glbc_t.glbcud026, #自定義欄位(日期時間)026
#       glbcud027 LIKE glbc_t.glbcud027, #自定義欄位(日期時間)027
#       glbcud028 LIKE glbc_t.glbcud028, #自定義欄位(日期時間)028
#       glbcud029 LIKE glbc_t.glbcud029, #自定義欄位(日期時間)029
#       glbcud030 LIKE glbc_t.glbcud030, #自定義欄位(日期時間)030
#       glbc015 LIKE glbc_t.glbc015 #狀態碼
#       END RECORD
#
   #161128-00061#7---add---end-----------
   #151223-00004#1--add--end--lujh
   #170411-00094#1--mark--e--xul 移动到 审核段
   WHENEVER ERROR CONTINUE
   
   #写入日志文件
   #先讀取$ERP, 若無則採用程序写死的路径
   LET l_path = FGL_GETENV("ERP")
   IF cl_null(l_path) THEN
      LET l_path = "/u1/t10dev/erp"
   END IF
   LET l_path = l_path,"/agl/4gl/log/"
#   #将log文件放在temp目录下
#   LET l_path = FGL_GETENV("TEMPDIR"),"/"
   LET l_logFile = l_path,g_today USING "YYYYMMDD","_",p_glapdocno,"_post",".log"
   LET l_ch = base.Channel.create()
   CALL l_ch.setDelimiter(NULL)
   CALL l_ch.openFile(l_logFile, "a")
   LET l_str = "#--------------------------- (", CURRENT YEAR TO SECOND,"'",p_glapdocno,"'", "post Start) ---------------------------#\n"
   CALL l_ch.write(l_str)
   LET l_str = "执行过账操作程序：",g_prog,"\n",
               "执行人员：",g_user,"\n"
   CALL l_ch.write(l_str)
   LET l_str="s_voucher_post_upd()更新glap_t状态 Start","\n"
   CALL l_ch.write(l_str)
   
   LET r_success  = TRUE
   LET r_errno = ''
   LET l_today = cl_get_current()  
   #更新狀態碼=過帳, 過帳人=g_user,過帳日期=g_today
   UPDATE glap_t SET glapstus = 'S',
                    glappstid = g_user,
                    glappstdt = l_today
              WHERE glapent = g_enterprise
                AND glapld = p_glapld
                AND glapdocno = p_glapdocno
   IF SQLCA.SQLCODE OR SQLCA.sqlerrd[3] = 0 THEN
#      CALL cl_errmsg('glapstus',p_glapdocno,'S',SQLCA.SQLCODE,1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code   = sqlca.sqlcode
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      LET r_success = FALSE
   END IF 
   
   #写入日志文件
   LET l_str = "1.更新glap_t状态='S'  过账者=",g_user,"  过账日期=",l_today,"\n",
               "更新结果：","\n",
               "r_success = ",r_success,"\n",
               "SQLCA.SQLCODE = ",SQLCA.SQLCODE,"\n",
               "SQLCA.sqlerrd[3] = ",SQLCA.sqlerrd[3],"\n"
   CALL l_ch.write(l_str)
   
   #更新該帳套最後過賬時間
   UPDATE glaa_t SET glaa012 = l_today
    WHERE glaaent = g_enterprise
      AND glaald = p_glapld
   IF SQLCA.SQLCODE OR SQLCA.sqlerrd[3] = 0 THEN
#      CALL cl_errmsg('glaa012',p_glapld,'',SQLCA.SQLCODE,1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapld
      LET g_errparam.code   = sqlca.sqlcode
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      LET r_success = FALSE
   END IF 
   
   #写入日志文件
   LET l_str = "2.更新該帳套最後過賬時間 glaa012 =",l_today,"\n",
               "更新结果：","\n",
               "r_success = ",r_success,"\n",
               "SQLCA.SQLCODE = ",SQLCA.SQLCODE,"\n",
               "SQLCA.sqlerrd[3] = ",SQLCA.sqlerrd[3],"\n"
   CALL l_ch.write(l_str)
   LET l_str="s_voucher_post_upd()更新glap_t END","\n"
   CALL l_ch.write(l_str)
   LET l_str = "#--------------------------- (", CURRENT YEAR TO SECOND,"'",p_glapdocno,"'", "post End) -----------------------------#\n"
   CALL l_ch.write(l_str)
   CALL l_ch.close()
   #170411-00094#1--mark--s--xul 移动到审核段
   #151223-00004#1--add--str--lujh
#   SELECT glap007,glapdocdt,glap002,glap004 
#     INTO l_glap007,l_glapdocdt,l_glap002,l_glap004
#     FROM glap_t
#    WHERE glapent = g_enterprise
#      AND glapld = p_glapld
#      AND glapdocno = p_glapdocno
#   
#   SELECT glaa122,glaa004 INTO l_glaa122,l_glaa004
#     FROM glaa_t
#    WHERE glaaent = g_enterprise
#      AND glaald = p_glapld    
#      
#   IF l_glap007 = 'GL' AND l_glaa122 = 'Y' THEN 
#      #161128-00061#7---add---begin-----------
#      #LET l_sql = "SELECT * FROM glaq_t ",
#      LET l_sql = "SELECT glaqent,glaqcomp,glaqld,glaqdocno,glaqseq,glaq001,glaq002,glaq003,",
#                  "glaq004,glaq005,glaq006,glaq007,glaq008,glaq009,glaq010,glaq011,glaq012,",
#                  "glaq013,glaq014,glaq015,glaq016,glaq017,glaq018,glaq019,glaq020,glaq021,",
#                  "glaq022,glaq023,glaq024,glaq025,glaq026,glaq027,glaq028,glaq029,glaq030,",
#                  "glaq031,glaq032,glaq033,glaq034,glaq035,glaq036,glaq037,glaq038,glaq039,",
#                  "glaq040,glaq041,glaq042,glaq043,glaq044,glaq051,glaq052,glaq053,glaqud001,",
#                  "glaqud002,glaqud003,glaqud004,glaqud005,glaqud006,glaqud007,glaqud008,",
#                  "glaqud009,glaqud010,glaqud011,glaqud012,glaqud013,glaqud014,glaqud015,",
#                  "glaqud016,glaqud017,glaqud018,glaqud019,glaqud020,glaqud021,glaqud022,",
#                  "glaqud023,glaqud024,glaqud025,glaqud026,glaqud027,glaqud028,glaqud029,glaqud030 FROM glaq_t ",
#      #161128-00061#7---add---end-----------
#                  " WHERE glaqent = ",g_enterprise,
#                  "   AND glaqld = '",p_glapld,"'",
#                  "   AND glaqdocno = '",p_glapdocno,"'"
#      PREPARE s_voucher_ins_nmbc_pre FROM l_sql
#      DECLARE s_voucher_ins_nmbc_cs CURSOR FOR s_voucher_ins_nmbc_pre
#      
#      #161128-00061#7---add---begin-----------
#      #LET l_sql = "SELECT * FROM glbc_t  ",
#      LET l_sql = "SELECT glbcent,glbcld,glbccomp,glbcdocno,glbcseq,glbcseq1,glbc001,glbc002,",
#                  "glbc003,glbc004,glbc005,glbc006,glbc007,glbc008,glbc009,glbc010,glbc011,",
#                  "glbc012,glbc013,glbc014,glbcud001,glbcud002,glbcud003,glbcud004,glbcud005,",
#                  "glbcud006,glbcud007,glbcud008,glbcud009,glbcud010,glbcud011,glbcud012,",
#                  "glbcud013,glbcud014,glbcud015,glbcud016,glbcud017,glbcud018,glbcud019,",
#                  "glbcud020,glbcud021,glbcud022,glbcud023,glbcud024,glbcud025,glbcud026,",
#                  "glbcud027,glbcud028,glbcud029,glbcud030,glbc015 FROM glbc_t  ",
#      #161128-00061#7---add---end-----------
#                  " WHERE glbcent = ",g_enterprise,
#                  "   AND glbcld = '",p_glapld,"'",
#                  "   AND glbcdocno = ? ",
#                  "   AND glbcseq = ? ",
#                  "   AND glbc001 = '",l_glap002,"'",
#                  "   AND glbc002 = '",l_glap004,"'",
#                  "   AND glbc010 = '1' "
#      PREPARE s_voucher_ins_glbc_pre FROM l_sql
#      DECLARE s_voucher_ins_glbc_cs CURSOR FOR s_voucher_ins_glbc_pre
#      
#      FOREACH s_voucher_ins_nmbc_cs INTO l_glaq.*
#         CALL s_voucher_glac016_get(l_glaa004,l_glaq.glaq002) RETURNING l_glac016
#         IF l_glac016 = 'Y' THEN 
#            LET l_nmbc.nmbcent   = g_enterprise
#            LET l_nmbc.nmbcownid = g_user
#            LET l_nmbc.nmbcowndp = g_dept
#            LET l_nmbc.nmbccrtid = g_user
#            LET l_nmbc.nmbccrtdp = g_dept 
#            LET l_nmbc.nmbccrtdt = cl_get_current()
#            LET l_nmbc.nmbcmodid = g_user
#            LET l_nmbc.nmbcmoddt = cl_get_current()
#            LET l_nmbc.nmbccnfid = g_user
#            LET l_nmbc.nmbccnfdt = cl_get_current()
#            LET l_nmbc.nmbcpstid = g_user
#            LET l_nmbc.nmbcpstdt = cl_get_current()
#            LET l_nmbc.nmbcstus  = 'S'
#            LET l_nmbc.nmbccomp  = l_glaq.glaqcomp
#            LET l_nmbc.nmbcsite  = l_glaq.glaqcomp
#            LET l_nmbc.nmbcorga  = l_glaq.glaq017  #160322-00025#30
#            LET l_nmbc.nmbcdocno = l_glaq.glaqdocno
#            LET l_nmbc.nmbcseq   = l_glaq.glaqseq
#            LET l_nmbc.nmbc001   = 'aglt310'
#            
#            SELECT nmas002 INTO l_nmbc.nmbc002
#              FROM nmaa_t,nmas_t
#             WHERE nmaaent = g_enterprise
#               AND nmaaent = nmasent
#               AND nmaa001 = nmas001
#               AND nmaa005 = l_glaq.glaq014
#               AND nmas003 = l_glaq.glaq005
#               AND nmaa002 IN (select ooef001 FROM ooef_t WHERE ooefent = g_enterprise
#                                               AND ooef017 = l_glaq.glaqcomp) 
#             ORDER BY nmaa001
#            
#            LET l_nmbc.nmbc003   = l_glaq.glaq022
#            LET l_nmbc.nmbc005   = l_glapdocdt
#            IF l_glaq.glaq003 <> 0 THEN 
#               LET l_nmbc.nmbc006 = '1'
#               LET l_nmbc.nmbc113 =  l_glaq.glaq003
#               LET l_nmbc.nmbc123 =  l_glaq.glaq040
#               LET l_nmbc.nmbc133 =  l_glaq.glaq043
#            END IF
#            IF l_glaq.glaq004 <> 0 THEN 
#               LET l_nmbc.nmbc006 = '2'
#               LET l_nmbc.nmbc113 =  l_glaq.glaq004
#               LET l_nmbc.nmbc123 =  l_glaq.glaq041
#               LET l_nmbc.nmbc133 =  l_glaq.glaq044
#            END IF
#            IF cl_null(l_nmbc.nmbc113) THEN LET l_nmbc.nmbc113 = 0 END IF
#            IF cl_null(l_nmbc.nmbc123) THEN LET l_nmbc.nmbc123 = 0 END IF
#            IF cl_null(l_nmbc.nmbc133) THEN LET l_nmbc.nmbc133 = 0 END IF
#            LET l_nmbc.nmbc007 = l_glaq.glaq016
#            LET l_nmbc.nmbc010 = ''
#            LET l_nmbc.nmbc014 = ''
#            LET l_nmbc.nmbc100 = l_glaq.glaq005
#            LET l_nmbc.nmbc101 = l_glaq.glaq006
#            LET l_nmbc.nmbc103 = l_glaq.glaq010
#            LET l_nmbc.nmbc121 = l_glaq.glaq039
#            LET l_nmbc.nmbc131 = l_glaq.glaq042
#            LET l_nmbc.nmbc012 = l_glaq.glaq011
#            LET l_nmbc.nmbc013 = l_glaq.glaq015
#            
#            #161128-00061#7---add---begin-----------
#            #INSERT INTO nmbc_t VALUES(l_nmbc.*)
#            INSERT INTO nmbc_t (nmbcent,nmbcownid,nmbcowndp,nmbccrtid,nmbccrtdp,nmbccrtdt,nmbcmodid,nmbcmoddt,
#                                nmbccnfid,nmbccnfdt,nmbcpstid,nmbcpstdt,nmbcstus,nmbccomp,nmbcsite,nmbcdocno,
#                                nmbcseq,nmbc001,nmbc002,nmbc003,nmbc004,nmbc005,nmbc006,nmbc007,nmbc008,nmbc009,
#                                nmbc010,nmbc011,nmbc100,nmbc101,nmbc103,nmbc113,nmbc121,nmbc123,nmbc131,nmbc133,
#                                nmbcud001,nmbcud002,nmbcud003,nmbcud004,nmbcud005,nmbcud006,nmbcud007,nmbcud008,
#                                nmbcud009,nmbcud010,nmbcud011,nmbcud012,nmbcud013,nmbcud014,nmbcud015,nmbcud016,
#                                nmbcud017,nmbcud018,nmbcud019,nmbcud020,nmbcud021,nmbcud022,nmbcud023,nmbcud024,
#                                nmbcud025,nmbcud026,nmbcud027,nmbcud028,nmbcud029,nmbcud030,nmbc012,nmbc013,
#                                nmbc014,nmbc015,nmbc016,nmbc017,nmbcorga)
#             VALUES(l_nmbc.nmbcent,l_nmbc.nmbcownid,l_nmbc.nmbcowndp,l_nmbc.nmbccrtid,l_nmbc.nmbccrtdp,l_nmbc.nmbccrtdt,l_nmbc.nmbcmodid,l_nmbc.nmbcmoddt,
#                    l_nmbc.nmbccnfid,l_nmbc.nmbccnfdt,l_nmbc.nmbcpstid,l_nmbc.nmbcpstdt,l_nmbc.nmbcstus,l_nmbc.nmbccomp,l_nmbc.nmbcsite,l_nmbc.nmbcdocno,
#                    l_nmbc.nmbcseq,l_nmbc.nmbc001,l_nmbc.nmbc002,l_nmbc.nmbc003,l_nmbc.nmbc004,l_nmbc.nmbc005,l_nmbc.nmbc006,l_nmbc.nmbc007,l_nmbc.nmbc008,l_nmbc.nmbc009,
#                    l_nmbc.nmbc010,l_nmbc.nmbc011,l_nmbc.nmbc100,l_nmbc.nmbc101,l_nmbc.nmbc103,l_nmbc.nmbc113,l_nmbc.nmbc121,l_nmbc.nmbc123,l_nmbc.nmbc131,l_nmbc.nmbc133,
#                    l_nmbc.nmbcud001,l_nmbc.nmbcud002,l_nmbc.nmbcud003,l_nmbc.nmbcud004,l_nmbc.nmbcud005,l_nmbc.nmbcud006,l_nmbc.nmbcud007,l_nmbc.nmbcud008,
#                    l_nmbc.nmbcud009,l_nmbc.nmbcud010,l_nmbc.nmbcud011,l_nmbc.nmbcud012,l_nmbc.nmbcud013,l_nmbc.nmbcud014,l_nmbc.nmbcud015,l_nmbc.nmbcud016,
#                    l_nmbc.nmbcud017,l_nmbc.nmbcud018,l_nmbc.nmbcud019,l_nmbc.nmbcud020,l_nmbc.nmbcud021,l_nmbc.nmbcud022,l_nmbc.nmbcud023,l_nmbc.nmbcud024,
#                    l_nmbc.nmbcud025,l_nmbc.nmbcud026,l_nmbc.nmbcud027,l_nmbc.nmbcud028,l_nmbc.nmbcud029,l_nmbc.nmbcud030,l_nmbc.nmbc012,l_nmbc.nmbc013,
#                    l_nmbc.nmbc014,l_nmbc.nmbc015,l_nmbc.nmbc016,l_nmbc.nmbc017,l_nmbc.nmbcorga)
#            #161128-00061#7---add---end-----------
#            IF SQLCA.SQLCODE THEN
#               INITIALIZE g_errparam TO NULL
#               LET g_errparam.extend = p_glapld
#               LET g_errparam.code   = sqlca.sqlcode
#               LET g_errparam.popup  = TRUE 
#               CALL cl_err()
#               LET r_success = FALSE
#            END IF 
#               
#            FOREACH s_voucher_ins_glbc_cs USING l_glaq.glaqdocno,l_glaq.glaqseq INTO l_glbc.*
#               LET l_glbc.glbc010 = '2'
#               LET l_glbc.glbc015 = 'S'
#               
#                #161128-00061#7---add---begin----------
#                #INSERT INTO glbc_t VALUES(l_glbc.*)
#                INSERT INTO glbc_t (glbcent,glbcld,glbccomp,glbcdocno,glbcseq,glbcseq1,glbc001,glbc002,glbc003,glbc004,glbc005,
#                                    glbc006,glbc007,glbc008,glbc009,glbc010,glbc011,glbc012,glbc013,glbc014,glbcud001,glbcud002,
#                                    glbcud003,glbcud004,glbcud005,glbcud006,glbcud007,glbcud008,glbcud009,glbcud010,glbcud011,
#                                    glbcud012,glbcud013,glbcud014,glbcud015,glbcud016,glbcud017,glbcud018,glbcud019,glbcud020,
#                                    glbcud021,glbcud022,glbcud023,glbcud024,glbcud025,glbcud026,glbcud027,glbcud028,glbcud029,
#                                    glbcud030,glbc015)
#                 VALUES(l_glbc.glbcent,l_glbc.glbcld,l_glbc.glbccomp,l_glbc.glbcdocno,l_glbc.glbcseq,l_glbc.glbcseq1,l_glbc.glbc001,l_glbc.glbc002,l_glbc.glbc003,l_glbc.glbc004,l_glbc.glbc005,
#                        l_glbc.glbc006,l_glbc.glbc007,l_glbc.glbc008,l_glbc.glbc009,l_glbc.glbc010,l_glbc.glbc011,l_glbc.glbc012,l_glbc.glbc013,l_glbc.glbc014,l_glbc.glbcud001,l_glbc.glbcud002,
#                        l_glbc.glbcud003,l_glbc.glbcud004,l_glbc.glbcud005,l_glbc.glbcud006,l_glbc.glbcud007,l_glbc.glbcud008,l_glbc.glbcud009,l_glbc.glbcud010,l_glbc.glbcud011,
#                        l_glbc.glbcud012,l_glbc.glbcud013,l_glbc.glbcud014,l_glbc.glbcud015,l_glbc.glbcud016,l_glbc.glbcud017,l_glbc.glbcud018,l_glbc.glbcud019,l_glbc.glbcud020,
#                        l_glbc.glbcud021,l_glbc.glbcud022,l_glbc.glbcud023,l_glbc.glbcud024,l_glbc.glbcud025,l_glbc.glbcud026,l_glbc.glbcud027,l_glbc.glbcud028,l_glbc.glbcud029,
#                        l_glbc.glbcud030,l_glbc.glbc015)
#                #161128-00061#7---add---end-----------
#               
#               IF SQLCA.SQLCODE THEN
#                  INITIALIZE g_errparam TO NULL
#                  LET g_errparam.extend = p_glapld
#                  LET g_errparam.code   = sqlca.sqlcode
#                  LET g_errparam.popup  = TRUE 
#                  CALL cl_err()
#                  LET r_success = FALSE
#               END IF
#            END FOREACH
#         END IF
#      END FOREACH 
#   END IF
   #151223-00004#1--add--end--lujh
   #170411-00094#1--mark--e--xul 移动到审核段
   RETURN r_success
#==============================
END FUNCTION
# Descriptions...: 傳票憑證過帳还原
# Memo...........:
# Usage..........: CALL s_voucher_unpost_chk(p_glapld,p_glapdocno)
#                  RETURNING r_success
# Input parameter: p_ld           帐套
#                : p_glapdocno    傳票編號
# Return code....: r_success      成功否标识位
# Date & Author..: 2013/09/10 By minpp
# Modify.........:
#===============================
PUBLIC FUNCTION s_voucher_unpost_chk(p_glapld,p_glapdocno)
   DEFINE p_glapld           LIKE glap_t.glapld              #帐别
   DEFINE p_glapdocno        LIKE glap_t.glapdocno           #传票编号
   DEFINE r_success          LIKE type_t.num5                #檢核狀態
   DEFINE r_errno            LIKE type_t.chr80               #錯誤訊息
   DEFINE l_glapstus         LIKE glap_t.glapstus            #状态码
   DEFINE l_glapdocdt        LIKE glap_t.glapdocdt           #单据日期
   DEFINE l_glap002          LIKE glap_t.glap002             #年度
   DEFINE l_glap004          LIKE glap_t.glap004             #期别
   DEFINE l_glar004          LIKE glar_t.glar004             #組合key
   DEFINE l_glar005          LIKE glar_t.glar005             #借方金额
   DEFINE l_glar006          LIKE glar_t.glar006             #贷方金额
   DEFINE l_glar007          LIKE glar_t.glar007             #借方笔数
   DEFINE l_glar008          LIKE glar_t.glar008             #贷方笔数
   DEFINE l_glar010          LIKE glar_t.glar010             #原币借方金额
   DEFINE l_glar011          LIKE glar_t.glar011             #原币贷方金额
   DEFINE l_glar034          LIKE glar_t.glar034             #借方金額(本位幣二)
   DEFINE l_glar035          LIKE glar_t.glar035             #贷方金額(本位幣二)
   DEFINE l_glar036          LIKE glar_t.glar036             #借方金额(本位幣三)
   DEFINE l_glar037          LIKE glar_t.glar037             #贷方金额(本位幣三)
   DEFINE l_sql              STRING 
   DEFINE l_glaa004          LIKE glaa_t.glaa004
   DEFINE l_glac002          LIKE glac_t.glac002
   DEFINE l_glac004          LIKE glac_t.glac004
   DEFINE l_glap007          LIKE glap_t.glap007
   DEFINE l_success          LIKE type_t.num5
   #写入日志文件
   DEFINE l_ch         base.Channel
   DEFINE l_logFile    STRING
   DEFINE l_path       STRING
   DEFINE l_str        STRING
   DEFINE l_glap001          LIKE glap_t.glap001 #151204-00001#1 add
   DEFINE l_cnt        LIKE type_t.num5 #170617-00495#1 add
   
   WHENEVER ERROR CONTINUE
   LET r_errno = ''
   LET r_success = TRUE
   INITIALIZE g_glaq.* TO NULL
   #资料检查
   #(1).传入参数为空，返回
   #170816-00007#130 by 09773 mod(S)
#   IF cl_null(p_glapld) OR cl_null(p_glapdocno) THEN
##      CALL cl_errmsg('unpost',p_glapdocno,'','sub-00110',1)
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.extend = p_glapdocno
#      LET g_errparam.code   = 'sub-00110'
#      LET g_errparam.popup  = TRUE 
#      CALL cl_err()
#      LET r_success = FALSE
#   END IF
   #170816-00007#130 by 09773 mod(E)
   
   #170816-00007#130 by 09773 add(S)
   #修改錯誤訊息報錯內容
   LET g_msg = ''
   LET g_colname_1 = ''
   LET g_comment_1 = ''
   IF cl_null(p_glapld) THEN
      CALL s_azzi902_get_gzzd("aapi511","lbl_glabld") RETURNING g_colname_1,g_comment_1  #賬套 
      LET g_msg = g_colname_1   
   END IF
   IF cl_null(p_glapdocno) THEN
      LET g_colname_1 = ''
      LET g_comment_1 = ''    
      CALL s_azzi902_get_gzzd("aglt310_07","lbl_glapdocno") RETURNING g_colname_1,g_comment_1   #單號
      IF g_msg IS NULL THEN   
         LET g_msg = g_colname_1   
      ELSE   
         LET g_msg = g_msg,",",g_colname_1
      END IF        
   END IF
   IF NOT cl_null(g_msg) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code = 'sub-00788'  #%1傳入值為空(錯誤)
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_msg 
      CALL cl_err()
      LET r_success = FALSE
   END IF   
   #170816-00007#130 by 09773 add(E)
   
   #(2).狀態碼=确认,才可進行確認動作
   #161205-00025#4--mod--str--
#   SELECT glapstus,glapdocdt,glap001 INTO l_glapstus,l_glapdocdt,l_glap001 FROM glap_t  #151204-00001#1 add glap001
   SELECT glapstus,glapdocdt,glap001,glap002,glap004,glap007 
     INTO l_glapstus,l_glapdocdt,l_glap001,l_glap002,l_glap004,l_glap007
     FROM glap_t
   #161205-00025#4--mod--end
    WHERE glapent = g_enterprise
      AND glapld = p_glapld
      AND glapdocno = p_glapdocno
   IF l_glapstus <>'S' THEN
#      CALL cl_errmsg('unpost',p_glapdocno,'','agl-00054',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code   = 'agl-00054'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      LET r_success = FALSE
   END IF 
   
   #(3).檢查當單據日期小於等於關帳日期時，不可異動單據
   IF l_glap001 <> '6' THEN #151204-00001#1 add
      CALL s_fin_date_close_chk(p_glapld,'','AGL',l_glapdocdt) RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
      END IF
   END IF   #151204-00001#1 add
   
   #170617-00495#1--add--str--
   #(4)已回转传票不可过账还原
   LET l_cnt = 0
   SELECT COUNT(1) INTO l_cnt FROM glap_t
    WHERE glapent=g_enterprise AND glapld=p_glapld
      AND glap015=p_glapdocno
      AND glapstus<>'X'
   IF l_cnt > 0 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code   = 'agl-00550'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      LET r_success = FALSE
   END IF
   #170617-00495#1--add--end
   
   
   #当检核有错误时，返回
   IF r_success = FALSE THEN
      RETURN  r_success
   END IF
   
   #更新会计科目余额档
#161205-00025#4--mark--str--
#   #抓取单头该笔资料的年度期别
#   SELECT glap002,glap004,glap007 INTO l_glap002,l_glap004,l_glap007 FROM glap_t
#    WHERE glapent = g_enterprise
#      AND glapld = p_glapld
#      AND glapdocno = p_glapdocno
#161205-00025#4--mark--end
   #抓會計參照表
   SELECT glaa004 INTO l_glaa004 FROM glaa_t 
    WHERE glaaent = g_enterprise AND glaald = p_glapld
    
   #写入日志文件
   #先讀取$ERP, 若無則採用程序写死的路径
   LET l_path = FGL_GETENV("ERP")
   IF cl_null(l_path) THEN
      LET l_path = "/u1/t10dev/erp"
   END IF
   LET l_path = l_path,"/agl/4gl/log/"
#   #将log文件放在temp目录下
#   LET l_path = FGL_GETENV("TEMPDIR"),"/"
   LET l_logFile = l_path,g_today USING "YYYYMMDD","_",p_glapdocno,"_unpost",".log"
   LET l_ch = base.Channel.create()
   CALL l_ch.setDelimiter(NULL)
   CALL l_ch.openFile(l_logFile, "a")
   LET l_str = "#--------------------------- (", CURRENT YEAR TO SECOND,"'",p_glapdocno,"'", "unpost Start) -------------------------#\n"
   CALL l_ch.write(l_str)
   LET l_str = "执行过账还原操作程序：",g_prog,"\n",
               "执行人员：",g_user,"\n"
   CALL l_ch.write(l_str)
   LET l_str="s_voucher_unpost_chk()写入glar_t Start","\n"
   CALL l_ch.write(l_str)
   LET l_str = "FOREACH抓出单身资料","\n"
   CALL l_ch.write(l_str) 
    
   #抓取单身的资料
#161205-00025#4--mark--str--   
#   LET l_sql = " SELECT * FROM glaq_t",
#               "  WHERE glaqent = '",g_enterprise,"'",
#               "    AND glaqld  = '",p_glapld,"'",
#               "    AND glaqdocno = '",p_glapdocno,"'"
#   PREPARE s_voucher_unpost_ins   FROM l_sql
#   DECLARE s_voucher_unpost_cs CURSOR FOR  s_voucher_unpost_ins
#161205-00025#4--mark--end
#161205-00025#4--add--str-- 
   LET l_sql = " SELECT glaq002,glaq005,glaq017,glaq018,glaq019,glaq020,glaq021,",
               "        glaq022,glaq023,glaq024,glaq051,glaq052,glaq053,glaq025,glaq027,glaq028,",
               "        glaq029,glaq030,glaq031,glaq032,glaq033,glaq034,glaq035,glaq036,glaq037,glaq038,",
               "        SUM(CASE WHEN glaq003<>0 THEN glaq010 ELSE 0 END),",
               "        SUM(CASE WHEN glaq004<>0 THEN glaq010 ELSE 0 END),",
               "        SUM(glaq003),SUM(glaq004),SUM(glaq040),SUM(glaq041),SUM(glaq043),SUM(glaq044)",
               "   FROM glaq_t ",
               "  WHERE glaqent = ",g_enterprise,
               "    AND glaqld  = '",p_glapld,"'",
               "    AND glaqdocno = '",p_glapdocno,"'",
               "  GROUP BY glaq002,glaq005,glaq017,glaq018,glaq019,glaq020,glaq021,",
               "        glaq022,glaq023,glaq024,glaq051,glaq052,glaq053,glaq025,glaq027,glaq028,",
               "        glaq029,glaq030,glaq031,glaq032,glaq033,glaq034,glaq035,glaq036,glaq037,glaq038 "
   PREPARE s_voucher_unpost_ins FROM l_sql
   DECLARE s_voucher_unpost_cs CURSOR FOR s_voucher_unpost_ins
   
   LET l_str = " SELECT COUNT(1) FROM glaq_t ",
               "  WHERE glaqent = ",g_enterprise,
               "    AND glaqld  = '",p_glapld,"'",
               "    AND glaqdocno = '",p_glapdocno,"'",
               "    AND glaq002=? AND glaq005=? AND glaq017=? AND glaq018=? AND glaq019=? ",
               "    AND glaq020=? AND glaq021=? AND glaq022=? AND glaq023=? AND glaq024=? ",
               "    AND glaq051=? AND glaq052=? AND glaq053=? AND glaq025=? AND glaq027=? ",
               "    AND glaq028=? AND glaq029=? AND glaq030=? AND glaq031=? AND glaq032=? ",
               "    AND glaq033=? AND glaq034=? AND glaq035=? AND glaq036=? AND glaq037=? ",
               "    AND glaq038=? "
   #借方笔数            
   LET l_sql = l_str," AND glaq003 <> 0 "
   PREPARE s_voucher_unpost_count_d_pr FROM l_sql   
   #贷方笔数
   LET l_sql = l_str," AND glaq004 <> 0 "
   PREPARE s_voucher_unpost_count_c_pr FROM l_sql 
   
   #检查该笔资料在余额档中是否存在
   LET l_sql = "SELECT COUNT(1) FROM glar_t ",l_str
   PREPARE s_voucher_unpost_count_pr FROM l_sql
   
   #更新glar
   LET l_sql = "UPDATE glar_t SET glar005 = glar005 - ?,",
               "                  glar006 = glar006 - ?,",
               "                  glar007 = glar007 - ?,",
               "                  glar008 = glar008 - ?,",
               "                  glar010 = glar010 - ?,",
               "                  glar011 = glar011 - ?,",
               "                  glar034 = glar034 - ?,",
               "                  glar035 = glar035 - ?,",
               "                  glar036 = glar036 - ?,",
               "                  glar037 = glar037 - ? ",
               " WHERE glarent =",g_enterprise,
               "   AND glarld  = '",p_glapld,"'",
               "   AND glar002 = ",l_glap002,  
               "   AND glar003 = ",l_glap004,
               "   AND glar001 = ? AND glar009 = ? AND glar012 = ? AND glar013 = ? AND glar014 = ?",
               "   AND glar015 = ? AND glar016 = ? AND glar017 = ? AND glar018 = ? AND glar019 = ?",
               "   AND glar051 = ? AND glar052 = ? AND glar053 = ? AND glar020 = ? AND glar022 = ?",
               "   AND glar023 = ? AND glar024 = ? AND glar025 = ? AND glar026 = ? AND glar027 = ?",
               "   AND glar028 = ? AND glar029 = ? AND glar030 = ? AND glar031 = ? AND glar032 = ?",
               "   AND glar033 = ? "
   PREPARE s_voucher_unpost_upd_glar_pr FROM l_sql
   
   #抓取上层科目
   LET l_sql = "SELECT glac004 FROM glac_t ",
               " WHERE glacent = ",g_enterprise,
               "   AND glac001 ='",l_glaa004,"' AND glac002=?"
   PREPARE s_voucher_unpost_sel_glac004_pr FROM l_sql
#161205-00025#4--add--str--

#161205-00025#4--mod--str--
#   FOREACH s_voucher_unpost_cs INTO g_glaq.*
   FOREACH s_voucher_unpost_cs INTO g_glaq.glaq002,g_glaq.glaq005,g_glaq.glaq017,g_glaq.glaq018,g_glaq.glaq019,
                                    g_glaq.glaq020,g_glaq.glaq021,g_glaq.glaq022,g_glaq.glaq023,g_glaq.glaq024,
                                    g_glaq.glaq051,g_glaq.glaq052,g_glaq.glaq053,g_glaq.glaq025,g_glaq.glaq027,
                                    g_glaq.glaq028,g_glaq.glaq029,g_glaq.glaq030,g_glaq.glaq031,g_glaq.glaq032,
                                    g_glaq.glaq033,g_glaq.glaq034,g_glaq.glaq035,g_glaq.glaq036,g_glaq.glaq037,
                                    g_glaq.glaq038,l_glar010,l_glar011,g_glaq.glaq003,g_glaq.glaq004,
                                    g_glaq.glaq040,g_glaq.glaq041,g_glaq.glaq043,g_glaq.glaq044   
#161205-00025#4--mod--end
      #写入日志文件
      LET l_str = " FOREACH s_voucher_unpost_cs 执行结果：","\n",
                  " SQLCA.sqlcode = ",SQLCA.sqlcode,"\n"
      CALL l_ch.write(l_str)
      
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         LET r_success = FALSE
         LET r_errno = sqlca.sqlcode
         EXIT FOREACH
      END IF
      
      #写入日志文件
      LET l_str = " 一次FOREACH 执行开始：glaqseq=",g_glaq.glaqseq,"\n",
                  " SQLCA.sqlcode = ",SQLCA.sqlcode,"\n"
      CALL l_ch.write(l_str)
      
      #161205-00025#4--add--str--
      IF cl_null(l_glar010) THEN LET l_glar010 = 0  END IF
      IF cl_null(l_glar011) THEN LET l_glar011 = 0  END IF
      IF cl_null(g_glaq.glaq003) THEN LET g_glaq.glaq003 = 0  END IF
      IF cl_null(g_glaq.glaq004) THEN LET g_glaq.glaq004 = 0  END IF
      IF cl_null(g_glaq.glaq040) THEN LET g_glaq.glaq040 = 0  END IF
      IF cl_null(g_glaq.glaq041) THEN LET g_glaq.glaq041 = 0  END IF
      IF cl_null(g_glaq.glaq043) THEN LET g_glaq.glaq043 = 0  END IF
      IF cl_null(g_glaq.glaq044) THEN LET g_glaq.glaq044 = 0  END IF
      #161205-00025#4--add--end
      
      #依据单身对应key值抓取会计余额档资料
#      #CE,YE类的凭证组合要素给空格
#      IF l_glap007 <>'CE' AND l_glap007 <> 'YE' THEN
         CALL s_voucher_glar004() RETURNING l_glar004
#      ELSE
#         LET l_glar004 = ' '
#      END IF
      
      #161205-00025#4--add--str--
      #借方笔数
      LET l_glar007 = 0
      EXECUTE s_voucher_unpost_count_d_pr 
        USING g_glaq.glaq002,g_glaq.glaq005,g_glaq.glaq017,g_glaq.glaq018,g_glaq.glaq019,
              g_glaq.glaq020,g_glaq.glaq021,g_glaq.glaq022,g_glaq.glaq023,g_glaq.glaq024,
              g_glaq.glaq051,g_glaq.glaq052,g_glaq.glaq053,g_glaq.glaq025,g_glaq.glaq027,
              g_glaq.glaq028,g_glaq.glaq029,g_glaq.glaq030,g_glaq.glaq031,g_glaq.glaq032,
              g_glaq.glaq033,g_glaq.glaq034,g_glaq.glaq035,g_glaq.glaq036,g_glaq.glaq037,
              g_glaq.glaq038
         INTO l_glar007
      #贷方笔数
      LET l_glar008 = 0
      EXECUTE s_voucher_unpost_count_c_pr 
        USING g_glaq.glaq002,g_glaq.glaq005,g_glaq.glaq017,g_glaq.glaq018,g_glaq.glaq019,
              g_glaq.glaq020,g_glaq.glaq021,g_glaq.glaq022,g_glaq.glaq023,g_glaq.glaq024,
              g_glaq.glaq051,g_glaq.glaq052,g_glaq.glaq053,g_glaq.glaq025,g_glaq.glaq027,
              g_glaq.glaq028,g_glaq.glaq029,g_glaq.glaq030,g_glaq.glaq031,g_glaq.glaq032,
              g_glaq.glaq033,g_glaq.glaq034,g_glaq.glaq035,g_glaq.glaq036,g_glaq.glaq037,
              g_glaq.glaq038
         INTO l_glar008
      #161205-00025#4--add--end
      
      LET l_glac002=g_glaq.glaq002 #科目編號
           
      #写入日志文件
      LET l_str = "WHILE循环，从底层科目向上层抓取统制科目产生对应的科目余额档：","\n"
      CALL l_ch.write(l_str)
      
      WHILE TRUE
#161205-00025#4--mod--str--
#         SELECT glar005,glar006,glar007,glar008,glar010,glar011,
#                glar034,glar035,glar036,glar037       
#           INTO l_glar005,l_glar006,l_glar007,l_glar008,l_glar010,l_glar011,
#                l_glar034,l_glar035,l_glar036,l_glar037 
#           FROM glar_t
#          WHERE glarent = g_enterprise
#            AND glarld  = g_glaq.glaqld
#            AND glar001 = l_glac002
#            AND glar002 = l_glap002   
#            AND glar003 = l_glap004
##            AND glar004 = l_glar004
#            AND glar009 = g_glaq.glaq005
#            AND glar012 = g_glaq.glaq017
#            AND glar013 = g_glaq.glaq018
#            AND glar014 = g_glaq.glaq019
#            AND glar015 = g_glaq.glaq020
#            AND glar016 = g_glaq.glaq021
#            AND glar017 = g_glaq.glaq022
#            AND glar018 = g_glaq.glaq023
#            AND glar019 = g_glaq.glaq024
#            AND glar051 = g_glaq.glaq051
#            AND glar052 = g_glaq.glaq052
#            AND glar053 = g_glaq.glaq053
#            AND glar020 = g_glaq.glaq025
#            AND glar022 = g_glaq.glaq027
#            AND glar023 = g_glaq.glaq028
#            AND glar024 = g_glaq.glaq029
#            AND glar025 = g_glaq.glaq030
#            AND glar026 = g_glaq.glaq031
#            AND glar027 = g_glaq.glaq032
#            AND glar028 = g_glaq.glaq033
#            AND glar029 = g_glaq.glaq034
#            AND glar030 = g_glaq.glaq035
#            AND glar031 = g_glaq.glaq036
#            AND glar032 = g_glaq.glaq037
#            AND glar033 = g_glaq.glaq038
            
#         #写入日志文件
#         LET l_str = "账套",g_glaq.glaqld," 科目",l_glac002,"年度",l_glap002,"期别",l_glap004,"\n",
#                     "组合码",l_glar004,"\n",
#                     "余额档借方金额：",l_glar005,"\n",
#                     "余额档贷方金额：",l_glar006,"\n",
#                     "余额档借方笔数：",l_glar007,"\n",
#                     "余额档贷方笔数：",l_glar008,"\n",
#                     "凭证借方金额：",g_glaq.glaq003,"\n",
#                     "凭证贷方金额：",g_glaq.glaq004,"\n"
#         CALL l_ch.write(l_str)
         
#         #如果是借方，则更新借方金额，借方笔数，原币借放金额
#         IF g_glaq.glaq003 <> 0 THEN 
#            LET l_glar005 = l_glar005 - g_glaq.glaq003
#            LET l_glar034 = l_glar034 - g_glaq.glaq040
#            LET l_glar036 = l_glar036 - g_glaq.glaq043
#            LET l_glar010 = l_glar010 - g_glaq.glaq010
#            UPDATE glar_t SET glar005 = l_glar005,  
#                              glar007 = l_glar007 -1,
#                              glar010 = l_glar010,
#                              glar034 = l_glar034,
#                              glar036 = l_glar036
#             WHERE glarent = g_enterprise
#               AND glarld  = g_glaq.glaqld
#               AND glar001 = l_glac002
#               AND glar002 = l_glap002   
#               AND glar003 = l_glap004
##               AND glar004 = l_glar004
#               AND glar009 = g_glaq.glaq005
#               AND glar012 = g_glaq.glaq017
#               AND glar013 = g_glaq.glaq018
#               AND glar014 = g_glaq.glaq019
#               AND glar015 = g_glaq.glaq020
#               AND glar016 = g_glaq.glaq021
#               AND glar017 = g_glaq.glaq022
#               AND glar018 = g_glaq.glaq023
#               AND glar019 = g_glaq.glaq024
#               AND glar051 = g_glaq.glaq051
#               AND glar052 = g_glaq.glaq052
#               AND glar053 = g_glaq.glaq053
#               AND glar020 = g_glaq.glaq025
#               AND glar022 = g_glaq.glaq027
#               AND glar023 = g_glaq.glaq028
#               AND glar024 = g_glaq.glaq029
#               AND glar025 = g_glaq.glaq030
#               AND glar026 = g_glaq.glaq031
#               AND glar027 = g_glaq.glaq032
#               AND glar028 = g_glaq.glaq033
#               AND glar029 = g_glaq.glaq034
#               AND glar030 = g_glaq.glaq035
#               AND glar031 = g_glaq.glaq036
#               AND glar032 = g_glaq.glaq037
#               AND glar033 = g_glaq.glaq038
#           
#           #写入日志文件
#           LET l_str = "账套",g_glaq.glaqld," 科目",l_glac002,"年度",l_glap002,"期别",l_glap004,"\n",
#                       "更新借方金额：",l_glar005,"\n",
#                       "更新借方笔数：",l_glar007 - 1,"\n",
#                       "update glar_t 结果:","\n",
#                       "SQLCA.SQLCODE = ",SQLCA.SQLCODE,"\n",
#                       "SQLCA.sqlerrd[3] = ",SQLCA.sqlerrd[3],"\n"
#           CALL l_ch.write(l_str)    
#         END IF
#         #如果是贷方，则更新贷方金额，贷方笔数，原币贷方金额  
#         IF g_glaq.glaq004 <> 0 THEN 
#            LET l_glar006 = l_glar006 - g_glaq.glaq004
#            LET l_glar035 = l_glar035 - g_glaq.glaq041
#            LET l_glar037 = l_glar037 - g_glaq.glaq044
#            LET l_glar011 = l_glar011 - g_glaq.glaq010
#            UPDATE glar_t SET glar006 = l_glar006,  
#                              glar008 = l_glar008 -1,
#                              glar011 = l_glar011,
#                              glar035 = l_glar035,
#                              glar037 = l_glar037
#             WHERE glarent = g_enterprise
#               AND glarld  = g_glaq.glaqld
#               AND glar001 = l_glac002
#               AND glar002 = l_glap002   
#               AND glar003 = l_glap004
##               AND glar004 = l_glar004
#               AND glar009 = g_glaq.glaq005
#               AND glar012 = g_glaq.glaq017
#               AND glar013 = g_glaq.glaq018
#               AND glar014 = g_glaq.glaq019
#               AND glar015 = g_glaq.glaq020
#               AND glar016 = g_glaq.glaq021
#               AND glar017 = g_glaq.glaq022
#               AND glar018 = g_glaq.glaq023
#               AND glar019 = g_glaq.glaq024
#               AND glar051 = g_glaq.glaq051
#               AND glar052 = g_glaq.glaq052
#               AND glar053 = g_glaq.glaq053
#               AND glar020 = g_glaq.glaq025
#               AND glar022 = g_glaq.glaq027
#               AND glar023 = g_glaq.glaq028
#               AND glar024 = g_glaq.glaq029
#               AND glar025 = g_glaq.glaq030
#               AND glar026 = g_glaq.glaq031
#               AND glar027 = g_glaq.glaq032
#               AND glar028 = g_glaq.glaq033
#               AND glar029 = g_glaq.glaq034
#               AND glar030 = g_glaq.glaq035
#               AND glar031 = g_glaq.glaq036
#               AND glar032 = g_glaq.glaq037
#               AND glar033 = g_glaq.glaq038
#               
#           #写入日志文件
#           LET l_str = "账套",g_glaq.glaqld," 科目",l_glac002,"年度",l_glap002,"期别",l_glap004,"\n",
#                       "更新贷方金额：",l_glar006,"\n",
#                       "更新贷方笔数：",l_glar008 - 1,"\n",
#                       "update glar_t 结果:","\n",
#                       "SQLCA.SQLCODE = ",SQLCA.SQLCODE,"\n",
#                       "SQLCA.sqlerrd[3] = ",SQLCA.sqlerrd[3],"\n"
#           CALL l_ch.write(l_str)
#         END IF
#161205-00025#4--mod--end

         #161205-00025#4--add--str--
         EXECUTE s_voucher_unpost_upd_glar_pr
           USING g_glaq.glaq003,g_glaq.glaq004,l_glar007,l_glar008,l_glar010,l_glar011,
                 g_glaq.glaq040,g_glaq.glaq041,g_glaq.glaq043,g_glaq.glaq044,
                 l_glac002,g_glaq.glaq005,g_glaq.glaq017,g_glaq.glaq018,g_glaq.glaq019,
                 g_glaq.glaq020,g_glaq.glaq021,g_glaq.glaq022,g_glaq.glaq023,g_glaq.glaq024,
                 g_glaq.glaq051,g_glaq.glaq052,g_glaq.glaq053,g_glaq.glaq025,g_glaq.glaq027,
                 g_glaq.glaq028,g_glaq.glaq029,g_glaq.glaq030,g_glaq.glaq031,g_glaq.glaq032,
                 g_glaq.glaq033,g_glaq.glaq034,g_glaq.glaq035,g_glaq.glaq036,g_glaq.glaq037,
                 g_glaq.glaq038
         
           
         #写入日志文件
         LET l_str = "账套",g_glaq.glaqld," 科目",l_glac002,"年度",l_glap002,"期别",l_glap004,"\n",
                     "更新借方减少金额：",g_glaq.glaq003,"\n",
                     "更新借方减少笔数：",l_glar007,"\n",
                     "更新贷方减少金额：",g_glaq.glaq004,"\n",
                     "更新贷方减少笔数：",l_glar008,"\n",
                     "update glar_t 结果:","\n",
                     "SQLCA.SQLCODE = ",SQLCA.SQLCODE,"\n",
                     "SQLCA.sqlerrd[3] = ",SQLCA.sqlerrd[3],"\n"
         CALL l_ch.write(l_str) 
         #161205-00025#4--add--end
         
         IF SQLCA.SQLCODE OR SQLCA.sqlerrd[3] = 0 THEN
#            CALL cl_errmsg('unpost',p_glapdocno,'',sqlca.sqlcode,1)
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = p_glapdocno
            LET g_errparam.code   = sqlca.sqlcode
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            LET r_success = FALSE
         END IF 
         
         #写入日志文件
         LET l_str = "r_success：",r_success,"\n"
         CALL l_ch.write(l_str)
         
         #抓取上层科目
         #161205-00025#4--mod--str--
#         SELECT glac004 INTO l_glac004 FROM glac_t 
#          WHERE glacent = g_enterprise AND glac001 = l_glaa004 AND glac002=l_glac002
         EXECUTE s_voucher_unpost_sel_glac004_pr USING l_glac002 INTO l_glac004
         #161205-00025#4--mod--end
         #已經是最上層科目
         IF l_glac002 = l_glac004 OR cl_null(l_glac002) OR cl_null(l_glac004) THEN
            EXIT WHILE
         ELSE
            LET l_glac002=l_glac004
            
            #写入日志文件
            LET l_str = "更新上层统制科目：",l_glac004,"\n"
            CALL l_ch.write(l_str)
         END IF       
      END WHILE
      
      #写入日志文件
      LET l_str = "一次foreach结束：glaqseq=",g_glaq.glaqseq,"\n"
      CALL l_ch.write(l_str)
   END FOREACH
   
   LET l_str="过账还原更新glar最终结果 r_success",r_success,"\n"
   CALL l_ch.write(l_str)
   LET l_str="s_voucher_unpost_chk()写入glar_t END","\n"
   CALL l_ch.write(l_str)
   LET l_str = "#--------------------------- (", CURRENT YEAR TO SECOND,"'",p_glapdocno,"'", "unpost End) ---------------------------#\n"
   CALL l_ch.write(l_str)
   CALL l_ch.close()
   
   RETURN r_success
#==================================================
END FUNCTION
# Descriptions...: 傳票憑證過帳还原状态更新
# Memo...........:
# Usage..........: CALL s_voucher_post_chk(p_glapld,p_glapdocno)
#                  RETURNING r_success
# Input parameter: p_ld           帐套
#                : p_glapdocno    傳票編號
# Return code....: r_success      成功否标识位
# Date & Author..: 2013/09/10 By minpp
# Modify.........:
#===================================================
PUBLIC FUNCTION s_voucher_unpost_upd(p_glapld,p_glapdocno)
   DEFINE p_glapld         LIKE glap_t.glapld         #帐别
   DEFINE p_glapdocno      LIKE glap_t.glapdocno      #傳票編號
   DEFINE r_success        LIKE type_t.num5
   DEFINE r_errno          LIKE type_t.chr80
   DEFINE l_glappstdt      LIKE glap_t.glappstdt
   #写入日志文件
   DEFINE l_ch         base.Channel
   DEFINE l_logFile    STRING
   DEFINE l_path       STRING
   DEFINE l_str        STRING
   #170411-00094#1--mark--s--xul 移动 到 取消审核段
   #151223-00004#1--add--str--lujh
#   DEFINE l_glapcomp   LIKE glap_t.glapcomp   
#   DEFINE l_glap002    LIKE glap_t.glap002
#   DEFINE l_glap004    LIKE glap_t.glap004
   #151223-00004#1--add--end--lujh
   #170411-00094#1--mark--e--xul
    
   WHENEVER ERROR CONTINUE
   
   #写入日志文件
   #先讀取$ERP, 若無則採用程序写死的路径
   LET l_path = FGL_GETENV("ERP")
   IF cl_null(l_path) THEN
      LET l_path = "/u1/t10dev/erp"
   END IF
   LET l_path = l_path,"/agl/4gl/log/"
#   #将log文件放在temp目录下
#   LET l_path = FGL_GETENV("TEMPDIR"),"/"
   LET l_logFile = l_path,g_today USING "YYYYMMDD","_",p_glapdocno,"_unpost",".log"
   LET l_ch = base.Channel.create()
   CALL l_ch.setDelimiter(NULL)
   CALL l_ch.openFile(l_logFile, "a")
   LET l_str = "#--------------------------- (", CURRENT YEAR TO SECOND,"'",p_glapdocno,"'", "unpost Start) -------------------------#\n"
   CALL l_ch.write(l_str)
   LET l_str = "执行过账还原操作程序：",g_prog,"\n",
               "执行人员：",g_user,"\n"
   CALL l_ch.write(l_str)
   LET l_str="s_voucher_unpost_upd()更新glap_t状态 Start","\n"
   CALL l_ch.write(l_str)
   
   LET r_success  = TRUE
   LET r_errno = ''
   
   #更新狀態碼=過帳, 過帳人=NULL,過帳日期=NULL
   UPDATE glap_t SET glapstus = 'Y',
                    glappstid = '',
                    glappstdt = ''
              WHERE glapent = g_enterprise
                AND glapld = p_glapld
                AND glapdocno = p_glapdocno
   IF SQLCA.SQLCODE OR SQLCA.sqlerrd[3] = 0 THEN
      LET r_success = FALSE
#      CALL cl_errmsg('glapstus',p_glapdocno,'Y',sqlca.sqlcode,1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code   = sqlca.sqlcode
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
   END IF 
    
   #写入日志文件
   LET l_str = "1.更新glap_t状态='Y'  过账者=''  过账日期=''","\n",
               "更新结果：","\n",
               "r_success = ",r_success,"\n",
               "SQLCA.SQLCODE = ",SQLCA.SQLCODE,"\n",
               "SQLCA.sqlerrd[3] = ",SQLCA.sqlerrd[3],"\n"
   CALL l_ch.write(l_str)
   
   #更新該帳套最後過賬時間
   SELECT MAX(glappstdt) INTO l_glappstdt FROM glap_t
    WHERE glapent = g_enterprise AND glapld = p_glapld
    
   UPDATE glaa_t SET glaa012 = l_glappstdt
    WHERE glaaent = g_enterprise
      AND glaald = p_glapld
   IF SQLCA.SQLCODE OR SQLCA.sqlerrd[3] = 0 THEN
#      CALL cl_errmsg('glaa012',p_glapld,'',SQLCA.SQLCODE,1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapld
      LET g_errparam.code   = sqlca.sqlcode
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      LET r_success = FALSE
   END IF 
   
   #写入日志文件
   LET l_str = "2.更新該帳套最後過賬時間 glaa012 =",l_glappstdt,"\n",
               "更新结果：","\n",
               "r_success = ",r_success,"\n",
               "SQLCA.SQLCODE = ",SQLCA.SQLCODE,"\n",
               "SQLCA.sqlerrd[3] = ",SQLCA.sqlerrd[3],"\n"
   CALL l_ch.write(l_str)
   LET l_str="s_voucher_unpost_upd()更新glap_t END","\n"
   CALL l_ch.write(l_str)
   LET l_str = "#--------------------------- (", CURRENT YEAR TO SECOND,"'",p_glapdocno,"'", "unpost End) ---------------------------#\n"
   CALL l_ch.write(l_str)
   CALL l_ch.close()
   #170411-00094#1--mark--s--xul 移动到 取消审核段
   #151223-00004#1--add--str--lujh
#   SELECT glapcomp,glap002,glap004 INTO l_glapcomp,l_glap002,l_glap004
#     FROM glap_t
#    WHERE glapent = g_enterprise
#      AND glapld = p_glapld
#      AND glapdocno = p_glapdocno
#      
#   DELETE FROM nmbc_t
#    WHERE nmbcent = g_enterprise
#      AND nmbcdocno = p_glapdocno
#      AND nmbccomp = l_glapcomp
#   
#   IF SQLCA.SQLCODE THEN
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.extend = p_glapld
#      LET g_errparam.code   = sqlca.sqlcode
#      LET g_errparam.popup  = TRUE 
#      CALL cl_err()
#      LET r_success = FALSE
#   END IF 
#   
#   DELETE FROM glbc_t
#    WHERE glbcent = g_enterprise
#      AND glbcld = p_glapld
#      AND glbcdocno = p_glapdocno
#      AND glbc001 = l_glap002
#      AND glbc002 = l_glap004
#      AND glbc010 = '2'
#   
#   IF SQLCA.SQLCODE THEN
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.extend = p_glapld
#      LET g_errparam.code   = sqlca.sqlcode
#      LET g_errparam.popup  = TRUE 
#      CALL cl_err()
#      LET r_success = FALSE
#   END IF 
   #151223-00004#1--add--end--lujh
   #170411-00094#1--mark--e--xul 移动到 取消审核段
   RETURN r_success
#======================================================
END FUNCTION
# Descriptions...: 傳票憑證作废更新
# Memo...........:
# Usage..........: CALL s_voucher_void_upd(p_glapld,p_glapdocno)
#                  RETURNING r_success
# Input parameter: p_ld           帐套
#                : p_glapdocno    傳票編號
# Return code....: r_success      成功否标识位
# Date & Author..: 2013/09/10 By minpp
# Modify.........:
#====================================================
PUBLIC FUNCTION s_voucher_void_upd(p_glapld,p_glapdocno)
    DEFINE p_glapld         LIKE glap_t.glapld         #帐别
    DEFINE p_glapdocno      LIKE glap_t.glapdocno      #傳票編號
    DEFINE r_success     LIKE type_t.num5
    DEFINE r_errno       LIKE type_t.chr80
    DEFINE l_today       DATETIME YEAR TO SECOND
    WHENEVER ERROR CONTINUE
    
    LET r_success  = TRUE
    LET r_errno = ''
    LET l_today = cl_get_current()
    #更新狀態碼='X', 修改者=g_user,修改日期=g_today
    UPDATE glap_t SET glapstus = 'X',
                      glapmodid = g_user,
                      glapmoddt = l_today
               WHERE glapent = g_enterprise
                 AND glapld = p_glapld
                 AND glapdocno = p_glapdocno
    IF SQLCA.SQLCODE OR SQLCA.sqlerrd[3] = 0 THEN
       LET r_success = FALSE
#       CALL cl_errmsg('glapstus',p_glapdocno,'X',sqlca.sqlcode,1)
       INITIALIZE g_errparam TO NULL
       LET g_errparam.extend = p_glapdocno
       LET g_errparam.code   = sqlca.sqlcode
       LET g_errparam.popup  = TRUE 
       CALL cl_err()
    END IF 
    RETURN r_success
#=====================================================
END FUNCTION
# Descriptions...: 傳票憑證作废
# Memo...........:
# Usage..........: CALL s_voucher_void_chk(p_glapld,p_glapdocno)
#                  RETURNING r_success
# Input parameter: p_ld           帐套
#                : p_glapdocno    傳票編號
# Return code....: r_success      成功否标识位
# Date & Author..: 2013/09/10 By minpp
# Modify.........:
#=====================================================
PUBLIC FUNCTION s_voucher_void_chk(p_glapld,p_glapdocno)
   DEFINE p_glapld           LIKE glap_t.glapld              #帐别
   DEFINE p_glapdocno        LIKE glap_t.glapdocno           #传票编号
   DEFINE r_success          LIKE type_t.num5                #檢核狀態
   DEFINE l_glapstus         LIKE glap_t.glapstus            #状态码
   DEFINE l_glapdocdt        LIKE glap_t.glapdocdt           #单据日期
   DEFINE l_success          LIKE type_t.num5
   DEFINE l_glap001          LIKE glap_t.glap001 #151204-00001#1 add
   
   WHENEVER ERROR CONTINUE
   LET r_success = TRUE
   #资料检查
   #(1).传入参数为空，返回
   #170816-00007#130 by 09773 mod(S)
#   IF cl_null(p_glapld) OR cl_null(p_glapdocno) THEN
##      CALL cl_errmsg('void',p_glapdocno,'','sub-00110',1)
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.extend = p_glapdocno
#      LET g_errparam.code   = 'sub-00110'
#      LET g_errparam.popup  = TRUE 
#      CALL cl_err()
#      LET r_success = FALSE
#   END IF 
   #170816-00007#130 by 09773 mod(E)
   
   #170816-00007#130 by 09773 add(S)
   #修改錯誤訊息報錯內容
   LET g_msg = ''
   LET g_colname_1 = ''
   LET g_comment_1 = ''
   IF cl_null(p_glapld) THEN
      CALL s_azzi902_get_gzzd("aapi511","lbl_glabld") RETURNING g_colname_1,g_comment_1  #賬套 
      LET g_msg = g_colname_1   
   END IF
   IF cl_null(p_glapdocno) THEN
      LET g_colname_1 = ''
      LET g_comment_1 = ''    
      CALL s_azzi902_get_gzzd("aglt310_07","lbl_glapdocno") RETURNING g_colname_1,g_comment_1   #單號
      IF g_msg IS NULL THEN   
         LET g_msg = g_colname_1   
      ELSE   
         LET g_msg = g_msg,",",g_colname_1
      END IF        
   END IF
   IF NOT cl_null(g_msg) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code = 'sub-00788'  #%1傳入值為空(錯誤)
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_msg 
      CALL cl_err()
      LET r_success = FALSE
   END IF   
   #170816-00007#130 by 09773 add(E)
   
   #(2).狀態碼=确认,才可進行確認動作
   SELECT glapstus,glapdocdt,glap001 INTO l_glapstus,l_glapdocdt,l_glap001 FROM glap_t #151204-00001#1 add glap001
    WHERE glapent = g_enterprise
      AND glapld = p_glapld
      AND glapdocno = p_glapdocno
   IF l_glapstus <>'N' THEN
#      CALL cl_errmsg('void',p_glapdocno,'','agl-00052',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code   = 'agl-00052'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      LET r_success = FALSE
   END IF 
   #(3).檢查當單據日期小於等於關帳日期時，不可異動單據
   IF l_glap001 <> '6' THEN #151204-00001#1 add
      CALL s_fin_date_close_chk(p_glapld,'','AGL',l_glapdocdt) RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
      END IF
   END IF   #151204-00001#1 add
   RETURN r_success
#===========================
END FUNCTION
# Descriptions...: 傳票憑證取消確認
# Memo...........:
# Usage..........: CALL s_voucher_unconf_chk(p_glapld,p_glapdocno)
#                  RETURNING r_success
# Input parameter: p_ld           帐套
#                : p_glapdocno    傳票編號
# Return code....: r_success      成功否标识位
# Date & Author..: 2013/09/10 By minpp
# Modify.........:
#=============================
PUBLIC FUNCTION s_voucher_unconf_chk(p_glapld,p_glapdocno)
   DEFINE p_glapld           LIKE glap_t.glapld              #帐别
   DEFINE p_glapdocno        LIKE glap_t.glapdocno           #传票编号
   DEFINE r_success          LIKE type_t.num5                #檢核狀態
   DEFINE l_glapstus         LIKE glap_t.glapstus            #状态码
   DEFINE l_glapdocdt        LIKE glap_t.glapdocdt           #单据日期
   DEFINE l_success          LIKE type_t.num5
   DEFINE l_glap001          LIKE glap_t.glap001 #151204-00001#1 add
   DEFINE l_cnt              LIKE type_t.num10   #170103-00019#1 add
   
   WHENEVER ERROR CONTINUE
   LET r_success = TRUE
   #资料检查
   #(1).传入参数为空，返回
   #170816-00007#130 by 09773 mod(S)
#   IF cl_null(p_glapld) OR cl_null(p_glapdocno) THEN
##      CALL cl_errmsg('unconf',p_glapdocno,'','sub-00110',1)
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.extend = p_glapdocno
#      LET g_errparam.code   = 'sub-00110'
#      LET g_errparam.popup  = TRUE 
#      CALL cl_err()
#      LET r_success = FALSE
#   END IF
   #170816-00007#130 by 09773 mod(E)
   
   #170816-00007#130 by 09773 add(S)
   #修改錯誤訊息報錯內容
   LET g_msg = ''
   LET g_colname_1 = ''
   LET g_comment_1 = ''
   IF cl_null(p_glapld) THEN
      CALL s_azzi902_get_gzzd("aapi511","lbl_glabld") RETURNING g_colname_1,g_comment_1  #賬套 
      LET g_msg = g_colname_1   
   END IF
   IF cl_null(p_glapdocno) THEN
      LET g_colname_1 = ''
      LET g_comment_1 = ''    
      CALL s_azzi902_get_gzzd("aglt310_07","lbl_glapdocno") RETURNING g_colname_1,g_comment_1   #單號
      IF g_msg IS NULL THEN   
         LET g_msg = g_colname_1   
      ELSE   
         LET g_msg = g_msg,",",g_colname_1
      END IF        
   END IF
   IF NOT cl_null(g_msg) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code = 'sub-00788'  #%1傳入值為空(錯誤)
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_msg 
      CALL cl_err()
      LET r_success = FALSE
   END IF   
   #170816-00007#130 by 09773 add(E)
   
   #(2).狀態碼=确认,才可進行確認動作
   SELECT glapstus,glapdocdt,glap001 INTO l_glapstus,l_glapdocdt,l_glap001 FROM glap_t #151204-00001#1 add glap001
    WHERE glapent = g_enterprise
      AND glapld = p_glapld
      AND glapdocno = p_glapdocno
   IF l_glapstus <>'Y' THEN
#      CALL cl_errmsg('unconf',p_glapdocno,'','agl-00053',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code   = 'agl-00053'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      LET r_success = FALSE
   END IF
   #(3).檢查當單據日期小於等於關帳日期時，不可異動單據
   IF l_glap001 <> '6' THEN #151204-00001#1 add
      CALL s_fin_date_close_chk(p_glapld,'','AGL',l_glapdocdt) RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
      END IF 
   END IF   #151204-00001#1 add
   
   #170103-00019#1--add--str--
   #(4).未發生沖抵,才可進行確認動作
   LET l_cnt = 0
   SELECT COUNT(1) INTO l_cnt FROM glax_t
    WHERE glaxent = g_enterprise
      AND glaxld = p_glapld
      AND glaxdocno = p_glapdocno
      AND (glax041>0 OR glax042>0)
   IF l_cnt>0 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapdocno
      LET g_errparam.code = 'agl-00208'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF 
   #170103-00019#1--add--end
   
   RETURN r_success
#=================================================
END FUNCTION
# Descriptions...: 取消审核更新数据库
# Memo...........:
# Usage..........: CALL s_voucher_unconf_upd(p_glapld,p_glapdocno)
#                  RETURNING r_success
# Input parameter: p_ld           帐套
#                : p_glapdocno    傳票編號
# Return code....: r_success      成功否标识位
# Date & Author..: 2013/09/10 By minpp
# Modify.........:
#=================================================
PUBLIC FUNCTION s_voucher_unconf_upd(p_glapld,p_glapdocno)
   DEFINE p_glapld         LIKE glap_t.glapld         #帐别
   DEFINE p_glapdocno      LIKE glap_t.glapdocno      #傳票編號
   DEFINE r_success     LIKE type_t.num5
   DEFINE r_errno       LIKE type_t.chr80
   DEFINE l_glaqseq     LIKE glaq_t.glaqseq   #150703-00021#24
   DEFINE l_ap_slip     LIKE glap_t.glapdocno #150703-00021#24
   DEFINE l_dfin5002    LIKE type_t.chr1      #150703-00021#24
   DEFINE l_glap008     LIKE glap_t.glap008   #150703-00021#24
   DEFINE l_sql         STRING
   #170411-00094#1--add--s--xul
   DEFINE l_glapcomp   LIKE glap_t.glapcomp   
   DEFINE l_glap002    LIKE glap_t.glap002
   DEFINE l_glap004    LIKE glap_t.glap004   
   #170411-00094#1--add--e--xul
   WHENEVER ERROR CONTINUE
   
   LET r_success  = TRUE
   LET r_errno = ''
   #更新狀態碼=開立, 確認人=NULL,確認日期=NULL
    UPDATE glap_t SET glapstus = 'N',
                     glapcnfid = '',
                     glapcnfdt = ''
               WHERE glapent = g_enterprise
                 AND glapld = p_glapld
                 AND glapdocno = p_glapdocno
    IF SQLCA.SQLCODE OR SQLCA.sqlerrd[3] = 0 THEN
       LET r_success = FALSE
#       CALL cl_errmsg('glapstus',p_glapdocno,'N',sqlca.sqlcode,1)
       INITIALIZE g_errparam TO NULL
       LET g_errparam.extend = p_glapdocno
       LET g_errparam.code   = sqlca.sqlcode
       LET g_errparam.popup  = TRUE 
       CALL cl_err()
    END IF 
   #170411-00094#1--add--s--xul
   SELECT glapcomp,glap002,glap004 INTO l_glapcomp,l_glap002,l_glap004
     FROM glap_t
    WHERE glapent = g_enterprise
      AND glapld = p_glapld
      AND glapdocno = p_glapdocno
      
   DELETE FROM nmbc_t
    WHERE nmbcent = g_enterprise
      AND nmbcdocno = p_glapdocno
      AND nmbccomp = l_glapcomp
   
   IF SQLCA.SQLCODE THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapld
      LET g_errparam.code   = sqlca.sqlcode
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      LET r_success = FALSE
   END IF 
   
   DELETE FROM glbc_t
    WHERE glbcent = g_enterprise
      AND glbcld = p_glapld
      AND glbcdocno = p_glapdocno
      AND glbc001 = l_glap002
      AND glbc002 = l_glap004
      AND glbc010 = '2'
   
   IF SQLCA.SQLCODE THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glapld
      LET g_errparam.code   = sqlca.sqlcode
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      LET r_success = FALSE
   END IF 
   #170411-00094#1--add--e--xul
#    IF g_prog MATCHES 'aapp330' THEN  #170116-00074#4   #170301-00030#8 by 09257 --mark
    IF g_prog MATCHES 'aapp330*' THEN  #170301-00030#8 by 09257 --add
    ELSE                              #170116-00074#4
       #150703-00021#24 ---s--
       SELECT glap008 INTO l_glap008 FROM glap_t WHERE glapent = g_enterprise AND glapdocno = p_glapdocno AND glapld = p_glapld
      #IF l_glap008 = 'P10'  THEN       #170116-00074#4 mark
       IF cl_null(l_glap008) THEN         #170116-00074#4 add
          LET l_sql = "  SELECT glaqseq FROM glaq_t               ",
                      #"   WHERE glaqent = '",g_enterprise,"'      ", #170615-00061#25 mark
                      "   WHERE glaqent = ",g_enterprise,"     ",     #170615-00061#25 add
                      "     AND glaqdocno = '",p_glapdocno,"'     ",
                      "     AND glaqld ='",p_glapld,"'            "               
          PREPARE agl_prep02 FROM l_sql
          DECLARE agl_curs02 CURSOR FOR agl_prep02
          FOREACH agl_curs02 INTO l_glaqseq         
             #更新滾動檔狀態
             CALL s_aapp330_bgbd_upd(p_glapdocno,p_glapld,l_glaqseq,'N','3')
                        RETURNING g_sub_success,g_errno
             IF NOT g_sub_success THEN
                INITIALIZE g_errparam TO NULL 
                LET g_errparam.extend = '' 
                LET g_errparam.code   = g_errno 
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
                LET r_success = FALSE 
             END IF                       
          END FOREACH   
       END IF
       #150703-00021#24 ---e--     
    END IF #170116-00074#4       
    RETURN r_success
################################################################################
END FUNCTION
# Descriptions...: 自动产生凭证
# Memo...........:
# Usage..........: CALL s_voucher_gen(p_type,p_ld,p_date,p_slip,p_sum_type,p_wc)
#                       RETURNING r_success,r_start_no,r_end_no
# Input parameter: p_type         来源类型(1.axrt330 应收立帐/2.應付立帳
#                : p_ld           帐套
#                : p_date         立帐日期
#                : p_slip         凭证单别
#                : p_sum_type     汇总方式 
#                : p_wc           QBE条件(帐款来源)
# Return code....: r_success      成功否标识位
#                : r_start_no     生成的起始凭证单号
#                : r_end_no       生成的截止凭证单号
# Date & Author..: 2013/11/01 By Carrier
# Modify.........: 2014/05/19 By Belle 增加來源類型(p_type) 2.應付立帳
################################################################################
PUBLIC FUNCTION s_voucher_gen(p_type,p_ld,p_date,p_slip,p_sum_type,p_wc)
   DEFINE p_type          LIKE type_t.chr2
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE p_date          LIKE glap_t.glapdocdt
   DEFINE p_slip          LIKE ooba_t.ooba002
   DEFINE p_sum_type      LIKE type_t.chr1
   DEFINE p_wc            LIKE type_t.chr1000
   DEFINE r_success       LIKE type_t.num5
   DEFINE r_start_no      LIKE glap_t.glapdocno
   DEFINE r_end_no        LIKE glap_t.glapdocno
   DEFINE l_site          LIKE ooef_t.ooef001
   DEFINE l_success       LIKE type_t.num5
   
   WHENEVER ERROR CONTINUE
   
   LET r_success  = FALSE
   LET r_start_no = NULL
   LET r_end_no   = NULL
   #检查事务中
   IF NOT s_transaction_chk('Y',1) THEN
      RETURN r_success,r_start_no,r_end_no
   END IF   

   IF cl_null(p_type) THEN
      #产生凭证的单别类型为空
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'agl-00120'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success,r_start_no,r_end_no
   END IF
   
   IF cl_null(p_ld) THEN
      #帐套参数为空
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'agl-00121'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success,r_start_no,r_end_no
   END IF
   
   #检查帐套是否正确
   #yemy
   
   IF cl_null(p_slip) THEN
      #传入单别为空
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'agl-00122'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success,r_start_no,r_end_no
   END IF
   
   #检查单别CALL s_aooi200_chk_slip()
   #目前无法取得单别参数表号,需要再确认
   SELECT glaacomp INTO l_site FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald  = p_ld
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'sel glaacomp'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success,r_start_no,r_end_no      
   END IF
#   CALL s_aooi200_chk_slip(l_site,'',p_slip,'aglt310')
#        RETURNING l_success
#   IF NOT l_success THEN
#      RETURN r_success,r_start_no,r_end_no    
#   END IF
   
   IF cl_null(p_sum_type) THEN
      #产生凭证的汇总方式为空
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'agl-00123'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success,r_start_no,r_end_no    
   END IF
   
   IF cl_null(p_wc) THEN LET p_wc = " 1=1" END IF
   
   CASE p_type
        WHEN '1'  #AR-应收立帐自动产生凭证
                  CALL s_voucher_gen_ar_1(p_ld,p_date,p_slip,p_sum_type,p_wc)
                       RETURNING r_success,r_start_no,r_end_no
        WHEN '2'  #AP-應付立帳
  #               CALL s_voucher_gen_ap_1(p_ld,p_date,p_slip,p_sum_type,p_wc)
  #                    RETURNING r_success,r_start_no,r_end_no
        WHEN '3'
   END CASE
   
   RETURN r_success,r_start_no,r_end_no

END FUNCTION
################################################################################
# Descriptions...: 自动产生凭证 定义CURSOR
# Memo...........:
# Usage..........: CALL s_voucher_gen_ar_1_def_cursor(p_ld,p_wc)
#                  RETURNING r_success
# Input parameter: p_ld           帐套
#                : p_wc           QBE条件(帐款来源)
#                : p_sum_type     汇总方式
# Return code....: r_success      成功否标识位
# Date & Author..: 2013/11/01 By Carrier
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_1_def_cursor(p_ld,p_wc,p_sum_type)
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE p_wc            LIKE type_t.chr1000
   DEFINE p_sum_type      LIKE type_t.chr1
   DEFINE r_success       LIKE type_t.num5
   DEFINE l_sql           LIKE type_t.chr1000  
   DEFINE l_glaa004       LIKE glaa_t.glaa004   
   DEFINE l_field         LIKE type_t.chr50
   
   WHENEVER ERROR CONTINUE
   LET r_success = FALSE 
   
   #SELECT xrca
   #161128-00061#7---add---begin-----------
   #LET l_sql = "SELECT * FROM xrca_t ",
   LET l_sql = "SELECT xrcaent,xrcaownid,xrcaowndp,xrcacrtid,xrcacrtdp,xrcacrtdt,xrcamodid,xrcamoddt,",
               "xrcacnfid,xrcacnfdt,xrcapstid,xrcapstdt,xrcastus,xrcacomp,xrcald,xrcadocno,xrcadocdt,",
               "xrca001,xrcasite,xrca003,xrca004,xrca005,xrca006,xrca007,xrca008,xrca009,xrca010,",
               "xrca011,xrca012,xrca013,xrca014,xrca015,xrca016,xrca017,xrca018,xrca019,xrca020,",
               "xrca021,xrca022,xrca023,xrca024,xrca025,xrca026,xrca028,xrca029,xrca030,xrca031,",
               "xrca032,xrca033,xrca034,xrca035,xrca036,xrca037,xrca038,xrca039,xrca040,xrca041,",
               "xrca042,xrca043,xrca044,xrca045,xrca046,xrca047,xrca048,xrca049,xrca050,xrca051,",
               "xrca052,xrca053,xrca054,xrca055,xrca056,xrca057,xrca058,xrca059,xrca060,xrca061,",
               "xrca062,xrca063,xrca064,xrca065,xrca066,xrca100,xrca101,xrca103,xrca104,xrca106,",
               "xrca107,xrca108,xrca113,xrca114,xrca116,xrca117,xrca118,xrca120,xrca121,xrca123,",
               "xrca124,xrca126,xrca127,xrca128,xrca130,xrca131,xrca133,xrca134,xrca136,xrca137,",
               "xrca138,xrcaud001,xrcaud002,xrcaud003,xrcaud004,xrcaud005,xrcaud006,xrcaud007,",
               "xrcaud008,xrcaud009,xrcaud010,xrcaud011,xrcaud012,xrcaud013,xrcaud014,xrcaud015,",
               "xrcaud016,xrcaud017,xrcaud018,xrcaud019,xrcaud020,xrcaud021,xrcaud022,xrcaud023,",
               "xrcaud024,xrcaud025,xrcaud026,xrcaud027,xrcaud028,xrcaud029,xrcaud030 FROM xrca_t ",
   #161128-00061#7---add---end-----------
               " WHERE xrcald = '",p_ld CLIPPED,"'",
               "   AND xrcastus = 'Y' ",
               "   AND xrca038 IS NULL ",
               "   AND ",p_wc,
               #"   AND xrcaent = '",g_enterprise,"' "   #150812-00010#2 #170615-00061#25 mark
               "   AND xrcaent = ",g_enterprise," "      #170615-00061#25 add
   PREPARE s_voucher_gen_ar_1_p1 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_1_p1'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   DECLARE s_voucher_gen_ar_1_cs1 CURSOR FOR s_voucher_gen_ar_1_p1
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_1_cs1'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   #借:应收帐款
               #单号/日期/借/企业/法人/帐套/摘要/科目
   LET l_sql = "SELECT xrcadocno,xrcadocdt,'1',xrcaent,xrcacomp,xrcald,xrcb005,xrca035,",
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xrca100,xrca101,xrcb006,xrcb101,'','',xrca014,'','','',",
               #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
               "       xrcblegl,xrcb010,xrcb011,'',xrca004,xrca004,xrca006,xrcb012,xrca014,",
               #预算编号/专案编号/WB/自由核算项1~10
               "       xrcb017,xrcb015,xrcb016,'','','','','','','','','','',",
               #借/贷/计价数量/原币金额
               "       xrcb115,0,xrcb007, xrcb105,xrca039 ",
               "  FROM xrca_t,xrcb_t ",
               " WHERE xrcbent   = ",g_enterprise,
               "   AND xrcbld    = '",p_ld CLIPPED,"'",
               "   AND xrcbdocno = ? ",
               "   AND xrcaent   = xrcbent ",
               "   AND xrcald    = xrcbld  ",
               "   AND xrcadocno = xrcbdocno "              
   PREPARE s_voucher_gen_ar_1_p2 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_1_p2'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_1_cs2 CURSOR FOR s_voucher_gen_ar_1_p2
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_1_cs2'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF               
               
   #贷 收入科目
               #单号/日期/借/企业/法人/帐套/摘要/科目
   LET l_sql = "SELECT xrcadocno,xrcadocdt,'2',xrcaent,xrcacomp,xrcald,xrcb005,xrcb021,",
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xrca100,xrca101,xrcb006,xrcb101,   '',      '',      xrca014,'','','',",
               #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
               "       xrcblegl,xrcb010,xrcb011,'',xrca004,xrca004,xrca006,xrcb012,xrca014,",
               #预算编号/专案编号/WB/自由核算项1~10
               "       xrcb017,xrcb015,xrcb016,'','','','','','','','','','',",
               #借/贷/计价数量/原币金额
               "       0,xrcb113,xrcb007, xrcb103,xrca039  ",
               "  FROM xrca_t,xrcb_t ",
               " WHERE xrcbent   = ",g_enterprise,
               "   AND xrcbld    = '",p_ld CLIPPED,"'",
               "   AND xrcbdocno = ? ",
               "   AND xrcaent   = xrcbent ",
               "   AND xrcald    = xrcbld  ",
               "   AND xrcadocno = xrcbdocno "  
   PREPARE s_voucher_gen_ar_1_p3 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_1_p3'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_1_cs3 CURSOR FOR s_voucher_gen_ar_1_p3
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_1_cs3'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF      
   
   #贷 销项税额
               #单号/日期/借/企业/法人/帐套/摘要/科目
   LET l_sql = "SELECT xrcadocno,xrcadocdt,'2',xrcaent,xrcacomp,xrcald,xrcb005,xrcd009,",
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xrca100,1,'',0,'','',xrca014,'','','',",
               #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
               "       xrcblegl,xrcb010,xrcb011,'',xrca004,xrca004,xrca006,xrcb012,xrca014,",
               #预算编号/专案编号/WB/自由核算项1~10
               "       xrcb017,xrcb015,xrcb016,'','','','','','','','','','',",
               #借/贷/计价数量/原币金额
               "       0,xrcd114,0, xrcd104,xrca039  ",
               "  FROM xrca_t,xrcb_t,xrcd_t,glaa_t ",
               " WHERE xrcbent   = ",g_enterprise,
               "   AND xrcbld    = '",p_ld CLIPPED,"'",
               "   AND xrcbdocno = ? ",
               "   AND xrcaent   = xrcbent ",
               "   AND xrcald    = xrcbld  ",
               "   AND xrcadocno = xrcbdocno ",
               "   AND xrcdent   = xrcbent ",
               "   AND xrcdld    = xrcbld ",
               "   AND xrcddocno = xrcbdocno ",
               "   AND xrcdseq   = xrcbseq ",
               "   AND xrcbent = glaaent ", #170615-00061#25 add
               "   AND glaald    = xrcdld  "               
   PREPARE s_voucher_gen_ar_1_p4 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_1_p4'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_1_cs4 CURSOR FOR s_voucher_gen_ar_1_p4
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_1_cs4'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF   
   
   #从临时表中取科目
   LET l_sql = " SELECT UNIQUE glaqld,glaq002 FROM s_vr_tmp01 "  #160727-00019#35   16/08/11 By 08734 临时表长度超过15码的减少到15码以下 s_voucher_gen_tmp ——> s_vr_tmp01
   PREPARE s_voucher_gen_ar_1_p5 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_1_p5'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_1_cs5 CURSOR FOR s_voucher_gen_ar_1_p5
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_1_cs5'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF      
   
   #从agli030取科目设置
   LET l_sql = " SELECT glad005,glad007,glad008,glad009,glad010,glad011,glad012,glad013,glad015,",
               "        glad016,glad031,glad032,glad033,glad017,glad018,glad019,glad020,glad021,",
               "        glad022,glad023,glad024,glad025,glad026 ",
               "   FROM glad_t ",
               "  WHERE gladent = ",g_enterprise,
               "    AND gladld  = '",p_ld CLIPPED,"'",
               "    AND glad001 = ? "
   PREPARE s_voucher_gen_ar_1_p6 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_1_p6'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_1_cs6 CURSOR FOR s_voucher_gen_ar_1_p6
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_1_cs6'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF       
   
   #若agli030中没有设置,则要取agli020中的设置
   SELECT glaa004 INTO l_glaa004 FROM glaa_t
    WHERE glaald  = p_ld
      AND glaaent = g_enterprise
   LET l_sql = " SELECT 'N',glac017,glac018,glac019,glac020,glac021,glac022,glac023,glac025,",
               "        glac026,glac028,glac029,glac030,'N','N','N','N','N','N','N','N','N',",
               "        'N' ",
               "   FROM glac_t ",
               "  WHERE glacent = ",g_enterprise,
               "    AND glac001 = '",l_glaa004 CLIPPED,"'",
               "    AND glac002 = ? "
   PREPARE s_voucher_gen_ar_1_p7 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_1_p7'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_1_cs7 CURSOR FOR s_voucher_gen_ar_1_p7
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_1_cs7'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF   

   #临时表GROUP,以便产生凭证单据的单头档glap_t
   #日期字段均有出现的原因是:若传入日期为空时,不管汇总方式为何,均有要按原始日期产生凭证的内容
   CASE p_sum_type
      WHEN '1'  LET l_field = "docno,docdt,''"
      WHEN '2'  LET l_field = "'',docdt,''"
      WHEN '3'  LET l_field = "'',docdt,glaq021"
   END CASE

   LET l_sql = " SELECT UNIQUE glaqent,glaqld,glaqcomp,",l_field CLIPPED,
               "   FROM s_vr_tmp01 "  #160727-00019#35   16/08/11 By 08734 临时表长度超过15码的减少到15码以下 s_voucher_gen_tmp ——> s_vr_tmp01
   PREPARE s_voucher_gen_ar_1_p8 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_1_p8'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_1_cs8 CURSOR FOR s_voucher_gen_ar_1_p8
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_1_cs8'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF

   #用于生成glaq_t资料的临时表
   LET l_sql = " SELECT * FROM s_vr_tmp01 ",  #160727-00019#35   16/08/11 By 08734 临时表长度超过15码的减少到15码以下 s_voucher_gen_tmp ——> s_vr_tmp01
               "  WHERE glaqent  = ? ",
               "    AND glaqld   = ? ",
               "    AND glaqcomp = ? ",
               "    AND docdt    = ? "
   CASE p_sum_type
        WHEN '1' LET l_sql = l_sql CLIPPED," AND docno = ? "
        WHEN '2' LET l_sql = l_sql CLIPPED," AND docdt = ? "
        WHEN '3' LET l_sql = l_sql CLIPPED," AND glaq021 = ? "
   END CASE
   LET l_sql = l_sql CLIPPED," ORDER BY docno "
   PREPARE s_voucher_gen_ar_1_p9 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_1_p9'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_1_cs9 CURSOR FOR s_voucher_gen_ar_1_p9
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_1_cs9'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF  
   
   LET l_sql = "UPDATE xrca_t SET xrca038 = ? ",
               " WHERE xrcaent   = ",g_enterprise,
               "   AND xrcald    = '",p_ld,"'",
               "   AND xrcadocno = ? "
   PREPARE s_voucher_gen_ar_1_p10 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_1_p10'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF

   LET r_success = TRUE
   RETURN r_success
################################################################################
END FUNCTION
# Descriptions...: 应收立帐自动产生凭证
# Memo...........:
# Usage..........: CALL s_voucher_gen_ar_1(p_ld,p_date,p_slip,p_sum_type,p_wc)
#                       RETURNING r_success,r_start_no,r_end_no
# Input parameter: p_ld           帐套
#                : p_date         立帐日期
#                : p_slip         凭证单别
#                : p_sum_type     汇总方式 
#                : p_wc           QBE条件(帐款来源)
# Return code....: r_success      成功否标识位
#                : r_start_no     生成的起始凭证单号
#                : r_end_no       生成的截止凭证单号
# Date & Author..: 2013/11/1 By Carrier
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_1(p_ld,p_date,p_slip,p_sum_type,p_wc)
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE p_date          LIKE glap_t.glapdocdt
   DEFINE p_slip          LIKE ooba_t.ooba002
   DEFINE p_sum_type      LIKE type_t.chr1
   DEFINE p_wc            LIKE type_t.chr1000
   DEFINE r_success       LIKE type_t.num5
   DEFINE r_start_no      LIKE glap_t.glapdocno
   DEFINE r_end_no        LIKE glap_t.glapdocno
   #161128-00061#7---add---begin-----------
   #DEFINE l_xrca          RECORD LIKE xrca_t.*
   DEFINE l_xrca RECORD  #應收憑單單頭
       xrcaent LIKE xrca_t.xrcaent, #企業編號
       xrcaownid LIKE xrca_t.xrcaownid, #資料所有者
       xrcaowndp LIKE xrca_t.xrcaowndp, #資料所屬部門
       xrcacrtid LIKE xrca_t.xrcacrtid, #資料建立者
       xrcacrtdp LIKE xrca_t.xrcacrtdp, #資料建立部門
       xrcacrtdt LIKE xrca_t.xrcacrtdt, #資料創建日
       xrcamodid LIKE xrca_t.xrcamodid, #資料修改者
       xrcamoddt LIKE xrca_t.xrcamoddt, #最近修改日
       xrcacnfid LIKE xrca_t.xrcacnfid, #資料確認者
       xrcacnfdt LIKE xrca_t.xrcacnfdt, #資料確認日
       xrcapstid LIKE xrca_t.xrcapstid, #資料過帳者
       xrcapstdt LIKE xrca_t.xrcapstdt, #資料過帳日
       xrcastus LIKE xrca_t.xrcastus, #狀態碼
       xrcacomp LIKE xrca_t.xrcacomp, #法人
       xrcald LIKE xrca_t.xrcald, #帳套
       xrcadocno LIKE xrca_t.xrcadocno, #應收帳款單號碼
       xrcadocdt LIKE xrca_t.xrcadocdt, #帳款日期
       xrca001 LIKE xrca_t.xrca001, #帳款單性質
       xrcasite LIKE xrca_t.xrcasite, #帳務中心
       xrca003 LIKE xrca_t.xrca003, #帳務人員
       xrca004 LIKE xrca_t.xrca004, #帳款客戶編號
       xrca005 LIKE xrca_t.xrca005, #收款客戶
       xrca006 LIKE xrca_t.xrca006, #客戶分類
       xrca007 LIKE xrca_t.xrca007, #帳款類別
       xrca008 LIKE xrca_t.xrca008, #收款條件編號
       xrca009 LIKE xrca_t.xrca009, #應收款日/應扣抵日
       xrca010 LIKE xrca_t.xrca010, #容許票據到期日
       xrca011 LIKE xrca_t.xrca011, #稅別
       xrca012 LIKE xrca_t.xrca012, #稅率
       xrca013 LIKE xrca_t.xrca013, #含稅否
       xrca014 LIKE xrca_t.xrca014, #人員編號
       xrca015 LIKE xrca_t.xrca015, #部門編號
       xrca016 LIKE xrca_t.xrca016, #來源作業類型
       xrca017 LIKE xrca_t.xrca017, #產生方式
       xrca018 LIKE xrca_t.xrca018, #來源參考單號
       xrca019 LIKE xrca_t.xrca019, #系統產生對應單號(待抵帳款-預收)
       xrca020 LIKE xrca_t.xrca020, #信用狀申請流程否
       xrca021 LIKE xrca_t.xrca021, #商業發票號碼(IV no.)
       xrca022 LIKE xrca_t.xrca022, #出口報單號碼
       xrca023 LIKE xrca_t.xrca023, #發票客戶編號
       xrca024 LIKE xrca_t.xrca024, #發票客戶統一編號
       xrca025 LIKE xrca_t.xrca025, #發票客戶全名
       xrca026 LIKE xrca_t.xrca026, #發票客戶地址
       xrca028 LIKE xrca_t.xrca028, #發票類型
       xrca029 LIKE xrca_t.xrca029, #發票匯率
       xrca030 LIKE xrca_t.xrca030, #發票應開未稅金額
       xrca031 LIKE xrca_t.xrca031, #發票應開稅額
       xrca032 LIKE xrca_t.xrca032, #發票應開含稅金額
       xrca033 LIKE xrca_t.xrca033, #專案編號
       xrca034 LIKE xrca_t.xrca034, #責任中心
       xrca035 LIKE xrca_t.xrca035, #應收(借方)科目編號
       xrca036 LIKE xrca_t.xrca036, #收入(貸方)科目編號
       xrca037 LIKE xrca_t.xrca037, #分錄傳票產生否
       xrca038 LIKE xrca_t.xrca038, #拋轉傳票號碼
       xrca039 LIKE xrca_t.xrca039, #會計檢核附件份數
       xrca040 LIKE xrca_t.xrca040, #留置否
       xrca041 LIKE xrca_t.xrca041, #留置理由碼
       xrca042 LIKE xrca_t.xrca042, #留置設定日期
       xrca043 LIKE xrca_t.xrca043, #留置解除日期
       xrca044 LIKE xrca_t.xrca044, #留置原幣金額
       xrca045 LIKE xrca_t.xrca045, #留置說明
       xrca046 LIKE xrca_t.xrca046, #關係人否
       xrca047 LIKE xrca_t.xrca047, #多角序號
       xrca048 LIKE xrca_t.xrca048, #集團代收/代付單號
       xrca049 LIKE xrca_t.xrca049, #來源營運中心編號
       xrca050 LIKE xrca_t.xrca050, #交易原始單據份數
       xrca051 LIKE xrca_t.xrca051, #作廢理由碼
       xrca052 LIKE xrca_t.xrca052, #列印次數
       xrca053 LIKE xrca_t.xrca053, #備註
       xrca054 LIKE xrca_t.xrca054, #多帳期設定
       xrca055 LIKE xrca_t.xrca055, #繳款優惠條件
       xrca056 LIKE xrca_t.xrca056, #會計檢核附件狀態
       xrca057 LIKE xrca_t.xrca057, #交易對象識別碼
       xrca058 LIKE xrca_t.xrca058, #銷售分類
       xrca059 LIKE xrca_t.xrca059, #預算編號
       xrca060 LIKE xrca_t.xrca060, #發票開立原則
       xrca061 LIKE xrca_t.xrca061, #預計開立發票日期
       xrca062 LIKE xrca_t.xrca062, #多角性質
       xrca063 LIKE xrca_t.xrca063, #整帳批序號
       xrca064 LIKE xrca_t.xrca064, #訂金序次
       xrca065 LIKE xrca_t.xrca065, #發票編號
       xrca066 LIKE xrca_t.xrca066, #發票號碼
       xrca100 LIKE xrca_t.xrca100, #交易原幣別
       xrca101 LIKE xrca_t.xrca101, #原幣匯率
       xrca103 LIKE xrca_t.xrca103, #原幣未稅金額
       xrca104 LIKE xrca_t.xrca104, #原幣稅額
       xrca106 LIKE xrca_t.xrca106, #原幣直接折抵合計金額
       xrca107 LIKE xrca_t.xrca107, #原幣直接沖帳(調整)合計金額
       xrca108 LIKE xrca_t.xrca108, #原幣應收金額
       xrca113 LIKE xrca_t.xrca113, #本幣未稅金額
       xrca114 LIKE xrca_t.xrca114, #本幣稅額
       xrca116 LIKE xrca_t.xrca116, #本幣直接沖帳(調整)合計金額
       xrca117 LIKE xrca_t.xrca117, #本幣直接沖帳(調整)合計金額
       xrca118 LIKE xrca_t.xrca118, #本幣應收金額
       xrca120 LIKE xrca_t.xrca120, #本位幣二幣別
       xrca121 LIKE xrca_t.xrca121, #本位幣二匯率
       xrca123 LIKE xrca_t.xrca123, #本位幣二未稅金額
       xrca124 LIKE xrca_t.xrca124, #本位幣二稅額
       xrca126 LIKE xrca_t.xrca126, #本位幣二直接折抵合計金額
       xrca127 LIKE xrca_t.xrca127, #本位幣二直接沖帳(調整)合計金額
       xrca128 LIKE xrca_t.xrca128, #本位幣二應收金額
       xrca130 LIKE xrca_t.xrca130, #本位幣三幣別
       xrca131 LIKE xrca_t.xrca131, #本位幣三匯率
       xrca133 LIKE xrca_t.xrca133, #本位幣三未稅金額
       xrca134 LIKE xrca_t.xrca134, #本位幣三稅額
       xrca136 LIKE xrca_t.xrca136, #本位幣三直接折抵合計金額
       xrca137 LIKE xrca_t.xrca137, #本位幣三直接沖帳(調整)合計金額
       xrca138 LIKE xrca_t.xrca138, #本位幣三應收金額
       xrcaud001 LIKE xrca_t.xrcaud001, #自定義欄位(文字)001
       xrcaud002 LIKE xrca_t.xrcaud002, #自定義欄位(文字)002
       xrcaud003 LIKE xrca_t.xrcaud003, #自定義欄位(文字)003
       xrcaud004 LIKE xrca_t.xrcaud004, #自定義欄位(文字)004
       xrcaud005 LIKE xrca_t.xrcaud005, #自定義欄位(文字)005
       xrcaud006 LIKE xrca_t.xrcaud006, #自定義欄位(文字)006
       xrcaud007 LIKE xrca_t.xrcaud007, #自定義欄位(文字)007
       xrcaud008 LIKE xrca_t.xrcaud008, #自定義欄位(文字)008
       xrcaud009 LIKE xrca_t.xrcaud009, #自定義欄位(文字)009
       xrcaud010 LIKE xrca_t.xrcaud010, #自定義欄位(文字)010
       xrcaud011 LIKE xrca_t.xrcaud011, #自定義欄位(數字)011
       xrcaud012 LIKE xrca_t.xrcaud012, #自定義欄位(數字)012
       xrcaud013 LIKE xrca_t.xrcaud013, #自定義欄位(數字)013
       xrcaud014 LIKE xrca_t.xrcaud014, #自定義欄位(數字)014
       xrcaud015 LIKE xrca_t.xrcaud015, #自定義欄位(數字)015
       xrcaud016 LIKE xrca_t.xrcaud016, #自定義欄位(數字)016
       xrcaud017 LIKE xrca_t.xrcaud017, #自定義欄位(數字)017
       xrcaud018 LIKE xrca_t.xrcaud018, #自定義欄位(數字)018
       xrcaud019 LIKE xrca_t.xrcaud019, #自定義欄位(數字)019
       xrcaud020 LIKE xrca_t.xrcaud020, #自定義欄位(數字)020
       xrcaud021 LIKE xrca_t.xrcaud021, #自定義欄位(日期時間)021
       xrcaud022 LIKE xrca_t.xrcaud022, #自定義欄位(日期時間)022
       xrcaud023 LIKE xrca_t.xrcaud023, #自定義欄位(日期時間)023
       xrcaud024 LIKE xrca_t.xrcaud024, #自定義欄位(日期時間)024
       xrcaud025 LIKE xrca_t.xrcaud025, #自定義欄位(日期時間)025
       xrcaud026 LIKE xrca_t.xrcaud026, #自定義欄位(日期時間)026
       xrcaud027 LIKE xrca_t.xrcaud027, #自定義欄位(日期時間)027
       xrcaud028 LIKE xrca_t.xrcaud028, #自定義欄位(日期時間)028
       xrcaud029 LIKE xrca_t.xrcaud029, #自定義欄位(日期時間)029
       xrcaud030 LIKE xrca_t.xrcaud030  #自定義欄位(日期時間)030
       END RECORD

   #161128-00061#7---add---end-----------
   DEFINE l_success       LIKE type_t.num5
   
   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE
   LET r_start_no = NULL
   LET r_end_no   = NULL

   IF p_sum_type NOT MATCHES '[123]' THEN
      #产生凭证的汇总方式仅可为1或2或3
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'agl-00124'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success,r_start_no,r_end_no    
   END IF
   
   DELETE FROM s_vr_tmp01;  #160727-00019#35   16/08/11 By 08734 临时表长度超过15码的减少到15码以下 s_voucher_gen_tmp ——> s_vr_tmp01

   #1.定义CURSOR
   CALL s_voucher_gen_ar_1_def_cursor(p_ld,p_wc,p_sum_type) RETURNING l_success
   IF NOT l_success THEN
      RETURN r_success,r_start_no,r_end_no       
   END IF
 
   #2.插入临时表
   FOREACH s_voucher_gen_ar_1_cs1 INTO l_xrca.*
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach s_voucher_gen_ar_1_cs1'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success,r_start_no,r_end_no
      END IF
      
      #借 应收帐款科目 xrca035
      CALL s_voucher_gen_ar_1_ins_tmp('1',l_xrca.xrcald,l_xrca.xrcadocno,'')
           RETURNING l_success
      IF NOT l_success THEN
         RETURN r_success,r_start_no,r_end_no       
      END IF
           
      #贷 收入科目
      CALL s_voucher_gen_ar_1_ins_tmp('2',l_xrca.xrcald,l_xrca.xrcadocno,l_xrca.xrca036)
           RETURNING l_success
      IF NOT l_success THEN
         RETURN r_success,r_start_no,r_end_no       
      END IF
      
      #贷 销项税科目
      CALL s_voucher_gen_ar_1_ins_tmp('3',l_xrca.xrcald,l_xrca.xrcadocno,'')
           RETURNING l_success 
      IF NOT l_success THEN
         RETURN r_success,r_start_no,r_end_no       
      END IF
   END FOREACH
   
   #3.按科目设置进行UPDATE,若有做不管理的字段,UPDATE至' '
   CALL s_voucher_gen_ar_1_upd_tmp(p_ld) 
        RETURNING l_success
   IF NOT l_success THEN
      RETURN r_success,r_start_no,r_end_no       
   END IF
      
   #4.若p_date不为空时,则表示凭证日期均为p_date
   IF NOT cl_null(p_date) THEN
      UPDATE s_vr_tmp01 SET docdt = p_date  #160727-00019#35   16/08/11 By 08734 临时表长度超过15码的减少到15码以下 s_voucher_gen_tmp ——> s_vr_tmp01
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'update docdt'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success,r_start_no,r_end_no  
      END IF
   END IF
   
   #5.插入凭证单头
   CALL s_voucher_gen_ar_1_ins_glap(p_slip,p_sum_type)
        RETURNING r_success,r_start_no,r_end_no
   IF NOT l_success THEN
      RETURN r_success,r_start_no,r_end_no       
   END IF   
   
   LET r_success = TRUE

   RETURN r_success,r_start_no,r_end_no
################################################################################
END FUNCTION
# Descriptions...: 自动产生凭证-建立临时表
# Memo...........:
# Usage..........: CALL s_voucher_cre_tmp_table()
#                  RETURNING r_success
# Input parameter: 
# Return code....: r_success      临时表建立成功否
# Date & Author..: 2013/11/01 By Carrier
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_cre_tmp_table()
   DEFINE r_success       LIKE type_t.num5
   
   WHENEVER ERROR CONTINUE
   LET r_success = FALSE
   
   #检查事务中
   IF NOT s_transaction_chk('N',1) THEN
      RETURN r_success
   END IF 
   
   DROP TABLE s_vr_tmp01;  #160727-00019#35   16/08/11 By 08734 临时表长度超过15码的减少到15码以下 s_voucher_gen_tmp ——> s_vr_tmp01
   CREATE TEMP TABLE s_vr_tmp01(  #160727-00019#35   16/08/11 By 08734 临时表长度超过15码的减少到15码以下 s_voucher_gen_tmp ——> s_vr_tmp01
   docno    LIKE glaq_t.glaqdocno,
   docdt    LIKE glap_t.glapdocdt, 
   sw       LIKE type_t.chr1,   
   glaqent  LIKE glaq_t.glaqent,
   glaqcomp LIKE glaq_t.glaqcomp,
   glaqld   LIKE glaq_t.glaqld,
   glaq001  LIKE glaq_t.glaq001,
   glaq002  LIKE glaq_t.glaq002,
   glaq005  LIKE glaq_t.glaq005,
   glaq006  LIKE glaq_t.glaq006,
   glaq007  LIKE glaq_t.glaq007,
   glaq009  LIKE glaq_t.glaq009,
   glaq011  LIKE glaq_t.glaq011,
   glaq012  LIKE glaq_t.glaq012,
   glaq013  LIKE glaq_t.glaq013,
   glaq014  LIKE glaq_t.glaq014,
   glaq015  LIKE glaq_t.glaq015,
   glaq016  LIKE glaq_t.glaq016,   
   glaq017  LIKE glaq_t.glaq017,
   glaq018  LIKE glaq_t.glaq018,
   glaq019  LIKE glaq_t.glaq019,
   glaq020  LIKE glaq_t.glaq020,
   glaq021  LIKE glaq_t.glaq021,
   glaq022  LIKE glaq_t.glaq022,
   glaq023  LIKE glaq_t.glaq023,
   glaq024  LIKE glaq_t.glaq024,
   glaq025  LIKE glaq_t.glaq025,
   glaq026  LIKE glaq_t.glaq026,
   glaq027  LIKE glaq_t.glaq027,
   glaq028  LIKE glaq_t.glaq028,
   glaq029  LIKE glaq_t.glaq029,
   glaq030  LIKE glaq_t.glaq030,
   glaq031  LIKE glaq_t.glaq031,
   glaq032  LIKE glaq_t.glaq032,
   glaq033  LIKE glaq_t.glaq033,
   glaq034  LIKE glaq_t.glaq034,
   glaq035  LIKE glaq_t.glaq035,
   glaq036  LIKE glaq_t.glaq036,
   glaq037  LIKE glaq_t.glaq037,
   glaq038  LIKE glaq_t.glaq038,
   d        LIKE glaq_t.glaq003,
   c        LIKE glaq_t.glaq004,
   qty      LIKE glaq_t.glaq008,
   sum      LIKE glaq_t.glaq010,
   xrca039  LIKE xrca_t.xrca039  
   );
   
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'create'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF

   #151008-00009#4 --s add
   #axrt470遞延沖轉
   DROP TABLE s_vr_tmp02;  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar1_tmp ——> s_vr_tmp02
   CREATE TEMP TABLE s_vr_tmp02(  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar1_tmp ——> s_vr_tmp02
   docno    LIKE glaq_t.glaqdocno,  #單據編號
   docdt    LIKE glap_t.glapdocdt, 
   sw       LIKE type_t.chr1,   
   glaqent  LIKE glaq_t.glaqent,
   glaqcomp LIKE glaq_t.glaqcomp,
   glaqld   LIKE glaq_t.glaqld,
   glaq001  LIKE glaq_t.glaq001,  #摘要
   glaq002  LIKE glaq_t.glaq002,  #科目
   glaq005  LIKE glaq_t.glaq005,  #幣別
   glaq006  LIKE glaq_t.glaq006,  #匯率
   glaq007  LIKE glaq_t.glaq007,  #單位
   glaq009  LIKE glaq_t.glaq009,  #單價
   glaq010  LIKE glaq_t.glaq010,  #原幣金額
   glaq011  LIKE glaq_t.glaq011,  #票據編碼
   glaq012  LIKE glaq_t.glaq012,  #票據日期
   glaq013  LIKE glaq_t.glaq013,  #申請人
   glaq014  LIKE glaq_t.glaq014,  #銀行帳號
   glaq015  LIKE glaq_t.glaq015,  #款別編號
   glaq016  LIKE glaq_t.glaq016,  #收支項目
   glaq017  LIKE glaq_t.glaq017,  #營運據點
   glaq018  LIKE glaq_t.glaq018,  #部門
   glaq019  LIKE glaq_t.glaq019,  #利潤/成本中心
   glaq020  LIKE glaq_t.glaq020,  #區域
   glaq021  LIKE glaq_t.glaq021,  #交易客商
   glaq022  LIKE glaq_t.glaq022,  #帳款客戶
   glaq023  LIKE glaq_t.glaq023,  #客群
   glaq024  LIKE glaq_t.glaq024,  #產品類別
   glaq025  LIKE glaq_t.glaq025,  #人員
   glaq027  LIKE glaq_t.glaq027,  #專案編號
   glaq028  LIKE glaq_t.glaq028,  #WBS
   glaq051  LIKE glaq_t.glaq051,  #經營方式
   glaq052  LIKE glaq_t.glaq052,  #渠道 
   glaq053  LIKE glaq_t.glaq053,  #品牌
   glaq029  LIKE glaq_t.glaq029,  #自由核算項
   glaq030  LIKE glaq_t.glaq030,  
   glaq031  LIKE glaq_t.glaq031,  
   glaq032  LIKE glaq_t.glaq032,  
   glaq033  LIKE glaq_t.glaq033,  
   glaq034  LIKE glaq_t.glaq034,  
   glaq035  LIKE glaq_t.glaq035,  
   glaq036  LIKE glaq_t.glaq036,  
   glaq037  LIKE glaq_t.glaq037,  
   glaq038  LIKE glaq_t.glaq038,  
   d        LIKE glaq_t.glaq003,  #借方金額
   c        LIKE glaq_t.glaq004,  #貸方金額
   qty      LIKE glaq_t.glaq008,  #數量
   sum      LIKE glaq_t.glaq010,  #總計
   glaq039  LIKE glaq_t.glaq039,  #匯率(本位幣二)
   glaq040  LIKE glaq_t.glaq040,  #借方金額(本位幣二)
   glaq041  LIKE glaq_t.glaq041,  #貸方金額(本位幣二)
   glaq042  LIKE glaq_t.glaq042,  #匯率(本位幣三)
   glaq043  LIKE glaq_t.glaq043,  #借方金額(本位幣三)
   glaq044  LIKE glaq_t.glaq044,  #貸方金額(本位幣三)
   seq      LIKE glaq_t.glaqseq,  #項次
   source   LIKE type_t.chr100,   #來源
   glaqseq  LIKE glaq_t.glaqseq,  #項次
   glgb055  LIKE glgb_t.glgb055   #現金變動碼        
   );
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'create'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   
   DROP TABLE s_vr_tmp03;  #160727-00019#35   16/08/11 By 08734 临时表长度超过15码的减少到15码以下 s_voucher_ar1_gro ——> s_vr_tmp03
   CREATE TEMP TABLE s_vr_tmp03(  #160727-00019#35   16/08/11 By 08734 临时表长度超过15码的减少到15码以下 s_voucher_ar1_gro ——> s_vr_tmp03
   docno    LIKE glaq_t.glaqdocno,  #單據編號
   docdt    LIKE glap_t.glapdocdt, 
   sw       LIKE type_t.chr1,   
   glaqent  LIKE glaq_t.glaqent,
   glaqcomp LIKE glaq_t.glaqcomp,
   glaqld   LIKE glaq_t.glaqld,
   glaq001  LIKE glaq_t.glaq001,  #摘要
   glaq002  LIKE glaq_t.glaq002,  #科目
   glaq005  LIKE glaq_t.glaq005,  #幣別
   glaq006  LIKE glaq_t.glaq006,  #匯率
   glaq007  LIKE glaq_t.glaq007,  #單位
   glaq009  LIKE glaq_t.glaq009,  #單價
   glaq010  LIKE glaq_t.glaq010,  #原幣金額
   glaq011  LIKE glaq_t.glaq011,  #票據編碼
   glaq012  LIKE glaq_t.glaq012,  #票據日期
   glaq013  LIKE glaq_t.glaq013,  #申請人
   glaq014  LIKE glaq_t.glaq014,  #銀行帳號
   glaq015  LIKE glaq_t.glaq015,  #款別編號
   glaq016  LIKE glaq_t.glaq016,  #收支項目
   glaq017  LIKE glaq_t.glaq017,  #營運據點
   glaq018  LIKE glaq_t.glaq018,  #部門
   glaq019  LIKE glaq_t.glaq019,  #利潤/成本中心
   glaq020  LIKE glaq_t.glaq020,  #區域
   glaq021  LIKE glaq_t.glaq021,  #交易客商
   glaq022  LIKE glaq_t.glaq022,  #帳款客戶
   glaq023  LIKE glaq_t.glaq023,  #客群
   glaq024  LIKE glaq_t.glaq024,  #產品類別
   glaq025  LIKE glaq_t.glaq025,  #人員
   glaq027  LIKE glaq_t.glaq027,  #專案編號
   glaq028  LIKE glaq_t.glaq028,  #WBS
   glaq051  LIKE glaq_t.glaq051,  #經營方式
   glaq052  LIKE glaq_t.glaq052,  #渠道 
   glaq053  LIKE glaq_t.glaq053,  #品牌
   glaq029  LIKE glaq_t.glaq029,  #自由核算項
   glaq030  LIKE glaq_t.glaq030,  
   glaq031  LIKE glaq_t.glaq031,  
   glaq032  LIKE glaq_t.glaq032,  
   glaq033  LIKE glaq_t.glaq033,  
   glaq034  LIKE glaq_t.glaq034,  
   glaq035  LIKE glaq_t.glaq035,  
   glaq036  LIKE glaq_t.glaq036,  
   glaq037  LIKE glaq_t.glaq037,  
   glaq038  LIKE glaq_t.glaq038,  
   d        LIKE glaq_t.glaq003,  #借方金額
   c        LIKE glaq_t.glaq004,  #貸方金額
   qty      LIKE glaq_t.glaq008,  #數量
   sum      LIKE glaq_t.glaq010,  #總計
   glaq039  LIKE glaq_t.glaq039,  #匯率(本位幣二)
   glaq040  LIKE glaq_t.glaq040,  #借方金額(本位幣二)
   glaq041  LIKE glaq_t.glaq041,  #貸方金額(本位幣二)
   glaq042  LIKE glaq_t.glaq042,  #匯率(本位幣三)
   glaq043  LIKE glaq_t.glaq043,  #借方金額(本位幣三)
   glaq044  LIKE glaq_t.glaq044,  #貸方金額(本位幣三)
   seq      LIKE glaq_t.glaqseq,  #項次
   source   LIKE type_t.chr100,   #來源
   glaqseq  LIKE glaq_t.glaqseq,  #項次
   glgb055  LIKE glgb_t.glgb055   #現金變動碼          
   );
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'create'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   
   #151008-00009#4 --e add

   LET r_success = TRUE
   RETURN r_success


################################################################################
END FUNCTION
# Descriptions...: 处理借方科目及金额等
# Memo...........:
# Usage..........: CALL s_voucher_gen_ar_1_ins_tmp(p_type,p_xrcald,p_xrcadocno,p_xrca036)
#                  RETURNING r_success
# Input parameter: p_type         类型 '1'借含税 '2'贷未税 '3'贷税额
#                : p_xrcald       帐套
#                : p_xrcadocno    应收帐款单号
#                : p_xrca036      科目
# Return code....: r_success      成功否标识位
# Date & Author..: 2013/11/01 By Carrier
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_1_ins_tmp(p_type,p_xrcald,p_xrcadocno,p_xrca036)
   DEFINE p_type           LIKE type_t.chr1
   DEFINE p_xrcald         LIKE xrca_t.xrcald
   DEFINE p_xrcadocno      LIKE xrca_t.xrcadocno
   DEFINE p_xrca036        LIKE xrca_t.xrca036
   DEFINE r_success        LIKE type_t.num5
   DEFINE l_tmp            RECORD 
                           docno    LIKE glaq_t.glaqdocno,
                           docdt    LIKE glap_t.glapdocdt,
                           sw       LIKE type_t.chr1,     
                           glaqent  LIKE glaq_t.glaqent,  
                           glaqcomp LIKE glaq_t.glaqcomp, 
                           glaqld   LIKE glaq_t.glaqld,   
                           glaq001  LIKE glaq_t.glaq001,  
                           glaq002  LIKE glaq_t.glaq002,  
                           glaq005  LIKE glaq_t.glaq005,  
                           glaq006  LIKE glaq_t.glaq006,  
                           glaq007  LIKE glaq_t.glaq007,  
                           glaq009  LIKE glaq_t.glaq009,  
                           glaq011  LIKE glaq_t.glaq011,  
                           glaq012  LIKE glaq_t.glaq012,  
                           glaq013  LIKE glaq_t.glaq013,  
                           glaq014  LIKE glaq_t.glaq014,  
                           glaq015  LIKE glaq_t.glaq015,  
                           glaq016  LIKE glaq_t.glaq016,  
                           glaq017  LIKE glaq_t.glaq017,  
                           glaq018  LIKE glaq_t.glaq018,  
                           glaq019  LIKE glaq_t.glaq019,  
                           glaq020  LIKE glaq_t.glaq020,  
                           glaq021  LIKE glaq_t.glaq021,  
                           glaq022  LIKE glaq_t.glaq022,  
                           glaq023  LIKE glaq_t.glaq023,  
                           glaq024  LIKE glaq_t.glaq024,  
                           glaq025  LIKE glaq_t.glaq025,  
                           glaq026  LIKE glaq_t.glaq026,  
                           glaq027  LIKE glaq_t.glaq027,  
                           glaq028  LIKE glaq_t.glaq028,  
                           glaq029  LIKE glaq_t.glaq029,  
                           glaq030  LIKE glaq_t.glaq030,  
                           glaq031  LIKE glaq_t.glaq031,  
                           glaq032  LIKE glaq_t.glaq032,  
                           glaq033  LIKE glaq_t.glaq033,  
                           glaq034  LIKE glaq_t.glaq034,  
                           glaq035  LIKE glaq_t.glaq035,  
                           glaq036  LIKE glaq_t.glaq036,  
                           glaq037  LIKE glaq_t.glaq037,  
                           glaq038  LIKE glaq_t.glaq038,   
                           d        LIKE glaq_t.glaq003,  
                           c        LIKE glaq_t.glaq004,  
                           qty      LIKE glaq_t.glaq008,  
                           sum      LIKE glaq_t.glaq010,
                           xrca039  LIKE xrca_t.xrca039                              
                           END RECORD
   WHENEVER ERROR CONTINUE    

   LET r_success = FALSE                        
   INITIALIZE l_tmp.* TO NULL

   CASE p_type
        WHEN '1'  #借:应收帐款
               FOREACH s_voucher_gen_ar_1_cs2 USING p_xrcadocno INTO l_tmp.*
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'foreach s_voucher_gen_ar_1_cs2'
                      LET g_errparam.popup = TRUE
                      CALL cl_err()

                      RETURN r_success
                   END IF
                   INSERT INTO s_vr_tmp01 VALUES(l_tmp.*)  #160727-00019#35   16/08/11 By 08734 临时表长度超过15码的减少到15码以下 s_voucher_gen_tmp ——> s_vr_tmp01
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'insert s_vr_tmp01'  #160727-00019#35   16/08/11 By 08734 临时表长度超过15码的减少到15码以下 s_voucher_gen_tmp ——> s_vr_tmp01
                      LET g_errparam.popup = TRUE
                      CALL cl_err()

                      RETURN r_success                   
                   END IF               
               END FOREACH        
        WHEN '2'
               FOREACH s_voucher_gen_ar_1_cs3 USING p_xrcadocno INTO l_tmp.*
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'foreach s_voucher_gen_ar_1_cs2'
                      LET g_errparam.popup = TRUE
                      CALL cl_err()

                      RETURN r_success
                   END IF
                   IF NOT cl_null(p_xrca036) THEN
                      LET l_tmp.glaq002 = p_xrca036
                   END IF
                   INSERT INTO s_vr_tmp01 VALUES(l_tmp.*)  #160727-00019#35   16/08/11 By 08734 临时表长度超过15码的减少到15码以下 s_voucher_gen_tmp ——> s_vr_tmp01
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'insert s_vr_tmp01'  #160727-00019#35   16/08/11 By 08734 临时表长度超过15码的减少到15码以下 s_voucher_gen_tmp ——> s_vr_tmp01
                      LET g_errparam.popup = TRUE
                      CALL cl_err()

                      RETURN r_success                   
                   END IF               
               END FOREACH            
        WHEN '3'
               FOREACH s_voucher_gen_ar_1_cs4 USING p_xrcadocno INTO l_tmp.*
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'foreach s_voucher_gen_ar_1_cs3'
                      LET g_errparam.popup = TRUE
                      CALL cl_err()

                      RETURN r_success
                   END IF
                   INSERT INTO s_vr_tmp01 VALUES(l_tmp.*)  #160727-00019#35   16/08/11 By 08734 临时表长度超过15码的减少到15码以下 s_voucher_gen_tmp ——> s_vr_tmp01
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'insert s_vr_tmp01'  #160727-00019#35   16/08/11 By 08734 临时表长度超过15码的减少到15码以下 s_voucher_gen_tmp ——> s_vr_tmp01
                      LET g_errparam.popup = TRUE
                      CALL cl_err()

                      RETURN r_success                   
                   END IF               
               END FOREACH     
   END CASE
   
   LET r_success = TRUE
   RETURN r_success
   
################################################################################
END FUNCTION
# Descriptions...: 自动产生凭证 - BY 科目的管理设置做UPDATE
# Memo...........:
# Usage..........: CALL s_voucher_gen_ar_1_upd_tmp()
#                  RETURNING r_success
# Input parameter: p_ld           帐套
# Return code....: r_success      成功否标识位
# Date & Author..: 2013/11/01 By Carrier
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_1_upd_tmp(p_ld)
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE r_success       LIKE type_t.num5
   DEFINE l_ld            LIKE glaa_t.glaald
   DEFINE l_glaq002       LIKE glaq_t.glaq002
   DEFINE l_upd_field     LIKE type_t.chr1000
   DEFINE l_sql           LIKE type_t.chr1000
   DEFINE l_glad_r        RECORD 
                          glad005   LIKE glad_t.glad005,  #数量/金额管理否
                          glad007   LIKE glad_t.glad007,  #部门管理否
                          glad008   LIKE glad_t.glad008,  #利润成本管理否
                          glad009   LIKE glad_t.glad009,  #区域管理否
                          glad010   LIKE glad_t.glad010,  #客商管理否
                          glad011   LIKE glad_t.glad011,  #客群管理否
                          glad012   LIKE glad_t.glad012,  #产品类别管理否
                          glad013   LIKE glad_t.glad013,  #人员管理否
#                          glad014   LIKE glad_t.glad014,  #预算管理否
                          glad015   LIKE glad_t.glad015,  #专案管理否
                          glad016   LIKE glad_t.glad016,  #WBS管理否
                          glad031   LIKE glad_t.glad031,  #經營方式管理否
                          glad032   LIKE glad_t.glad032,  #渠道管理否
                          glad033   LIKE glad_t.glad033,  #品牌管理否
                          glad017   LIKE glad_t.glad017,  #自由核算项1管理否
                          glad018   LIKE glad_t.glad018,  #自由核算项2管理否
                          glad019   LIKE glad_t.glad019,  #自由核算项3管理否
                          glad020   LIKE glad_t.glad020,  #自由核算项4管理否
                          glad021   LIKE glad_t.glad021,  #自由核算项5管理否
                          glad022   LIKE glad_t.glad022,  #自由核算项6管理否
                          glad023   LIKE glad_t.glad023,  #自由核算项7管理否
                          glad024   LIKE glad_t.glad024,  #自由核算项8管理否
                          glad025   LIKE glad_t.glad025,  #自由核算项9管理否
                          glad026   LIKE glad_t.glad026   #自由核算项10管理否                        
                          END RECORD
   WHENEVER ERROR CONTINUE
   LET r_success = FALSE   
   FOREACH s_voucher_gen_ar_1_cs5 INTO l_ld,l_glaq002
       IF SQLCA.sqlcode THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code = SQLCA.sqlcode
          LET g_errparam.extend = 'foreach s_voucher_gen_ar_1_cs5'
          LET g_errparam.popup = TRUE
          CALL cl_err()

          RETURN r_success
       END IF  
       
       EXECUTE s_voucher_gen_ar_1_cs6 USING l_glaq002 INTO l_glad_r.*
       IF SQLCA.sqlcode THEN
          EXECUTE s_voucher_gen_ar_1_cs7 USING l_glaq002 INTO l_glad_r.*
       END IF

       LET l_upd_field = NULL
       IF l_glad_r.glad005 = 'N' THEN  #数量/金额不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq007 = ' ',qty = 0,glaq009 = 0"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq007 = ' ',glaq008 = 0,glaq009 = 0"
          END IF
       END IF
       IF l_glad_r.glad007 = 'N' THEN  #部门不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq018 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq018 = ' '"
          END IF
       END IF
       IF l_glad_r.glad008 = 'N' THEN  #利润成本不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq019 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq019 = ' '"
          END IF       
       END IF       

       IF l_glad_r.glad009 = 'N' THEN  #区域不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq020 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq020 = ' '"
          END IF       
       END IF 
#       IF l_glad_r.glad010 = 'N' THEN  #客商不管理
#          IF cl_null(l_upd_field) THEN
#             LET l_upd_field = "glaq021 = ' ',glaq022 = ' '"
#          ELSE
#             LET l_upd_field = l_upd_field CLIPPED,",glaq021 = ' ',glaq022 = ' '"
#          END IF       
#       END IF 
#       IF l_glad_r.glad011 = 'N' THEN  #客群不管理
#          IF cl_null(l_upd_field) THEN
#             LET l_upd_field = "glaq023 = ' '"
#          ELSE
#             LET l_upd_field = l_upd_field CLIPPED,",glaq023 = ' '"
#          END IF       
#       END IF 
       IF l_glad_r.glad012 = 'N' THEN  #产品类别不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq024 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq024 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad031 = 'N' THEN  #經營方式不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq051 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq051 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad032 = 'N' THEN  #渠道不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq052 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq052 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad033 = 'N' THEN  #品牌不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq053 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq053 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad013 = 'N' THEN  #人员不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq025 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq025 = ' '"
          END IF       
       END IF        
#       IF l_glad_r.glad014 = 'N' THEN  #预算不管理
#          IF cl_null(l_upd_field) THEN
#             LET l_upd_field = "glaq026 = ' '"
#          ELSE
#             LET l_upd_field = l_upd_field CLIPPED,",glaq026 = ' '"
#          END IF       
#       END IF        
       IF l_glad_r.glad015 = 'N' THEN  #专案不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq027 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq027 = ' '"
          END IF       
       END IF        
       IF l_glad_r.glad016 = 'N' THEN  #WBS不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq028 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq028 = ' '"
          END IF       
       END IF        
       IF l_glad_r.glad017 = 'N' THEN  #自由核算项1不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq029 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq029 = ' '"
          END IF       
       END IF        
       IF l_glad_r.glad018 = 'N' THEN  #自由核算项2不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq030 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq030 = ' '"
          END IF       
       END IF        
       IF l_glad_r.glad019 = 'N' THEN  #自由核算项3不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq031 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq031 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad020 = 'N' THEN  #自由核算项4不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq032 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq032 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad021 = 'N' THEN  #自由核算项5不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq033 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq033 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad022 = 'N' THEN  #自由核算项6不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq034 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq034 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad023 = 'N' THEN  #自由核算项7不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq035 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq035 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad024 = 'N' THEN  #自由核算项8不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq036 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq036 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad025 = 'N' THEN  #自由核算项9不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq037 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq037 = ' '"
          END IF       
       END IF        
       IF l_glad_r.glad026 = 'N' THEN  #自由核算项10不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq038 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq038 = ' '"
          END IF       
       END IF   
       
       IF NOT cl_null(l_upd_field) THEN
          LET l_sql = "UPDATE s_vr_tmp01 SET ",l_upd_field,  #160727-00019#35   16/08/11 By 08734 临时表长度超过15码的减少到15码以下 s_voucher_gen_tmp ——> s_vr_tmp01
                      " WHERE glaqld  = '",p_ld CLIPPED,"'",
                      "   AND glaq002 = '",l_glaq002,"'"
          PREPARE s_voucher_gen_ar_1_upd_tmp_p1 FROM l_sql
          IF SQLCA.sqlcode THEN
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = SQLCA.sqlcode
             LET g_errparam.extend = 's_voucher_gen_ar_1_upd_tmp_p1'
             LET g_errparam.popup = TRUE
             CALL cl_err()

             RETURN r_success
          END IF
          EXECUTE s_voucher_gen_ar_1_upd_tmp_p1
          IF SQLCA.sqlcode THEN
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = SQLCA.sqlcode
             LET g_errparam.extend = 'execute s_voucher_gen_ar_1_upd_tmp_p1'
             LET g_errparam.popup = TRUE
             CALL cl_err()

             RETURN r_success
          END IF
       END IF

   END FOREACH
   
   LET r_success = TRUE
   RETURN r_success
      
################################################################################
END FUNCTION
# Descriptions...: 自动生成凭证 - 产生凭证单头
# Memo...........:
# Usage..........: CALL s_voucher_gen_ar_1_ins_glap()
#                       RETURNING r_success,r_start_no,r_end_no
# Input parameter: p_slip         凭证单别
#                : p_sum_type     汇种方式
# Return code....: r_success      成功否标识位
#                : r_start_no     生成的起始凭证单号
#                : r_end_no       生成的截止凭证单号
# Date & Author..: 2013/11/01 By Carrier
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_1_ins_glap(p_slip,p_sum_type)
   DEFINE p_slip          LIKE ooba_t.ooba002
   DEFINE p_sum_type      LIKE type_t.chr1
   DEFINE r_success       LIKE type_t.num5
   DEFINE r_start_no      LIKE glap_t.glapdocno
   DEFINE r_end_no        LIKE glap_t.glapdocno
   #161128-00061#7---add---begin-----------
   #DEFINE l_glap          RECORD LIKE glap_t.*
   DEFINE l_glap RECORD  #傳票憑證單頭檔
       glapent LIKE glap_t.glapent, #企業編號
       glapld LIKE glap_t.glapld, #帳套
       glapcomp LIKE glap_t.glapcomp, #法人
       glapdocno LIKE glap_t.glapdocno, #單號
       glapdocdt LIKE glap_t.glapdocdt, #單據日期
       glap001 LIKE glap_t.glap001, #傳票性質
       glap002 LIKE glap_t.glap002, #會計年度
       glap003 LIKE glap_t.glap003, #會計季別
       glap004 LIKE glap_t.glap004, #會計期別
       glap005 LIKE glap_t.glap005, #會計周別
       glap006 LIKE glap_t.glap006, #收支科目
       glap007 LIKE glap_t.glap007, #來源碼
       glap008 LIKE glap_t.glap008, #帳款類型
       glap009 LIKE glap_t.glap009, #總號
       glap010 LIKE glap_t.glap010, #借方總金額
       glap011 LIKE glap_t.glap011, #貸方總金額
       glap012 LIKE glap_t.glap012, #列印次數
       glap013 LIKE glap_t.glap013, #附件張數
       glap014 LIKE glap_t.glap014, #外幣憑證否
       glap015 LIKE glap_t.glap015, #原傳票編號
       glap016 LIKE glap_t.glap016, #來源帳套編號
       glap017 LIKE glap_t.glap017, #來源傳票編號
       glapownid LIKE glap_t.glapownid, #資料所有者
       glapowndp LIKE glap_t.glapowndp, #資料所屬部門
       glapcrtid LIKE glap_t.glapcrtid, #資料建立者
       glapcrtdp LIKE glap_t.glapcrtdp, #資料建立部門
       glapcrtdt LIKE glap_t.glapcrtdt, #資料創建日
       glapmodid LIKE glap_t.glapmodid, #資料修改者
       glapmoddt LIKE glap_t.glapmoddt, #最近修改日
       glapcnfid LIKE glap_t.glapcnfid, #資料確認者
       glapcnfdt LIKE glap_t.glapcnfdt, #資料確認日
       glappstid LIKE glap_t.glappstid, #資料過帳者
       glappstdt LIKE glap_t.glappstdt, #資料過帳日
       glapstus LIKE glap_t.glapstus, #狀態碼
       glapud001 LIKE glap_t.glapud001, #自定義欄位(文字)001
       glapud002 LIKE glap_t.glapud002, #自定義欄位(文字)002
       glapud003 LIKE glap_t.glapud003, #自定義欄位(文字)003
       glapud004 LIKE glap_t.glapud004, #自定義欄位(文字)004
       glapud005 LIKE glap_t.glapud005, #自定義欄位(文字)005
       glapud006 LIKE glap_t.glapud006, #自定義欄位(文字)006
       glapud007 LIKE glap_t.glapud007, #自定義欄位(文字)007
       glapud008 LIKE glap_t.glapud008, #自定義欄位(文字)008
       glapud009 LIKE glap_t.glapud009, #自定義欄位(文字)009
       glapud010 LIKE glap_t.glapud010, #自定義欄位(文字)010
       glapud011 LIKE glap_t.glapud011, #自定義欄位(數字)011
       glapud012 LIKE glap_t.glapud012, #自定義欄位(數字)012
       glapud013 LIKE glap_t.glapud013, #自定義欄位(數字)013
       glapud014 LIKE glap_t.glapud014, #自定義欄位(數字)014
       glapud015 LIKE glap_t.glapud015, #自定義欄位(數字)015
       glapud016 LIKE glap_t.glapud016, #自定義欄位(數字)016
       glapud017 LIKE glap_t.glapud017, #自定義欄位(數字)017
       glapud018 LIKE glap_t.glapud018, #自定義欄位(數字)018
       glapud019 LIKE glap_t.glapud019, #自定義欄位(數字)019
       glapud020 LIKE glap_t.glapud020, #自定義欄位(數字)020
       glapud021 LIKE glap_t.glapud021, #自定義欄位(日期時間)021
       glapud022 LIKE glap_t.glapud022, #自定義欄位(日期時間)022
       glapud023 LIKE glap_t.glapud023, #自定義欄位(日期時間)023
       glapud024 LIKE glap_t.glapud024, #自定義欄位(日期時間)024
       glapud025 LIKE glap_t.glapud025, #自定義欄位(日期時間)025
       glapud026 LIKE glap_t.glapud026, #自定義欄位(日期時間)026
       glapud027 LIKE glap_t.glapud027, #自定義欄位(日期時間)027
       glapud028 LIKE glap_t.glapud028, #自定義欄位(日期時間)028
       glapud029 LIKE glap_t.glapud029, #自定義欄位(日期時間)029
       glapud030 LIKE glap_t.glapud030  #自定義欄位(日期時間)030
       END RECORD

   #161128-00061#7---add---end-----------
   DEFINE l_glaqent       LIKE glaq_t.glaqent
   DEFINE l_glaqld        LIKE glaq_t.glaqld
   DEFINE l_glaqcomp      LIKE glaq_t.glaqcomp
   DEFINE l_docno         LIKE glap_t.glapdocno
   DEFINE l_docdt         LIKE glap_t.glapdocdt
   DEFINE l_glaq021       LIKE glaq_t.glaq021
   DEFINE l_success       LIKE type_t.num5
   DEFINE l_ooef008       LIKE ooef_t.ooef008
   DEFINE l_ooef010       LIKE ooef_t.ooef010

   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE
   LET r_start_no = NULL
   LET r_end_no   = NULL
   
   FOREACH s_voucher_gen_ar_1_cs8 INTO l_glaqent,l_glaqld,l_glaqcomp,l_docno,l_docdt,l_glaq021
      IF SQLCA.sqlcode THEN  
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_ar_1_cs8'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success,r_start_no,r_end_no
      END IF
      
      INITIALIZE l_glap.* TO NULL
      SELECT ooef008,ooef010 INTO l_ooef008,l_ooef010 FROM ooef_t
       WHERE ooefent = g_enterprise
         AND ooef001 = l_glaqcomp
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'sel ooef'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         LET r_start_no = NULL
         LET r_end_no   = NULL
         RETURN r_success,r_start_no,r_end_no
      END IF

      #自动编号
      CALL s_aooi200_fin_gen_docno(l_glaqld,'','',p_slip,l_docdt,g_prog) RETURNING l_success,l_glap.glapdocno
      IF SQLCA.sqlcode THEN
         LET r_start_no = NULL
         LET r_end_no   = NULL
         RETURN r_success,r_start_no,r_end_no
      END IF
      
      #处理起始单号,截止单号
      IF cl_null(r_start_no) THEN LET r_start_no = l_glap.glapdocno END IF
      LET r_end_no   = l_glap.glapdocno 
      
      LET l_glap.glapent   =  l_glaqent  # 企業代碼
      LET l_glap.glapld    =  l_glaqld   # 帳別
      LET l_glap.glapcomp  =  l_glaqcomp # 法人
      LET l_glap.glapdocdt =  l_docdt    # 單據日期
      LET l_glap.glap001   = '1'         # 傳票性質
      
      # 會計年度/會計期別/會計季別/會計周別
      SELECT oogc015,oogc006,oogc007,oogc008 INTO l_glap.glap002,l_glap.glap004,l_glap.glap003,l_glap.glap005
        FROM oogc_t
       WHERE oogcent = g_enterprise
         AND oogc001 = l_ooef008
         AND oogc002 = l_ooef010
         AND oogc003 = l_glap.glapdocdt
      
      LET l_glap.glap006   =  ''         # 收支科目
      LET l_glap.glap007   =  'AR'       # 來源碼
      LET l_glap.glap008   =  'axrt300'  # 帳款類型
      LET l_glap.glap009   =  0          # 總號
      LET l_glap.glap010   =  0          # 借方總金額
      LET l_glap.glap011   =  0          # 貸方總金額
      LET l_glap.glap012   =  0          # 列印次數
      LET l_glap.glap013   =  0          # 附件張數
      LET l_glap.glap014   =  'Y'        # 外幣憑證否
      LET l_glap.glap015   =  ''         # 原傳票編號
      LET l_glap.glap016   =  ''         # 來源帳別編號
      LET l_glap.glap017   =  ''         # 來源傳票編號
      LET l_glap.glapownid =  g_user     # 資料所有者
      LET l_glap.glapowndp =  g_dept     # 資料所屬部門
      LET l_glap.glapcrtid =  g_user     # 資料建立者
      LET l_glap.glapcrtdp =  g_dept     # 資料建立部門
      LET l_glap.glapcrtdt =  cl_get_current()  # 資料創建日
      LET l_glap.glapmodid =  ''         # 資料修改者
      LET l_glap.glapmoddt =  ''         # 最近修改日
      LET l_glap.glapcnfid =  ''         # 資料確認者
      LET l_glap.glapcnfdt =  ''         # 資料確認日
      LET l_glap.glappstid =  ''         # 資料過帳者
      LET l_glap.glappstdt =  ''         # 資料過帳日
      LET l_glap.glapstus  =  'N'        # 狀態碼

      #161128-00061#7---add---begin-----------
      #INSERT INTO glap_t VALUES(l_glap.*)
      INSERT INTO glap_t (glapent,glapld,glapcomp,glapdocno,glapdocdt,glap001,glap002,glap003,glap004,
                          glap005,glap006,glap007,glap008,glap009,glap010,glap011,glap012,glap013,glap014,
                          glap015,glap016,glap017,glapownid,glapowndp,glapcrtid,glapcrtdp,glapcrtdt,
                          glapmodid,glapmoddt,glapcnfid,glapcnfdt,glappstid,glappstdt,glapstus,
                          glapud001,glapud002,glapud003,glapud004,glapud005,glapud006,glapud007,glapud008,
                          glapud009,glapud010,glapud011,glapud012,glapud013,glapud014,glapud015,glapud016,
                          glapud017,glapud018,glapud019,glapud020,glapud021,glapud022,glapud023,glapud024,
                          glapud025,glapud026,glapud027,glapud028,glapud029,glapud030)
       VALUES(l_glap.glapent,l_glap.glapld,l_glap.glapcomp,l_glap.glapdocno,l_glap.glapdocdt,l_glap.glap001,l_glap.glap002,l_glap.glap003,l_glap.glap004,
              l_glap.glap005,l_glap.glap006,l_glap.glap007,l_glap.glap008,l_glap.glap009,l_glap.glap010,l_glap.glap011,l_glap.glap012,l_glap.glap013,l_glap.glap014,
              l_glap.glap015,l_glap.glap016,l_glap.glap017,l_glap.glapownid,l_glap.glapowndp,l_glap.glapcrtid,l_glap.glapcrtdp,l_glap.glapcrtdt,
              l_glap.glapmodid,l_glap.glapmoddt,l_glap.glapcnfid,l_glap.glapcnfdt,l_glap.glappstid,l_glap.glappstdt,l_glap.glapstus,
              l_glap.glapud001,l_glap.glapud002,l_glap.glapud003,l_glap.glapud004,l_glap.glapud005,l_glap.glapud006,l_glap.glapud007,l_glap.glapud008,
              l_glap.glapud009,l_glap.glapud010,l_glap.glapud011,l_glap.glapud012,l_glap.glapud013,l_glap.glapud014,l_glap.glapud015,l_glap.glapud016,
              l_glap.glapud017,l_glap.glapud018,l_glap.glapud019,l_glap.glapud020,l_glap.glapud021,l_glap.glapud022,l_glap.glapud023,l_glap.glapud024,
              l_glap.glapud025,l_glap.glapud026,l_glap.glapud027,l_glap.glapud028,l_glap.glapud029,l_glap.glapud030)
      #161128-00061#7---add---end-----------
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'ins glap'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         LET r_start_no = NULL
         LET r_end_no   = NULL
         RETURN r_success,r_start_no,r_end_no         
      END IF
      
      #产生凭证单身
      CALL s_voucher_gen_ar_1_ins_glaq(p_sum_type,l_glap.glapdocno,l_glaqent,l_glaqld,l_glaqcomp,l_docno,l_docdt,l_glaq021)
           RETURNING l_success
      IF NOT l_success THEN
         LET r_start_no = NULL
         LET r_end_no   = NULL
         RETURN r_success,r_start_no,r_end_no           
      END IF
  
   END FOREACH

   LET r_success = TRUE
   RETURN r_success,r_start_no,r_end_no
   
################################################################################
END FUNCTION
# Descriptions...: 自动生成凭证 - 产生凭证单身
# Memo...........:
# Usage..........: CALL s_voucher_gen_ar_1_ins_glaq(p_sum_type,p_glapdocno,p_glaqent,p_glaqld,p_glaqcomp,p_docno,p_docdt,p_glaq021)
#                       RETURNING r_success
# Input parameter: p_sum_type     汇总类型
#                : p_glapdocno    凭证单号
#                : p_glaqent      企业编号
#                : p_glaqld       帐套
#                : p_glaqcomp     公司编号
#                : p_docno        来源单号
#                : p_docdt        凭证日期
#                : p_glaq021      客商编号
# Return code....: r_success      成功否标识位
# Date & Author..: 2013/11/04 By Carrier
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_1_ins_glaq(p_sum_type,p_glapdocno,p_glaqent,p_glaqld,p_glaqcomp,p_docno,p_docdt,p_glaq021)
   DEFINE p_sum_type          LIKE type_t.chr1
   DEFINE p_glapdocno         LIKE glap_t.glapdocno
   DEFINE p_glaqent           LIKE glaq_t.glaqent
   DEFINE p_glaqld            LIKE glaq_t.glaqld
   DEFINE p_glaqcomp          LIKE glaq_t.glaqcomp
   DEFINE p_docno             LIKE glaq_t.glaqdocno
   DEFINE p_docdt             LIKE glap_t.glapdocdt
   DEFINE p_glaq021           LIKE glaq_t.glaq021
   DEFINE r_success           LIKE type_t.num5
   DEFINE l_value             LIKE type_t.chr50
   #161128-00061#7---add---begin-----------
   #DEFINE l_glaq              RECORD LIKE glaq_t.*
   DEFINE l_glaq RECORD  #傳票憑證單身檔
       glaqent LIKE glaq_t.glaqent, #企業編號
       glaqcomp LIKE glaq_t.glaqcomp, #法人
       glaqld LIKE glaq_t.glaqld, #帳套
       glaqdocno LIKE glaq_t.glaqdocno, #單號
       glaqseq LIKE glaq_t.glaqseq, #項次
       glaq001 LIKE glaq_t.glaq001, #摘要
       glaq002 LIKE glaq_t.glaq002, #科目編號
       glaq003 LIKE glaq_t.glaq003, #借方金額
       glaq004 LIKE glaq_t.glaq004, #貸方金額
       glaq005 LIKE glaq_t.glaq005, #交易幣別
       glaq006 LIKE glaq_t.glaq006, #匯率
       glaq007 LIKE glaq_t.glaq007, #計價單位
       glaq008 LIKE glaq_t.glaq008, #數量
       glaq009 LIKE glaq_t.glaq009, #單價
       glaq010 LIKE glaq_t.glaq010, #原幣金額
       glaq011 LIKE glaq_t.glaq011, #票據編碼
       glaq012 LIKE glaq_t.glaq012, #票據日期
       glaq013 LIKE glaq_t.glaq013, #申請人
       glaq014 LIKE glaq_t.glaq014, #銀行帳號
       glaq015 LIKE glaq_t.glaq015, #款別編號
       glaq016 LIKE glaq_t.glaq016, #收支專案
       glaq017 LIKE glaq_t.glaq017, #營運據點
       glaq018 LIKE glaq_t.glaq018, #部門
       glaq019 LIKE glaq_t.glaq019, #利潤/成本中心
       glaq020 LIKE glaq_t.glaq020, #區域
       glaq021 LIKE glaq_t.glaq021, #收付款客商
       glaq022 LIKE glaq_t.glaq022, #帳款客戶
       glaq023 LIKE glaq_t.glaq023, #客群
       glaq024 LIKE glaq_t.glaq024, #產品類別
       glaq025 LIKE glaq_t.glaq025, #人員
       glaq026 LIKE glaq_t.glaq026, #no use
       glaq027 LIKE glaq_t.glaq027, #專案編號
       glaq028 LIKE glaq_t.glaq028, #WBS
       glaq029 LIKE glaq_t.glaq029, #自由核算項一
       glaq030 LIKE glaq_t.glaq030, #自由核算項二
       glaq031 LIKE glaq_t.glaq031, #自由核算項三
       glaq032 LIKE glaq_t.glaq032, #自由核算項四
       glaq033 LIKE glaq_t.glaq033, #自由核算項五
       glaq034 LIKE glaq_t.glaq034, #自由核算項六
       glaq035 LIKE glaq_t.glaq035, #自由核算項七
       glaq036 LIKE glaq_t.glaq036, #自由核算項八
       glaq037 LIKE glaq_t.glaq037, #自由核算項九
       glaq038 LIKE glaq_t.glaq038, #自由核算項十
       glaq039 LIKE glaq_t.glaq039, #匯率(本位幣二)
       glaq040 LIKE glaq_t.glaq040, #借方金額(本位幣二)
       glaq041 LIKE glaq_t.glaq041, #貸方金額(本位幣二)
       glaq042 LIKE glaq_t.glaq042, #匯率(本位幣三)
       glaq043 LIKE glaq_t.glaq043, #借方金額(本位幣三)
       glaq044 LIKE glaq_t.glaq044, #貸方金額(本位幣三)
       glaq051 LIKE glaq_t.glaq051, #經營方式
       glaq052 LIKE glaq_t.glaq052, #通路
       glaq053 LIKE glaq_t.glaq053, #品牌
       glaqud001 LIKE glaq_t.glaqud001, #自定義欄位(文字)001
       glaqud002 LIKE glaq_t.glaqud002, #自定義欄位(文字)002
       glaqud003 LIKE glaq_t.glaqud003, #自定義欄位(文字)003
       glaqud004 LIKE glaq_t.glaqud004, #自定義欄位(文字)004
       glaqud005 LIKE glaq_t.glaqud005, #自定義欄位(文字)005
       glaqud006 LIKE glaq_t.glaqud006, #自定義欄位(文字)006
       glaqud007 LIKE glaq_t.glaqud007, #自定義欄位(文字)007
       glaqud008 LIKE glaq_t.glaqud008, #自定義欄位(文字)008
       glaqud009 LIKE glaq_t.glaqud009, #自定義欄位(文字)009
       glaqud010 LIKE glaq_t.glaqud010, #自定義欄位(文字)010
       glaqud011 LIKE glaq_t.glaqud011, #自定義欄位(數字)011
       glaqud012 LIKE glaq_t.glaqud012, #自定義欄位(數字)012
       glaqud013 LIKE glaq_t.glaqud013, #自定義欄位(數字)013
       glaqud014 LIKE glaq_t.glaqud014, #自定義欄位(數字)014
       glaqud015 LIKE glaq_t.glaqud015, #自定義欄位(數字)015
       glaqud016 LIKE glaq_t.glaqud016, #自定義欄位(數字)016
       glaqud017 LIKE glaq_t.glaqud017, #自定義欄位(數字)017
       glaqud018 LIKE glaq_t.glaqud018, #自定義欄位(數字)018
       glaqud019 LIKE glaq_t.glaqud019, #自定義欄位(數字)019
       glaqud020 LIKE glaq_t.glaqud020, #自定義欄位(數字)020
       glaqud021 LIKE glaq_t.glaqud021, #自定義欄位(日期時間)021
       glaqud022 LIKE glaq_t.glaqud022, #自定義欄位(日期時間)022
       glaqud023 LIKE glaq_t.glaqud023, #自定義欄位(日期時間)023
       glaqud024 LIKE glaq_t.glaqud024, #自定義欄位(日期時間)024
       glaqud025 LIKE glaq_t.glaqud025, #自定義欄位(日期時間)025
       glaqud026 LIKE glaq_t.glaqud026, #自定義欄位(日期時間)026
       glaqud027 LIKE glaq_t.glaqud027, #自定義欄位(日期時間)027
       glaqud028 LIKE glaq_t.glaqud028, #自定義欄位(日期時間)028
       glaqud029 LIKE glaq_t.glaqud029, #自定義欄位(日期時間)029
       glaqud030 LIKE glaq_t.glaqud030  #自定義欄位(日期時間)030
       END RECORD
   #161128-00061#7---add---end-----------
   DEFINE l_xrca039           LIKE xrca_t.xrca039
   DEFINE l_last_xrcadocno    LIKE xrca_t.xrcadocno
   DEFINE l_foreign           LIKE type_t.chr1
   DEFINE l_glaa001           LIKE glaa_t.glaa001
   DEFINE l_glap010           LIKE glap_t.glap010
   DEFINE l_glap011           LIKE glap_t.glap011
   DEFINE l_glad_r            RECORD 
                              glad005   LIKE glad_t.glad005,  #数量/金额管理否
                              glad007   LIKE glad_t.glad007,  #部门管理否
                              glad008   LIKE glad_t.glad008,  #利润成本管理否
                              glad009   LIKE glad_t.glad009,  #区域管理否
                              glad010   LIKE glad_t.glad010,  #客商管理否
                              glad011   LIKE glad_t.glad011,  #客群管理否
                              glad012   LIKE glad_t.glad012,  #产品类别管理否
                              glad013   LIKE glad_t.glad013,  #人员管理否
#                              glad014   LIKE glad_t.glad014,  #预算管理否
                              glad015   LIKE glad_t.glad015,  #专案管理否
                              glad016   LIKE glad_t.glad016,  #WBS管理否
                              glad031   LIKE glad_t.glad031,  #經營方式管理否
                              glad032   LIKE glad_t.glad032,  #渠道管理否
                              glad033   LIKE glad_t.glad033,  #品牌管理否
                              glad017   LIKE glad_t.glad017,  #自由核算项1管理否
                              glad018   LIKE glad_t.glad018,  #自由核算项2管理否
                              glad019   LIKE glad_t.glad019,  #自由核算项3管理否
                              glad020   LIKE glad_t.glad020,  #自由核算项4管理否
                              glad021   LIKE glad_t.glad021,  #自由核算项5管理否
                              glad022   LIKE glad_t.glad022,  #自由核算项6管理否
                              glad023   LIKE glad_t.glad023,  #自由核算项7管理否
                              glad024   LIKE glad_t.glad024,  #自由核算项8管理否
                              glad025   LIKE glad_t.glad025,  #自由核算项9管理否
                              glad026   LIKE glad_t.glad026   #自由核算项10管理否                        
                              END RECORD
   DEFINE l_tmp               RECORD 
                              docno    LIKE glaq_t.glaqdocno,
                              docdt    LIKE glap_t.glapdocdt,
                              sw       LIKE type_t.chr1,       #1.借  2.贷
                              glaqent  LIKE glaq_t.glaqent,  
                              glaqcomp LIKE glaq_t.glaqcomp, 
                              glaqld   LIKE glaq_t.glaqld,   
                              glaq001  LIKE glaq_t.glaq001,  
                              glaq002  LIKE glaq_t.glaq002,  
                              glaq005  LIKE glaq_t.glaq005,  
                              glaq006  LIKE glaq_t.glaq006,  
                              glaq007  LIKE glaq_t.glaq007,  
                              glaq009  LIKE glaq_t.glaq009,  
                              glaq011  LIKE glaq_t.glaq011,  
                              glaq012  LIKE glaq_t.glaq012,  
                              glaq013  LIKE glaq_t.glaq013,  
                              glaq014  LIKE glaq_t.glaq014,  
                              glaq015  LIKE glaq_t.glaq015,  
                              glaq016  LIKE glaq_t.glaq016,  
                              glaq017  LIKE glaq_t.glaq017,  
                              glaq018  LIKE glaq_t.glaq018,  
                              glaq019  LIKE glaq_t.glaq019,  
                              glaq020  LIKE glaq_t.glaq020,  
                              glaq021  LIKE glaq_t.glaq021,  
                              glaq022  LIKE glaq_t.glaq022,  
                              glaq023  LIKE glaq_t.glaq023,  
                              glaq024  LIKE glaq_t.glaq024,  
                              glaq025  LIKE glaq_t.glaq025,  
                              glaq026  LIKE glaq_t.glaq026,  
                              glaq027  LIKE glaq_t.glaq027,  
                              glaq028  LIKE glaq_t.glaq028,  
                              glaq029  LIKE glaq_t.glaq029,  
                              glaq030  LIKE glaq_t.glaq030,  
                              glaq031  LIKE glaq_t.glaq031,  
                              glaq032  LIKE glaq_t.glaq032,  
                              glaq033  LIKE glaq_t.glaq033,  
                              glaq034  LIKE glaq_t.glaq034,  
                              glaq035  LIKE glaq_t.glaq035,  
                              glaq036  LIKE glaq_t.glaq036,  
                              glaq037  LIKE glaq_t.glaq037,  
                              glaq038  LIKE glaq_t.glaq038,   
                              d        LIKE glaq_t.glaq003,  
                              c        LIKE glaq_t.glaq004,  
                              qty      LIKE glaq_t.glaq008,  
                              sum      LIKE glaq_t.glaq010,
                              xrca039  LIKE xrca_t.xrca039                              
                              END RECORD
   
   WHENEVER ERROR CONTINUE
   LET r_success = FALSE
   
   CASE p_sum_type
        WHEN '1'  LET l_value = p_docno
        WHEN '2'  LET l_value = p_docdt
        WHEN '3'  LET l_value = p_glaq021
   END CASE
   
   SELECT glaa001 INTO l_glaa001 FROM glaa_t WHERE glaald = p_glaqld 
   AND glaaent = g_enterprise #161206-00023#1 add
   
   LET l_xrca039 = 0  #附件张数
   LET l_foreign = 'N' #外币凭证否
   
   INITIALIZE l_tmp.* TO NULL
   LET l_last_xrcadocno = NULL
   FOREACH s_voucher_gen_ar_1_cs9 USING p_glaqent,p_glaqld,p_glaqcomp,p_docdt,l_value INTO l_tmp.*
      IF SQLCA.sqlcode THEN  
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_ar_1_cs9'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF   
      INITIALIZE l_glaq.* TO NULL
      
      #汇总 附件张数 & update 来源单据的"抛转凭证单号"
      IF cl_null(l_last_xrcadocno) OR l_last_xrcadocno <> l_tmp.docno THEN
         LET l_xrca039 = l_xrca039 + l_tmp.xrca039
         #
         EXECUTE s_voucher_gen_ar_1_p10 USING p_glapdocno,l_tmp.docno    
         IF SQLCA.sqlcode THEN  
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = 'execute s_voucher_gen_ar_1_cs10'
            LET g_errparam.popup = TRUE
            CALL cl_err()

            RETURN r_success
         END IF         
      END IF
      IF l_foreign = 'N' THEN
         IF l_tmp.glaq005 <> l_glaa001 THEN
            LET l_foreign = 'Y'
         END IF
      END IF
      
      LET l_glaq.glaqent   = l_tmp.glaqent    #企業代碼
      LET l_glaq.glaqcomp  = l_tmp.glaqcomp   #法人
      LET l_glaq.glaqld    = l_tmp.glaqld     #帳別
      LET l_glaq.glaqdocno = p_glapdocno      #單號
      #项次
      SELECT MAX(glaqseq) + 1 INTO l_glaq.glaqseq
        FROM glaq_t
       WHERE glaqent   = l_glaq.glaqent
         AND glaqld    = l_glaq.glaqld
         AND glaqdocno = l_glaq.glaqdocno
      IF cl_null(l_glaq.glaqseq) THEN
         LET l_glaq.glaqseq = 1
      END IF
      LET l_glaq.glaq001   = l_tmp.glaq001    #摘要
      LET l_glaq.glaq002   = l_tmp.glaq002    #科目編號
      LET l_glaq.glaq003   = l_tmp.d          #借方金額
      LET l_glaq.glaq004   = l_tmp.c          #貸方金額
      LET l_glaq.glaq005   = l_tmp.glaq005    #交易幣別
      LET l_glaq.glaq006   = l_tmp.glaq006    #匯率
      LET l_glaq.glaq007   = l_tmp.glaq007    #計價單位
      LET l_glaq.glaq008   = l_tmp.qty        #數量
      LET l_glaq.glaq009   = l_tmp.glaq009    #單價
      LET l_glaq.glaq010   = l_tmp.sum        #原幣金額
      LET l_glaq.glaq011   = l_tmp.glaq011    #票據編碼
      LET l_glaq.glaq012   = l_tmp.glaq012    #票據日期
      LET l_glaq.glaq013   = l_tmp.glaq013    #申請人
      LET l_glaq.glaq014   = l_tmp.glaq014    #銀行帳號
      LET l_glaq.glaq015   = l_tmp.glaq015    #結算方式
      LET l_glaq.glaq016   = l_tmp.glaq016    #收支項目
      LET l_glaq.glaq017   = l_tmp.glaq017    #營運據點
      LET l_glaq.glaq018   = l_tmp.glaq018    #部門
      LET l_glaq.glaq019   = l_tmp.glaq019    #利潤/成本中心
      LET l_glaq.glaq020   = l_tmp.glaq020    #區域

      #对于同一AR单据,若不同科目中有些做客商管理,有些不做客商管理
      #若在s_voucher_gen_ar_1_upd_tmp中直接对glaq021/glaq022做UPDATE时
      #会导致同一AR拆成两张不同的GL
      #故对glaq021/glaq022的判断放置插入glaq时做
      EXECUTE s_voucher_gen_ar_1_cs6 USING l_glaq.glaq002 INTO l_glad_r.*
      IF SQLCA.sqlcode THEN
         EXECUTE s_voucher_gen_ar_1_cs7 USING l_glaq.glaq002 INTO l_glad_r.*
      END IF
      IF l_glad_r.glad010 = 'N' THEN             #客商不管理
         LET l_glaq.glaq021   = ' '              #交易客商
      ELSE
         LET l_glaq.glaq021   = l_tmp.glaq021    #交易客商      
      END IF      
      IF l_glad_r.glad011 = 'N' THEN             #客群不管理
         LET l_glaq.glaq022   = ' '              #交易客商
      ELSE
         LET l_glaq.glaq022   = l_tmp.glaq022    #交易客商      
      END IF         

      LET l_glaq.glaq023   = l_tmp.glaq023    #客群
      LET l_glaq.glaq024   = l_tmp.glaq024    #產品類別
      LET l_glaq.glaq025   = l_tmp.glaq025    #人員
      LET l_glaq.glaq026   = l_tmp.glaq026    #預算編號
      LET l_glaq.glaq027   = l_tmp.glaq027    #專案編號
      LET l_glaq.glaq028   = l_tmp.glaq028    #WBS
      LET l_glaq.glaq029   = l_tmp.glaq029    #自由核算項一
      LET l_glaq.glaq030   = l_tmp.glaq030    #自由核算項二
      LET l_glaq.glaq031   = l_tmp.glaq031    #自由核算項三
      LET l_glaq.glaq032   = l_tmp.glaq032    #自由核算項四
      LET l_glaq.glaq033   = l_tmp.glaq033    #自由核算項五
      LET l_glaq.glaq034   = l_tmp.glaq034    #自由核算項六
      LET l_glaq.glaq035   = l_tmp.glaq035    #自由核算項七
      LET l_glaq.glaq036   = l_tmp.glaq036    #自由核算項八
      LET l_glaq.glaq037   = l_tmp.glaq037    #自由核算項九
      LET l_glaq.glaq038   = l_tmp.glaq038    #自由核算項十
      
      #170322-00036#1 add s--- 
      #核算项如果没值,给个空格 
      IF l_glaq.glaq018 IS NULL THEN LET l_glaq.glaq018 = ' ' END IF
      IF l_glaq.glaq019 IS NULL THEN LET l_glaq.glaq019 = ' ' END IF
      IF l_glaq.glaq020 IS NULL THEN LET l_glaq.glaq020 = ' ' END IF
      IF l_glaq.glaq021 IS NULL THEN LET l_glaq.glaq021 = ' ' END IF
      IF l_glaq.glaq022 IS NULL THEN LET l_glaq.glaq022 = ' ' END IF
      IF l_glaq.glaq023 IS NULL THEN LET l_glaq.glaq023 = ' ' END IF
      IF l_glaq.glaq024 IS NULL THEN LET l_glaq.glaq024 = ' ' END IF
      IF l_glaq.glaq025 IS NULL THEN LET l_glaq.glaq025 = ' ' END IF
      IF l_glaq.glaq027 IS NULL THEN LET l_glaq.glaq027 = ' ' END IF
      IF l_glaq.glaq028 IS NULL THEN LET l_glaq.glaq028 = ' ' END IF
      IF l_glaq.glaq051 IS NULL THEN LET l_glaq.glaq051 = ' ' END IF
      IF l_glaq.glaq052 IS NULL THEN LET l_glaq.glaq052 = ' ' END IF
      IF l_glaq.glaq053 IS NULL THEN LET l_glaq.glaq053 = ' ' END IF
      IF l_glaq.glaq029 IS NULL THEN LET l_glaq.glaq029 = ' ' END IF
      IF l_glaq.glaq030 IS NULL THEN LET l_glaq.glaq030 = ' ' END IF
      IF l_glaq.glaq031 IS NULL THEN LET l_glaq.glaq031 = ' ' END IF
      IF l_glaq.glaq032 IS NULL THEN LET l_glaq.glaq032 = ' ' END IF
      IF l_glaq.glaq033 IS NULL THEN LET l_glaq.glaq033 = ' ' END IF
      IF l_glaq.glaq034 IS NULL THEN LET l_glaq.glaq034 = ' ' END IF
      IF l_glaq.glaq035 IS NULL THEN LET l_glaq.glaq035 = ' ' END IF
      IF l_glaq.glaq036 IS NULL THEN LET l_glaq.glaq036 = ' ' END IF
      IF l_glaq.glaq037 IS NULL THEN LET l_glaq.glaq037 = ' ' END IF
      IF l_glaq.glaq038 IS NULL THEN LET l_glaq.glaq038 = ' ' END IF
      #170322-00036#1 add e--- 
      
      #161128-00061#7---add---begin-----------
      #INSERT INTO glaq_t VALUES(l_glaq.*)
      INSERT INTO glaq_t (glaqent,glaqcomp,glaqld,glaqdocno,glaqseq,glaq001,glaq002,glaq003,glaq004,glaq005,
                          glaq006,glaq007,glaq008,glaq009,glaq010,glaq011,glaq012,glaq013,glaq014,glaq015,
                          glaq016,glaq017,glaq018,glaq019,glaq020,glaq021,glaq022,glaq023,glaq024,glaq025,
                          glaq026,glaq027,glaq028,glaq029,glaq030,glaq031,glaq032,glaq033,glaq034,glaq035,
                          glaq036,glaq037,glaq038,glaq039,glaq040,glaq041,glaq042,glaq043,glaq044,glaq051,
                          glaq052,glaq053,glaqud001,glaqud002,glaqud003,glaqud004,glaqud005,glaqud006,
                          glaqud007,glaqud008,glaqud009,glaqud010,glaqud011,glaqud012,glaqud013,glaqud014,
                          glaqud015,glaqud016,glaqud017,glaqud018,glaqud019,glaqud020,glaqud021,glaqud022,
                          glaqud023,glaqud024,glaqud025,glaqud026,glaqud027,glaqud028,glaqud029,glaqud030)
       VALUES(l_glaq.glaqent,l_glaq.glaqcomp,l_glaq.glaqld,l_glaq.glaqdocno,l_glaq.glaqseq,l_glaq.glaq001,l_glaq.glaq002,l_glaq.glaq003,l_glaq.glaq004,l_glaq.glaq005,
              l_glaq.glaq006,l_glaq.glaq007,l_glaq.glaq008,l_glaq.glaq009,l_glaq.glaq010,l_glaq.glaq011,l_glaq.glaq012,l_glaq.glaq013,l_glaq.glaq014,l_glaq.glaq015,
              l_glaq.glaq016,l_glaq.glaq017,l_glaq.glaq018,l_glaq.glaq019,l_glaq.glaq020,l_glaq.glaq021,l_glaq.glaq022,l_glaq.glaq023,l_glaq.glaq024,l_glaq.glaq025,
              l_glaq.glaq026,l_glaq.glaq027,l_glaq.glaq028,l_glaq.glaq029,l_glaq.glaq030,l_glaq.glaq031,l_glaq.glaq032,l_glaq.glaq033,l_glaq.glaq034,l_glaq.glaq035,
              l_glaq.glaq036,l_glaq.glaq037,l_glaq.glaq038,l_glaq.glaq039,l_glaq.glaq040,l_glaq.glaq041,l_glaq.glaq042,l_glaq.glaq043,l_glaq.glaq044,l_glaq.glaq051,
              l_glaq.glaq052,l_glaq.glaq053,l_glaq.glaqud001,l_glaq.glaqud002,l_glaq.glaqud003,l_glaq.glaqud004,l_glaq.glaqud005,l_glaq.glaqud006,
              l_glaq.glaqud007,l_glaq.glaqud008,l_glaq.glaqud009,l_glaq.glaqud010,l_glaq.glaqud011,l_glaq.glaqud012,l_glaq.glaqud013,l_glaq.glaqud014,
              l_glaq.glaqud015,l_glaq.glaqud016,l_glaq.glaqud017,l_glaq.glaqud018,l_glaq.glaqud019,l_glaq.glaqud020,l_glaq.glaqud021,l_glaq.glaqud022,
              l_glaq.glaqud023,l_glaq.glaqud024,l_glaq.glaqud025,l_glaq.glaqud026,l_glaq.glaqud027,l_glaq.glaqud028,l_glaq.glaqud029,l_glaq.glaqud030)
      #161128-00061#7---add---end-----------
      IF SQLCA.sqlcode THEN      
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'ins glaq'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF
   END FOREACH
   
   #一笔凭证处理完毕后,对凭证单头进行更行
   #总借/贷
   SELECT SUM(glaq003),SUM(glaq004) INTO l_glap010,l_glap011
     FROM glaq_t
    WHERE glaqent   = p_glaqent
      AND glaqld    = p_glaqld
      AND glaqdocno = p_glapdocno
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'sel glaq'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   IF cl_null(l_glap010) THEN LET l_glap010 = 0 END IF
   IF cl_null(l_glap011) THEN LET l_glap011 = 0 END IF
   
   #附件张数
   UPDATE glap_t SET glap010 = l_glap010,glap011 = l_glap011,glap013 = l_xrca039,glap014 = l_foreign
    WHERE glapent   = p_glaqent
      AND glapld    = p_glaqld
      AND glapdocno = p_glapdocno
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'upd glap_t'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   LET r_success = TRUE
   RETURN r_success
   
   
#=========================
END FUNCTION
#+功能名稱：s_voucher_conf_chk_glam
#功能目的：常用傳票確認
#注意事項：無
#關鍵詞：總帳、分攤、確認
#同義詞：总账、分摊、确认
#參數值：1.帳別 
#　　　　2.分攤編號
#回傳值：1.檢核狀態 
#　　　　2.錯誤訊息
#==========================
PUBLIC FUNCTION s_voucher_conf_chk_glam(p_glalld,p_glaldocno,p_str)
   DEFINE p_glalld         LIKE glal_t.glalld         #帐别
   DEFINE p_glaldocno      LIKE glal_t.glaldocno      #傳票編號
   DEFINE r_success        LIKE type_t.num5           #檢核狀態
   DEFINE r_errno          LIKE type_t.chr80          #錯誤訊息
   DEFINE l_glaldocdt      LIKE glal_t.glaldocdt      #传票日期
   DEFINE l_glam003        LIKE glam_t.glam003        #单身借方金额
   DEFINE l_glam004        LIKE glam_t.glam004        #单身贷方金额
   DEFINE l_cnt            LIKE type_t.num5
   DEFINE l_glalstus       LIKE glal_t.glalstus       #状态
   DEFINE l_glamseq        LIKE glam_t.glamseq        #项次
   DEFINE l_glac006        LIKE glac_t.glac006        #科目性质
   DEFINE l_glac003        LIKE glac_t.glac003        #统治/明细科目
   DEFINE l_sql            STRING
   DEFINE l_glad007        LIKE glad_t.glad007        #部門管理否
   DEFINE l_glad008        LIKE glad_t.glad008        #利潤成本中心管理
   DEFINE l_glad009        LIKE glad_t.glad009        #區域管理
   DEFINE l_glad010        LIKE glad_t.glad010        #客商管理
   DEFINE l_glad011        LIKE glad_t.glad011        #客群管理否
   DEFINE l_glad012        LIKE glad_t.glad012        #產品類別
   DEFINE l_glad013        LIKE glad_t.glad013        #人員
#   DEFINE l_glad014        LIKE glad_t.glad014        #预算管理否
   DEFINE l_glad015        LIKE glad_t.glad015        #专案管理否
   DEFINE l_glad016        LIKE glad_t.glad016        #wbs管理
   DEFINE l_glad031        LIKE glad_t.glad031        #經營方式管理
   DEFINE l_glad032        LIKE glad_t.glad032        #渠道管理
   DEFINE l_glad033        LIKE glad_t.glad033        #品牌管理
   DEFINE l_glad027        LIKE glad_t.glad027
   DEFINE l_sum1           LIKE glam_t.glam003
   DEFINE l_sum2           LIKE glam_t.glam004
   DEFINE l_sum3           LIKE glam_t.glam044
   DEFINE l_sum4           LIKE glam_t.glam045
   DEFINE l_sum5           LIKE glam_t.glam047
   DEFINE l_sum6           LIKE glam_t.glam048
   DEFINE l_errno          LIKE type_t.chr10
   DEFINE l_errmsg         STRING     #组合报错信息
   DEFINE l_msg            STRING     #组合报错信息
   DEFINE l_msg1           STRING     #组合报错信息
   DEFINE p_str            LIKE type_t.chr10
   DEFINE l_glaa015        LIKE glaa_t.glaa015
   DEFINE l_glaa019        LIKE glaa_t.glaa019
   DEFINE l_glaa004        LIKE glaa_t.glaa004
   DEFINE l_success        LIKE type_t.num5 
   DEFINE l_efin5001       LIKE type_t.chr1
   DEFINE l_ooba002        LIKE ooba_t.ooba002
   DEFINE l_glalcomp       LIKE glal_t.glalcomp
   DEFINE l_glalcrtid      LIKE glal_t.glalcrtid
   DEFINE l_hsx            DYNAMIC ARRAY OF VARCHAR(30) #160729-00009#1 add
   
   LET r_errno = ''
   LET r_success = TRUE
   #初始化数组
   INITIALIZE g_glam.* TO NULL
   #资料检查
   #(1).传入参数为空，返回
   #170816-00007#130 by 09773 mod(S)
#   IF cl_null(p_glalld) OR cl_null(p_glaldocno) THEN
#      LET r_success = FALSE
##      CALL cl_errmsg('conf_chk',p_glaldocno,'','sub-00110',1)
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.extend = p_glaldocno
#      LET g_errparam.code   = 'sub-00110'
#      LET g_errparam.popup  = TRUE 
#      CALL cl_err()
#   END IF
   #170816-00007#130 by 09773 mod(E)
   
   #170816-00007#130 by 09773 add(S)
   #修改錯誤訊息報錯內容
   LET g_msg = ''
   LET g_colname_1 = ''
   LET g_comment_1 = ''
   IF cl_null(p_glalld) THEN
      CALL s_azzi902_get_gzzd("aapi511","lbl_glabld") RETURNING g_colname_1,g_comment_1  #賬套 
      LET g_msg = g_colname_1   
   END IF
   IF cl_null(p_glaldocno) THEN
      LET g_colname_1 = ''
      LET g_comment_1 = ''    
      CALL s_azzi902_get_gzzd("aglt310_07","lbl_glapdocno") RETURNING g_colname_1,g_comment_1   #單號
      IF g_msg IS NULL THEN   
         LET g_msg = g_colname_1   
      ELSE   
         LET g_msg = g_msg,",",g_colname_1
      END IF        
   END IF
   IF NOT cl_null(g_msg) THEN
      LET r_success = FALSE
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaldocno
      LET g_errparam.code = 'sub-00788'  #%1傳入值為空(錯誤)
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_msg 
      CALL cl_err()
   END IF   
   #170816-00007#130 by 09773 add(E)
   
   SELECT glaa004,glaa015,glaa019
     INTO l_glaa004,l_glaa015,l_glaa019
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald = p_glalld
   
   #抓取状态码 
   SELECT glaldocdt,glalstus,glalcomp,glalcrtid
     INTO l_glaldocdt,l_glalstus,l_glalcomp,l_glalcrtid
     FROM glal_t
    WHERE glalent = g_enterprise
      AND glalld = p_glalld
      AND glaldocno = p_glaldocno
   #(2).狀態碼=開立,才可進行確認動作   
   IF l_glalstus <>'N' THEN
      LET r_success = FALSE
#      CALL cl_errmsg('glalstus',p_glaldocno,'','agl-00052',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaldocno
      LET g_errparam.code   = 'agl-00052'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
   END IF 
   
   #2015/05/27--add--str--
   #檢查當單據日期小於等於關帳日期時，不可異動單據
   CALL s_fin_date_close_chk(p_glalld,'','AGL',l_glaldocdt) RETURNING l_success
   IF l_success = FALSE THEN
      LET r_success = FALSE
   END IF
   #2015/05/27--add--end
   
   #根據參數判斷，資料建立者和確認者為同一人才可確認
   #150602-00057#2 by 02291 add
   CALL s_aooi200_fin_get_slip(p_glaldocno) RETURNING l_success,l_ooba002
   CALL s_fin_chk_E5001(p_glalld,l_glalcomp,l_ooba002) RETURNING l_efin5001
   IF l_efin5001 = 'N' THEN
      IF l_glalcrtid = g_user THEN
         LET r_success = FALSE
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'axr-00346'
         LET g_errparam.extend = ''
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
   END IF   
   #150602-00057#2 by 02291 add
   
   #(3).借貸方金額應相等,不可同時為0   
   #170620-00058#1--mod--str--
   IF g_prog MATCHES 'aglt370*' THEN
      CALL s_voucher_glam_sum_chk(p_glalld,p_glaldocno) RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
      END IF
   ELSE
   #170620-00058#1--mod--end
   SELECT SUM(glam003),SUM(glam004)
     INTO l_sum1,l_sum2
     FROM glam_t
    WHERE glament = g_enterprise
      AND glamld = p_glalld
      AND glamdocno = p_glaldocno
#   IF l_sum1 <> l_sum2 THEN #161208-00035#1 mark
#   IF l_sum1 <> l_sum2 AND g_prog <> 'aglt370' THEN #161208-00035#1 add   #170301-00030#8 by 09257 --mark
#   IF l_sum1 <> l_sum2 AND g_prog NOT MATCHES 'aglt370*' THEN #161208-00035#1 add   #170301-00030#8 by 09257 --add    #170620-00058#1 mark
   IF l_sum1 <> l_sum2 AND g_prog NOT MATCHES 'aglt380*' THEN  #170620-00058#1 add
      LET r_success = FALSE
#      CALL cl_errmsg('',p_glaldocno,'','agl-00050',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaldocno
      LET g_errparam.code   = 'agl-00050'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
   END IF 
   
   #------------本位幣二-------------
   IF l_glaa015 = 'Y' THEN 
      SELECT SUM(glam044),SUM(glam045)
        INTO l_sum3,l_sum4
        FROM glam_t
       WHERE glament = g_enterprise
         AND glamld = p_glalld
         AND glamdocno = p_glaldocno
#      IF l_sum3 <> l_sum4 THEN #161208-00035#1 mark
#      IF l_sum3 <> l_sum4 AND g_prog <> 'aglt370' THEN #161208-00035#1 add   #170301-00030#8 by 09257 --mark      
#      IF l_sum3 <> l_sum4 AND g_prog NOT MATCHES 'aglt370*' THEN   #170301-00030#8 by 09257 --add #170620-00058#1 mark
      IF l_sum3 <> l_sum4 AND g_prog NOT MATCHES 'aglt380*' THEN #170620-00058#1 add
         LET r_success = FALSE      
#         CALL cl_errmsg('',p_glaldocno,'','agl-00198',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = p_glaldocno
         LET g_errparam.code   = 'agl-00198'
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      END IF
   END IF
   
   #------------本位幣三-------------
   IF l_glaa019 = 'Y' THEN 
      SELECT SUM(glam047),SUM(glam048)
        INTO l_sum5,l_sum6
        FROM glam_t
       WHERE glament = g_enterprise
         AND glamld = p_glalld
         AND glamdocno = p_glaldocno
#      IF l_sum5 <> l_sum6 THEN #161208-00035#1 mark
#      IF l_sum5 <> l_sum6 AND g_prog <> 'aglt370' THEN #161208-00035#1 add
#      IF l_sum5 <> l_sum6 AND g_prog NOT MATCHES 'aglt370*' THEN #161208-00035#1 add   #170620-00058#1 mark
      IF l_sum5 <> l_sum6 AND g_prog NOT MATCHES 'aglt380*' THEN #170620-00058#1 add
         LET r_success = FALSE
#         CALL cl_errmsg('',p_glaldocno,'','agl-00199',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = p_glaldocno
         LET g_errparam.code   = 'agl-00199'
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      END IF
   END IF
   END IF #170620-00058#1 add
   
　 #(4).有單頭資料但無單身資料返回报错
   LET l_cnt = 0
   #SELECT COUNT(*) INTO l_cnt FROM glam_t           #170615-00061#25 mark
   SELECT COUNT(glamdocno) INTO l_cnt FROM glam_t    #170615-00061#25 add
    WHERE glament = g_enterprise
      AND glamld  = p_glalld
      AND glamdocno = p_glaldocno
   IF l_cnt = 0  THEN
      LET r_success = FALSE
#      CALL cl_errmsg('',p_glaldocno,'','agl-00066',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaldocno
      LET g_errparam.code   = 'agl-00066'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
   END IF 
  
   #151103-00017#1--add--str--
   #(7)当为aglt390时glan_t金额分摊来源档不可以没有资料
#   IF g_prog='aglt390' THEN   #170301-00030#8 by 09257 --mark
   IF g_prog MATCHES 'aglt390*' THEN   #170301-00030#8 by 09257 --add
      LET l_cnt=0
      #SELECT COUNT(*) INTO l_cnt FROM glan_t         #170615-00061#25 mark
      SELECT COUNT(glandocno) INTO l_cnt FROM glan_t  #170615-00061#25 add
       WHERE glanent=g_enterprise AND glanld=p_glalld AND glandocno=p_glaldocno
      IF l_cnt=0 THEN
         LET r_success = FALSE
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = p_glaldocno
         LET g_errparam.code   = 'agl-00386'
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      END IF
   END IF
   #151103-00017#1--add--end
   
　 #(6).单身科目无效，性質不為帳戶,不為明細或獨立帳戶,则返回报错
   #固定核算項的欄位,應檢查若科目有啟用該核算項時,其對應基本資料的合理性 
   LET l_sql = " SELECT glamseq,glam002,glam003,glam004,glam005,glam006,",
               "        glam007,glam008,glam009,glam010,",
               "        glam011,glam012,glam013,glam014,",
               "        glam015,glam017,glam018,",
               "        glam019,glam020,glam021,glam022,",
               "        glam023,glam024,glam025,glam026,",
               "        glam027,glam029,glam030,",
               "        glam031,glam032,glam033,glam034,",
               "        glam035,glam036,glam037,glam038,",
               "        glam039,glam041,glam042,",
               "        glam051,glam052,glam053,",
               "        glam054,glam055,glam056,",
               "        glam057,glam058,glam059 ",
               "   FROM glam_t ",
               #"  WHERE glament = '",g_enterprise,"'", #170615-00061#25 mark
               "  WHERE glament = ",g_enterprise," ",   #170615-00061#25 add
               "    AND glamld = '",p_glalld,"'",
               "    AND glamdocno = '",p_glaldocno,"'"
   PREPARE s_voucher_pre2 FROM l_sql
   DECLARE s_voucher_cur2 CURSOR FOR s_voucher_pre2
   FOREACH s_voucher_cur2 INTO g_glam.glamseq,g_glam.glam002,g_glam.glam003,g_glam.glam004,
                               g_glam.glam005,g_glam.glam006,
                               g_glam.glam007,g_glam.glam008,g_glam.glam009,g_glam.glam010,
                               g_glam.glam011,g_glam.glam012,g_glam.glam013,g_glam.glam014,
                               g_glam.glam015,g_glam.glam017,g_glam.glam018, 
                               g_glam.glam019,g_glam.glam020,g_glam.glam021,g_glam.glam022,
                               g_glam.glam023,g_glam.glam024,g_glam.glam025,g_glam.glam026,
                               g_glam.glam027,g_glam.glam029,g_glam.glam030,
                               g_glam.glam031,g_glam.glam032,g_glam.glam033,g_glam.glam034,
                               g_glam.glam035,g_glam.glam036,g_glam.glam037,g_glam.glam038,  
                               g_glam.glam039,g_glam.glam041,g_glam.glam042,
                               g_glam.glam051,g_glam.glam052,g_glam.glam053,
                               g_glam.glam054,g_glam.glam055,g_glam.glam056,
                               g_glam.glam057,g_glam.glam058,g_glam.glam059
                               
       IF SQLCA.sqlcode THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code = SQLCA.sqlcode
          LET g_errparam.extend = 'foreach:'
          LET g_errparam.popup = TRUE
          CALL cl_err()

          EXIT FOREACH
       END IF
       
       #组合报错信息
       LET l_msg = p_glaldocno||'/'||g_glam.glamseq
       LET l_msg1 = p_glaldocno||'/'||g_glam.glamseq||'/'||g_glam.glam002
       #借貸金額不可同時為0
#       IF g_prog <> 'aglt380' THEN #160919-00060#1 add   #170301-00030#8 by 09257 --mark
       IF g_prog NOT MATCHES 'aglt380*' THEN   #170301-00030#8 by 09257 --add
       IF g_glam.glam003 = 0 AND g_glam.glam004 = 0 THEN 
          LET r_success = FALSE
#          CALL cl_errmsg('',l_errmsg,g_glam.glam002,'agl-00084',1)
          INITIALIZE g_errparam TO NULL
          LET g_errparam.extend = l_msg
          LET g_errparam.code = 'agl-00084'
          LET g_errparam.popup = TRUE
          CALL cl_err()
       END IF 
       END IF #160919-00060#1 add
       #科目
       IF NOT cl_null(g_glam.glam002) THEN
#          CALL s_voucher_glam002_chk(p_glalld,g_glam.glam002)  #151117-00009#1 mark
          CALL s_voucher_glaq002_chk(p_glalld,g_glam.glam002)   #151117-00009#1 add
          IF NOT cl_null(g_errno) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glam002',l_errmsg,g_glam.glam002,g_errno,1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code = g_errno
             #160321-00016#19 --s add
             LET g_errparam.replace[1] = 'agli030'
             LET g_errparam.replace[2] = cl_get_progname('agli030',g_lang,"2")
             LET g_errparam.exeprog = 'agli030'
             #160321-00016#19 --e add
             LET g_errparam.popup = TRUE
             CALL cl_err()
          END IF 
       END IF
       #营运据点检查   
       IF NOT cl_null(g_glam.glam007) THEN 
          CALL s_voucher_glam007_chk(g_glam.glam007)
          IF NOT cl_null(g_errno) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glam007',l_errmsg,g_glam.glam007,g_errno,1)
             LET l_errmsg = l_msg||'/'||g_glam.glam007
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_errmsg
             #160321-00016#19 --s add
             LET g_errparam.replace[1] = 'aooi100'
             LET g_errparam.replace[2] = cl_get_progname('aooi100',g_lang,"2")
             LET g_errparam.exeprog = 'aooi100'
             #160321-00016#19 --e add
             LET g_errparam.code = g_errno
             LET g_errparam.popup = TRUE
             CALL cl_err()
          END IF 
       ELSE
          LET r_success = FALSE
#          CALL cl_errmsg('glam007',l_errmsg,g_glam.glam007,'agl-00291',1)
          INITIALIZE g_errparam TO NULL
          LET g_errparam.extend = l_msg1
          LET g_errparam.code = 'agl-00291'
          LET g_errparam.popup = TRUE
          CALL cl_err()
       END IF
       ################################################################################################
       #aglt390不需检查此项--mod by mpp
#       IF p_str<>'aglt390'  THEN  #151103-00017#1
          #依據帳別，科目編號，判斷該科目是否启用
          #部門管理， 利潤成本中心管理，區域管理，客商管理，客群管理，產品類別，人員，預算，專案，wbs管理
          #1.清空核算项管理值
          LET l_glad007 = ''  LET l_glad008 = ''  LET l_glad009 = ''  LET l_glad010 = ''  LET l_glad011 = ''
          LET l_glad012 = ''  LET l_glad013 = ''  LET l_glad015 = ''  LET l_glad016 = ''  LET l_glad031 = ''
          LET l_glad032 = ''  LET l_glad033 = ''  LET l_glad027 = ''
          #2.重新依账套，科目抓取核算项管理值
#          SELECT glad007,glad008,glad009,glad010,glad011,glad012,glad013,glad014,glad015,glad016          
#            INTO l_glad007,l_glad008,l_glad009,l_glad010,l_glad011,l_glad012,l_glad013,l_glad014,l_glad015,l_glad016
#            FROM glad_t
#          WHERE gladent = g_enterprise
#            AND gladld = p_glalld
#            AND glad001 = g_glam.glam002
           
          CALL s_voucher_fix_acc_open_chk(p_glalld,g_glam.glam002)
          RETURNING l_glad007,l_glad008,l_glad009,l_glad010,l_glad027,l_glad011,l_glad012,l_glad013,l_glad015,l_glad016,l_glad031,l_glad032,l_glad033
          #======================================
          #固定核算项检查
          #如果启用改固定核算项勾选，则对该核算项的值进行检查
          #======================================  
          #該科目做部門管理時，部門不可空白  
          IF l_glad007 = 'Y' THEN
             IF cl_null(g_glam.glam008) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glam008',l_errmsg,'','agl-00043',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'agl-00043'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             ELSE
                #部门检查          
                CALL s_department_chk(g_glam.glam008,l_glaldocdt) RETURNING l_success 
                IF NOT l_success THEN
                   LET r_success = FALSE
#                   CALL cl_errmsg('glam008',l_errmsg,'',g_errno,1)
#                   LET l_errmsg = l_msg||'/'||g_glam.glam008
#                   INITIALIZE g_errparam TO NULL
#                   LET g_errparam.extend = l_errmsg
#                   LET g_errparam.code = g_errno
#                   LET g_errparam.popup = TRUE
#                   CALL cl_err()
                END IF  
             END IF             
          END IF
         
          #該科目做利潤成本管理時，利潤成本不可空白  
          IF l_glad008 = 'Y' THEN
             IF cl_null(g_glam.glam009) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glam009',l_errmsg,'','agl-00044',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'agl-00044'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             ELSE
                #利润成本中心检查  
                CALL s_voucher_glaq019_chk(g_glam.glam009,l_glaldocdt)
                IF NOT cl_null(g_errno) THEN
                   LET r_success = FALSE
#                   CALL cl_errmsg('glam009',l_errmsg,'',g_errno,1)
                   LET l_errmsg = l_msg||'/'||g_glam.glam009
                   INITIALIZE g_errparam TO NULL
                   LET g_errparam.extend = l_errmsg
                   LET g_errparam.code = g_errno
                   #160321-00016#19 --s add
                   LET g_errparam.replace[1] = 'aooi125'
                   LET g_errparam.replace[2] = cl_get_progname('aooi125',g_lang,"2")
                   LET g_errparam.exeprog = 'aooi125'
                   #160321-00016#19 --e add
                   LET g_errparam.popup = TRUE
                   CALL cl_err()
                END IF 
             END IF             
          END IF 
          
          #該科目做區域管理時，區域不可空白  
          IF l_glad009 = 'Y' THEN
             IF cl_null(g_glam.glam010) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glam010',l_errmsg,'','agl-00045',1) 
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'agl-00045'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             ELSE
                #区域检查  
                CALL s_azzi650_chk_exist('287',g_glam.glam010) RETURNING l_success
                IF NOT l_success THEN
                   LET r_success = FALSE
#                   CALL cl_errmsg('glam010',l_errmsg,'',g_errno,1)
#                   LET l_errmsg = l_msg||'/'||g_glam.glam010
#                   INITIALIZE g_errparam TO NULL
#                   LET g_errparam.extend = l_errmsg
#                   LET g_errparam.code = g_errno
#                   LET g_errparam.popup = TRUE
#                   CALL cl_err()
                END IF  
             END IF             
          END IF 
          
          #該科目做客商管理時，客商不可空白  
          IF l_glad010 = 'Y' THEN
             IF cl_null(g_glam.glam011) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glam011',l_errmsg,'','agl-00046',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'agl-00046'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             ELSE
                #客商检查 
                CALL s_voucher_glaq021_chk(g_glam.glam011)
                IF NOT cl_null(g_errno) THEN
                   LET r_success = FALSE
#                   CALL cl_errmsg('glam011',l_errmsg,'',g_errno,1)
                   LET l_errmsg = l_msg||'/'||g_glam.glam011
                   INITIALIZE g_errparam TO NULL
                   LET g_errparam.extend = l_errmsg
                   LET g_errparam.code = g_errno
                   #160321-00016#19 --s add
                   LET g_errparam.replace[1] = 'apmm100'
                   LET g_errparam.replace[2] = cl_get_progname('apmm100',g_lang,"2")
                   LET g_errparam.exeprog = 'apmm100'
                   #160321-00016#19 --e add
                   LET g_errparam.popup = TRUE
                   CALL cl_err()
                END IF
             END IF
          END IF 
          
          #該科目做账款客商管理時，客商不可空白
          IF l_glad027 = 'Y'  THEN
             IF cl_null(g_glam.glam012) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glam012',l_errmsg,'','axr-00215',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'axr-00215'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             ELSE
                #客商检查
                CALL s_voucher_glaq021_chk(g_glam.glam012)
                IF NOT cl_null(g_errno) THEN
                   LET r_success = FALSE
#                   CALL cl_errmsg('glam012',l_errmsg,'',g_errno,1)
                   LET l_errmsg = l_msg||'/'||g_glam.glam012
                   INITIALIZE g_errparam TO NULL
                   LET g_errparam.extend = l_errmsg
                   LET g_errparam.code = g_errno
                   #160321-00016#19 --s add
                   LET g_errparam.replace[1] = 'apmm100'
                   LET g_errparam.replace[2] = cl_get_progname('apmm100',g_lang,"2")
                   LET g_errparam.exeprog = 'apmm100'
                   #160321-00016#19 --e add
                   LET g_errparam.popup = TRUE
                   CALL cl_err()
                END IF 
             END IF
          END IF 
          
          #該科目做客群管理時，客群不可空白  
          IF l_glad011 = 'Y' THEN
             IF cl_null(g_glam.glam013) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glam013',l_errmsg,'','agl-00047',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'agl-00047'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             ELSE
                #区域检查 
                CALL s_azzi650_chk_exist('281',g_glam.glam013) RETURNING l_success
                IF NOT l_success THEN
                   LET r_success = FALSE
#                   CALL cl_errmsg('glam013',l_errmsg,'',g_errno,1)
#                   LET l_errmsg = l_msg||'/'||g_glam.glam013
#                   INITIALIZE g_errparam TO NULL
#                   LET g_errparam.extend = l_errmsg
#                   LET g_errparam.code = g_errno
#                   LET g_errparam.popup = TRUE
#                   CALL cl_err()
                END IF
             END IF             
          END IF 
          
          #該科目做產品分類管理時，不可空白  
          IF l_glad012 = 'Y' THEN
             IF cl_null(g_glam.glam014) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glam014',l_errmsg,'','agl-00068',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'agl-00068'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             ELSE
                #产品分类检查 
                CALL s_voucher_glaq024_chk(g_glam.glam014)
                IF NOT cl_null(g_errno) THEN
                   LET r_success = FALSE
#                   CALL cl_errmsg('glam014',l_errmsg,'',g_errno,1)
                   LET l_errmsg = l_msg||'/'||g_glam.glam014
                   INITIALIZE g_errparam TO NULL
                   LET g_errparam.extend = l_errmsg
                   LET g_errparam.code = g_errno
                   #160321-00016#19 --s add
                   LET g_errparam.replace[1] = 'arti202'
                   LET g_errparam.replace[2] = cl_get_progname('arti202',g_lang,"2")
                   LET g_errparam.exeprog = 'arti202'
                   #160321-00016#19 --e add
                   LET g_errparam.popup = TRUE
                   CALL cl_err()
                END IF 
             END IF             
          END IF

          #該科目做經營方式管理時，經營方式不可空白  
          IF l_glad031 = 'Y' THEN
             IF cl_null(g_glam.glam051) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glam051',l_errmsg,'','agl-00286',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'agl-00286'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             ELSE
                #經營方式检查
                CALL s_voucher_glaq051_chk(g_glam.glam051)
                IF NOT cl_null(g_errno) THEN
                   LET r_success = FALSE
#                   CALL cl_errmsg('glam051',l_errmsg,'',g_errno,1)
                   LET l_errmsg = l_msg||'/'||g_glam.glam051
                   INITIALIZE g_errparam TO NULL
                   LET g_errparam.extend = l_errmsg
                   LET g_errparam.code = g_errno
                   LET g_errparam.popup = TRUE
                   CALL cl_err()
                END IF
             END IF             
          END IF 
          
          #該科目做渠道管理時，渠道不可空白  
          IF l_glad032 = 'Y' THEN
             IF cl_null(g_glam.glam052) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glam052',l_errmsg,'','agl-00287',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'agl-00287'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             ELSE
                #渠道检查
                CALL s_voucher_glaq052_chk(g_glam.glam052)
                IF NOT cl_null(g_errno) THEN
                   LET r_success = FALSE
#                   CALL cl_errmsg('glam052',l_errmsg,'',g_errno,1)
                   LET l_errmsg = l_msg||'/'||g_glam.glam052
                   INITIALIZE g_errparam TO NULL
                   LET g_errparam.extend = l_errmsg
                   LET g_errparam.code = g_errno
                   LET g_errparam.popup = TRUE
                   CALL cl_err()
                END IF
             END IF             
          END IF 
         
          #該科目做品牌管理時，品牌不可空白  
          IF l_glad033 = 'Y' THEN
             IF cl_null(g_glam.glam053) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glam053',l_errmsg,'','agl-00288',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'agl-00288'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             ELSE
                #品牌检查
                CALL s_azzi650_chk_exist('2002',g_glam.glam053) RETURNING l_success
                IF NOT l_success THEN
                   LET r_success = FALSE
#                   CALL cl_errmsg('glam053',l_errmsg,'',g_errno,1)
#                   LET l_errmsg = l_msg||'/'||g_glam.glam053
#                   INITIALIZE g_errparam TO NULL
#                   LET g_errparam.extend = l_errmsg
#                   LET g_errparam.code = g_errno
#                   LET g_errparam.popup = TRUE
#                   CALL cl_err()
                END IF
             END IF             
          END IF 
          
          #該科目做人員管理時，不可空白  
          IF l_glad013 = 'Y' THEN
             IF cl_null(g_glam.glam015) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glam015',l_errmsg,'','agl-00069',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'agl-00069'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             ELSE
                #人员检查
                CALL s_employee_chk(g_glam.glam015) RETURNING l_success
                IF NOT l_success THEN
                   LET r_success = FALSE
#                   CALL cl_errmsg('glam015',l_errmsg,'',g_errno,1)
#                   LET l_errmsg = l_msg||'/'||g_glam.glam015
#                   INITIALIZE g_errparam TO NULL
#                   LET g_errparam.extend = l_errmsg
#                   LET g_errparam.code = g_errno
#                   LET g_errparam.popup = TRUE
#                   CALL cl_err()
                END IF 
             END IF             
          END IF 
          
#          #該科目做預算管理時，不可空白  
#          IF l_glad014 = 'Y' THEN
#             IF cl_null(g_glam.glam016) THEN
#                LET r_success = FALSE
#                CALL cl_errmsg('glam016',l_errmsg,'','agl-00070',1)
#             END IF
#             #预算检查
#             IF NOT cl_null(g_glam.glam016) THEN
#                CALL s_voucher_glam016_chk(g_glam.glam016)
#                IF NOT cl_null(g_errno) THEN
#                   LET r_success = FALSE
#                   CALL cl_errmsg('glam016',l_errmsg,'',g_errno,1)
#                END IF 
#             END IF             
#          END IF
          
          #該科目做專案管理時，不可空白  
          IF l_glad015 = 'Y' THEN
             IF cl_null(g_glam.glam017) THEN
                #LET r_success = FALSE             #170111-00005#1 mark
#                CALL cl_errmsg('glam017',l_errmsg,'','agl-00071',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                #LET g_errparam.code = 'agl-00071' #170111-00005#1 mark
                LET g_errparam.code = 'agl-00541'  #170111-00005#1 add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             ELSE
                CALL s_aap_project_chk(g_glam.glam017) RETURNING l_success,g_errno
                IF NOT l_success THEN
                   LET r_success = FALSE
                   LET l_errmsg = l_msg||'/'||g_glam.glam017
                   INITIALIZE g_errparam TO NULL
                   LET g_errparam.code = g_errno
                   LET g_errparam.extend = l_errmsg
                   #160321-00016#19 --s add
                   LET g_errparam.replace[1] = 'apjm200'
                   LET g_errparam.replace[2] = cl_get_progname('apjm200',g_lang,"2")
                   LET g_errparam.exeprog = 'apjm200'
                   #160321-00016#19 --e add
                   LET g_errparam.popup = TRUE
                   CALL cl_err()
                END IF
             END IF
          END IF 
          
          #該科目做WBS管理時，不可空白  
          IF l_glad016 = 'Y' THEN
             IF cl_null(g_glam.glam018) THEN
                #LET r_success = FALSE             #170111-00005#1 mark
#                CALL cl_errmsg('glam018',l_errmsg,'','agl-00072',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                #LET g_errparam.code = 'agl-00072' #170111-00005#1 mark
                LET g_errparam.code = 'agl-00542'  #170111-00005#1 add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             ELSE
                CALL s_voucher_glaq028_chk(g_glam.glam017,g_glam.glam018) 
                IF NOT cl_null(g_errno) THEN
                   LET r_success = FALSE
                   LET l_errmsg = l_msg||'/'||g_glam.glam018
                   INITIALIZE g_errparam TO NULL
                   LET g_errparam.code = g_errno
                   LET g_errparam.extend = l_errmsg
                   LET g_errparam.popup = TRUE
                   CALL cl_err()
                END IF
             END IF 
          END IF
          
          #160729-00009#1--add--str--
          #对14个固定核算项进行检核是否满足agli060的设限条件
          LET l_hsx[1]=g_glam.glam007
          LET l_hsx[2]=g_glam.glam008
          LET l_hsx[3]=g_glam.glam009
          LET l_hsx[4]=g_glam.glam010
          LET l_hsx[5]=g_glam.glam011
          LET l_hsx[6]=g_glam.glam012
          LET l_hsx[7]=g_glam.glam013
          LET l_hsx[8]=g_glam.glam014
          LET l_hsx[9]=g_glam.glam051
          LET l_hsx[10]=g_glam.glam052
          LET l_hsx[11]=g_glam.glam053
          LET l_hsx[12]=g_glam.glam015
          LET l_hsx[13]=g_glam.glam017
          LET l_hsx[14]=g_glam.glam018
          CALL s_voucher_all_hsx_chk(p_glalld,g_glam.glam002,l_hsx) RETURNING l_success
          IF l_success = FALSE THEN
             LET r_success = FALSE
          END IF
          #160729-00009#1--add--end
          
#       END IF    #151103-00017#1 mark
       IF p_str = 'aglt380' THEN 
          IF cl_null(g_glam.glam005) AND cl_null(g_glam.glam006) THEN 
             LET r_success = FALSE
#             CALL cl_errmsg('',l_errmsg,'','agl-00157',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code = 'agl-00157'
             LET g_errparam.popup = TRUE
             CALL cl_err()
          END IF 
          IF NOT cl_null(g_glam.glam005) AND cl_null(g_glam.glam006) THEN 
#             CALL s_voucher_glam002_chk(p_glalld,g_glam.glam005)   #151117-00009#1 mark
             CALL s_voucher_glaq002_chk(p_glalld,g_glam.glam005)    #151117-00009#1 add
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glam005',l_errmsg,g_glam.glam005,g_errno,1)
                LET l_errmsg = l_msg||'/'||g_glam.glam005
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code = g_errno
                #160321-00016#19 --s add
                LET g_errparam.replace[1] = 'agli030'
                LET g_errparam.replace[2] = cl_get_progname('agli030',g_lang,"2")
                LET g_errparam.exeprog = 'agli030'
                #160321-00016#19 --e add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF 
             CALL s_voucher_forzen_glam005_chk(p_glalld,p_glaldocno,g_glam.glam005,l_glaldocdt,r_success)
             RETURNING r_success
             #160729-00009#1--add--str--
             #对14个固定核算项进行检核是否满足agli060的设限条件
             LET l_hsx[1]=g_glam.glam019
             LET l_hsx[2]=g_glam.glam020
             LET l_hsx[3]=g_glam.glam021
             LET l_hsx[4]=g_glam.glam022
             LET l_hsx[5]=g_glam.glam023
             LET l_hsx[6]=g_glam.glam024
             LET l_hsx[7]=g_glam.glam025
             LET l_hsx[8]=g_glam.glam026
             LET l_hsx[9]=g_glam.glam054
             LET l_hsx[10]=g_glam.glam055
             LET l_hsx[11]=g_glam.glam056
             LET l_hsx[12]=g_glam.glam027
             LET l_hsx[13]=g_glam.glam029
             LET l_hsx[14]=g_glam.glam030
             CALL s_voucher_all_hsx_chk(p_glalld,g_glam.glam005,l_hsx) RETURNING l_success
             IF l_success = FALSE THEN
                LET r_success = FALSE
             END IF
             #160729-00009#1--add--end
          END IF 
          IF cl_null(g_glam.glam005) AND NOT cl_null(g_glam.glam006) THEN 
#             CALL s_voucher_glam002_chk(p_glalld,g_glam.glam006)   #151117-00009#1 mark
             CALL s_voucher_glaq002_chk(p_glalld,g_glam.glam006)    #151117-00009#1 add
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glam006',l_errmsg,g_glam.glam006,g_errno,1)
                LET l_errmsg = l_msg||'/'||g_glam.glam006
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code = g_errno
                #160321-00016#19 --s add
                LET g_errparam.replace[1] = 'agli030'
                LET g_errparam.replace[2] = cl_get_progname('agli030',g_lang,"2")
                LET g_errparam.exeprog = 'agli030'
                #160321-00016#19 --e add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF
             CALL s_voucher_forzen_glam006_chk(p_glalld,p_glaldocno,g_glam.glam006,l_glaldocdt,r_success)
             RETURNING r_success
             #160729-00009#1--add--str--
             #对14个固定核算项进行检核是否满足agli060的设限条件
             LET l_hsx[1]=g_glam.glam031
             LET l_hsx[2]=g_glam.glam032
             LET l_hsx[3]=g_glam.glam033
             LET l_hsx[4]=g_glam.glam034
             LET l_hsx[5]=g_glam.glam035
             LET l_hsx[6]=g_glam.glam036
             LET l_hsx[7]=g_glam.glam037
             LET l_hsx[8]=g_glam.glam038
             LET l_hsx[9]=g_glam.glam057
             LET l_hsx[10]=g_glam.glam058
             LET l_hsx[11]=g_glam.glam059
             LET l_hsx[12]=g_glam.glam039
             LET l_hsx[13]=g_glam.glam041
             LET l_hsx[14]=g_glam.glam042
             CALL s_voucher_all_hsx_chk(p_glalld,g_glam.glam005,l_hsx) RETURNING l_success
             IF l_success = FALSE THEN
                LET r_success = FALSE
             END IF
             #160729-00009#1--add--end
          END IF 
       END IF 
       
   END FOREACH
   
   #151103-00017#1--add--str--
   #(8)当为aglt390时，检查glan_t金额分摊来源档中维护的资料
#   IF g_prog='aglt390' THEN   #170301-00030#8 by 09257 --mark
   IF g_prog MATCHES 'aglt390*' THEN   #170301-00030#8 by 09257 --add  
      CALL s_voucher_glan_chk(p_glalld,p_glaldocno,l_glaldocdt) RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
      END IF
   END IF
   #151103-00017#1--add--end
   
   RETURN r_success
# 常用传票单身科目检查
END FUNCTION

PUBLIC FUNCTION s_voucher_glam002_chk(p_glalld,p_glam002)
   DEFINE p_glalld     LIKE glal_t.glalld
   DEFINE p_glam002    LIKE glam_t.glam002
   DEFINE l_glac006    LIKE glac_t.glac006
   DEFINE l_glac003    LIKE glac_t.glac003
   DEFINE l_glacstus   LIKE glac_t.glacstus
  
   LET g_errno = ''
   LET l_glac003 = ''
   LET l_glac006 = ''
   LET l_glacstus = ''
   SELECT glacstus,glac003,glac006 INTO l_glacstus,l_glac003,l_glac006 FROM glac_t
    WHERE glacent = g_enterprise
      AND glac001 = (SELECT glaa004 FROM glaa_t WHERE glaaent = g_enterprise
                        AND glaald = p_glalld)   #会计科目参照表
      AND glac002 = p_glam002
       
   CASE
      WHEN SQLCA.SQLCODE = 100   LET g_errno = 'agl-00011'
      #WHEN l_glacstus = 'N'      LET g_errno = 'agl-00012'  #160321-00016#19 mark
      WHEN l_glacstus = 'N'      LET g_errno = 'sub-01302'   #160321-00016#19 add
      WHEN l_glac003 = '1'       LET g_errno = 'agl-00013'  #必须为非统治类科目
      WHEN l_glac006 <>'1'       LET g_errno = 'agl-00030'  #须为账户性质   
   END CASE   
# 營運據點檢查
END FUNCTION

PUBLIC FUNCTION s_voucher_glam007_chk(p_glam007)
   DEFINE p_glam007      LIKE glam_t.glam007
   DEFINE l_ooefstus     LIKE ooef_t.ooefstus
   
   LET g_errno = ''
   
   SELECT ooefstus INTO l_ooefstus FROM ooef_t
    WHERE ooefent = g_enterprise
      AND ooef001 = p_glam007
      
   CASE
      WHEN SQLCA.SQLCODE = 100    LET g_errno = 'aoo-00088'
      #WHEN l_ooefstus = 'N'       LET g_errno = 'aoo-00089' #160321-00016#19 mark
      WHEN l_ooefstus = 'N'       LET g_errno = 'sub-01302'  #160321-00016#19 add
   END CASE
# 部門/成本利潤中心檢查
END FUNCTION

PUBLIC FUNCTION s_voucher_glam008_chk(p_glam008,p_glaldocdt)
   DEFINE l_ooegstus     LIKE ooeg_t.ooegstus
   DEFINE p_glam008      LIKE glam_t.glam008
   DEFINE p_glaldocdt    LIKE glal_t.glaldocdt    #传票日期
   LET g_errno = ''
   
   SELECT ooegstus INTO l_ooegstus FROM ooeg_t
    WHERE ooegent = g_enterprise
      AND ooeg001 = p_glam008
      AND ooeg006 <= p_glaldocdt
      AND (ooeg007 IS NULL OR ooeg007 >= p_glaldocdt ) 
   CASE
      WHEN SQLCA.SQLCODE = 100    LET g_errno = 'abm-00006'
     #WHEN l_ooegstus = 'N'       LET g_errno = 'abm-00007'   #160321-00016#19 mark
      WHEN l_ooegstus = 'N'       LET g_errno = 'sub-01302'   #160321-00016#19 
   END CASE
# 區域客群檢查
END FUNCTION

PUBLIC FUNCTION s_voucher_glam010_chk(p_oocq001,p_oocq002)
   DEFINE p_oocq001    LIKE oocq_t.oocq001
   DEFINE p_oocq002    LIKE oocq_t.oocq002
   DEFINE l_oocqstus   LIKE oocq_t.oocqstus

   LET g_errno = ''
   SELECT oocqstus INTO l_oocqstus FROM oocq_t
    WHERE oocqent = g_enterprise
      AND oocq001 = p_oocq001
      AND oocq002 = p_oocq002
   CASE
     WHEN SQLCA.SQLCODE = 100
        IF p_oocq001 = '287' THEN
          #LET g_errno = 'apm-00092'  #160321-00016#19  mark
           LET g_errno = 'sub-01303'  #160321-00016#19 
        ELSE
           LET g_errno = 'axm-00003'
        END IF

     WHEN l_oocqstus = 'N'
        IF p_oocq001 = '287' THEN
          #LET g_errno = 'apm-00093'  #160321-00016#19 mark
           LET g_errno = 'sub-01302'  #160321-00016#19 
        ELSE
          #LET g_errno = 'axm-00004'  #160321-00016#19 mark
           LET g_errno = 'sub-01302'  #160321-00016#19 
        END IF
   END CASE
# 客商檢查
END FUNCTION

PUBLIC FUNCTION s_voucher_glam011_chk(p_pmaa001)
   DEFINE p_pmaa002     LIKE pmaa_t.pmaa002
   DEFINE p_pmaa001     LIKE pmaa_t.pmaa001
   DEFINE l_pmaastus    LIKE pmaa_t.pmaastus

   LET g_errno = ''
   SELECT pmaastus INTO l_pmaastus FROM pmaa_t
    WHERE pmaaent = g_enterprise
      AND pmaa001 = p_pmaa001

   CASE
      WHEN SQLCA.SQLCODE = 100   LET g_errno = 'apm-00028' 
      #WHEN l_pmaastus = 'N'      LET g_errno = 'apm-00029' #160321-00016#19 mark
      WHEN l_pmaastus = 'N'      LET g_errno = 'sub-01302'  #160321-00016#19 add
   END CASE
# 產品分類檢查
END FUNCTION

PUBLIC FUNCTION s_voucher_glam014_chk(p_glaq024)
   DEFINE p_glaq024   LIKE glaq_t.glaq024
   DEFINE l_rtaxstus  LIKE rtax_t.rtaxstus

   LET g_errno = ''
   SELECT rtaxstus INTO l_rtaxstus FROM rtax_t
    WHERE rtaxent = g_enterprise
      AND rtax001 = p_glaq024
 
   CASE
      WHEN SQLCA.SQLCODE = 100   LET g_errno = 'aoo-00137'
      #WHEN l_rtaxstus = 'N'      LET g_errno = 'aoo-00138' #160321-00016#19 mark
      WHEN l_rtaxstus = 'N'      LET g_errno = 'sub-01302'  #160321-00016#19 add
   END CASE
# 人員檢查
END FUNCTION

PUBLIC FUNCTION s_voucher_glam015_chk(p_glaq013)
   DEFINE p_glaq013    LIKE glaq_t.glaq013 
   DEFINE l_ooagstus   LIKE ooag_t.ooagstus


   LET g_errno=''
   SELECT ooagstus INTO l_ooagstus FROM ooag_t
    WHERE ooagent = g_enterprise
      AND ooag001 = p_glaq013

   CASE
      WHEN SQLCA.SQLCODE=100   LET g_errno = 'aoo-00074'
      #WHEN l_ooagstus ='N'     LET g_errno = 'aoo-00071' #160321-00016#19 mark
      WHEN l_ooagstus ='N'     LET g_errno = 'sub-01302'  #160321-00016#19 add
   END CASE
# 預算編號檢查
END FUNCTION

PUBLIC FUNCTION s_voucher_glam016_chk(p_glaq026)
   DEFINE p_glaq026     LIKE glaq_t.glaq026
   DEFINE l_bgaastus    LIKE bgaa_t.bgaastus
    
   LET g_errno = ''
   SELECT bgaastus INTO l_bgaastus FROM bgaa_t
    WHERE bgaaent = g_enterprise
      AND bgaa001 = p_glaq026

   CASE
      WHEN SQLCA.SQLCODE = 100   LET g_errno = 'abg-00007'
      #WHEN l_bgaastus = 'N'      LET g_errno = 'abg-00008' #160321-00016#19 mark
      WHEN l_bgaastus = 'N'      LET g_errno = 'sub-01302'  #160321-00016#19 add
   END CASE
# 審核數據庫更新
END FUNCTION

PUBLIC FUNCTION s_voucher_conf_upd_glam(p_glalld,p_glaldocno)
   DEFINE p_glalld         LIKE glal_t.glalld         #帐别
   DEFINE p_glaldocno      LIKE glal_t.glaldocno      #傳票編號
   DEFINE r_success        LIKE type_t.num5
   DEFINE r_errno          LIKE type_t.chr80
   DEFINE l_today          DATETIME YEAR TO SECOND
   
   WHENEVER ERROR CONTINUE

   LET r_success  = TRUE
   LET r_errno = ''
   LET l_today  = cl_get_current()
   #检查完毕，更新狀態碼=已確認,確認人=登入user,確認日期=g_today
   UPDATE glal_t SET glalstus = 'Y',
                     glalcnfid = g_user,
                     glalcnfdt = l_today
               WHERE glalent = g_enterprise
                 AND glalld = p_glalld
                 AND glaldocno = p_glaldocno
    IF SQLCA.SQLCODE THEN
       LET r_success = FALSE
#       CALL cl_errmsg('glalstus',p_glaldocno,'Y',sqlca.sqlcode,1)
       INITIALIZE g_errparam TO NULL
       LET g_errparam.extend = p_glaldocno
       LET g_errparam.code = sqlca.sqlcode
       LET g_errparam.popup = TRUE
       CALL cl_err()
    END IF 
    RETURN r_success
################################################################################
END FUNCTION
#功能目的：常用傳票取消確認
#注意事項：無
#關鍵詞：總帳、分攤編號、取消確認
#同義詞：总账、分摊编号、取消确认
#參數值：1.帳別 
#　　　　2.分攤編號
#回傳值：1.檢核狀態 
#　　　　2.錯誤訊息
################################################################################
PUBLIC FUNCTION s_voucher_unconf_chk_glam(p_glalld,p_glaldocno)
   DEFINE p_glalld           LIKE glal_t.glalld              #帐别
   DEFINE p_glaldocno        LIKE glal_t.glaldocno           #传票编号
   DEFINE r_success          LIKE type_t.num5                #檢核狀態
   DEFINE r_errno            LIKE type_t.chr80               #錯誤訊息
   DEFINE l_glalstus         LIKE glal_t.glalstus            #状态码
   DEFINE l_glaldocdt        LIKE glal_t.glaldocdt
   DEFINE l_success          LIKE type_t.num5
   
   LET r_errno = ''
   LET r_success = TRUE
   #资料检查
   #(1).传入参数为空，返回
   #170816-00007#130 by 09773 mod(S)
#   IF cl_null(p_glalld) OR cl_null(p_glaldocno) THEN
##      CALL cl_errmsg('unconf',p_glaldocno,'','sub-00110',1)
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.extend = p_glaldocno
#      LET g_errparam.code = 'sub-00110'
#      LET g_errparam.popup = TRUE
#      CALL cl_err()
#      LET r_success = FALSE
#   END IF
   #170816-00007#130 by 09773 mod(E)
   
   #170816-00007#130 by 09773 add(S)
   #修改錯誤訊息報錯內容
   LET g_msg = ''
   LET g_colname_1 = ''
   LET g_comment_1 = ''
   IF cl_null(p_glalld) THEN
      CALL s_azzi902_get_gzzd("aapi511","lbl_glabld") RETURNING g_colname_1,g_comment_1  #賬套 
      LET g_msg = g_colname_1   
   END IF
   IF cl_null(p_glaldocno) THEN
      LET g_colname_1 = ''
      LET g_comment_1 = ''    
      CALL s_azzi902_get_gzzd("aglt310_07","lbl_glapdocno") RETURNING g_colname_1,g_comment_1   #單號
      IF g_msg IS NULL THEN   
         LET g_msg = g_colname_1   
      ELSE   
         LET g_msg = g_msg,",",g_colname_1
      END IF        
   END IF
   IF NOT cl_null(g_msg) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaldocno
      LET g_errparam.code = 'sub-00788'  #%1傳入值為空(錯誤)
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_msg 
      CALL cl_err()
      LET r_success = FALSE
   END IF   
   #170816-00007#130 by 09773 add(E)
   
   #(2).狀態碼=确认,才可進行確認動作
   SELECT glalstus,glaldocdt INTO l_glalstus,l_glaldocdt
     FROM glal_t
    WHERE glalent = g_enterprise
      AND glalld = p_glalld
      AND glaldocno = p_glaldocno
   IF l_glalstus <>'Y' THEN
#      CALL cl_errmsg('unconf',p_glaldocno,'','agl-00053',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaldocno
      LET g_errparam.code = 'agl-00053'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF 
   
   #2015/05/27--add--str--
   #檢查當單據日期小於等於關帳日期時，不可異動單據
   CALL s_fin_date_close_chk(p_glalld,'','AGL',l_glaldocdt) RETURNING l_success
   IF l_success = FALSE THEN
      LET r_success = FALSE
   END IF
   #2015/05/27--add--end
   
   RETURN r_success
# 取消審核更新數據庫
END FUNCTION

PUBLIC FUNCTION s_voucher_unconf_upd_glam(p_glalld,p_glaldocno)
   DEFINE p_glalld         LIKE glal_t.glalld         #帐别
   DEFINE p_glaldocno      LIKE glal_t.glaldocno      #傳票編號
   DEFINE r_success        LIKE type_t.num5
   DEFINE r_errno          LIKE type_t.chr80
   
   WHENEVER ERROR CONTINUE
   
   LET r_success  = TRUE
   LET r_errno = ''
   #更新狀態碼=開立, 確認人=NULL,確認日期=NULL
    UPDATE glal_t SET glalstus = 'N',
                      glalcnfid = '',
                      glalcnfdt = ''
                WHERE glalent = g_enterprise
                  AND glalld = p_glalld
                  AND glaldocno = p_glaldocno
    IF SQLCA.SQLCODE THEN
      LET r_success = FALSE
#      CALL cl_errmsg('glalstus',p_glaldocno,'N',sqlca.sqlcode,1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaldocno
      LET g_errparam.code = sqlca.sqlcode
      LET g_errparam.popup = TRUE
      CALL cl_err()
    END IF 
    
    RETURN r_success
################################################################################
END FUNCTION
#+功能名稱：s_voucher_void_chk_glam
# 功能目的：常用傳票作廢
# 注意事項：無
# 關鍵詞：總帳、分攤編號、作廢
# 同義詞：总账、分摊编号、作废
# 參數值：1.帳別 
#　　　　 2.分攤編號
# 回傳值：1.檢核狀態 
#　　　 　2.錯誤訊息
################################################################################
PUBLIC FUNCTION s_voucher_void_chk_glam(p_glalld,p_glaldocno)
   DEFINE p_glalld           LIKE glal_t.glalld              #帐别
   DEFINE p_glaldocno        LIKE glal_t.glaldocno           #传票编号
   DEFINE r_success          LIKE type_t.num5                #檢核狀態
   DEFINE r_errno            LIKE type_t.chr80               #錯誤訊息
   DEFINE l_glalstus         LIKE glal_t.glalstus            #状态码
   DEFINE l_glaldocdt        LIKE glal_t.glaldocdt
   DEFINE l_success          LIKE type_t.num5
   
   LET r_errno = ''
   LET r_success = TRUE
   #资料检查
   #(1).传入参数为空，返回
   #170816-00007#130 by 09773 mod(S)
#   IF cl_null(p_glalld) OR cl_null(p_glaldocno) THEN
##      CALL cl_errmsg('void',p_glaldocno,'','sub-00110',1)
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.extend = p_glaldocno
#      LET g_errparam.code = 'sub-00110'
#      LET g_errparam.popup = TRUE
#      CALL cl_err()
#      LET r_success = FALSE
#   END IF 
   #170816-00007#130 by 09773 mod(E)
   
   #170816-00007#130 by 09773 add(S)
   #修改錯誤訊息報錯內容
   LET g_msg = ''
   LET g_colname_1 = ''
   LET g_comment_1 = ''
   IF cl_null(p_glalld) THEN
      CALL s_azzi902_get_gzzd("aapi511","lbl_glabld") RETURNING g_colname_1,g_comment_1  #賬套 
      LET g_msg = g_colname_1   
   END IF
   IF cl_null(p_glaldocno) THEN
      LET g_colname_1 = ''
      LET g_comment_1 = ''    
      CALL s_azzi902_get_gzzd("aglt310_07","lbl_glapdocno") RETURNING g_colname_1,g_comment_1   #單號
      IF g_msg IS NULL THEN   
         LET g_msg = g_colname_1   
      ELSE   
         LET g_msg = g_msg,",",g_colname_1
      END IF        
   END IF
   IF NOT cl_null(g_msg) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaldocno
      LET g_errparam.code = 'sub-00788'  #%1傳入值為空(錯誤)
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_msg 
      CALL cl_err()
      LET r_success = FALSE
   END IF   
   #170816-00007#130 by 09773 add(E)
   
   #(2).狀態碼=确认,才可進行確認動作
   SELECT glalstus,glaldocdt INTO l_glalstus,l_glaldocdt
     FROM glal_t
    WHERE glalent = g_enterprise
      AND glalld = p_glalld
      AND glaldocno = p_glaldocno
   IF l_glalstus <>'N' THEN
#      CALL cl_errmsg('void',p_glaldocno,'','agl-00052',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaldocno
      LET g_errparam.code = 'agl-00052'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF 
   
   #2015/05/27--add--str--
   #檢查當單據日期小於等於關帳日期時，不可異動單據
   CALL s_fin_date_close_chk(p_glalld,'','AGL',l_glaldocdt) RETURNING l_success
   IF l_success = FALSE THEN
      LET r_success = FALSE
   END IF
   #2015/05/27--add--end
   
   RETURN r_success
# 作废更新
END FUNCTION

PUBLIC FUNCTION s_voucher_void_upd_glam(p_glalld,p_glaldocno)
   DEFINE p_glalld         LIKE glal_t.glalld         #帐别
   DEFINE p_glaldocno      LIKE glal_t.glaldocno      #傳票編號
   DEFINE r_success        LIKE type_t.num5
   DEFINE r_errno          LIKE type_t.chr80

   WHENEVER ERROR CONTINUE
   
   LET r_success  = TRUE
   LET r_errno = ''
   #更新狀態碼='X', 修改者=g_user,修改日期=g_today
   UPDATE glal_t SET glalstus = 'X',
                     glalmodid = g_user,
                     glalmoddt = g_today
               WHERE glalent = g_enterprise
                 AND glalld = p_glalld
                 AND glaldocno = p_glaldocno
   IF SQLCA.SQLCODE THEN
      LET r_success = FALSE
#      CALL cl_errmsg('glalstus',p_glaldocno,'X',sqlca.sqlcode,1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaldocno
      LET g_errparam.code = sqlca.sqlcode
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF 
   RETURN r_success
# 借方科目核算項檢查
END FUNCTION
# Descriptions...: 自动产生凭证
# Memo...........:
# Usage..........: CALL s_voucher_gen_ar(p_type,p_ld,p_date,p_slip,p_sum_type,p_wc,p_preview)
#                       RETURNING r_success,r_start_no,r_end_no
# Input parameter: p_type         来源类型
#                                 1.axrt330 应收立帐
#                                 2.axrt400 應收沖帳
#                : p_ld           帐套
#                : p_date         立帐日期
#                : p_slip         凭证单别
#                : p_sum_type     汇总方式 
#                : p_wc           ＱＢＥ的範圍條件
#                : p_preview      是否先預覽后再拋憑證（Y/N）
# Return code....: r_success      成功否标识位
#                : r_start_no     起始号码
#                : r_end_no       结束号码
# Date & Author..: 2012/03/02 By Carrier
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar(p_type,p_ld,p_date,p_slip,p_sum_type,p_wc,p_preview)
   DEFINE p_type          LIKE type_t.chr2
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE p_date          LIKE glap_t.glapdocdt
  #DEFINE p_slip          LIKE ooba_t.ooba002    #160525-00021#1 mark
   DEFINE p_slip          LIKE type_t.chr50      #160525-00021#1   
   DEFINE p_sum_type      LIKE type_t.chr1
   DEFINE p_wc            LIKE type_t.chr1000
   DEFINE p_preview       LIKE type_t.chr1
   DEFINE r_success       LIKE type_t.num5
   DEFINE r_start_no      LIKE glap_t.glapdocno
   DEFINE r_end_no        LIKE glap_t.glapdocno
   DEFINE l_site          LIKE ooef_t.ooef001
   DEFINE l_success       LIKE type_t.num5
   
   
   WHENEVER ERROR CONTINUE
   
   LET r_success  = FALSE
   CALL g_glaq_d.clear()

   #检查事务中
   IF NOT s_transaction_chk('Y',1) THEN
      RETURN r_success,r_start_no,r_end_no
   END IF   

   
   IF cl_null(p_ld) THEN
      #帐套参数为空
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'agl-00121'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success,r_start_no,r_end_no
   END IF
   
   #检查帐套是否正确
#   IF g_prog <> 'axrp141' AND g_prog <> 'axrp142' AND g_prog <> 'aapp141' AND g_prog <> 'aapp142' THEN    #170110-00009#1 add lujh   #170301-00030#8 by 09257 --mark
   IF g_prog NOT MATCHES 'axrp141*' AND g_prog NOT MATCHES 'axrp142*' AND g_prog NOT MATCHES 'aapp141*' AND g_prog NOT MATCHES 'aapp142*' THEN    #170110-00009#1 add lujh    #170301-00030#8 by 09257 --add  
      CALL s_ld_chk_authorization(g_user,p_ld) RETURNING l_success
      IF l_success = FALSE THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'axr-00022'
         LET g_errparam.extend = p_ld
         LET g_errparam.popup = TRUE
         CALL cl_err()
      
         RETURN r_success,r_start_no,r_end_no
      END IF 
   END IF     #170110-00009#1 add lujh
   
   #检查单别CALL s_aooi200_chk_slip()
   #目前无法取得单别参数表号,需要再确认
   SELECT glaacomp INTO l_site FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald  = p_ld
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'sel glaacomp'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success,r_start_no,r_end_no 
   END IF
#   CALL s_aooi200_chk_slip(l_site,'',p_slip,'aglt310')
#        RETURNING l_success
#   IF NOT l_success THEN
#      RETURN r_success,r_start_no,r_end_no    
#   END IF
   
   IF cl_null(p_sum_type) THEN
      #产生凭证的汇总方式为空
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'agl-00123'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success,r_start_no,r_end_no 
   END IF
   
   IF cl_null(p_wc) THEN LET p_wc = " 1=1" END IF
   
   #CALL s_voucher_cre_ar_tmp_table() RETURNING r_success
   
   CASE p_type
        WHEN '1'   #AR-应收立帐自动产生凭证
                   CALL s_voucher_gen_ar_2(p_ld,p_sum_type,p_wc)
                        RETURNING r_success
        WHEN '2'   #AR-应收冲帐自动产生凭证
                   CALL s_voucher_gen_ar_3(p_ld,p_sum_type,p_wc)
                        RETURNING r_success
        WHEN '3'   #AR-重评价自动产生凭证
                   CALL s_voucher_gen_ar_4(p_ld,p_sum_type,p_wc,p_date)
                        RETURNING r_success
   END CASE
   
   #將明細資料彙總
   CALL s_voucher_gen_ar_2_ins_group_tmp(p_type,p_ld,p_sum_type) RETURNING l_success
   IF NOT l_success THEN
      RETURN r_success,r_start_no,r_end_no    
   END IF
   
   IF p_preview = 'Y' THEN   #先預覽,不產生憑證
      RETURN r_success,r_start_no,r_end_no
   ELSE                      #不預覽,直接產生憑證
      #因为交易客商前面无条件显示,抛凭证时才根据设置清空,这边做清空处理
      CALL s_voucher_gen_ar_2_glaq021_upd(p_ld) RETURNING l_success
      IF NOT l_success THEN
         RETURN r_success,r_start_no,r_end_no    
      END IF
      IF p_type = '1' THEN  #170509-00094#12 add
         CALL s_voucher_ins_tmp(p_sum_type) #170509-00094#12 add
      END IF  #170509-00094#12 add  
      #插入凭证单头
      CALL s_voucher_gen_ar_2_ins_glap(p_type,p_slip,p_date,p_ld,p_sum_type)
         RETURNING r_success,r_start_no,r_end_no
      IF NOT r_success THEN
         RETURN r_success,r_start_no,r_end_no       
      END IF
      RETURN r_success,r_start_no,r_end_no      
   END IF

################################################################################
END FUNCTION

PUBLIC FUNCTION s_voucher_forzen_glam005_chk(p_glalld,p_glaldocno,p_glam005,p_glaldocdt,p_success)
   DEFINE l_glad007        LIKE glad_t.glad007        #部門管理否
   DEFINE l_glad008        LIKE glad_t.glad008        #利潤成本中心管理
   DEFINE l_glad009        LIKE glad_t.glad009        #區域管理
   DEFINE l_glad010        LIKE glad_t.glad010        #客商管理
   DEFINE l_glad011        LIKE glad_t.glad011        #客群管理否
   DEFINE l_glad012        LIKE glad_t.glad012        #產品類別
   DEFINE l_glad013        LIKE glad_t.glad013        #人員
#   DEFINE l_glad014        LIKE glad_t.glad014        #预算管理否
   DEFINE l_glad015        LIKE glad_t.glad015        #专案管理否
   DEFINE l_glad016        LIKE glad_t.glad016        #wbs管理
   DEFINE l_glad031        LIKE glad_t.glad031        #预算管理否
   DEFINE l_glad032        LIKE glad_t.glad032        #预算管理否
   DEFINE l_glad033        LIKE glad_t.glad033        #预算管理否
   DEFINE l_glad027        LIKE glad_t.glad027
   DEFINE p_glalld         LIKE glal_t.glalld
   DEFINE p_glam005        LIKE glam_t.glam005
   DEFINE p_glaldocdt      LIKE glal_t.glaldocdt
   DEFINE l_errmsg         STRING
   DEFINE l_msg            STRING
   DEFINE l_msg1           STRING
   DEFINE p_success        LIKE type_t.num5
   DEFINE r_success        LIKE type_t.num5
   DEFINE p_glaldocno      LIKE glal_t.glaldocno
   DEFINE l_glaa004        LIKE glaa_t.glaa004
   DEFINE l_success        LIKE type_t.num5 
   
   LET r_success = p_success
   LET l_msg  = p_glaldocno||'/'||g_glam.glamseq
   LET l_msg1 = p_glaldocno||'/'||g_glam.glamseq||'/'||g_glam.glam005
   #营运据点检查   
   IF NOT cl_null(g_glam.glam019) THEN 
      CALL s_voucher_glam007_chk(g_glam.glam019)
      IF NOT cl_null(g_errno) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam019',l_errmsg,g_glam.glam019,g_errno,1)
         LET l_errmsg = l_msg||'/'||g_glam.glam019
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_errmsg
         #160321-00016#19 --s add
         LET g_errparam.replace[1] = 'aooi100'
         LET g_errparam.replace[2] = cl_get_progname('aooi100',g_lang,"2")
         LET g_errparam.exeprog = 'aooi100'
         #160321-00016#19 --e add
         LET g_errparam.code = g_errno
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF 
   ELSE
      LET r_success = FALSE
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = l_msg1
      LET g_errparam.code = 'agl-00291'
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   ################################################################################################
   #依據帳別，科目編號，判斷該科目是否启用
   #部門管理， 利潤成本中心管理，區域管理，客商管理，客群管理，產品類別，人員，預算，專案，wbs管理
   #1.清空核算项管理值
   LET l_glad007 = ''  LET l_glad008 = ''  LET l_glad009 = ''  LET l_glad010 = ''  LET l_glad011 = ''
   LET l_glad012 = ''  LET l_glad013 = ''  LET l_glad015 = ''  LET l_glad016 = ''  LET l_glad027 = ''
   LET l_glad031 = ''  LET l_glad032 = ''  LET l_glad033 = ''  
   #2.重新依账套，科目抓取核算项管理值
#   SELECT glad007,glad008,glad009,glad010,glad011,glad012,glad013,glad014,glad015,glad016          
#     INTO l_glad007,l_glad008,l_glad009,l_glad010,l_glad011,l_glad012,l_glad013,l_glad014,l_glad015,l_glad016
#     FROM glad_t
#   WHERE gladent = g_enterprise
#     AND gladld = p_glalld
#     AND glad001 = p_glam005
   SELECT glaa004 INTO l_glaa004 FROM glaa_t WHERE glaaent=g_enterprise AND glaald=p_glalld
   CALL s_voucher_fix_acc_open_chk(p_glalld,p_glam005)
   RETURNING l_glad007,l_glad008,l_glad009,l_glad010,l_glad027,l_glad011,l_glad012,l_glad013,l_glad015,l_glad016,l_glad031,l_glad032,l_glad033
       
   #======================================
   #固定核算项检查
   #如果启用改固定核算项勾选，则对该核算项的值进行检查
   #======================================  
   #該科目做部門管理時，部門不可空白  
   IF l_glad007 = 'Y' THEN
      IF cl_null(g_glam.glam020) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam020',l_errmsg,g_glam.glam020,'agl-00043',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code = 'agl-00043'
         LET g_errparam.popup = TRUE
         CALL cl_err()
      ELSE
         #部门检查        
         CALL s_department_chk(g_glam.glam020,p_glaldocdt) RETURNING l_success
         IF NOT l_success THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam020',l_errmsg,g_glam.glam020,g_errno,1)
#            LET l_errmsg = l_msg||'/'||g_glam.glam020
#            INITIALIZE g_errparam TO NULL
#            LET g_errparam.extend = l_errmsg
#            LET g_errparam.code = g_errno
#            LET g_errparam.popup = TRUE
#            CALL cl_err()
         END IF
      END IF
   END IF
  
   #該科目做利潤成本管理時，利潤成本不可空白  
   IF l_glad008 = 'Y' THEN
      IF cl_null(g_glam.glam021) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam021',l_errmsg,g_glam.glam021,'agl-00044',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code = 'agl-00044'
         LET g_errparam.popup = TRUE
         CALL cl_err()
      ELSE
         #利润成本中心检查   
         CALL s_voucher_glaq019_chk(g_glam.glam021,p_glaldocdt)
         IF NOT cl_null(g_errno) THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam021',l_errmsg,g_glam.glam021,g_errno,1)
            LET l_errmsg = l_msg||'/'||g_glam.glam021
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_errmsg
            LET g_errparam.code = g_errno
            #160321-00016#19 --s add
            LET g_errparam.replace[1] = 'aooi125'
            LET g_errparam.replace[2] = cl_get_progname('aooi125',g_lang,"2")
            LET g_errparam.exeprog = 'aooi125'
            #160321-00016#19 --e add
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF 
      END IF  
   END IF 
   
   #該科目做區域管理時，區域不可空白  
   IF l_glad009 = 'Y' THEN
      IF cl_null(g_glam.glam022) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam022',l_errmsg,g_glam.glam022,'agl-00045',1) 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code = 'agl-00045'
         LET g_errparam.popup = TRUE
         CALL cl_err()
      ELSE 
         #区域检查  
         CALL s_azzi650_chk_exist('287',g_glam.glam022) RETURNING l_success
         IF NOT l_success THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam022',l_errmsg,g_glam.glam022,g_errno,1)
#            LET l_errmsg = l_msg||'/'||g_glam.glam022
#            INITIALIZE g_errparam TO NULL
#            LET g_errparam.extend = l_errmsg
#            LET g_errparam.code = g_errno
#            LET g_errparam.popup = TRUE
#            CALL cl_err()
         END IF 
      END IF         
   END IF 
   
   #該科目做客商管理時，客商不可空白  
   IF l_glad010 = 'Y' THEN
      IF cl_null(g_glam.glam023) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam023',l_errmsg,'','agl-00046',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code = 'agl-00046'
         LET g_errparam.popup = TRUE
         CALL cl_err()
      ELSE
         #客商检查 
         CALL s_voucher_glaq021_chk(g_glam.glam023)
         IF NOT cl_null(g_errno) THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam023',l_errmsg,g_glam.glam023,g_errno,1)
            LET l_errmsg = l_msg||'/'||g_glam.glam023
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_errmsg
            LET g_errparam.code = g_errno
            #160321-00016#19 --s add
            LET g_errparam.replace[1] = 'apmm100'
            LET g_errparam.replace[2] = cl_get_progname('apmm100',g_lang,"2")
            LET g_errparam.exeprog = 'apmm100'
            #160321-00016#19 --e add
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF
      END IF
   END IF 
   
   #該科目做账款客商管理時，客商不可空白 
   IF l_glad027 = 'Y' THEN
      IF cl_null(g_glam.glam024) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam023',l_errmsg,'','agl-00046',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code = "axr-00215"
         LET g_errparam.popup = TRUE
         CALL cl_err()
      ELSE 
         CALL s_voucher_glaq021_chk(g_glam.glam024)
         IF NOT cl_null(g_errno) THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam024',l_errmsg,g_glam.glam024,g_errno,1)
            LET l_errmsg = l_msg||'/'||g_glam.glam024
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_errmsg
            LET g_errparam.code = g_errno
            #160321-00016#19 --s add
            LET g_errparam.replace[1] = 'apmm100'
            LET g_errparam.replace[2] = cl_get_progname('apmm100',g_lang,"2")
            LET g_errparam.exeprog = 'apmm100'
            #160321-00016#19 --e add
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF 
      END IF      
   END IF  
   
   #該科目做客群管理時，客群不可空白  
   IF l_glad011 = 'Y' THEN
      IF cl_null(g_glam.glam025) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam025',l_errmsg,g_glam.glam025,'agl-00047',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code = 'agl-00047'
         LET g_errparam.popup = TRUE
         CALL cl_err()
      ELSE
         #区域检查  
         CALL s_azzi650_chk_exist('281',g_glam.glam025) RETURNING l_success
         IF NOT l_success THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam025',l_errmsg,g_glam.glam025,g_errno,1)
#            LET l_errmsg = l_msg||'/'||g_glam.glam025
#            INITIALIZE g_errparam TO NULL
#            LET g_errparam.extend = l_errmsg
#            LET g_errparam.code = g_errno
#            LET g_errparam.popup = TRUE
#            CALL cl_err()
         END IF 
      END IF      
   END IF 
   
   #該科目做產品分類管理時，不可空白  
   IF l_glad012 = 'Y' THEN
      IF cl_null(g_glam.glam026) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam026',l_errmsg,g_glam.glam026,'agl-00068',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code = 'agl-00068'
         LET g_errparam.popup = TRUE
         CALL cl_err()
      ELSE
         #产品分类检查
         CALL s_voucher_glaq024_chk(g_glam.glam026)
         IF NOT cl_null(g_errno) THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam026',l_errmsg,g_glam.glam026,g_errno,1)
            LET l_errmsg = l_msg||'/'||g_glam.glam026
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_errmsg
            LET g_errparam.code = g_errno
            #160321-00016#19 --s add
            LET g_errparam.replace[1] = 'arti202'
            LET g_errparam.replace[2] = cl_get_progname('arti202',g_lang,"2")
            LET g_errparam.exeprog = 'arti202'
            #160321-00016#19 --e add
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF
      END IF         
   END IF 
   
   #該科目做經營方式管理時，經營方式不可空白  
   IF l_glad031 = 'Y' THEN
      IF cl_null(g_glam.glam054) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam054',l_errmsg,'','agl-00286',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code = 'agl-00286'
         LET g_errparam.popup = TRUE
         CALL cl_err()
      ELSE
         #經營方式检查
         CALL s_voucher_glaq051_chk(g_glam.glam054)
         IF NOT cl_null(g_errno) THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam054',l_errmsg,'',g_errno,1)
            LET l_errmsg = l_msg||'/'||g_glam.glam054
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_errmsg
            LET g_errparam.code = g_errno
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF
      END IF             
   END IF 
   
   #該科目做渠道管理時，渠道不可空白  
   IF l_glad032 = 'Y' THEN
      IF cl_null(g_glam.glam055) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam055',l_errmsg,'','agl-00287',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code = 'agl-00287'
         LET g_errparam.popup = TRUE
         CALL cl_err()
      ELSE
         #渠道检查
         CALL s_voucher_glaq052_chk(g_glam.glam055)
         IF NOT cl_null(g_errno) THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam055',l_errmsg,'',g_errno,1)
            LET l_errmsg = l_msg||'/'||g_glam.glam055
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_errmsg
            LET g_errparam.code = g_errno
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF
      END IF             
   END IF 
   
   #該科目做品牌管理時，品牌不可空白  
   IF l_glad033 = 'Y' THEN
      IF cl_null(g_glam.glam056) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam056',l_errmsg,'','agl-00288',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code = 'agl-00288'
         LET g_errparam.popup = TRUE
         CALL cl_err()
      ELSE
         #品牌检查
         CALL s_azzi650_chk_exist('2002',g_glam.glam056) RETURNING l_success
         IF NOT l_success THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam056',l_errmsg,'',g_errno,1)
            LET l_errmsg = l_msg||'/'||g_glam.glam056
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_errmsg
            LET g_errparam.code = g_errno
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF
      END IF             
   END IF 
   
   #該科目做人員管理時，不可空白  
   IF l_glad013 = 'Y' THEN
      IF cl_null(g_glam.glam027) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam027',l_errmsg,g_glam.glam027,'agl-00069',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code = 'agl-00069'
         LET g_errparam.popup = TRUE
         CALL cl_err()
      ELSE
         #人员检查
         CALL s_employee_chk(g_glam.glam027) RETURNING l_success
         IF NOT l_success THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam027',l_errmsg,g_glam.glam027,g_errno,1)
#            LET l_errmsg = l_msg||'/'||g_glam.glam027
#            INITIALIZE g_errparam TO NULL
#            LET g_errparam.extend = l_errmsg
#            LET g_errparam.code = g_errno
#            LET g_errparam.popup = TRUE
#            CALL cl_err()
         END IF
      END IF      
   END IF 
   
#   #該科目做預算管理時，不可空白  
#   IF l_glad014 = 'Y' THEN
#      IF cl_null(g_glam.glam028) THEN
#         LET r_success = FALSE
#         CALL cl_errmsg('glam028',l_errmsg,g_glam.glam028,'agl-00070',1)
#      END IF
#      #预算检查
#      IF NOT cl_null(g_glam.glam028) THEN
#         CALL s_voucher_glam016_chk(g_glam.glam028)
#         IF NOT cl_null(g_errno) THEN
#            LET r_success = FALSE
#            CALL cl_errmsg('glam028',l_errmsg,g_glam.glam028,g_errno,1)
#         END IF     
#      END IF      
#   END IF
   
   #該科目做專案管理時，不可空白  
   IF l_glad015 = 'Y' THEN
      IF cl_null(g_glam.glam029) THEN
         #LET r_success = FALSE             #170111-00005#1 mark
#         CALL cl_errmsg('glam029',l_errmsg,g_glam.glam029,'agl-00071',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         #LET g_errparam.code = 'agl-00071' #170111-00005#1 mark
         LET g_errparam.code = 'agl-00541'  #170111-00005#1 add
         LET g_errparam.popup = TRUE
         CALL cl_err()
      ELSE
         CALL s_aap_project_chk(g_glam.glam029) RETURNING l_success,g_errno
         IF NOT l_success THEN
            LET r_success = FALSE
            LET l_errmsg = l_msg||'/'||g_glam.glam029
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = g_errno
            LET g_errparam.extend = l_errmsg
            #160321-00016#19 --s add
            LET g_errparam.replace[1] = 'apjm200'
            LET g_errparam.replace[2] = cl_get_progname('apjm200',g_lang,"2")
            LET g_errparam.exeprog = 'apjm200'
            #160321-00016#19 --e add
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF
      END IF 
   END IF 
   
   #該科目做WBS管理時，不可空白  
   IF l_glad016 = 'Y' THEN
      IF cl_null(g_glam.glam030) THEN
         #LET r_success = FALSE             #170111-00005#1 mark
#         CALL cl_errmsg('glam030',l_errmsg,g_glam.glam030,'agl-00072',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         #LET g_errparam.code = 'agl-00072' #170111-00005#1 mark
         LET g_errparam.code = 'agl-00542'  #170111-00005#1 add
         LET g_errparam.popup = TRUE
         CALL cl_err()
      ELSE
         CALL s_voucher_glaq028_chk(g_glam.glam029,g_glam.glam030) 
         IF NOT cl_null(g_errno) THEN
            LET r_success = FALSE
            LET l_errmsg = l_msg||'/'||g_glam.glam030
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = g_errno
            LET g_errparam.extend = l_errmsg
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF
      END IF 
   END IF
   
   RETURN r_success
# 貸方科目核算項檢查
END FUNCTION

PUBLIC FUNCTION s_voucher_forzen_glam006_chk(p_glalld,p_glaldocno,p_glam006,p_glaldocdt,p_success)
   DEFINE l_glad007        LIKE glad_t.glad007        #部門管理否
   DEFINE l_glad008        LIKE glad_t.glad008        #利潤成本中心管理
   DEFINE l_glad009        LIKE glad_t.glad009        #區域管理
   DEFINE l_glad010        LIKE glad_t.glad010        #客商管理
   DEFINE l_glad011        LIKE glad_t.glad011        #客群管理否
   DEFINE l_glad012        LIKE glad_t.glad012        #產品類別
   DEFINE l_glad013        LIKE glad_t.glad013        #人員
#   DEFINE l_glad014        LIKE glad_t.glad014        #预算管理否
   DEFINE l_glad015        LIKE glad_t.glad015        #专案管理否
   DEFINE l_glad016        LIKE glad_t.glad016        #wbs管理
   DEFINE l_glad027        LIKE glad_t.glad027
   DEFINE l_glad031        LIKE glad_t.glad031
   DEFINE l_glad032        LIKE glad_t.glad032
   DEFINE l_glad033        LIKE glad_t.glad033
   DEFINE p_glalld         LIKE glal_t.glalld
   DEFINE p_glam006        LIKE glam_t.glam005
   DEFINE p_glaldocdt      LIKE glal_t.glaldocdt
   DEFINE l_errmsg         STRING
   DEFINE l_msg            STRING
   DEFINE l_msg1           STRING
   DEFINE p_success        LIKE type_t.num5
   DEFINE r_success        LIKE type_t.num5
   DEFINE p_glaldocno      LIKE glal_t.glaldocno
   DEFINE l_glaa004        LIKE glaa_t.glaa004
   DEFINE l_success        LIKE type_t.num5 
   
   LET r_success = p_success
   LET l_msg  = p_glaldocno||'/'||g_glam.glamseq
   LET l_msg1 = p_glaldocno||'/'||g_glam.glamseq||'/'||g_glam.glam006
   
   #营运据点检查   
   IF NOT cl_null(g_glam.glam031) THEN 
      CALL s_voucher_glam007_chk(g_glam.glam031)
      IF NOT cl_null(g_errno) THEN
        LET r_success = FALSE
#        CALL cl_errmsg('glam031',l_errmsg,g_glam.glam031,g_errno,1)
        LET l_errmsg = l_msg||'/'||g_glam.glam031
        INITIALIZE g_errparam TO NULL
        LET g_errparam.extend = l_errmsg
        #160321-00016#19 --s add
        LET g_errparam.replace[1] = 'aooi100'
        LET g_errparam.replace[2] = cl_get_progname('aooi100',g_lang,"2")
        LET g_errparam.exeprog = 'aooi100'
        #160321-00016#19 --e add
        LET g_errparam.code = g_errno
        LET g_errparam.popup = TRUE
        CALL cl_err()
      END IF
   ELSE
      LET r_success = FALSE
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = l_msg1
      LET g_errparam.code   = 'agl-00291'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
   END IF
   ################################################################################################
   #依據帳別，科目編號，判斷該科目是否启用
   #部門管理， 利潤成本中心管理，區域管理，客商管理，客群管理，產品類別，人員，預算，專案，wbs管理
   #1.清空核算项管理值
   LET l_glad007 = ''  LET l_glad008 = ''  LET l_glad009 = ''  LET l_glad010 = ''  LET l_glad011 = ''
   LET l_glad012 = ''  LET l_glad013 = ''  LET l_glad015 = ''  LET l_glad016 = ''  LET l_glad027 = '' 
   LET l_glad031 = ''  LET l_glad032 = ''  LET l_glad033 = ''  
   #2.重新依账套，科目抓取核算项管理值
#   SELECT glad007,glad008,glad009,glad010,glad011,glad012,glad013,glad014,glad015,glad016          
#     INTO l_glad007,l_glad008,l_glad009,l_glad010,l_glad011,l_glad012,l_glad013,l_glad014,l_glad015,l_glad016
#     FROM glad_t
#   WHERE gladent = g_enterprise
#     AND gladld = p_glalld
#     AND glad001 = p_glam006
   SELECT glaa004 INTO l_glaa004 FROM glaa_t WHERE glaaent=g_enterprise AND glaald=p_glalld
   CALL s_voucher_fix_acc_open_chk(p_glalld,p_glam006)
   RETURNING l_glad007,l_glad008,l_glad009,l_glad010,l_glad027,l_glad011,l_glad012,l_glad013,l_glad015,l_glad016,l_glad031,l_glad032,l_glad033

   #======================================
   #固定核算项检查
   #如果启用改固定核算项勾选，则对该核算项的值进行检查
   #======================================  
   #該科目做部門管理時，部門不可空白  
   IF l_glad007 = 'Y' THEN
      IF cl_null(g_glam.glam032) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam032',l_errmsg,'','agl-00043',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code   = 'agl-00043'
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      ELSE
         #部门检查          
         CALL s_department_chk(g_glam.glam032,p_glaldocdt) RETURNING l_success
         IF NOT l_success THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam032',l_errmsg,'',g_errno,1)
#            LET l_errmsg = l_msg||'/'||g_glam.glam032
#            INITIALIZE g_errparam TO NULL
#            LET g_errparam.extend = l_errmsg
#            LET g_errparam.code = g_errno
#            LET g_errparam.popup = TRUE
#            CALL cl_err()
         END IF 
      END IF   
   END IF
  
   #該科目做利潤成本管理時，利潤成本不可空白  
   IF l_glad008 = 'Y' THEN
      IF cl_null(g_glam.glam033) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam033',l_errmsg,'','agl-00044',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code   = 'agl-00044'
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      ELSE
         #利润成本中心检查 
         CALL s_voucher_glaq019_chk(g_glam.glam033,p_glaldocdt)
         IF NOT cl_null(g_errno) THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam033',l_errmsg,'',g_errno,1)
            LET l_errmsg = l_msg||'/'||g_glam.glam033
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_errmsg
            LET g_errparam.code = g_errno
            #160321-00016#19 --s add
            LET g_errparam.replace[1] = 'aooi125'
            LET g_errparam.replace[2] = cl_get_progname('aooi125',g_lang,"2")
            LET g_errparam.exeprog = 'aooi125'
            #160321-00016#19 --e add
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF  
      END IF   
   END IF 
   
   #該科目做區域管理時，區域不可空白  
   IF l_glad009 = 'Y' THEN
      IF cl_null(g_glam.glam034) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam034',l_errmsg,'','agl-00045',1) 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code   = 'agl-00045'
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      ELSE 
         #区域检查
         CALL s_azzi650_chk_exist('287',g_glam.glam034) RETURNING l_success
         IF NOT l_success THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam034',l_errmsg,'',g_errno,1)
#            LET l_errmsg = l_msg||'/'||g_glam.glam034
#            INITIALIZE g_errparam TO NULL
#            LET g_errparam.extend = l_errmsg
#            LET g_errparam.code = g_errno
#            LET g_errparam.popup = TRUE
#            CALL cl_err()
         END IF
      END IF      
   END IF 
   
   #該科目做客商管理時，客商不可空白  
   IF l_glad010 = 'Y' THEN
      IF cl_null(g_glam.glam035) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam035',l_errmsg,'','agl-00046',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code   = 'agl-00046'
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      ELSE
         #客商检查
         CALL s_voucher_glaq021_chk(g_glam.glam035)
         IF NOT cl_null(g_errno) THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam035',l_errmsg,'',g_errno,1)
            LET l_errmsg = l_msg||'/'||g_glam.glam035
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_errmsg
            LET g_errparam.code = g_errno
            #160321-00016#19 --s add
            LET g_errparam.replace[1] = 'apmm100'
            LET g_errparam.replace[2] = cl_get_progname('apmm100',g_lang,"2")
            LET g_errparam.exeprog = 'apmm100'
            #160321-00016#19 --e add
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF
      END IF
   END IF 
   
   #該科目做客商管理時，客商不可空白  
   IF l_glad027 = 'Y' THEN
      IF cl_null(g_glam.glam036) THEN
         LET r_success = FALSE
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code   = 'axr-00215'
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      ELSE
         CALL s_voucher_glaq021_chk(g_glam.glam036)
         IF NOT cl_null(g_errno) THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam036',l_errmsg,'',g_errno,1)
            LET l_errmsg = l_msg||'/'||g_glam.glam036
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_errmsg
            LET g_errparam.code = g_errno
            #160321-00016#19 --s add
            LET g_errparam.replace[1] = 'apmm100'
            LET g_errparam.replace[2] = cl_get_progname('apmm100',g_lang,"2")
            LET g_errparam.exeprog = 'apmm100'
            #160321-00016#19 --e add
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF  
      END IF         
   END IF 
   
   #該科目做客群管理時，客群不可空白  
   IF l_glad011 = 'Y' THEN
      IF cl_null(g_glam.glam037) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam037',l_errmsg,'','agl-00047',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code   = 'agl-00047'
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      ELSE
         #区域检查
         CALL s_azzi650_chk_exist('281',g_glam.glam037) RETURNING l_success
         IF NOT l_success THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam037',l_errmsg,'',g_errno,1)
#            LET l_errmsg = l_msg||'/'||g_glam.glam037
#            INITIALIZE g_errparam TO NULL
#            LET g_errparam.extend = l_errmsg
#            LET g_errparam.code = g_errno
#            LET g_errparam.popup = TRUE
#            CALL cl_err()
         END IF
      END IF      
   END IF 
   
   #該科目做產品分類管理時，不可空白  
   IF l_glad012 = 'Y' THEN
      IF cl_null(g_glam.glam038) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam038',l_errmsg,'','agl-00068',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code   = 'agl-00068'
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      ELSE
         #产品分类检查 
         CALL s_voucher_glaq024_chk(g_glam.glam038)
         IF NOT cl_null(g_errno) THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam038',l_errmsg,'',g_errno,1)
            LET l_errmsg = l_msg||'/'||g_glam.glam038
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_errmsg
            LET g_errparam.code = g_errno
            #160321-00016#19 --s add
            LET g_errparam.replace[1] = 'arti202'
            LET g_errparam.replace[2] = cl_get_progname('arti202',g_lang,"2")
            LET g_errparam.exeprog = 'arti202'
            #160321-00016#19 --e add
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF   
      END IF       
   END IF 
   
   #該科目做經營方式管理時，經營方式不可空白  
   IF l_glad031 = 'Y' THEN
      IF cl_null(g_glam.glam057) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam057',l_errmsg,'','agl-00286',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code   = 'agl-00286'
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      ELSE
         #經營方式检查 
         CALL s_voucher_glaq051_chk(g_glam.glam057)
         IF NOT cl_null(g_errno) THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam057',l_errmsg,'',g_errno,1)
            LET l_errmsg = l_msg||'/'||g_glam.glam057
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_errmsg
            LET g_errparam.code = g_errno
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF
      END IF             
   END IF 
   
   #該科目做渠道管理時，渠道不可空白  
   IF l_glad032 = 'Y' THEN
      IF cl_null(g_glam.glam058) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam058',l_errmsg,'','agl-00287',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code   = 'agl-00287'
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      ELSE
         #渠道检查
         CALL s_voucher_glaq052_chk(g_glam.glam058)
         IF NOT cl_null(g_errno) THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam058',l_errmsg,'',g_errno,1)
            LET l_errmsg = l_msg||'/'||g_glam.glam058
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_errmsg
            LET g_errparam.code = g_errno
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF
      END IF             
   END IF 
   
   #該科目做品牌管理時，品牌不可空白  
   IF l_glad033 = 'Y' THEN
      IF cl_null(g_glam.glam059) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam059',l_errmsg,'','agl-00288',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code   = 'agl-00288'
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      ELSE
         #品牌检查
         CALL s_azzi650_chk_exist('2002',g_glam.glam059) RETURNING l_success
         IF NOT l_success THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam059',l_errmsg,'',g_errno,1)
            LET l_errmsg = l_msg||'/'||g_glam.glam059
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_errmsg
            LET g_errparam.code = g_errno
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF
      END IF             
   END IF 
   
   #該科目做人員管理時，不可空白  
   IF l_glad013 = 'Y' THEN
      IF cl_null(g_glam.glam039) THEN
         LET r_success = FALSE
#         CALL cl_errmsg('glam039',l_errmsg,'','agl-00069',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         LET g_errparam.code   = 'agl-00069'
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      ELSE
         #人员检查
         CALL s_employee_chk(g_glam.glam039) RETURNING l_success
         IF NOT l_success THEN
            LET r_success = FALSE
#            CALL cl_errmsg('glam039',l_errmsg,'',g_errno,1)
#            LET l_errmsg = l_msg||'/'||g_glam.glam039
#            INITIALIZE g_errparam TO NULL
#            LET g_errparam.extend = l_errmsg
#            LET g_errparam.code = g_errno
#            LET g_errparam.popup = TRUE
#            CALL cl_err()
         END IF  
      END IF      
   END IF 
   
#   #該科目做預算管理時，不可空白  
#   IF l_glad014 = 'Y' THEN
#      IF cl_null(g_glam.glam040) THEN
#         LET r_success = FALSE
#         CALL cl_errmsg('glam040',l_errmsg,'','agl-00070',1)
#      END IF
#      #预算检查
#      IF NOT cl_null(g_glam.glam040) THEN
#         CALL s_voucher_glam016_chk(g_glam.glam040)
#         IF NOT cl_null(g_errno) THEN
#            LET r_success = FALSE
#            CALL cl_errmsg('glam040',l_errmsg,'',g_errno,1)
#         END IF    
#      END IF      
#   END IF
   
   #該科目做專案管理時，不可空白  
   IF l_glad015 = 'Y' THEN
      IF cl_null(g_glam.glam041) THEN
         #LET r_success = FALSE               #170111-00005#1 mark
#         CALL cl_errmsg('glam041',l_errmsg,'','agl-00071',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         #LET g_errparam.code   = 'agl-00071' #170111-00005#1 mark
         LET g_errparam.code   = 'agl-00541'  #170111-00005#1 add
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      ELSE
         CALL s_aap_project_chk(g_glam.glam041) RETURNING l_success,g_errno
         IF NOT l_success THEN
            LET r_success = FALSE
            LET l_errmsg = l_msg||'/'||g_glam.glam041
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = g_errno
            LET g_errparam.extend = l_errmsg
            #160321-00016#19 --s add
            LET g_errparam.replace[1] = 'apjm200'
            LET g_errparam.replace[2] = cl_get_progname('apjm200',g_lang,"2")
            LET g_errparam.exeprog = 'apjm200'
            #160321-00016#19 --e add
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF
      END IF 
   END IF 
   
   #該科目做WBS管理時，不可空白  
   IF l_glad016 = 'Y' THEN
      IF cl_null(g_glam.glam042) THEN
         #LET r_success = FALSE               #170111-00005#1 mark
#         CALL cl_errmsg('glam042',l_errmsg,'','agl-00072',1)
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_msg1
         #LET g_errparam.code   = 'agl-00072' #170111-00005#1 mark
         LET g_errparam.code   = 'agl-00542'  #170111-00005#1 add
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      ELSE
         CALL s_voucher_glaq028_chk(g_glam.glam041,g_glam.glam042) 
         IF NOT cl_null(g_errno) THEN
            LET r_success = FALSE
            LET l_errmsg = l_msg||'/'||g_glam.glam042
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = g_errno
            LET g_errparam.extend = l_errmsg
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF
      END IF 
   END IF
   
   RETURN r_success
################################################################################
END FUNCTION
# Descriptions...: 细项立冲确认检查
# Memo...........:
# Usage..........: CALL s_voucher_conf_chk_glax (传入参数)
#                  RETURNING 回传参数
# Input parameter: p_glaxls       帐别
#                : p_glaxdocno    传票单号
# Return code....: r_success      执行状态
#               
# Date & Author..: 2014/01/08 By minpp
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_conf_chk_glax(p_glaxld,p_glaxdocno)
   DEFINE p_glaxld         LIKE glax_t.glaxld         #帐别
   DEFINE p_glaxdocno      LIKE glax_t.glaxdocno      #傳票編號
   DEFINE r_success        LIKE type_t.num5           #檢核狀態
   DEFINE l_glaxdocdt      LIKE glax_t.glaxdocdt      #传票日期
   DEFINE l_cnt            LIKE type_t.num5
   DEFINE l_glaxstus       LIKE glax_t.glaxstus       #状态
   DEFINE l_glaxseq        LIKE glax_t.glaxseq        #项次
   DEFINE l_glax002        LIKE glax_t.glax002        #单身科目
   DEFINE l_glac006        LIKE glac_t.glac006        #科目性质
   DEFINE l_glac003        LIKE glac_t.glac003        #统治/明细科目
   DEFINE l_sql            STRING
   DEFINE l_glad007        LIKE glad_t.glad007     #部門管理否
   DEFINE l_glad008        LIKE glad_t.glad008     #利潤成本中心管理
   DEFINE l_glad009        LIKE glad_t.glad009     #區域管理
   DEFINE l_glad010        LIKE glad_t.glad010     #交易客商管理
   DEFINE l_glad027        LIKE glad_t.glad027     #账款客商管理
   DEFINE l_glad011        LIKE glad_t.glad011     #客群管理否
   DEFINE l_glad012        LIKE glad_t.glad012     #產品類別
   DEFINE l_glad013        LIKE glad_t.glad013     #人員
#   DEFINE l_glad014        LIKE glad_t.glad014     #预算管理否
   DEFINE l_glad015        LIKE glad_t.glad015     #专案管理否
   DEFINE l_glad016        LIKE glad_t.glad016     #wbs管理
   DEFINE l_glad031        LIKE glad_t.glad031     #經營方式管理
   DEFINE l_glad032        LIKE glad_t.glad032     #渠道管理
   DEFINE l_glad033        LIKE glad_t.glad033     #品牌管理
   DEFINE l_success        LIKE type_t.num5 
   #是否做自由科目核算项管理
   DEFINE l_glad017        LIKE glad_t.glad017
   DEFINE l_glad0171       LIKE glad_t.glad0171 
   DEFINE l_glad0172       LIKE glad_t.glad0172 
   DEFINE l_glad018        LIKE glad_t.glad018
   DEFINE l_glad0181       LIKE glad_t.glad0181
   DEFINE l_glad0182       LIKE glad_t.glad0182
   DEFINE l_glad019        LIKE glad_t.glad019
   DEFINE l_glad0191       LIKE glad_t.glad0191
   DEFINE l_glad0192       LIKE glad_t.glad0192
   DEFINE l_glad020        LIKE glad_t.glad020
   DEFINE l_glad0201       LIKE glad_t.glad0201
   DEFINE l_glad0202       LIKE glad_t.glad0202
   DEFINE l_glad021        LIKE glad_t.glad021
   DEFINE l_glad0211       LIKE glad_t.glad0211
   DEFINE l_glad0212       LIKE glad_t.glad0212
   DEFINE l_glad022        LIKE glad_t.glad022
   DEFINE l_glad0221       LIKE glad_t.glad0221
   DEFINE l_glad0222       LIKE glad_t.glad0222
   DEFINE l_glad023        LIKE glad_t.glad023
   DEFINE l_glad0231       LIKE glad_t.glad0231
   DEFINE l_glad0232       LIKE glad_t.glad0232
   DEFINE l_glad024        LIKE glad_t.glad024
   DEFINE l_glad0241       LIKE glad_t.glad0241
   DEFINE l_glad0242       LIKE glad_t.glad0242
   DEFINE l_glad025        LIKE glad_t.glad025
   DEFINE l_glad0251       LIKE glad_t.glad0251
   DEFINE l_glad0252       LIKE glad_t.glad0252
   DEFINE l_glad026        LIKE glad_t.glad026
   DEFINE l_glad0261       LIKE glad_t.glad0261
   DEFINE l_glad0262       LIKE glad_t.glad0262
   DEFINE l_errno          LIKE type_t.chr10
   DEFINE l_errmsg         STRING     #组合报错信息
   DEFINE l_msg            STRING     #组合报错信息
   DEFINE l_msg1           STRING     #组合报错信息
   DEFINE l_efin5001       LIKE type_t.chr1
   DEFINE l_ooba002        LIKE ooba_t.ooba002
   DEFINE l_glaxcomp       LIKE glax_t.glaxcomp
   DEFINE l_glaxcrtid      LIKE glax_t.glaxcrtid
   DEFINE l_hsx            DYNAMIC ARRAY OF VARCHAR(30) #160729-00009#1 add
   
   
   WHENEVER ERROR CONTINUE
   LET r_success = TRUE
   #初始化数组
   INITIALIZE g_glax.* TO NULL
   #资料检查
   #(1).传入参数为空，返回
   #170816-00007#130 by 09773 mod(S)
#   IF cl_null(p_glaxld) OR cl_null(p_glaxdocno) THEN
#      LET r_success = FALSE
##      CALL cl_errmsg('conf_chk',p_glaxdocno,'','sub-00110',1)
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.extend = p_glaxdocno
#      LET g_errparam.code = 'sub-00110'
#      LET g_errparam.popup = TRUE
#      CALL cl_err()
#   END IF
   #170816-00007#130 by 09773 mod(E)
   
   #170816-00007#130 by 09773 add(S)
   #修改錯誤訊息報錯內容
   LET g_msg = ''
   LET g_colname_1 = ''
   LET g_comment_1 = ''
   IF cl_null(p_glaxld) THEN
      CALL s_azzi902_get_gzzd("aapi511","lbl_glabld") RETURNING g_colname_1,g_comment_1  #賬套 
      LET g_msg = g_colname_1   
   END IF
   IF cl_null(p_glaxdocno) THEN
      LET g_colname_1 = ''
      LET g_comment_1 = ''    
      CALL s_azzi902_get_gzzd("aglt310_07","lbl_glapdocno") RETURNING g_colname_1,g_comment_1   #單號
      IF g_msg IS NULL THEN   
         LET g_msg = g_colname_1   
      ELSE   
         LET g_msg = g_msg,",",g_colname_1
      END IF        
   END IF
   IF NOT cl_null(g_msg) THEN
      LET r_success = FALSE
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaxdocno
      LET g_errparam.code = 'sub-00788'  #%1傳入值為空(錯誤)
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_msg 
      CALL cl_err()
   END IF   
   #170816-00007#130 by 09773 add(E)
   
   #抓取状态码,传票日期   
   LET l_glaxstus =''
   LET l_glaxdocdt=''
   SELECT glaxstus,glaxdocdt,glaxcomp,glaxcrtid INTO l_glaxstus,l_glaxdocdt,l_glaxcomp,l_glaxcrtid FROM glax_t
    WHERE glaxent = g_enterprise
      AND glaxld = p_glaxld
      AND glaxdocno = p_glaxdocno
   #(2).狀態碼=開立,才可進行確認動作   
   IF l_glaxstus <>'N' THEN
      LET r_success = FALSE
#      CALL cl_errmsg('glaxstus',p_glaxdocno,'','agl-00052',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaxdocno
      LET g_errparam.code = 'agl-00052'
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF 
  
   #2015/05/27--add--str--
   #檢查當單據日期小於等於關帳日期時，不可異動單據
   CALL s_fin_date_close_chk(p_glaxld,'','AGL',l_glaxdocdt) RETURNING l_success
   IF l_success = FALSE THEN
      LET r_success = FALSE
   END IF
   #2015/05/27--add--end
   
   #根據參數判斷，資料建立者和確認者為同一人才可確認
   #150602-00057#2 by 02291 add
   CALL s_aooi200_fin_get_slip(p_glaxdocno) RETURNING l_success,l_ooba002
   CALL s_fin_chk_E5001(p_glaxld,l_glaxcomp,l_ooba002) RETURNING l_efin5001
   IF l_efin5001 = 'N' THEN
      IF l_glaxcrtid = g_user THEN
         LET r_success = FALSE
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'axr-00346'
         LET g_errparam.extend = ''
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
   END IF   
   #150602-00057#2 by 02291 add
   
　 #(6).单身科目无效，性質不為帳戶,不為明細或獨立帳戶,则返回报错
   #業務信息頁籤的欄位,若有輸入值,應檢查其對應基本資料的合理性
   #固定核算項及自由核算的欄位,應檢查若科目有啟用該核算項時,其對應基本資料的合理性 
   LET l_sql = " SELECT glaxseq,glax002,",
               "        glax005,glax006,glax007,glax008,glax009,glax010,",
               "        glax011,glax012,glax013,glax014,glax015,glax016,",
               "        glax017,glax018,glax019,glax020,glax021,glax022,",
               "        glax023,glax024,glax025,glax027,glax028,glax061,glax062,glax063,",
               "        glax029,glax030,glax031,glax032,glax033,glax034,",
               "        glax035,glax036,glax037,glax038 ",
               "  FROM glax_t ",
               #" WHERE glaxent = '",g_enterprise,"'", #170615-00061#25 mark
               " WHERE glaxent = ",g_enterprise," ",   #170615-00061#25 add
               "   AND glaxld = '",p_glaxld,"'",
               "   AND glaxdocno = '",p_glaxdocno,"'"
   PREPARE s_voucher_pre_glax1 FROM l_sql
   DECLARE s_voucher_cur_glax1 CURSOR FOR s_voucher_pre_glax1
   FOREACH s_voucher_cur_glax1 INTO g_glax.glaxseq,g_glax.glax002,
                               g_glax.glax005,g_glax.glax006,g_glax.glax007,g_glax.glax008,g_glax.glax009,g_glax.glax010,
                               g_glax.glax011,g_glax.glax012,g_glax.glax013,g_glax.glax014,g_glax.glax015,g_glax.glax016,
                               g_glax.glax017,g_glax.glax018,g_glax.glax019,g_glax.glax020,g_glax.glax021,g_glax.glax022,
                               g_glax.glax023,g_glax.glax024,g_glax.glax025,g_glax.glax027,g_glax.glax028,
                               g_glax.glax061,g_glax.glax062,g_glax.glax063,
                               g_glax.glax029,g_glax.glax030,g_glax.glax031,g_glax.glax032,g_glax.glax033,g_glax.glax034,
                               g_glax.glax035,g_glax.glax036,g_glax.glax037,g_glax.glax038                              
       IF SQLCA.sqlcode THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code = SQLCA.sqlcode
          LET g_errparam.extend = 'foreach:'
          LET g_errparam.popup = TRUE
          CALL cl_err()

          EXIT FOREACH
       END IF
       #组合报错信息
       LET l_msg  = p_glaxdocno||'/'||g_glax.glaxseq
       LET l_msg1 = p_glaxdocno||'/'||g_glax.glaxseq||'/'||g_glax.glax002
       #科目
       IF NOT cl_null(g_glax.glax002) THEN
          CALL s_voucher_glaq002_chk(p_glaxld,g_glax.glax002)
          IF NOT cl_null(g_errno) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glaq002',l_errmsg,'',g_errno,1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code = g_errno
             #160321-00016#19 --s add
             LET g_errparam.replace[1] = 'agli030'
             LET g_errparam.replace[2] = cl_get_progname('agli030',g_lang,"2")
             LET g_errparam.exeprog = 'agli030'
             #160321-00016#19 --e add
             LET g_errparam.popup = TRUE
             CALL cl_err()
          END IF 
       END IF
       #============================       
       #业务咨询检查
       #============================
       #币种
       IF NOT cl_null(g_glax.glax005) THEN 
          CALL s_voucher_glaq005_chk(g_glax.glax005)
          IF NOT cl_null(g_errno) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax005',l_errmsg,g_glax.glax005,g_errno,1)
             LET l_errmsg = l_msg||'/'||g_glax.glax005
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_errmsg
             LET g_errparam.code = g_errno
             #160321-00016#19 --s add
             LET g_errparam.replace[1] = 'aooi140'
             LET g_errparam.replace[2] = cl_get_progname('aooi140',g_lang,"2")
             LET g_errparam.exeprog = 'aooi140'
             #160321-00016#19 --e add
             LET g_errparam.popup = TRUE
             CALL cl_err()
          END IF 
       END IF 
       #汇率
        IF NOT cl_null(g_glax.glax006) THEN
           CALL s_voucher_num_chk(g_glax.glax006)
           IF NOT cl_null(g_errno) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax006',l_errmsg,g_glax.glax006,g_errno,1)
             LET l_errmsg = l_msg||'/'||g_glax.glax006
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_errmsg
             LET g_errparam.code = g_errno
             LET g_errparam.popup = TRUE
             CALL cl_err()
          END IF 
        END IF 
       
       #计价单位
       IF NOT cl_null(g_glax.glax007) THEN 
          CALL s_voucher_glaq007_chk(g_glax.glax007)
          IF NOT cl_null(g_errno) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax007',l_errmsg,g_glax.glax007,g_errno,1)
             LET l_errmsg = l_msg||'/'||g_glax.glax007
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_errmsg
             LET g_errparam.code = g_errno
             #160321-00016#19 --s add
             LET g_errparam.replace[1] = 'aooi250'
             LET g_errparam.replace[2] = cl_get_progname('aooi250',g_lang,"2")
             LET g_errparam.exeprog = 'aooi250'
             #160321-00016#19 --e add
             LET g_errparam.popup = TRUE
             CALL cl_err()
          END IF 
       END IF 
       
       #数量
       IF NOT cl_null(g_glax.glax008) THEN
           CALL s_voucher_num_chk(g_glax.glax008)
           IF NOT cl_null(g_errno) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax008',l_errmsg,g_glax.glax008,g_errno,1)
             LET l_errmsg = l_msg||'/'||g_glax.glax008
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_errmsg
             LET g_errparam.code = g_errno
             LET g_errparam.popup = TRUE
             CALL cl_err()
          END IF 
        END IF 
       #单价
       IF NOT cl_null(g_glax.glax009) THEN
          CALL s_voucher_num_chk(g_glax.glax009)
          IF NOT cl_null(g_errno) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax009',l_errmsg,g_glax.glax009,g_errno,1)
             LET l_errmsg = l_msg||'/'||g_glax.glax009
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_errmsg
             LET g_errparam.code = g_errno
             LET g_errparam.popup = TRUE
             CALL cl_err()
          END IF 
        END IF 
       #金额
       IF NOT cl_null(g_glax.glax010) THEN
          CALL s_voucher_num_chk(g_glax.glax010)
          IF NOT cl_null(g_errno) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax010',l_errmsg,g_glax.glax010,g_errno,1)
             LET l_errmsg = l_msg||'/'||g_glax.glax010
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_errmsg
             LET g_errparam.code = g_errno
             LET g_errparam.popup = TRUE
             CALL cl_err()
          END IF 
       END IF 
        
       #申请人
       IF NOT cl_null(g_glax.glax013) THEN 
          CALL s_voucher_glaq013_chk(g_glax.glax013)
          IF NOT cl_null(g_errno) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax013',l_errmsg,g_glax.glax013,g_errno,1)
             LET l_errmsg = l_msg||'/'||g_glax.glax013
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_errmsg
             LET g_errparam.code = g_errno
             #160321-00016#19 --s add
             LET g_errparam.replace[1] = 'aooi130'
             LET g_errparam.replace[2] = cl_get_progname('aooi130',g_lang,"2")
             LET g_errparam.exeprog = 'aooi130'
             #160321-00016#19 --e add
             LET g_errparam.popup = TRUE
             CALL cl_err()
          END IF 
       END IF
       #营运据点检查   
       IF NOT cl_null(g_glax.glax017) THEN 
          CALL s_voucher_glaq017_chk(g_glax.glax017)
          IF NOT cl_null(g_errno) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax017',l_errmsg,g_glax.glax017,g_errno,1)
             LET l_errmsg = l_msg||'/'||g_glax.glax017
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_errmsg
             LET g_errparam.code = g_errno
             LET g_errparam.popup = TRUE
             #160321-00016#1--s
             LET g_errparam.replace[1]='aooi100'
             LET g_errparam.replace[2] = cl_get_progname('aooi100',g_lang,"2")
             LET g_errparam.exeprog  = "aooi100"             
             #160321-00016#1--e             
             CALL cl_err()
          END IF 
       ELSE 
          LET r_success = FALSE
#          CALL cl_errmsg('glax017',l_errmsg,g_glax.glax017,'agl-00291',1)
          INITIALIZE g_errparam TO NULL
          LET g_errparam.extend = l_msg1
          LET g_errparam.code = 'agl-00291'
          LET g_errparam.popup = TRUE
          CALL cl_err()
       END IF
       ################################################################################################
       #依據帳別，科目編號，判斷該科目是否启用
       #部門管理， 利潤成本中心管理，區域管理，交易客商管理，客群管理，產品類別，人員，預算，專案，wbs管理，账款客商管理，自由核算项1~10
       #1.清空核算项管理值
       LET l_glad007 = ''  LET l_glad008 = ''  LET l_glad009 = ''  LET l_glad010 = ''  LET l_glad027 = ''   LET l_glad011 = ''
       LET l_glad012 = ''  LET l_glad013 = ''  LET l_glad015 = ''  LET l_glad016 = ''  
       LET l_glad031 = ''  LET l_glad032 = ''  LET l_glad033 = ''
       LET l_glad017 = ''  LET l_glad0171 =''  LET l_glad0172 = '' LET l_glad018 = ''  LET l_glad0181 = ''  LET l_glad0182 = ''   
       LET l_glad019 = ''  LET l_glad0191 =''  LET l_glad0192 = '' LET l_glad020 = ''  LET l_glad0201 = ''  LET l_glad0202 = ''
       LET l_glad021 = ''  LET l_glad0211 =''  LET l_glad0212 = '' LET l_glad022 = ''  LET l_glad0221 = ''  LET l_glad0222 = ''
       LET l_glad023 = ''  LET l_glad0231 =''  LET l_glad0232 = '' LET l_glad024 = ''  LET l_glad0241 = ''  LET l_glad0242 = ''
       LET l_glad025 = ''  LET l_glad0251 =''  LET l_glad0252 = '' LET l_glad026 = ''  LET l_glad0261 = ''  LET l_glad0262 = ''
       #2.重新依账套，科目抓取核算项管理值
       SELECT glad007,glad008,glad009,glad010,glad027,glad011,glad012,glad013,glad015,glad016,
              glad031,glad032,glad033,
              glad017,glad0171,glad0172,glad018,glad0181,glad0182,glad019,glad0191,glad0192,
              glad020,glad0201,glad0202,glad021,glad0211,glad0212,glad022,glad0221,glad0222,
              glad023,glad0231,glad0232,glad024,glad0241,glad0242,glad025,glad0251,glad0252,
              glad026,glad0261,glad0262              
         INTO l_glad007,l_glad008,l_glad009,l_glad010,l_glad027,l_glad011,l_glad012,l_glad013,l_glad015,l_glad016,
              l_glad031,l_glad032,l_glad033,
              l_glad017,l_glad0171,l_glad0172,l_glad018,l_glad0181,l_glad0182,l_glad019,l_glad0191,l_glad0192,
              l_glad020,l_glad0201,l_glad0202,l_glad021,l_glad0211,l_glad0212,l_glad022,l_glad0221,l_glad0222,
              l_glad023,l_glad0231,l_glad0232,l_glad024,l_glad0241,l_glad0242,l_glad025,l_glad0251,l_glad0252,
              l_glad026,l_glad0261,l_glad0262
         FROM glad_t
       WHERE gladent = g_enterprise
         AND gladld = p_glaxld
         AND glad001 = g_glax.glax002
       #======================================
       #固定核算项检查
       #如果启用改固定核算项勾选，则对该核算项的值进行检查
       #======================================  
       #該科目做部門管理時，部門不可空白  
       IF l_glad007 = 'Y' THEN
          IF cl_null(g_glax.glax018) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax018',l_errmsg,'','agl-00043',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code = 'agl-00043'
             LET g_errparam.popup = TRUE
             CALL cl_err()
          ELSE
             #部门检查          
             CALL s_department_chk(g_glax.glax018,l_glaxdocdt) RETURNING l_success
             IF NOT l_success THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax018',l_errmsg,'',g_errno,1)
                LET l_errmsg = l_msg||'/'||g_glax.glax018
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code = g_errno
                #160321-00016#19 --s add
                LET g_errparam.replace[1] = 'aooi125'
                LET g_errparam.replace[2] = cl_get_progname('aooi125',g_lang,"2")
                LET g_errparam.exeprog = 'aooi125'
                #160321-00016#19 --e add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF
          END IF   
       END IF
      
       #該科目做利潤成本管理時，利潤成本不可空白  
       IF l_glad008 = 'Y' THEN
          IF cl_null(g_glax.glax019) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax019',l_errmsg,'','agl-00044',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code = 'agl-00044'
             LET g_errparam.popup = TRUE
             CALL cl_err()
          ELSE
             #利润成本中心检查 
             CALL s_voucher_glaq019_chk(g_glax.glax019,l_glaxdocdt)
             IF NOT cl_null(g_errno) THEN
               LET r_success = FALSE
#                CALL cl_errmsg('glax019',l_errmsg,'',g_errno,1)
                LET l_errmsg = l_msg||'/'||g_glax.glax019
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code = g_errno
                #160321-00016#19 --s add
                LET g_errparam.replace[1] = 'aooi125'
                LET g_errparam.replace[2] = cl_get_progname('aooi125',g_lang,"2")
                LET g_errparam.exeprog = 'aooi125'
                #160321-00016#19 --e add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF 
          END IF
       END IF 
       
       #該科目做區域管理時，區域不可空白  
       IF l_glad009 = 'Y' THEN
          IF cl_null(g_glax.glax020) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax020',l_errmsg,'','agl-00045',1) 
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code = 'agl-00045'
             LET g_errparam.popup = TRUE
             CALL cl_err()
          ELSE 
             #区域检查
             CALL s_azzi650_chk_exist('287',g_glax.glax020) RETURNING l_success
             IF NOT l_success THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax020',l_errmsg,'',g_errno,1)
#                LET l_errmsg = l_msg||'/'||g_glax.glax020
#                INITIALIZE g_errparam TO NULL
#                LET g_errparam.extend = l_errmsg
#                LET g_errparam.code = g_errno
#                LET g_errparam.popup = TRUE
#                CALL cl_err()
             END IF
          END IF
       END IF 
       
       #該科目做交易客商管理時，客商不可空白  
       IF l_glad010 = 'Y' THEN
          IF cl_null(g_glax.glax021) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax021',l_errmsg,'','agl-00046',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code = 'agl-00046'
             LET g_errparam.popup = TRUE
             CALL cl_err()
          ELSE
             #客商检查
             CALL s_voucher_glaq021_chk(g_glax.glax021)
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax021',l_errmsg,'',g_errno,1)
                LET l_errmsg = l_msg||'/'||g_glax.glax021
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code = g_errno
                #160321-00016#19 --s add
                LET g_errparam.replace[1] = 'apmm100'
                LET g_errparam.replace[2] = cl_get_progname('apmm100',g_lang,"2")
                LET g_errparam.exeprog = 'apmm100'
                #160321-00016#19 --e add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF
          END IF
       END IF 
       
       #該科目做账款客商管理時，客商不可空白
       IF l_glad027 = 'Y' THEN
          IF cl_null(g_glax.glax022) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax022',l_errmsg,'','agl-00046',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code = 'axr-00215'
             LET g_errparam.popup = TRUE
             CALL cl_err()
          ELSE
             #客商检查
             CALL s_voucher_glaq021_chk(g_glax.glax022)
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax022',l_errmsg,'',g_errno,1)
                LET l_errmsg = l_msg||'/'||g_glax.glax022
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code = g_errno
                #160321-00016#19 --s add
                LET g_errparam.replace[1] = 'apmm100'
                LET g_errparam.replace[2] = cl_get_progname('apmm100',g_lang,"2")
                LET g_errparam.exeprog = 'apmm100'
                #160321-00016#19 --e add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF  
          END IF
       END IF 
       #該科目做客群管理時，客群不可空白  
       IF l_glad011 = 'Y' THEN
          IF cl_null(g_glax.glax023) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax023',l_errmsg,'','agl-00047',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code = 'agl-00047'
             LET g_errparam.popup = TRUE
             CALL cl_err()
          ELSE
             #区域检查
             CALL s_azzi650_chk_exist('281',g_glax.glax023) RETURNING l_success
             IF NOT l_success THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax023',l_errmsg,'',g_errno,1)
#                LET l_errmsg = l_msg||'/'||g_glax.glax023
#                INITIALIZE g_errparam TO NULL
#                LET g_errparam.extend = l_errmsg
#                LET g_errparam.code = g_errno
#                LET g_errparam.popup = TRUE
#                CALL cl_err()
             END IF                     
          END IF
       END IF 
       
       #該科目做產品分類管理時，不可空白  
       IF l_glad012 = 'Y' THEN
          IF cl_null(g_glax.glax024) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax024',l_errmsg,'','agl-00068',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code = 'agl-00068'
             LET g_errparam.popup = TRUE
             CALL cl_err()
          ELSE
             #产品分类检查 
             CALL s_voucher_glaq024_chk(g_glax.glax024)
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax024',l_errmsg,'',g_errno,1)
                LET l_errmsg = l_msg||'/'||g_glax.glax024
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code = g_errno
                #160321-00016#19 --s add
                LET g_errparam.replace[1] = 'arti202'
                LET g_errparam.replace[2] = cl_get_progname('arti202',g_lang,"2")
                LET g_errparam.exeprog = 'arti202'
                #160321-00016#19 --e add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF
          END IF             
       END IF 
       
       #該科目做經營方式管理時，不可空白  
       IF l_glad031 = 'Y' THEN
          IF cl_null(g_glax.glax061) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax061',l_errmsg,'','agl-00286',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code = 'agl-00286'
             LET g_errparam.popup = TRUE
             CALL cl_err()
          ELSE
             #經營方式检查 
             CALL s_voucher_glaq051_chk(g_glax.glax061)
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax061',l_errmsg,'',g_errno,1)
                LET l_errmsg = l_msg||'/'||g_glax.glax061
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code = g_errno
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF
          END IF
       END IF 
       
       #該科目做渠道管理時，不可空白  
       IF l_glad032 = 'Y' THEN
          IF cl_null(g_glax.glax062) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax062',l_errmsg,'','agl-00287',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code = 'agl-00287'
             LET g_errparam.popup = TRUE
             CALL cl_err()
          ELSE
             #渠道检查 
             CALL s_voucher_glaq052_chk(g_glax.glax062)
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax062',l_errmsg,'',g_errno,1)
                LET l_errmsg = l_msg||'/'||g_glax.glax062
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code = g_errno
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF
          END IF             
       END IF 
       
       #該科目做品牌管理時，不可空白  
       IF l_glad033 = 'Y' THEN
          IF cl_null(g_glax.glax063) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax063',l_errmsg,'','agl-00288',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code = 'agl-00288'
             LET g_errparam.popup = TRUE
             CALL cl_err()
          ELSE
             #品牌检查 
             CALL s_azzi650_chk_exist('2002',g_glax.glax063) RETURNING l_success
             IF NOT l_success THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax063',l_errmsg,'',g_errno,1)
                LET l_errmsg = l_msg||'/'||g_glax.glax063
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code = g_errno
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF
          END IF
       END IF 
       
       #該科目做人員管理時，不可空白  
       IF l_glad013 = 'Y' THEN
          IF cl_null(g_glax.glax025) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax025',l_errmsg,'','agl-00069',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code = 'agl-00069'
             LET g_errparam.popup = TRUE
             CALL cl_err()
          ELSE 
             #人员检查
             CALL s_employee_chk(g_glax.glax025) RETURNING l_success
             IF NOT l_success THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax025',l_errmsg,'',g_errno,1)
#                LET l_errmsg = l_msg||'/'||g_glax.glax025
#                INITIALIZE g_errparam TO NULL
#                LET g_errparam.extend = l_errmsg
#                LET g_errparam.code = g_errno
#                LET g_errparam.popup = TRUE
#                CALL cl_err()
             END IF
          END IF
       END IF 
       
#       #該科目做預算管理時，不可空白  
#       IF l_glad014 = 'Y' THEN
#          IF cl_null(g_glax.glax026) THEN
#             LET r_success = FALSE
#            CALL cl_errmsg('glax026',l_errmsg,'','agl-00070',1)
#          END IF
#          #预算检查
#          CALL s_voucher_glaq026_chk(g_glax.glax026)
#          IF NOT cl_null(g_errno) THEN
#             LET r_success = FALSE
#             CALL cl_errmsg('glax026',l_errmsg,'',g_errno,1)
#          END IF           
#       END IF
       
       #該科目做專案管理時，不可空白  
       IF l_glad015 = 'Y' THEN
          IF cl_null(g_glax.glax027) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax027',l_errmsg,'','agl-00071',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code = 'agl-00071'
             LET g_errparam.popup = TRUE
             CALL cl_err()
          ELSE
             CALL s_aap_project_chk(g_glax.glax027) RETURNING l_success,g_errno
             IF NOT l_success THEN
                LET r_success = FALSE
                LET l_errmsg = l_msg||'/'||g_glax.glax027
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = g_errno
                LET g_errparam.extend = l_errmsg
                #160321-00016#19 --s add
                LET g_errparam.replace[1] = 'apjm200'
                LET g_errparam.replace[2] = cl_get_progname('apjm200',g_lang,"2")
                LET g_errparam.exeprog = 'apjm200'
                #160321-00016#19 --e add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF
          END IF 
       END IF 
       
       #該科目做WBS管理時，不可空白  
       IF l_glad016 = 'Y' THEN
          IF cl_null(g_glax.glax028) THEN
             LET r_success = FALSE
#             CALL cl_errmsg('glax028',l_errmsg,'','agl-00072',1)
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code = 'agl-00072'
             LET g_errparam.popup = TRUE
             CALL cl_err()
          ELSE
             CALL s_voucher_glaq028_chk(g_glax.glax027,g_glax.glax028) 
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
                LET l_errmsg = l_msg||'/'||g_glax.glax028
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = g_errno
                LET g_errparam.extend = l_errmsg
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF
          END IF 
       END IF
       
       #160729-00009#1--add--str--
       #对14个固定核算项进行检核是否满足agli060的设限条件
       LET l_hsx[1]=g_glax.glax017
       LET l_hsx[2]=g_glax.glax018
       LET l_hsx[3]=g_glax.glax019
       LET l_hsx[4]=g_glax.glax020
       LET l_hsx[5]=g_glax.glax021
       LET l_hsx[6]=g_glax.glax022
       LET l_hsx[7]=g_glax.glax023
       LET l_hsx[8]=g_glax.glax024
       LET l_hsx[9]=g_glax.glax061
       LET l_hsx[10]=g_glax.glax062
       LET l_hsx[11]=g_glax.glax063
       LET l_hsx[12]=g_glax.glax025
       LET l_hsx[13]=g_glax.glax027
       LET l_hsx[14]=g_glax.glax028
       CALL s_voucher_all_hsx_chk(p_glaxld,g_glax.glax002,l_hsx) RETURNING l_success
       IF l_success = FALSE THEN
          LET r_success = FALSE
       END IF
       #160729-00009#1--add--end
       
       #===================================================
       #自由核算项检查
       #如果启用该核算项勾选，并且控制方式不为1：允许空白，则对核算项的值进行检查
       #===================================================
       #核算项一
       IF l_glad017 = 'Y' THEN
          IF l_glad0172<>'1' THEN
             IF cl_null(g_glax.glax029) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax029',l_errmsg,'','agl-00074',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'agl-00074'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF
          END IF
          IF NOT cl_null(g_glax.glax029) THEN          
             CALL s_voucher_free_account_chk(l_glad0171,g_glax.glax029,l_glad0172) RETURNING l_errno
             IF NOT cl_null(l_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax029',l_errmsg,'',l_errno,1)
                LET l_errmsg = l_msg||'/'||g_glax.glax029
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code = l_errno
                #160321-00016#19 --s add
                IF l_errno = 'sub-01302' THEN
                   LET g_errparam.replace[1] = 'agli041'
                   LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                   LET g_errparam.exeprog = 'agli041'
                END IF
                #160321-00016#19 --e add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF 
           END IF   
       END IF 
       #核算项二
       IF l_glad018 = 'Y'  THEN
          IF l_glad0182 <>'1' THEN 
             IF cl_null(g_glax.glax030) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax030',l_errmsg,'','agl-00075',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'agl-00075'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF
          END IF
          IF NOT cl_null(g_glax.glax030) THEN          
             CALL s_voucher_free_account_chk(l_glad0181,g_glax.glax030,l_glad0182) RETURNING l_errno
             IF NOT cl_null(l_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax030',l_errmsg,'',l_errno,1)
                LET l_errmsg = l_msg||'/'||g_glax.glax030
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code = l_errno
                #160321-00016#19 --s add
                IF l_errno = 'sub-01302' THEN
                   LET g_errparam.replace[1] = 'agli041'
                   LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                   LET g_errparam.exeprog = 'agli041'
                END IF
                #160321-00016#19 --e add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF 
          END IF    
       END IF
       #核算项三
       IF l_glad019 = 'Y'  THEN
          IF l_glad0192 <>'1'  THEN 
             IF cl_null(g_glax.glax031) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax031',l_errmsg,'','agl-00076',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'agl-00076'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF
          END IF   
          IF NOT cl_null(g_glax.glax031) THEN        
             CALL s_voucher_free_account_chk(l_glad0191,g_glax.glax031,l_glad0192) RETURNING l_errno
             IF NOT cl_null(l_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax031',l_errmsg,'',l_errno,1)
                LET l_errmsg = l_msg||'/'||g_glax.glax031
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code = l_errno
                #160321-00016#19 --s add
                IF l_errno = 'sub-01302' THEN
                   LET g_errparam.replace[1] = 'agli041'
                   LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                   LET g_errparam.exeprog = 'agli041'
                END IF
                #160321-00016#19 --e add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF 
          END IF    
       END IF 
       #核算项四
       IF l_glad020 = 'Y' THEN
          IF l_glad0202 <>'1' THEN
             IF cl_null(g_glax.glax032) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax032',l_errmsg,'','agl-00077',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'agl-00077'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF   
          END IF
          IF NOT cl_null(g_glax.glax032) THEN
             CALL s_voucher_free_account_chk(l_glad0201,g_glax.glax032,l_glad0202) RETURNING l_errno
             IF NOT cl_null(l_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax032',l_errmsg,'',l_errno,1)
                LET l_errmsg = l_msg||'/'||g_glax.glax032
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code = l_errno
                #160321-00016#19 --s add
                IF l_errno = 'sub-01302' THEN
                   LET g_errparam.replace[1] = 'agli041'
                   LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                   LET g_errparam.exeprog = 'agli041'
                END IF
                #160321-00016#19 --e add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF 
          END IF    
       END IF
       #核算项五
       IF l_glad021 = 'Y'  THEN
          IF l_glad0212 <>'1' THEN
             IF cl_null(g_glax.glax033) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax033',l_errmsg,'','agl-00078',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'agl-00078'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF
          END IF
          IF NOT cl_null(g_glax.glax033) THEN
             CALL s_voucher_free_account_chk(l_glad0211,g_glax.glax033,l_glad0212) RETURNING l_errno
             IF NOT cl_null(l_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax033',l_errmsg,'',l_errno,1)
                LET l_errmsg = l_msg||'/'||g_glax.glax033
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code = l_errno
                #160321-00016#19 --s add
                IF l_errno = 'sub-01302' THEN
                   LET g_errparam.replace[1] = 'agli041'
                   LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                   LET g_errparam.exeprog = 'agli041'
                END IF
                #160321-00016#19 --e add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF 
          END IF    
       END IF 
        #核算项六
       IF l_glad022 = 'Y'  THEN
          IF l_glad0222 <>'1' THEN 
             IF cl_null(g_glax.glax034) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax034',l_errmsg,'','agl-00079',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'agl-00079'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF 
          END IF
          IF NOT cl_null(g_glax.glax034) THEN          
             CALL s_voucher_free_account_chk(l_glad0221,g_glax.glax034,l_glad0222) RETURNING l_errno
             IF NOT cl_null(l_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax034',l_errmsg,'',l_errno,1)
                LET l_errmsg = l_msg||'/'||g_glax.glax034
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code = l_errno
                #160321-00016#19 --s add
                IF l_errno = 'sub-01302' THEN
                   LET g_errparam.replace[1] = 'agli041'
                   LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                   LET g_errparam.exeprog = 'agli041'
                END IF
                #160321-00016#19 --e add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF
          END IF           
       END IF 
       #核算项七
       IF l_glad023 = 'Y'  THEN
          IF l_glad0232 <>'1' THEN 
             IF cl_null(g_glax.glax035) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax035',l_errmsg,'','agl-00080',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'agl-00080'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF  
          END IF
          IF NOT cl_null(g_glax.glax035) THEN          
             CALL s_voucher_free_account_chk(l_glad0231,g_glax.glax035,l_glad0232) RETURNING l_errno
             IF NOT cl_null(l_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax035',l_errmsg,'',l_errno,1)
                LET l_errmsg = l_msg||'/'||g_glax.glax035
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code = l_errno
                #160321-00016#19 --s add
                IF l_errno = 'sub-01302' THEN
                   LET g_errparam.replace[1] = 'agli041'
                   LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                   LET g_errparam.exeprog = 'agli041'
                END IF
                #160321-00016#19 --e add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF
          END IF           
       END IF
       #核算项八
       IF l_glad024 = 'Y'  THEN
          IF l_glad0242 <>'1' THEN 
             IF cl_null(g_glax.glax036) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax036',l_errmsg,'','agl-00081',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'agl-000831'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF 
          END IF
          IF NOT cl_null(g_glax.glax036) THEN           
             CALL s_voucher_free_account_chk(l_glad0241,g_glax.glax036,l_glad0242) RETURNING l_errno
             IF NOT cl_null(l_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax036',l_errmsg,'',l_errno,1)
                LET l_errmsg = l_msg||'/'||g_glax.glax036
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code = l_errno
                #160321-00016#19 --s add
                IF l_errno = 'sub-01302' THEN
                   LET g_errparam.replace[1] = 'agli041'
                   LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                   LET g_errparam.exeprog = 'agli041'
                END IF
                #160321-00016#19 --e add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF 
          END IF 
       END IF 
       #核算项九
       IF l_glad025 = 'Y'  THEN
          IF l_glad0252 <>'1' THEN 
             IF cl_null(g_glax.glax037) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax037',l_errmsg,'','agl-00082',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'agl-00082'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF 
          END IF
          IF NOT cl_null(g_glax.glax037) THEN          
             CALL s_voucher_free_account_chk(l_glad0251,g_glax.glax037,l_glad0252) RETURNING l_errno
             IF NOT cl_null(l_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax037',l_errmsg,'',l_errno,1)
                LET l_errmsg = l_msg||'/'||g_glax.glax037
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code = l_errno
                #160321-00016#19 --s add
                IF l_errno = 'sub-01302' THEN
                   LET g_errparam.replace[1] = 'agli041'
                   LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                   LET g_errparam.exeprog = 'agli041'
                END IF
                #160321-00016#19 --e add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF
          END IF           
       END IF        
       #核算项十
       IF l_glad026 = 'Y'  THEN
          IF l_glad0262 <>'1' THEN 
             IF cl_null(g_glax.glax038) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax038',l_errmsg,'','agl-00083',1)
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_msg1
                LET g_errparam.code = 'agl-00083'
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF  
          END IF
          IF NOT cl_null(g_glax.glax038) THEN        
             CALL s_voucher_free_account_chk(l_glad0261,g_glax.glax038,l_glad0262) RETURNING l_errno
             IF NOT cl_null(l_errno) THEN
                LET r_success = FALSE
#                CALL cl_errmsg('glax038',l_errmsg,'',l_errno,1)
                LET l_errmsg = l_msg||'/'||g_glax.glax038
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code = l_errno
                #160321-00016#19 --s add
                IF l_errno = 'sub-01302' THEN
                   LET g_errparam.replace[1] = 'agli041'
                   LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                   LET g_errparam.exeprog = 'agli041'
                END IF
                #160321-00016#19 --e add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF 
          END IF 
       END IF         
   END FOREACH
    RETURN r_success
################################################################################
END FUNCTION
# Descriptions...: 细项立冲确认更新
# Memo...........:
# Usage..........: CALL s_voucher_conf_upd_glax (传入参数)
#                  RETURNING 回传参数
# Input parameter: p_glaxls       帐别
#                : p_glaxdocno    传票单号
# Return code....: r_success      执行状态
#               
# Date & Author..: 2014/01/08 By minpp
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_conf_upd_glax(p_glaxld,p_glaxdocno)
   DEFINE p_glaxld         LIKE glax_t.glaxld         #帐别
   DEFINE p_glaxdocno      LIKE glax_t.glaxdocno      #傳票編號
   DEFINE r_success        LIKE type_t.num5
   DEFINE l_today          DATETIME YEAR TO SECOND
   
   WHENEVER ERROR CONTINUE

   LET r_success  = TRUE
   LET l_today  = cl_get_current()
   #检查完毕，更新狀態碼=已確認,確認人=登入user,確認日期=g_today
   UPDATE glax_t SET glaxstus = 'Y',
                     glaxcnfid = g_user,
                     glaxcnfdt = l_today
               WHERE glaxent = g_enterprise
                 AND glaxld = p_glaxld
                 AND glaxdocno = p_glaxdocno
    IF SQLCA.SQLCODE THEN
       LET r_success = FALSE
#       CALL cl_errmsg('glaxstus',p_glaxdocno,'Y',sqlca.sqlcode,1)
       INITIALIZE g_errparam TO NULL
       LET g_errparam.extend = p_glaxdocno
       LET g_errparam.code = sqlca.sqlcode
       LET g_errparam.popup = TRUE
       CALL cl_err()
    END IF 
    RETURN r_success
################################################################################
END FUNCTION
# Descriptions...: 启用固定核算项检查
# Memo...........:
# Usage..........: CALL s_voucher_fix_acc_open_chk(p_ld,p_subj)
#                  RETURNING 回传参数
# Input parameter: p_ld      帐别 
#                : p_subj    科目
# Return code....: r_glad007   部门
#                ：r_glad008   成本利润中心
#                ：r_glad009   区域管理
#                ：r_glad010   交易客商
#                ：r_glad027   账款客商
#                ：r_glad011   客群
#                ：r_glad012   产品类别
#                ：r_glad013   人员管理
#                ：r_glad015   专案管理
#                ：r_glad016   WBS管理 
#                ：r_glad031   經營方式管理
#                ：r_glad032   渠道管理
#                ：r_glad033   品牌管理               
# Date & Author..: 2014/01/23  By minpp
# Modify.........: 2014/10/13  By 02599 去除參數p_glaa004科目參照表號，去除預算管理，增加經營方式管理、渠道管理、品牌管理
################################################################################
PUBLIC FUNCTION s_voucher_fix_acc_open_chk(p_ld,p_subj)
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE p_subj          LIKE glaq_t.glaq002
#   DEFINE p_glaa004       LIKE glaa_t.glaa004
   #科目核算项
   DEFINE r_glad007       LIKE glad_t.glad007
   DEFINE r_glad008       LIKE glad_t.glad008
   DEFINE r_glad009       LIKE glad_t.glad009
   DEFINE r_glad010       LIKE glad_t.glad010
   DEFINE r_glad027       LIKE glad_t.glad027
   DEFINE r_glad011       LIKE glad_t.glad011
   DEFINE r_glad012       LIKE glad_t.glad012
   DEFINE r_glad013       LIKE glad_t.glad013
#   DEFINE r_glad014       LIKE glad_t.glad014
   DEFINE r_glad015       LIKE glad_t.glad015
   DEFINE r_glad016       LIKE glad_t.glad016
   DEFINE r_glad031       LIKE glad_t.glad031
   DEFINE r_glad032       LIKE glad_t.glad032
   DEFINE r_glad033       LIKE glad_t.glad033
   DEFINE l_cnt           LIKE type_t.num5
   
   #2014/10/13----先規格調整，固定核算項全部抓取agli030中
#   LET l_cnt = 0
#   #agli020已加入核算项管理的勾选,未来应用都改成先抓agli030(细的),抓不到再抓agli020(粗的)
#   #==>glad_t 若找不到該科目  就到agli020裡去抓
#   SELECT COUNT(*) INTO l_cnt FROM glad_t
#    WHERE gladent = g_enterprise
#      AND gladld = p_ld
#      AND glad001 = p_subj
#   IF l_cnt <> 0 THEN   
    #依據帳別，科目編號，判斷該科目是否做部門管理，利潤成本中心管理，區域管理，客商管理，帳款客商管理，客群管理，產品類別，人員，專案，wbs管理，經營方式，渠道，品牌
    SELECT glad007,glad008,glad009,glad010,glad027,glad011,glad012,glad013,glad015,glad016,glad031,glad032,glad033 
      INTO r_glad007,r_glad008,r_glad009,r_glad010,r_glad027,r_glad011,r_glad012,r_glad013,r_glad015,r_glad016,r_glad031,r_glad032,r_glad033 
      FROM glad_t
    WHERE gladent = g_enterprise
      AND gladld = p_ld
      AND glad001 = p_subj
#   ELSE
#      #依據帳別，科目編號，判斷該科目是否做部門管理， 利潤成本中心管理，區域管理，客商管理，帳款客商管理，客群管理，產品類別，人員，預算，專案，wbs管理
#      SELECT glac017,glac018,glac019,glac020,glac027,glac021,glac022,glac023,glac024,glac025,glac026 
#        INTO r_glad007,r_glad008,r_glad009,r_glad010,r_glad027,r_glad011,r_glad012,r_glad013,r_glad014,r_glad015,r_glad016
#        FROM glac_t
#      WHERE glacent = g_enterprise
#        AND glac001 = p_glaa004
#        AND glac002 = p_subj
#   END IF 
   #如果核算项没有启用，则不需开出子视窗  
   RETURN r_glad007,r_glad008,r_glad009,r_glad010,r_glad027,r_glad011,r_glad012,r_glad013,r_glad015,r_glad016,r_glad031,r_glad032,r_glad033
#====================================================================
END FUNCTION
#組合要素=交易幣別及固定核算項及自由核算項的字元組合(核算項未啟用者略過),
#為檔案key值之一,並為後續程序調用之便,各要素欄位同步記錄於本檔的表格內
#例:當筆傳票單身科目設置啟用固定核算項部門及人員兩項
#         則組合要素欄位內容值=NTDDS1DC030000086
#                              NTD=交易幣別
#                              DS1=營運據點(系統固定啟用)
#                              DC0300=部門(科目檔勾選啟用該核算項)
#                              00086=人員(科目檔勾選啟用該核算項)
#===========================================================================
PUBLIC FUNCTION s_voucher_glar004()
   DEFINE l_glar004       LIKE glar_t.glar004
   #固定核算项
   DEFINE l_glad007       LIKE glad_t.glad007     #部門管理否
   DEFINE l_glad008       LIKE glad_t.glad008     #利潤成本中心管理
   DEFINE l_glad009       LIKE glad_t.glad009     #區域管理
   DEFINE l_glad010       LIKE glad_t.glad010     #交易客商管理
   DEFINE l_glad027       LIKE glad_t.glad027     #账款客商管理
   DEFINE l_glad011       LIKE glad_t.glad011     #客群管理否
   DEFINE l_glad012       LIKE glad_t.glad012     #產品類別
   DEFINE l_glad013       LIKE glad_t.glad013     #人員
#   DEFINE l_glad014       LIKE glad_t.glad014     #预算管理否
   DEFINE l_glad015       LIKE glad_t.glad015     #专案管理否
   DEFINE l_glad016       LIKE glad_t.glad016     #wbs管理
   DEFINE l_glad031       LIKE glad_t.glad031     #經營方式管理否
   DEFINE l_glad032       LIKE glad_t.glad032     #渠道管理否
   DEFINE l_glad033       LIKE glad_t.glad033     #品牌管理否
   #自由核算项
   DEFINE l_glad017       LIKE glad_t.glad017     #自由核算项一
   DEFINE l_glad018       LIKE glad_t.glad018     #自由核算项二
   DEFINE l_glad019       LIKE glad_t.glad019     #自由核算项三
   DEFINE l_glad020       LIKE glad_t.glad020     #自由核算项四
   DEFINE l_glad021       LIKE glad_t.glad021     #自由核算项五
   DEFINE l_glad022       LIKE glad_t.glad022     #自由核算项六
   DEFINE l_glad023       LIKE glad_t.glad023     #自由核算项七
   DEFINE l_glad024       LIKE glad_t.glad024     #自由核算项八
   DEFINE l_glad025       LIKE glad_t.glad025     #自由核算项九
   DEFINE l_glad026       LIKE glad_t.glad026     #自由核算项十
   
   #依據帳別，科目編號，判斷該科目是否做部門管理， 利潤成本中心管理，區域管理，
   #客商管理，账款客商管理,客群管理，產品類別，人員，預算，專案，wbs管理，經營方式，渠道，品牌,以及自由核算项
   #幣別、營運據點
   #161205-00025#4 mod 将显示组合码中的','-->'/'，
   #这样改的原因是：USING传入参数时会按照逗号分隔插入字符串，避免出现问题，不使用逗号作为间隔符
   LET l_glar004 = "glar009='",g_glaq.glaq005,"'/",
                   "glar012='",g_glaq.glaq017,"'/",
                   "glar013='",g_glaq.glaq018,"'/",
                   "glar014='",g_glaq.glaq019,"'/",
                   "glar015='",g_glaq.glaq020,"'/",
                   "glar016='",g_glaq.glaq021,"'/",
                   "glar017='",g_glaq.glaq022,"'/",
                   "glar018='",g_glaq.glaq023,"'/",
                   "glar019='",g_glaq.glaq024,"'/",
                   "glar051='",g_glaq.glaq051,"'/",
                   "glar052='",g_glaq.glaq052,"'/",
                   "glar053='",g_glaq.glaq053,"'/",
                   "glar020='",g_glaq.glaq025,"'/",
                   "glar022='",g_glaq.glaq027,"'/",
                   "glar023='",g_glaq.glaq028,"'/",
                   "glar024='",g_glaq.glaq029,"'/",
                   "glar025='",g_glaq.glaq030,"'/",
                   "glar026='",g_glaq.glaq031,"'/",
                   "glar027='",g_glaq.glaq032,"'/",
                   "glar028='",g_glaq.glaq033,"'/",
                   "glar029='",g_glaq.glaq034,"'/",
                   "glar030='",g_glaq.glaq035,"'/",
                   "glar031='",g_glaq.glaq036,"'/",
                   "glar032='",g_glaq.glaq037,"'/",
                   "glar033='",g_glaq.glaq038,"'"

#   #固定核算項
#   CALL s_voucher_fix_acc_open_chk(g_glaq.glaqld,g_glaq.glaq002)
#   RETURNING l_glad007,l_glad008,l_glad009,l_glad010,l_glad027,l_glad011,l_glad012,l_glad013,l_glad015,l_glad016,l_glad031,l_glad032,l_glad033
#     
#   #自由核算项
#   SELECT glad017,glad018,glad019,glad020,glad021,glad022,glad023,glad024,glad025,glad026
#     INTO l_glad017,l_glad018,l_glad019,l_glad020,l_glad021,l_glad022,l_glad023,l_glad024,l_glad025,l_glad026
#     FROM glad_t
#    WHERE gladent = g_enterprise
#      AND gladld = g_glaq.glaqld
#      AND glad001 = g_glaq.glaq002
#      
#   #該科目做部門管理時
#   IF l_glad007 = 'Y' THEN
#      IF cl_null(g_glaq.glaq018) THEN
#         LET g_glaq.glaq018 = ' '
#      END IF 
#      LET l_glar004 = l_glar004,",glar013='",g_glaq.glaq018,"'"
#   ELSE
#      LET l_glar004 = l_glar004       
#   END IF
#       
#   #該科目做利潤成本管理時
#   IF l_glad008 = 'Y' THEN
#      IF cl_null(g_glaq.glaq019) THEN
#         LET g_glaq.glaq019 = ' '
#      END IF
#      LET l_glar004 = l_glar004,",glar014='",g_glaq.glaq019,"'"
#   ELSE
#      LET l_glar004 = l_glar004       
#   END IF
#      
#   #該科目做區域管理時 
#   IF l_glad009 = 'Y' THEN
#      IF cl_null(g_glaq.glaq020) THEN
#         LET g_glaq.glaq020 = ' '
#      END IF
#      LET l_glar004 = l_glar004,",glar015='",g_glaq.glaq020,"'"
#   ELSE
#      LET l_glar004 = l_glar004       
#   END IF
#       
#   #做交易客商管理
#   IF l_glad010 = 'Y' THEN
#      IF cl_null(g_glaq.glaq021) THEN
#         LET g_glaq.glaq021 = ' '
#      END IF
#      LET l_glar004 = l_glar004,",glar016='",g_glaq.glaq021,"'"
#   ELSE
#      LET l_glar004 = l_glar004       
#   END IF
#       
#   #做账款客商管理
#   IF l_glad027 = 'Y' THEN
#      IF cl_null(g_glaq.glaq022) THEN
#         LET g_glaq.glaq022 = ' '
#      END IF
#      LET l_glar004 = l_glar004,",glar017='",g_glaq.glaq022,"'"
#   ELSE
#      LET l_glar004 = l_glar004       
#   END IF  
#       
#   #該科目做客群管理時
#   IF l_glad011 = 'Y' THEN
#      IF cl_null(g_glaq.glaq023) THEN
#         LET g_glaq.glaq023 = ' '
#      END IF
#      LET l_glar004 = l_glar004,",glar018='",g_glaq.glaq023,"'"
#   ELSE
#      LET l_glar004 = l_glar004       
#   END IF
#       
#   #該科目做產品分類管理時，不可空白  
#   IF l_glad012 = 'Y' THEN
#      IF cl_null(g_glaq.glaq024) THEN
#         LET g_glaq.glaq024 = ' '
#      END IF
#      LET l_glar004 = l_glar004,",glar019='",g_glaq.glaq024,"'"
#   ELSE
#      LET l_glar004 = l_glar004       
#   END IF
#      
#   #該科目做經營方式管理時，不可空白  
#   IF l_glad031 = 'Y' THEN
#      IF cl_null(g_glaq.glaq051) THEN
#         LET g_glaq.glaq051 = ' '
#      END IF       
#      LET l_glar004 = l_glar004,",glar051='",g_glaq.glaq051,"'"
#   ELSE
#      LET l_glar004 = l_glar004       
#   END IF
#   
#   #該科目做渠道管理時，不可空白  
#   IF l_glad032 = 'Y' THEN
#      IF cl_null(g_glaq.glaq052) THEN
#         LET g_glaq.glaq052 = ' '
#      END IF       
#      LET l_glar004 = l_glar004,",glar052='",g_glaq.glaq052,"'"
#   ELSE
#      LET l_glar004 = l_glar004       
#   END IF
#   
#   #該科目做品牌管理時，不可空白  
#   IF l_glad033 = 'Y' THEN
#      IF cl_null(g_glaq.glaq053) THEN
#         LET g_glaq.glaq053 = ' '
#      END IF       
#      LET l_glar004 = l_glar004,",glar053='",g_glaq.glaq053,"'"
#   ELSE
#      LET l_glar004 = l_glar004       
#   END IF
#      
#   #該科目做人員管理時，不可空白  
#   IF l_glad013 = 'Y' THEN
#      IF cl_null(g_glaq.glaq025) THEN
#         LET g_glaq.glaq025 = ' '
#      END IF
#      LET l_glar004 = l_glar004,",glar020='",g_glaq.glaq025,"'"
#   ELSE
#      LET l_glar004 = l_glar004       
#   END IF
#      
##   #該科目做預算管理時，不可空白  
##   IF l_glad014 = 'Y' THEN
##      IF cl_null(g_glaq.glaq026) THEN
##         LET g_glaq.glaq026 = ' '
##      END IF       
##      LET l_glar004 = l_glar004,",glar021='",g_glaq.glaq026,"'"
##   ELSE
##      LET l_glar004 = l_glar004       
##   END IF
#      
#   #該科目做專案管理時，不可空白  
#   IF l_glad015 = 'Y' THEN
#      IF cl_null(g_glaq.glaq027) THEN
#         LET g_glaq.glaq027 = ' '
#      END IF
#      LET l_glar004 = l_glar004,",glar022='",g_glaq.glaq027,"'"
#   ELSE
#      LET l_glar004 = l_glar004       
#   END IF
#   #該科目做WBS管理時，不可空白  
#   IF l_glad016 = 'Y' THEN
#      IF cl_null(g_glaq.glaq028) THEN
#         LET g_glaq.glaq028 = ' '
#      END IF
#      LET l_glar004 = l_glar004,",glar023='",g_glaq.glaq028,"'"
#   ELSE
#      LET l_glar004 = l_glar004       
#   END IF
#       
#   #该科目启用自由核算项一
#   IF l_glad017 = 'Y'  THEN 
#      IF cl_null(g_glaq.glaq029) THEN
#         LET g_glaq.glaq029 = ' '
#      END IF 
#      LET l_glar004 = l_glar004,",glar024='",g_glaq.glaq029,"'"
#   ELSE
#      LET l_glar004 = l_glar004 
#   END IF
#   
#   #该科目启用自由核算项二
#   IF l_glad018 = 'Y'  THEN
#      IF cl_null(g_glaq.glaq030) THEN
#         LET g_glaq.glaq030 = ' '
#      END IF 
#      LET l_glar004 = l_glar004,",glar025='",g_glaq.glaq030,"'"
#   ELSE
#      LET l_glar004 = l_glar004 
#   END IF
#
#   #该科目启用自由核算项三
#   IF l_glad019 = 'Y'  THEN
#      IF cl_null(g_glaq.glaq031) THEN
#         LET g_glaq.glaq031 = ' '
#      END IF 
#      LET l_glar004 = l_glar004,",glar026='",g_glaq.glaq031,"'"
#   ELSE
#      LET l_glar004 = l_glar004 
#   END IF
#   
#   #该科目启用自由核算项四
#   IF l_glad020 = 'Y'  THEN
#      IF cl_null(g_glaq.glaq032) THEN
#         LET g_glaq.glaq032 = ' '
#      END IF 
#      LET l_glar004 = l_glar004,",glar027='",g_glaq.glaq032,"'"
#   ELSE
#      LET l_glar004 = l_glar004 
#   END IF
#   
#    #该科目启用自由核算项五
#   IF l_glad021 = 'Y'  THEN
#      IF cl_null(g_glaq.glaq033) THEN
#         LET g_glaq.glaq033 = ' '
#      END IF 
#      LET l_glar004 = l_glar004,",glar028='",g_glaq.glaq033,"'"
#   ELSE
#      LET l_glar004 = l_glar004 
#   END IF
#   
#   #该科目启用自由核算项六
#   IF l_glad022 = 'Y'  THEN
#      IF cl_null(g_glaq.glaq034) THEN
#         LET g_glaq.glaq034 = ' '
#      END IF 
#      LET l_glar004 = l_glar004,",glar029='",g_glaq.glaq034,"'"
#   ELSE
#      LET l_glar004 = l_glar004 
#   END IF
#       
#   #该科目启用自由核算项七
#   IF l_glad023 = 'Y'  THEN
#      IF cl_null(g_glaq.glaq035) THEN
#         LET g_glaq.glaq035 = ' '
#      END IF 
#      LET l_glar004 = l_glar004,",glar030='",g_glaq.glaq035,"'"
#   ELSE
#      LET l_glar004 = l_glar004 
#   END IF
#   
#   #该科目启用自由核算项八
#   IF l_glad024 = 'Y'  THEN
#      IF cl_null(g_glaq.glaq036) THEN
#         LET g_glaq.glaq036 = ' '
#      END IF 
#      LET l_glar004 = l_glar004,",glar031='",g_glaq.glaq036,"'"
#   ELSE
#      LET l_glar004 = l_glar004 
#   END IF
#   
#   #该科目启用自由核算项九
#   IF l_glad025 = 'Y'  THEN
#      IF cl_null(g_glaq.glaq037) THEN
#         LET g_glaq.glaq037 = ' '
#      END IF 
#      LET l_glar004 = l_glar004,",glar032='",g_glaq.glaq037,"'"
#   ELSE
#      LET l_glar004 = l_glar004 
#   END IF
#       
#   #该科目启用自由核算项十
#   IF l_glad026 = 'Y'  THEN
#      IF cl_null(g_glaq.glaq038) THEN
#         LET g_glaq.glaq038 = ' '
#      END IF 
#      LET l_glar004 = l_glar004,",glar033='",g_glaq.glaq038,"'"
#   ELSE
#      LET l_glar004 = l_glar004 
#   END IF
   RETURN l_glar004
################################################################################
END FUNCTION
# Descriptions...: 细项立冲取消确认检查
# Memo...........:
# Usage..........: CALL s_voucher_unconf_chk_glax (传入参数)
#                  RETURNING 回传参数
# Input parameter: p_glaxls       帐别
#                : p_glaxdocno    传票单号
# Return code....: r_success      执行状态
#               
# Date & Author..: 2014/01/08 By minpp
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_unconf_chk_glax(p_glaxld,p_glaxdocno)
   DEFINE p_glaxld           LIKE glax_t.glaxld              #帐别
   DEFINE p_glaxdocno        LIKE glax_t.glaxdocno           #传票编号
   DEFINE r_success          LIKE type_t.num5                #檢核狀態
   DEFINE l_glaxstus         LIKE glax_t.glaxstus            #状态码
   DEFINE l_cnt              LIKE type_t.num5
   DEFINE l_glaxdocdt        LIKE glax_t.glaxdocdt
   DEFINE l_success          LIKE type_t.num5
   
   WHENEVER ERROR CONTINUE
   LET r_success = TRUE
   #资料检查
   #(1).传入参数为空，返回
   #170816-00007#130 by 09773 mod(S)
#   IF cl_null(p_glaxld) OR cl_null(p_glaxdocno) THEN
##      CALL cl_errmsg('unconf',p_glaxdocno,'','sub-00110',1)
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.extend = p_glaxdocno
#      LET g_errparam.code = 'sub-00110'
#      LET g_errparam.popup = TRUE
#      CALL cl_err()
#      LET r_success = FALSE
#   END IF
   #170816-00007#130 by 09773 mod(E)
   
   #170816-00007#130 by 09773 add(S)
   #修改錯誤訊息報錯內容
   LET g_msg = ''
   LET g_colname_1 = ''
   LET g_comment_1 = ''
   IF cl_null(p_glaxld) THEN
      CALL s_azzi902_get_gzzd("aapi511","lbl_glabld") RETURNING g_colname_1,g_comment_1  #賬套 
      LET g_msg = g_colname_1   
   END IF
   IF cl_null(p_glaxdocno) THEN
      LET g_colname_1 = ''
      LET g_comment_1 = ''    
      CALL s_azzi902_get_gzzd("aglt310_07","lbl_glapdocno") RETURNING g_colname_1,g_comment_1   #單號
      IF g_msg IS NULL THEN   
         LET g_msg = g_colname_1   
      ELSE   
         LET g_msg = g_msg,",",g_colname_1
      END IF        
   END IF
   IF NOT cl_null(g_msg) THEN
      LET r_success = FALSE
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaxdocno
      LET g_errparam.code = 'sub-00788'  #%1傳入值為空(錯誤)
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_msg 
      CALL cl_err()
   END IF   
   #170816-00007#130 by 09773 add(E)
   
   #(2).狀態碼=确认,才可進行確認動作
   SELECT glaxstus,glaxdocdt INTO l_glaxstus,l_glaxdocdt FROM glax_t
    WHERE glaxent = g_enterprise
      AND glaxld = p_glaxld
      AND glaxdocno = p_glaxdocno
   IF l_glaxstus <>'Y' THEN
#      CALL cl_errmsg('unconf',p_glaxdocno,'','agl-00053',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaxdocno
      LET g_errparam.code = 'agl-00053'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF 
   
   #2015/05/27--add--str--
   #檢查當單據日期小於等於關帳日期時，不可異動單據
   CALL s_fin_date_close_chk(p_glaxld,'','AGL',l_glaxdocdt) RETURNING l_success
   IF l_success = FALSE THEN
      LET r_success = FALSE
   END IF
   #2015/05/27--add--end
   
   #(3).未發生沖抵,才可進行確認動作
   #SELECT COUNT(*) INTO l_cnt FROM glax_t          #170615-00061#25 mark
   SELECT COUNT(glaxdocno) INTO l_cnt FROM glax_t   #170615-00061#25 add
    WHERE glaxent = g_enterprise
      AND glaxld = p_glaxld
      AND glaxdocno = p_glaxdocno
      AND (glax041>0 OR glax042>0)
   IF l_cnt>0 THEN
#      CALL cl_errmsg('unconf',p_glaxdocno,'','agl-00208',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaxdocno
      LET g_errparam.code = 'agl-00208'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF 
    RETURN r_success
################################################################################
END FUNCTION
# Descriptions...: 细项立冲取消确认更新
# Memo...........:
# Usage..........: CALL s_voucher_conf_upd_glax (传入参数)
#                  RETURNING 回传参数
# Input parameter: p_glaxls       帐别
#                : p_glaxdocno    传票单号
# Return code....: r_success      执行状态
#               
# Date & Author..: 2014/01/08 By minpp
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_unconf_upd_glax(p_glaxld,p_glaxdocno)
   DEFINE p_glaxld         LIKE glax_t.glaxld         #帐别
   DEFINE p_glaxdocno      LIKE glax_t.glaxdocno      #傳票編號
   DEFINE r_success        LIKE type_t.num5
   
   WHENEVER ERROR CONTINUE
   
   LET r_success  = TRUE
   #更新狀態碼=開立, 確認人=NULL,確認日期=NULL
    UPDATE glax_t SET glaxstus = 'N',
                     glaxcnfid = '',
                     glaxcnfdt = ''
               WHERE glaxent = g_enterprise
                 AND glaxld = p_glaxld
                 AND glaxdocno = p_glaxdocno
    IF SQLCA.SQLCODE THEN
       LET r_success = FALSE
#       CALL cl_errmsg('glaxstus',p_glaxdocno,'N',sqlca.sqlcode,1)
       INITIALIZE g_errparam TO NULL
       LET g_errparam.extend = p_glaxdocno
       LET g_errparam.code = sqlca.sqlcode
       LET g_errparam.popup = TRUE
       CALL cl_err()
    END IF 
    
    RETURN r_success
################################################################################
END FUNCTION
# Descriptions...: 细项立冲作废检查
# Memo...........:
# Usage..........: CALL s_voucher_conf_upd_glax (传入参数)
#                  RETURNING 回传参数
# Input parameter: p_glaxls       帐别
#                : p_glaxdocno    传票单号
# Return code....: r_success      执行状态
#               
# Date & Author..: 2014/01/08 By minpp
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_void_chk_glax(p_glaxld,p_glaxdocno)
   DEFINE p_glaxld           LIKE glax_t.glaxld              #帐别
   DEFINE p_glaxdocno        LIKE glax_t.glaxdocno           #传票编号
   DEFINE r_success          LIKE type_t.num5                #檢核狀態
   DEFINE l_cnt              LIKE type_t.num5
   DEFINE l_glaxdocdt        LIKE glax_t.glaxdocdt
   DEFINE l_success          LIKE type_t.num5
   
   WHENEVER ERROR CONTINUE
   LET r_success = TRUE
   #资料检查
   #(1).传入参数为空，返回
   #170816-00007#130 by 09773 mod(S)
#   IF cl_null(p_glaxld) OR cl_null(p_glaxdocno) THEN
##      CALL cl_errmsg('void',p_glaxdocno,'','sub-00110',1)
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.extend = p_glaxdocno
#      LET g_errparam.code = 'sub-00110'
#      LET g_errparam.popup = TRUE
#      CALL cl_err()
#      LET r_success = FALSE
#   END IF
   #170816-00007#130 by 09773 mod(E)
   
   #170816-00007#130 by 09773 add(S)
   #修改錯誤訊息報錯內容
   LET g_msg = ''
   LET g_colname_1 = ''
   LET g_comment_1 = ''
   IF cl_null(p_glaxld) THEN
      CALL s_azzi902_get_gzzd("aapi511","lbl_glabld") RETURNING g_colname_1,g_comment_1  #賬套 
      LET g_msg = g_colname_1   
   END IF
   IF cl_null(p_glaxdocno) THEN
      LET g_colname_1 = ''
      LET g_comment_1 = ''    
      CALL s_azzi902_get_gzzd("aglt310_07","lbl_glapdocno") RETURNING g_colname_1,g_comment_1   #單號
      IF g_msg IS NULL THEN   
         LET g_msg = g_colname_1   
      ELSE   
         LET g_msg = g_msg,",",g_colname_1
      END IF        
   END IF
   IF NOT cl_null(g_msg) THEN
      LET r_success = FALSE
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaxdocno
      LET g_errparam.code = 'sub-00788'  #%1傳入值為空(錯誤)
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_msg 
      CALL cl_err()
   END IF   
   #170816-00007#130 by 09773 add(E)
   
   #(2).狀態碼=确认,才可進行確認動作
   #SELECT COUNT(*) INTO l_cnt FROM glax_t         #170615-00061#25 mark
   SELECT COUNT(glaxdocno) INTO l_cnt FROM glax_t  #170615-00061#25 add
    WHERE glaxent = g_enterprise
      AND glaxld = p_glaxld
      AND glaxdocno = p_glaxdocno
      AND glaxstus<>'N'
   IF l_cnt>0 THEN
#      CALL cl_errmsg('void',p_glaxdocno,'','agl-00052',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaxdocno
      LET g_errparam.code = 'agl-00052'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF 
   
   RETURN r_success
################################################################################
END FUNCTION
# Descriptions...: 细项立冲作废更新
# Memo...........:
# Usage..........: CALL s_voucher_conf_upd_glax (传入参数)
#                  RETURNING 回传参数
# Input parameter: p_glaxls       帐别
#                : p_glaxdocno    传票单号
# Return code....: r_success      执行状态
#               
# Date & Author..: 2014/01/08 By minpp
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_void_upd_glax(p_glaxld,p_glaxdocno)
    DEFINE p_glaxld         LIKE glax_t.glaxld         #帐别
    DEFINE p_glaxdocno      LIKE glax_t.glaxdocno      #傳票編號
    DEFINE r_success     LIKE type_t.num5
    DEFINE l_today       DATETIME YEAR TO SECOND
    WHENEVER ERROR CONTINUE
    
    LET r_success  = TRUE
    LET l_today = cl_get_current()
    #更新狀態碼='X', 修改者=g_user,修改日期=g_today
    UPDATE glax_t SET glaxstus = 'X',
                      glaxmodid = g_user,
                      glaxmoddt = l_today
               WHERE glaxent = g_enterprise
                 AND glaxld = p_glaxld
                 AND glaxdocno = p_glaxdocno
    IF SQLCA.SQLCODE THEN
       LET r_success = FALSE
#       CALL cl_errmsg('glaxstus',p_glaxdocno,'X',sqlca.sqlcode,1)
       INITIALIZE g_errparam TO NULL
       LET g_errparam.extend = p_glaxdocno
       LET g_errparam.code = sqlca.sqlcode
       LET g_errparam.popup = TRUE
       CALL cl_err()
    END IF 
    RETURN r_success
################################################################################
END FUNCTION
# Descriptions...: 描述说明
# Memo...........: 檢查細項沖帳異動資料
# Usage..........: CALL s_voucher_void_chk_glay(p_glayld,p_glaydocno)
#                  RETURNING r_success
# Input parameter: p_glayld       帳套
#                : p_glaydocno    傳票編號
# Return code....: r_success      檢查結果
# Date & Author..: 14/02/13 By 02599
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_void_chk_glay(p_glayld,p_glaydocno)
   DEFINE p_glayld           LIKE glay_t.glayld              #帐别
   DEFINE p_glaydocno        LIKE glay_t.glaydocno           #传票编号
   DEFINE r_success          LIKE type_t.num5                #檢核狀態
   DEFINE l_cnt              LIKE type_t.num5                
   
   WHENEVER ERROR CONTINUE
   LET r_success = TRUE
   #资料检查
   #(1).传入参数为空，返回
   #170816-00007#130 by 09773 mod(S)
#   IF cl_null(p_glayld) OR cl_null(p_glaydocno) THEN
##      CALL cl_errmsg('void',p_glaydocno,'','sub-00110',1)
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.extend = p_glaydocno
#      LET g_errparam.code = 'sub-00110'
#      LET g_errparam.popup = TRUE
#      CALL cl_err()
#      LET r_success = FALSE
#   END IF 
   #170816-00007#130 by 09773 mod(E)
   
   #170816-00007#130 by 09773 add(S)
   #修改錯誤訊息報錯內容
   LET g_msg = ''
   LET g_colname_1 = ''
   LET g_comment_1 = ''
   IF cl_null(p_glayld) THEN
      CALL s_azzi902_get_gzzd("aapi511","lbl_glabld") RETURNING g_colname_1,g_comment_1  #賬套 
      LET g_msg = g_colname_1   
   END IF
   IF cl_null(p_glaydocno) THEN
      LET g_colname_1 = ''
      LET g_comment_1 = ''    
      CALL s_azzi902_get_gzzd("aglt310_07","lbl_glapdocno") RETURNING g_colname_1,g_comment_1   #單號
      IF g_msg IS NULL THEN   
         LET g_msg = g_colname_1   
      ELSE   
         LET g_msg = g_msg,",",g_colname_1
      END IF        
   END IF
   IF NOT cl_null(g_msg) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaydocno
      LET g_errparam.code = 'sub-00788'  #%1傳入值為空(錯誤)
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_msg 
      CALL cl_err()
      LET r_success = FALSE
   END IF   
   #170816-00007#130 by 09773 add(E)
   
   #(1).狀態碼=未确认,才可進行作廢動作
   #SELECT COUNT(*) INTO l_cnt FROM glay_t        #170615-00061#25 mark
   SELECT COUNT(glaydocno) INTO l_cnt FROM glay_t #170615-00061#25 add
    WHERE glayent = g_enterprise
      AND glayld = p_glayld
      AND glaydocno = p_glaydocno
      AND glaystus<>'N'
   IF l_cnt>0 THEN
#      CALL cl_errmsg('void',p_glaydocno,'','agl-00052',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaydocno
      LET g_errparam.code = 'agl-00052'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF 
    RETURN r_success
################################################################################
END FUNCTION
# Descriptions...: 自动产生凭证 定义CURSOR
# Memo...........:
# Usage..........: CALL s_voucher_gen_ar_1_def_cursor(p_ld,p_wc)
#                  RETURNING r_success
# Input parameter: p_ld           帐套
#                : p_wc           QBE条件(帐款来源)
#                : p_sum_type     汇总方式
# Return code....: r_success      成功否标识位
# Date & Author..: 2014/03/02 By Carrier
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_2_def_cursor(p_ld,p_wc,p_sum_type,p_date)
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE p_wc            LIKE type_t.chr1000
   DEFINE p_sum_type      LIKE type_t.chr1
   DEFINE r_success       LIKE type_t.num5
   DEFINE l_sql           STRING  
   DEFINE l_glaa004       LIKE glaa_t.glaa004   
   DEFINE l_field         STRING
   DEFINE l_field1        STRING
   DEFINE p_date          LIKE type_t.dat
   DEFINE l_xreb001       LIKE xreb_t.xreb001
   DEFINE l_xreb002       LIKE xreb_t.xreb002
   DEFINE l_8319_11       LIKE gzcb_t.gzcb002      #壞帳費用科目
   DEFINE l_8319_21       LIKE gzcb_t.gzcb002      #壞帳準備提列科目
   DEFINE l_8318_11       LIKE gzcb_t.gzcb002      #重評價匯兌收益科目
   DEFINE l_8318_12       LIKE gzcb_t.gzcb002      #重評價匯兌損失科目
   DEFINE l_glab005d      LIKE glab_t.glab005      #借方科目
   DEFINE l_glab005c      LIKE glab_t.glab005      #贷方科目
 
   
   WHENEVER ERROR CONTINUE
   LET r_success = FALSE 

   LET l_xreb001 = YEAR(p_date)
   LET l_xreb002 = MONTH(p_date)

   IF g_prog = 'axrt920' OR g_prog = 'anmt821' THEN   #170111-00055#1 add lujh axrp133效能优化
      SELECT glab005 INTO l_8318_11 FROM glab_t WHERE glabent = g_enterprise 
         AND glabld = p_ld
         AND glab002 = '8318'
         AND glab003 = '8318_11'
      
      SELECT glab005 INTO l_8318_12 FROM glab_t WHERE glabent = g_enterprise
         AND glabld = p_ld
         AND glab002 = '8318'
         AND glab003 = '8318_12'
         
      LET l_glab005d = l_8318_11 LET l_glab005c = l_8318_12   #170111-00055#1 add lujh axrp133效能优化
         
   END IF  #170111-00055#1 add lujh axrp133效能优化
      
   IF g_prog = 'axrt930' THEN   #170111-00055#1 add lujh axrp133效能优化
      SELECT glab005 INTO l_8319_11 FROM glab_t WHERE glabent = g_enterprise
         AND glabld = p_ld
         AND glab002 = '8319'
         AND glab003 = '8319_11'
      
      SELECT glab005 INTO l_8319_21 FROM glab_t WHERE glabent = g_enterprise
         AND glabld = p_ld
         AND glab002 = '8319'
         AND glab003 = '8319_21'
         
      LET l_glab005d = l_8319_11 LET l_glab005c = l_8319_21   #170111-00055#1 add lujh axrp133效能优化
   END IF   #170111-00055#1 add lujh axrp133效能优化

   #170111-00055#1--mark--str--lujh axrp133效能优化
   #IF g_prog = 'axrt920' THEN LET l_glab005d = l_8318_11 LET l_glab005c = l_8318_12 END IF
   #IF g_prog = 'anmt821' THEN LET l_glab005d = l_8318_11 LET l_glab005c = l_8318_12 END IF
   #IF g_prog = 'axrt930' THEN LET l_glab005d = l_8319_11 LET l_glab005c = l_8319_21 END IF
   #170111-00055#1--mark--end--lujh axrp133效能优化

   #161128-00061#7---add---begin-----------
   #LET l_sql = "SELECT * FROM xrca_t ",
   LET l_sql = "SELECT xrcaent,xrcaownid,xrcaowndp,xrcacrtid,xrcacrtdp,xrcacrtdt,xrcamodid,xrcamoddt,",
               "xrcacnfid,xrcacnfdt,xrcapstid,xrcapstdt,xrcastus,xrcacomp,xrcald,xrcadocno,xrcadocdt,",
               "xrca001,xrcasite,xrca003,xrca004,xrca005,xrca006,xrca007,xrca008,xrca009,xrca010,",
               "xrca011,xrca012,xrca013,xrca014,xrca015,xrca016,xrca017,xrca018,xrca019,xrca020,",
               "xrca021,xrca022,xrca023,xrca024,xrca025,xrca026,xrca028,xrca029,xrca030,xrca031,",
               "xrca032,xrca033,xrca034,xrca035,xrca036,xrca037,xrca038,xrca039,xrca040,xrca041,",
               "xrca042,xrca043,xrca044,xrca045,xrca046,xrca047,xrca048,xrca049,xrca050,xrca051,",
               "xrca052,xrca053,xrca054,xrca055,xrca056,xrca057,xrca058,xrca059,xrca060,xrca061,",
               "xrca062,xrca063,xrca064,xrca065,xrca066,xrca100,xrca101,xrca103,xrca104,xrca106,",
               "xrca107,xrca108,xrca113,xrca114,xrca116,xrca117,xrca118,xrca120,xrca121,xrca123,",
               "xrca124,xrca126,xrca127,xrca128,xrca130,xrca131,xrca133,xrca134,xrca136,xrca137,",
               "xrca138,xrcaud001,xrcaud002,xrcaud003,xrcaud004,xrcaud005,xrcaud006,xrcaud007,",
               "xrcaud008,xrcaud009,xrcaud010,xrcaud011,xrcaud012,xrcaud013,xrcaud014,xrcaud015,",
               "xrcaud016,xrcaud017,xrcaud018,xrcaud019,xrcaud020,xrcaud021,xrcaud022,xrcaud023,",
               "xrcaud024,xrcaud025,xrcaud026,xrcaud027,xrcaud028,xrcaud029,xrcaud030 FROM xrca_t ",
   #161128-00061#7---add---end-----------
               " WHERE xrcald = '",p_ld CLIPPED,"'",
               "   AND xrca038 IS NULL ",
               "   AND ",p_wc,
               #"   AND xrcaent = '",g_enterprise,"' "   #150812-00010#2 #170615-00061#25 mark
               "   AND xrcaent = ",g_enterprise," "                      #170615-00061#25 add
               
#   IF g_prog = 'axrp330' THEN    #170301-00030#8 by 09257 --mark
   IF g_prog MATCHES 'axrp330*' THEN   #170301-00030#8 by 09257 --add      
      LET l_sql = l_sql," AND xrcastus = 'Y'"
   END IF
   PREPARE s_voucher_gen_ar_2_p1 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_p1'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   DECLARE s_voucher_gen_ar_2_cs1 CURSOR FOR s_voucher_gen_ar_2_p1
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_cs1'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   #借:应收帐款
               #单号/日期/借/企业/法人/帐套/摘要/科目
   LET l_sql = "SELECT xrcadocno,xrcadocdt,'1',xrcaent,xrcacomp,xrcald,xrcb047,xrcb029,",
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xrca100,xrca101,xrcb006,xrcb101,'','',xrca014,'','','',",
               #营运据点/部门/利润中心/区域/收款客户/账款客户/客群/产品类别/人员
               "       xrcborga,xrcb010,xrcb011,xrcb024,xrca005,xrca004,xrcb036,xrcb012,xrcb051,", #160407-00019#2 mod xrca004-->xrca005
               #专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10/现金变动码
               "       xrcb015,xrcb016,xrcb033,xrcb034,xrcb035,xrcb037,xrcb038,xrcb039,xrcb040,xrcb041,",
               "       xrcb042,xrcb043,xrcb044,xrcb045,xrcb046,'',",
               #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
               "       xrcb115*xrcb022,0,xrcb007,xrcb105*xrcb022,xrca121,xrcb125*xrcb022,0,xrca131,xrcb135*xrcb022,0,",
               #来源单号项次    来源表             交易客户/帐款  红冲否  来源性质 冲暂估否 直接冲账原币 直接冲账本币 直接冲账本位币二 直接冲账本位币三                
               "       xrcbseq,'xrcb','',xrca039,xrca004,xrca005,'N',xrcb001,xrcb023,(xrca106+xrca107),(xrca116+xrca117),(xrca126+xrca127),(xrca136+xrca137),", #20150612 add 'N' lujh
               "       xrcb056*xrcb022,xrcb055*xrcb022,xrcb057*xrcb022,xrcb004,xrcb058,xrcb059,xrcb060,xrcb053,xrcb054 ",  #160509-00004#73 add lujh  
               "      ,xrca007,glad006,glad036 ",   #170111-00055#1 add lujh axrp133效能优化 
               "  FROM xrca_t,xrcb_t,glad_t ",      #170111-00055#1 add glad_t lujh axrp133效能优化  
               " WHERE xrcbent   = ",g_enterprise,
               "   AND xrcbld    = '",p_ld CLIPPED,"'",
               "   AND xrcbdocno = ? ",
               "   AND xrcaent   = xrcbent ",
               "   AND xrcald    = xrcbld  ",
               "   AND xrcadocno = xrcbdocno ",
               #170111-00055#1 add lujh axrp133效能优化 
               "   AND gladent = xrcaent ",
               "   AND gladld = xrcald ",
               "   AND glad001 = xrcb029 ",
               #170111-00055#1 add lujh axrp133效能优化
               "   AND xrcb021 IS NOT NULL",      #160509-00004#9 add lujh
               "   AND xrcb029 IS NOT NULL",      #160509-00004#9 add lujh
               " ORDER BY xrcb115*xrcb022 desc"               
   PREPARE s_voucher_gen_ar_2_p2 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_p2'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_2_cs2 CURSOR FOR s_voucher_gen_ar_2_p2
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_cs2'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF               
               
   #贷 收入科目
               #单号/日期/借/企业/法人/帐套/摘要/科目
   LET l_sql = "SELECT xrcadocno,xrcadocdt,'2',xrcaent,xrcacomp,xrcald,xrcb047,xrcb021,",
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xrca100,xrca101,xrcb006,xrcb101,   '',      '',      xrca014,'','','',",
               #营运据点/部门/利润中心/区域/收款客户/账款客户/客群/产品类别/人员
               "       xrcborga,xrcb010,xrcb011,xrcb024,xrca005,xrca004,xrcb036,xrcb012,xrcb051,", #160407-00019#2 mod xrca004-->xrca005
               #专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10/现金变动码
               "       xrcb015,xrcb016,xrcb033,xrcb034,xrcb035,xrcb037,xrcb038,xrcb039,xrcb040,xrcb041,",
               "       xrcb042,xrcb043,xrcb044,xrcb045,xrcb046,'',",
               #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
               "       0,xrcb113*xrcb022,xrcb007, xrcb103*xrcb022,xrca121,0,xrcb123*xrcb022,xrca131,0,xrcb133*xrcb022,",
               #来源单号项次    来源表             交易客户/帐款   红冲否 来源性质 冲暂估否  
               "       xrcbseq,'xrcb','',xrca039,xrca004,xrca005,'N',xrcb001,xrcb023, ",    #20150612 add 'N' lujh
               #收付款對象/帳款對象
               "       xrcb053,xrcb054,xrcb055*xrcb022,xrcb057*xrcb022,xrcb029,xrcb058,xrcb060 ",    #160509-00004#34 add lujh   #160509-00004#73 add xrcb029,xrcb058,xrcb060 lujh
               "      ,xrca007,glad006,glad036 ",   #170111-00055#1 add lujh axrp133效能优化 
               "  FROM xrca_t,xrcb_t,glad_t ",      #170111-00055#1 add glad_t lujh axrp133效能优化  
               " WHERE xrcbent   = ",g_enterprise,
               "   AND xrcbld    = '",p_ld CLIPPED,"'",
               "   AND xrcbdocno = ? ",
               "   AND xrcaent   = xrcbent ",
               "   AND xrcald    = xrcbld  ",
               "   AND xrcadocno = xrcbdocno ",
               #170111-00055#1 add lujh axrp133效能优化 
               "   AND gladent = xrcaent ",
               "   AND gladld = xrcald ",
               "   AND glad001 = xrcb021 ",
               #170111-00055#1 add lujh axrp133效能优化                
               "   AND xrcb021 IS NOT NULL",      #160509-00004#9 add lujh
               "   AND xrcb029 IS NOT NULL"       #160509-00004#9 add lujh
   PREPARE s_voucher_gen_ar_2_p3 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_p3'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_2_cs3 CURSOR FOR s_voucher_gen_ar_2_p3
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_cs3'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF      
   
   #贷 销项税额
               #单号/日期/借/企业/法人/帐套/摘要/科目
   LET l_sql = "SELECT DISTINCT xrcadocno,xrcadocdt,'2',xrcaent,xrcacomp,xrcald,xrcb047,xrcd009,",
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xrca100,xrca101,'',0,'','',xrca014,'','','',",
               #营运据点/部门/利润中心/区域/收款客户/账款客户/客群/产品类别/人员
               "       xrcborga,xrcb010,xrcb011,xrcb024,xrca005,xrca004,xrcb036,xrcb012,xrcb051,",  #160407-00019#2 mod xrca004-->xrca005
               #专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10/现金变动码
               "       xrcb015,xrcb016,xrcb033,xrcb034,xrcb035,xrcb037,xrcb038,xrcb039,xrcb040,xrcb041,",
               "       xrcb042,xrcb043,xrcb044,xrcb045,xrcb046,'',",
               #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
               "       0,xrcd114*xrcb022,0, xrcd104*xrcb022,xrcd121,0,xrcd124*xrcb022,xrcd131,0,xrcd134*xrcb022,",
               #来源单号项次    来源表             交易客户/帐款   红冲否 来源性质 冲暂估否 
               "       xrcdseq,'xrcd','',xrca039,xrca004,xrca005,'N',xrcb001,xrcb023 ", #20150612 add 'N' lujh
               "      ,xrca007,glad006,glad036 ",   #170111-00055#1 add lujh axrp133效能优化
               "  FROM xrca_t,xrcb_t,xrcd_t,glaa_t,glad_t ",  #170111-00055#1 add glad_t lujh axrp133效能优化  
               " WHERE xrcbent   = ",g_enterprise,
               "   AND xrcbld    = '",p_ld CLIPPED,"'",
               "   AND xrcbdocno = ? ",
               "   AND xrcaent   = xrcbent ",
               "   AND xrcald    = xrcbld  ",
               "   AND xrcadocno = xrcbdocno ",
               #170111-00055#1 add lujh axrp133效能优化 
               "   AND gladent = xrcaent ",
               "   AND gladld = xrcald ",
               "   AND glad001 = xrcd009 ",
               #170111-00055#1 add lujh axrp133效能优化  
               "   AND xrcdent   = xrcbent ",
               "   AND xrcdld    = xrcbld ",
               "   AND xrcddocno = xrcbdocno ",
               "   AND xrcdseq   = xrcbseq ",
               "   AND xrcbent = glaaent ", #170615-00061#25 add
               "   AND glaald    = xrcdld  "               
   PREPARE s_voucher_gen_ar_2_p4 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_p4'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_2_cs4 CURSOR FOR s_voucher_gen_ar_2_p4
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_cs4'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF   
   
   #直接沖帳   xrce_t
               #贷未税金额
               #单号/日期/借/企业/法人/帐套/摘要/科目
   LET l_sql = "SELECT xrcedocno,xrcadocdt,'2',xrceent,xrcecomp,xrceld,xrce010,xrce016,",
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xrce100,xrce101,'',0,'','',xrce017,'','','',",
               #营运据点/部门/利润中心/区域/收款客户/账款客户/客群/产品类别/人员
               "       xrceorga,xrce018,xrce019,xrce035,xrca005,xrca004,xrce036,xrce020,xrce017,", #160407-00019#2 mod xrca004-->xrca005
               #专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10/现金变动码
               "       xrce022,xrce023,xrce039,xrce040,xrce041,xrce042,xrce043,xrce044,xrce045,xrce046,",
               "       xrce047,xrce048,xrce049,xrce050,xrce051,'',",
               #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
#               "       0,xrce119 ,0, xrce109,xrce121,0,xrce129,xrce131,0,xrce139,xrceseq,'xrce','',xrca039,", #160628-00002#1 mark
               "       0,xrce113 ,0, xrce103,xrce121,0,xrce123,xrce131,0,xrce133,xrceseq,'xrce','',xrca039,", #160628-00002#1 add
               "       xrca004,xrca005,'N',xrce015,xrca035  ",   #20150612 add 'N' lujh
               #待抵单号/用于标记是未税金额分录
               "      ,xrce003,'1'",  #160628-00002#1 add 
               "      ,xrca007,glad006,glad036 ",   #170111-00055#1 add lujh axrp133效能优化
               "  FROM xrca_t,xrce_t,glad_t ",      #170111-00055#1 add glad_t lujh axrp133效能优化 
               " WHERE xrceent   = ",g_enterprise,
               "   AND xrceld    = '",p_ld CLIPPED,"'",
               "   AND xrcedocno = ? ",
               #170111-00055#1 add lujh axrp133效能优化 
               "   AND gladent = xrcaent ",
               "   AND gladld = xrcald ",
               "   AND glad001 = xrce016 ",
               #170111-00055#1 add lujh axrp133效能优化   
               "   AND xrcaent   = xrceent ",
               "   AND xrcald    = xrceld  ",
               "   AND xrcadocno = xrcedocno "  
               #160628-00002#1--add--str--
               #贷：税额
              ," UNION ",
               #单号/日期/借/企业/法人/帐套/摘要/科目
               "SELECT xrcedocno,xrcadocdt,'2',xrceent,xrcecomp,xrceld,xrce010,'',",
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xrce100,xrce101,'',0,'','',xrce017,'','','',",
               #营运据点/部门/利润中心/区域/收款客户/账款客户/客群/产品类别/人员
               "       xrceorga,xrce018,xrce019,xrce035,xrca005,xrca004,xrce036,xrce020,xrce017,", #160407-00019#2 mod xrca004-->xrca005
               #专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10/现金变动码
               "       xrce022,xrce023,xrce039,xrce040,xrce041,xrce042,xrce043,xrce044,xrce045,xrce046,",
               "       xrce047,xrce048,xrce049,xrce050,xrce051,'',",
               #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
               "       0,xrce114 ,0, xrce104,xrce121,0,xrce124,xrce131,0,xrce134,xrceseq,'xrce','',xrca039,",
               "       xrca004,xrca005,'N',xrce015,xrca035,  ",  
               #待抵单号/用于标记是税额分录
               "       xrce003,'2' ", 
               "      ,xrca007,glad006,glad036 ",   #170111-00055#1 add lujh axrp133效能优化
               "  FROM xrca_t,xrce_t,glad_t ",      #170111-00055#1 add glad_t lujh axrp133效能优化               
               " WHERE xrceent   = ",g_enterprise,
               "   AND xrceld    = '",p_ld CLIPPED,"'",
               "   AND xrcedocno = ? ",
               #170111-00055#1 add lujh axrp133效能优化 
               "   AND gladent = xrcaent ",
               "   AND gladld = xrcald ",
               "   AND glad001 = xrce016 ",
               #170111-00055#1 add lujh axrp133效能优化  
               "   AND xrcaent   = xrceent ",
               "   AND xrcald    = xrceld  ",
               "   AND xrcadocno = xrcedocno " 
               #160628-00002#1--add--end
   PREPARE s_voucher_gen_ar_2_p7 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_p7'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_2_cs7 CURSOR FOR s_voucher_gen_ar_2_p7
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_cs7'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF   
   
   #直接沖帳  xrde
               #单号/日期/借/企业/法人/帐套/摘要/科目
   LET l_sql = "SELECT xrdedocno,xrcadocdt,'2',xrdeent,xrdecomp,xrdeld,xrde010,xrde016,",
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xrde100,xrde101,'',0,'','',xrde017,'','','',",
               #营运据点/部门/利润中心/区域/收款客户/账款客户/客群/产品类别/人员
               "       xrdeorga,xrde018,xrde019,xrde035,xrca005,xrca004,xrde036,xrde020,xrde017,", #160407-00019#2 mod xrca004-->xrca005
               #专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10/现金变动码
               "       xrde022,xrde023,xrde039,xrde040,xrde041,xrde042,xrde043,xrde044,xrde045,xrde046,",
               "       xrde047,xrde048,xrde049,xrde050,xrde051,xrde012,",
               #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
               "       0,xrde119 ,0, xrde109,xrde121,0,xrde129,xrde131,0,xrde139,xrdeseq,'xrde','',xrca039,",
               "       xrca004,xrca005,'N',xrde015,xrca035,xrde001 ",  #20150612 add 'N' lujh   #160509-00004#45 add xrde001 lujh   
               "      ,xrca007,glad006,glad036 ",   #170111-00055#1 add lujh axrp133效能优化
               "  FROM xrca_t,xrde_t,glad_t ",      #170111-00055#1 add glad_t lujh axrp133效能优化  
               " WHERE xrdeent   = ",g_enterprise,
               "   AND xrdeld    = '",p_ld CLIPPED,"'",
               "   AND xrdedocno = ? ",
               #170111-00055#1 add lujh axrp133效能优化 
               "   AND gladent = xrcaent ",
               "   AND gladld = xrcald ",
               "   AND glad001 = xrde016 ",
               #170111-00055#1 add lujh axrp133效能优化   
               "   AND xrcaent   = xrdeent ",
               "   AND xrcald    = xrdeld  ",
               "   AND xrcadocno = xrdedocno "          
   PREPARE s_voucher_gen_ar_2_p19 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_p19'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_2_cs19 CURSOR FOR s_voucher_gen_ar_2_p19
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_cs18'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF  
   
   #单身来源是销退,借方改抓xrcf
   #借：應收暫估會科
               #单号/日期/借/企业/法人/帐套/摘要/科目
   LET l_sql = "SELECT xrcadocno,xrcadocdt,'1',xrcaent,xrcacomp,xrcald,xrcf049,xrcf021,",
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xrca100,xrcf102,xrcb006,xrcf101,'','',xrca014,'','','',",
               #营运据点/部门/利润中心/区域/收款客户/账款客户/客群/产品类别/人员
               "       xrcforga,xrcf026,xrcf027,xrcf028,xrcf029,xrcf030,xrcf031,xrcf032,xrcf033,", #160407-00019#2 mod xrcf029-->xrcf030
               #专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10/现金变动码
               "       xrcf034,xrcf035,xrcf036,xrcf037,xrcf038,xrcf039,xrcf040,xrcf041,xrcf042,",
               "       xrcf043,xrcf044,xrcf045,xrcf046,xrcf047,xrcf048,'',",
               #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
               "       xrcf115,0,xrcb007,xrcf105,xrcf122,xrcf125,0,xrcf132,xrcf135,0,xrcbseq,'xrcf','',xrca039, ",
               "       xrcf029,xrcf030",
               "  FROM xrca_t,xrcb_t,xrcf_t ",
               " WHERE xrcbent   = ",g_enterprise,
               "   AND xrcbld    = '",p_ld CLIPPED,"'",
               "   AND xrcbdocno = ? ",
               "   AND xrcaent   = xrcbent ",
               "   AND xrcald    = xrcbld  ",
               "   AND xrcadocno = xrcbdocno ",
               "   AND xrcbent   = xrcfent ",
               "   AND xrcbdocno = xrcfdocno",
               "   AND xrcbld    = xrcfld ",
               "   AND xrcbseq   = xrcfseq",
               "   AND xrcfseq   = ? ",
               "   AND xrcf008   <> 'DIFF'"               
   PREPARE s_voucher_gen_ar_2_p15 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_p15'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   #单身来源是出货,贷方改抓xrcf
   #贷：應收暫估會科
               #单号/日期/借/企业/法人/帐套/摘要/科目
   LET l_sql = "SELECT xrcadocno,xrcadocdt,'2',xrcaent,xrcacomp,xrcald,xrcf049,xrcf021,",
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xrca100,xrcf102,'',xrcf101,'','',xrca014,'','','',",   #161212-00024#1 Mod xrcb006 --> ''
               #营运据点/部门/利润中心/区域/收款客户/账款客户/客群/产品类别/人员
               "       xrcforga,xrcf026,xrcf027,xrcf028,xrcf029,xrcf030,xrcf031,xrcf032,xrcf033,", #160407-00019#2 mod xrcf029-->xrcf030
               #专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10/现金变动码
               "       xrcf034,xrcf035,xrcf036,xrcf037,xrcf038,xrcf039,xrcf040,xrcf041,xrcf042,",
               "       xrcf043,xrcf044,xrcf045,xrcf046,xrcf047,xrcf048,'',",
               #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
               "       0,xrcf115,xrcf007,xrcf105,xrcf122,0,xrcf125,xrcf132,0,xrcf135,xrcfseq,'xrcf','',xrca039, ", #161212-00024#1 mod xrcb007-->xrcf007 xrcbseq --> xrcfseq   #161223-00007#1 change #160407-00019#2 to #161212-00024#1  
               "       xrcf029,xrcf030,'N'",  #20150612 add 'N' lujh
               "      ,xrca007,glad006,glad036 ",      #170111-00055#1 add lujh axrp133效能优化
               "      ,xrcf008 ",                      #170310-00049#1               
               "  FROM xrca_t,xrcf_t,glad_t ",  #161212-00024#1 Del xrcb_t  #170111-00055#1 add glad_t lujh axrp133效能优化  
               #161212-00024#1 Add  ---(S)---
               " WHERE xrcaent   = ",g_enterprise,
               "   AND xrcald    = '",p_ld CLIPPED,"'",
               "   AND xrcadocno = ? ",
               "   AND xrcaent   = xrcfent ",
               "   AND xrcadocno = xrcfdocno",
               "   AND xrcald    = xrcfld ",
               #170111-00055#1 add lujh axrp133效能优化 
               "   AND gladent = xrcaent ",
               "   AND gladld = xrcald ",
               "   AND glad001 = xrcf021 ",
               #170111-00055#1 add lujh axrp133效能优化   
               "   AND xrcf008   <> 'DIFF'"     
               #161212-00024#1 Add  ---(E)---
               #161212-00024#1 Mark ---(S)---
              #" WHERE xrcbent   = ",g_enterprise,
              #"   AND xrcbld    = '",p_ld CLIPPED,"'",
              #"   AND xrcbdocno = ? ",
              #"   AND xrcaent   = xrcbent ",
              #"   AND xrcald    = xrcbld  ",
              #"   AND xrcadocno = xrcbdocno ",
              #"   AND xrcbent   = xrcfent ",
              #"   AND xrcbdocno = xrcfdocno",
              #"   AND xrcbld    = xrcfld ",
              #"   AND xrcbseq   = xrcfseq",
              #"   AND xrcfseq   = ? ",
              #"   AND xrcf008   <> 'DIFF'"         
               #161212-00024#1 Mark ---(E)---      
   PREPARE s_voucher_gen_ar_2_p16 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_p16'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   DECLARE s_voucher_gen_ar_2_cs16 CURSOR FOR s_voucher_gen_ar_2_p16
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_cs16'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF 

   #160816-00014#1 Add  ---(S)---
   #借：應收暫估税额會科
               #单号/日期/借/企业/法人/帐套/摘要/科目
   LET l_sql = "SELECT xrcadocno,xrcadocdt,'2',xrcaent,xrcacomp,xrcald,xrcf049,xrcf023,",
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xrca100,xrcf102,'',xrcf101,'','',xrca014,'','','',",   #161212-00024#1 Mod xrcb006 --> ''
               #营运据点/部门/利润中心/区域/收款客户/账款客户/客群/产品类别/人员
               "       xrcforga,xrcf026,xrcf027,xrcf028,xrcf029,xrcf030,xrcf031,xrcf032,xrcf033,", #160407-00019#2 mod xrcf029-->xrcf030
               #专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10/现金变动码
               "       xrcf034,xrcf035,xrcf036,xrcf037,xrcf038,xrcf039,xrcf040,xrcf041,xrcf042,",
               "       xrcf043,xrcf044,xrcf045,xrcf046,xrcf047,xrcf048,'',",
               #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
               "       xrcf114,0,xrcf007,xrcf104,xrcf122,xrcf124,0,xrcf132,xrcf134,0,xrcfseq,'xrcf','',xrca039, ", #161212-00024#1 mod xrcb007-->xrcf007 xrcbseq --> xrcfseq  #161223-00007#1 change #160407-00019#2 to #161212-00024#1 
               "       xrcf029,xrcf030,'N'",
               "      ,xrca007,glad006,glad036 ",      #170111-00055#1 add lujh axrp133效能优化
               "      ,xrcf008 ",         #170328-00085#1 add
               "  FROM xrca_t,xrcf_t,glad_t ",   #161212-00024#1 Del xrcb_t  #170111-00055#1 add glad_t lujh axrp133效能优化 
               #161212-00024#1 Add  ---(S)---
               " WHERE xrcaent   = ",g_enterprise,
               "   AND xrcald    = '",p_ld CLIPPED,"'",
               "   AND xrcadocno = ? ",
               "   AND xrcaent   = xrcfent ",
               "   AND xrcadocno = xrcfdocno",
               "   AND xrcald    = xrcfld ",
               #170111-00055#1 add lujh axrp133效能优化 
               "   AND gladent = xrcaent ",
               "   AND gladld = xrcald ",
               "   AND glad001 = xrcf021 ",
               #170111-00055#1 add lujh axrp133效能优化   
               "   AND xrcf008   <> 'DIFF'"     
               #161212-00024#1 Add  ---(E)---
               #161212-00024#1 Mark ---(S)---
              #" WHERE xrcbent   = ",g_enterprise,
              #"   AND xrcbld    = '",p_ld CLIPPED,"'",
              #"   AND xrcbdocno = ? ",
              #"   AND xrcaent   = xrcbent ",
              #"   AND xrcald    = xrcbld  ",
              #"   AND xrcadocno = xrcbdocno ",
              #"   AND xrcbent   = xrcfent ",
              #"   AND xrcbdocno = xrcfdocno",
              #"   AND xrcbld    = xrcfld ",
              #"   AND xrcbseq   = xrcfseq",
              #"   AND xrcfseq   = ? ",
              #"   AND xrcf008   <> 'DIFF'"         
               #161212-00024#1 Mark ---(E)---     
   PREPARE s_voucher_gen_ar_2_p21 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_p21'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   DECLARE s_voucher_gen_ar_2_cs21 CURSOR FOR s_voucher_gen_ar_2_p21
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_cs21'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF 

   #160816-00014#1 Add  ---(E)---

   #差异,无条件放贷方
   #贷：應收暫估會科
               #单号/日期/借/企业/法人/帐套/摘要/科目
   LET l_sql = "SELECT DISTINCT xrcadocno,xrcadocdt,'2',xrcaent,xrcacomp,xrcald,xrcf049,xrcf021,",
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xrca100,xrcf102,'',xrcf101,'','',xrca014,'','','',",
               #营运据点/部门/利润中心/区域/收款客户/账款客户/客群/产品类别/人员
               "       xrcforga,xrcf026,xrcf027,xrcf028,xrcf029,xrcf030,xrcf031,xrcf032,xrcf033,", #160407-00019#2 mod xrcf029-->xrcf030
               #专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10/现金变动码
               "       xrcf034,xrcf035,xrcf036,xrcf037,xrcf038,xrcf039,xrcf040,xrcf041,xrcf042,",
               "       xrcf043,xrcf044,xrcf045,xrcf046,xrcf047,xrcf048,'',",
               #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
               "       0,xrcf115,'',xrcf105,xrcf122,0,xrcf125,xrcf132,0,xrcf135,'','diff','',xrca039, ",
               "       xrcf029,xrcf030,'N'",  #20150612 add 'N' lujh
               "      ,xrca007,glad006,glad036 ",      #170111-00055#1 add lujh axrp133效能优化
               "  FROM xrca_t,xrcb_t,xrcf_t,glad_t ",  #170111-00055#1 add glad_t lujh axrp133效能优化 
               " WHERE xrcbent   = ",g_enterprise,
               "   AND xrcbld    = '",p_ld CLIPPED,"'",
               "   AND xrcbdocno = ? ",
               "   AND xrcaent   = xrcbent ",
               "   AND xrcald    = xrcbld  ",
               "   AND xrcadocno = xrcbdocno ",
               "   AND xrcbent   = xrcfent ",
               "   AND xrcbdocno = xrcfdocno",
               "   AND xrcbld    = xrcfld ",
               #170111-00055#1 add lujh axrp133效能优化 
               "   AND gladent = xrcaent ",
               "   AND gladld = xrcald ",
               "   AND glad001 = xrcf021 ",
               #170111-00055#1 add lujh axrp133效能优化 
              #"   AND xrcfseq   = ? ",   #160912-00011#4 Mark
               "   AND xrcf008   = 'DIFF'"               
   PREPARE s_voucher_gen_ar_2_p17 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_p17'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_2_cs17 CURSOR FOR s_voucher_gen_ar_2_p17
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_cs17'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF 
   
   #直接冲账净额       
   LET l_sql = "SELECT SUM(xrce119),SUM(xrce129),SUM(xrce139)",
               "  FROM xrce_t ",
               " WHERE xrceent   = ",g_enterprise,
               "   AND xrceld    = '",p_ld CLIPPED,"'",
               "   AND xrcedocno = ? "           
   PREPARE s_voucher_gen_ar_2_p18 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_p18'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF

   #从临时表中取科目
   LET l_sql = " SELECT DISTINCT glaq002,glac016 FROM s_vr_tmp04,glac_t,glaa_t ",  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04   #170111-00055#1 add glac016 axrp133效能优化
               #170111-00055#1 add axrp133效能优化
               "  WHERE glacent = ",g_enterprise,
               "    AND glacent = glaaent", #170401-00012#1 add
               "    AND glaald = glaqld ",
               "    AND glac001 = glaa004 ",
               "    AND glac002 = glaq002 ",
               #170111-00055#1 add axrp133效能优化
               "  ORDER BY glaq002"
   PREPARE s_voucher_gen_ar_2_p5 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_p5'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_2_cs5 CURSOR FOR s_voucher_gen_ar_2_p5
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_cs5'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   #从agli030取科目设置
   LET l_sql = " SELECT glad005,glad007,glad008,glad009,glad010,glad011,glad012,glad013,glad015,",
               "        glad016,glad017,glad018,glad019,glad020,glad021,glad022,glad023,glad024,",
               "        glad025,glad026,glad027,glad031,glad032,glad033 ",
               "   FROM glad_t ",
               "  WHERE gladent = ",g_enterprise,
               "    AND gladld  = '",p_ld CLIPPED,"'",
               "    AND glad001 = ? "
   PREPARE s_voucher_gen_ar_2_p6 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_p6'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_2_cs6 CURSOR FOR s_voucher_gen_ar_2_p6
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_cs6'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF       
   
   #临时表GROUP,以便产生凭证单据的单头档glap_t
   CASE p_sum_type
      WHEN '1'  LET l_field = "docno,docdt,''"
      WHEN '2'  LET l_field = "'',docdt,''"
      WHEN '3'  LET l_field = "'','',b_glaq021"
      WHEN '4'  LET l_field = "'',docdt,b_glaq021"
      WHEN '5'  LET l_field = "'','',''"
   END CASE
   
   LET l_sql = " SELECT UNIQUE glaqcomp,",l_field CLIPPED,
               "   FROM s_vr_tmp05 "  #160727-00019#36   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_ar_group ——> s_vr_tmp05
               
   CASE p_sum_type
      WHEN '1'  LET l_sql = l_sql,"  ORDER BY docno ASC"
      WHEN '2'  LET l_sql = l_sql,"  ORDER BY docdt ASC"
      WHEN '4'  LET l_sql = l_sql,"  ORDER BY docdt ASC"
   END CASE
   
   PREPARE s_voucher_gen_ar_2_p8 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_p8'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_2_cs8 CURSOR FOR s_voucher_gen_ar_2_p8
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_cs8'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF

   #用于生成glaq_t资料的临时表
   #LET l_sql = " SELECT * FROM s_vr_tmp05 "  #160727-00019#36   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_ar_group ——> s_vr_tmp05  #170509-00094#12 mark
   LET l_sql = " SELECT * FROM s_vr_tmp051 "   #170509-00094#12 add
#170509-00094#12 mod s---
#   CASE p_sum_type
#      WHEN '1' LET l_sql = l_sql CLIPPED," WHERE docno = ?  ORDER BY glaq002,? "
#      WHEN '2' LET l_sql = l_sql CLIPPED," WHERE docdt = ?  ORDER BY glaq002,? "
#      WHEN '3' LET l_sql = l_sql CLIPPED," WHERE b_glaq021 = ?  ORDER BY glaq002,? "
#      WHEN '4' LET l_sql = l_sql CLIPPED," WHERE b_glaq021 = ? AND docdt = ?  ORDER BY glaq002 "
#      WHEN '5' LET l_sql = l_sql CLIPPED," ORDER BY glaq002,?,? "
#   END CASE
   CASE p_sum_type
      WHEN '1' LET l_sql = l_sql CLIPPED," WHERE docno = ?  ORDER BY sw,glaq002,? "
      WHEN '2' LET l_sql = l_sql CLIPPED," WHERE docdt = ?  ORDER BY sw,glaq002,? "
      WHEN '3' LET l_sql = l_sql CLIPPED," WHERE b_glaq021 = ?  ORDER BY sw,glaq002,? "
      WHEN '4' LET l_sql = l_sql CLIPPED," WHERE b_glaq021 = ? AND docdt = ?  ORDER BY sw,glaq002 "
      WHEN '5' LET l_sql = l_sql CLIPPED," ORDER BY sw,glaq002,?,? "
   END CASE   
#170509-00094#12 mod e---   
   #LET l_sql = l_sql CLIPPED," ORDER BY glaq002,? "
   PREPARE s_voucher_gen_ar_2_p9 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_p9'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_2_cs9 CURSOR FOR s_voucher_gen_ar_2_p9
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_cs9'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF  
   
   LET l_sql = "UPDATE xrca_t SET xrca038 = ? ",
               " WHERE xrcaent   = ",g_enterprise,
               "   AND xrcald    = '",p_ld,"'",
               "   AND xrcadocno = ? "
   PREPARE s_voucher_gen_ar_2_p10 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_p10'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   LET g_sql = "SELECT docno,docdt,sw,glaqent,glaqcomp,glaqld,glaq001,glaq002,glaq005,",
               "       glaq006,glaq007,glaq009,glaq011,glaq012,glaq013,glaq014,glaq015,glaq016,",
               "       glaq017,glaq018,glaq019,glaq020,glaq021,glaq022,glaq023,glaq024,glaq025, ",
               "       glaq027,glaq028,glaq051,glaq052,glaq053,glaq029,glaq030,glaq031,",
               "       glaq032,glaq033,glaq034,glaq035,glaq036,glaq037,glaq038,glbc004,d,c,qty,sum,",
               "       glaq039,glaq040,glaq041,glaq042,glaq043,glaq044,seq,source,glaqseq,xrca039, ",
               "       b_glaq020,b_glaq021,",
               "  FROM s_vr_tmp04 "  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
   PREPARE s_voucher_gen_ar_2_p11 FROM g_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_p11'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_2_cs11 CURSOR FOR s_voucher_gen_ar_2_p11
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_cs11'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF 
   
   
   #根據匯總條件抓單據單號
   IF p_sum_type = '2' THEN 
      LET g_sql = "SELECT docno  ",
                  "  FROM s_vr_tmp04 ",  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                  " WHERE docdt    = ? ",
                  "   AND glaqent  = ? ",
                  "   AND (glaqcomp  = ? OR ( ? IS NULL AND glaqcomp IS NULL) OR glaqcomp = ' ')",
                  "   AND (glaq001  = ? OR ( ? IS NULL AND glaq001 IS NULL) OR glaq001 = ' ')",
                  "   AND (glaq002  = ? OR ( ? IS NULL AND glaq002 IS NULL) OR glaq002 = ' ')",
                  "   AND (glaq005  = ? OR ( ? IS NULL AND glaq005 IS NULL) OR glaq005 = ' ')",
                  "   AND (glaq006  = ? OR ( ? IS NULL AND glaq006 IS NULL))",
                  "   AND (glaq039  = ? OR ( ? IS NULL AND glaq039 IS NULL))",
                  "   AND (glaq042  = ? OR ( ? IS NULL AND glaq042 IS NULL))",
                  "   AND (glaq018  = ? OR ( ? IS NULL AND glaq018 IS NULL) OR glaq018 = ' ')",
                  "   AND (glaq019  = ? OR ( ? IS NULL AND glaq019 IS NULL) OR glaq019 = ' ')",
                  "   AND (glaq020  = ? OR ( ? IS NULL AND glaq020 IS NULL) OR glaq020 = ' ')",
                  "   AND (glaq021  = ? OR ( ? IS NULL AND glaq021 IS NULL) OR glaq021 = ' ')",
                  "   AND (glaq022  = ? OR ( ? IS NULL AND glaq022 IS NULL) OR glaq022 = ' ')",
                  "   AND (glaq023  = ? OR ( ? IS NULL AND glaq023 IS NULL) OR glaq023 = ' ')",
                  "   AND (glaq024  = ? OR ( ? IS NULL AND glaq024 IS NULL) OR glaq024 = ' ')",
                  "   AND (glaq025  = ? OR ( ? IS NULL AND glaq025 IS NULL) OR glaq025 = ' ')",
                  "   AND (glaq027  = ? OR ( ? IS NULL AND glaq027 IS NULL) OR glaq027 = ' ')",
                  "   AND (glaq028  = ? OR ( ? IS NULL AND glaq028 IS NULL) OR glaq028 = ' ')",
                  "   AND (glaq051  = ? OR ( ? IS NULL AND glaq051 IS NULL) OR glaq051 = ' ')",
                  "   AND (glaq052  = ? OR ( ? IS NULL AND glaq052 IS NULL) OR glaq052 = ' ')",
                  "   AND (glaq053  = ? OR ( ? IS NULL AND glaq053 IS NULL) OR glaq053 = ' ')",
                  "   AND (glaq029  = ? OR ( ? IS NULL AND glaq029 IS NULL) OR glaq029 = ' ')",
                  "   AND (glaq030  = ? OR ( ? IS NULL AND glaq030 IS NULL) OR glaq030 = ' ')",
                  "   AND (glaq031  = ? OR ( ? IS NULL AND glaq031 IS NULL) OR glaq031 = ' ')",
                  "   AND (glaq032  = ? OR ( ? IS NULL AND glaq032 IS NULL) OR glaq032 = ' ')",
                  "   AND (glaq033  = ? OR ( ? IS NULL AND glaq033 IS NULL) OR glaq033 = ' ')",
                  "   AND (glaq034  = ? OR ( ? IS NULL AND glaq034 IS NULL) OR glaq034 = ' ')",
                  "   AND (glaq035  = ? OR ( ? IS NULL AND glaq035 IS NULL) OR glaq035 = ' ')",
                  "   AND (glaq036  = ? OR ( ? IS NULL AND glaq036 IS NULL) OR glaq036 = ' ')",
                  "   AND (glaq037  = ? OR ( ? IS NULL AND glaq037 IS NULL) OR glaq037 = ' ')",
                  "   AND (glaq038  = ? OR ( ? IS NULL AND glaq038 IS NULL) OR glaq038 = ' ')",
                  "   AND (glbc004  = ? OR ( ? IS NULL AND glbc004 IS NULL) OR glbc004 = ' ')",
                  "   AND (glaq007  = ? OR ( ? IS NULL AND glaq007 IS NULL) OR glaq007 = ' ')"
   END IF
   
   IF p_sum_type = '3' THEN 
      LET g_sql = "SELECT docno  ",
                  "  FROM s_vr_tmp04 ",  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                  " WHERE glaqent  = ? ",
                  "   AND (glaqcomp  = ? OR ( ? IS NULL AND glaqcomp IS NULL) OR glaqcomp = ' ')",
                  "   AND (glaq001  = ? OR ( ? IS NULL AND glaq001 IS NULL) OR glaq001 = ' ')",
                  "   AND (glaq002  = ? OR ( ? IS NULL AND glaq002 IS NULL) OR glaq002 = ' ')",
                  "   AND (glaq021  = ? OR ( ? IS NULL AND glaq021 IS NULL) OR glaq021 = ' ')",
                  "   AND (glaq022  = ? OR ( ? IS NULL AND glaq022 IS NULL) OR glaq022 = ' ')",
                  "   AND (glaq005  = ? OR ( ? IS NULL AND glaq005 IS NULL) OR glaq005 = ' ')",
                  "   AND (glaq006  = ? OR ( ? IS NULL AND glaq006 IS NULL))",
                  "   AND (glaq039  = ? OR ( ? IS NULL AND glaq039 IS NULL))",
                  "   AND (glaq042  = ? OR ( ? IS NULL AND glaq042 IS NULL))",
                  "   AND (glaq018  = ? OR ( ? IS NULL AND glaq018 IS NULL) OR glaq018 = ' ')",
                  "   AND (glaq019  = ? OR ( ? IS NULL AND glaq019 IS NULL) OR glaq019 = ' ')",
                  "   AND (glaq020  = ? OR ( ? IS NULL AND glaq020 IS NULL) OR glaq020 = ' ')",
                  "   AND (glaq021  = ? OR ( ? IS NULL AND glaq021 IS NULL) OR glaq021 = ' ')",
                  "   AND (glaq022  = ? OR ( ? IS NULL AND glaq022 IS NULL) OR glaq022 = ' ')",
                  "   AND (glaq023  = ? OR ( ? IS NULL AND glaq023 IS NULL) OR glaq023 = ' ')",
                  "   AND (glaq024  = ? OR ( ? IS NULL AND glaq024 IS NULL) OR glaq024 = ' ')",
                  "   AND (glaq025  = ? OR ( ? IS NULL AND glaq025 IS NULL) OR glaq025 = ' ')",
                  "   AND (glaq027  = ? OR ( ? IS NULL AND glaq027 IS NULL) OR glaq027 = ' ')",
                  "   AND (glaq028  = ? OR ( ? IS NULL AND glaq028 IS NULL) OR glaq028 = ' ')",
                  "   AND (glaq051  = ? OR ( ? IS NULL AND glaq051 IS NULL) OR glaq051 = ' ')",
                  "   AND (glaq052  = ? OR ( ? IS NULL AND glaq052 IS NULL) OR glaq052 = ' ')",
                  "   AND (glaq053  = ? OR ( ? IS NULL AND glaq053 IS NULL) OR glaq053 = ' ')",
                  "   AND (glaq029  = ? OR ( ? IS NULL AND glaq029 IS NULL) OR glaq029 = ' ')",
                  "   AND (glaq030  = ? OR ( ? IS NULL AND glaq030 IS NULL) OR glaq030 = ' ')",
                  "   AND (glaq031  = ? OR ( ? IS NULL AND glaq031 IS NULL) OR glaq031 = ' ')",
                  "   AND (glaq032  = ? OR ( ? IS NULL AND glaq032 IS NULL) OR glaq032 = ' ')",
                  "   AND (glaq033  = ? OR ( ? IS NULL AND glaq033 IS NULL) OR glaq033 = ' ')",
                  "   AND (glaq034  = ? OR ( ? IS NULL AND glaq034 IS NULL) OR glaq034 = ' ')",
                  "   AND (glaq035  = ? OR ( ? IS NULL AND glaq035 IS NULL) OR glaq035 = ' ')",
                  "   AND (glaq036  = ? OR ( ? IS NULL AND glaq036 IS NULL) OR glaq036 = ' ')",
                  "   AND (glaq037  = ? OR ( ? IS NULL AND glaq037 IS NULL) OR glaq037 = ' ')",
                  "   AND (glaq038  = ? OR ( ? IS NULL AND glaq038 IS NULL) OR glaq038 = ' ')",
                  "   AND (glbc004  = ? OR ( ? IS NULL AND glbc004 IS NULL) OR glbc004 = ' ')",
                  "   AND (glaq007  = ? OR ( ? IS NULL AND glaq007 IS NULL) OR glaq007 = ' ')",
                  "   AND (b_glaq021  = ? OR ( ? IS NULL AND b_glaq021 IS NULL) OR b_glaq021 = ' ')"
   END IF
   
   IF p_sum_type = '4' THEN 
      LET g_sql = "SELECT docno  ",
                  "  FROM s_vr_tmp04 ",  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                  " WHERE docdt    = ? ",
                  "   AND glaqent  = ? ",
                  "   AND (glaqcomp  = ? OR ( ? IS NULL AND glaqcomp IS NULL) OR glaqcomp = ' ')",
                  "   AND (glaq001  = ? OR ( ? IS NULL AND glaq001 IS NULL) OR glaq001 = ' ')",
                  "   AND (glaq002  = ? OR ( ? IS NULL AND glaq002 IS NULL) OR glaq002 = ' ')",
                  "   AND (glaq005  = ? OR ( ? IS NULL AND glaq005 IS NULL) OR glaq005 = ' ')",
                  "   AND (glaq006  = ? OR ( ? IS NULL AND glaq006 IS NULL))",
                  "   AND (glaq039  = ? OR ( ? IS NULL AND glaq039 IS NULL))",
                  "   AND (glaq042  = ? OR ( ? IS NULL AND glaq042 IS NULL))",
                  "   AND (glaq018  = ? OR ( ? IS NULL AND glaq018 IS NULL) OR glaq018 = ' ')",
                  "   AND (glaq019  = ? OR ( ? IS NULL AND glaq019 IS NULL) OR glaq019 = ' ')",
                  "   AND (glaq020  = ? OR ( ? IS NULL AND glaq020 IS NULL) OR glaq020 = ' ')",
                  "   AND (glaq021  = ? OR ( ? IS NULL AND glaq021 IS NULL) OR glaq021 = ' ')",
                  "   AND (glaq022  = ? OR ( ? IS NULL AND glaq022 IS NULL) OR glaq022 = ' ')",
                  "   AND (glaq023  = ? OR ( ? IS NULL AND glaq023 IS NULL) OR glaq023 = ' ')",
                  "   AND (glaq024  = ? OR ( ? IS NULL AND glaq024 IS NULL) OR glaq024 = ' ')",
                  "   AND (glaq025  = ? OR ( ? IS NULL AND glaq025 IS NULL) OR glaq025 = ' ')",
                  "   AND (glaq027  = ? OR ( ? IS NULL AND glaq027 IS NULL) OR glaq027 = ' ')",
                  "   AND (glaq028  = ? OR ( ? IS NULL AND glaq028 IS NULL) OR glaq028 = ' ')",
                  "   AND (glaq051  = ? OR ( ? IS NULL AND glaq051 IS NULL) OR glaq051 = ' ')",
                  "   AND (glaq052  = ? OR ( ? IS NULL AND glaq052 IS NULL) OR glaq052 = ' ')",
                  "   AND (glaq053  = ? OR ( ? IS NULL AND glaq053 IS NULL) OR glaq053 = ' ')",
                  "   AND (glaq029  = ? OR ( ? IS NULL AND glaq029 IS NULL) OR glaq029 = ' ')",
                  "   AND (glaq030  = ? OR ( ? IS NULL AND glaq030 IS NULL) OR glaq030 = ' ')",
                  "   AND (glaq031  = ? OR ( ? IS NULL AND glaq031 IS NULL) OR glaq031 = ' ')",
                  "   AND (glaq032  = ? OR ( ? IS NULL AND glaq032 IS NULL) OR glaq032 = ' ')",
                  "   AND (glaq033  = ? OR ( ? IS NULL AND glaq033 IS NULL) OR glaq033 = ' ')",
                  "   AND (glaq034  = ? OR ( ? IS NULL AND glaq034 IS NULL) OR glaq034 = ' ')",
                  "   AND (glaq035  = ? OR ( ? IS NULL AND glaq035 IS NULL) OR glaq035 = ' ')",
                  "   AND (glaq036  = ? OR ( ? IS NULL AND glaq036 IS NULL) OR glaq036 = ' ')",
                  "   AND (glaq037  = ? OR ( ? IS NULL AND glaq037 IS NULL) OR glaq037 = ' ')",
                  "   AND (glaq038  = ? OR ( ? IS NULL AND glaq038 IS NULL) OR glaq038 = ' ')",
                  "   AND (glbc004  = ? OR ( ? IS NULL AND glbc004 IS NULL) OR glbc004 = ' ')",
                  "   AND (glaq007  = ? OR ( ? IS NULL AND glaq007 IS NULL) OR glaq007 = ' ')",
                  "   AND (b_glaq021  = ? OR ( ? IS NULL AND b_glaq021 IS NULL) OR b_glaq021 = ' ')"
   END IF
   
   IF p_sum_type = '5' THEN 
      LET g_sql = "SELECT docno  ",
                  "  FROM s_vr_tmp04 ",  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                  " WHERE glaqent  = ? ",
                  "   AND (glaqcomp  = ? OR ( ? IS NULL AND glaqcomp IS NULL) OR glaqcomp = ' ')",
                  "   AND (glaq001  = ? OR ( ? IS NULL AND glaq001 IS NULL) OR glaq001 = ' ')",
                  "   AND (glaq002  = ? OR ( ? IS NULL AND glaq002 IS NULL) OR glaq002 = ' ')",
                  "   AND (glaq005  = ? OR ( ? IS NULL AND glaq005 IS NULL) OR glaq005 = ' ')",
                  "   AND (glaq006  = ? OR ( ? IS NULL AND glaq006 IS NULL))",
                  "   AND (glaq039  = ? OR ( ? IS NULL AND glaq039 IS NULL))",
                  "   AND (glaq042  = ? OR ( ? IS NULL AND glaq042 IS NULL))",
                  "   AND (glaq018  = ? OR ( ? IS NULL AND glaq018 IS NULL) OR glaq018 = ' ')",
                  "   AND (glaq019  = ? OR ( ? IS NULL AND glaq019 IS NULL) OR glaq019 = ' ')",
                  "   AND (glaq020  = ? OR ( ? IS NULL AND glaq020 IS NULL) OR glaq020 = ' ')",
                  "   AND (glaq021  = ? OR ( ? IS NULL AND glaq021 IS NULL) OR glaq021 = ' ')",
                  "   AND (glaq022  = ? OR ( ? IS NULL AND glaq022 IS NULL) OR glaq022 = ' ')",
                  "   AND (glaq023  = ? OR ( ? IS NULL AND glaq023 IS NULL) OR glaq023 = ' ')",
                  "   AND (glaq024  = ? OR ( ? IS NULL AND glaq024 IS NULL) OR glaq024 = ' ')",
                  "   AND (glaq025  = ? OR ( ? IS NULL AND glaq025 IS NULL) OR glaq025 = ' ')",
                  "   AND (glaq027  = ? OR ( ? IS NULL AND glaq027 IS NULL) OR glaq027 = ' ')",
                  "   AND (glaq028  = ? OR ( ? IS NULL AND glaq028 IS NULL) OR glaq028 = ' ')",
                  "   AND (glaq051  = ? OR ( ? IS NULL AND glaq051 IS NULL) OR glaq051 = ' ')",
                  "   AND (glaq052  = ? OR ( ? IS NULL AND glaq052 IS NULL) OR glaq052 = ' ')",
                  "   AND (glaq053  = ? OR ( ? IS NULL AND glaq053 IS NULL) OR glaq053 = ' ')",
                  "   AND (glaq029  = ? OR ( ? IS NULL AND glaq029 IS NULL) OR glaq029 = ' ')",
                  "   AND (glaq030  = ? OR ( ? IS NULL AND glaq030 IS NULL) OR glaq030 = ' ')",
                  "   AND (glaq031  = ? OR ( ? IS NULL AND glaq031 IS NULL) OR glaq031 = ' ')",
                  "   AND (glaq032  = ? OR ( ? IS NULL AND glaq032 IS NULL) OR glaq032 = ' ')",
                  "   AND (glaq033  = ? OR ( ? IS NULL AND glaq033 IS NULL) OR glaq033 = ' ')",
                  "   AND (glaq034  = ? OR ( ? IS NULL AND glaq034 IS NULL) OR glaq034 = ' ')",
                  "   AND (glaq035  = ? OR ( ? IS NULL AND glaq035 IS NULL) OR glaq035 = ' ')",
                  "   AND (glaq036  = ? OR ( ? IS NULL AND glaq036 IS NULL) OR glaq036 = ' ')",
                  "   AND (glaq037  = ? OR ( ? IS NULL AND glaq037 IS NULL) OR glaq037 = ' ')",
                  "   AND (glaq038  = ? OR ( ? IS NULL AND glaq038 IS NULL) OR glaq038 = ' ')",
                  "   AND (glbc004  = ? OR ( ? IS NULL AND glbc004 IS NULL) OR glbc004 = ' ')",
                  "   AND (glaq007  = ? OR ( ? IS NULL AND glaq007 IS NULL) OR glaq007 = ' ')"
   END IF

   PREPARE s_voucher_gen_ar_2_p13 FROM g_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_p13'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_2_cs13 CURSOR FOR s_voucher_gen_ar_2_p13
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_2_cs13'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF 
   
   #应收冲帐
   #161128-00061#7---add---begin-----------
   #LET l_sql = "SELECT * FROM xrda_t ",
   LET l_sql = "SELECT xrdaent,xrdacomp,xrdald,xrdadocno,xrdadocdt,xrdasite,xrda001,xrda003,",
               "xrda004,xrda005,xrda006,xrda007,xrda008,xrda009,xrda010,xrda011,xrda012,xrda013,",
               "xrda014,xrda015,xrda016,xrda017,xrdastus,xrdaownid,xrdaowndp,xrdacrtid,xrdacrtdp,",
               "xrdacrtdt,xrdamodid,xrdamoddt,xrdaud001,xrdaud002,xrdaud003,xrdaud004,xrdaud005,",
               "xrdaud006,xrdaud007,xrdaud008,xrdaud009,xrdaud010,xrdaud011,xrdaud012,xrdaud013,",
               "xrdaud014,xrdaud015,xrdaud016,xrdaud017,xrdaud018,xrdaud019,xrdaud020,xrdaud021,",
               "xrdaud022,xrdaud023,xrdaud024,xrdaud025,xrdaud026,xrdaud027,xrdaud028,xrdaud029,",
               "xrdaud030,xrda103,xrda104,xrda113,xrda114,xrda123,xrda124,xrda133,xrda134,xrdacnfid,",
               "xrdacnfdt,xrdapstid,xrdapstdt,xrda018 FROM xrda_t ",
   #161128-00061#7---add---end-----------
               " WHERE xrdald = '",p_ld CLIPPED,"'",
     #         "   AND xrdastus = 'Y' ",
               "   AND xrda014 IS NULL ",
               "   AND xrdaent = ",g_enterprise,  #161206-00023#1 add
               "   AND ",p_wc
               
#   IF g_prog = 'axrp420' THEN    #170301-00030#8 by 09257 --mark
   IF g_prog MATCHES 'axrp420*' THEN   #170301-00030#8 by 09257 --add    
      LET l_sql = l_sql," AND xrdastus = 'Y'"
   END IF            
   PREPARE s_voucher_gen_ar_3_p1 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_3_p1'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   DECLARE s_voucher_gen_ar_3_cs1 CURSOR FOR s_voucher_gen_ar_3_p1
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_3_cs1'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   #借
               #单号/日期/借/企业/法人/帐套/摘要/科目
   LET l_sql = "SELECT xrdedocno,xrdadocdt,'1',xrdeent,xrdecomp,xrdeld,xrde010,xrde016,",
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xrde100,xrde101,'',0,'','',xrde017,'','','',",
               #营运据点/部门/利润中心/区域/收款客户/账款客户/客群/产品类别/人员
               "       xrdeorga,xrde018,xrde019,xrde035,xrda005,xrda004,xrde036,xrde020,xrde017,", #160407-00019#2 mod xrda004-->xrda005
               #专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10/现金变动码
               "       xrde022,xrde023,xrde039,xrde040,xrde041,xrde042,xrde043,xrde044,xrde045,",
               "       xrde046,xrde047,xrde048,xrde049,xrde050,xrde051,xrde012,",
               #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
               "       xrde119,0 ,0, xrde109,xrde121,xrde129,0,xrde131,xrde139,0,xrdeseq,'xrde','','',",
               "       xrda004,xrda005,'N',xrde015,xrde002,xrde013,xrde108,xrde118,xrde007",  #20150612 add 'N' lujh   #160509-00004#80 add xrde108,xrde118,xrde007 lujh
               "  FROM xrda_t,xrde_t ",
               " WHERE xrdeent   = ",g_enterprise,
               "   AND xrdeld    = '",p_ld CLIPPED,"'",
               "   AND xrdedocno = ? ",
               "   AND xrdaent   = xrdeent ",
               "   AND xrdald    = xrdeld  ",
               "   AND xrdadocno = xrdedocno "              
   PREPARE s_voucher_gen_ar_3_p2 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_3_p2'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_3_cs2 CURSOR FOR s_voucher_gen_ar_3_p2
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_3_cs2'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   
   #贷
               #单号/日期/借/企业/法人/帐套/摘要/科目
   LET l_sql = "SELECT xrcedocno,xrdadocdt,'2',xrceent,xrcecomp,xrceld,xrce010,xrce016,",
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xrce100,xrce101,'',0,'','',xrce017,'','','',",
               #营运据点/部门/利润中心/区域/收款客户/账款客户/客群/产品类别/人员
#               "       xrceorga,xrce018,xrce019,xrce035,xrda005,xrda004,xrce036,xrce020,xrce017,", #160407-00019#2 mod xrda004-->xrda005 #170621-00052#1 20170726 mark by 08172   
               #170605-00007#1 mark
               "       xrceorga,xrce018,xrce019,xrce035,xrda005,xrce038,xrce036,xrce020,xrce017,", #170605-00007#1 xrda004>xrce038  #170621-00052#1 20170726 remark by 08172
               #专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10/现金变动码
               "       xrce022,xrce023,xrce039,xrce040,xrce041,xrce042,xrce043,xrce044,xrce045,",
               "       xrce046,xrce047,xrce048,xrce049,xrce050,xrce051,'',",
               #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
               "       0,xrce119 ,0, xrce109,xrce121,0,xrce129,xrce131,0,xrce139,xrceseq,'xrce','','',",
               "       xrda004,xrda005,'N',xrce015,xrce002,xrce003,xrce004,xrce055  ",   #2015/01/19 BY zhangwei Add xrce002  #20150612 add 'N' lujh   #160509-00004#80 add xrce003,xrce004,xrce055 lujh
               "  FROM xrda_t,xrce_t ",
               " WHERE xrceent   = ",g_enterprise,
               "   AND xrceld    = '",p_ld CLIPPED,"'",
               "   AND xrcedocno = ? ",
               "   AND xrdaent   = xrceent ",
               "   AND xrdald    = xrceld  ",
               "   AND xrdadocno = xrcedocno "               
   PREPARE s_voucher_gen_ar_3_p3 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_3_p3'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_3_cs3 CURSOR FOR s_voucher_gen_ar_3_p3
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_3_cs3'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF   
   
   LET l_sql = "UPDATE xrda_t SET xrda014 = ? ",
               " WHERE xrdaent   = ",g_enterprise,
               "   AND xrdald    = '",p_ld,"'",
               "   AND xrdadocno = ? "
   PREPARE s_voucher_gen_ar_3_p4 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_3_p4'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   #應收帳款
   #借方
               #单号/日期/借/企业/法人/帐套/摘要/科目
   LET l_sql = "SELECT xrcadocno,xrcadocdt,'1',xrcaent,xrcacomp,xrcald,xrcb005,xrcb029,",
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xrca100,xrca101,xrcb006,xrcb101,'','',xrca014,'','','',",
               #营运据点/部门/利润中心/区域/收款客户/账款客户/客群/产品类别/人员
               "       xrcborga,xrcb010,xrcb011,xrcb024,xrca005,xrca004,xrcb036,xrcb012,xrca014,", #160407-00019#2 mod xrca004-->xrca005
               #专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10/现金变动码
               "       xrcb015,xrcb016,xrcb033,xrcb034,xrcb035,'','','','','','','','','','','',",
               #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
               "       xrcb115,0,xrcb007,xrcb105,xrca121,xrcb125,0,xrca131,xrcb135,0,xrcbseq,'xrcb','',xrca039,",
               "       xrca004,xrca005,'N',xrcb022 ",  #20150612 add 'N' lujh 
               "  FROM xrca_t,xrcb_t ",
               " WHERE xrcbent   = ",g_enterprise,
               "   AND xrcbld    = '",p_ld CLIPPED,"'",
               "   AND xrcaent   = xrcbent ",
               "   AND xrcald    = xrcbld  ",
               "   AND xrcadocno = xrcbdocno ",
               "   AND ((xrca001 LIKE 1% AND xreb022 = 1) OR ((xrca001 LIKE 2% AND xreb022 = -1))",
               "   AND ",p_wc
   PREPARE s_voucher_gen_ar_4_p2 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_4_p2'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_4_cs2 CURSOR FOR s_voucher_gen_ar_4_p2
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_4_cs2'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF

   #贷方
   LET l_sql = "SELECT xrcadocno,xrcadocdt,'2',xrcaent,xrcacomp,xrcald,xrcb005,xrcb029,",
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xrca100,xrca101,xrcb006,xrcb101,'','',xrca014,'','','',",
               #营运据点/部门/利润中心/区域/收款客户/账款客户/客群/产品类别/人员
               "       xrcborga,xrcb010,xrcb011,xrcb024,xrca005,xrca004,xrcb036,xrcb012,xrca014,", #160407-00019#2 mod xrca004-->xrca005
               #专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10/现金变动码
               "       xrcb015,xrcb016,xrcb033,xrcb034,xrcb035,'','','','','','','','','','','',",
               #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
               "       0,xrcb115,xrcb007,xrcb105,xrca121,0,xrcb125,xrca131,0,xrcb135,xrcbseq,'xrcb','',xrca039,",
               "       xrca004,xrca005,'N',xrcb022 ",   #20150612 add 'N' lujh
               "  FROM xrca_t,xrcb_t ",
               " WHERE xrcbent   = ",g_enterprise,
               "   AND xrcbld    = '",p_ld CLIPPED,"'",
               "   AND xrcbdocno = ? ",
               "   AND xrcaent   = xrcbent ",
               "   AND xrcald    = xrcbld  ",
               "   AND xrcadocno = xrcbdocno ",
               "   AND ((xrca001 LIKE 1% AND xreb022 = -1) OR ((xrca001 LIKE 2% AND xreb022 = 1))",
               "   AND ",p_wc
   PREPARE s_voucher_gen_ar_4_p3 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_4_p3'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_4_cs3 CURSOR FOR s_voucher_gen_ar_4_p3
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_4_cs3'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF

   #匯差
   #藉方
               #单号/日期/借/企业/法人/帐套/摘要/科目
   #LET l_sql = "SELECT xreb005,xreb008,'1',xrebent,xrebcomp,xrebld,glah003,xreb020,",    #2015/01/07---mark-- 
   LET l_sql = "SELECT xregdocno,xregdocdt,'1',xrebent,xrebcomp,xrebld,glah003,xreb019,",     #2015/01/07---add---
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xreb100,1,'',0,'','',xreb016,'','','',",
               #营运据点/部门/利润中心/区域/收款客户/账款客户/客群/产品类别/人员
               #"       xreb010,xreb011,xreb012,xreb013,xreb009,xreb009,xreb014,xreb015,xreb016,",  #2015/01/07---mark-- 
               "       xreborga,xreb011,xreb012,xreb013,xreb010,xreb009,xreb014,xreb015,xreb016,",  #2015/01/07---add--- #160407-00019#2 mod xreb009-->xreb010
               #专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10/现金变动码
               #"       xreb018,xreb019,'','','','','','','','','','','','','',",                   #2015/01/07---mark--
               "       xreb017,xreb018,xreb020,xreb021,xreb022,'','','','','','','','','','','',",     #2015/01/07---add---       
               #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
               #"       xreb116,0,0,0,xreb121,xreb126,0,xreb131,xreb136,0,xreb006,'xreb','',0,0,xreb009,xreb010  ",   #2015/01/07---mark--
               "       xreb116,0,0,0,xreb121,xreb126,0,xreb131,xreb136,0,xreb006,'xreb','',0,xreb009,xreb010,'N',0 ",     #2015/01/07---add---
               #"  FROM xreg_t,xreb_t LEFT JOIN glah_t ON xrebld = glahld AND glah001 = xreb020 AND glah003 = '",g_prog,"' ",                      #170615-00061#25 mark
               "  FROM xreg_t,xreb_t LEFT JOIN glah_t ON xrebent = glahent AND xrebld = glahld AND glah001 = xreb020 AND glah003 = '",g_prog,"' ", #170615-00061#25 add
               " WHERE xrebent = ",g_enterprise,
               "   AND xrebld  = '",p_ld CLIPPED,"'",
               "   AND xregent=xrebent AND xregld=xrebld AND xreg001=xreb001 AND xreg002=xreb002 AND xreg003=xreb003 ",
#               "   AND xreb001 = '",l_xreb001,"' ",   #yangtt 同過l_wc傳進
#               "   AND xreb002 = '",l_xreb002,"' ",   #yangtt 同過l_wc傳進
               "   AND xreb116 > 0 ",
               "   AND ",p_wc,       #yangtt 添加xreb003模組類型的參數傳入
               " UNION ",
               #单号/日期/借/企业/法人/帐套/摘要/科目
               "SELECT xregdocno,xregdocdt,'1',xrebent,xrebcomp,xrebld,'','",l_glab005d,"',",
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xreb100,1,'',0,'','',xreb016,'','','',",
               #营运据点/部门/利润中心/区域/收款客户/账款客户/客群/产品类别/人员
               #"       xreb010,xreb011,xreb012,xreb013,xreb009,xreb009,xreb014,xreb015,xreb016,",      #2015/01/07---mark-- 
               "       xreborga,xreb011,xreb012,xreb013,xreb010,xreb009,xreb014,xreb015,xreb016,",      #2015/01/07---add--- #160407-00019#2 mod xreb009-->xreb010
               #专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10/现金变动码
               #"       xreb018,xreb019,'','','','','','','','','','','','','',",                       #2015/01/07---mark--
               "       xreb017,xreb018,xreb020,xreb021,xreb022,'','','','','','','','','','','',",         #2015/01/07---add---   
               #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
               #"       xreb116,0,0,0,xreb121,xreb126,0,xreb131,xreb136,0,xreb006,'xreb','',0,0,xreb009,xreb010  ",   #2015/01/07---mark--
               "       xreb116,0,0,0,xreb121,xreb126,0,xreb131,xreb136,0,xreb006,'xreb','',0,xreb009,xreb010,'N',0  ",    #2015/01/07---add---
               #"  FROM xreg_t,xreb_t LEFT JOIN glah_t ON xrebld = glahld AND glah001 = '",l_glab005d,"' AND glah003 = '",g_prog,"'",                      #170615-00061#25 mark
               "  FROM xreg_t,xreb_t LEFT JOIN glah_t ON xrebent = glahent AND xrebld = glahld AND glah001 = '",l_glab005d,"' AND glah003 = '",g_prog,"'", #170615-00061#25 add
               " WHERE xrebent = ",g_enterprise,
               "   AND xrebld  = '",p_ld CLIPPED,"'",
               "   AND xregent=xrebent AND xregld=xrebld AND xreg001=xreb001 AND xreg002=xreb002 AND xreg003=xreb003 ",
#               "   AND xreb001 = '",l_xreb001,"' ",   #yangtt 同過l_wc傳進
#               "   AND xreb002 = '",l_xreb002,"' ",   #yangtt 同過l_wc傳進
               "   AND xreb116 < 0 ",
               "   AND ",p_wc        #yangtt 添加xreb003模組類型的參數傳入
   PREPARE s_voucher_gen_ar_4_p4 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_4_p4'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_4_cs4 CURSOR FOR s_voucher_gen_ar_4_p4
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_4_cs4'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF

   #貸方
               #单号/日期/借/企业/法人/帐套/摘要/科目
   LET l_sql = "SELECT xregdocno,xregdocdt,'2',xrebent,xrebcomp,xrebld,glah003,xreb020,",
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xreb100,1,'',0,'','',xreb016,'','','',",
               #营运据点/部门/利润中心/区域/收款客户/账款客户/客群/产品类别/人员
               "       xreb010,xreb011,xreb012,xreb013,xreb010,xreb009,xreb014,xreb015,xreb016,", #160407-00019#2 mod xreb009-->xreb010
               #专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10/现金变动码
               "       xreb018,xreb019,'','','','','','','','','','','','','','',",
               #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
               "       0,xreb116,0,0,xreb121,0,xreb126,xreb131,0,xreb136,xreb006,'xreb','',0,0,xreb009,xreb010  ",
               #"  FROM xreg_t,xreb_t LEFT JOIN glah_t ON xrebld = glahld AND glah001 = xreb020 AND glah003 = '",g_prog,"' ",                       #170615-00061#25 mark
               "  FROM xreg_t,xreb_t LEFT JOIN glah_t ON xrebent = glahent AND xrebld = glahld AND glah001 = xreb020 AND glah003 = '",g_prog,"' ",  #170615-00061#25 add
               " WHERE xrebent = ",g_enterprise,
               "   AND xrebld  = '",p_ld CLIPPED,"'",
               "   AND xregent=xrebent AND xregld=xrebld AND xreg001=xreb001 AND xreg002=xreb002 AND xreg003=xreb003 ",
#               "   AND xreb001 = '",l_xreb001,"' ",   #yangtt 同過l_wc傳進
#               "   AND xreb002 = '",l_xreb002,"' ",   #yangtt 同過l_wc傳進
               "   AND xreb116 < 0 ",
               "   AND ",p_wc,       #yangtt 添加xreb003模組類型的參數傳入
               " UNION ",
               #单号/日期/借/企业/法人/帐套/摘要/科目
               "SELECT xregdocno,xregdocdt,'2',xrebent,xrebcomp,xrebld,glah003,'",l_glab005c,"',",
               #币别/汇率/计价单位/单价/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       xreb100,1,'',0,'','',xreb016,'','','',",
               #营运据点/部门/利润中心/区域/收款客户/账款客户/客群/产品类别/人员
               "       xreb010,xreb011,xreb012,xreb013,xreb010,xreb009,xreb014,xreb015,xreb016,", #160407-00019#2 mod xreb009-->xreb010
               #专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10/现金变动码
               "       xreb018,xreb019,'','','','','','','','','','','','','','',",
               #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
               "       0,xreb116,0,0,xreb121,0,xreb126,xreb131,0,xreb136,xreb006,'xreb','',0,0,xreb009,xreb010  ",
               #"  FROM xreg_t,xreb_t xreb_t LEFT JOIN glah_t ON xrebld = glahld AND glah001 = '",l_glab005c,"' AND glah003 = '",g_prog,"'",                       #170615-00061#25 mark
               "  FROM xreg_t,xreb_t xreb_t LEFT JOIN glah_t ON xrebent = glahent AND xrebld = glahld AND glah001 = '",l_glab005c,"' AND glah003 = '",g_prog,"'",  #170615-00061#25 add
               " WHERE xrebent = ",g_enterprise,
               "   AND xrebld  = '",p_ld CLIPPED,"'",
               "   AND xregent=xrebent AND xregld=xrebld AND xreg001=xreb001 AND xreg002=xreb002 AND xreg003=xreb003 ",
#               "   AND xreb001 = '",l_xreb001,"' ",  #yangtt 同過l_wc傳進
#               "   AND xreb002 = '",l_xreb002,"' ",  #yangtt 同過l_wc傳進
               "   AND xreb116 > 0 ",
               "   AND ",p_wc        #yangtt 添加xreb003模組類型的參數傳入
   PREPARE s_voucher_gen_ar_4_p5 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_4_p5'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_4_cs5 CURSOR FOR s_voucher_gen_ar_4_p5
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_4_cs5'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF

   #170509-00094#3 add s---
   #agli031按餘額類型產生分錄，agli021科目正常餘額 
   LET l_sql = "SELECT glad002,glac008", 
               "  FROM glad_t",
               "  LEFT JOIN glac_t ON glacent = gladent AND glad001 = glac002 AND glac001 = ?",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld = '",p_ld,"'",
               "   AND glad001 = ?"
   PREPARE s_voucher_gen_ar_2_p14 FROM l_sql      
   #170509-00094#3 add e---
   
   LET r_success = TRUE
   RETURN r_success
################################################################################
END FUNCTION
# Descriptions...: 处理借方科目及金额等
# Memo...........:
# Usage..........: CALL s_voucher_gen_ar_1_ins_tmp(p_type,p_xrcald,p_xrcadocno,p_xrca001)
#                  RETURNING r_success
# Input parameter: p_type         类型 '1'借含税 '2'贷未税 '3'贷税额
#                : p_xrcald       帐套
#                : p_xrcadocno    应收帐款单号
#                : p_xrcacomp     法人
#                : p_xrca001      帳款單性質
# Return code....: r_success      成功否标识位
# Date & Author..: 2014/03/02 By Carrier
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_2_ins_tmp(p_type,p_xrcald,p_xrcadocno,p_xrcacomp,p_xrca001)
   DEFINE p_type           LIKE type_t.chr1
   DEFINE p_xrcald         LIKE xrca_t.xrcald
   DEFINE p_xrcadocno      LIKE xrca_t.xrcadocno
   DEFINE p_xrcacomp       LIKE xrca_t.xrcacomp
   DEFINE p_xrca036        LIKE xrca_t.xrca036
   DEFINE p_xrca001        LIKE xrca_t.xrca001
   DEFINE l_xrcb001        LIKE xrcb_t.xrcb001
   DEFINE l_xrcb023        LIKE xrcb_t.xrcb023
   DEFINE l_xrce015        LIKE xrce_t.xrce015
   DEFINE l_xrca035        LIKE xrca_t.xrca035
   DEFINE l_xrcbseq        LIKE xrcb_t.xrcbseq
   DEFINE l_xrca107        LIKE xrca_t.xrca107
   DEFINE l_xrca117        LIKE xrca_t.xrca117
   DEFINE l_xrca127        LIKE xrca_t.xrca127
   DEFINE l_xrca137        LIKE xrca_t.xrca137
   DEFINE l_amt1           LIKE xrca_t.xrca117
   DEFINE l_amt2           LIKE xrca_t.xrca117
   DEFINE l_amt3           LIKE xrca_t.xrca117
   DEFINE l_amt4           LIKE xrca_t.xrca117
   DEFINE l_flag           LIKE type_t.chr1
   DEFINE l_flag1          LIKE type_t.chr1
   DEFINE r_success        LIKE type_t.num5
   DEFINE l_n              LIKE type_t.num5
   DEFINE l_para_data      LIKE type_t.chr80     #暂估账款传票期初不做回转
   DEFINE l_success        LIKE type_t.num5
   DEFINE l_slip           LIKE type_t.chr20     #20150612 add lujh
   DEFINE l_ooac004        LIKE ooac_t.ooac004   #20150612 add lujh
  #20150604 By 01727
   DEFINE l_xrde002        LIKE xrde_t.xrde002
   DEFINE l_xrde006        LIKE xrde_t.xrde006
   DEFINE l_xrde038        LIKE xrde_t.xrde038
  #20150604 By 01727
   DEFINE l_memo           LIKE glaq_t.glaq001
   DEFINE l_glaa004        LIKE glaa_t.glaa004   
   DEFINE l_glaa005        LIKE glaa_t.glaa005
   DEFINE l_glac016        LIKE glac_t.glac016   
   DEFINE l_glaq020        LIKE glaq_t.glaq020
   DEFINE l_glaq021        LIKE glaq_t.glaq021
   DEFINE l_glaq022        LIKE glaq_t.glaq022
   DEFINE l_glaq023        LIKE glaq_t.glaq023
   DEFINE l_glaq024        LIKE glaq_t.glaq024
   DEFINE l_glaq051        LIKE glaq_t.glaq051
   DEFINE l_glaq052        LIKE glaq_t.glaq052
   DEFINE l_glaq053        LIKE glaq_t.glaq053
   DEFINE l_glaq027        LIKE glaq_t.glaq027
   DEFINE l_glaq028        LIKE glaq_t.glaq028
   DEFINE l_glaq029        LIKE glaq_t.glaq029
   DEFINE l_glaq030        LIKE glaq_t.glaq030
   DEFINE l_glaq031        LIKE glaq_t.glaq031
   DEFINE l_glaq032        LIKE glaq_t.glaq032
   DEFINE l_glaq033        LIKE glaq_t.glaq033
   DEFINE l_glaq034        LIKE glaq_t.glaq034
   DEFINE l_glaq035        LIKE glaq_t.glaq035
   DEFINE l_glaq036        LIKE glaq_t.glaq036
   DEFINE l_glaq037        LIKE glaq_t.glaq037
   DEFINE l_glaq038        LIKE glaq_t.glaq038
   DEFINE l_glaq010        LIKE glaq_t.glaq010
   #160509-00004#34--add--str--lujh
   DEFINE l_xrcb053        LIKE xrcb_t.xrcb053
   DEFINE l_xrcb054        LIKE xrcb_t.xrcb054
   #160509-00004#34--add--end--lujh
   DEFINE l_xrcb056        LIKE xrcb_t.xrcb056  #add by liyan
   DEFINE l_xrcb055        LIKE xrcb_t.xrcb055  #add by liyan
   DEFINE l_xrcb004        LIKE xrcb_t.xrcb004  #add by liyan
   #160509-00004#73--add--str--lujh
   DEFINE l_xrcb057        LIKE xrcb_t.xrcb057  
   DEFINE l_xrcb058        LIKE xrcb_t.xrcb058
   DEFINE l_xrcb059        LIKE xrcb_t.xrcb059
   DEFINE l_xrcb060        LIKE xrcb_t.xrcb060
   DEFINE l_xrcb029        LIKE xrcb_t.xrcb029
   #160509-00004#73--add--end--lujh
  #DEFINE l_tmp            RECORD    #151008-00009#8 mark
   TYPE type_l_tmp         RECORD    #151008-00009#8 
                           docno       LIKE glaq_t.glaqdocno,
                           docdt       LIKE glap_t.glapdocdt,
                           sw          LIKE type_t.chr1,     
                           glaqent     LIKE glaq_t.glaqent,  
                           glaqcomp    LIKE glaq_t.glaqcomp, 
                           glaqld      LIKE glaq_t.glaqld,   
                           glaq001     LIKE glaq_t.glaq001,  
                           glaq002     LIKE glaq_t.glaq002,  
                           glaq005     LIKE glaq_t.glaq005,  
                           glaq006     LIKE glaq_t.glaq006,  
                           glaq007     LIKE glaq_t.glaq007,  
                           glaq009     LIKE glaq_t.glaq009,  
                           glaq011     LIKE glaq_t.glaq011,  
                           glaq012     LIKE glaq_t.glaq012,  
                           glaq013     LIKE glaq_t.glaq013,  
                           glaq014     LIKE glaq_t.glaq014,  
                           glaq015     LIKE glaq_t.glaq015,  
                           glaq016     LIKE glaq_t.glaq016,  
                           glaq017     LIKE glaq_t.glaq017,  
                           glaq018     LIKE glaq_t.glaq018,  
                           glaq019     LIKE glaq_t.glaq019,  
                           glaq020     LIKE glaq_t.glaq020,  
                           glaq021     LIKE glaq_t.glaq021,  
                           glaq022     LIKE glaq_t.glaq022,  
                           glaq023     LIKE glaq_t.glaq023,  
                           glaq024     LIKE glaq_t.glaq024,  
                           glaq025     LIKE glaq_t.glaq025,  
                           glaq027     LIKE glaq_t.glaq027,  
                           glaq028     LIKE glaq_t.glaq028,  
                           glaq051     LIKE glaq_t.glaq051,  #經營方式
                           glaq052     LIKE glaq_t.glaq052,  #渠道 
                           glaq053     LIKE glaq_t.glaq053,  #品牌
                           glaq029     LIKE glaq_t.glaq029,  
                           glaq030     LIKE glaq_t.glaq030,  
                           glaq031     LIKE glaq_t.glaq031,  
                           glaq032     LIKE glaq_t.glaq032,  
                           glaq033     LIKE glaq_t.glaq033,  
                           glaq034     LIKE glaq_t.glaq034,  
                           glaq035     LIKE glaq_t.glaq035,  
                           glaq036     LIKE glaq_t.glaq036,  
                           glaq037     LIKE glaq_t.glaq037,  
                           glaq038     LIKE glaq_t.glaq038,   
                           glbc004     LIKE glbc_t.glbc004,  #现金变动码
                           d           LIKE glaq_t.glaq003,  
                           c           LIKE glaq_t.glaq004,  
                           qty         LIKE glaq_t.glaq008,  
                           sum         LIKE glaq_t.glaq010,
                           glaq039     LIKE glaq_t.glaq039,
                           glaq040     LIKE glaq_t.glaq040,
                           glaq041     LIKE glaq_t.glaq041,
                           glaq042     LIKE glaq_t.glaq042,
                           glaq043     LIKE glaq_t.glaq043,
                           glaq044     LIKE glaq_t.glaq044,
                           seq         LIKE glaq_t.glaqseq,
                           source      LIKE type_t.chr100,
                           glaqseq     LIKE glaq_t.glaqseq,
                           xrca039     LIKE xrca_t.xrca039,
                           b_glaq021   LIKE glaq_t.glaq021,
                           b_glaq022   LIKE glaq_t.glaq022,
                           red         LIKE type_t.chr1       #红冲否(待抵单使用) #20150612 add lujh                           
                           END RECORD
   #151008-00009#8--s          
   DEFINE l_tmp            type_l_tmp   
   DEFINE l_tmp2           type_l_tmp
   #151008-00009#8--e
   DEFINE l_prog           LIKE type_t.chr100
   DEFINE l_n_str          LIKE type_t.chr1000     #160509-00004#45 add lujh
   DEFINE l_xrde001        LIKE xrde_t.xrde001     #160509-00004#45 add lujh
   #151008-00009#8--s
   #160509-00004#80--add--str--lujh
   DEFINE l_xrde108        LIKE xrde_t.xrde108
   DEFINE l_xrde118        LIKE xrde_t.xrde118
   #160509-00004#80--add--end--lujh
   DEFINE l_sfin2019       LIKE type_t.chr1       #遞延負債放交易立帳時同時認列第一期實現收入否
   DEFINE l_glaa139        LIKE glaa_t.glaa139    #遞延收入(負債)管理產生否   
   DEFINE ls_js            STRING
   DEFINE lc_param         RECORD
             xreq003       LIKE xreq_t.xreq003,   #異動類型       #151008-00009#9
             xreq012       LIKE xreq_t.xreq012,   #遞延認列科目
             xreq013       LIKE xreq_t.xreq013,   #銷貨收入科目   #151008-00009#9
             xreq103       LIKE xreq_t.xreq103,   #原幣
             xreq113       LIKE xreq_t.xreq113,   #本幣
             xreq123       LIKE xreq_t.xreq123,   #本位二
             xreq133       LIKE xreq_t.xreq133    #本位三
                       END RECORD   
   #151008-00009#8--e
   DEFINE l_i              LIKE type_t.num5       #151008-00009#9
   #160628-00002#1--add--str--
   DEFINE l_xrce003        LIKE xrce_t.xrce003
   DEFINE l_xrca007        LIKE xrca_t.xrca007
   DEFINE l_xrca011        LIKE xrca_t.xrca011
   #160628-00002#1--add--end
   #160912-00011#4 Add  ---(S)---
   DEFINE l_xrcadocdt      LIKE xrca_t.xrcadocdt
   DEFINE t_xrcadocdt      LIKE xrca_t.xrcadocdt
   #160912-00011#4 Add  ---(E)---
   #170111-00055#1 add lujh axrp133效能优化 
   DEFINE l_glad006        LIKE glad_t.glad006
   DEFINE l_glad036        LIKE glad_t.glad036
   #170111-00055#1 add lujh axrp133效能优化 
   #170310-00049#1-----s
   DEFINE l_xrca001        LIKE xrca_t.xrca001
   DEFINE l_xrcf008        LIKE xrcf_t.xrcf008
   #170310-00049#1-----e
   
   WHENEVER ERROR CONTINUE    

   LET r_success = FALSE                        
   INITIALIZE l_tmp.* TO NULL

   CALL cl_get_para(g_enterprise,p_xrcacomp,'S-FIN-2011') RETURNING l_para_data
   #160912-00011#4 ---(S)---
   SELECT MIN (xrcadocdt) INTO l_xrcadocdt FROM xrca_t WHERE xrcaent = g_enterprise
      AND xrcald = p_xrcald
      AND xrcadocno = p_xrcadocno
   SELECT MIN (xrcadocdt) INTO t_xrcadocdt FROM xrca_t WHERE xrcaent = g_enterprise
      AND xrcald = p_xrcald
      AND xrcadocno IN (SELECT xrcf008 FROM xrcf_t WHERE xrcfent = g_enterprise
                           AND xrcfld = p_xrcald
                           AND xrcfdocno = p_xrcadocno
                        )
   IF NOT cl_null(t_xrcadocdt) THEN
      IF YEAR(t_xrcadocdt) * 12 + MONTH(t_xrcadocdt) >= YEAR(l_xrcadocdt) * 12 + MONTH(l_xrcadocdt) THEN
         LET l_para_data = 'N'
      END IF
   END IF
   #160912-00011#4 ---(S)---
   CALL cl_get_para(g_enterprise,p_xrcacomp,'S-FIN-2019') RETURNING l_sfin2019   #151008-00009#8
   
  #SELECT glaa004,glaa005 INTO l_glaa004,l_glaa005                      #151008-00009#8 mark
   SELECT glaa004,glaa005,glaa139 INTO l_glaa004,l_glaa005,l_glaa139    #151008-00009#8   
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald = p_xrcald
   
   LET l_glac016 = ''
   
   
   #170111-00055#1 mark lujh axrp133效能优化
   ##20150612--add--str--lujh
   ##获取单别
   #CALL s_aooi200_fin_get_slip(p_xrcadocno) RETURNING l_success,l_slip
   ##红冲否    
   #CALL s_fin_get_doc_para(p_xrcald,'',l_slip,'D-FIN-1002') RETURNING l_ooac004
   ##20150612--add--end--lujh
   #170111-00055#1 mark lujh axrp133效能优化
   LET l_ooac004 = g_ooac004   #170111-00055#1 add lujh axrp133效能优化
   
   #150918-00001#3--add--str--lujh
   #程序编号
   LET l_prog = g_prog
   
   CASE 
      WHEN l_prog = 'axrp136' LET l_prog = 'axrt350'
      WHEN l_prog = 'axrp200' LET l_prog = 'axrt210'
      WHEN l_prog = 'axrp138' LET l_prog = 'axrt320'
     #160525-00026#1 Add  ---(S)---
      WHEN l_prog = 'axrp131' LET l_prog = 'axrt320'
      WHEN l_prog = 'axrp132' LET l_prog = 'axrt300'
      WHEN l_prog = 'axrp133' LET l_prog = 'axrt300'
      WHEN l_prog = 'axrp137' LET l_prog = 'axrt310'
     #160525-00026#1 Add  ---(E)---
      WHEN l_prog = 'azzp660' LET l_prog = 'axrt300' #170112-00050#1 add
   END CASE
   #150918-00001#3--add--end--lujh

   CASE p_type
        WHEN '1'  #借:应收帐款
               LET l_amt1 = 0
               LET l_amt2 = 0
               LET l_amt3 = 0
               LET l_amt4 = 0
               LET l_flag = 'N'
               LET l_flag1 = 'N'
               FOREACH s_voucher_gen_ar_2_cs2 USING p_xrcadocno INTO l_tmp.*,l_xrcb001,l_xrcb023,l_xrca107,l_xrca117,l_xrca127,l_xrca137,
                                                                     l_xrcb056,l_xrcb055,l_xrcb057,l_xrcb004,l_xrcb058,l_xrcb059,l_xrcb060,l_xrcb053,l_xrcb054,   #160509-00004#73 add lujh
                                                                     l_xrca007,l_glad006,l_glad036   #170111-00055#1 add lujh axrp133效能优化
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'foreach s_voucher_gen_ar_2_cs2'
                      LET g_errparam.popup = TRUE
                      CALL cl_err()

                      RETURN r_success
                   END IF      
                   
                   #add by liyan--str--
#                   IF g_prog='axrt211' THEN   #170301-00030#8 by 09257 --mark 
                   IF g_prog MATCHES 'axrt211*' THEN   #170301-00030#8 by 09257 --add     
                      #160509-00004#73--add--str--lujh
                      IF l_xrcb060 <> '2' THEN 
                         CONTINUE FOREACH
                      END IF
                      #160509-00004#73--add--end--lujh
                      LET l_tmp.d=l_xrcb056
                   END IF 
                      
#                   IF g_prog='axrt211' OR g_prog='axrp201' OR g_prog='axrt210' THEN   #170301-00030#8 by 09257 --mark
                   IF g_prog MATCHES 'axrt211*' OR g_prog MATCHES 'axrp201*' OR g_prog MATCHES 'axrt210*' THEN   #170301-00030#8 by 09257 --add   
                      #160509-00004#73--add--str--lujh
                      LET l_tmp.glaq021 = l_xrcb053
                      LET l_tmp.glaq022 = l_xrcb054
                      #160509-00004#73--add--str--lujh
                   END IF
                   #add by liyan --end--
                   IF l_amt1 = 0 THEN 
                      LET l_amt1 = l_xrca117
                   END IF
                   IF l_amt2 = 0 THEN 
                      LET l_amt2 = l_xrca127
                   END IF
                   IF l_amt3 = 0 THEN 
                      LET l_amt3 = l_xrca137
                   END IF
                   IF l_amt4 = 0 THEN 
                      LET l_amt4 = l_xrca107
                   END IF
                   
                   LET l_tmp.red = g_ooac004 #170509-00094#3 add
#170509-00094#3 mark s---
#                   #20150612--add--str--lujh
#                   IF p_xrca001 = '22' OR p_xrca001 = '29' THEN 
#                      IF l_ooac004 = 'Y' THEN 
#                         LET l_tmp.red = 'Y'
#                         IF l_tmp.sum < 0 THEN 
#                            LET l_tmp.sum = l_tmp.sum * -1
#                         END IF
#                      END IF
#                   ELSE
#170509-00094#3 mark e---
#                   #20150612--add--end--lujh
                      #若為負數金額,則借貸方向要相反
                      IF l_tmp.d < 0 THEN 
                         LET l_tmp.sw = '2'
                         LET l_tmp.c = l_tmp.d * -1
                         LET l_tmp.d = 0
                         LET l_tmp.glaq041 = l_tmp.glaq040 * -1
                         LET l_tmp.glaq040 = 0
                         LET l_tmp.glaq044 = l_tmp.glaq043 * -1
                         LET l_tmp.glaq043 = 0
                      END IF
#                   END IF  #170509-00094#3 mark
                   
                   #161223-00028#1--add--str--lujh
                   IF l_tmp.d = 0 AND l_tmp.c = 0 THEN 
                      CONTINUE FOREACH
                   END IF
                   #161223-00028#1--add--end--lujh
                   
                   #170111-00055#1 add lujh axrp133效能优化
                   IF cl_null(l_tmp.glaq001) THEN  #170310-00016#1 add xul
                      CALL s_aap_get_glab010(p_xrcald,'13',l_xrca007,'8304_01',l_tmp.glaq001,
                             p_xrcadocno,l_tmp.seq,'AR','1',l_tmp.glaq002,'glgb001')
                      RETURNING l_tmp.glaq001
                   END IF #170310-00016#1 add xul
                   IF cl_null(l_tmp.glbc004) THEN    #170310-00016#1 add xul
                      IF l_tmp.d <> 0 THEN 
                         LET l_tmp.glbc004 = l_glad006
                      END IF
                      
                      IF l_tmp.c <> 0 THEN 
                         LET l_tmp.glbc004 = l_glad036
                      END IF
                   END IF   #170310-00016#1 add xul 
                   #170111-00055#1 add lujh axrp133效能优化
                   
                   #170111-00055#1 mark lujh axrp133效能优化
                   #IF cl_null(l_tmp.glaq001) THEN
                   #   CALL s_axrt300_get_meno(p_xrcald,p_xrcadocno,l_tmp.seq,l_tmp.glaq002)
                   #      RETURNING l_success,l_memo
                   #   LET l_tmp.glaq001 = l_tmp.glaq001,l_memo
                   #   IF cl_null(l_tmp.glaq001) THEN 
                   #      LET l_tmp.glaq001 = ''
                   #   END IF
                   #END IF
                   #
                   ##150918-00001#3--add--str--lujh
                   #IF cl_null(l_tmp.glaq001) THEN
                   #   #                 2:摘要/账套/科目编号  /程序编号/目的字段/单据编号/单据项次1/单据项次2
                   #   CALL s_account_item('2',p_xrcald,l_tmp.glaq002,l_prog,'glgb001',p_xrcadocno,l_tmp.seq,'') #160927-00008#1 mod 'xrcb047'-->'glgb001'
                   #   RETURNING l_memo
                   #   IF NOT cl_null(l_memo) THEN
                   #      LET l_tmp.glaq001 = l_memo
                   #   END IF
                   #END IF
                   ##150918-00001#3--add--end--lujh
                   #                      
                   #CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
                   #
                   #IF cl_null(l_tmp.glbc004) AND l_glac016 = 'Y' THEN 
                   #   CALL s_voucher_glad006_get(p_xrcald,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glbc004
                   #END IF
                   #
                   #CALL s_voucher_get_glas003(p_xrcald,l_tmp.glaq002) 
                   #RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                   #          l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                   #          l_glaq035,l_glaq036,l_glaq037,l_glaq038
                   #          
                   #IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
                   #IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
                   #IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
                   #IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
                   #IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
                   #IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
                   #IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
                   #IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
                   #IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
                   #IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
                   #IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
                   #IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
                   #IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
                   #IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
                   #IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
                   #IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
                   #IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
                   #IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
                   #IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
                   #IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF
                   #170111-00055#1 mark lujh axrp133效能优化
                            
                   INSERT INTO s_vr_tmp04 VALUES(l_tmp.*)  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'insert s_vr_tmp04'  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                      LET g_errparam.popup = TRUE
                      CALL cl_err()
                   
                      RETURN r_success                   
                   END IF 
                   
                   IF l_amt1 <> 0 AND l_flag1 = 'N' THEN   #有直接冲账金额或直接冲账金额没有分摊完
                      IF l_tmp.d <= 0 THEN 
                         IF l_amt1 <= l_tmp.c THEN   #直接冲账净额小于等于应收金额,直接分摊到金额最大的应收金额
                            LET l_tmp.sw = '1'
                            LET l_tmp.d = l_amt1
                            LET l_tmp.c = 0
                            LET l_tmp.glaq040 = l_amt2
                            LET l_tmp.glaq041 = 0
                            LET l_tmp.glaq043 = l_amt3
                            LET l_tmp.glaq044 = 0
                            LET l_tmp.sum = l_amt4
                            
                            LET l_flag = 'Y'    #直接冲账金额分摊完
                         ELSE            #直接冲账净额大于应收金额,从最大金额开始依次拆分
                            LET l_tmp.sw = '1'
                            LET l_tmp.d = l_tmp.c
                            LET l_tmp.c = 0
                            LET l_tmp.glaq040 = l_tmp.glaq041
                            LET l_tmp.glaq041 = 0
                            LET l_tmp.glaq043 = l_tmp.glaq044
                            LET l_tmp.glaq044 = 0
                            
                            LET l_amt1 = l_amt1 - l_tmp.d * -1
                            LET l_amt2 = l_amt2 - l_tmp.glaq040 * -1
                            LET l_amt3 = l_amt3 - l_tmp.glaq043 * -1
                            LET l_glaq010 = l_tmp.sum
                            IF l_glaq010 < 0 THEN 
                               LET l_glaq010 = l_glaq010 * -1
                            END IF
                            LET l_amt4 = l_amt4 - l_glaq010
                         END IF
                      ELSE
                         IF l_amt1 <= l_tmp.d THEN   #直接冲账净额小于等于应收金额,直接分摊到金额最大的应收金额
                            LET l_tmp.sw = '2'
                            LET l_tmp.d = 0
                            LET l_tmp.c = l_amt1
                            LET l_tmp.glaq040 = 0
                            LET l_tmp.glaq041 = l_amt2
                            LET l_tmp.glaq043 = 0
                            LET l_tmp.glaq044 = l_amt3
                            LET l_tmp.sum = l_amt4 * -1
                            
                            LET l_flag = 'Y'    #直接冲账金额分摊完
                         ELSE            #直接冲账净额大于应收金额,从最大金额开始依次拆分
                            LET l_tmp.sw = '2'
                            LET l_tmp.c = l_tmp.d
                            LET l_tmp.d = 0
                            LET l_tmp.glaq041 = l_tmp.glaq042
                            LET l_tmp.glaq040 = 0
                            LET l_tmp.glaq044 = l_tmp.glaq043
                            LET l_tmp.glaq043 = 0
                            
                            LET l_amt1 = l_amt1 - l_tmp.c
                            LET l_amt2 = l_amt2 - l_tmp.glaq041
                            LET l_amt3 = l_amt3 - l_tmp.glaq044
                            LET l_tmp.sum = l_tmp.sum * -1
                            LET l_glaq010 = l_tmp.sum
                            IF l_glaq010 < 0 THEN 
                               LET l_glaq010 = l_glaq010 * -1
                            END IF
                            LET l_amt4 = l_amt4 - l_glaq010
                         END IF
                      END IF 
                      
                      #170111-00055#1 add lujh axrp133效能优化
                      IF cl_null(l_tmp.glaq001) THEN  #170310-00016#1 add xul                    
                         CALL s_aap_get_glab010(p_xrcald,'13',l_xrca007,'8304_01',l_tmp.glaq001,
                                p_xrcadocno,l_tmp.seq,'AR','1',l_tmp.glaq002,'glgb001')
                         RETURNING l_tmp.glaq001
                      END IF   #170310-00016#1 add xul                        
                      IF cl_null(l_tmp.glbc004) THEN    #170310-00016#1 add xul
                         IF l_tmp.d <> 0 THEN 
                            LET l_tmp.glbc004 = l_glad006
                         END IF
                         
                         IF l_tmp.c <> 0 THEN 
                            LET l_tmp.glbc004 = l_glad036
                         END IF
                      END IF  #170310-00016#1 add xul
                      #170111-00055#1 add lujh axrp133效能优化
                      
                      #170111-00055#1 mark lujh axrp133效能优化
                      #IF cl_null(l_tmp.glaq001) THEN
                      #   CALL s_axrt300_get_meno(p_xrcald,p_xrcadocno,l_tmp.seq,l_tmp.glaq002)
                      #      RETURNING l_success,l_memo
                      #   LET l_tmp.glaq001 = l_tmp.glaq001,l_memo
                      #   IF cl_null(l_tmp.glaq001) THEN 
                      #      LET l_tmp.glaq001 = ''
                      #   END IF
                      #END IF
                      #
                      ##150918-00001#3--add--str--lujh
                      #IF cl_null(l_tmp.glaq001) THEN
                      #   #                 2:摘要/账套/科目编号  /程序编号/目的字段/单据编号/单据项次1/单据项次2
                      #   CALL s_account_item('2',p_xrcald,l_tmp.glaq002,l_prog,'glgb001',p_xrcadocno,l_tmp.seq,'') #160927-00008#1 mod 'xrcb047'-->'glgb001'
                      #   RETURNING l_memo
                      #   IF NOT cl_null(l_memo) THEN
                      #      LET l_tmp.glaq001 = l_memo
                      #   END IF
                      #END IF
                      ##150918-00001#3--add--end--lujh
                      #
                      #CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
                      #
                      #IF cl_null(l_tmp.glbc004) AND l_glac016 = 'Y' THEN 
                      #   CALL s_voucher_glad006_get(p_xrcald,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glbc004
                      #END IF
                      #170111-00055#1 mark lujh axrp133效能优化
                      
                      #20150612--add--str--lujh
                      IF p_xrca001 = '22' OR p_xrca001 = '29' THEN  
                         IF l_ooac004 = 'Y' THEN 
                            LET l_tmp.red = 'Y'
                            IF l_tmp.sum < 0 THEN 
                               LET l_tmp.sum = l_tmp.sum * -1
                            END IF
                         END IF
                      END IF
                      #20150612--add--end--lujh

                      INSERT INTO s_vr_tmp04 VALUES(l_tmp.*)  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                      IF SQLCA.sqlcode THEN
                         INITIALIZE g_errparam TO NULL
                         LET g_errparam.code = SQLCA.sqlcode
                         LET g_errparam.extend = 'insert s_vr_tmp04'  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                         LET g_errparam.popup = TRUE
                         CALL cl_err()
                      
                         RETURN r_success                   
                      END IF
                      
                      IF l_flag = 'Y' THEN 
                         LET l_flag1 = 'Y'
                      END IF
                   END IF
                   
               END FOREACH        
        WHEN '2'
               FOREACH s_voucher_gen_ar_2_cs3 USING p_xrcadocno INTO l_tmp.*,l_xrcb001,l_xrcb023,l_xrcb053,l_xrcb054,   #160509-00004#34 add l_xrcb053,l_xrcb054 lujh
                                                                     l_xrcb055,l_xrcb057,l_xrcb029,l_xrcb058,l_xrcb060,    #160509-00004#73 add lujh 
                                                                     l_xrca007,l_glad006,l_glad036   #170111-00055#1 add lujh axrp133效能优化                                                                      
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'foreach s_voucher_gen_ar_2_cs2'
                      LET g_errparam.popup = TRUE
                      CALL cl_err()

                      RETURN r_success
                   END IF
   
                   #160509-00004#34--add--str--lujh
#                   IF g_prog = 'axrt351' OR g_prog = 'axrt211' OR g_prog='axrp201' OR g_prog='axrt210' THEN   #160509-00004#73 OR g_prog = 'axrt211' lujh   #170301-00030#8 by 09257 --mark
                   IF g_prog MATCHES 'axrt351*' OR g_prog MATCHES 'axrt211*' OR g_prog MATCHES 'axrp201*' OR g_prog MATCHES 'axrt210*' THEN   #160509-00004#73 OR g_prog = 'axrt211' lujh   #170301-00030#8 by 09257 --add   
                      LET l_tmp.glaq021 = l_xrcb053
                      LET l_tmp.glaq022 = l_xrcb054
                   END IF
                   #160509-00004#34--add--end--lujh
                   
                   #160509-00004#73--add--str--lujh
#                   IF g_prog = 'axrt211' THEN 
                   IF g_prog MATCHES 'axrt211*' THEN 
                      IF l_xrcb060 = '1' THEN 
                         LET l_tmp.c = l_xrcb057
                         LET l_tmp.glaq002 = l_xrcb029
                      END IF
                      IF l_xrcb060 = '3' THEN 
                         LET l_tmp.c = l_xrcb055
                         LET l_tmp.glaq002 = l_xrcb058
                      END IF
                   END IF
                   #160509-00004#73--add--end--lujh
                   
                   #161223-00028#1--add--str--lujh
                   IF l_tmp.d = 0 AND l_tmp.c = 0 THEN 
                      CONTINUE FOREACH
                   END IF
                   #161223-00028#1--add--end--lujh
                  
                   LET l_tmp.red = g_ooac004 #170509-00094#3 add                  
                   IF l_xrcb023 = 'Y' AND l_para_data = 'N' THEN   #单身为冲暂估且为出货单时,贷方抓xrcf
                      #161212-00024#1 Mark ---(S)---
                     #LET l_xrcbseq = l_tmp.seq
                     #INITIALIZE l_tmp.* TO NULL
                     #
                     #FOREACH s_voucher_gen_ar_2_cs16 USING p_xrcadocno,l_xrcbseq INTO l_tmp.*
                     #   IF SQLCA.sqlcode THEN
                     #      INITIALIZE g_errparam TO NULL
                     #      LET g_errparam.code = SQLCA.sqlcode
                     #      LET g_errparam.extend = 'foreach s_voucher_gen_ar_2_cs2'
                     #      LET g_errparam.popup = TRUE
                     #      CALL cl_err()
                     #
                     #      RETURN r_success
                     #   END IF
                     #   
                     #   IF l_xrcb001 = '21' OR l_xrcb001 = '29' THEN 
                     #      LET l_tmp.sw = '1'
                     #      LET l_tmp.d = l_tmp.c
                     #      LET l_tmp.c = 0
                     #      LET l_tmp.glaq040 = l_tmp.glaq041
                     #      LET l_tmp.glaq041 = 0
                     #      LET l_tmp.glaq043 = l_tmp.glaq044
                     #      LET l_tmp.glaq044 = 0 
                     #      LET l_tmp.sum = l_tmp.sum * -1
                     #   END IF
                     #
                     #   #150918-00001#3--add--str--lujh
                     #   IF cl_null(l_tmp.glaq001) THEN
                     #      #                 2:摘要/账套/科目编号  /程序编号/目的字段/单据编号/单据项次1/单据项次2
                     #      CALL s_account_item('2',p_xrcald,l_tmp.glaq002,l_prog,'glgb001',p_xrcadocno,l_tmp.seq,'')#160927-00008#1 mod 'xrcf049'-->'glgb001'
                     #      RETURNING l_memo
                     #      IF NOT cl_null(l_memo) THEN
                     #         LET l_tmp.glaq001 = l_memo
                     #      END IF
                     #   END IF
                     #   #150918-00001#3--add--end--lujh
                     #   
                     #   #160322--(S)
                     #   IF cl_null(l_tmp.glaq001) THEN
                     #      CALL s_axrt300_get_meno(p_xrcald,p_xrcadocno,l_tmp.seq,l_tmp.glaq002)
                     #         RETURNING l_success,l_memo
                     #      LET l_tmp.glaq001 = l_tmp.glaq001,l_memo
                     #      IF cl_null(l_tmp.glaq001) THEN 
                     #         LET l_tmp.glaq001 = ''
                     #      END IF
                     #   END IF
                     #   #160322--(E)
                     #   
                     #   CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
                     #   
                     #   IF cl_null(l_tmp.glbc004) AND l_glac016 = 'Y' THEN 
                     #      CALL s_voucher_glad006_get(p_xrcald,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glbc004
                     #   END IF
                     #
                     #   INSERT INTO s_vr_tmp04 VALUES(l_tmp.*)  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                     #   IF SQLCA.sqlcode THEN
                     #      INITIALIZE g_errparam TO NULL
                     #      LET g_errparam.code = SQLCA.sqlcode
                     #      LET g_errparam.extend = 'insert s_vr_tmp04'  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                     #      LET g_errparam.popup = TRUE
                     #      CALL cl_err()
                     #   
                     #      RETURN r_success                   
                     #   END IF   
                     #END FOREACH
                     #160816-00014#1 Add  ---(S)---
                     #LET l_xrcbseq = l_tmp.seq
                     #INITIALIZE l_tmp.* TO NULL
                     #
                     #FOREACH s_voucher_gen_ar_2_cs21 USING p_xrcadocno,l_xrcbseq INTO l_tmp.*
                     #   IF SQLCA.sqlcode THEN
                     #      INITIALIZE g_errparam TO NULL
                     #      LET g_errparam.code = SQLCA.sqlcode
                     #      LET g_errparam.extend = 'foreach s_voucher_gen_ar_2_cs2'
                     #      LET g_errparam.popup = TRUE
                     #      CALL cl_err()
                     #
                     #      RETURN r_success
                     #   END IF
                     #   
                     #   IF l_xrcb001 = '21' OR l_xrcb001 = '29' THEN 
                     #      LET l_tmp.sw = '2'
                     #      LET l_tmp.c = l_tmp.d * -1
                     #      LET l_tmp.d = 0
                     #      LET l_tmp.glaq041 = l_tmp.glaq040 * -1
                     #      LET l_tmp.glaq040 = 0
                     #      LET l_tmp.glaq044 = l_tmp.glaq043 * -1
                     #      LET l_tmp.glaq043 = 0
                     #      LET l_tmp.sum = l_tmp.sum * -1
                     #   END IF
                     #
                     #   IF cl_null(l_tmp.glaq001) THEN
                     #      #                 2:摘要/账套/科目编号  /程序编号/目的字段/单据编号/单据项次1/单据项次2
                     #      CALL s_account_item('2',p_xrcald,l_tmp.glaq002,l_prog,'glgb001',p_xrcadocno,l_tmp.seq,'')#160927-00008#1 mod 'xrcf049'-->'glgb001'
                     #      RETURNING l_memo
                     #      IF NOT cl_null(l_memo) THEN
                     #         LET l_tmp.glaq001 = l_memo
                     #      END IF
                     #   END IF
                     #
                     #   IF cl_null(l_tmp.glaq001) THEN
                     #      CALL s_axrt300_get_meno(p_xrcald,p_xrcadocno,l_tmp.seq,l_tmp.glaq002)
                     #         RETURNING l_success,l_memo
                     #      LET l_tmp.glaq001 = l_tmp.glaq001,l_memo
                     #      IF cl_null(l_tmp.glaq001) THEN 
                     #         LET l_tmp.glaq001 = ''
                     #      END IF
                     #   END IF
                     #
                     #   CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
                     #   
                     #   IF cl_null(l_tmp.glbc004) AND l_glac016 = 'Y' THEN 
                     #      CALL s_voucher_glad006_get(p_xrcald,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glbc004
                     #   END IF
                     #
                     #   INSERT INTO s_vr_tmp04 VALUES(l_tmp.*)
                     #   IF SQLCA.sqlcode THEN
                     #      INITIALIZE g_errparam TO NULL
                     #      LET g_errparam.code = SQLCA.sqlcode
                     #      LET g_errparam.extend = 'insert s_vr_tmp04'
                     #      LET g_errparam.popup = TRUE
                     #      CALL cl_err()
                     #   
                     #      RETURN r_success                   
                     #   END IF   
                     #END FOREACH
                     ##160816-00014#1 Add  ---(E)---
                      #161212-00024#1 Mark ---(E)---
                   ELSE
#170509-00094#3 mark s---                   
#                      #20150612--add--str--lujh
#                      IF p_xrca001 = '22' OR p_xrca001 = '29' THEN 
#                         IF l_ooac004 = 'Y' THEN 
#                            LET l_tmp.red = 'Y'
#                            IF l_tmp.sum > 0 THEN 
#                               LET l_tmp.sum = l_tmp.sum * -1
#                            END IF
#                         END IF
#                      ELSE
#170509-00094#3 mark e---
                      #20150612--add--end--lujh
                         #若為負數金額,則借貸方向要相反
                         IF l_tmp.c < 0 THEN 
                            LET l_tmp.sw = '1'
                            LET l_tmp.d = l_tmp.c * -1
                            LET l_tmp.c = 0
                            LET l_tmp.glaq040 = l_tmp.glaq041 * -1
                            LET l_tmp.glaq041 = 0
                            LET l_tmp.glaq043 = l_tmp.glaq044 * -1
                            LET l_tmp.glaq044 = 0
                         END IF
#                      END IF   #20150612 add lujh #170509-00094#3 mark e---
                      #151008-00009#8--s
                      #遞延收入(負債)管理產生否
                      IF l_glaa139 = 'Y' THEN
                         LET ls_js = ''
                         LET l_tmp2.* = l_tmp.*   
                         #取得遞延科目與首期沖轉金額
                         CALL s_axrt470_get_first_xreq(p_xrcald,p_xrcadocno,l_tmp.seq,'') RETURNING ls_js
                         CALL util.JSON.parse(ls_js,lc_param)         
                         #遞延科目不是空的,代表有存在對應應收單號+項次之遞延檔,才需要往下處理
                         IF NOT cl_null(lc_param.xreq012) THEN    
                            #160805-00027#1--s
                            #單據性質屬於2*:待抵單,切立遞延分錄時,所取得遞延檔的金額,必須也轉負數處理,避免金額與單頭應收金額差異
                            IF p_xrca001 MATCHES '2*' THEN
                               LET lc_param.xreq103 = lc_param.xreq103 * -1
                               LET lc_param.xreq113 = lc_param.xreq113 * -1
                               LET lc_param.xreq123 = lc_param.xreq123 * -1
                               LET lc_param.xreq133 = lc_param.xreq133 * -1
                            END IF
                            #160805-00027#1--e                            
                            #151008-00009#9--S
                            #####21:銷退沖轉#####
                            #取銷退沖轉之遞延檔金額,對原出貨單遞延認列之銷貨收入做沖抵,借[1.遞延收入],貸[2.銷貨收入]
                            IF lc_param.xreq003 = '21' THEN   
                               FOR l_i = 1 TO 2
                                  #-----[1.遞延收入][2.銷貨收入]分錄-----(S)--#                      
                                  #待抵2*
                                  IF p_xrca001 MATCHES '2*' THEN
                                     CASE l_i
                                        WHEN 2 LET l_tmp2.glaq002 = lc_param.xreq012      #遞延收入科目
                                        WHEN 1 LET l_tmp2.glaq002 = lc_param.xreq013      #銷貨收入科目
                                     END CASE                                  
                                  ELSE
                                  #負向暫估02/04
                                     CASE l_i
                                        WHEN 1 LET l_tmp2.glaq002 = lc_param.xreq012      #遞延收入科目
                                        WHEN 2 LET l_tmp2.glaq002 = lc_param.xreq013      #銷貨收入科目
                                     END CASE
                                  END IF                                  
                                  LET l_tmp2.sum = lc_param.xreq103          #原幣金額
                                  #處理有金額的一方
                                  IF l_tmp2.d > 0 THEN
                                     LET l_tmp2.d = lc_param.xreq113         #本幣  (借)
                                     LET l_tmp2.glaq040 = lc_param.xreq123   #本位二(借)
                                     LET l_tmp2.glaq043 = lc_param.xreq133   #本位三(借)
                                     #處理銷貨收入科目的時候借貸相反
                                     IF l_i = 2 THEN
                                        LET l_tmp.sw = '2'
                                        LET l_tmp2.c = l_tmp2.d
                                        LET l_tmp2.d = 0
                                        LET l_tmp2.glaq041 = l_tmp2.glaq040
                                        LET l_tmp2.glaq040 = 0
                                        LET l_tmp2.glaq044 = l_tmp2.glaq043
                                        LET l_tmp2.glaq043 = 0                                        
                                     END IF                                         
                                  ELSE
                                     LET l_tmp2.c = lc_param.xreq113         #本幣  (貸)   
                                     LET l_tmp2.glaq041 = lc_param.xreq123   #本位二(貸)   
                                     LET l_tmp2.glaq044 = lc_param.xreq133   #本位三(貸)   
                                     #處理銷貨收入科目的時候借貸相反
                                     IF l_i = 2 THEN
                                        LET l_tmp2.sw = '1'
                                        LET l_tmp2.d = l_tmp2.c
                                        LET l_tmp2.c = 0
                                        LET l_tmp2.glaq040 = l_tmp2.glaq041
                                        LET l_tmp2.glaq041 = 0
                                        LET l_tmp2.glaq043 = l_tmp2.glaq044
                                        LET l_tmp2.glaq044 = 0                                    
                                     END IF                                         
                                  END IF              
                              
                                  IF l_tmp2.d <> 0 OR l_tmp2.c <> 0 THEN                         
                                     #後面寫入s_voucher_ar_tmp前的處理在這邊都處理一遍,因為要多插一條分錄進來
                                     #170111-00055#1 add lujh axrp133效能优化
                                     IF cl_null(l_tmp2.glaq001) THEN  #170310-00016#1 add xul   
                                        CALL s_aap_get_glab010(p_xrcald,'13',l_xrca007,'8304_01',l_tmp2.glaq001, #170310-00016#1 MOD l_tmp.glaq001 -> l_tmp2.glaq001
                                               p_xrcadocno,l_tmp2.seq,'AR','1',l_tmp2.glaq002,'glgb001') #170310-00016#1 MOD  l_tmp.seq->l_tmp2.seq, l_tmp.glaq002->l_tmp2.glaq002
                                        RETURNING l_tmp2.glaq001 #170310-00016#1 MOD l_tmp.glaq001->l_tmp2.glaq001
                                     END IF #170310-00016#1 add xul   
                                     IF cl_null(l_tmp2.glbc004) THEN  #170310-00016#1 add xul   
                                        IF l_tmp2.d <> 0 THEN  #170310-00016#1  mod l_tmp.d->l_tmp2.d
                                           LET l_tmp2.glbc004 = l_glad006 #170310-00016#1  mod l_tmp.glbc004-> l_tmp2.glbc004
                                        END IF
                                        
                                        IF l_tmp2.c <> 0 THEN  #170310-00016#1  mod l_tmp.c->l_tmp2.c
                                           LET l_tmp2.glbc004 = l_glad036 #170310-00016#1  mod l_tmp.glbc004-> l_tmp2.glbc004
                                        END IF
                                     END IF  #170310-00016#1 add xul   
                                     #170111-00055#1 add lujh axrp133效能优化
                                     
                                     #170111-00055#1 mark lujh axrp133效能优化
                                     #IF cl_null(l_tmp2.glaq001) THEN
                                     #   #                 2:摘要/账套/科目编号  /程序编号/目的字段/单据编号/单据项次1/单据项次2
                                     #   CALL s_account_item('2',p_xrcald,l_tmp2.glaq002,l_prog,'glgb001',p_xrcadocno,l_tmp2.seq,'')#160927-00008#1 mod 'xrcb047'-->'glgb001'
                                     #   RETURNING l_memo
                                     #   IF NOT cl_null(l_memo) THEN
                                     #      LET l_tmp2.glaq001 = l_memo
                                     #   END IF
                                     #END IF
                                     #                         
                                     #IF cl_null(l_tmp2.glaq001) THEN
                                     #   CALL s_axrt300_get_meno(p_xrcald,p_xrcadocno,l_tmp2.seq,l_tmp2.glaq002)
                                     #      RETURNING l_success,l_memo
                                     #   LET l_tmp2.glaq001 = l_tmp2.glaq001,l_memo
                                     #   IF cl_null(l_tmp2.glaq001) THEN 
                                     #      LET l_tmp2.glaq001 = ''
                                     #   END IF
                                     #END IF                      
                                     #
                                     #CALL s_voucher_glac016_get(l_glaa004,l_tmp2.glaq002) RETURNING l_glac016
                                     #
                                     #IF cl_null(l_tmp2.glbc004) AND l_glac016 = 'Y' THEN 
                                     #   CALL s_voucher_glad006_get(p_xrcald,l_tmp2.glaq002,l_tmp2.d,l_tmp2.c) RETURNING l_tmp2.glbc004
                                     #END IF
                                     #
                                     #CALL s_voucher_get_glas003(p_xrcald,l_tmp2.glaq002) 
                                     #RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                                     #          l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                                     #          l_glaq035,l_glaq036,l_glaq037,l_glaq038
                                     #          
                                     #IF NOT cl_null(l_glaq020) THEN LET l_tmp2.glaq020 = l_glaq020 END IF
                                     #IF NOT cl_null(l_glaq021) THEN LET l_tmp2.glaq021 = l_glaq021 END IF
                                     #IF NOT cl_null(l_glaq022) THEN LET l_tmp2.glaq022 = l_glaq022 END IF
                                     #IF NOT cl_null(l_glaq023) THEN LET l_tmp2.glaq023 = l_glaq023 END IF
                                     #IF NOT cl_null(l_glaq024) THEN LET l_tmp2.glaq024 = l_glaq024 END IF
                                     #IF NOT cl_null(l_glaq051) THEN LET l_tmp2.glaq051 = l_glaq051 END IF
                                     #IF NOT cl_null(l_glaq052) THEN LET l_tmp2.glaq052 = l_glaq052 END IF
                                     #IF NOT cl_null(l_glaq053) THEN LET l_tmp2.glaq053 = l_glaq053 END IF
                                     #IF NOT cl_null(l_glaq027) THEN LET l_tmp2.glaq027 = l_glaq027 END IF
                                     #IF NOT cl_null(l_glaq028) THEN LET l_tmp2.glaq028 = l_glaq028 END IF
                                     #IF NOT cl_null(l_glaq029) THEN LET l_tmp2.glaq029 = l_glaq029 END IF
                                     #IF NOT cl_null(l_glaq030) THEN LET l_tmp2.glaq030 = l_glaq030 END IF
                                     #IF NOT cl_null(l_glaq031) THEN LET l_tmp2.glaq031 = l_glaq031 END IF
                                     #IF NOT cl_null(l_glaq032) THEN LET l_tmp2.glaq032 = l_glaq032 END IF
                                     #IF NOT cl_null(l_glaq033) THEN LET l_tmp2.glaq032 = l_glaq033 END IF
                                     #IF NOT cl_null(l_glaq034) THEN LET l_tmp2.glaq032 = l_glaq034 END IF
                                     #IF NOT cl_null(l_glaq035) THEN LET l_tmp2.glaq032 = l_glaq035 END IF
                                     #IF NOT cl_null(l_glaq036) THEN LET l_tmp2.glaq032 = l_glaq036 END IF
                                     #IF NOT cl_null(l_glaq037) THEN LET l_tmp2.glaq032 = l_glaq037 END IF
                                     #IF NOT cl_null(l_glaq038) THEN LET l_tmp2.glaq032 = l_glaq038 END IF
                                     #170111-00055#1 mark lujh axrp133效能优化
               
                                     INSERT INTO s_vr_tmp04 VALUES(l_tmp2.*)  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                                     IF SQLCA.sqlcode THEN
                                        INITIALIZE g_errparam TO NULL
                                        LET g_errparam.code = SQLCA.sqlcode
                                        LET g_errparam.extend = 'insert s_vr_tmp04'  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                                        LET g_errparam.popup = TRUE
                                        CALL cl_err()
                                     
                                        RETURN r_success                   
                                     END IF         
                                  END IF
                               END FOR                                                           
                               #-----[1.遞延收入][2.銷貨收入]分錄-----(E)--#                            
                            ELSE                                                          
                            #151008-00009#9--E
                            #####[2:每期沖轉/4:折讓沖轉]#####
                            #金額除了首期沖轉金額仍視為[1.銷貨收入],剩餘認列為[2.遞延收入],共會有兩條借方分錄

                               #-----[1.銷貨收入]分錄-----(S)--#                      
                               LET l_tmp2.sum = lc_param.xreq103          #原幣金額
                               #處理有金額的一方
                               IF l_tmp2.d > 0 THEN
                                  LET l_tmp2.d = lc_param.xreq113         #本幣  (借)
                                  LET l_tmp2.glaq040 = lc_param.xreq123   #本位二(借)
                                  LET l_tmp2.glaq043 = lc_param.xreq133   #本位三(借)
                               ELSE
                                  LET l_tmp2.c = lc_param.xreq113         #本幣  (貸)   
                                  LET l_tmp2.glaq041 = lc_param.xreq123   #本位二(貸)   
                                  LET l_tmp2.glaq044 = lc_param.xreq133   #本位三(貸)   
                               END IF                        
                               IF l_tmp2.d <> 0 OR l_tmp2.c <> 0 THEN                         
                                  #後面寫入s_voucher_ar_tmp前的處理在這邊都處理一遍,因為要多插一條分錄進來
                                  #170111-00055#1 add lujh axrp133效能优化
                                  IF cl_null(l_tmp2.glaq001) THEN #170310-00016#1 ADD xul 
                                     CALL s_aap_get_glab010(p_xrcald,'13',l_xrca007,'8304_01',l_tmp2.glaq001, #170310-00016#1 mod l_tmp.glaq001->l_tmp2.glaq001
                                            p_xrcadocno,l_tmp2.seq,'AR','1',l_tmp2.glaq002,'glgb001') #170310-00016#1 mod l_tmp.seq->l_tmp2.seq,l_tmp.glaq002 ->l_tmp2.glaq002
                                     RETURNING l_tmp2.glaq001   #170310-00016#1 mod l_tmp.glaq001 ->l_tmp2.glaq001 
                                  END IF  #170310-00016#1 ADD xul 
                                  IF cl_null(l_tmp2.glbc004) THEN  #170310-00016#1 ADD xul 
                                     IF l_tmp2.d <> 0 THEN  #170310-00016#1 mod l_tmp.d ->l_tmp2.d
                                        LET l_tmp2.glbc004 = l_glad006 #170310-00016#1 mod l_tmp.glbc004 ->l_tmp2.glbc004
                                     END IF
                                     
                                     IF l_tmp.c <> 0 THEN 
                                        LET l_tmp2.glbc004 = l_glad036 #170310-00016#1 mod l_tmp.glbc004 ->l_tmp2.glbc004
                                     END IF
                                  END IF   #170310-00016#1 ADD xul  
                                  #170111-00055#1 add lujh axrp133效能优化
                                  
                                  #170111-00055#1 mark lujh axrp133效能优化
                                  #IF cl_null(l_tmp2.glaq001) THEN
                                  #   #                 2:摘要/账套/科目编号  /程序编号/目的字段/单据编号/单据项次1/单据项次2
                                  #   CALL s_account_item('2',p_xrcald,l_tmp2.glaq002,l_prog,'glgb001',p_xrcadocno,l_tmp2.seq,'')#160927-00008#1 mod 'xrcb047'-->'glgb001'
                                  #   RETURNING l_memo
                                  #   IF NOT cl_null(l_memo) THEN
                                  #      LET l_tmp2.glaq001 = l_memo
                                  #   END IF
                                  #END IF
                                  #                         
                                  #IF cl_null(l_tmp2.glaq001) THEN
                                  #   CALL s_axrt300_get_meno(p_xrcald,p_xrcadocno,l_tmp2.seq,l_tmp2.glaq002)
                                  #      RETURNING l_success,l_memo
                                  #   LET l_tmp2.glaq001 = l_tmp2.glaq001,l_memo
                                  #   IF cl_null(l_tmp2.glaq001) THEN 
                                  #      LET l_tmp2.glaq001 = ''
                                  #   END IF
                                  #END IF                      
                                  #
                                  #CALL s_voucher_glac016_get(l_glaa004,l_tmp2.glaq002) RETURNING l_glac016
                                  #
                                  #IF cl_null(l_tmp2.glbc004) AND l_glac016 = 'Y' THEN 
                                  #   CALL s_voucher_glad006_get(p_xrcald,l_tmp2.glaq002,l_tmp2.d,l_tmp2.c) RETURNING l_tmp2.glbc004
                                  #END IF
                                  #
                                  #CALL s_voucher_get_glas003(p_xrcald,l_tmp2.glaq002) 
                                  #RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                                  #          l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                                  #          l_glaq035,l_glaq036,l_glaq037,l_glaq038
                                  #          
                                  #IF NOT cl_null(l_glaq020) THEN LET l_tmp2.glaq020 = l_glaq020 END IF
                                  #IF NOT cl_null(l_glaq021) THEN LET l_tmp2.glaq021 = l_glaq021 END IF
                                  #IF NOT cl_null(l_glaq022) THEN LET l_tmp2.glaq022 = l_glaq022 END IF
                                  #IF NOT cl_null(l_glaq023) THEN LET l_tmp2.glaq023 = l_glaq023 END IF
                                  #IF NOT cl_null(l_glaq024) THEN LET l_tmp2.glaq024 = l_glaq024 END IF
                                  #IF NOT cl_null(l_glaq051) THEN LET l_tmp2.glaq051 = l_glaq051 END IF
                                  #IF NOT cl_null(l_glaq052) THEN LET l_tmp2.glaq052 = l_glaq052 END IF
                                  #IF NOT cl_null(l_glaq053) THEN LET l_tmp2.glaq053 = l_glaq053 END IF
                                  #IF NOT cl_null(l_glaq027) THEN LET l_tmp2.glaq027 = l_glaq027 END IF
                                  #IF NOT cl_null(l_glaq028) THEN LET l_tmp2.glaq028 = l_glaq028 END IF
                                  #IF NOT cl_null(l_glaq029) THEN LET l_tmp2.glaq029 = l_glaq029 END IF
                                  #IF NOT cl_null(l_glaq030) THEN LET l_tmp2.glaq030 = l_glaq030 END IF
                                  #IF NOT cl_null(l_glaq031) THEN LET l_tmp2.glaq031 = l_glaq031 END IF
                                  #IF NOT cl_null(l_glaq032) THEN LET l_tmp2.glaq032 = l_glaq032 END IF
                                  #IF NOT cl_null(l_glaq033) THEN LET l_tmp2.glaq032 = l_glaq033 END IF
                                  #IF NOT cl_null(l_glaq034) THEN LET l_tmp2.glaq032 = l_glaq034 END IF
                                  #IF NOT cl_null(l_glaq035) THEN LET l_tmp2.glaq032 = l_glaq035 END IF
                                  #IF NOT cl_null(l_glaq036) THEN LET l_tmp2.glaq032 = l_glaq036 END IF
                                  #IF NOT cl_null(l_glaq037) THEN LET l_tmp2.glaq032 = l_glaq037 END IF
                                  #IF NOT cl_null(l_glaq038) THEN LET l_tmp2.glaq032 = l_glaq038 END IF
                                  #170111-00055#1 mark lujh axrp133效能优化
            
                                  INSERT INTO s_vr_tmp04 VALUES(l_tmp2.*)  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                                  IF SQLCA.sqlcode THEN
                                     INITIALIZE g_errparam TO NULL
                                     LET g_errparam.code = SQLCA.sqlcode
                                     LET g_errparam.extend = 'insert s_vr_tmp04'  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                                     LET g_errparam.popup = TRUE
                                     CALL cl_err()
                                  
                                     RETURN r_success                   
                                  END IF                           
                               END IF                     
                               #-----[1.銷貨收入]分錄-----(E)--#
                               #-----[2.遞延收入]分錄-----(S)--#
                               LET l_tmp.sum = l_tmp.sum - lc_param.xreq103              #原幣金額
                               #處理有金額的一方
                               IF l_tmp.d > 0 THEN
                                  LET l_tmp.d = l_tmp.d - lc_param.xreq113               #本幣  (借)
                                  LET l_tmp.glaq040 = l_tmp.glaq040 - lc_param.xreq123   #本位二(借)
                                  LET l_tmp.glaq043 = l_tmp.glaq043 - lc_param.xreq133   #本位三(借)
                               ELSE
                                  LET l_tmp.c = l_tmp.c - lc_param.xreq113               #本幣  (貸)   
                                  LET l_tmp.glaq041 = l_tmp.glaq041 - lc_param.xreq123   #本位二(貸)   
                                  LET l_tmp.glaq044 = l_tmp.glaq044 - lc_param.xreq133   #本位三(貸)   
                               END IF
                               LET l_tmp.glaq002 = lc_param.xreq012                      #原銷貨收入科目替換成遞延收入           
                               #-----[2.遞延收入]分錄-----(E)--#                         
                           END IF   #151008-00009#9
                        END IF
                      END IF
                      #151008-00009#8--e
                      
                      #170111-00055#1 add lujh axrp133效能优化
                      IF cl_null(l_tmp.glaq001) THEN #170310-00016#1 ADD xul 
                         CALL s_aap_get_glab010(p_xrcald,'13',l_xrca007,'8304_01',l_tmp.glaq001,
                                p_xrcadocno,l_tmp.seq,'AR','1',l_tmp.glaq002,'glgb001')
                         RETURNING l_tmp.glaq001
                      END IF  #170310-00016#1 ADD xul 
                      IF cl_null(l_tmp.glbc004) THEN  #170310-00016#1 ADD xul 
                         IF l_tmp.d <> 0 THEN 
                            LET l_tmp.glbc004 = l_glad006
                         END IF
                         
                         IF l_tmp.c <> 0 THEN 
                            LET l_tmp.glbc004 = l_glad036
                         END IF
                      END IF  #170310-00016#1 ADD xul 
                      #170111-00055#1 add lujh axrp133效能优化
                      
                      #170111-00055#1 mark lujh axrp133效能优化
                      ##150918-00001#3--add--str--lujh
                      #IF cl_null(l_tmp.glaq001) THEN
                      #   #                 2:摘要/账套/科目编号  /程序编号/目的字段/单据编号/单据项次1/单据项次2
                      #   CALL s_account_item('2',p_xrcald,l_tmp.glaq002,l_prog,'glgb001',p_xrcadocno,l_tmp.seq,'')#160927-00008#1 mod 'xrcb047'-->'glgb001'
                      #   RETURNING l_memo
                      #   IF NOT cl_null(l_memo) THEN
                      #      LET l_tmp.glaq001 = l_memo
                      #   END IF
                      #END IF
                      ##150918-00001#3--add--end--lujh
                      ##160322--(S)
                      #IF cl_null(l_tmp.glaq001) THEN
                      #   CALL s_axrt300_get_meno(p_xrcald,p_xrcadocno,l_tmp.seq,l_tmp.glaq002)
                      #      RETURNING l_success,l_memo
                      #   LET l_tmp.glaq001 = l_tmp.glaq001,l_memo
                      #   IF cl_null(l_tmp.glaq001) THEN 
                      #      LET l_tmp.glaq001 = ''
                      #   END IF
                      #END IF
                      ##160322--(E)
                      #
                      #CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
                      #
                      #IF cl_null(l_tmp.glbc004) AND l_glac016 = 'Y' THEN 
                      #   CALL s_voucher_glad006_get(p_xrcald,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glbc004
                      #END IF
                      #
                      #CALL s_voucher_get_glas003(p_xrcald,l_tmp.glaq002) 
                      #RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                      #          l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                      #          l_glaq035,l_glaq036,l_glaq037,l_glaq038
                      #          
                      #IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
                      #IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
                      #IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
                      #IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
                      #IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
                      #IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
                      #IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
                      #IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
                      #IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
                      #IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
                      #IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
                      #IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
                      #IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
                      #IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
                      #IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
                      #IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
                      #IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
                      #IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
                      #IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
                      #IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF
                      #170111-00055#1 mark lujh axrp133效能优化

                      INSERT INTO s_vr_tmp04 VALUES(l_tmp.*)  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                      IF SQLCA.sqlcode THEN
                         INITIALIZE g_errparam TO NULL
                         LET g_errparam.code = SQLCA.sqlcode
                         LET g_errparam.extend = 'insert s_vr_tmp04' #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                         LET g_errparam.popup = TRUE
                         CALL cl_err()
                      
                         RETURN r_success                   
                      END IF    
                   END IF               
               END FOREACH            
        WHEN '3'
               FOREACH s_voucher_gen_ar_2_cs4 USING p_xrcadocno INTO l_tmp.*,l_xrcb001,l_xrcb023,
                                                                     l_xrca007,l_glad006,l_glad036   #170111-00055#1 add lujh axrp133效能优化 
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'foreach s_voucher_gen_ar_2_cs4'
                      LET g_errparam.popup = TRUE
                      CALL cl_err()

                      RETURN r_success
                   END IF
                   
                   #IF l_xrcb023 = 'Y' AND l_para_data = 'N' THEN 
                   #   CONTINUE FOREACH 
                   #END IF
                   LET l_tmp.red = g_ooac004 #170509-00094#3 add
#170509-00094#3 mark s---                   
#                   #20150612--add--str--lujh
#                   IF p_xrca001 = '22' OR p_xrca001 = '29' THEN 
#                      IF l_ooac004 = 'Y' THEN 
#                         LET l_tmp.red = 'Y'
#                         IF l_tmp.sum > 0 THEN 
#                            LET l_tmp.sum = l_tmp.sum * -1
#                         END IF
#                      END IF
#                   ELSE
#170509-00094#3 mark e---
#                   #20150612--add--end--lujh
                      #若為負數金額,則借貸方向要相反
                      IF l_tmp.c < 0 THEN 
                         LET l_tmp.sw = '1'
                         LET l_tmp.d = l_tmp.c * -1
                         LET l_tmp.c = 0
                         LET l_tmp.glaq040 = l_tmp.glaq041 * -1
                         LET l_tmp.glaq041 = 0
                         LET l_tmp.glaq043 = l_tmp.glaq044 * -1
                         LET l_tmp.glaq044 = 0
                      END IF
#                   END IF  #170509-00094#3 mark 
                   
                   #沒有稅額,不產生
                   IF l_tmp.d = 0 AND l_tmp.c = 0 THEN 
                      CONTINUE FOREACH 
                   END IF
                  
                   LET l_tmp.red = g_ooac004 #170509-00094#3 add
                   
                   #161229-00017#1--mark--str--lujh
                   #IF cl_null(l_tmp.glaq001) THEN
                   #   CALL s_axrt300_get_meno(p_xrcald,p_xrcadocno,l_tmp.seq,l_tmp.glaq002)
                   #      RETURNING l_success,l_memo
                   #   LET l_tmp.glaq001 = l_tmp.glaq001,l_memo
                   #   IF cl_null(l_tmp.glaq001) THEN 
                   #      LET l_tmp.glaq001 = ''
                   #   END IF
                   #END IF
                   #161229-00017#1--mark--end--lujh
                   
                   #150918-00001#3--add--str--lujh
                   IF cl_null(l_tmp.glaq001) THEN
                      #                 2:摘要/账套/科目编号  /程序编号/目的字段/单据编号/单据项次1/单据项次2
                      CALL s_account_item('2',p_xrcald,l_tmp.glaq002,l_prog,'glgb001',p_xrcadocno,l_tmp.seq,'') #160927-00008#1 mod 'xrcb047'-->'glgb001'
                      RETURNING l_memo
                      IF NOT cl_null(l_memo) THEN
                         LET l_tmp.glaq001 = l_memo
                      END IF
                   END IF
                   #150918-00001#3--add--end--lujh
                   
                   #170821-00034#1---add-----str
                   IF cl_null(l_tmp.glaq039) THEN
                      LET l_tmp.glaq039 = 0
                   END IF
                   IF cl_null(l_tmp.glaq042) THEN
                      LET l_tmp.glaq042 = 0  
                   END IF
                   #170821-00034#1---add-----end
                   
                   #170111-00055#1 mark lujh axrp133效能优化
                   #CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
                   #
                   #IF cl_null(l_tmp.glbc004) AND l_glac016 = 'Y' THEN 
                   #   CALL s_voucher_glad006_get(p_xrcald,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glbc004
                   #END IF
                   #
                   #CALL s_voucher_get_glas003(p_xrcald,l_tmp.glaq002) 
                   #RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                   #          l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                   #          l_glaq035,l_glaq036,l_glaq037,l_glaq038
                   #          
                   #IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
                   #IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
                   #IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
                   #IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
                   #IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
                   #IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
                   #IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
                   #IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
                   #IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
                   #IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
                   #IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
                   #IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
                   #IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
                   #IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
                   #IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
                   #IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
                   #IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
                   #IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
                   #IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
                   #IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF
                   #170111-00055#1 mark lujh axrp133效能优化

                   INSERT INTO s_vr_tmp04 VALUES(l_tmp.*)  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'insert s_vr_tmp04'  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                      LET g_errparam.popup = TRUE
                      CALL cl_err()

                      RETURN r_success                   
                   END IF               
               END FOREACH   
         WHEN '4'   #直接沖賬 xrce
#               FOREACH s_voucher_gen_ar_2_cs7 USING p_xrcadocno INTO l_tmp.*,l_xrce015,l_xrca035 #160628-00002#1 mark
               FOREACH s_voucher_gen_ar_2_cs7 USING p_xrcadocno,p_xrcadocno INTO l_tmp.*,l_xrce015,l_xrca035,l_xrce003,l_flag, #160628-00002#1 add
                                                                                 l_xrca007,l_glad006,l_glad036   #170111-00055#1 add lujh axrp133效能优化 
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'foreach s_voucher_gen_ar_2_cs7'
                      LET g_errparam.popup = TRUE
                      CALL cl_err()
               
                      RETURN r_success
                   END IF
                   
                   #160628-00002#1--add--str--
                   #当税额分录时，按照以下顺序抓取科目
                   #先抓取税别对应科目aisi070，当没有抓到科目时，在通过账款类别抓取科目axri011
                   IF l_flag = '2' THEN
                      SELECT xrca007,xrca011 INTO l_xrca007,l_xrca011 FROM xrca_t
                       WHERE xrcaent=g_enterprise AND xrcald=p_xrcald
                         AND xrcadocno=l_xrce003
                      LET l_tmp.glaq002 = ''   #160912-00002#1
                      SELECT glab005 INTO l_tmp.glaq002 FROM glab_t
                       WHERE glabent=g_enterprise AND glabld=p_xrcald
                         AND glab001='14' AND glab002='2'
                         AND glab003=l_xrca011
                      IF cl_null(l_tmp.glaq002) THEN
                         SELECT glab005 INTO l_tmp.glaq002 FROM glab_t 
                          WHERE glabent=g_enterprise AND  glabld=p_xrcald
                            AND glab001='13' AND glab003='8304_29'
                            AND glab002=l_xrca007
                      END IF
                   END IF
                   #160628-00002#1--add--end
                   
                   IF l_xrce015 = 'D' THEN 
                      LET l_tmp.sw = '1'
                      LET l_tmp.d = l_tmp.c
                      LET l_tmp.c = 0
                      LET l_tmp.glaq040 = l_tmp.glaq041
                      LET l_tmp.glaq041 = 0
                      LET l_tmp.glaq043 = l_tmp.glaq044
                      LET l_tmp.glaq044 = 0
                   END IF
                   
                  # IF l_xrce015 = 'C' THEN  #170410-00063#1----mark
                   IF l_xrce015 = 'D' THEN   #170410-00063#1----add
                      LET l_tmp.sum = l_tmp.sum * -1
                   END IF
                   
                   #161223-00028#1--add--str--lujh
                   IF l_tmp.d = 0 AND l_tmp.c = 0 THEN 
                      CONTINUE FOREACH
                   END IF
                   #161223-00028#1--add--end--lujh
                   
                   #170111-00055#1 add lujh axrp133效能优化
                   IF cl_null(l_tmp.glaq001) THEN #170310-00016#1 ADD xul 
                      CALL s_aap_get_glab010(p_xrcald,'13',l_xrca007,'8304_01',l_tmp.glaq001,
                             p_xrcadocno,l_tmp.seq,'AR','1',l_tmp.glaq002,'glgb001')
                      RETURNING l_tmp.glaq001
                   END IF  #170310-00016#1 ADD xul 
                   IF cl_null(l_tmp.glbc004) THEN #170310-00016#1 ADD xul 
                      IF l_tmp.d <> 0 THEN 
                         LET l_tmp.glbc004 = l_glad006
                      END IF
                      
                      IF l_tmp.c <> 0 THEN 
                         LET l_tmp.glbc004 = l_glad036
                      END IF
                   END IF   #170310-00016#1 ADD xul 
                   #170111-00055#1 add lujh axrp133效能优化
                   
                   #170111-00055#1 mark lujh axrp133效能优化
                   #IF cl_null(l_tmp.glaq001) THEN
                   #   CALL s_axrt300_get_meno(p_xrcald,p_xrcadocno,l_tmp.seq,l_tmp.glaq002)
                   #      RETURNING l_success,l_memo
                   #   LET l_tmp.glaq001 = l_tmp.glaq001,l_memo
                   #   IF cl_null(l_tmp.glaq001) THEN 
                   #      LET l_tmp.glaq001 = ''
                   #   END IF
                   #END IF
                   #
                   ##150918-00001#3--add--str--lujh
                   #IF cl_null(l_tmp.glaq001) THEN
                   #   #                 2:摘要/账套/科目编号  /程序编号/目的字段/单据编号/单据项次1/单据项次2
                   #   CALL s_account_item('2',p_xrcald,l_tmp.glaq002,l_prog,'glgb001',p_xrcadocno,l_tmp.seq,'')#160927-00008#1 mod 'xrce010'-->'glgb001'
                   #   RETURNING l_memo
                   #   IF NOT cl_null(l_memo) THEN
                   #      LET l_tmp.glaq001 = l_memo
                   #   END IF
                   #END IF
                   ##150918-00001#3--add--end--lujh
                   #
                   #CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
                   #
                   #IF cl_null(l_tmp.glbc004) AND l_glac016 = 'Y' THEN 
                   #   CALL s_voucher_glad006_get(p_xrcald,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glbc004
                   #END IF
                   #
                   #CALL s_voucher_get_glas003(p_xrcald,l_tmp.glaq002) 
                   #RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                   #          l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                   #          l_glaq035,l_glaq036,l_glaq037,l_glaq038
                   #          
                   #IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
                   #IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
                   #IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
                   #IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
                   #IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
                   #IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
                   #IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
                   #IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
                   #IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
                   #IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
                   #IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
                   #IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
                   #IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
                   #IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
                   #IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
                   #IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
                   #IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
                   #IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
                   #IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
                   #IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF
                   #170111-00055#1 mark lujh axrp133效能优化

                   INSERT INTO s_vr_tmp04 VALUES(l_tmp.*)  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'insert s_vr_tmp04'  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                      LET g_errparam.popup = TRUE
                      CALL cl_err()
               
                      RETURN r_success                   
                   END IF       
               END FOREACH 
               
         WHEN '6'   #直接沖賬 xrde
               LET l_n = 1   #160509-00004#45 add lujh
               FOREACH s_voucher_gen_ar_2_cs19 USING p_xrcadocno INTO l_tmp.*,l_xrce015,l_xrca035,l_xrde001,  #160509-00004#45 add l_xrde001 lujh   
                                                                      l_xrca007,l_glad006,l_glad036   #170111-00055#1 add lujh axrp133效能优化 
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'foreach s_voucher_gen_ar_2_cs18'
                      LET g_errparam.popup = TRUE
                      CALL cl_err()
               
                      RETURN r_success
                   END IF
 
                   #160509-00004#45--add--str--lujh
#                   IF g_prog = 'axrt351' AND l_xrde001 = 'axrt351' THEN 
                   IF g_prog MATCHES 'axrt351*' AND l_xrde001 MATCHES 'axrt351*' THEN    
                      LET l_n_str = l_n
                      LET l_tmp.source = l_tmp.source CLIPPED,l_n_str
                      LET l_n = l_n + 1
                   END IF
                   #160509-00004#45--add--end--lujh
                   
                   #20150604 By 01727
                   SELECT xrde002,xrde006,xrde038 INTO l_xrde002,l_xrde006,l_xrde038 FROM xrde_t
                    WHERE xrdeent = g_enterprise
                      AND xrdedocno = p_xrcadocno
                      AND xrdeld = l_tmp.glaqld
                      AND xrdeseq = l_tmp.seq
                   #IF l_xrde002 = '10' AND l_xrde006 = '91' THEN  #160509-00004#53 mark lujh
#                   IF g_prog = 'axrt351' THEN          #160509-00004#53 add lujh   #170301-00030#8 by 09257 --mark
                   IF g_prog MATCHES 'axrt351*' THEN   #170301-00030#8 by 09257 --add
                      LET l_tmp.glaq021 = l_xrde038
                      LET l_tmp.glaq022 = l_xrde038    #160509-00004#53 add lujh
                   END IF
                   #20150604 By 01727
                   IF l_xrce015 = 'D' THEN 
                      LET l_tmp.sw = '1'
                      LET l_tmp.d = l_tmp.c
                      LET l_tmp.c = 0
                      LET l_tmp.glaq040 = l_tmp.glaq041
                      LET l_tmp.glaq041 = 0
                      LET l_tmp.glaq043 = l_tmp.glaq044
                      LET l_tmp.glaq044 = 0
                   END IF
                   
                   IF l_xrce015 = 'C' THEN 
                      LET l_tmp.sum = l_tmp.sum * -1
                   END IF
                   
                   #161223-00028#1--add--str--lujh
                   IF l_tmp.d = 0 AND l_tmp.c = 0 THEN 
                      CONTINUE FOREACH
                   END IF
                   #161223-00028#1--add--end--lujh
                   
                   #170111-00055#1 add lujh axrp133效能优化
                   IF cl_null(l_tmp.glaq001) THEN #170310-00016#1 ADD xul 
                      CALL s_aap_get_glab010(p_xrcald,'13',l_xrca007,'8304_01',l_tmp.glaq001,
                             p_xrcadocno,l_tmp.seq,'AR','1',l_tmp.glaq002,'glgb001')
                      RETURNING l_tmp.glaq001
                   END IF #170310-00016#1 ADD xul 
                   IF cl_null(l_tmp.glbc004) THEN #170310-00016#1 ADD xul 
                      IF l_tmp.d <> 0 THEN 
                         LET l_tmp.glbc004 = l_glad006
                      END IF
                      
                      IF l_tmp.c <> 0 THEN 
                         LET l_tmp.glbc004 = l_glad036
                      END IF
                   END IF #170310-00016#1 ADD xul 
                   #170111-00055#1 add lujh axrp133效能优化

                   #170111-00055#1 mark lujh axrp133效能优化
                   #IF cl_null(l_tmp.glaq001) THEN
                   #   CALL s_axrt300_get_meno(p_xrcald,p_xrcadocno,l_tmp.seq,l_tmp.glaq002)
                   #   RETURNING l_success,l_memo
                   #   LET l_tmp.glaq001 = l_tmp.glaq001,l_memo
                   #   IF cl_null(l_tmp.glaq001) THEN 
                   #      LET l_tmp.glaq001 = ''
                   #   END IF
                   #END IF
                   #
                   ##150918-00001#3--add--str--lujh
                   #IF cl_null(l_tmp.glaq001) THEN
                   #   #                 2:摘要/账套/科目编号  /程序编号/目的字段/单据编号/单据项次1/单据项次2
                   #   CALL s_account_item('2',p_xrcald,l_tmp.glaq002,l_prog,'glgb001',p_xrcadocno,l_tmp.seq,'')#160927-00008#1 mod 'xrde010'-->'glgb001'
                   #   RETURNING l_memo
                   #   IF NOT cl_null(l_memo) THEN
                   #      LET l_tmp.glaq001 = l_memo
                   #   END IF
                   #END IF
                   ##150918-00001#3--add--end--lujh
                   #
                   #CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
                   #
                   #IF cl_null(l_tmp.glbc004) AND l_glac016 = 'Y' THEN 
                   #   CALL s_voucher_glad006_get(p_xrcald,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glbc004
                   #END IF
                   #
                   #CALL s_voucher_get_glas003(p_xrcald,l_tmp.glaq002) 
                   #RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                   #          l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                   #          l_glaq035,l_glaq036,l_glaq037,l_glaq038
                   #          
                   #IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
                   #IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
                   #IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
                   #IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
                   #IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
                   #IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
                   #IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
                   #IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
                   #IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
                   #IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
                   #IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
                   #IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
                   #IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
                   #IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
                   #IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
                   #IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
                   #IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
                   #IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
                   #IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
                   #IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF
                   #170111-00055#1 mark lujh axrp133效能优化

                   INSERT INTO s_vr_tmp04 VALUES(l_tmp.*)  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'insert s_vr_tmp04'  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                      LET g_errparam.popup = TRUE
                      CALL cl_err()
               
                      RETURN r_success                   
                   END IF       
               END FOREACH       
               
         WHEN '5'   #差异
               IF l_para_data = 'N' THEN
                  FOREACH s_voucher_gen_ar_2_cs17 USING p_xrcadocno INTO l_tmp.*,   #160912-00011#4 DEl ,'0' 
                                                                         l_xrca007,l_glad006,l_glad036   #170111-00055#1 add lujh axrp133效能优化
                     IF SQLCA.sqlcode THEN
                         INITIALIZE g_errparam TO NULL
                         LET g_errparam.code = SQLCA.sqlcode
                         LET g_errparam.extend = 'foreach s_voucher_gen_ar_2_cs17'
                         LET g_errparam.popup = TRUE
                         CALL cl_err()
                  
                         RETURN r_success
                      END IF
                      
                      IF p_xrca001 = '22' OR p_xrca001 = '29' THEN  #axrt340时
                         #SELECT COUNT(*) INTO l_n         #170615-00061#25 mark
                         SELECT COUNT(xrcbdocno) INTO l_n  #170615-00061#25 add
                           FROM xrcb_t
                          WHERE xrcbent = g_enterprise
                            AND xrcbld  = p_xrcald
                            AND xrcbdocno = p_xrcadocno
                            AND (xrcb001 = '11' OR xrcb001 = '19')
                            
                         IF l_n = 0 THEN  #如果单身只有销退/或其他减项,则借贷相反
                            LET l_tmp.sw = '1'
                            LET l_tmp.d = l_tmp.c
                            LET l_tmp.c = 0
                            LET l_tmp.glaq040 = l_tmp.glaq041
                            LET l_tmp.glaq041 = 0
                            LET l_tmp.glaq043 = l_tmp.glaq044
                            LET l_tmp.glaq044 = 0 
                         END IF
                      END IF
                      
                      #161223-00028#1--add--str--lujh
                      IF l_tmp.d = 0 AND l_tmp.c = 0 THEN 
                         CONTINUE FOREACH
                      END IF
                      #161223-00028#1--add--end--lujh

                      LET l_tmp.red = g_ooac004 #170509-00094#3 add

                      #170111-00055#1 add lujh axrp133效能优化
                      IF cl_null(l_tmp.glaq001) THEN  #170310-00016#1 add xul
                         CALL s_aap_get_glab010(p_xrcald,'13',l_xrca007,'8304_01',l_tmp.glaq001,
                                p_xrcadocno,l_tmp.seq,'AR','1',l_tmp.glaq002,'glgb001')
                         RETURNING l_tmp.glaq001
                      END IF #170310-00016#1 add xul
                      IF cl_null(l_tmp.glbc004) THEN   #170310-00016#1 add xul
                         IF l_tmp.d <> 0 THEN 
                            LET l_tmp.glbc004 = l_glad006
                         END IF
                         
                         IF l_tmp.c <> 0 THEN 
                            LET l_tmp.glbc004 = l_glad036
                         END IF
                      END IF #170310-00016#1 add xul
                      #170111-00055#1 add lujh axrp133效能优化
                      
                      #170111-00055#1 mark lujh axrp133效能优化
                      #IF cl_null(l_tmp.glaq001) THEN
                      #   CALL s_axrt300_get_meno(p_xrcald,p_xrcadocno,l_tmp.seq,l_tmp.glaq002)
                      #      RETURNING l_success,l_memo
                      #   LET l_tmp.glaq001 = l_tmp.glaq001,l_memo
                      #   IF cl_null(l_tmp.glaq001) THEN 
                      #      LET l_tmp.glaq001 = ''
                      #   END IF
                      #END IF
                      #
                      ##150918-00001#3--add--str--lujh
                      #IF cl_null(l_tmp.glaq001) THEN
                      #   #                 2:摘要/账套/科目编号  /程序编号/目的字段/单据编号/单据项次1/单据项次2
                      #   CALL s_account_item('2',p_xrcald,l_tmp.glaq002,l_prog,'glgb001',p_xrcadocno,l_tmp.seq,'')#160927-00008#1 mod 'xrcf049'-->'glgb001'
                      #   RETURNING l_memo
                      #   IF NOT cl_null(l_memo) THEN
                      #      LET l_tmp.glaq001 = l_memo
                      #   END IF
                      #END IF
                      ##150918-00001#3--add--end--lujh
                      #
                      #CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
                      #
                      #IF cl_null(l_tmp.glbc004) AND l_glac016 = 'Y' THEN 
                      #   CALL s_voucher_glad006_get(p_xrcald,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glbc004
                      #END IF
                      #
                      #CALL s_voucher_get_glas003(p_xrcald,l_tmp.glaq002) 
                      #RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                      #          l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                      #          l_glaq035,l_glaq036,l_glaq037,l_glaq038
                      #          
                      #IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
                      #IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
                      #IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
                      #IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
                      #IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
                      #IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
                      #IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
                      #IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
                      #IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
                      #IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
                      #IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
                      #IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
                      #IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
                      #IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
                      #IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
                      #IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
                      #IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
                      #IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
                      #IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
                      #IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF
                      #170111-00055#1 mark lujh axrp133效能优化

                     INSERT INTO s_vr_tmp04 VALUES(l_tmp.*)  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                     IF SQLCA.sqlcode THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = SQLCA.sqlcode
                        LET g_errparam.extend = 'insert s_vr_tmp04'  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                     
                        RETURN r_success                   
                     END IF    
                  END FOREACH  
               END IF
               
      #add by liyan --str--
      WHEN '7'  #借:预收帐款
               FOREACH s_voucher_gen_ar_2_cs2 USING p_xrcadocno INTO l_tmp.*,l_xrcb001,l_xrcb023,l_xrca107,l_xrca117,l_xrca127,l_xrca137,
                                                                     l_xrcb056,l_xrcb055,l_xrcb057,l_xrcb004,l_xrcb058,l_xrcb059,l_xrcb060,l_xrcb053,l_xrcb054,    #160509-00004#73 add l_xrcb057,l_xrcb058,l_xrcb059,l_xrcb060 lujh
                                                                     l_xrca007,l_glad006,l_glad036   #170111-00055#1 add lujh axrp133效能优化
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'foreach s_voucher_gen_ar_2_cs2'
                      LET g_errparam.popup = TRUE
                      CALL cl_err()

                      RETURN r_success
                   END IF
                     
                   #160509-00004#73--add--str--lujh
                   IF l_xrcb060 <> '2' THEN 
                      CONTINUE FOREACH
                   END IF
                   #160509-00004#73--add--end--lujh
                   LET l_tmp.red = g_ooac004 #170509-00094#3 add
                   LET l_tmp.d = l_xrcb055
                   LET l_tmp.glaq002 = l_xrcb058    #160509-00004#73 add lujh
                   
                   LET l_tmp.glaq021 = l_xrcb053
                   LET l_tmp.glaq022 = l_xrcb054
#170509-00094#3 mark s---                   
#                   #20150612--add--str--lujh
#                   IF p_xrca001 = '22' OR p_xrca001 = '29' THEN 
#                      IF l_ooac004 = 'Y' THEN 
#                         LET l_tmp.red = 'Y'
#                         IF l_tmp.sum < 0 THEN 
#                            LET l_tmp.sum = l_tmp.sum * -1
#                         END IF
#                      END IF
#                   ELSE
#                   #20150612--add--end--lujh
#170509-00094#3 mark e---
                      #若為負數金額,則借貸方向要相反
                      IF l_tmp.d < 0 THEN 
                         LET l_tmp.sw = '2'
                         LET l_tmp.c = l_tmp.d * -1
                         LET l_tmp.d = 0
                         LET l_tmp.glaq041 = l_tmp.glaq040 * -1
                         LET l_tmp.glaq040 = 0
                         LET l_tmp.glaq044 = l_tmp.glaq043 * -1
                         LET l_tmp.glaq043 = 0
                      END IF
#                   END IF #170509-00094#3 mark 
                   
                   #161223-00028#1--add--str--lujh
                   IF l_tmp.d = 0 AND l_tmp.c = 0 THEN 
                      CONTINUE FOREACH
                   END IF
                   #161223-00028#1--add--end--lujh
                   
                   #170111-00055#1 add lujh axrp133效能优化
                   IF cl_null(l_tmp.glaq001) THEN  #170310-00016#1 ADD xul
                     CALL s_aap_get_glab010(p_xrcald,'13',l_xrca007,'8304_01',l_tmp.glaq001,
                            p_xrcadocno,l_tmp.seq,'AR','1',l_tmp.glaq002,'glgb001')
                     RETURNING l_tmp.glaq001
                   END IF  #170310-00016#1 ADD xul
                   IF cl_null(l_tmp.glbc004) THEN #170310-00016#1 ADD xul
                      IF l_tmp.d <> 0 THEN 
                         LET l_tmp.glbc004 = l_glad006
                      END IF
                      
                      IF l_tmp.c <> 0 THEN 
                         LET l_tmp.glbc004 = l_glad036
                      END IF
                   END IF #170310-00016#1 ADD xul
                   #170111-00055#1 add lujh axrp133效能优化
                   
                   #170111-00055#1 mark lujh axrp133效能优化
                   #IF cl_null(l_tmp.glaq001) THEN
                   #   CALL s_axrt300_get_meno(p_xrcald,p_xrcadocno,l_tmp.seq,l_tmp.glaq002)
                   #      RETURNING l_success,l_memo
                   #   LET l_tmp.glaq001 = l_tmp.glaq001,l_memo
                   #   IF cl_null(l_tmp.glaq001) THEN 
                   #      LET l_tmp.glaq001 = ''
                   #   END IF
                   #END IF
                   #
                   ##150918-00001#3--add--str--lujh
                   #IF cl_null(l_tmp.glaq001) THEN
                   #   #                 2:摘要/账套/科目编号  /程序编号/目的字段/单据编号/单据项次1/单据项次2
                   #   CALL s_account_item('2',p_xrcald,l_tmp.glaq002,l_prog,'glgb001',p_xrcadocno,l_tmp.seq,'')#160927-00008#1 mod 'xrcb047'-->'glgb001'
                   #   RETURNING l_memo
                   #   IF NOT cl_null(l_memo) THEN
                   #      LET l_tmp.glaq001 = l_memo
                   #   END IF
                   #END IF
                   ##150918-00001#3--add--end--lujh
                   #                      
                   #CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
                   #
                   #IF cl_null(l_tmp.glbc004) AND l_glac016 = 'Y' THEN 
                   #   CALL s_voucher_glad006_get(p_xrcald,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glbc004
                   #END IF
                   #
                   #CALL s_voucher_get_glas003(p_xrcald,l_tmp.glaq002) 
                   #RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                   #          l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                   #          l_glaq035,l_glaq036,l_glaq037,l_glaq038
                   #          
                   #IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
                   #IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
                   #IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
                   #IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
                   #IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
                   #IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
                   #IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
                   #IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
                   #IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
                   #IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
                   #IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
                   #IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
                   #IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
                   #IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
                   #IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
                   #IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
                   #IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
                   #IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
                   #IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
                   #IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF
                   #170111-00055#1 mark lujh axrp133效能优化
  
                   INSERT INTO s_vr_tmp04 VALUES(l_tmp.*)  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'insert s_vr_tmp04'  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                      LET g_errparam.popup = TRUE
                      CALL cl_err()
                   
                      RETURN r_success                   
                   END IF 
               END FOREACH 
      #add by liyan --end--               
      
      WHEN '8'  #借:代收银
               FOREACH s_voucher_gen_ar_2_cs2 USING p_xrcadocno INTO l_tmp.*,l_xrcb001,l_xrcb023,l_xrca107,l_xrca117,l_xrca127,l_xrca137,
                                                                     l_xrcb056,l_xrcb055,l_xrcb057,l_xrcb004,l_xrcb058,l_xrcb059,l_xrcb060,l_xrcb053,l_xrcb054,    #160509-00004#73 add l_xrcb058,l_xrcb059,l_xrcb060 lujh
                                                                     l_xrca007,l_glad006,l_glad036   #170111-00055#1 add lujh axrp133效能优化
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'foreach s_voucher_gen_ar_2_cs2'
                      LET g_errparam.popup = TRUE
                      CALL cl_err()

                      RETURN r_success
                   END IF

                   LET l_tmp.d = l_xrcb057
                   LET l_tmp.glaq002 = l_xrcb059    #160509-00004#73 add lujh
                   
                   LET l_tmp.glaq021 = l_xrcb053
                   LET l_tmp.glaq022 = l_xrcb054
                   LET l_tmp.red = g_ooac004 #170509-00094#3 add

#170509-00094#3 mark s---                   
#                   #20150612--add--str--lujh
#                   IF p_xrca001 = '22' OR p_xrca001 = '29' THEN 
#                      IF l_ooac004 = 'Y' THEN 
#                         LET l_tmp.red = 'Y'
#                         IF l_tmp.sum < 0 THEN 
#                            LET l_tmp.sum = l_tmp.sum * -1
#                         END IF
#                      END IF
#                   ELSE
#                   #20150612--add--end--lujh
#170509-00094#3 mark e---
                      #若為負數金額,則借貸方向要相反
                      IF l_tmp.d < 0 THEN 
                         LET l_tmp.sw = '2'
                         LET l_tmp.c = l_tmp.d * -1
                         LET l_tmp.d = 0
                         LET l_tmp.glaq041 = l_tmp.glaq040 * -1
                         LET l_tmp.glaq040 = 0
                         LET l_tmp.glaq044 = l_tmp.glaq043 * -1
                         LET l_tmp.glaq043 = 0
                      END IF
#                   END IF  #170509-00094#3 mark 
                   
                   #161223-00028#1--add--str--lujh
                   IF l_tmp.d = 0 AND l_tmp.c = 0 THEN 
                      CONTINUE FOREACH
                   END IF
                   #161223-00028#1--add--end--lujh
                   
                   #170111-00055#1 add lujh axrp133效能优化
                   IF cl_null(l_tmp.glaq001) THEN #170310-00016#1 ADD xul
                      CALL s_aap_get_glab010(p_xrcald,'13',l_xrca007,'8304_01',l_tmp.glaq001,
                             p_xrcadocno,l_tmp.seq,'AR','1',l_tmp.glaq002,'glgb001')
                      RETURNING l_tmp.glaq001
                   END IF #170310-00016#1 ADD xul
                   IF cl_null(l_tmp.glbc004) THEN #170310-00016#1 ADD xul
                      IF l_tmp.d <> 0 THEN 
                         LET l_tmp.glbc004 = l_glad006
                      END IF
                      
                      IF l_tmp.c <> 0 THEN 
                         LET l_tmp.glbc004 = l_glad036
                      END IF
                   END IF #170310-00016#1 ADD xul
                   #170111-00055#1 add lujh axrp133效能优化
                   
                   #170111-00055#1 mark lujh axrp133效能优化
                   #IF cl_null(l_tmp.glaq001) THEN
                   #   CALL s_axrt300_get_meno(p_xrcald,p_xrcadocno,l_tmp.seq,l_tmp.glaq002)
                   #      RETURNING l_success,l_memo
                   #   LET l_tmp.glaq001 = l_tmp.glaq001,l_memo
                   #   IF cl_null(l_tmp.glaq001) THEN 
                   #      LET l_tmp.glaq001 = ''
                   #   END IF
                   #END IF
                   #
                   ##150918-00001#3--add--str--lujh
                   #IF cl_null(l_tmp.glaq001) THEN
                   #   #                 2:摘要/账套/科目编号  /程序编号/目的字段/单据编号/单据项次1/单据项次2
                   #   CALL s_account_item('2',p_xrcald,l_tmp.glaq002,l_prog,'glgb001',p_xrcadocno,l_tmp.seq,'')#160927-00008#1 mod 'xrcb047'-->'glgb001'
                   #   RETURNING l_memo
                   #   IF NOT cl_null(l_memo) THEN
                   #      LET l_tmp.glaq001 = l_memo
                   #   END IF
                   #END IF
                   ##150918-00001#3--add--end--lujh
                   #                      
                   #CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
                   #
                   #IF cl_null(l_tmp.glbc004) AND l_glac016 = 'Y' THEN 
                   #   CALL s_voucher_glad006_get(p_xrcald,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glbc004
                   #END IF
                   #
                   #CALL s_voucher_get_glas003(p_xrcald,l_tmp.glaq002) 
                   #RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                   #          l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                   #          l_glaq035,l_glaq036,l_glaq037,l_glaq038
                   #          
                   #IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
                   #IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
                   #IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
                   #IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
                   #IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
                   #IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
                   #IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
                   #IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
                   #IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
                   #IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
                   #IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
                   #IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
                   #IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
                   #IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
                   #IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
                   #IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
                   #IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
                   #IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
                   #IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
                   #IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF
                   #170111-00055#1 mark lujh axrp133效能优化     
                        
                   INSERT INTO s_vr_tmp04 VALUES(l_tmp.*)  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'insert s_vr_tmp04'  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                      LET g_errparam.popup = TRUE
                      CALL cl_err()
                   
                      RETURN r_success                   
                   END IF 
               END FOREACH                       

      #161212-00024#1 Add  ---(S)---
      WHEN '9'  #暂估冲销
         IF l_para_data = 'N' THEN
            INITIALIZE l_tmp.* TO NULL
            FOREACH s_voucher_gen_ar_2_cs16 USING p_xrcadocno INTO l_tmp.*,
                                                                   l_xrca007,l_glad006,l_glad036   #170111-00055#1 add lujh axrp133效能优化
                                                                  ,l_xrcf008   #170310-00049#1
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = 'foreach s_voucher_gen_ar_2_cs2'
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  RETURN r_success
               END IF
               LET l_tmp.red = g_ooac004 #170509-00094#3 add

               #170310-00049#1-----s
               LET l_xrca001 = NULL
               SELECT xrca001 INTO l_xrca001 FROM xrca_t
                WHERE xrcaent = g_enterprise
                  AND xrcadocno = l_xrcf008 
               #170310-00049#1-----e
 
               #IF l_xrcb001 = '21' OR l_xrcb001 = '29' THEN    #170310-00049#1 mark
               #170310-00049#1-----s
               IF l_xrcb001 = '21' OR l_xrcb001 = '29'
                  OR l_xrca001 = '02' OR l_xrca001 = '04' 
                  THEN
               #170310-00049#1-----e               
                  LET l_tmp.sw = '1'
                  LET l_tmp.d = l_tmp.c
                  LET l_tmp.c = 0
                  LET l_tmp.glaq040 = l_tmp.glaq041
                  LET l_tmp.glaq041 = 0
                  LET l_tmp.glaq043 = l_tmp.glaq044
                  LET l_tmp.glaq044 = 0 
                  LET l_tmp.sum = l_tmp.sum * -1
               END IF
               
               #161223-00028#1--add--str--lujh
               IF l_tmp.d = 0 AND l_tmp.c = 0 THEN 
                  CONTINUE FOREACH
               END IF
               #161223-00028#1--add--end--lujh

               #170111-00055#1 add lujh axrp133效能优化
               IF cl_null(l_tmp.glaq001) THEN #170310-00016#1 ADD xul 
                  CALL s_aap_get_glab010(p_xrcald,'13',l_xrca007,'8304_01',l_tmp.glaq001,
                         p_xrcadocno,l_tmp.seq,'AR','1',l_tmp.glaq002,'glgb001')
                  RETURNING l_tmp.glaq001
               END IF #170310-00016#1 ADD xul 
               IF cl_null(l_tmp.glbc004) THEN  #170310-00016#1 ADD xul 
                 IF l_tmp.d <> 0 THEN 
                    LET l_tmp.glbc004 = l_glad006
                 END IF
                 
                 IF l_tmp.c <> 0 THEN 
                    LET l_tmp.glbc004 = l_glad036
                 END IF
               END IF   #170310-00016#1 ADD xul 
               #170111-00055#1 add lujh axrp133效能优化
               
               #170111-00055#1 mark lujh axrp133效能优化
               #IF cl_null(l_tmp.glaq001) THEN
               #   #                 2:摘要/账套/科目编号  /程序编号/目的字段/单据编号/单据项次1/单据项次2
               #   CALL s_account_item('2',p_xrcald,l_tmp.glaq002,l_prog,'glgb001',p_xrcadocno,l_tmp.seq,'')
               #   RETURNING l_memo
               #   IF NOT cl_null(l_memo) THEN
               #      LET l_tmp.glaq001 = l_memo
               #   END IF
               #END IF
               #
               #IF cl_null(l_tmp.glaq001) THEN
               #   CALL s_axrt300_get_meno(p_xrcald,p_xrcadocno,l_tmp.seq,l_tmp.glaq002)
               #      RETURNING l_success,l_memo
               #   LET l_tmp.glaq001 = l_tmp.glaq001,l_memo
               #   IF cl_null(l_tmp.glaq001) THEN 
               #      LET l_tmp.glaq001 = ''
               #   END IF
               #END IF
               #
               #CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
               #          
               #IF cl_null(l_tmp.glbc004) AND l_glac016 = 'Y' THEN 
               #   CALL s_voucher_glad006_get(p_xrcald,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glbc004
               #END IF
               #170111-00055#1 mark lujh axrp133效能优化

               INSERT INTO s_vr_tmp04 VALUES(l_tmp.*)
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = 'insert s_vr_tmp04'
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
               
                  RETURN r_success                   
               END IF   
            END FOREACH

            INITIALIZE l_tmp.* TO NULL

            FOREACH s_voucher_gen_ar_2_cs21 USING p_xrcadocno INTO l_tmp.*,
                                                                   l_xrca007,l_glad006,l_glad036,   #170111-00055#1 add lujh axrp133效能优化
                                                                   l_xrcf008                        #170328-00085#1 add
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = 'foreach s_voucher_gen_ar_2_cs21'
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  RETURN r_success
               END IF
               
               #170328-00085#1---add---start---
               LET l_xrcb001 = NULL
               SELECT xrcb001 INTO l_xrcb001 FROM xrcb_t
                WHERE xrcbent = g_enterprise
                  AND xrcbdocno = l_xrcf008 
               #170328-00085#1---add---end---
               
               IF l_xrcb001 = '21' OR l_xrcb001 = '29' THEN    
                  LET l_tmp.sw = '2'
                 #LET l_tmp.c = l_tmp.d * -1     #170328-00085#1 mark
                  LET l_tmp.c = l_tmp.d          #170328-00085#1 add 
                  LET l_tmp.d = 0
                  LET l_tmp.glaq041 = l_tmp.glaq040 * -1
                  LET l_tmp.glaq040 = 0
                  LET l_tmp.glaq044 = l_tmp.glaq043 * -1
                  LET l_tmp.glaq043 = 0
                  LET l_tmp.sum = l_tmp.sum * -1
               END IF

               #161223-00028#1--add--str--lujh
               IF l_tmp.d = 0 AND l_tmp.c = 0 THEN 
                  CONTINUE FOREACH
               END IF
               #161223-00028#1--add--end--lujh

               #170111-00055#1 add lujh axrp133效能优化
               IF cl_null(l_tmp.glaq001) THEN #170310-00016#1 ADD xul 
                  CALL s_aap_get_glab010(p_xrcald,'13',l_xrca007,'8304_01',l_tmp.glaq001,
                         p_xrcadocno,l_tmp.seq,'AR','1',l_tmp.glaq002,'glgb001')
                  RETURNING l_tmp.glaq001
               END IF  #170310-00016#1 ADD xul 
               IF cl_null(l_tmp.glbc004) THEN 
                  IF l_tmp.d <> 0 THEN 
                     LET l_tmp.glbc004 = l_glad006
                  END IF
                  
                  IF l_tmp.c <> 0 THEN 
                     LET l_tmp.glbc004 = l_glad036
                  END IF
               END IF #170310-00016#1 ADD xul  
               #170111-00055#1 add lujh axrp133效能优化

               #170111-00055#1 mark lujh axrp133效能优化
               #IF cl_null(l_tmp.glaq001) THEN
               #   #                 2:摘要/账套/科目编号  /程序编号/目的字段/单据编号/单据项次1/单据项次2
               #   CALL s_account_item('2',p_xrcald,l_tmp.glaq002,l_prog,'glgb001',p_xrcadocno,l_tmp.seq,'')
               #   RETURNING l_memo
               #   IF NOT cl_null(l_memo) THEN
               #      LET l_tmp.glaq001 = l_memo
               #   END IF
               #END IF
               #
               #IF cl_null(l_tmp.glaq001) THEN
               #   CALL s_axrt300_get_meno(p_xrcald,p_xrcadocno,l_tmp.seq,l_tmp.glaq002)
               #      RETURNING l_success,l_memo
               #   LET l_tmp.glaq001 = l_tmp.glaq001,l_memo
               #   IF cl_null(l_tmp.glaq001) THEN
               #      LET l_tmp.glaq001 = ''
               #   END IF
               #END IF
               #
               #CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
               #
               #IF cl_null(l_tmp.glbc004) AND l_glac016 = 'Y' THEN
               #   CALL s_voucher_glad006_get(p_xrcald,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glbc004
               #END IF
               #170111-00055#1 mark lujh axrp133效能优化

               INSERT INTO s_vr_tmp04 VALUES(l_tmp.*)
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = 'insert s_vr_tmp04'
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  RETURN r_success
               END IF
            END FOREACH
         END IF
      #161212-00024#1 Add  ---(S)---
   END CASE
   
   LET r_success = TRUE
   RETURN r_success
################################################################################
END FUNCTION
################################################################################
# Descriptions...: 自动生成凭证 - 产生凭证单头
# Memo...........:
# Usage..........: CALL s_voucher_gen_ar_2_ins_glap(p_type,p_slip,p_date,p_ld,p_sum_type)
#                       RETURNING r_success,r_start_no,r_end_no
# Input parameter: p_type         来源类型
#                                 1.axrt330 应收立帐
#                                 2.axrt400 應收沖帳 
#                : p_slip         凭证单别
#                : p_date         傳票日期
#                : p_ld           帳套
#                : p_sum_type     匯總方式
# Return code....: r_success      成功否标识位
#                : r_start_no     生成的起始凭证单号
#                : r_end_no       生成的截止凭证单号
# Date & Author..: 2013/11/01 By Carrier
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_2_ins_glap(p_type,p_slip,p_date,p_ld,p_sum_type)
   DEFINE p_type          LIKE type_t.chr2
  #DEFINE p_slip          LIKE ooba_t.ooba002    #160525-00021#1 mark
   DEFINE p_slip          LIKE type_t.chr50      #160525-00021#1    
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE p_sum_type      LIKE type_t.chr1
   DEFINE p_date          LIKE glap_t.glapdocdt
   DEFINE r_success       LIKE type_t.num5
   DEFINE r_start_no      LIKE glap_t.glapdocno
   DEFINE r_end_no        LIKE glap_t.glapdocno
   #161128-00061#7---add---begin-----------
   #DEFINE l_glap          RECORD LIKE glap_t.*
   DEFINE l_glap RECORD  #傳票憑證單頭檔
       glapent LIKE glap_t.glapent, #企業編號
       glapld LIKE glap_t.glapld, #帳套
       glapcomp LIKE glap_t.glapcomp, #法人
       glapdocno LIKE glap_t.glapdocno, #單號
       glapdocdt LIKE glap_t.glapdocdt, #單據日期
       glap001 LIKE glap_t.glap001, #傳票性質
       glap002 LIKE glap_t.glap002, #會計年度
       glap003 LIKE glap_t.glap003, #會計季別
       glap004 LIKE glap_t.glap004, #會計期別
       glap005 LIKE glap_t.glap005, #會計周別
       glap006 LIKE glap_t.glap006, #收支科目
       glap007 LIKE glap_t.glap007, #來源碼
       glap008 LIKE glap_t.glap008, #帳款類型
       glap009 LIKE glap_t.glap009, #總號
       glap010 LIKE glap_t.glap010, #借方總金額
       glap011 LIKE glap_t.glap011, #貸方總金額
       glap012 LIKE glap_t.glap012, #列印次數
       glap013 LIKE glap_t.glap013, #附件張數
       glap014 LIKE glap_t.glap014, #外幣憑證否
       glap015 LIKE glap_t.glap015, #原傳票編號
       glap016 LIKE glap_t.glap016, #來源帳套編號
       glap017 LIKE glap_t.glap017, #來源傳票編號
       glapownid LIKE glap_t.glapownid, #資料所有者
       glapowndp LIKE glap_t.glapowndp, #資料所屬部門
       glapcrtid LIKE glap_t.glapcrtid, #資料建立者
       glapcrtdp LIKE glap_t.glapcrtdp, #資料建立部門
       glapcrtdt LIKE glap_t.glapcrtdt, #資料創建日
       glapmodid LIKE glap_t.glapmodid, #資料修改者
       glapmoddt LIKE glap_t.glapmoddt, #最近修改日
       glapcnfid LIKE glap_t.glapcnfid, #資料確認者
       glapcnfdt LIKE glap_t.glapcnfdt, #資料確認日
       glappstid LIKE glap_t.glappstid, #資料過帳者
       glappstdt LIKE glap_t.glappstdt, #資料過帳日
       glapstus LIKE glap_t.glapstus, #狀態碼
       glapud001 LIKE glap_t.glapud001, #自定義欄位(文字)001
       glapud002 LIKE glap_t.glapud002, #自定義欄位(文字)002
       glapud003 LIKE glap_t.glapud003, #自定義欄位(文字)003
       glapud004 LIKE glap_t.glapud004, #自定義欄位(文字)004
       glapud005 LIKE glap_t.glapud005, #自定義欄位(文字)005
       glapud006 LIKE glap_t.glapud006, #自定義欄位(文字)006
       glapud007 LIKE glap_t.glapud007, #自定義欄位(文字)007
       glapud008 LIKE glap_t.glapud008, #自定義欄位(文字)008
       glapud009 LIKE glap_t.glapud009, #自定義欄位(文字)009
       glapud010 LIKE glap_t.glapud010, #自定義欄位(文字)010
       glapud011 LIKE glap_t.glapud011, #自定義欄位(數字)011
       glapud012 LIKE glap_t.glapud012, #自定義欄位(數字)012
       glapud013 LIKE glap_t.glapud013, #自定義欄位(數字)013
       glapud014 LIKE glap_t.glapud014, #自定義欄位(數字)014
       glapud015 LIKE glap_t.glapud015, #自定義欄位(數字)015
       glapud016 LIKE glap_t.glapud016, #自定義欄位(數字)016
       glapud017 LIKE glap_t.glapud017, #自定義欄位(數字)017
       glapud018 LIKE glap_t.glapud018, #自定義欄位(數字)018
       glapud019 LIKE glap_t.glapud019, #自定義欄位(數字)019
       glapud020 LIKE glap_t.glapud020, #自定義欄位(數字)020
       glapud021 LIKE glap_t.glapud021, #自定義欄位(日期時間)021
       glapud022 LIKE glap_t.glapud022, #自定義欄位(日期時間)022
       glapud023 LIKE glap_t.glapud023, #自定義欄位(日期時間)023
       glapud024 LIKE glap_t.glapud024, #自定義欄位(日期時間)024
       glapud025 LIKE glap_t.glapud025, #自定義欄位(日期時間)025
       glapud026 LIKE glap_t.glapud026, #自定義欄位(日期時間)026
       glapud027 LIKE glap_t.glapud027, #自定義欄位(日期時間)027
       glapud028 LIKE glap_t.glapud028, #自定義欄位(日期時間)028
       glapud029 LIKE glap_t.glapud029, #自定義欄位(日期時間)029
       glapud030 LIKE glap_t.glapud030  #自定義欄位(日期時間)030
       END RECORD

   #161128-00061#7---add---end-----------
   DEFINE l_glaqent       LIKE glaq_t.glaqent
   DEFINE l_glaqld        LIKE glaq_t.glaqld
   DEFINE l_glaqcomp      LIKE glaq_t.glaqcomp
   DEFINE l_docno         LIKE glap_t.glapdocno
   DEFINE l_docdt         LIKE glap_t.glapdocdt
   DEFINE l_glaq021       LIKE glaq_t.glaq021
   DEFINE l_success       LIKE type_t.num5
   DEFINE l_ooef008       LIKE ooef_t.ooef008
   DEFINE l_ooef010       LIKE ooef_t.ooef010
   DEFINE l_glaa001       LIKE glaa_t.glaa001
   DEFINE l_xrca100       LIKE xrca_t.xrca100
   DEFINE l_sql           STRING
   DEFINE l_glaa100       LIKE glaa_t.glaa100
   DEFINE l_glaa024       LIKE glaa_t.glaa024
   DEFINE l_cnt           LIKE type_t.num5
   DEFINE l_date          LIKE glap_t.glapdocdt

   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE
   LET r_start_no = NULL
   LET r_end_no   = NULL
   
   #1.定义CURSOR
   CALL s_voucher_gen_ar_2_def_cursor(p_ld,'',p_sum_type,'') RETURNING l_success
   IF NOT l_success THEN
      RETURN r_success,r_start_no,r_end_no  
   END IF

   #150126-00027#1---(S)
   SELECT glaa100,glaa024 INTO l_glaa100,l_glaa024 FROM glaa_t WHERE glaaent = g_enterprise AND glaald = p_ld

   IF l_glaa100 = 'Y' THEN
      #161207-00051#1--mark--str--lujh
      #DELETE FROM s_fin_tmp  #160727-00019#31  2016/08/10  By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
      #CALL s_fin_continue_no_ins(p_ld,l_glaa024,p_slip,p_date,'3') RETURNING g_sub_success,g_errno
      #161207-00051#1--mark--end--lujh
       
      DELETE FROM s_fin_tmp  #160727-00019#31  2016/08/10  By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
      IF NOT cl_null(p_date) THEN   #彙總類型是3的 p_date必傳
         CALL s_fin_continue_no_ins(p_ld,l_glaa024,p_slip,p_date,'3') RETURNING g_sub_success,g_errno
      ELSE
         LET l_sql = " SELECT DISTINCT docdt FROM s_vr_tmp04  "  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
         PREPARE continue_no_pb2 FROM l_sql
         DECLARE continue_no_cs2 CURSOR FOR continue_no_pb2
         FOREACH continue_no_cs2 INTO l_date
            CALL s_fin_continue_no_ins(p_ld,l_glaa024,p_slip,l_date,'3') RETURNING g_sub_success,g_errno
         END FOREACH
      END IF
   END IF

   LET l_sql = " SELECT docno FROM s_fin_tmp WHERE isuse = 'N' ORDER BY docno"  #160727-00019#31  2016/08/10  By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
   PREPARE continue_no_pb1 FROM l_sql
   DECLARE continue_no_cs1 CURSOR FOR continue_no_pb1
   #150126-00027#1---(E)
   
   #若p_date不为空时,则表示凭证日期均为p_date
   #IF NOT cl_null(p_date) THEN
   #   UPDATE s_voucher_ar_group SET docdt = p_date
   #   IF SQLCA.sqlcode THEN
   #      INITIALIZE g_errparam TO NULL
   #      LET g_errparam.code = SQLCA.sqlcode
   #      LET g_errparam.extend = 'update docdt'
   #      LET g_errparam.popup = TRUE
   #      CALL cl_err()
   #
   #      RETURN r_success,r_start_no,r_end_no  
   #   END IF
   #END IF
   
   
   FOREACH s_voucher_gen_ar_2_cs8 INTO l_glaqcomp,l_docno,l_docdt,l_glaq021
      IF SQLCA.sqlcode THEN  
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_ar_1_cs8'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success,r_start_no,r_end_no
      END IF
      
      INITIALIZE l_glap.* TO NULL
     
      
      #帳套主幣別
      SELECT glaa001 INTO l_glaa001 
        FROM glaa_t
       WHERE glaaent = g_enterprise
         AND glaald = p_ld
         
      SELECT xrca100 INTO l_xrca100
        FROM xrca_t
       WHERE xrcaent = g_enterprise
         AND xrcald = p_ld
         AND xrcadocno = l_docno
         
      #凭证日期没有值,按单据日期来
      IF cl_null(p_date) THEN 
         LET l_glap.glapdocdt = l_docdt     # 單據日期
      ELSE
         LET l_glap.glapdocdt = p_date      # 單據日期
      END IF

      #自动编号
      #150126-00027#1---(S)
      #SELECT count(*) INTO l_cnt #170615-00061#25 mark
      SELECT count(1) INTO l_cnt  #170615-00061#25 add
        FROM s_fin_tmp  #160727-00019#31  2016/08/10  By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
       WHERE isuse = 'N'
      IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF

      IF l_cnt > 0 THEN
         FOREACH continue_no_cs1 INTO l_glap.glapdocno
            UPDATE s_fin_tmp  #160727-00019#31  2016/08/10  By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
               SET isuse = 'Y'
             WHERE docno = l_glap.glapdocno
            #檢查是否號碼已被使用
            #SELECT count(*) INTO l_cnt        #170615-00061#25 mark
            SELECT count(glapdocno) INTO l_cnt #170615-00061#25 add
              FROM glap_t
             WHERE glapent = g_enterprise AND glapld = p_ld
              AND glapdocno=l_glap.glapdocno
            IF l_cnt = 0 THEN
               EXIT FOREACH
            END IF
         END FOREACH
         #假設整個單號都已被取用還是透過s_aooi200_fin_gen_docno取單號
         IF l_cnt > 0 THEN
            CALL s_aooi200_fin_gen_docno(p_ld,'','',p_slip,l_glap.glapdocdt,'aglt310') RETURNING g_sub_success,l_glap.glapdocno
         END IF
      ELSE
         CALL s_aooi200_fin_gen_docno(p_ld,'','',p_slip,l_glap.glapdocdt,'aglt310') RETURNING g_sub_success,l_glap.glapdocno
      END IF
      #150126-00027#1---(E)

     ##自动编号
     #CALL s_aooi200_fin_gen_docno(p_ld,'','',p_slip,p_date,'aglt310') RETURNING l_success,l_glap.glapdocno
     #IF NOT l_success THEN
     #   LET r_start_no = NULL
     #   LET r_end_no   = NULL
     #   RETURN r_success,r_start_no,r_end_no
     #END IF
      
      #处理起始单号,截止单号
      IF cl_null(r_start_no) THEN LET r_start_no = l_glap.glapdocno END IF
      LET r_end_no   = l_glap.glapdocno 
      
      LET l_glap.glapent   =  g_enterprise  # 企業代碼
      LET l_glap.glapld    =  p_ld          # 帳別
      LET l_glap.glapcomp  =  l_glaqcomp    # 法人
      LET l_glap.glap001   = '1'            # 傳票性質
      
      # 會計年度/會計期別/會計季別/會計周別
      CALL s_fin_date_get_yspw('',l_glap.glapld,l_glap.glapdocdt) 
      RETURNING l_success,l_glap.glap002,l_glap.glap003,l_glap.glap004,l_glap.glap005
      
      LET l_glap.glap006   =  ''         # 收支科目
      LET l_glap.glap007   =  'AR'       # 來源碼
      CASE p_type
         WHEN '1' 
            LET l_glap.glap008   =  'R10'  # 帳款類型  axrt3*
         WHEN '2' 
            LET l_glap.glap008   =  'R20'  # 帳款類型  axrt4*
         WHEN '4' 
            LET l_glap.glap008   =  'R60'  # 帳款類型  axrt940
         WHEN '5' 
            LET l_glap.glap008   =  'R50'  # 帳款類型  axrt930
         WHEN '6' 
            LET l_glap.glap008   =  'R51'  # 帳款類型  axrt931
         WHEN '3'
            LET l_glap.glap007   =  'NM'   
            LET l_glap.glap008   =  'N45'
      END CASE
      LET l_glap.glap009   =  0          # 總號
      LET l_glap.glap010   =  0          # 借方總金額
      LET l_glap.glap011   =  0          # 貸方總金額
      LET l_glap.glap012   =  0          # 列印次數
      LET l_glap.glap013   =  0          # 附件張數
      IF l_glaa001 = l_xrca100 THEN 
         LET l_glap.glap014   =  'N'        # 外幣憑證否
      ELSE
         LET l_glap.glap014   =  'Y'        # 外幣憑證否
      END IF
      LET l_glap.glap015   =  ''         # 原傳票編號
      LET l_glap.glap016   =  ''         # 來源帳別編號
      LET l_glap.glap017   =  ''         # 來源傳票編號
      LET l_glap.glapownid =  g_user     # 資料所有者
      LET l_glap.glapowndp =  g_dept     # 資料所屬部門
      LET l_glap.glapcrtid =  g_user     # 資料建立者
      LET l_glap.glapcrtdp =  g_dept     # 資料建立部門
      LET l_glap.glapcrtdt =  cl_get_current()  # 資料創建日
      LET l_glap.glapmodid =  ''         # 資料修改者
      LET l_glap.glapmoddt =  ''         # 最近修改日
      LET l_glap.glapcnfid =  ''         # 資料確認者
      LET l_glap.glapcnfdt =  ''         # 資料確認日
      LET l_glap.glappstid =  ''         # 資料過帳者
      LET l_glap.glappstdt =  ''         # 資料過帳日
      LET l_glap.glapstus  =  'N'        # 狀態碼

       #161128-00061#7---add---begin-----------
      #INSERT INTO glap_t VALUES(l_glap.*)
      INSERT INTO glap_t (glapent,glapld,glapcomp,glapdocno,glapdocdt,glap001,glap002,glap003,glap004,
                          glap005,glap006,glap007,glap008,glap009,glap010,glap011,glap012,glap013,glap014,
                          glap015,glap016,glap017,glapownid,glapowndp,glapcrtid,glapcrtdp,glapcrtdt,
                          glapmodid,glapmoddt,glapcnfid,glapcnfdt,glappstid,glappstdt,glapstus,
                          glapud001,glapud002,glapud003,glapud004,glapud005,glapud006,glapud007,glapud008,
                          glapud009,glapud010,glapud011,glapud012,glapud013,glapud014,glapud015,glapud016,
                          glapud017,glapud018,glapud019,glapud020,glapud021,glapud022,glapud023,glapud024,
                          glapud025,glapud026,glapud027,glapud028,glapud029,glapud030)
       VALUES(l_glap.glapent,l_glap.glapld,l_glap.glapcomp,l_glap.glapdocno,l_glap.glapdocdt,l_glap.glap001,l_glap.glap002,l_glap.glap003,l_glap.glap004,
              l_glap.glap005,l_glap.glap006,l_glap.glap007,l_glap.glap008,l_glap.glap009,l_glap.glap010,l_glap.glap011,l_glap.glap012,l_glap.glap013,l_glap.glap014,
              l_glap.glap015,l_glap.glap016,l_glap.glap017,l_glap.glapownid,l_glap.glapowndp,l_glap.glapcrtid,l_glap.glapcrtdp,l_glap.glapcrtdt,
              l_glap.glapmodid,l_glap.glapmoddt,l_glap.glapcnfid,l_glap.glapcnfdt,l_glap.glappstid,l_glap.glappstdt,l_glap.glapstus,
              l_glap.glapud001,l_glap.glapud002,l_glap.glapud003,l_glap.glapud004,l_glap.glapud005,l_glap.glapud006,l_glap.glapud007,l_glap.glapud008,
              l_glap.glapud009,l_glap.glapud010,l_glap.glapud011,l_glap.glapud012,l_glap.glapud013,l_glap.glapud014,l_glap.glapud015,l_glap.glapud016,
              l_glap.glapud017,l_glap.glapud018,l_glap.glapud019,l_glap.glapud020,l_glap.glapud021,l_glap.glapud022,l_glap.glapud023,l_glap.glapud024,
              l_glap.glapud025,l_glap.glapud026,l_glap.glapud027,l_glap.glapud028,l_glap.glapud029,l_glap.glapud030)
      #161128-00061#7---add---end-----------
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'ins glap'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         LET r_start_no = NULL
         LET r_end_no   = NULL
         RETURN r_success,r_start_no,r_end_no         
      END IF
      
      #产生凭证单身
      CALL s_voucher_gen_ar_2_ins_glaq(p_type,l_glap.glapdocno,p_ld,l_glaqcomp,l_glap.glapdocdt,l_docno,l_docdt,l_glaq021,p_sum_type)
           RETURNING l_success
      IF NOT l_success THEN
         LET r_start_no = NULL
         LET r_end_no   = NULL
         RETURN r_success,r_start_no,r_end_no           
      END IF
      
      ##插入現金變動碼資訊
      #CALL s_voucher_ins_glac(l_glap.glapdocno) RETURNING l_success
      #IF NOT l_success THEN
      #   LET r_start_no = NULL
      #   LET r_end_no   = NULL
      #   RETURN r_success,r_start_no,r_end_no           
      #END IF
  
   END FOREACH
   
   IF cl_null(r_start_no) THEN 
      RETURN r_success,r_start_no,r_end_no
   END IF
   
   LET r_success = TRUE
   RETURN r_success,r_start_no,r_end_no
# Descriptions...: 自动产生凭证 - BY 科目的管理设置做UPDATE
# Memo...........:
# Usage..........: CALL s_voucher_gen_ar_1_upd_tmp()
#                  RETURNING r_success
END FUNCTION
################################################################################
# Input parameter: p_glapdocno    凭证单号
#                : p_glaqent      企业编号
#                : p_glaqld       帐套
#                : p_glaqcomp     公司编号
#                : p_glapdocn     憑證日期
#                : p_docno        来源单号
#                : p_docdt        來源單據日期
# Return code....: r_success      成功否标识位
# Date & Author..: 2013/11/04 By Carrier
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_2_ins_glaq(p_type,p_glapdocno,p_glaqld,p_glaqcomp,p_glapdocdt,p_docno,p_docdt,p_glaq021,p_sum_type)
   DEFINE p_type              LIKE type_t.chr2
   DEFINE p_glapdocno         LIKE glap_t.glapdocno
   DEFINE p_glaqent           LIKE glaq_t.glaqent
   DEFINE p_glaqld            LIKE glaq_t.glaqld
   DEFINE p_glaqcomp          LIKE glaq_t.glaqcomp
   DEFINE p_glapdocdt         LIKE glap_t.glapdocdt
   DEFINE p_docno             LIKE glaq_t.glaqdocno
   DEFINE p_docdt             LIKE glap_t.glapdocdt
   DEFINE p_sum_type          LIKE type_t.chr1
   DEFINE p_glaq021           LIKE glaq_t.glaq021
   DEFINE r_success           LIKE type_t.num5
   DEFINE l_success           LIKE type_t.num5
   DEFINE l_value             LIKE type_t.chr50
  #161128-00061#7---add---begin-----------
   #DEFINE l_glaq              RECORD LIKE glaq_t.*
   DEFINE l_glaq RECORD  #傳票憑證單身檔
       glaqent LIKE glaq_t.glaqent, #企業編號
       glaqcomp LIKE glaq_t.glaqcomp, #法人
       glaqld LIKE glaq_t.glaqld, #帳套
       glaqdocno LIKE glaq_t.glaqdocno, #單號
       glaqseq LIKE glaq_t.glaqseq, #項次
       glaq001 LIKE glaq_t.glaq001, #摘要
       glaq002 LIKE glaq_t.glaq002, #科目編號
       glaq003 LIKE glaq_t.glaq003, #借方金額
       glaq004 LIKE glaq_t.glaq004, #貸方金額
       glaq005 LIKE glaq_t.glaq005, #交易幣別
       glaq006 LIKE glaq_t.glaq006, #匯率
       glaq007 LIKE glaq_t.glaq007, #計價單位
       glaq008 LIKE glaq_t.glaq008, #數量
       glaq009 LIKE glaq_t.glaq009, #單價
       glaq010 LIKE glaq_t.glaq010, #原幣金額
       glaq011 LIKE glaq_t.glaq011, #票據編碼
       glaq012 LIKE glaq_t.glaq012, #票據日期
       glaq013 LIKE glaq_t.glaq013, #申請人
       glaq014 LIKE glaq_t.glaq014, #銀行帳號
       glaq015 LIKE glaq_t.glaq015, #款別編號
       glaq016 LIKE glaq_t.glaq016, #收支專案
       glaq017 LIKE glaq_t.glaq017, #營運據點
       glaq018 LIKE glaq_t.glaq018, #部門
       glaq019 LIKE glaq_t.glaq019, #利潤/成本中心
       glaq020 LIKE glaq_t.glaq020, #區域
       glaq021 LIKE glaq_t.glaq021, #收付款客商
       glaq022 LIKE glaq_t.glaq022, #帳款客戶
       glaq023 LIKE glaq_t.glaq023, #客群
       glaq024 LIKE glaq_t.glaq024, #產品類別
       glaq025 LIKE glaq_t.glaq025, #人員
       glaq026 LIKE glaq_t.glaq026, #no use
       glaq027 LIKE glaq_t.glaq027, #專案編號
       glaq028 LIKE glaq_t.glaq028, #WBS
       glaq029 LIKE glaq_t.glaq029, #自由核算項一
       glaq030 LIKE glaq_t.glaq030, #自由核算項二
       glaq031 LIKE glaq_t.glaq031, #自由核算項三
       glaq032 LIKE glaq_t.glaq032, #自由核算項四
       glaq033 LIKE glaq_t.glaq033, #自由核算項五
       glaq034 LIKE glaq_t.glaq034, #自由核算項六
       glaq035 LIKE glaq_t.glaq035, #自由核算項七
       glaq036 LIKE glaq_t.glaq036, #自由核算項八
       glaq037 LIKE glaq_t.glaq037, #自由核算項九
       glaq038 LIKE glaq_t.glaq038, #自由核算項十
       glaq039 LIKE glaq_t.glaq039, #匯率(本位幣二)
       glaq040 LIKE glaq_t.glaq040, #借方金額(本位幣二)
       glaq041 LIKE glaq_t.glaq041, #貸方金額(本位幣二)
       glaq042 LIKE glaq_t.glaq042, #匯率(本位幣三)
       glaq043 LIKE glaq_t.glaq043, #借方金額(本位幣三)
       glaq044 LIKE glaq_t.glaq044, #貸方金額(本位幣三)
       glaq051 LIKE glaq_t.glaq051, #經營方式
       glaq052 LIKE glaq_t.glaq052, #通路
       glaq053 LIKE glaq_t.glaq053, #品牌
       glaqud001 LIKE glaq_t.glaqud001, #自定義欄位(文字)001
       glaqud002 LIKE glaq_t.glaqud002, #自定義欄位(文字)002
       glaqud003 LIKE glaq_t.glaqud003, #自定義欄位(文字)003
       glaqud004 LIKE glaq_t.glaqud004, #自定義欄位(文字)004
       glaqud005 LIKE glaq_t.glaqud005, #自定義欄位(文字)005
       glaqud006 LIKE glaq_t.glaqud006, #自定義欄位(文字)006
       glaqud007 LIKE glaq_t.glaqud007, #自定義欄位(文字)007
       glaqud008 LIKE glaq_t.glaqud008, #自定義欄位(文字)008
       glaqud009 LIKE glaq_t.glaqud009, #自定義欄位(文字)009
       glaqud010 LIKE glaq_t.glaqud010, #自定義欄位(文字)010
       glaqud011 LIKE glaq_t.glaqud011, #自定義欄位(數字)011
       glaqud012 LIKE glaq_t.glaqud012, #自定義欄位(數字)012
       glaqud013 LIKE glaq_t.glaqud013, #自定義欄位(數字)013
       glaqud014 LIKE glaq_t.glaqud014, #自定義欄位(數字)014
       glaqud015 LIKE glaq_t.glaqud015, #自定義欄位(數字)015
       glaqud016 LIKE glaq_t.glaqud016, #自定義欄位(數字)016
       glaqud017 LIKE glaq_t.glaqud017, #自定義欄位(數字)017
       glaqud018 LIKE glaq_t.glaqud018, #自定義欄位(數字)018
       glaqud019 LIKE glaq_t.glaqud019, #自定義欄位(數字)019
       glaqud020 LIKE glaq_t.glaqud020, #自定義欄位(數字)020
       glaqud021 LIKE glaq_t.glaqud021, #自定義欄位(日期時間)021
       glaqud022 LIKE glaq_t.glaqud022, #自定義欄位(日期時間)022
       glaqud023 LIKE glaq_t.glaqud023, #自定義欄位(日期時間)023
       glaqud024 LIKE glaq_t.glaqud024, #自定義欄位(日期時間)024
       glaqud025 LIKE glaq_t.glaqud025, #自定義欄位(日期時間)025
       glaqud026 LIKE glaq_t.glaqud026, #自定義欄位(日期時間)026
       glaqud027 LIKE glaq_t.glaqud027, #自定義欄位(日期時間)027
       glaqud028 LIKE glaq_t.glaqud028, #自定義欄位(日期時間)028
       glaqud029 LIKE glaq_t.glaqud029, #自定義欄位(日期時間)029
       glaqud030 LIKE glaq_t.glaqud030  #自定義欄位(日期時間)030
       END RECORD
   #161128-00061#7---add---end-----------
   DEFINE l_xrca039           LIKE xrca_t.xrca039
   DEFINE l_last_xrcadocno    LIKE xrca_t.xrcadocno
   DEFINE l_foreign           LIKE type_t.chr1
   DEFINE l_glaa001           LIKE glaa_t.glaa001
   DEFINE l_glaa015           LIKE glaa_t.glaa015   
   DEFINE l_glaa016           LIKE glaa_t.glaa016
   DEFINE l_glaa019           LIKE glaa_t.glaa019  
   DEFINE l_glaa020           LIKE glaa_t.glaa020
   DEFINE l_glap010           LIKE glap_t.glap010
   DEFINE l_glap011           LIKE glap_t.glap011
   DEFINE l_xrcadocno         LIKE xrca_t.xrcadocno
   DEFINE l_glad_r            RECORD 
                              glad005   LIKE glad_t.glad005,  #数量/金额管理否
                              glad007   LIKE glad_t.glad007,  #部门管理否
                              glad008   LIKE glad_t.glad008,  #利润成本管理否
                              glad009   LIKE glad_t.glad009,  #区域管理否
                              glad010   LIKE glad_t.glad010,  #交易客商管理否
                              glad011   LIKE glad_t.glad011,  #客群管理否
                              glad012   LIKE glad_t.glad012,  #产品类别管理否
                              glad013   LIKE glad_t.glad013,  #人员管理否
#                              glad014   LIKE glad_t.glad014,  #预算管理否
                              glad015   LIKE glad_t.glad015,  #专案管理否
                              glad016   LIKE glad_t.glad016,  #WBS管理否
                              glad017   LIKE glad_t.glad017,  #自由核算项1管理否
                              glad018   LIKE glad_t.glad018,  #自由核算项2管理否
                              glad019   LIKE glad_t.glad019,  #自由核算项3管理否
                              glad020   LIKE glad_t.glad020,  #自由核算项4管理否
                              glad021   LIKE glad_t.glad021,  #自由核算项5管理否
                              glad022   LIKE glad_t.glad022,  #自由核算项6管理否
                              glad023   LIKE glad_t.glad023,  #自由核算项7管理否
                              glad024   LIKE glad_t.glad024,  #自由核算项8管理否
                              glad025   LIKE glad_t.glad025,  #自由核算项9管理否
                              glad026   LIKE glad_t.glad026,  #自由核算项10管理否   
                              glad027   LIKE glad_t.glad027,  #账款客商管理否   
                              glad031   LIKE glad_t.glad031,  #經營方式管理否
                              glad032   LIKE glad_t.glad032,  #渠道管理否
                              glad033   LIKE glad_t.glad033   #品牌管理否                   
                              END RECORD
   DEFINE l_tmp               RECORD 
                              docno       LIKE glaq_t.glaqdocno,
                              docdt       LIKE glap_t.glapdocdt,
                              sw          LIKE type_t.chr1,       #1.借  2.贷
                              glaqent     LIKE glaq_t.glaqent,  
                              glaqcomp    LIKE glaq_t.glaqcomp, 
                              glaqld      LIKE glaq_t.glaqld,   
                              glaq001     LIKE glaq_t.glaq001,  
                              glaq002     LIKE glaq_t.glaq002,  
                              glaq005     LIKE glaq_t.glaq005,  
                              glaq006     LIKE glaq_t.glaq006,  
                              glaq007     LIKE glaq_t.glaq007,  
                              glaq009     LIKE glaq_t.glaq009,  
                              glaq011     LIKE glaq_t.glaq011,  
                              glaq012     LIKE glaq_t.glaq012,  
                              glaq013     LIKE glaq_t.glaq013,  
                              glaq014     LIKE glaq_t.glaq014,  
                              glaq015     LIKE glaq_t.glaq015,  
                              glaq016     LIKE glaq_t.glaq016,  
                              glaq017     LIKE glaq_t.glaq017,  
                              glaq018     LIKE glaq_t.glaq018,  
                              glaq019     LIKE glaq_t.glaq019,  
                              glaq020     LIKE glaq_t.glaq020,  
                              glaq021     LIKE glaq_t.glaq021,  
                              glaq022     LIKE glaq_t.glaq022,  
                              glaq023     LIKE glaq_t.glaq023,  
                              glaq024     LIKE glaq_t.glaq024,  
                              glaq025     LIKE glaq_t.glaq025,  
                              glaq027     LIKE glaq_t.glaq027,  
                              glaq028     LIKE glaq_t.glaq028,  
                              glaq051     LIKE glaq_t.glaq051,  #經營方式
                              glaq052     LIKE glaq_t.glaq052,  #渠道 
                              glaq053     LIKE glaq_t.glaq053,  #品牌
                              glaq029     LIKE glaq_t.glaq029,  
                              glaq030     LIKE glaq_t.glaq030,  
                              glaq031     LIKE glaq_t.glaq031,  
                              glaq032     LIKE glaq_t.glaq032,  
                              glaq033     LIKE glaq_t.glaq033,  
                              glaq034     LIKE glaq_t.glaq034,  
                              glaq035     LIKE glaq_t.glaq035,  
                              glaq036     LIKE glaq_t.glaq036,  
                              glaq037     LIKE glaq_t.glaq037,  
                              glaq038     LIKE glaq_t.glaq038, 
                              glbc004     LIKE glbc_t.glbc004,  #现金变动码                              
                              d           LIKE glaq_t.glaq003,  
                              c           LIKE glaq_t.glaq004,  
                              qty         LIKE glaq_t.glaq008,  
                              sum         LIKE glaq_t.glaq010,
                              glaq039     LIKE glaq_t.glaq039,
                              glaq040     LIKE glaq_t.glaq040,
                              glaq041     LIKE glaq_t.glaq041,
                              glaq042     LIKE glaq_t.glaq042,
                              glaq043     LIKE glaq_t.glaq043,
                              glaq044     LIKE glaq_t.glaq044,
                              seq         LIKE glaq_t.glaqseq,
                              source      LIKE type_t.chr100,
                              glaqseq     LIKE glaq_t.glaqseq,
                              xrca039     LIKE xrca_t.xrca039,
                              b_glaq021   LIKE glaq_t.glaq021,
                              b_glaq022   LIKE glaq_t.glaq022,
                              red         LIKE type_t.chr1       #红冲否(待抵单使用) #20150612 add lujh                                
                              END RECORD
   DEFINE l_value1  LIKE type_t.chr50
   DEFINE l_value2  LIKE type_t.chr50
   
   WHENEVER ERROR CONTINUE
   LET r_success = FALSE
   
   CASE p_sum_type
        WHEN '1'  LET l_value1 = p_docno
                  LET l_value2 = ''
        WHEN '2'  LET l_value1 = p_docdt
                  LET l_value2 = '' 
        WHEN '3'  LET l_value1 = p_glaq021
                  LET l_value2 = ''
        WHEN '4'  LET l_value1 = p_glaq021
                  LET l_value2 = p_docdt
        WHEN '5'  LET l_value1 = ''
                  LET l_value2 = ''
   END CASE
   
   SELECT glaa001,glaa015,glaa016,glaa019,glaa020 
     INTO l_glaa001,l_glaa015,l_glaa016,l_glaa019,l_glaa020    
     FROM glaa_t 
    WHERE glaaent = g_enterprise AND glaald = p_glaqld
   
   LET l_xrca039 = 0  #附件张数
   LET l_foreign = 'N' #外币凭证否
   
   INITIALIZE l_tmp.* TO NULL
   LET l_last_xrcadocno = NULL

   FOREACH s_voucher_gen_ar_2_cs9 USING l_value1,l_value2 INTO l_tmp.*
      IF SQLCA.sqlcode THEN  
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_ar_2_cs9'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF   
      INITIALIZE l_glaq.* TO NULL
      
      
      IF l_foreign = 'N' THEN
         IF l_tmp.glaq005 <> l_glaa001 THEN
            LET l_foreign = 'Y'
         END IF
      END IF
      
      LET l_glaq.glaqent   = l_tmp.glaqent    #企業代碼
      LET l_glaq.glaqcomp  = l_tmp.glaqcomp   #法人
      LET l_glaq.glaqld    = p_glaqld         #帳別
      LET l_glaq.glaqdocno = p_glapdocno      #單號
      #项次
      SELECT MAX(glaqseq) + 1 INTO l_glaq.glaqseq
        FROM glaq_t
       WHERE glaqent   = l_glaq.glaqent
         AND glaqld    = l_glaq.glaqld
         AND glaqdocno = l_glaq.glaqdocno
      IF cl_null(l_glaq.glaqseq) THEN
         LET l_glaq.glaqseq = 1
      END IF
      LET l_glaq.glaq001   = l_tmp.glaq001    #摘要
      LET l_glaq.glaq002   = l_tmp.glaq002    #科目編號
      LET l_glaq.glaq003   = l_tmp.d          #借方金額
      LET l_glaq.glaq004   = l_tmp.c          #貸方金額
      LET l_glaq.glaq005   = l_tmp.glaq005    #交易幣別
      LET l_glaq.glaq006   = l_tmp.glaq006    #匯率
      LET l_glaq.glaq007   = l_tmp.glaq007    #計價單位
      LET l_glaq.glaq008   = l_tmp.qty        #數量
      LET l_glaq.glaq009   = l_tmp.glaq009    #單價
      LET l_glaq.glaq010   = l_tmp.sum        #原幣金額
      LET l_glaq.glaq011   = l_tmp.glaq011    #票據編碼
      LET l_glaq.glaq012   = l_tmp.glaq012    #票據日期
      LET l_glaq.glaq013   = l_tmp.glaq013    #申請人
      LET l_glaq.glaq014   = l_tmp.glaq014    #銀行帳號
      LET l_glaq.glaq015   = l_tmp.glaq015    #結算方式
      LET l_glaq.glaq016   = l_tmp.glaq016    #收支項目
      LET l_glaq.glaq017   = l_tmp.glaq017    #營運據點
      LET l_glaq.glaq018   = l_tmp.glaq018    #部門
      LET l_glaq.glaq019   = l_tmp.glaq019    #利潤/成本中心
      LET l_glaq.glaq020   = l_tmp.glaq020    #區域
      LET l_glaq.glaq021   = l_tmp.glaq021    #交易客商  
      LET l_glaq.glaq022   = l_tmp.glaq022    #账款客商  
      
      #EXECUTE s_voucher_gen_ar_2_cs6 USING l_glaq.glaq002 INTO l_glad_r.*
      #
      #IF l_glad_r.glad010 = 'N' OR cl_null(l_glad_r.glad010) THEN            #客商不管理
      #   LET l_glaq.glaq021   = ''              #交易客商
      #ELSE
      #   LET l_glaq.glaq021   = l_tmp.glaq021   #交易客商      
      #END IF      
      #IF l_glad_r.glad027 = 'N' OR cl_null(l_glad_r.glad027) THEN            #客群不管理
      #   LET l_glaq.glaq022   = ''              #交易客商
      #ELSE
      #   LET l_glaq.glaq022   = l_tmp.glaq022   #交易客商      
      #END IF    

      LET l_glaq.glaq023   = l_tmp.glaq023    #客群
      LET l_glaq.glaq024   = l_tmp.glaq024    #產品類別
      LET l_glaq.glaq025   = l_tmp.glaq025    #人員
      LET l_glaq.glaq027   = l_tmp.glaq027    #專案編號
      LET l_glaq.glaq028   = l_tmp.glaq028    #WBS
      LET l_glaq.glaq051   = l_tmp.glaq051    #經營方式
      LET l_glaq.glaq052   = l_tmp.glaq052    #渠道
      LET l_glaq.glaq053   = l_tmp.glaq053    #品牌
      LET l_glaq.glaq029   = l_tmp.glaq029    #自由核算項一
      LET l_glaq.glaq030   = l_tmp.glaq030    #自由核算項二
      LET l_glaq.glaq031   = l_tmp.glaq031    #自由核算項三
      LET l_glaq.glaq032   = l_tmp.glaq032    #自由核算項四
      LET l_glaq.glaq033   = l_tmp.glaq033    #自由核算項五
      LET l_glaq.glaq034   = l_tmp.glaq034    #自由核算項六
      LET l_glaq.glaq035   = l_tmp.glaq035    #自由核算項七
      LET l_glaq.glaq036   = l_tmp.glaq036    #自由核算項八
      LET l_glaq.glaq037   = l_tmp.glaq037    #自由核算項九
      LET l_glaq.glaq038   = l_tmp.glaq038    #自由核算項十
      
      LET l_glaq.glaq039   = l_tmp.glaq039
      LET l_glaq.glaq040   = l_tmp.glaq040
      LET l_glaq.glaq041   = l_tmp.glaq041
      LET l_glaq.glaq042   = l_tmp.glaq042
      LET l_glaq.glaq043   = l_tmp.glaq043
      LET l_glaq.glaq044   = l_tmp.glaq044
      
      #核算项如果没值,给个空格 
      IF l_glaq.glaq018 IS NULL THEN LET l_glaq.glaq018 = ' ' END IF
      IF l_glaq.glaq019 IS NULL THEN LET l_glaq.glaq019 = ' ' END IF
      IF l_glaq.glaq020 IS NULL THEN LET l_glaq.glaq020 = ' ' END IF
      IF l_glaq.glaq021 IS NULL THEN LET l_glaq.glaq021 = ' ' END IF
      IF l_glaq.glaq022 IS NULL THEN LET l_glaq.glaq022 = ' ' END IF
      IF l_glaq.glaq023 IS NULL THEN LET l_glaq.glaq023 = ' ' END IF
      IF l_glaq.glaq024 IS NULL THEN LET l_glaq.glaq024 = ' ' END IF
      IF l_glaq.glaq025 IS NULL THEN LET l_glaq.glaq025 = ' ' END IF
      IF l_glaq.glaq027 IS NULL THEN LET l_glaq.glaq027 = ' ' END IF
      IF l_glaq.glaq028 IS NULL THEN LET l_glaq.glaq028 = ' ' END IF
      IF l_glaq.glaq051 IS NULL THEN LET l_glaq.glaq051 = ' ' END IF
      IF l_glaq.glaq052 IS NULL THEN LET l_glaq.glaq052 = ' ' END IF
      IF l_glaq.glaq053 IS NULL THEN LET l_glaq.glaq053 = ' ' END IF
      IF l_glaq.glaq029 IS NULL THEN LET l_glaq.glaq029 = ' ' END IF
      IF l_glaq.glaq030 IS NULL THEN LET l_glaq.glaq030 = ' ' END IF
      IF l_glaq.glaq031 IS NULL THEN LET l_glaq.glaq031 = ' ' END IF
      IF l_glaq.glaq032 IS NULL THEN LET l_glaq.glaq032 = ' ' END IF
      IF l_glaq.glaq033 IS NULL THEN LET l_glaq.glaq033 = ' ' END IF
      IF l_glaq.glaq034 IS NULL THEN LET l_glaq.glaq034 = ' ' END IF
      IF l_glaq.glaq035 IS NULL THEN LET l_glaq.glaq035 = ' ' END IF
      IF l_glaq.glaq036 IS NULL THEN LET l_glaq.glaq036 = ' ' END IF
      IF l_glaq.glaq037 IS NULL THEN LET l_glaq.glaq037 = ' ' END IF
      IF l_glaq.glaq038 IS NULL THEN LET l_glaq.glaq038 = ' ' END IF
      
      LET l_glaq.glaq010 = s_curr_round(l_glaq.glaqcomp,l_glaq.glaq005,l_glaq.glaq010,'2')
      LET l_glaq.glaq003 = s_curr_round(l_glaq.glaqcomp,l_glaa001,l_glaq.glaq003,'2')
      LET l_glaq.glaq004 = s_curr_round(l_glaq.glaqcomp,l_glaa001,l_glaq.glaq004,'2')
      IF l_glaa015 = 'Y' THEN 
         LET l_glaq.glaq040 = s_curr_round(l_glaq.glaqcomp,l_glaa016,l_glaq.glaq040,'2')
         LET l_glaq.glaq041 = s_curr_round(l_glaq.glaqcomp,l_glaa016,l_glaq.glaq041,'2')
      END IF
      IF l_glaa019 = 'Y' THEN
         LET l_glaq.glaq043 = s_curr_round(l_glaq.glaqcomp,l_glaa020,l_glaq.glaq043,'2')
         LET l_glaq.glaq044 = s_curr_round(l_glaq.glaqcomp,l_glaa020,l_glaq.glaq044,'2')
      END IF
      
      #161128-00061#7---add---begin-----------
      #INSERT INTO glaq_t VALUES(l_glaq.*)
      INSERT INTO glaq_t (glaqent,glaqcomp,glaqld,glaqdocno,glaqseq,glaq001,glaq002,glaq003,glaq004,glaq005,
                          glaq006,glaq007,glaq008,glaq009,glaq010,glaq011,glaq012,glaq013,glaq014,glaq015,
                          glaq016,glaq017,glaq018,glaq019,glaq020,glaq021,glaq022,glaq023,glaq024,glaq025,
                          glaq026,glaq027,glaq028,glaq029,glaq030,glaq031,glaq032,glaq033,glaq034,glaq035,
                          glaq036,glaq037,glaq038,glaq039,glaq040,glaq041,glaq042,glaq043,glaq044,glaq051,
                          glaq052,glaq053,glaqud001,glaqud002,glaqud003,glaqud004,glaqud005,glaqud006,
                          glaqud007,glaqud008,glaqud009,glaqud010,glaqud011,glaqud012,glaqud013,glaqud014,
                          glaqud015,glaqud016,glaqud017,glaqud018,glaqud019,glaqud020,glaqud021,glaqud022,
                          glaqud023,glaqud024,glaqud025,glaqud026,glaqud027,glaqud028,glaqud029,glaqud030)
       VALUES(l_glaq.glaqent,l_glaq.glaqcomp,l_glaq.glaqld,l_glaq.glaqdocno,l_glaq.glaqseq,l_glaq.glaq001,l_glaq.glaq002,l_glaq.glaq003,l_glaq.glaq004,l_glaq.glaq005,
              l_glaq.glaq006,l_glaq.glaq007,l_glaq.glaq008,l_glaq.glaq009,l_glaq.glaq010,l_glaq.glaq011,l_glaq.glaq012,l_glaq.glaq013,l_glaq.glaq014,l_glaq.glaq015,
              l_glaq.glaq016,l_glaq.glaq017,l_glaq.glaq018,l_glaq.glaq019,l_glaq.glaq020,l_glaq.glaq021,l_glaq.glaq022,l_glaq.glaq023,l_glaq.glaq024,l_glaq.glaq025,
              l_glaq.glaq026,l_glaq.glaq027,l_glaq.glaq028,l_glaq.glaq029,l_glaq.glaq030,l_glaq.glaq031,l_glaq.glaq032,l_glaq.glaq033,l_glaq.glaq034,l_glaq.glaq035,
              l_glaq.glaq036,l_glaq.glaq037,l_glaq.glaq038,l_glaq.glaq039,l_glaq.glaq040,l_glaq.glaq041,l_glaq.glaq042,l_glaq.glaq043,l_glaq.glaq044,l_glaq.glaq051,
              l_glaq.glaq052,l_glaq.glaq053,l_glaq.glaqud001,l_glaq.glaqud002,l_glaq.glaqud003,l_glaq.glaqud004,l_glaq.glaqud005,l_glaq.glaqud006,
              l_glaq.glaqud007,l_glaq.glaqud008,l_glaq.glaqud009,l_glaq.glaqud010,l_glaq.glaqud011,l_glaq.glaqud012,l_glaq.glaqud013,l_glaq.glaqud014,
              l_glaq.glaqud015,l_glaq.glaqud016,l_glaq.glaqud017,l_glaq.glaqud018,l_glaq.glaqud019,l_glaq.glaqud020,l_glaq.glaqud021,l_glaq.glaqud022,
              l_glaq.glaqud023,l_glaq.glaqud024,l_glaq.glaqud025,l_glaq.glaqud026,l_glaq.glaqud027,l_glaq.glaqud028,l_glaq.glaqud029,l_glaq.glaqud030)
      #161128-00061#7---add---end-----------
      IF SQLCA.sqlcode THEN      
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'ins glaq'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF
      
      CALL s_voucher_ins_glac(p_glaqld,p_glapdocdt,p_glapdocno,l_glaq.glaqseq,l_glaq.glaq002,l_tmp.glbc004,l_tmp.glaq021,l_glaq.*)
      RETURNING l_success
         
      IF l_success = FALSE THEN 
         RETURN r_success
      END IF
      
      #170103-00019#1--add--str--
      #插入细项立冲账资料
      LET l_success = TRUE
      CALL s_pre_voucher_insert_glax(l_glaq.*) RETURNING l_success
      IF l_success = FALSE THEN
         RETURN r_success
      END IF
      #170103-00019#1--add--end
      
      #汇总 附件张数 & update 来源单据的"抛转凭证单号"
      IF cl_null(l_last_xrcadocno) OR l_last_xrcadocno <> l_tmp.docno THEN
         LET l_xrca039 = l_xrca039 + l_tmp.xrca039
         
         IF p_sum_type = '1' THEN 
            IF p_type = '1' THEN 
               EXECUTE s_voucher_gen_ar_2_p10 USING p_glapdocno,l_tmp.docno
            END IF               
            
            IF p_type = '2' THEN 
               EXECUTE s_voucher_gen_ar_3_p4 USING p_glapdocno,l_tmp.docno 
            END IF

            IF SQLCA.sqlcode THEN  
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'execute s_voucher_gen_ar_2_cs10'
               LET g_errparam.popup = TRUE
               CALL cl_err()
            
               RETURN r_success
            END IF    
         END IF
         
         #匯總時沒有單號,所以要把group的字段拿來當條件回寫單號
         LET l_xrcadocno = ''
         IF p_sum_type = '2' THEN 
            FOREACH s_voucher_gen_ar_2_cs13 USING p_docdt,g_enterprise,
                                                  l_glaq.glaqcomp,l_glaq.glaqcomp,
                                                  l_glaq.glaq001,l_glaq.glaq001,
                                                  l_glaq.glaq002,l_glaq.glaq002,
                                                  l_glaq.glaq005,l_glaq.glaq005,
                                                  l_glaq.glaq006,l_glaq.glaq006,
                                                  l_glaq.glaq039,l_glaq.glaq039,
                                                  l_glaq.glaq042,l_glaq.glaq042,
                                                  l_tmp.glaq018,l_tmp.glaq018,
                                                  l_tmp.glaq019,l_tmp.glaq019,
                                                  l_tmp.glaq020,l_tmp.glaq020,
                                                  l_tmp.glaq021,l_tmp.glaq021,
                                                  l_tmp.glaq022,l_tmp.glaq022,
                                                  l_tmp.glaq023,l_tmp.glaq023,
                                                  l_tmp.glaq024,l_tmp.glaq024,
                                                  l_tmp.glaq025,l_tmp.glaq025,
                                                  l_tmp.glaq027,l_tmp.glaq027,
                                                  l_tmp.glaq028,l_tmp.glaq028,
                                                  l_tmp.glaq051,l_tmp.glaq051,
                                                  l_tmp.glaq052,l_tmp.glaq052,
                                                  l_tmp.glaq053,l_tmp.glaq053,
                                                  l_tmp.glaq029,l_tmp.glaq029,
                                                  l_tmp.glaq030,l_tmp.glaq030,
                                                  l_tmp.glaq031,l_tmp.glaq031,
                                                  l_tmp.glaq032,l_tmp.glaq032,
                                                  l_tmp.glaq033,l_tmp.glaq033,
                                                  l_tmp.glaq034,l_tmp.glaq034,
                                                  l_tmp.glaq035,l_tmp.glaq035,
                                                  l_tmp.glaq036,l_tmp.glaq036,
                                                  l_tmp.glaq037,l_tmp.glaq037,
                                                  l_tmp.glaq038,l_tmp.glaq038,
                                                  l_tmp.glbc004,l_tmp.glbc004,
                                                  l_glaq.glaq007,l_glaq.glaq007
                                            INTO l_xrcadocno
               IF p_type = '1' THEN 
                  EXECUTE s_voucher_gen_ar_2_p10 USING p_glapdocno,l_xrcadocno
               END IF
               
               IF p_type = '2' THEN 
                  EXECUTE s_voucher_gen_ar_3_p4 USING p_glapdocno,l_xrcadocno
               END IF
               
               IF SQLCA.sqlcode THEN  
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = 'execute s_voucher_gen_ar_2_cs10'
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  
                  RETURN r_success
               END IF          
            END FOREACH 
         END IF
         
         IF p_sum_type = '3' THEN 
            FOREACH s_voucher_gen_ar_2_cs13 USING g_enterprise,
                                                  l_glaq.glaqcomp,l_glaq.glaqcomp,
                                                  l_glaq.glaq001,l_glaq.glaq001,
                                                  l_glaq.glaq002,l_glaq.glaq002,
                                                  l_tmp.glaq021,l_tmp.glaq021,
                                                  l_tmp.glaq022,l_tmp.glaq022,
                                                  l_glaq.glaq005,l_glaq.glaq005,
                                                  l_glaq.glaq006,l_glaq.glaq006,
                                                  l_glaq.glaq039,l_glaq.glaq039,
                                                  l_glaq.glaq042,l_glaq.glaq042,
                                                  l_tmp.glaq018,l_tmp.glaq018,
                                                  l_tmp.glaq019,l_tmp.glaq019,
                                                  l_tmp.glaq020,l_tmp.glaq020,
                                                  l_tmp.glaq021,l_tmp.glaq021,
                                                  l_tmp.glaq022,l_tmp.glaq022,
                                                  l_tmp.glaq023,l_tmp.glaq023,
                                                  l_tmp.glaq024,l_tmp.glaq024,
                                                  l_tmp.glaq025,l_tmp.glaq025,
                                                  l_tmp.glaq027,l_tmp.glaq027,
                                                  l_tmp.glaq028,l_tmp.glaq028,
                                                  l_tmp.glaq051,l_tmp.glaq051,
                                                  l_tmp.glaq052,l_tmp.glaq052,
                                                  l_tmp.glaq053,l_tmp.glaq053,
                                                  l_tmp.glaq029,l_tmp.glaq029,
                                                  l_tmp.glaq030,l_tmp.glaq030,
                                                  l_tmp.glaq031,l_tmp.glaq031,
                                                  l_tmp.glaq032,l_tmp.glaq032,
                                                  l_tmp.glaq033,l_tmp.glaq033,
                                                  l_tmp.glaq034,l_tmp.glaq034,
                                                  l_tmp.glaq035,l_tmp.glaq035,
                                                  l_tmp.glaq036,l_tmp.glaq036,
                                                  l_tmp.glaq037,l_tmp.glaq037,
                                                  l_tmp.glaq038,l_tmp.glaq038,
                                                  l_tmp.glbc004,l_tmp.glbc004,
                                                  l_glaq.glaq007,l_glaq.glaq007,
                                                  l_tmp.b_glaq021,l_tmp.b_glaq021
                                            INTO l_xrcadocno
                                            
               IF p_type = '1' THEN 
                  EXECUTE s_voucher_gen_ar_2_p10 USING p_glapdocno,l_xrcadocno
               END IF
               
               IF p_type = '2' THEN 
                  EXECUTE s_voucher_gen_ar_3_p4 USING p_glapdocno,l_xrcadocno
               END IF
               
               IF SQLCA.sqlcode THEN  
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = 'execute s_voucher_gen_ar_2_cs10'
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  
                  RETURN r_success
               END IF  
            END FOREACH        
         END IF
         
         IF p_sum_type = '4' THEN 
            FOREACH s_voucher_gen_ar_2_cs13 USING p_docdt,g_enterprise,
                                                  l_glaq.glaqcomp,l_glaq.glaqcomp,
                                                  l_glaq.glaq001,l_glaq.glaq001,
                                                  l_glaq.glaq002,l_glaq.glaq002,
                                                  l_glaq.glaq005,l_glaq.glaq005,
                                                  l_glaq.glaq006,l_glaq.glaq006,
                                                  l_glaq.glaq039,l_glaq.glaq039,
                                                  l_glaq.glaq042,l_glaq.glaq042,
                                                  l_tmp.glaq018,l_tmp.glaq018,
                                                  l_tmp.glaq019,l_tmp.glaq019,
                                                  l_tmp.glaq020,l_tmp.glaq020,
                                                  l_tmp.glaq021,l_tmp.glaq021,
                                                  l_tmp.glaq022,l_tmp.glaq022,
                                                  l_tmp.glaq023,l_tmp.glaq023,
                                                  l_tmp.glaq024,l_tmp.glaq024,
                                                  l_tmp.glaq025,l_tmp.glaq025,
                                                  l_tmp.glaq027,l_tmp.glaq027,
                                                  l_tmp.glaq028,l_tmp.glaq028,
                                                  l_tmp.glaq051,l_tmp.glaq051,
                                                  l_tmp.glaq052,l_tmp.glaq052,
                                                  l_tmp.glaq053,l_tmp.glaq053,
                                                  l_tmp.glaq029,l_tmp.glaq029,
                                                  l_tmp.glaq030,l_tmp.glaq030,
                                                  l_tmp.glaq031,l_tmp.glaq031,
                                                  l_tmp.glaq032,l_tmp.glaq032,
                                                  l_tmp.glaq033,l_tmp.glaq033,
                                                  l_tmp.glaq034,l_tmp.glaq034,
                                                  l_tmp.glaq035,l_tmp.glaq035,
                                                  l_tmp.glaq036,l_tmp.glaq036,
                                                  l_tmp.glaq037,l_tmp.glaq037,
                                                  l_tmp.glaq038,l_tmp.glaq038,
                                                  l_tmp.glbc004,l_tmp.glbc004,
                                                  l_glaq.glaq007,l_glaq.glaq007,
                                                  l_tmp.b_glaq021,l_tmp.b_glaq021
                                            INTO l_xrcadocno
               IF p_type = '1' THEN 
                  EXECUTE s_voucher_gen_ar_2_p10 USING p_glapdocno,l_xrcadocno
               END IF
               
               IF p_type = '2' THEN 
                  EXECUTE s_voucher_gen_ar_3_p4 USING p_glapdocno,l_xrcadocno
               END IF
               
               IF SQLCA.sqlcode THEN  
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = 'execute s_voucher_gen_ar_2_cs10'
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  
                  RETURN r_success
               END IF          
            END FOREACH 
         END IF
         
         IF p_sum_type = '5' THEN 
            FOREACH s_voucher_gen_ar_2_cs13 USING g_enterprise,
                                                  l_glaq.glaqcomp,l_glaq.glaqcomp,
                                                  l_glaq.glaq001,l_glaq.glaq001,
                                                  l_glaq.glaq002,l_glaq.glaq002,
                                                  l_glaq.glaq005,l_glaq.glaq005,
                                                  l_glaq.glaq006,l_glaq.glaq006,
                                                  l_glaq.glaq039,l_glaq.glaq039,
                                                  l_glaq.glaq042,l_glaq.glaq042,
                                                  l_tmp.glaq018,l_tmp.glaq018,
                                                  l_tmp.glaq019,l_tmp.glaq019,
                                                  l_tmp.glaq020,l_tmp.glaq020,
                                                  l_tmp.glaq021,l_tmp.glaq021,
                                                  l_tmp.glaq022,l_tmp.glaq022,
                                                  l_tmp.glaq023,l_tmp.glaq023,
                                                  l_tmp.glaq024,l_tmp.glaq024,
                                                  l_tmp.glaq025,l_tmp.glaq025,
                                                  l_tmp.glaq027,l_tmp.glaq027,
                                                  l_tmp.glaq028,l_tmp.glaq028,
                                                  l_tmp.glaq051,l_tmp.glaq051,
                                                  l_tmp.glaq052,l_tmp.glaq052,
                                                  l_tmp.glaq053,l_tmp.glaq053,
                                                  l_tmp.glaq029,l_tmp.glaq029,
                                                  l_tmp.glaq030,l_tmp.glaq030,
                                                  l_tmp.glaq031,l_tmp.glaq031,
                                                  l_tmp.glaq032,l_tmp.glaq032,
                                                  l_tmp.glaq033,l_tmp.glaq033,
                                                  l_tmp.glaq034,l_tmp.glaq034,
                                                  l_tmp.glaq035,l_tmp.glaq035,
                                                  l_tmp.glaq036,l_tmp.glaq036,
                                                  l_tmp.glaq037,l_tmp.glaq037,
                                                  l_tmp.glaq038,l_tmp.glaq038,
                                                  l_tmp.glbc004,l_tmp.glbc004,
                                                  l_glaq.glaq007,l_glaq.glaq007
                                            INTO l_xrcadocno
                                            
               IF p_type = '1' THEN 
                  EXECUTE s_voucher_gen_ar_2_p10 USING p_glapdocno,l_xrcadocno
               END IF
               
               IF p_type = '2' THEN 
                  EXECUTE s_voucher_gen_ar_3_p4 USING p_glapdocno,l_xrcadocno
               END IF
                    
               IF SQLCA.sqlcode THEN  
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = 'execute s_voucher_gen_ar_2_cs10'
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  
                  RETURN r_success
               END IF  
            END FOREACH        
         END IF
      END IF
      
   END FOREACH
   
   #一笔凭证处理完毕后,对凭证单头进行更行
   #总借/贷
   SELECT SUM(glaq003),SUM(glaq004) INTO l_glap010,l_glap011
     FROM glaq_t
    WHERE glaqent   = g_enterprise
      AND glaqld    = p_glaqld
      AND glaqdocno = p_glapdocno
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'sel glaq'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   IF cl_null(l_glap010) THEN LET l_glap010 = 0 END IF
   IF cl_null(l_glap011) THEN LET l_glap011 = 0 END IF
   
   #附件张数
   UPDATE glap_t SET glap010 = l_glap010,glap011 = l_glap011,glap013 = l_xrca039,glap014 = l_foreign
    WHERE glapent   = g_enterprise
      AND glapld    = p_glaqld
      AND glapdocno = p_glapdocno
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'upd glap_t'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   LET r_success = TRUE
   RETURN r_success
# Descriptions...: 細項沖帳作廢更新
# Memo...........: 
################################################################################
# Descriptions...: 自动产生凭证-建立临时表
# Memo...........:
# Usage..........: CALL s_voucher_cre_ar_tmp_table()
END FUNCTION
################################################################################
# Descriptions...: 自动产生凭证-建立临时表
# Memo...........:
# Usage..........: CALL s_voucher_cre_ar_tmp_table()
#                  RETURNING r_success
# Input parameter: 
# Return code....: r_success      临时表建立成功否
# Date & Author..: 2014/03/02 By Carrier
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_cre_ar_tmp_table()
   DEFINE r_success       LIKE type_t.num5
   
   WHENEVER ERROR CONTINUE
   LET r_success = FALSE
   
   #检查事务中
   #IF NOT s_transaction_chk('N',1) THEN
   #   RETURN r_success
   #END IF 
   
   DROP TABLE s_vr_tmp04;  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
   CREATE TEMP TABLE s_vr_tmp04(  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
   docno       LIKE glaq_t.glaqdocno,
   docdt       LIKE glap_t.glapdocdt, 
   sw          LIKE type_t.chr1,   
   glaqent     LIKE glaq_t.glaqent,
   glaqcomp    LIKE glaq_t.glaqcomp,
   glaqld      LIKE glaq_t.glaqld,
   glaq001     LIKE glaq_t.glaq001,
   glaq002     LIKE glaq_t.glaq002,
   glaq005     LIKE glaq_t.glaq005,
   glaq006     LIKE glaq_t.glaq006,
   glaq007     LIKE glaq_t.glaq007,
   glaq009     LIKE glaq_t.glaq009,
   glaq011     LIKE glaq_t.glaq011,
   glaq012     LIKE glaq_t.glaq012,
   glaq013     LIKE glaq_t.glaq013,
   glaq014     LIKE glaq_t.glaq014,
   glaq015     LIKE glaq_t.glaq015,
   glaq016     LIKE glaq_t.glaq016,   
   glaq017     LIKE glaq_t.glaq017,
   glaq018     LIKE glaq_t.glaq018,
   glaq019     LIKE glaq_t.glaq019,
   glaq020     LIKE glaq_t.glaq020,
   glaq021     LIKE glaq_t.glaq021,
   glaq022     LIKE glaq_t.glaq022,
   glaq023     LIKE glaq_t.glaq023,
   glaq024     LIKE glaq_t.glaq024,
   glaq025     LIKE glaq_t.glaq025,
   glaq027     LIKE glaq_t.glaq027,
   glaq028     LIKE glaq_t.glaq028,
   glaq051     LIKE glaq_t.glaq051,  #經營方式
   glaq052     LIKE glaq_t.glaq052,  #渠道 
   glaq053     LIKE glaq_t.glaq053,  #品牌
   glaq029     LIKE glaq_t.glaq029,
   glaq030     LIKE glaq_t.glaq030,
   glaq031     LIKE glaq_t.glaq031,
   glaq032     LIKE glaq_t.glaq032,
   glaq033     LIKE glaq_t.glaq033,
   glaq034     LIKE glaq_t.glaq034,
   glaq035     LIKE glaq_t.glaq035,
   glaq036     LIKE glaq_t.glaq036,
   glaq037     LIKE glaq_t.glaq037,
   glaq038     LIKE glaq_t.glaq038,
   glbc004     LIKE glbc_t.glbc004,  #现金变动码  
   d           LIKE glaq_t.glaq003,
   c           LIKE glaq_t.glaq004,
   qty         LIKE glaq_t.glaq008,
   sum         LIKE glaq_t.glaq010,
   glaq039     LIKE glaq_t.glaq039,
   glaq040     LIKE glaq_t.glaq040,
   glaq041     LIKE glaq_t.glaq041,
   glaq042     LIKE glaq_t.glaq042,
   glaq043     LIKE glaq_t.glaq043,
   glaq044     LIKE glaq_t.glaq044,
   seq         LIKE glaq_t.glaqseq,
   source      LIKE type_t.chr100,
   glaqseq     LIKE glaq_t.glaqseq,
   xrca039     LIKE xrca_t.xrca039,
   b_glaq021   LIKE glaq_t.glaq021,
   b_glaq022   LIKE glaq_t.glaq022,
   red         LIKE type_t.chr1       #红冲否(待抵单使用) #20150612 add lujh   
   );
   
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'create'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   DROP TABLE s_vr_tmp05;  #160727-00019#36   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_ar_group ——> s_vr_tmp05
   CREATE TEMP TABLE s_vr_tmp05(  #160727-00019#36   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_ar_group ——> s_vr_tmp05
   docno       LIKE glaq_t.glaqdocno,
   docdt       LIKE glap_t.glapdocdt, 
   sw          LIKE type_t.chr1,   
   glaqent     LIKE glaq_t.glaqent,
   glaqcomp    LIKE glaq_t.glaqcomp,
   glaqld      LIKE glaq_t.glaqld,
   glaq001     LIKE glaq_t.glaq001,
   glaq002     LIKE glaq_t.glaq002,
   glaq005     LIKE glaq_t.glaq005,
   glaq006     LIKE glaq_t.glaq006,
   glaq007     LIKE glaq_t.glaq007,
   glaq009     LIKE glaq_t.glaq009,
   glaq011     LIKE glaq_t.glaq011,
   glaq012     LIKE glaq_t.glaq012,
   glaq013     LIKE glaq_t.glaq013,
   glaq014     LIKE glaq_t.glaq014,
   glaq015     LIKE glaq_t.glaq015,
   glaq016     LIKE glaq_t.glaq016,   
   glaq017     LIKE glaq_t.glaq017,
   glaq018     LIKE glaq_t.glaq018,
   glaq019     LIKE glaq_t.glaq019,
   glaq020     LIKE glaq_t.glaq020,
   glaq021     LIKE glaq_t.glaq021,
   glaq022     LIKE glaq_t.glaq022,
   glaq023     LIKE glaq_t.glaq023,
   glaq024     LIKE glaq_t.glaq024,
   glaq025     LIKE glaq_t.glaq025,
   glaq027     LIKE glaq_t.glaq027,
   glaq028     LIKE glaq_t.glaq028,
   glaq051     LIKE glaq_t.glaq051,  #經營方式
   glaq052     LIKE glaq_t.glaq052,  #渠道 
   glaq053     LIKE glaq_t.glaq053,  #品牌
   glaq029     LIKE glaq_t.glaq029,
   glaq030     LIKE glaq_t.glaq030,
   glaq031     LIKE glaq_t.glaq031,
   glaq032     LIKE glaq_t.glaq032,
   glaq033     LIKE glaq_t.glaq033,
   glaq034     LIKE glaq_t.glaq034,
   glaq035     LIKE glaq_t.glaq035,
   glaq036     LIKE glaq_t.glaq036,
   glaq037     LIKE glaq_t.glaq037,
   glaq038     LIKE glaq_t.glaq038,
   glbc004     LIKE glbc_t.glbc004,  #现金变动码
   d           LIKE glaq_t.glaq003,
   c           LIKE glaq_t.glaq004,
   qty         LIKE glaq_t.glaq008,
   sum         LIKE glaq_t.glaq010,
   glaq039     LIKE glaq_t.glaq039,
   glaq040     LIKE glaq_t.glaq040,
   glaq041     LIKE glaq_t.glaq041,
   glaq042     LIKE glaq_t.glaq042,
   glaq043     LIKE glaq_t.glaq043,
   glaq044     LIKE glaq_t.glaq044,
   seq         LIKE glaq_t.glaqseq,
   source      LIKE type_t.chr100,
   glaqseq     LIKE glaq_t.glaqseq,
   xrca039     LIKE xrca_t.xrca039,
   b_glaq021   LIKE glaq_t.glaq021,
   b_glaq022   LIKE glaq_t.glaq022,
   red         LIKE type_t.chr1       #红冲否(待抵单使用) #20150612 add lujh    
   );
   
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'create'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   #170509-00094#12 add s---
   DROP TABLE s_vr_tmp051;   
   CREATE TEMP TABLE s_vr_tmp051(   
   docno       LIKE glaq_t.glaqdocno,
   docdt       LIKE glap_t.glapdocdt, 
   sw          LIKE type_t.chr1,   
   glaqent     LIKE glaq_t.glaqent,
   glaqcomp    LIKE glaq_t.glaqcomp,
   glaqld      LIKE glaq_t.glaqld,
   glaq001     LIKE glaq_t.glaq001,
   glaq002     LIKE glaq_t.glaq002,
   glaq005     LIKE glaq_t.glaq005,
   glaq006     LIKE glaq_t.glaq006,
   glaq007     LIKE glaq_t.glaq007,
   glaq009     LIKE glaq_t.glaq009,
   glaq011     LIKE glaq_t.glaq011,
   glaq012     LIKE glaq_t.glaq012,
   glaq013     LIKE glaq_t.glaq013,
   glaq014     LIKE glaq_t.glaq014,
   glaq015     LIKE glaq_t.glaq015,
   glaq016     LIKE glaq_t.glaq016,   
   glaq017     LIKE glaq_t.glaq017,
   glaq018     LIKE glaq_t.glaq018,
   glaq019     LIKE glaq_t.glaq019,
   glaq020     LIKE glaq_t.glaq020,
   glaq021     LIKE glaq_t.glaq021,
   glaq022     LIKE glaq_t.glaq022,
   glaq023     LIKE glaq_t.glaq023,
   glaq024     LIKE glaq_t.glaq024,
   glaq025     LIKE glaq_t.glaq025,
   glaq027     LIKE glaq_t.glaq027,
   glaq028     LIKE glaq_t.glaq028,
   glaq051     LIKE glaq_t.glaq051,  #經營方式
   glaq052     LIKE glaq_t.glaq052,  #渠道 
   glaq053     LIKE glaq_t.glaq053,  #品牌
   glaq029     LIKE glaq_t.glaq029,
   glaq030     LIKE glaq_t.glaq030,
   glaq031     LIKE glaq_t.glaq031,
   glaq032     LIKE glaq_t.glaq032,
   glaq033     LIKE glaq_t.glaq033,
   glaq034     LIKE glaq_t.glaq034,
   glaq035     LIKE glaq_t.glaq035,
   glaq036     LIKE glaq_t.glaq036,
   glaq037     LIKE glaq_t.glaq037,
   glaq038     LIKE glaq_t.glaq038,
   glbc004     LIKE glbc_t.glbc004,  #现金变动码
   d           LIKE glaq_t.glaq003,
   c           LIKE glaq_t.glaq004,
   qty         LIKE glaq_t.glaq008,
   sum         LIKE glaq_t.glaq010,
   glaq039     LIKE glaq_t.glaq039,
   glaq040     LIKE glaq_t.glaq040,
   glaq041     LIKE glaq_t.glaq041,
   glaq042     LIKE glaq_t.glaq042,
   glaq043     LIKE glaq_t.glaq043,
   glaq044     LIKE glaq_t.glaq044,
   seq         LIKE glaq_t.glaqseq,
   source      LIKE type_t.chr100,
   glaqseq     LIKE glaq_t.glaqseq,
   xrca039     LIKE xrca_t.xrca039,
   b_glaq021   LIKE glaq_t.glaq021,
   b_glaq022   LIKE glaq_t.glaq022,
   red         LIKE type_t.chr1        
   );
   
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'create'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF   
   #170509-00094#12 add e---
   
   DROP TABLE s_voucher_glbc;
   CREATE TEMP TABLE s_voucher_glbc(
   glbcent    LIKE glbc_t.glbcent,
   glbcld     LIKE glbc_t.glbcld,
   glbccomp   LIKE glbc_t.glbccomp, 
   glbcdocno  LIKE glbc_t.glbcdocno,   
   glbcseq    LIKE glbc_t.glbcseq,
   glbc001    LIKE glbc_t.glbc001,
   glbc002    LIKE glbc_t.glbc002,
   glbc003    LIKE glbc_t.glbc003,
   glbc004    LIKE glbc_t.glbc004,
   glbc005    LIKE glbc_t.glbc005,
   glbc006    LIKE glbc_t.glbc006,
   glbc007    LIKE glbc_t.glbc007,
   glbc008    LIKE glbc_t.glbc008,
   glbc009    LIKE glbc_t.glbc009,
   glbc010    LIKE glbc_t.glbc010,
   glbc011    LIKE glbc_t.glbc011,
   glbc012    LIKE glbc_t.glbc012,   
   glbc013    LIKE glbc_t.glbc013,
   glbc014    LIKE glbc_t.glbc014,
   xrdadocno  LIKE xrda_t.xrdadocno
   );
   
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'create'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION
# Descriptions...: 应收立帐自动产生凭证
# Memo...........:
# Usage..........: CALL s_voucher_gen_ar_2(p_ld,p_sum_type,p_wc)
#                       RETURNING r_success,g_glaq
# Input parameter: p_ld           帐套
#                : p_sum_type     汇总方式 
#                : p_wc           QBE条件(帐款来源)
# Return code....: r_success      成功否标识位
#                : g_glaq         傳票底稿清單
# Date & Author..: 2014/03/02 By Carrier
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_2(p_ld,p_sum_type,p_wc)
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE p_sum_type      LIKE type_t.chr1
   DEFINE p_wc            LIKE type_t.chr1000
   DEFINE r_success       LIKE type_t.num5
   #161128-00061#7---add---begin-----------
   #DEFINE l_xrca          RECORD LIKE xrca_t.*
   DEFINE l_xrca RECORD  #應收憑單單頭
       xrcaent LIKE xrca_t.xrcaent, #企業編號
       xrcaownid LIKE xrca_t.xrcaownid, #資料所有者
       xrcaowndp LIKE xrca_t.xrcaowndp, #資料所屬部門
       xrcacrtid LIKE xrca_t.xrcacrtid, #資料建立者
       xrcacrtdp LIKE xrca_t.xrcacrtdp, #資料建立部門
       xrcacrtdt LIKE xrca_t.xrcacrtdt, #資料創建日
       xrcamodid LIKE xrca_t.xrcamodid, #資料修改者
       xrcamoddt LIKE xrca_t.xrcamoddt, #最近修改日
       xrcacnfid LIKE xrca_t.xrcacnfid, #資料確認者
       xrcacnfdt LIKE xrca_t.xrcacnfdt, #資料確認日
       xrcapstid LIKE xrca_t.xrcapstid, #資料過帳者
       xrcapstdt LIKE xrca_t.xrcapstdt, #資料過帳日
       xrcastus LIKE xrca_t.xrcastus, #狀態碼
       xrcacomp LIKE xrca_t.xrcacomp, #法人
       xrcald LIKE xrca_t.xrcald, #帳套
       xrcadocno LIKE xrca_t.xrcadocno, #應收帳款單號碼
       xrcadocdt LIKE xrca_t.xrcadocdt, #帳款日期
       xrca001 LIKE xrca_t.xrca001, #帳款單性質
       xrcasite LIKE xrca_t.xrcasite, #帳務中心
       xrca003 LIKE xrca_t.xrca003, #帳務人員
       xrca004 LIKE xrca_t.xrca004, #帳款客戶編號
       xrca005 LIKE xrca_t.xrca005, #收款客戶
       xrca006 LIKE xrca_t.xrca006, #客戶分類
       xrca007 LIKE xrca_t.xrca007, #帳款類別
       xrca008 LIKE xrca_t.xrca008, #收款條件編號
       xrca009 LIKE xrca_t.xrca009, #應收款日/應扣抵日
       xrca010 LIKE xrca_t.xrca010, #容許票據到期日
       xrca011 LIKE xrca_t.xrca011, #稅別
       xrca012 LIKE xrca_t.xrca012, #稅率
       xrca013 LIKE xrca_t.xrca013, #含稅否
       xrca014 LIKE xrca_t.xrca014, #人員編號
       xrca015 LIKE xrca_t.xrca015, #部門編號
       xrca016 LIKE xrca_t.xrca016, #來源作業類型
       xrca017 LIKE xrca_t.xrca017, #產生方式
       xrca018 LIKE xrca_t.xrca018, #來源參考單號
       xrca019 LIKE xrca_t.xrca019, #系統產生對應單號(待抵帳款-預收)
       xrca020 LIKE xrca_t.xrca020, #信用狀申請流程否
       xrca021 LIKE xrca_t.xrca021, #商業發票號碼(IV no.)
       xrca022 LIKE xrca_t.xrca022, #出口報單號碼
       xrca023 LIKE xrca_t.xrca023, #發票客戶編號
       xrca024 LIKE xrca_t.xrca024, #發票客戶統一編號
       xrca025 LIKE xrca_t.xrca025, #發票客戶全名
       xrca026 LIKE xrca_t.xrca026, #發票客戶地址
       xrca028 LIKE xrca_t.xrca028, #發票類型
       xrca029 LIKE xrca_t.xrca029, #發票匯率
       xrca030 LIKE xrca_t.xrca030, #發票應開未稅金額
       xrca031 LIKE xrca_t.xrca031, #發票應開稅額
       xrca032 LIKE xrca_t.xrca032, #發票應開含稅金額
       xrca033 LIKE xrca_t.xrca033, #專案編號
       xrca034 LIKE xrca_t.xrca034, #責任中心
       xrca035 LIKE xrca_t.xrca035, #應收(借方)科目編號
       xrca036 LIKE xrca_t.xrca036, #收入(貸方)科目編號
       xrca037 LIKE xrca_t.xrca037, #分錄傳票產生否
       xrca038 LIKE xrca_t.xrca038, #拋轉傳票號碼
       xrca039 LIKE xrca_t.xrca039, #會計檢核附件份數
       xrca040 LIKE xrca_t.xrca040, #留置否
       xrca041 LIKE xrca_t.xrca041, #留置理由碼
       xrca042 LIKE xrca_t.xrca042, #留置設定日期
       xrca043 LIKE xrca_t.xrca043, #留置解除日期
       xrca044 LIKE xrca_t.xrca044, #留置原幣金額
       xrca045 LIKE xrca_t.xrca045, #留置說明
       xrca046 LIKE xrca_t.xrca046, #關係人否
       xrca047 LIKE xrca_t.xrca047, #多角序號
       xrca048 LIKE xrca_t.xrca048, #集團代收/代付單號
       xrca049 LIKE xrca_t.xrca049, #來源營運中心編號
       xrca050 LIKE xrca_t.xrca050, #交易原始單據份數
       xrca051 LIKE xrca_t.xrca051, #作廢理由碼
       xrca052 LIKE xrca_t.xrca052, #列印次數
       xrca053 LIKE xrca_t.xrca053, #備註
       xrca054 LIKE xrca_t.xrca054, #多帳期設定
       xrca055 LIKE xrca_t.xrca055, #繳款優惠條件
       xrca056 LIKE xrca_t.xrca056, #會計檢核附件狀態
       xrca057 LIKE xrca_t.xrca057, #交易對象識別碼
       xrca058 LIKE xrca_t.xrca058, #銷售分類
       xrca059 LIKE xrca_t.xrca059, #預算編號
       xrca060 LIKE xrca_t.xrca060, #發票開立原則
       xrca061 LIKE xrca_t.xrca061, #預計開立發票日期
       xrca062 LIKE xrca_t.xrca062, #多角性質
       xrca063 LIKE xrca_t.xrca063, #整帳批序號
       xrca064 LIKE xrca_t.xrca064, #訂金序次
       xrca065 LIKE xrca_t.xrca065, #發票編號
       xrca066 LIKE xrca_t.xrca066, #發票號碼
       xrca100 LIKE xrca_t.xrca100, #交易原幣別
       xrca101 LIKE xrca_t.xrca101, #原幣匯率
       xrca103 LIKE xrca_t.xrca103, #原幣未稅金額
       xrca104 LIKE xrca_t.xrca104, #原幣稅額
       xrca106 LIKE xrca_t.xrca106, #原幣直接折抵合計金額
       xrca107 LIKE xrca_t.xrca107, #原幣直接沖帳(調整)合計金額
       xrca108 LIKE xrca_t.xrca108, #原幣應收金額
       xrca113 LIKE xrca_t.xrca113, #本幣未稅金額
       xrca114 LIKE xrca_t.xrca114, #本幣稅額
       xrca116 LIKE xrca_t.xrca116, #本幣直接沖帳(調整)合計金額
       xrca117 LIKE xrca_t.xrca117, #本幣直接沖帳(調整)合計金額
       xrca118 LIKE xrca_t.xrca118, #本幣應收金額
       xrca120 LIKE xrca_t.xrca120, #本位幣二幣別
       xrca121 LIKE xrca_t.xrca121, #本位幣二匯率
       xrca123 LIKE xrca_t.xrca123, #本位幣二未稅金額
       xrca124 LIKE xrca_t.xrca124, #本位幣二稅額
       xrca126 LIKE xrca_t.xrca126, #本位幣二直接折抵合計金額
       xrca127 LIKE xrca_t.xrca127, #本位幣二直接沖帳(調整)合計金額
       xrca128 LIKE xrca_t.xrca128, #本位幣二應收金額
       xrca130 LIKE xrca_t.xrca130, #本位幣三幣別
       xrca131 LIKE xrca_t.xrca131, #本位幣三匯率
       xrca133 LIKE xrca_t.xrca133, #本位幣三未稅金額
       xrca134 LIKE xrca_t.xrca134, #本位幣三稅額
       xrca136 LIKE xrca_t.xrca136, #本位幣三直接折抵合計金額
       xrca137 LIKE xrca_t.xrca137, #本位幣三直接沖帳(調整)合計金額
       xrca138 LIKE xrca_t.xrca138, #本位幣三應收金額
       xrcaud001 LIKE xrca_t.xrcaud001, #自定義欄位(文字)001
       xrcaud002 LIKE xrca_t.xrcaud002, #自定義欄位(文字)002
       xrcaud003 LIKE xrca_t.xrcaud003, #自定義欄位(文字)003
       xrcaud004 LIKE xrca_t.xrcaud004, #自定義欄位(文字)004
       xrcaud005 LIKE xrca_t.xrcaud005, #自定義欄位(文字)005
       xrcaud006 LIKE xrca_t.xrcaud006, #自定義欄位(文字)006
       xrcaud007 LIKE xrca_t.xrcaud007, #自定義欄位(文字)007
       xrcaud008 LIKE xrca_t.xrcaud008, #自定義欄位(文字)008
       xrcaud009 LIKE xrca_t.xrcaud009, #自定義欄位(文字)009
       xrcaud010 LIKE xrca_t.xrcaud010, #自定義欄位(文字)010
       xrcaud011 LIKE xrca_t.xrcaud011, #自定義欄位(數字)011
       xrcaud012 LIKE xrca_t.xrcaud012, #自定義欄位(數字)012
       xrcaud013 LIKE xrca_t.xrcaud013, #自定義欄位(數字)013
       xrcaud014 LIKE xrca_t.xrcaud014, #自定義欄位(數字)014
       xrcaud015 LIKE xrca_t.xrcaud015, #自定義欄位(數字)015
       xrcaud016 LIKE xrca_t.xrcaud016, #自定義欄位(數字)016
       xrcaud017 LIKE xrca_t.xrcaud017, #自定義欄位(數字)017
       xrcaud018 LIKE xrca_t.xrcaud018, #自定義欄位(數字)018
       xrcaud019 LIKE xrca_t.xrcaud019, #自定義欄位(數字)019
       xrcaud020 LIKE xrca_t.xrcaud020, #自定義欄位(數字)020
       xrcaud021 LIKE xrca_t.xrcaud021, #自定義欄位(日期時間)021
       xrcaud022 LIKE xrca_t.xrcaud022, #自定義欄位(日期時間)022
       xrcaud023 LIKE xrca_t.xrcaud023, #自定義欄位(日期時間)023
       xrcaud024 LIKE xrca_t.xrcaud024, #自定義欄位(日期時間)024
       xrcaud025 LIKE xrca_t.xrcaud025, #自定義欄位(日期時間)025
       xrcaud026 LIKE xrca_t.xrcaud026, #自定義欄位(日期時間)026
       xrcaud027 LIKE xrca_t.xrcaud027, #自定義欄位(日期時間)027
       xrcaud028 LIKE xrca_t.xrcaud028, #自定義欄位(日期時間)028
       xrcaud029 LIKE xrca_t.xrcaud029, #自定義欄位(日期時間)029
       xrcaud030 LIKE xrca_t.xrcaud030  #自定義欄位(日期時間)030
       END RECORD

   #161128-00061#7---add--end-------------
   DEFINE l_success       LIKE type_t.num5
   DEFINE l_ac            LIKE type_t.num5
   DEFINE l_ac1           LIKE type_t.num5
   DEFINE l_docno         LIKE glaq_t.glaqdocno
   DEFINE l_glaq002       LIKE glaq_t.glaq002
   DEFINE l_field         LIKE type_t.chr1000
   DEFINE l_field1        LIKE type_t.chr1000
   DEFINE l_field2        LIKE type_t.chr1000
   DEFINE l_field3        LIKE type_t.chr1000
   DEFINE l_field4        LIKE type_t.chr1000
   DEFINE l_group_field   LIKE type_t.chr1000
   DEFINE l_slip          LIKE type_t.chr20     #170111-00055#1 add lujh axrp133效能优化
   DEFINE l_glad_r        RECORD 
                          glad005   LIKE glad_t.glad005,  #数量/金额管理否
                          glad007   LIKE glad_t.glad007,  #部门管理否
                          glad008   LIKE glad_t.glad008,  #利润成本管理否
                          glad009   LIKE glad_t.glad009,  #区域管理否
                          glad010   LIKE glad_t.glad010,  #交易客商管理否
                          glad011   LIKE glad_t.glad011,  #客群管理否
                          glad012   LIKE glad_t.glad012,  #产品类别管理否
                          glad013   LIKE glad_t.glad013,  #人员管理否
#                          glad014   LIKE glad_t.glad014,  #预算管理否
                          glad015   LIKE glad_t.glad015,  #专案管理否
                          glad016   LIKE glad_t.glad016,  #WBS管理否
                          glad017   LIKE glad_t.glad017,  #自由核算项1管理否
                          glad018   LIKE glad_t.glad018,  #自由核算项2管理否
                          glad019   LIKE glad_t.glad019,  #自由核算项3管理否
                          glad020   LIKE glad_t.glad020,  #自由核算项4管理否
                          glad021   LIKE glad_t.glad021,  #自由核算项5管理否
                          glad022   LIKE glad_t.glad022,  #自由核算项6管理否
                          glad023   LIKE glad_t.glad023,  #自由核算项7管理否
                          glad024   LIKE glad_t.glad024,  #自由核算项8管理否
                          glad025   LIKE glad_t.glad025,  #自由核算项9管理否
                          glad026   LIKE glad_t.glad026,  #自由核算项10管理否   
                          glad027   LIKE glad_t.glad027,  #账款客商管理否   
                          glad031   LIKE glad_t.glad031,  #經營方式管理否
                          glad032   LIKE glad_t.glad032,  #渠道管理否
                          glad033   LIKE glad_t.glad033   #品牌管理否                         
                          END RECORD
   
   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE

   #IF p_sum_type NOT MATCHES '[1234]' THEN
   #   #产生凭证的汇总方式仅可为1或2或3或4
   #   INITIALIZE g_errparam TO NULL
   #   LET g_errparam.code = 'agl-00124'
   #   LET g_errparam.extend = ''
   #   LET g_errparam.popup = TRUE
   #   CALL cl_err()
   #
   #   RETURN r_success
   #END IF
   
   DELETE FROM s_vr_tmp04;     #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
   DELETE FROM s_vr_tmp05;    #160727-00019#36   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_ar_group ——> s_vr_tmp05
   DELETE FROM s_voucher_glbc;

   #1.定义CURSOR
   CALL s_voucher_gen_ar_2_def_cursor(p_ld,p_wc,p_sum_type,'') RETURNING l_success
   IF NOT l_success THEN
      RETURN r_success
   END IF
 
   #2.插入临时表
   FOREACH s_voucher_gen_ar_2_cs1 INTO l_xrca.*
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach s_voucher_gen_ar_1_cs1'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF
      
      #170111-00055#1 add lujh axrp133效能优化
      #获取单别
      CALL s_aooi200_fin_get_slip(l_xrca.xrcadocno) RETURNING l_success,l_slip
      #红冲否    
      CALL s_fin_get_doc_para(l_xrca.xrcald,'',l_slip,'D-FIN-1002') RETURNING g_ooac004
      #170111-00055#1 add lujh axrp133效能优化
      
      #借 应收帐款科目 xrca035
      CALL s_voucher_gen_ar_2_ins_tmp('1',l_xrca.xrcald,l_xrca.xrcadocno,l_xrca.xrcacomp,l_xrca.xrca001)
           RETURNING l_success
      IF NOT l_success THEN
         RETURN r_success    
      END IF
           
      #贷 收入科目
      CALL s_voucher_gen_ar_2_ins_tmp('2',l_xrca.xrcald,l_xrca.xrcadocno,l_xrca.xrcacomp,l_xrca.xrca001)
           RETURNING l_success
      IF NOT l_success THEN
         RETURN r_success  
      END IF
      
      #贷 销项税科目
      CALL s_voucher_gen_ar_2_ins_tmp('3',l_xrca.xrcald,l_xrca.xrcadocno,l_xrca.xrcacomp,l_xrca.xrca001)
           RETURNING l_success 
      IF NOT l_success THEN
         RETURN r_success      
      END IF
      
      #直接沖帳  xrce
      CALL s_voucher_gen_ar_2_ins_tmp('4',l_xrca.xrcald,l_xrca.xrcadocno,l_xrca.xrcacomp,l_xrca.xrca001)
           RETURNING l_success 
      IF NOT l_success THEN
         RETURN r_success   
      END IF

      #直接沖帳  xrde
      CALL s_voucher_gen_ar_2_ins_tmp('6',l_xrca.xrcald,l_xrca.xrcadocno,l_xrca.xrcacomp,l_xrca.xrca001)
           RETURNING l_success 
      IF NOT l_success THEN
         RETURN r_success   
      END IF

      #161212-00024#1 Add  ---(S)---
      #暂估冲销
      CALL s_voucher_gen_ar_2_ins_tmp('9',l_xrca.xrcald,l_xrca.xrcadocno,l_xrca.xrcacomp,l_xrca.xrca001)
           RETURNING l_success 
      IF NOT l_success THEN
         RETURN r_success   
      END IF
      #161212-00024#1 Add  ---(E)---

      #差异
      CALL s_voucher_gen_ar_2_ins_tmp('5',l_xrca.xrcald,l_xrca.xrcadocno,l_xrca.xrcacomp,l_xrca.xrca001)
           RETURNING l_success 
      IF NOT l_success THEN
         RETURN r_success   
      END IF
      #add by liyan --str--
#      IF g_prog='axrt211' THEN 
      IF g_prog MATCHES 'axrt211*' THEN    
         CALL s_voucher_gen_ar_2_ins_tmp('7',l_xrca.xrcald,l_xrca.xrcadocno,l_xrca.xrcacomp,l_xrca.xrca001)
              RETURNING l_success 
         IF NOT l_success THEN
            RETURN r_success   
         END IF
         
         #160509-00004#73--add--str--lujh
         CALL s_voucher_gen_ar_2_ins_tmp('8',l_xrca.xrcald,l_xrca.xrcadocno,l_xrca.xrcacomp,l_xrca.xrca001)
              RETURNING l_success 
         IF NOT l_success THEN
            RETURN r_success   
         END IF
         #160509-00004#73--add--end--lujh
      END IF 
      #add by liyan --end--
   END FOREACH
   
   #3.按科目设置进行UPDATE,若有做不管理的字段,UPDATE至' '
   CALL s_voucher_gen_ar_2_upd_tmp(p_ld) 
        RETURNING l_success
   IF NOT l_success THEN
      RETURN r_success    
   END IF
   
   
   
   #5.插入凭证单头
   #CALL s_voucher_gen_ar_1_ins_glap(p_slip,p_sum_type)
   #     RETURNING r_success,r_start_no,r_end_no
   #IF NOT l_success THEN
   #   RETURN r_success,r_start_no,r_end_no       
   #END IF   
   #
   LET r_success = TRUE
   
   
   RETURN r_success

END FUNCTION
# Descriptions...: 自动产生凭证 - BY 科目的管理设置做UPDATE
# Memo...........:
# Usage..........: CALL s_voucher_gen_ar_1_upd_tmp()
#                  RETURNING r_success
# Input parameter: p_ld           帐套
# Return code....: r_success      成功否标识位
# Date & Author..: 2014/03/02 By Carrier
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_2_upd_tmp(p_ld)
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE r_success       LIKE type_t.num5
   DEFINE l_ld            LIKE glaa_t.glaald
   DEFINE l_glaq002       LIKE glaq_t.glaq002
   DEFINE l_docno         LIKE glaq_t.glaqdocno
   DEFINE l_upd_field     STRING
   DEFINE l_sql           STRING
   DEFINE l_glaa004       LIKE glaa_t.glaa004   
   DEFINE l_glaa005       LIKE glaa_t.glaa005
   DEFINE l_glac016       LIKE glac_t.glac016
   #170111-00055#1 add lujh axrp133效能优化 
   DEFINE l_glaq020        LIKE glaq_t.glaq020
   DEFINE l_glaq021        LIKE glaq_t.glaq021
   DEFINE l_glaq022        LIKE glaq_t.glaq022
   DEFINE l_glaq023        LIKE glaq_t.glaq023
   DEFINE l_glaq024        LIKE glaq_t.glaq024
   DEFINE l_glaq051        LIKE glaq_t.glaq051
   DEFINE l_glaq052        LIKE glaq_t.glaq052
   DEFINE l_glaq053        LIKE glaq_t.glaq053
   DEFINE l_glaq027        LIKE glaq_t.glaq027
   DEFINE l_glaq028        LIKE glaq_t.glaq028
   DEFINE l_glaq029        LIKE glaq_t.glaq029
   DEFINE l_glaq030        LIKE glaq_t.glaq030
   DEFINE l_glaq031        LIKE glaq_t.glaq031
   DEFINE l_glaq032        LIKE glaq_t.glaq032
   DEFINE l_glaq033        LIKE glaq_t.glaq033
   DEFINE l_glaq034        LIKE glaq_t.glaq034
   DEFINE l_glaq035        LIKE glaq_t.glaq035
   DEFINE l_glaq036        LIKE glaq_t.glaq036
   DEFINE l_glaq037        LIKE glaq_t.glaq037
   DEFINE l_glaq038        LIKE glaq_t.glaq038
   #170111-00055#1 add lujh axrp133效能优化 
   DEFINE l_glad_r        RECORD 
                          glad005   LIKE glad_t.glad005,  #数量/金额管理否
                          glad007   LIKE glad_t.glad007,  #部门管理否
                          glad008   LIKE glad_t.glad008,  #利润成本管理否
                          glad009   LIKE glad_t.glad009,  #区域管理否
                          glad010   LIKE glad_t.glad010,  #产品类别管理否
                          glad011   LIKE glad_t.glad011,  #客群管理否
                          glad012   LIKE glad_t.glad012,  #产品类别管理否
                          glad013   LIKE glad_t.glad013,  #人员管理否
#                          glad014   LIKE glad_t.glad014,  #预算管理否
                          glad015   LIKE glad_t.glad015,  #专案管理否
                          glad016   LIKE glad_t.glad016,  #WBS管理否
                          glad017   LIKE glad_t.glad017,  #自由核算项1管理否
                          glad018   LIKE glad_t.glad018,  #自由核算项2管理否
                          glad019   LIKE glad_t.glad019,  #自由核算项3管理否
                          glad020   LIKE glad_t.glad020,  #自由核算项4管理否
                          glad021   LIKE glad_t.glad021,  #自由核算项5管理否
                          glad022   LIKE glad_t.glad022,  #自由核算项6管理否
                          glad023   LIKE glad_t.glad023,  #自由核算项7管理否
                          glad024   LIKE glad_t.glad024,  #自由核算项8管理否
                          glad025   LIKE glad_t.glad025,  #自由核算项9管理否
                          glad026   LIKE glad_t.glad026,  #自由核算项10管理否  
                          glad027   LIKE glad_t.glad027,  #账款客商管理否   
                          glad031   LIKE glad_t.glad031,  #經營方式管理否
                          glad032   LIKE glad_t.glad032,  #渠道管理否
                          glad033   LIKE glad_t.glad033   #品牌管理否                          
                          END RECORD
   WHENEVER ERROR CONTINUE
   LET r_success = FALSE   
   
   #170111-00055#1 mark lujh axrp133效能优化
   #SELECT glaa004,glaa005 INTO l_glaa004,l_glaa005 
   #  FROM glaa_t
   # WHERE glaaent = g_enterprise
   #   AND glaald = p_ld
   #170111-00055#1 mark lujh axrp133效能优化
   
   LET l_glac016 = ''
   
   #170111-00055#1 add lujh axrp133效能优化 
   #数量/金额不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad005 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad005 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq007 = ' ',",
               "               qty = 0, ",
               "               glaq009 = 0 "
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq007 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq007
   
   #部门不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad007 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad007 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq018 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq018 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq018
   
   #利润成本不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad008 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad008 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq019 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq019 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq019
   
   #区域不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad009 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad009 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq020 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq020 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq020
   
   #客群不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad011 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad011 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq023 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq023 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq023
   
   #产品类别不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad012 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad012 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq024 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq024 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq024
   
   #人员不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad013 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad013 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq025 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq025 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq025
   
   #专案不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad015 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad015 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq027 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq027 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq027
   
   #WBS不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad016 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad016 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq028 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq028 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq028
   
   #經營方式不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad031 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad031 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq051 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq051 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq051
   
   #渠道不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad032 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad032 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq052 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq052 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq052
   
   #品牌不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad033 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad033 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq053 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq053 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq053
   
   #自由核算项1不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad017 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad017 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq029 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq029 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq029
   
   #自由核算项2不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad018 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad018 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq030 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq030 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq030
   
   #自由核算项3不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad019 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad019 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq031 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq031 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq031
  
   #自由核算项4不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad020 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad020 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq032 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq032 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq032
   
   #自由核算项5不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad021 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad021 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq033 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq033 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq033
   
   #自由核算项6不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad022 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad022 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq034 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq034 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq034
   
   #自由核算项7不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad023 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad023 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq035 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq035 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq035
   
   #自由核算项8不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad024 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad024 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq036 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq036 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq036
   
   #自由核算项9不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad025 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad025 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq037 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq037 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq037
   
   #自由核算项10不管理
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glad001,glad026 FROM glad_t",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld  = '",p_ld,"' )",
               "    ON ( glad001 = glaq002 AND glaq002 IS NOT NULL AND glad026 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glaq038 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glaq038 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glaq038
   
   #现金变动码不启用
   LET g_sql = " MERGE INTO s_vr_tmp04",
               " USING (SELECT glac002,glac016 FROM glac_t",
               " WHERE glacent = ",g_enterprise,
               "   AND glac001  = (SELECT glaa004 FROM glaa_t WHERE glaaent = ",g_enterprise," AND glaald = '",p_ld,"' ) )",
               "    ON ( glac002 = glaq002 AND glaq002 IS NOT NULL AND glac016 = 'N'  ) ",
               "    WHEN MATCHED THEN                            ",
               "    UPDATE SET glbc004 = ' '"
   PREPARE s_voucher_gen_ar_2_upd_tmp_glbc004 FROM g_sql
   EXECUTE s_voucher_gen_ar_2_upd_tmp_glbc004
   #170111-00055#1 add lujh axrp133效能优化 
   
   FOREACH s_voucher_gen_ar_2_cs5 INTO l_glaq002,l_glac016   #170111-00055#1 add l_glac016 axrp133效能优化
       IF SQLCA.sqlcode THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code = SQLCA.sqlcode
          LET g_errparam.extend = 'foreach s_voucher_gen_ar_1_cs5'
          LET g_errparam.popup = TRUE
          CALL cl_err()

          RETURN r_success
       END IF  
       
       #170111-00055#1 mark lujh axrp133效能优化 
       #EXECUTE s_voucher_gen_ar_2_cs6 USING l_glaq002 INTO l_glad_r.*
       #
       #CALL s_voucher_glac016_get(l_glaa004,l_glaq002) RETURNING l_glac016
       #
       #LET l_upd_field = NULL
       #IF l_glad_r.glad005 = 'N' OR cl_null(l_glad_r.glad005) THEN  #数量/金额不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq007 = ' ',qty = 0,glaq009 = 0"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq007 = ' ',glaq008 = 0,glaq009 = 0"
       #   END IF
       #END IF
       #IF l_glad_r.glad007 = 'N' OR cl_null(l_glad_r.glad007) THEN  #部门不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq018 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq018 = ' '"
       #   END IF
       #END IF
       #IF l_glad_r.glad008 = 'N' OR cl_null(l_glad_r.glad008) THEN  #利润成本不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq019 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq019 = ' '"
       #   END IF       
       #END IF       
       #
       #IF l_glad_r.glad009 = 'N' OR cl_null(l_glad_r.glad009) THEN  #区域不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq020 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq020 = ' '"
       #   END IF       
       #END IF 
       ##IF l_glad_r.glad010 = 'N' THEN  #交易客商不管理
       ##   IF cl_null(l_upd_field) THEN
       ##      LET l_upd_field = "glaq021 = ' '"
       ##   ELSE
       ##      LET l_upd_field = l_upd_field CLIPPED,",glaq021 = ' '"
       ##   END IF       
       ##END IF 
       ##IF l_glad_r.glad027 = 'N' THEN  #账款客商不管理
       ##   IF cl_null(l_upd_field) THEN
       ##      LET l_upd_field = "glaq022 = ' '"
       ##   ELSE
       ##      LET l_upd_field = l_upd_field CLIPPED,",glaq022 = ' '"
       ##   END IF       
       ##END IF 
       #IF l_glad_r.glad011 = 'N' THEN  #客群不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq023 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq023 = ' '"
       #   END IF       
       #END IF 
       #IF l_glad_r.glad012 = 'N' OR cl_null(l_glad_r.glad012) THEN  #产品类别不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq024 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq024 = ' '"
       #   END IF       
       #END IF 
       #IF l_glad_r.glad013 = 'N' OR cl_null(l_glad_r.glad013) THEN  #人员不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq025 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq025 = ' '"
       #   END IF       
       #END IF        
#      # IF l_glad_r.glad014 = 'N' OR cl_null(l_glad_r.glad014) THEN  #预算不管理
#      #    IF cl_null(l_upd_field) THEN
#      #       LET l_upd_field = "glaq026 = ' '"
#      #    ELSE
#      #       LET l_upd_field = l_upd_field CLIPPED,",glaq026 = ' '"
#      #    END IF       
#      # END IF        
       #IF l_glad_r.glad015 = 'N' OR cl_null(l_glad_r.glad015) THEN  #专案不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq027 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq027 = ' '"
       #   END IF       
       #END IF        
       #IF l_glad_r.glad016 = 'N' OR cl_null(l_glad_r.glad016) THEN  #WBS不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq028 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq028 = ' '"
       #   END IF       
       #END IF  
       #IF l_glad_r.glad031 = 'N' OR cl_null(l_glad_r.glad031) THEN  #經營方式不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq051 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq051 = ' '"
       #   END IF       
       #END IF 
       #IF l_glad_r.glad032 = 'N' OR cl_null(l_glad_r.glad032) THEN  #渠道不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq052 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq052 = ' '"
       #   END IF       
       #END IF
       #IF l_glad_r.glad033 = 'N' OR cl_null(l_glad_r.glad033) THEN  #品牌不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq053 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq053 = ' '"
       #   END IF       
       #END IF
       #
       #IF l_glad_r.glad017 = 'N' OR cl_null(l_glad_r.glad017) THEN  #自由核算项1不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq029 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq029 = ' '"
       #   END IF       
       #END IF        
       #IF l_glad_r.glad018 = 'N' OR cl_null(l_glad_r.glad018) THEN  #自由核算项2不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq030 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq030 = ' '"
       #   END IF       
       #END IF        
       #IF l_glad_r.glad019 = 'N' OR cl_null(l_glad_r.glad019) THEN  #自由核算项3不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq031 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq031 = ' '"
       #   END IF       
       #END IF 
       #IF l_glad_r.glad020 = 'N' OR cl_null(l_glad_r.glad020) THEN  #自由核算项4不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq032 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq032 = ' '"
       #   END IF       
       #END IF 
       #IF l_glad_r.glad021 = 'N' OR cl_null(l_glad_r.glad021) THEN  #自由核算项5不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq033 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq033 = ' '"
       #   END IF       
       #END IF 
       #IF l_glad_r.glad022 = 'N' OR cl_null(l_glad_r.glad022) THEN  #自由核算项6不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq034 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq034 = ' '"
       #   END IF       
       #END IF 
       #IF l_glad_r.glad023 = 'N' OR cl_null(l_glad_r.glad023) THEN  #自由核算项7不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq035 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq035 = ' '"
       #   END IF       
       #END IF 
       #IF l_glad_r.glad024 = 'N' OR cl_null(l_glad_r.glad024) THEN  #自由核算项8不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq036 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq036 = ' '"
       #   END IF       
       #END IF 
       #IF l_glad_r.glad025 = 'N' OR cl_null(l_glad_r.glad025) THEN  #自由核算项9不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq037 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq037 = ' '"
       #   END IF       
       #END IF        
       #IF l_glad_r.glad026 = 'N' OR cl_null(l_glad_r.glad026) THEN  #自由核算项10不管理
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glaq038 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glaq038 = ' '"
       #   END IF       
       #END IF   
       #
       #IF l_glac016 = 'N' OR cl_null(l_glac016) THEN   #现金变动码不启用
       #   IF cl_null(l_upd_field) THEN
       #      LET l_upd_field = "glbc004 = ' '"
       #   ELSE
       #      LET l_upd_field = l_upd_field CLIPPED,",glbc004 = ' '"
       #   END IF  
       #END IF
       #
       #IF NOT cl_null(l_upd_field) THEN
       #   LET l_sql = "UPDATE s_vr_tmp04 SET ",l_upd_field,  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
       #               " WHERE glaqld  = '",p_ld CLIPPED,"'",
       #               "   AND glaq002 = '",l_glaq002,"'"
       #   PREPARE s_voucher_gen_ar_2_upd_tmp_p1 FROM l_sql
       #   IF SQLCA.sqlcode THEN
       #      INITIALIZE g_errparam TO NULL
       #      LET g_errparam.code = SQLCA.sqlcode
       #      LET g_errparam.extend = 's_voucher_gen_ar_2_upd_tmp_p1'
       #      LET g_errparam.popup = TRUE
       #      CALL cl_err()
       #
       #      RETURN r_success
       #   END IF
       #   EXECUTE s_voucher_gen_ar_2_upd_tmp_p1
       #   IF SQLCA.sqlcode THEN
       #      INITIALIZE g_errparam TO NULL
       #      LET g_errparam.code = SQLCA.sqlcode
       #      LET g_errparam.extend = 'execute s_voucher_gen_ar_2_upd_tmp_p1'
       #      LET g_errparam.popup = TRUE
       #      CALL cl_err()
       #
       #      RETURN r_success
       #   END IF
       #END IF
       
       #170111-00055#1 add lujh axrp133效能优化
       CALL s_voucher_get_glas003(p_ld,l_glaq002) 
       RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                 l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                 l_glaq035,l_glaq036,l_glaq037,l_glaq038
       #170310-00016#1--mark--s--xul          
#       LET l_sql = "UPDATE s_vr_tmp04 SET glaq020 = '",l_glaq020,"'",
#                   "                     ,glaq021 = '",l_glaq021,"'",
#                   "                     ,glaq022 = '",l_glaq022,"'",
#                   "                     ,glaq023 = '",l_glaq023,"'",
#                   "                     ,glaq024 = '",l_glaq024,"'",
#                   "                     ,glaq051 = '",l_glaq051,"'",
#                   "                     ,glaq052 = '",l_glaq052,"'",
#                   "                     ,glaq053 = '",l_glaq053,"'",
#                   "                     ,glaq027 = '",l_glaq027,"'",
#                   "                     ,glaq028 = '",l_glaq028,"'",
#                   "                     ,glaq029 = '",l_glaq029,"'",
#                   "                     ,glaq030 = '",l_glaq030,"'",
#                   "                     ,glaq031 = '",l_glaq031,"'",
#                   "                     ,glaq032 = '",l_glaq032,"'",
#                   "                     ,glaq033 = '",l_glaq033,"'",
#                   "                     ,glaq034 = '",l_glaq034,"'",
#                   "                     ,glaq035 = '",l_glaq035,"'",
#                   "                     ,glaq036 = '",l_glaq036,"'",
#                   "                     ,glaq037 = '",l_glaq037,"'",
#                   "                     ,glaq038 = '",l_glaq038,"'",
#                   " WHERE glaqld  = '",p_ld CLIPPED,"'",
#                   "   AND glaq002 = '",l_glaq002,"'"
       #170310-00016#1--mark--e--xul    
       #170310-00016#1--add--s--xul
       LET l_sql = "UPDATE s_vr_tmp04 SET glaq020 = CASE WHEN glaq020 IS NOT NULL THEN glaq020 ELSE '",l_glaq020,"' END",
                   "                     ,glaq021 = CASE WHEN glaq021 IS NOT NULL THEN glaq021 ELSE '",l_glaq021,"' END",
                   "                     ,glaq022 = CASE WHEN glaq022 IS NOT NULL THEN glaq022 ELSE '",l_glaq022,"' END",
                   "                     ,glaq023 = CASE WHEN glaq023 IS NOT NULL THEN glaq023 ELSE '",l_glaq023,"' END",
                   "                     ,glaq024 = CASE WHEN glaq024 IS NOT NULL THEN glaq024 ELSE '",l_glaq024,"' END",
                   "                     ,glaq051 = CASE WHEN glaq051 IS NOT NULL THEN glaq051 ELSE '",l_glaq051,"' END",
                   "                     ,glaq052 = CASE WHEN glaq052 IS NOT NULL THEN glaq052 ELSE '",l_glaq052,"' END",
                   "                     ,glaq053 = CASE WHEN glaq053 IS NOT NULL THEN glaq053 ELSE '",l_glaq053,"' END",
                   "                     ,glaq027 = CASE WHEN glaq027 IS NOT NULL THEN glaq027 ELSE '",l_glaq027,"' END",
                   "                     ,glaq028 = CASE WHEN glaq028 IS NOT NULL THEN glaq028 ELSE '",l_glaq028,"' END",
                   "                     ,glaq029 = CASE WHEN glaq029 IS NOT NULL THEN glaq029 ELSE '",l_glaq029,"' END",
                   "                     ,glaq030 = CASE WHEN glaq030 IS NOT NULL THEN glaq030 ELSE '",l_glaq030,"' END",
                   "                     ,glaq031 = CASE WHEN glaq031 IS NOT NULL THEN glaq031 ELSE '",l_glaq031,"' END",
                   "                     ,glaq032 = CASE WHEN glaq032 IS NOT NULL THEN glaq032 ELSE '",l_glaq032,"' END",
                   "                     ,glaq033 = CASE WHEN glaq033 IS NOT NULL THEN glaq033 ELSE '",l_glaq033,"' END",
                   "                     ,glaq034 = CASE WHEN glaq034 IS NOT NULL THEN glaq034 ELSE '",l_glaq034,"' END",
                   "                     ,glaq035 = CASE WHEN glaq035 IS NOT NULL THEN glaq035 ELSE '",l_glaq035,"' END",
                   "                     ,glaq036 = CASE WHEN glaq036 IS NOT NULL THEN glaq036 ELSE '",l_glaq036,"' END",
                   "                     ,glaq037 = CASE WHEN glaq037 IS NOT NULL THEN glaq037 ELSE '",l_glaq037,"' END",
                   "                     ,glaq038 = CASE WHEN glaq038 IS NOT NULL THEN glaq038 ELSE '",l_glaq038,"' END",
                   " WHERE glaqld  = '",p_ld CLIPPED,"'",
                   "   AND glaq002 = '",l_glaq002,"'"
       #170310-00016#1--add--e--xul
       PREPARE s_voucher_gen_ar_2_upd_tmp_p1 FROM l_sql
       IF SQLCA.sqlcode THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code = SQLCA.sqlcode
          LET g_errparam.extend = 's_voucher_gen_ar_2_upd_tmp_p1'
          LET g_errparam.popup = TRUE
          CALL cl_err()
        
          RETURN r_success
       END IF
       EXECUTE s_voucher_gen_ar_2_upd_tmp_p1
       IF SQLCA.sqlcode THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code = SQLCA.sqlcode
          LET g_errparam.extend = 'execute s_voucher_gen_ar_2_upd_tmp_p1'
          LET g_errparam.popup = TRUE
          CALL cl_err()
        
          RETURN r_success
       END IF
       #170111-00055#1 add lujh axrp133效能优化

   END FOREACH
   
   LET r_success = TRUE
   RETURN r_success    
################################################################################
END FUNCTION
#                  RETURNING r_success
# Input parameter: p_ld           帐套
#                : p_sum_type     汇总方式 
# Return code....: r_success      成功否标识位
# Date & Author..: 2014/03/02 By Carrier
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_2_ins_group_tmp(p_type,p_ld,p_sum_type)
   DEFINE p_type          LIKE type_t.chr2
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE p_sum_type      LIKE type_t.chr1
   DEFINE p_wc            LIKE type_t.chr1000
   DEFINE r_success       LIKE type_t.num5
   #161128-00061#7---add---begin-----------
   #DEFINE l_xrca          RECORD LIKE xrca_t.*
   DEFINE l_xrca RECORD  #應收憑單單頭
       xrcaent LIKE xrca_t.xrcaent, #企業編號
       xrcaownid LIKE xrca_t.xrcaownid, #資料所有者
       xrcaowndp LIKE xrca_t.xrcaowndp, #資料所屬部門
       xrcacrtid LIKE xrca_t.xrcacrtid, #資料建立者
       xrcacrtdp LIKE xrca_t.xrcacrtdp, #資料建立部門
       xrcacrtdt LIKE xrca_t.xrcacrtdt, #資料創建日
       xrcamodid LIKE xrca_t.xrcamodid, #資料修改者
       xrcamoddt LIKE xrca_t.xrcamoddt, #最近修改日
       xrcacnfid LIKE xrca_t.xrcacnfid, #資料確認者
       xrcacnfdt LIKE xrca_t.xrcacnfdt, #資料確認日
       xrcapstid LIKE xrca_t.xrcapstid, #資料過帳者
       xrcapstdt LIKE xrca_t.xrcapstdt, #資料過帳日
       xrcastus LIKE xrca_t.xrcastus, #狀態碼
       xrcacomp LIKE xrca_t.xrcacomp, #法人
       xrcald LIKE xrca_t.xrcald, #帳套
       xrcadocno LIKE xrca_t.xrcadocno, #應收帳款單號碼
       xrcadocdt LIKE xrca_t.xrcadocdt, #帳款日期
       xrca001 LIKE xrca_t.xrca001, #帳款單性質
       xrcasite LIKE xrca_t.xrcasite, #帳務中心
       xrca003 LIKE xrca_t.xrca003, #帳務人員
       xrca004 LIKE xrca_t.xrca004, #帳款客戶編號
       xrca005 LIKE xrca_t.xrca005, #收款客戶
       xrca006 LIKE xrca_t.xrca006, #客戶分類
       xrca007 LIKE xrca_t.xrca007, #帳款類別
       xrca008 LIKE xrca_t.xrca008, #收款條件編號
       xrca009 LIKE xrca_t.xrca009, #應收款日/應扣抵日
       xrca010 LIKE xrca_t.xrca010, #容許票據到期日
       xrca011 LIKE xrca_t.xrca011, #稅別
       xrca012 LIKE xrca_t.xrca012, #稅率
       xrca013 LIKE xrca_t.xrca013, #含稅否
       xrca014 LIKE xrca_t.xrca014, #人員編號
       xrca015 LIKE xrca_t.xrca015, #部門編號
       xrca016 LIKE xrca_t.xrca016, #來源作業類型
       xrca017 LIKE xrca_t.xrca017, #產生方式
       xrca018 LIKE xrca_t.xrca018, #來源參考單號
       xrca019 LIKE xrca_t.xrca019, #系統產生對應單號(待抵帳款-預收)
       xrca020 LIKE xrca_t.xrca020, #信用狀申請流程否
       xrca021 LIKE xrca_t.xrca021, #商業發票號碼(IV no.)
       xrca022 LIKE xrca_t.xrca022, #出口報單號碼
       xrca023 LIKE xrca_t.xrca023, #發票客戶編號
       xrca024 LIKE xrca_t.xrca024, #發票客戶統一編號
       xrca025 LIKE xrca_t.xrca025, #發票客戶全名
       xrca026 LIKE xrca_t.xrca026, #發票客戶地址
       xrca028 LIKE xrca_t.xrca028, #發票類型
       xrca029 LIKE xrca_t.xrca029, #發票匯率
       xrca030 LIKE xrca_t.xrca030, #發票應開未稅金額
       xrca031 LIKE xrca_t.xrca031, #發票應開稅額
       xrca032 LIKE xrca_t.xrca032, #發票應開含稅金額
       xrca033 LIKE xrca_t.xrca033, #專案編號
       xrca034 LIKE xrca_t.xrca034, #責任中心
       xrca035 LIKE xrca_t.xrca035, #應收(借方)科目編號
       xrca036 LIKE xrca_t.xrca036, #收入(貸方)科目編號
       xrca037 LIKE xrca_t.xrca037, #分錄傳票產生否
       xrca038 LIKE xrca_t.xrca038, #拋轉傳票號碼
       xrca039 LIKE xrca_t.xrca039, #會計檢核附件份數
       xrca040 LIKE xrca_t.xrca040, #留置否
       xrca041 LIKE xrca_t.xrca041, #留置理由碼
       xrca042 LIKE xrca_t.xrca042, #留置設定日期
       xrca043 LIKE xrca_t.xrca043, #留置解除日期
       xrca044 LIKE xrca_t.xrca044, #留置原幣金額
       xrca045 LIKE xrca_t.xrca045, #留置說明
       xrca046 LIKE xrca_t.xrca046, #關係人否
       xrca047 LIKE xrca_t.xrca047, #多角序號
       xrca048 LIKE xrca_t.xrca048, #集團代收/代付單號
       xrca049 LIKE xrca_t.xrca049, #來源營運中心編號
       xrca050 LIKE xrca_t.xrca050, #交易原始單據份數
       xrca051 LIKE xrca_t.xrca051, #作廢理由碼
       xrca052 LIKE xrca_t.xrca052, #列印次數
       xrca053 LIKE xrca_t.xrca053, #備註
       xrca054 LIKE xrca_t.xrca054, #多帳期設定
       xrca055 LIKE xrca_t.xrca055, #繳款優惠條件
       xrca056 LIKE xrca_t.xrca056, #會計檢核附件狀態
       xrca057 LIKE xrca_t.xrca057, #交易對象識別碼
       xrca058 LIKE xrca_t.xrca058, #銷售分類
       xrca059 LIKE xrca_t.xrca059, #預算編號
       xrca060 LIKE xrca_t.xrca060, #發票開立原則
       xrca061 LIKE xrca_t.xrca061, #預計開立發票日期
       xrca062 LIKE xrca_t.xrca062, #多角性質
       xrca063 LIKE xrca_t.xrca063, #整帳批序號
       xrca064 LIKE xrca_t.xrca064, #訂金序次
       xrca065 LIKE xrca_t.xrca065, #發票編號
       xrca066 LIKE xrca_t.xrca066, #發票號碼
       xrca100 LIKE xrca_t.xrca100, #交易原幣別
       xrca101 LIKE xrca_t.xrca101, #原幣匯率
       xrca103 LIKE xrca_t.xrca103, #原幣未稅金額
       xrca104 LIKE xrca_t.xrca104, #原幣稅額
       xrca106 LIKE xrca_t.xrca106, #原幣直接折抵合計金額
       xrca107 LIKE xrca_t.xrca107, #原幣直接沖帳(調整)合計金額
       xrca108 LIKE xrca_t.xrca108, #原幣應收金額
       xrca113 LIKE xrca_t.xrca113, #本幣未稅金額
       xrca114 LIKE xrca_t.xrca114, #本幣稅額
       xrca116 LIKE xrca_t.xrca116, #本幣直接沖帳(調整)合計金額
       xrca117 LIKE xrca_t.xrca117, #本幣直接沖帳(調整)合計金額
       xrca118 LIKE xrca_t.xrca118, #本幣應收金額
       xrca120 LIKE xrca_t.xrca120, #本位幣二幣別
       xrca121 LIKE xrca_t.xrca121, #本位幣二匯率
       xrca123 LIKE xrca_t.xrca123, #本位幣二未稅金額
       xrca124 LIKE xrca_t.xrca124, #本位幣二稅額
       xrca126 LIKE xrca_t.xrca126, #本位幣二直接折抵合計金額
       xrca127 LIKE xrca_t.xrca127, #本位幣二直接沖帳(調整)合計金額
       xrca128 LIKE xrca_t.xrca128, #本位幣二應收金額
       xrca130 LIKE xrca_t.xrca130, #本位幣三幣別
       xrca131 LIKE xrca_t.xrca131, #本位幣三匯率
       xrca133 LIKE xrca_t.xrca133, #本位幣三未稅金額
       xrca134 LIKE xrca_t.xrca134, #本位幣三稅額
       xrca136 LIKE xrca_t.xrca136, #本位幣三直接折抵合計金額
       xrca137 LIKE xrca_t.xrca137, #本位幣三直接沖帳(調整)合計金額
       xrca138 LIKE xrca_t.xrca138, #本位幣三應收金額
       xrcaud001 LIKE xrca_t.xrcaud001, #自定義欄位(文字)001
       xrcaud002 LIKE xrca_t.xrcaud002, #自定義欄位(文字)002
       xrcaud003 LIKE xrca_t.xrcaud003, #自定義欄位(文字)003
       xrcaud004 LIKE xrca_t.xrcaud004, #自定義欄位(文字)004
       xrcaud005 LIKE xrca_t.xrcaud005, #自定義欄位(文字)005
       xrcaud006 LIKE xrca_t.xrcaud006, #自定義欄位(文字)006
       xrcaud007 LIKE xrca_t.xrcaud007, #自定義欄位(文字)007
       xrcaud008 LIKE xrca_t.xrcaud008, #自定義欄位(文字)008
       xrcaud009 LIKE xrca_t.xrcaud009, #自定義欄位(文字)009
       xrcaud010 LIKE xrca_t.xrcaud010, #自定義欄位(文字)010
       xrcaud011 LIKE xrca_t.xrcaud011, #自定義欄位(數字)011
       xrcaud012 LIKE xrca_t.xrcaud012, #自定義欄位(數字)012
       xrcaud013 LIKE xrca_t.xrcaud013, #自定義欄位(數字)013
       xrcaud014 LIKE xrca_t.xrcaud014, #自定義欄位(數字)014
       xrcaud015 LIKE xrca_t.xrcaud015, #自定義欄位(數字)015
       xrcaud016 LIKE xrca_t.xrcaud016, #自定義欄位(數字)016
       xrcaud017 LIKE xrca_t.xrcaud017, #自定義欄位(數字)017
       xrcaud018 LIKE xrca_t.xrcaud018, #自定義欄位(數字)018
       xrcaud019 LIKE xrca_t.xrcaud019, #自定義欄位(數字)019
       xrcaud020 LIKE xrca_t.xrcaud020, #自定義欄位(數字)020
       xrcaud021 LIKE xrca_t.xrcaud021, #自定義欄位(日期時間)021
       xrcaud022 LIKE xrca_t.xrcaud022, #自定義欄位(日期時間)022
       xrcaud023 LIKE xrca_t.xrcaud023, #自定義欄位(日期時間)023
       xrcaud024 LIKE xrca_t.xrcaud024, #自定義欄位(日期時間)024
       xrcaud025 LIKE xrca_t.xrcaud025, #自定義欄位(日期時間)025
       xrcaud026 LIKE xrca_t.xrcaud026, #自定義欄位(日期時間)026
       xrcaud027 LIKE xrca_t.xrcaud027, #自定義欄位(日期時間)027
       xrcaud028 LIKE xrca_t.xrcaud028, #自定義欄位(日期時間)028
       xrcaud029 LIKE xrca_t.xrcaud029, #自定義欄位(日期時間)029
       xrcaud030 LIKE xrca_t.xrcaud030  #自定義欄位(日期時間)030
       END RECORD

   #161128-00061#7---add--end-------------
   DEFINE l_success       LIKE type_t.num5
   DEFINE l_count         LIKE type_t.num5
   DEFINE l_ac            LIKE type_t.num5
   DEFINE l_docno         LIKE glaq_t.glaqdocno
   DEFINE l_glaq002       LIKE glaq_t.glaq002
   DEFINE l_glaa001       LIKE glaa_t.glaa001
   DEFINE l_glad034       LIKE glad_t.glad034
   DEFINE l_field         STRING
   DEFINE l_field1        STRING
   DEFINE l_field2        STRING
   DEFINE l_field3        STRING
   DEFINE l_field4        STRING
   DEFINE l_field5        STRING
   DEFINE l_group_field   STRING
   DEFINE l_d             LIKE glaq_t.glaq003   #20150612 add lujh
   DEFINE l_c             LIKE glaq_t.glaq004   #20150612 add lujh
   DEFINE l_glaa004       LIKE glaa_t.glaa004   
   DEFINE l_glaa005       LIKE glaa_t.glaa005
   DEFINE l_glac016       LIKE glac_t.glac016
   #170111-00055#1 add lujh axrp133效能优化 
   DEFINE l_xrca106       LIKE xrca_t.xrca106   
   DEFINE l_xrcc109       LIKE xrcc_t.xrcc109   
   DEFINE l_glaa015       LIKE glaa_t.glaa015   
   DEFINE l_glaa016       LIKE glaa_t.glaa016
   DEFINE l_glaa019       LIKE glaa_t.glaa019
   DEFINE l_glaa020       LIKE glaa_t.glaa020
   #170111-00055#1 add lujh axrp133效能优化
   DEFINE l_glad_r        RECORD 
                          glad005   LIKE glad_t.glad005,  #数量/金额管理否
                          glad007   LIKE glad_t.glad007,  #部门管理否
                          glad008   LIKE glad_t.glad008,  #利润成本管理否
                          glad009   LIKE glad_t.glad009,  #区域管理否
                          glad010   LIKE glad_t.glad010,  #交易客商管理否
                          glad011   LIKE glad_t.glad011,  #客群管理否
                          glad012   LIKE glad_t.glad012,  #产品类别管理否
                          glad013   LIKE glad_t.glad013,  #人员管理否
#                          glad014   LIKE glad_t.glad014,  #预算管理否
                          glad015   LIKE glad_t.glad015,  #专案管理否
                          glad016   LIKE glad_t.glad016,  #WBS管理否
                          glad017   LIKE glad_t.glad017,  #自由核算项1管理否
                          glad018   LIKE glad_t.glad018,  #自由核算项2管理否
                          glad019   LIKE glad_t.glad019,  #自由核算项3管理否
                          glad020   LIKE glad_t.glad020,  #自由核算项4管理否
                          glad021   LIKE glad_t.glad021,  #自由核算项5管理否
                          glad022   LIKE glad_t.glad022,  #自由核算项6管理否
                          glad023   LIKE glad_t.glad023,  #自由核算项7管理否
                          glad024   LIKE glad_t.glad024,  #自由核算项8管理否
                          glad025   LIKE glad_t.glad025,  #自由核算项9管理否
                          glad026   LIKE glad_t.glad026,  #自由核算项10管理否 
                          glad027   LIKE glad_t.glad027,  #账款客商管理否   
                          glad031   LIKE glad_t.glad031,  #經營方式管理否
                          glad032   LIKE glad_t.glad032,  #渠道管理否
                          glad033   LIKE glad_t.glad033   #品牌管理否                            
                          END RECORD
   #170509-00094#3 add s---                       
   DEFINE l_glad002       LIKE glad_t.glad002
   DEFINE l_glac008       LIKE glac_t.glac008
   DEFINE l_red           LIKE type_t.chr1
   DEFINE l_slip          STRING   
   #170509-00094#3 add e---   
   
   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE
   
   #SELECT glaa004,glaa005 INTO l_glaa004,l_glaa005   #170111-00055#1 mark lujh axrp133效能优化 
   #170111-00055#1 add lujh axrp133效能优化 
   SELECT glaa001,glaa015,glaa016,glaa019,glaa020,glaa004 #170509-00094#3 add glaa004
     INTO l_glaa001,l_glaa015,l_glaa016,l_glaa019,l_glaa020,l_glaa004 #170509-00094#3 add glaa004
   #170111-00055#1 add lujh axrp133效能优化   
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald = p_ld
   
   LET l_glac016 = ''
   
    #1.定义CURSOR
   CALL s_voucher_gen_ar_2_def_cursor(p_ld,'','','') RETURNING l_success
   IF NOT l_success THEN
      RETURN r_success
   END IF
   
   #161005-00018#2 Add  ---(S)---
   #不同来源的科目如果核算项+摘要相同也需要合并
   UPDATE s_vr_tmp04 SET source = 'xrcb' WHERE source <> 'diff'
   #161005-00018#2 Add  ---(E)---
   
   LET l_ac = 1
   #select count(*) into l_count  from s_vr_tmp04  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04 #170615-00061#25 mark
   select count(1) into l_count  from s_vr_tmp04                                                                                                           #170615-00061#25 add
   FOREACH s_voucher_gen_ar_2_cs5 INTO l_glaq002,l_glac016    #170111-00055#1 add glac016 axrp133效能优化
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach s_voucher_gen_ar_1_cs5'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF  
      
      EXECUTE s_voucher_gen_ar_2_cs6 USING l_glaq002 INTO l_glad_r.*
      
      #CALL s_voucher_glac016_get(l_glaa004,l_glaq002) RETURNING l_glac016   #170111-00055#1 mark axrp133效能优化
      
      LET l_group_field = NULL
      IF l_glad_r.glad007 = 'Y' THEN  #部门管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq018"
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq018"
         END IF
      END IF
      IF l_glad_r.glad008 = 'Y' THEN  #利润成本管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq019"
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq019"
         END IF       
      END IF       

      IF l_glad_r.glad009 = 'Y' THEN  #区域管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq020"
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq020 "
         END IF       
      END IF 
      #IF l_glad_r.glad010 = 'Y' THEN  #交易客商管理
      #   IF cl_null(l_group_field) THEN
      #      LET l_group_field = ",glaq021"
      #   ELSE
      #      LET l_group_field = l_group_field CLIPPED,",glaq021"
      #   END IF       
      #END IF
      #IF l_glad_r.glad027 = 'Y' THEN  #账款客商管理
      #   IF cl_null(l_group_field) THEN
      #      LET l_group_field = ",glaq022"
      #   ELSE
      #      LET l_group_field = l_group_field CLIPPED,",glaq022"
      #   END IF       
      #END IF       
      IF l_glad_r.glad011 = 'Y' THEN  #客群管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq023 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq023 "
         END IF       
      END IF 
      IF l_glad_r.glad012 = 'Y' THEN  #产品类别管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq024 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq024 "
         END IF       
      END IF 
      IF l_glad_r.glad013 = 'Y' THEN  #人员管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq025 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq025"
         END IF       
      END IF        
#      IF l_glad_r.glad014 = 'Y' THEN  #预算管理
#         IF cl_null(l_group_field) THEN
#            LET l_group_field = ",glaq026 "
#         ELSE
#            LET l_group_field = l_group_field CLIPPED,",glaq026 "
#         END IF       
#      END IF        
      IF l_glad_r.glad015 = 'Y' THEN  #专案管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq027 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq027 "
         END IF       
      END IF        
      IF l_glad_r.glad016 = 'Y' THEN  #WBS管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq028 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq028 "
         END IF       
      END IF 
      IF l_glad_r.glad031 = 'Y' THEN  #經營方式管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq051 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq051 "
         END IF       
      END IF 
      IF l_glad_r.glad032 = 'Y' THEN  #經營方式管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq052 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq052 "
         END IF       
      END IF 
      IF l_glad_r.glad033 = 'Y' THEN  #經營方式管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq053 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq053 "
         END IF       
      END IF
      IF l_glad_r.glad017 = 'Y' THEN  #自由核算项1
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq029 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq029 "
         END IF       
      END IF  
      IF l_glad_r.glad018 = 'Y' THEN  #自由核算项2
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq030 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq030 "
         END IF       
      END IF   
      IF l_glad_r.glad019 = 'Y' THEN  #自由核算项3
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq031 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq031 "
         END IF       
      END IF 
      IF l_glad_r.glad020 = 'Y' THEN  #自由核算项4
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq032 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq032 "
         END IF       
      END IF 
      IF l_glad_r.glad021 = 'Y' THEN  #自由核算项5
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq033 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq033 "
         END IF       
      END IF  
      IF l_glad_r.glad022 = 'Y' THEN  #自由核算项6
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq034 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq034 "
         END IF       
      END IF  
      IF l_glad_r.glad023 = 'Y' THEN  #自由核算项7
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq035 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq035 "
         END IF       
      END IF  
      IF l_glad_r.glad024 = 'Y' THEN  #自由核算项8
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq036 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq036 "
         END IF       
      END IF  
      IF l_glad_r.glad025 = 'Y' THEN  #自由核算项9
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq037 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq037 "
         END IF       
      END IF  
      IF l_glad_r.glad026 = 'Y' THEN  #自由核算项10
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq038 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq038 "
         END IF       
      END IF     
      IF l_glac016 = 'Y' THEN  #数量/金额管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glbc004"
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glbc004"
         END IF
      END IF      
      IF l_glad_r.glad005 = 'Y' THEN  #数量/金额管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq007"
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq007"
         END IF
      END IF
      
      LET l_field = NULL
      LET l_field1 = NULL
      LET l_field2 = NULL
      LET l_field3 = NULL
      LET l_field4 = NULL
      LET l_field5 = NULL
      
      IF l_glad_r.glad007 = 'Y' THEN  #部门管理
         IF cl_null(l_field) THEN
            LET l_field = "glaq018"
         ELSE
            LET l_field = l_field CLIPPED,",glaq018"
         END IF
      ELSE
         IF cl_null(l_field) THEN
            LET l_field = "''"
         ELSE
            LET l_field = l_field CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad008 = 'Y' THEN  #利润成本管理
         IF cl_null(l_field) THEN
            LET l_field = "glaq019"
         ELSE
            LET l_field = l_field CLIPPED,",glaq019"
         END IF 
      ELSE
         IF cl_null(l_field) THEN
            LET l_field = "''"
         ELSE
            LET l_field = l_field CLIPPED,",''"
         END IF         
      END IF       

      IF l_glad_r.glad009 = 'Y' THEN  #区域管理
         IF cl_null(l_field) THEN
            LET l_field = "glaq020"
         ELSE
            LET l_field = l_field CLIPPED,",glaq020 "
         END IF   
      ELSE
         IF cl_null(l_field) THEN
            LET l_field = "''"
         ELSE
            LET l_field = l_field CLIPPED,",''"
         END IF         
      END IF 
      #IF l_glad_r.glad010 = 'Y' THEN  #交易客商管理
      #   IF cl_null(l_field) THEN
      #      LET l_field = "glaq021"
      #   ELSE
      #      LET l_field = l_field CLIPPED,",glaq021"
      #   END IF       
      #ELSE
      #   IF cl_null(l_field) THEN
      #      LET l_field = "''"
      #   ELSE
      #      LET l_field = l_field CLIPPED,",''"
      #   END IF
      #END IF 
      #IF l_glad_r.glad027 = 'Y' THEN  #账款客商管理
      #   IF cl_null(l_field) THEN
      #      LET l_field = "glaq022"
      #   ELSE
      #      LET l_field = l_field CLIPPED,",glaq022"
      #   END IF       
      #ELSE
      #   IF cl_null(l_field) THEN
      #      LET l_field = "''"
      #   ELSE
      #      LET l_field = l_field CLIPPED,",''"
      #   END IF
      #END IF
      IF l_glad_r.glad011 = 'Y' THEN  #客群管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq023 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq023 "
         END IF   
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF 
      IF l_glad_r.glad012 = 'Y' THEN  #产品类别管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq024 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq024 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF 
      IF l_glad_r.glad013 = 'Y' THEN  #人员管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq025 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq025"
         END IF    
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF        
#      IF l_glad_r.glad014 = 'Y' THEN  #预算管理
#         IF cl_null(l_field3) THEN
#            LET l_field3 = "glaq026 "
#         ELSE
#            LET l_field3 = l_field3 CLIPPED,",glaq026 "
#         END IF  
#      ELSE
#         IF cl_null(l_field3) THEN
#            LET l_field3 = "''"
#         ELSE
#            LET l_field3 = l_field3 CLIPPED,",''"
#         END IF         
#      END IF        
      IF l_glad_r.glad015 = 'Y' THEN  #专案管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq027 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq027 "
         END IF 
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF        
      IF l_glad_r.glad016 = 'Y' THEN  #WBS管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq028 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq028 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF  

      IF l_glad_r.glad031 = 'Y' THEN  #經營方式管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq051 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq051 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad032 = 'Y' THEN  #渠道管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq052 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq052 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad033 = 'Y' THEN  #品牌管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq053 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq053 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad017 = 'Y' THEN  #自由核算项1
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq029 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq029 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad018 = 'Y' THEN  #自由核算项2
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq030 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq030 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad019 = 'Y' THEN  #自由核算项3
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq031 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq031 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad020 = 'Y' THEN  #自由核算项4
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq032 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq032 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad021 = 'Y' THEN  #自由核算项5
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq033 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq033 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad022 = 'Y' THEN  #自由核算项6
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq034 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq034 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad023 = 'Y' THEN  #自由核算项7
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq035 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq035 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad024 = 'Y' THEN  #自由核算项8
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq036 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq036 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad025 = 'Y' THEN  #自由核算项9
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq037 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq037 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad026 = 'Y' THEN  #自由核算项10
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq038 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq038 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glac016 = 'Y' THEN  #现金变动码
         IF cl_null(l_field3) THEN
            LET l_field3 = "glbc004 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glbc004 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF


      IF l_glad_r.glad005 = 'Y' THEN  #数量/金额管理
         IF cl_null(l_field1) THEN
            LET l_field1 = "glaq007"
         ELSE
            LET l_field1 = l_field1 CLIPPED,",glaq007"
         END IF
         IF cl_null(l_field2) THEN
            LET l_field2 = "SUM(qty)"
         ELSE
            LET l_field2 = l_field2 CLIPPED,",SUM(qty)"
         END IF
      ELSE
         IF cl_null(l_field1) THEN
            LET l_field1 = "''"
         ELSE
            LET l_field1 = l_field1 CLIPPED,",''"
         END IF
         IF cl_null(l_field2) THEN
            LET l_field2 = "''"
         ELSE
            LET l_field2 = l_field2 CLIPPED,",''"
         END IF
      END IF
 
      IF NOT cl_null(l_glaq002) THEN 
         LET l_field4 = " glaq002 = '",l_glaq002,"'"
      ELSE
         LET l_field4 = " glaq002 IS NULL"
      END IF
      IF p_sum_type = '1' THEN
         IF p_type = '2' THEN 
            LET g_sql = "SELECT docno,docdt,sw,glaqent,glaqcomp,'',glaq001,glaq002,glaq005,",
                        "       glaq006,",l_field1 CLIPPED,",",
                        "       '','','','','','','',glaq017,",l_field CLIPPED,",",
                        "       glaq021,glaq022,",l_field3 CLIPPED,",",
                        "       SUM(d),",
                        "       SUM(c),",l_field2 CLIPPED,",",
                        "       SUM(sum),glaq039,",
                        "       SUM(glaq040),",
                        "       SUM(glaq041),",
                        "       glaq042,",                                                                                                                   
                        "       SUM(glaq043),",
                        "       SUM(glaq044),",
                        "       '',source,'','',b_glaq021 ",
                        "  FROM s_vr_tmp04 ",  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                        " WHERE ",l_field4,
                        " GROUP BY docno,docdt,sw,glaqent,glaqcomp,glaq001,glaq002,glaq005,glaq006,glaq039,glaq042,glaq017,source,b_glaq021,glaq021,glaq022 ",l_group_field 
         ELSE
#170509-00094#3 mod s---         
#            LET g_sql = "SELECT docno,docdt,'',glaqent,glaqcomp,'',glaq001,glaq002,glaq005,",
#                        "       glaq006,",l_field1 CLIPPED,",",
#                        "       '','','','','','','',glaq017,",l_field CLIPPED,",",
#                        "       glaq021,glaq022,",l_field3 CLIPPED,",",
#                        "       CASE WHEN source = 'diff' THEN SUM(d) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(d - c) > 0 THEN 0 ELSE SUM(d - c) END) ELSE CASE WHEN SUM(d-c) < 0 THEN 0 ELSE SUM(d-c) END END END ,",
#                        "       CASE WHEN source = 'diff' THEN SUM(c) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(c - d) > 0 THEN 0 ELSE SUM(c - d) END) ELSE CASE WHEN SUM(c-d) < 0 THEN 0 ELSE SUM(c-d) END END END ,",l_field2 CLIPPED,",",
#                        "       CASE WHEN source = 'diff' THEN SUM(sum) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(sum) > 0 THEN SUM(sum)*-1 ELSE SUM(sum) END) ELSE CASE WHEN SUM(sum) < 0 THEN SUM(sum)*-1 ELSE SUM(sum) END END END ,glaq039,",
#                        "       CASE WHEN source = 'diff' THEN SUM(glaq040) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(glaq040-glaq041) > 0 THEN 0 ELSE SUM(glaq040-glaq041) END) ELSE CASE WHEN SUM(glaq040-glaq041) < 0 THEN 0 ELSE SUM(glaq040-glaq041) END END END ,",
#                        "       CASE WHEN source = 'diff' THEN SUM(glaq041) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(glaq041-glaq040) > 0 THEN 0 ELSE SUM(glaq041-glaq040) END) ELSE CASE WHEN SUM(glaq041-glaq040) < 0 THEN 0 ELSE SUM(glaq041-glaq040) END END END ,",
#                        "       glaq042,",                                                                                                                   
#                        "       CASE WHEN source = 'diff' THEN SUM(glaq043) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(glaq043-glaq044) > 0 THEN 0 ELSE SUM(glaq043-glaq044) END) ELSE CASE WHEN SUM(glaq043-glaq044) < 0 THEN 0 ELSE SUM(glaq043-glaq044) END END END ,",
#                        "       CASE WHEN source = 'diff' THEN SUM(glaq044) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(glaq044-glaq043) > 0 THEN 0 ELSE SUM(glaq044-glaq043) END) ELSE CASE WHEN SUM(glaq044-glaq043) < 0 THEN 0 ELSE SUM(glaq044-glaq043) END END END ,",
#                        "       '',source,'','',b_glaq021 ",
#                        "  FROM s_vr_tmp04 ",  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
#                        " WHERE ",l_field4,
#                        " GROUP BY docno,docdt,glaqent,glaqcomp,glaq001,glaq002,glaq005,glaq006,glaq039,glaq042,glaq017,source,b_glaq021,glaq021,glaq022,red ",l_group_field
            LET g_sql = "SELECT docno,docdt,'',glaqent,glaqcomp,'',glaq001,glaq002,glaq005,",
                        "       glaq006,",l_field1 CLIPPED,",",
                        "       '','','','','','','',glaq017,",l_field CLIPPED,",",
                        "       glaq021,glaq022,",l_field3 CLIPPED,",",
                        "       CASE WHEN source = 'diff' THEN SUM(d) ELSE CASE WHEN SUM(d-c) < 0 THEN 0 ELSE SUM(d-c) END END ,",
                        "       CASE WHEN source = 'diff' THEN SUM(c) ELSE CASE WHEN SUM(c-d) < 0 THEN 0 ELSE SUM(c-d) END END ,",l_field2 CLIPPED,",",
                        "       CASE WHEN source = 'diff' THEN SUM(sum) ELSE CASE WHEN SUM(sum) < 0 THEN SUM(sum)*-1 ELSE SUM(sum) END END ,glaq039,",
                        "       CASE WHEN source = 'diff' THEN SUM(glaq040) ELSE CASE WHEN SUM(glaq040-glaq041) < 0 THEN 0 ELSE SUM(glaq040-glaq041) END END ,",
                        "       CASE WHEN source = 'diff' THEN SUM(glaq041) ELSE CASE WHEN SUM(glaq041-glaq040) < 0 THEN 0 ELSE SUM(glaq041-glaq040) END END ,",
                        "       glaq042,",                                                                                                                   
                        "       CASE WHEN source = 'diff' THEN SUM(glaq043) ELSE CASE WHEN SUM(glaq043-glaq044) < 0 THEN 0 ELSE SUM(glaq043-glaq044) END END ,",
                        "       CASE WHEN source = 'diff' THEN SUM(glaq044) ELSE CASE WHEN SUM(glaq044-glaq043) < 0 THEN 0 ELSE SUM(glaq044-glaq043) END END ,",
                        "       '',source,'','',b_glaq021,'',red ",
                        "  FROM s_vr_tmp04 ",  
                        " WHERE ",l_field4,
                        " GROUP BY docno,docdt,glaqent,glaqcomp,glaq001,glaq002,glaq005,glaq006,glaq039,glaq042,glaq017,source,b_glaq021,glaq021,glaq022,red ",l_group_field
#170509-00094#3 mod e---                        
         END IF                          
      END IF
      IF p_sum_type = '2' THEN 
         IF p_type = '2' THEN 
            LET g_sql = "SELECT '',docdt,sw,glaqent,glaqcomp,'',glaq001,glaq002,glaq005,",
                        "       glaq006,",l_field1 CLIPPED,",",
                        "       '','','','','','','',glaq017,",l_field CLIPPED,",",
#                        "       '','',",l_field3 CLIPPED,",",   #170618-00294#1 20170626 mark by 08172
                        "       glaq021,glaq022,",l_field3 CLIPPED,",",   #170618-00294#1 20170626 add by 08172
                        "       SUM(d),",
                        "       SUM(c),",l_field2 CLIPPED,",",
                        "       SUM(sum),glaq039,",
                        "       SUM(glaq040),",
                        "       SUM(glaq041),",
                        "       glaq042,",                                                                                                                   
                        "       SUM(glaq043),",
                        "       SUM(glaq044),",
                        "       '',source,'','',b_glaq021 ",
                        "  FROM s_vr_tmp04 ",  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                        " WHERE ",l_field4,
#                        " GROUP BY docdt,glaqent,sw,glaqcomp,glaq001,glaq002,glaq005,glaq006,glaq039,glaq042,glaq017,source,b_glaq021 ",l_group_field  #170618-00294#1 20170626 mark by 08172
                        " GROUP BY docdt,glaqent,sw,glaqcomp,glaq001,glaq002,glaq005,glaq006,glaq039,glaq042,glaq017,source,b_glaq021,glaq021,glaq022 ",l_group_field  #170618-00294#1 20170626 add by 08172
         ELSE
#170509-00094#3 mod s---
#            LET g_sql = "SELECT '',docdt,'',glaqent,glaqcomp,'',glaq001,glaq002,glaq005,",
#                        "       glaq006,",l_field1 CLIPPED,",",
#                        "       '','','','','','','',glaq017,",l_field CLIPPED,",",
##                        "       '','',",l_field3 CLIPPED,",",  #170618-00294#1 20170626 mark by 08172
#                        "       glaq021,glaq022,",l_field3 CLIPPED,",",   #170618-00294#1 20170626 add by 08172
#                        "       CASE WHEN source = 'diff' THEN SUM(d) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(d - c) > 0 THEN 0 ELSE SUM(d - c) END) ELSE CASE WHEN SUM(d-c) < 0 THEN 0 ELSE SUM(d-c) END END END ,",
#                        "       CASE WHEN source = 'diff' THEN SUM(c) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(c - d) > 0 THEN 0 ELSE SUM(c - d) END) ELSE CASE WHEN SUM(c-d) < 0 THEN 0 ELSE SUM(c-d) END END END,",l_field2 CLIPPED,",",
#                        "       CASE WHEN source = 'diff' THEN SUM(sum) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(sum) > 0 THEN SUM(sum)*-1 ELSE SUM(sum) END) ELSE CASE WHEN SUM(sum) < 0 THEN SUM(sum)*-1 ELSE SUM(sum) END END END,glaq039,",
#                        "       CASE WHEN source = 'diff' THEN SUM(glaq040) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(glaq040-glaq041) > 0 THEN 0 ELSE SUM(glaq040-glaq041) END) ELSE CASE WHEN SUM(glaq040-glaq041) < 0 THEN 0 ELSE SUM(glaq040-glaq041) END END END,",
#                        "       CASE WHEN source = 'diff' THEN SUM(glaq041) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(glaq041-glaq040) > 0 THEN 0 ELSE SUM(glaq041-glaq040) END) ELSE CASE WHEN SUM(glaq041-glaq040) < 0 THEN 0 ELSE SUM(glaq041-glaq040) END END END,",
#                        "       glaq042,",                                                                                                                   
#                        "       CASE WHEN source = 'diff' THEN SUM(glaq043) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(glaq043-glaq044) > 0 THEN 0 ELSE SUM(glaq043-glaq044) END) ELSE CASE WHEN SUM(glaq043-glaq044) < 0 THEN 0 ELSE SUM(glaq043-glaq044) END END END,",
#                        "       CASE WHEN source = 'diff' THEN SUM(glaq044) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(glaq044-glaq043) > 0 THEN 0 ELSE SUM(glaq044-glaq043) END) ELSE CASE WHEN SUM(glaq044-glaq043) < 0 THEN 0 ELSE SUM(glaq044-glaq043) END END END,",
#                        "       '',source,'','',b_glaq021 ",
#                        "  FROM s_vr_tmp04 ",  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
#                        " WHERE ",l_field4,
##                        " GROUP BY docdt,glaqent,glaqcomp,glaq001,glaq002,glaq005,glaq006,glaq039,glaq042,glaq017,source,b_glaq021,red ",l_group_field  #170618-00294#1 20170626 mark by 08172
#                        " GROUP BY docdt,glaqent,glaqcomp,glaq001,glaq002,glaq005,glaq006,glaq039,glaq042,glaq017,source,b_glaq021,glaq021,glaq022,red ",l_group_field  #170618-00294#1 20170626 add by 08172
            LET g_sql = "SELECT '',docdt,'',glaqent,glaqcomp,'',glaq001,glaq002,glaq005,",
                        "       glaq006,",l_field1 CLIPPED,",",
                        "       '','','','','','','',glaq017,",l_field CLIPPED,",",
                        "       glaq021,glaq022,",l_field3 CLIPPED,",",    
                        "       CASE WHEN source = 'diff' THEN SUM(d)       ELSE CASE WHEN SUM(d-c) < 0 THEN 0 ELSE SUM(d-c) END END ,",
                        "       CASE WHEN source = 'diff' THEN SUM(c)       ELSE CASE WHEN SUM(c-d) < 0 THEN 0 ELSE SUM(c-d) END END ,",l_field2 CLIPPED,",",
                        "       CASE WHEN source = 'diff' THEN SUM(sum)     ELSE CASE WHEN SUM(sum) < 0 THEN SUM(sum)*-1 ELSE SUM(sum) END END ,glaq039,",
                        "       CASE WHEN source = 'diff' THEN SUM(glaq040) ELSE CASE WHEN SUM(glaq040-glaq041) < 0 THEN 0 ELSE SUM(glaq040-glaq041) END END ,",
                        "       CASE WHEN source = 'diff' THEN SUM(glaq041) ELSE CASE WHEN SUM(glaq041-glaq040) < 0 THEN 0 ELSE SUM(glaq041-glaq040) END END ,",
                        "       glaq042,",                                                                                                                   
                        "       CASE WHEN source = 'diff' THEN SUM(glaq043) ELSE CASE WHEN SUM(glaq043-glaq044) < 0 THEN 0 ELSE SUM(glaq043-glaq044) END END ,",
                        "       CASE WHEN source = 'diff' THEN SUM(glaq044) ELSE CASE WHEN SUM(glaq044-glaq043) < 0 THEN 0 ELSE SUM(glaq044-glaq043) END END ,",
                        "       '',source,'','',b_glaq021,'',red ",
                        "  FROM s_vr_tmp04 ",  
                        " WHERE ",l_field4,                 
                        " GROUP BY docdt,glaqent,glaqcomp,glaq001,glaq002,glaq005,glaq006,glaq039,glaq042,glaq017,source,b_glaq021,glaq021,glaq022,red ",l_group_field   
#170509-00094#3 mod e---                        
         END IF
      END IF
      IF p_sum_type = '3' THEN 
         IF p_type = '2' THEN 
            LET g_sql = "SELECT '','',sw,glaqent,glaqcomp,'',glaq001,glaq002,glaq005,",
                        "       glaq006,",l_field1 CLIPPED,",",
                        "       '','','','','','','',glaq017,",l_field CLIPPED,",",
                        "       glaq021,glaq022,",l_field3 CLIPPED,",",
                        "       SUM(d),",
                        "       SUM(c),",l_field2 CLIPPED,",",
                        "       SUM(sum),glaq039,",
                        "       SUM(glaq040),",
                        "       SUM(glaq041),",
                        "       glaq042,",                                                                                                                   
                        "       SUM(glaq043),",
                        "       SUM(glaq044),",
                        "       '',source,'','',b_glaq021 ",
                        "  FROM s_vr_tmp04 ",  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                        " WHERE ",l_field4,
                        " GROUP BY glaqent,sw,glaqcomp,glaq001,glaq002,glaq005,glaq006,glaq039,glaq042,glaq017,source,b_glaq021,glaq021,glaq022 ",l_group_field
         ELSE
#170509-00094#3 mod s---         
#            LET g_sql = "SELECT '','','',glaqent,glaqcomp,'',glaq001,glaq002,glaq005,",
#                        "       glaq006,",l_field1 CLIPPED,",",
#                        "       '','','','','','','',glaq017,",l_field CLIPPED,",",
#                        "       glaq021,glaq022,",l_field3 CLIPPED,",",
#                        "       CASE WHEN source = 'diff' THEN SUM(d) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(d - c) > 0 THEN 0 ELSE SUM(d - c) END) ELSE CASE WHEN SUM(d-c) < 0 THEN 0 ELSE SUM(d-c) END END END ,",
#                        "       CASE WHEN source = 'diff' THEN SUM(c) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(c - d) > 0 THEN 0 ELSE SUM(c - d) END) ELSE CASE WHEN SUM(c-d) < 0 THEN 0 ELSE SUM(c-d) END END END,",l_field2 CLIPPED,",",
#                        "       CASE WHEN source = 'diff' THEN SUM(sum) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(sum) > 0 THEN SUM(sum)*-1 ELSE SUM(sum) END) ELSE CASE WHEN SUM(sum) < 0 THEN SUM(sum)*-1 ELSE SUM(sum) END END END,glaq039,",
#                        "       CASE WHEN source = 'diff' THEN SUM(glaq040) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(glaq040-glaq041) > 0 THEN 0 ELSE SUM(glaq040-glaq041) END) ELSE CASE WHEN SUM(glaq040-glaq041) < 0 THEN 0 ELSE SUM(glaq040-glaq041) END END END,",
#                        "       CASE WHEN source = 'diff' THEN SUM(glaq041) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(glaq041-glaq040) > 0 THEN 0 ELSE SUM(glaq041-glaq040) END) ELSE CASE WHEN SUM(glaq041-glaq040) < 0 THEN 0 ELSE SUM(glaq041-glaq040) END END END,",
#                        "       glaq042,",                                                                                                                   
#                        "       CASE WHEN source = 'diff' THEN SUM(glaq043) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(glaq043-glaq044) > 0 THEN 0 ELSE SUM(glaq043-glaq044) END) ELSE CASE WHEN SUM(glaq043-glaq044) < 0 THEN 0 ELSE SUM(glaq043-glaq044) END END END,",
#                        "       CASE WHEN source = 'diff' THEN SUM(glaq044) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(glaq044-glaq043) > 0 THEN 0 ELSE SUM(glaq044-glaq043) END) ELSE CASE WHEN SUM(glaq044-glaq043) < 0 THEN 0 ELSE SUM(glaq044-glaq043) END END END,",
#                        "       '',source,'','',b_glaq021 ",
#                        "  FROM s_vr_tmp04 ",  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
#                        " WHERE ",l_field4,
#                        " GROUP BY glaqent,glaqcomp,glaq001,glaq002,glaq005,glaq006,glaq039,glaq042,glaq017,source,b_glaq021,glaq021,glaq022,red ",l_group_field
            LET g_sql = "SELECT '','','',glaqent,glaqcomp,'',glaq001,glaq002,glaq005,",
                        "       glaq006,",l_field1 CLIPPED,",",
                        "       '','','','','','','',glaq017,",l_field CLIPPED,",",
                        "       glaq021,glaq022,",l_field3 CLIPPED,",",
                        "       CASE WHEN source = 'diff' THEN SUM(d)       ELSE CASE WHEN SUM(d-c) < 0 THEN 0 ELSE SUM(d-c) END END ,",
                        "       CASE WHEN source = 'diff' THEN SUM(c)       ELSE CASE WHEN SUM(c-d) < 0 THEN 0 ELSE SUM(c-d) END END ,",l_field2 CLIPPED,",",
                        "       CASE WHEN source = 'diff' THEN SUM(sum)     ELSE CASE WHEN SUM(sum) < 0 THEN SUM(sum)*-1 ELSE SUM(sum) END END ,glaq039,",
                        "       CASE WHEN source = 'diff' THEN SUM(glaq040) ELSE CASE WHEN SUM(glaq040-glaq041) < 0 THEN 0 ELSE SUM(glaq040-glaq041) END END ,",
                        "       CASE WHEN source = 'diff' THEN SUM(glaq041) ELSE CASE WHEN SUM(glaq041-glaq040) < 0 THEN 0 ELSE SUM(glaq041-glaq040) END END,",
                        "       glaq042,",                                                                                                                   
                        "       CASE WHEN source = 'diff' THEN SUM(glaq043) ELSE CASE WHEN SUM(glaq043-glaq044) < 0 THEN 0 ELSE SUM(glaq043-glaq044) END END ,",
                        "       CASE WHEN source = 'diff' THEN SUM(glaq044) ELSE CASE WHEN SUM(glaq044-glaq043) < 0 THEN 0 ELSE SUM(glaq044-glaq043) END END ,",
                        "       '',source,'','',b_glaq021,'',red ",
                        "  FROM s_vr_tmp04 ",   
                        " WHERE ",l_field4,
                        " GROUP BY glaqent,glaqcomp,glaq001,glaq002,glaq005,glaq006,glaq039,glaq042,glaq017,source,b_glaq021,glaq021,glaq022,red ",l_group_field                        
#170509-00094#3 mod e---         
         END IF                  
      END IF
      
      IF p_sum_type = '4' THEN
         IF p_type = '2' THEN 
            LET g_sql = "SELECT '',docdt,sw,glaqent,glaqcomp,'',glaq001,glaq002,glaq005,",
                        "       glaq006,",l_field1 CLIPPED,",",
                        "       '','','','','','','',glaq017,",l_field CLIPPED,",",
                        "       glaq021,glaq022,",l_field3 CLIPPED,",",
                        "       SUM(d),",
                        "       SUM(c),",l_field2 CLIPPED,",",
                        "       SUM(sum),glaq039,",
                        "       SUM(glaq040),",
                        "       SUM(glaq041),",
                        "       glaq042,",                                                                                                                   
                        "       SUM(glaq043),",
                        "       SUM(glaq044),",
                       #"       '',source,'','',b_glaq021 ",   #161005-00018#2 Mark
                        "       '','','','',b_glaq021 ",       #161005-00018#2 Add
                        "  FROM s_vr_tmp04 ",  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                        " WHERE ",l_field4,
                        " GROUP BY docdt,sw,glaqent,glaqcomp,glaq001,glaq002,glaq005,glaq006,glaq039,glaq042,glaq017,source,b_glaq021,glaq021,glaq022 ",l_group_field
         ELSE
#170509-00094#3 mod s---
#            LET g_sql = "SELECT '',docdt,'',glaqent,glaqcomp,'',glaq001,glaq002,glaq005,",
#                        "       glaq006,",l_field1 CLIPPED,",",
#                        "       '','','','','','','',glaq017,",l_field CLIPPED,",",
#                        "       glaq021,glaq022,",l_field3 CLIPPED,",",
#                        "       CASE WHEN source = 'diff' THEN SUM(d) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(d - c) > 0 THEN 0 ELSE SUM(d - c) END) ELSE CASE WHEN SUM(d-c) < 0 THEN 0 ELSE SUM(d-c) END END END ,",
#                        "       CASE WHEN source = 'diff' THEN SUM(c) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(c - d) > 0 THEN 0 ELSE SUM(c - d) END) ELSE CASE WHEN SUM(c-d) < 0 THEN 0 ELSE SUM(c-d) END END END,",l_field2 CLIPPED,",",
#                        "       CASE WHEN source = 'diff' THEN SUM(sum) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(sum) > 0 THEN SUM(sum)*-1 ELSE SUM(sum) END) ELSE CASE WHEN SUM(sum) < 0 THEN SUM(sum)*-1 ELSE SUM(sum) END END END,glaq039,",
#                        "       CASE WHEN source = 'diff' THEN SUM(glaq040) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(glaq040-glaq041) > 0 THEN 0 ELSE SUM(glaq040-glaq041) END) ELSE CASE WHEN SUM(glaq040-glaq041) < 0 THEN 0 ELSE SUM(glaq040-glaq041) END END END,",
#                        "       CASE WHEN source = 'diff' THEN SUM(glaq041) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(glaq041-glaq040) > 0 THEN 0 ELSE SUM(glaq041-glaq040) END) ELSE CASE WHEN SUM(glaq041-glaq040) < 0 THEN 0 ELSE SUM(glaq041-glaq040) END END END,",
#                        "       glaq042,",                                                                                                                   
#                        "       CASE WHEN source = 'diff' THEN SUM(glaq043) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(glaq043-glaq044) > 0 THEN 0 ELSE SUM(glaq043-glaq044) END) ELSE CASE WHEN SUM(glaq043-glaq044) < 0 THEN 0 ELSE SUM(glaq043-glaq044) END END END,",
#                        "       CASE WHEN source = 'diff' THEN SUM(glaq044) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(glaq044-glaq043) > 0 THEN 0 ELSE SUM(glaq044-glaq043) END) ELSE CASE WHEN SUM(glaq044-glaq043) < 0 THEN 0 ELSE SUM(glaq044-glaq043) END END END,",
#                        "       '',source,'','',b_glaq021 ",
#                        "  FROM s_vr_tmp04 ",  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
#                        " WHERE ",l_field4,
#                        " GROUP BY docdt,glaqent,glaqcomp,glaq001,glaq002,glaq005,glaq006,glaq039,glaq042,glaq017,source,b_glaq021,glaq021,glaq022,red ",l_group_field
            LET g_sql = "SELECT '',docdt,'',glaqent,glaqcomp,'',glaq001,glaq002,glaq005,",
                        "       glaq006,",l_field1 CLIPPED,",",
                        "       '','','','','','','',glaq017,",l_field CLIPPED,",",
                        "       glaq021,glaq022,",l_field3 CLIPPED,",",
                        "       CASE WHEN source = 'diff' THEN SUM(d)       ELSE CASE WHEN SUM(d-c) < 0 THEN 0 ELSE SUM(d-c) END END ,",
                        "       CASE WHEN source = 'diff' THEN SUM(c)       ELSE CASE WHEN SUM(c-d) < 0 THEN 0 ELSE SUM(c-d) END END ,",l_field2 CLIPPED,",",
                        "       CASE WHEN source = 'diff' THEN SUM(sum)     ELSE CASE WHEN SUM(sum) < 0 THEN SUM(sum)*-1 ELSE SUM(sum) END END ,glaq039,",
                        "       CASE WHEN source = 'diff' THEN SUM(glaq040) ELSE CASE WHEN SUM(glaq040-glaq041) < 0 THEN 0 ELSE SUM(glaq040-glaq041) END END ,",
                        "       CASE WHEN source = 'diff' THEN SUM(glaq041) ELSE CASE WHEN SUM(glaq041-glaq040) < 0 THEN 0 ELSE SUM(glaq041-glaq040) END END ,",
                        "       glaq042,",                                                
                        "       CASE WHEN source = 'diff' THEN SUM(glaq043) ELSE CASE WHEN SUM(glaq043-glaq044) < 0 THEN 0 ELSE SUM(glaq043-glaq044) END END ,",
                        "       CASE WHEN source = 'diff' THEN SUM(glaq044) ELSE CASE WHEN SUM(glaq044-glaq043) < 0 THEN 0 ELSE SUM(glaq044-glaq043) END END ,",
                        "       '',source,'','',b_glaq021,'',red ",
                        "  FROM s_vr_tmp04 ",  
                        " WHERE ",l_field4,
                        " GROUP BY docdt,glaqent,glaqcomp,glaq001,glaq002,glaq005,glaq006,glaq039,glaq042,glaq017,source,b_glaq021,glaq021,glaq022,red ",l_group_field         
#170509-00094#3 mod e---         
         END IF       
      END IF
      
      IF p_sum_type = '5' THEN
         IF p_type = '2' THEN 
            LET g_sql = "SELECT '','',sw,glaqent,glaqcomp,'',glaq001,glaq002,glaq005,",
                        "       glaq006,",l_field1 CLIPPED,",",
                        "       '','','','','','','',glaq017,",l_field CLIPPED,",",
                        "       glaq021,glaq022,",l_field3 CLIPPED,",",
                        "       SUM(d),",
                        "       SUM(c),",l_field2 CLIPPED,",",
                        "       SUM(sum),glaq039,",
                        "       SUM(glaq040),",
                        "       SUM(glaq041),",
                        "       glaq042,",                                                                                                                   
                        "       SUM(glaq043),",
                        "       SUM(glaq044),",
                       #"       '',source,'','',b_glaq021 ",   #161005-00018#2 Mark
                        "       '','','','',b_glaq021 ",       #161005-00018#2 Add
                        "  FROM s_vr_tmp04 ",  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                        " WHERE ",l_field4,
                        " GROUP BY sw,glaqent,glaqcomp,glaq001,glaq002,glaq005,glaq006,glaq039,glaq042,glaq017,source,b_glaq021,glaq021,glaq022 ",l_group_field 
         ELSE
#170509-00094#3 mod s---         
#            LET g_sql = "SELECT '','','',glaqent,glaqcomp,'',glaq001,glaq002,glaq005,",
#                        "       glaq006,",l_field1 CLIPPED,",",
#                        "       '','','','','','','',glaq017,",l_field CLIPPED,",",
#                        "       glaq021,glaq022,",l_field3 CLIPPED,",",               #20151123 add lujh
#                        "       CASE WHEN source = 'diff' THEN SUM(d) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(d - c) > 0 THEN 0 ELSE SUM(d - c) END) ELSE CASE WHEN SUM(d-c) < 0 THEN 0 ELSE SUM(d-c) END END END ,",
#                        "       CASE WHEN source = 'diff' THEN SUM(c) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(c - d) > 0 THEN 0 ELSE SUM(c - d) END) ELSE CASE WHEN SUM(c-d) < 0 THEN 0 ELSE SUM(c-d) END END END,",l_field2 CLIPPED,",",
#                        "       CASE WHEN source = 'diff' THEN SUM(sum) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(sum) > 0 THEN SUM(sum)*-1 ELSE SUM(sum) END) ELSE CASE WHEN SUM(sum) < 0 THEN SUM(sum)*-1 ELSE SUM(sum) END END END,glaq039,",
#                        "       CASE WHEN source = 'diff' THEN SUM(glaq040) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(glaq040-glaq041) > 0 THEN 0 ELSE SUM(glaq040-glaq041) END) ELSE CASE WHEN SUM(glaq040-glaq041) < 0 THEN 0 ELSE SUM(glaq040-glaq041) END END END,",
#                        "       CASE WHEN source = 'diff' THEN SUM(glaq041) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(glaq041-glaq040) > 0 THEN 0 ELSE SUM(glaq041-glaq040) END) ELSE CASE WHEN SUM(glaq041-glaq040) < 0 THEN 0 ELSE SUM(glaq041-glaq040) END END END,",
#                        "       glaq042,",                                                                                                                   
#                        "       CASE WHEN source = 'diff' THEN SUM(glaq043) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(glaq043-glaq044) > 0 THEN 0 ELSE SUM(glaq043-glaq044) END) ELSE CASE WHEN SUM(glaq043-glaq044) < 0 THEN 0 ELSE SUM(glaq043-glaq044) END END END,",
#                        "       CASE WHEN source = 'diff' THEN SUM(glaq044) ELSE CASE WHEN red = 'Y' THEN (CASE WHEN SUM(glaq044-glaq043) > 0 THEN 0 ELSE SUM(glaq044-glaq043) END) ELSE CASE WHEN SUM(glaq044-glaq043) < 0 THEN 0 ELSE SUM(glaq044-glaq043) END END END,",
#                        "       '',source,'','',b_glaq021 ",
#                        "  FROM s_vr_tmp04 ",  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
#                        " WHERE ",l_field4,
#                        " GROUP BY glaqent,glaqcomp,glaq001,glaq002,glaq005,glaq006,glaq039,glaq042,glaq017,source,b_glaq021,glaq021,glaq022,red ",l_group_field  
            LET g_sql = "SELECT '','','',glaqent,glaqcomp,'',glaq001,glaq002,glaq005,",
                        "       glaq006,",l_field1 CLIPPED,",",
                        "       '','','','','','','',glaq017,",l_field CLIPPED,",",
                        "       glaq021,glaq022,",l_field3 CLIPPED,",",              
                        "       CASE WHEN source = 'diff' THEN SUM(d)       ELSE CASE WHEN SUM(d-c) < 0 THEN 0 ELSE SUM(d-c) END END ,",
                        "       CASE WHEN source = 'diff' THEN SUM(c)       ELSE CASE WHEN SUM(c-d) < 0 THEN 0 ELSE SUM(c-d) END END ,",l_field2 CLIPPED,",",
                        "       CASE WHEN source = 'diff' THEN SUM(sum)     ELSE CASE WHEN SUM(sum) < 0 THEN SUM(sum)*-1 ELSE SUM(sum) END END ,glaq039,",
                        "       CASE WHEN source = 'diff' THEN SUM(glaq040) ELSE CASE WHEN SUM(glaq040-glaq041) < 0 THEN 0 ELSE SUM(glaq040-glaq041) END END ,",
                        "       CASE WHEN source = 'diff' THEN SUM(glaq041) ELSE CASE WHEN SUM(glaq041-glaq040) < 0 THEN 0 ELSE SUM(glaq041-glaq040) END END ,",
                        "       glaq042,",                                                                                                                   
                        "       CASE WHEN source = 'diff' THEN SUM(glaq043) ELSE CASE WHEN SUM(glaq043-glaq044) < 0 THEN 0 ELSE SUM(glaq043-glaq044) END END ,",
                        "       CASE WHEN source = 'diff' THEN SUM(glaq044) ELSE CASE WHEN SUM(glaq044-glaq043) < 0 THEN 0 ELSE SUM(glaq044-glaq043) END END ,",
                        "       '',source,'','',b_glaq021,'',red ",
                        "  FROM s_vr_tmp04 ",   
                        " WHERE ",l_field4,
                        " GROUP BY glaqent,glaqcomp,glaq001,glaq002,glaq005,glaq006,glaq039,glaq042,glaq017,source,b_glaq021,glaq021,glaq022,red ",l_group_field           
#170509-00094#3 mod e---         
         END IF                          
      END IF
      PREPARE s_voucher_gen_ar_2_p12 FROM g_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_ar_2_p12'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF  
      
      DECLARE s_voucher_gen_ar_2_cs12 CURSOR FOR s_voucher_gen_ar_2_p12
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_ar_2_cs12'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF 
      
      LET l_red = 'N' #170509-00094#3 add
      
      FOREACH s_voucher_gen_ar_2_cs12 INTO g_glaq2_d[l_ac].*
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = 'foreach s_voucher_gen_ar_2_cs12'
            LET g_errparam.popup = TRUE
            CALL cl_err()

            RETURN r_success
         END IF
         LET g_glaq2_d[l_ac].glaqseq = l_ac
         IF g_glaq2_d[l_ac].d = 0 AND g_glaq2_d[l_ac].c = 0 THEN 
            CONTINUE FOREACH
         END IF
         
         #IF g_glaq2_d[l_ac].d <> 0 AND g_glaq2_d[l_ac].c <> 0 THEN
         #   LET l_d = g_glaq2_d[l_ac].d
         #   LET l_c = g_glaq2_d[l_ac].c
         #   
         #   IF l_d < 0 THEN 
         #      LET l_d = l_d * -1
         #   END IF
         #   
         #   IF l_c < 0 THEN 
         #      LET l_c = l_c * -1
         #   END IF
         #   
         #   IF l_d > l_c THEN 
         #      LET g_glaq2_d[l_ac].d = g_glaq2_d[l_ac].d - g_glaq2_d[l_ac].c
         #      LET g_glaq2_d[l_ac].c = 0
         #   ELSE
         #      LET g_glaq2_d[l_ac].d = 0
         #      LET g_glaq2_d[l_ac].c = g_glaq2_d[l_ac].c - g_glaq2_d[l_ac].d
         #   END IF 
         #END IF
         
         #170111-00055#1 mark lujh axrp133效能优化 
         #SELECT glaa001 INTO l_glaa001
         #  FROM glaa_t
         # WHERE glaaent = g_enterprise
         #   AND glaald = p_ld
         #170111-00055#1 mark lujh axrp133效能优化 
         
         #170509-00094#3 add s---
         EXECUTE s_voucher_gen_ar_2_p14 USING l_glaa004,g_glaq2_d[l_ac].glaq002 INTO l_glad002,l_glac008  
         
#         IF NOT cl_null(g_glaq2_d[l_ac].docno) THEN 
#            CALL s_aooi200_fin_get_slip(g_glaq2_d[l_ac].docno) RETURNING l_success,l_slip
#            #獲取單據別對應參數：紅字傳票否
#            CALL s_fin_get_doc_para(p_ld,'',l_slip,'D-FIN-1002') RETURNING l_red  
#         END IF   
            
         IF l_glad002 = 'Y' AND g_glaq2_d[l_ac].red = 'Y' THEN 
            #借余
            IF l_glac008 = '1' THEN 
               IF g_glaq2_d[l_ac].d = 0 AND g_glaq2_d[l_ac].c <> 0 THEN 
                  LET g_glaq2_d[l_ac].d = g_glaq2_d[l_ac].c * -1
                  LET g_glaq2_d[l_ac].c = 0
                  LET g_glaq2_d[l_ac].sum = g_glaq2_d[l_ac].sum * -1
               END IF
            ELSE
               IF g_glaq2_d[l_ac].d <> 0 AND g_glaq2_d[l_ac].c = 0 THEN 
                  LET g_glaq2_d[l_ac].c = g_glaq2_d[l_ac].d * -1
                  LET g_glaq2_d[l_ac].d = 0
                  LET g_glaq2_d[l_ac].sum = g_glaq2_d[l_ac].sum * -1
               END IF
            END IF
         END IF
         #170509-00094#3 add e---         
         
         CALL s_pre_voucher_glad034_get(p_ld,g_glaq2_d[l_ac].glaq002) RETURNING l_glad034
            
         IF l_glad034 = 'N' THEN
            LET g_glaq2_d[l_ac].glaq005 = l_glaa001
            LET g_glaq2_d[l_ac].glaq006 = 1
            IF g_glaq2_d[l_ac].d <> 0 THEN 
               LET g_glaq2_d[l_ac].sum = g_glaq2_d[l_ac].d
            END IF 
            IF g_glaq2_d[l_ac].c <> 0 THEN 
               LET g_glaq2_d[l_ac].sum = g_glaq2_d[l_ac].c
            END IF 
            
            #20151123--add--str--lujh
            UPDATE s_vr_tmp04 SET glaq005 = g_glaq2_d[l_ac].glaq005,  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                                        glaq006 = g_glaq2_d[l_ac].glaq006
             WHERE glaq002 = g_glaq2_d[l_ac].glaq002
            #20151123--add--end--lujh
         END IF
         
         #170111-00055#1 add lujh axrp133效能优化 
         LET g_glaq2_d[l_ac].sum = s_curr_round(g_glaq2_d[l_ac].glaqcomp,g_glaq2_d[l_ac].glaq005,g_glaq2_d[l_ac].sum,'2')
         LET g_glaq2_d[l_ac].d = s_curr_round(g_glaq2_d[l_ac].glaqcomp,l_glaa001,g_glaq2_d[l_ac].d,'2')
         LET g_glaq2_d[l_ac].c = s_curr_round(g_glaq2_d[l_ac].glaqcomp,l_glaa001,g_glaq2_d[l_ac].c,'2')
         IF l_glaa015 = 'Y' THEN 
            LET g_glaq2_d[l_ac].glaq040 = s_curr_round(g_glaq2_d[l_ac].glaqcomp,l_glaa016,g_glaq2_d[l_ac].glaq040,'2')
            LET g_glaq2_d[l_ac].glaq041 = s_curr_round(g_glaq2_d[l_ac].glaqcomp,l_glaa016,g_glaq2_d[l_ac].glaq041,'2')
         END IF
         IF l_glaa019 = 'Y' THEN
            LET g_glaq2_d[l_ac].glaq043 = s_curr_round(g_glaq2_d[l_ac].glaqcomp,l_glaa020,g_glaq2_d[l_ac].glaq043,'2')
            LET g_glaq2_d[l_ac].glaq044 = s_curr_round(g_glaq2_d[l_ac].glaqcomp,l_glaa020,g_glaq2_d[l_ac].glaq044,'2')
         END IF
         #170111-00055#1 add lujh axrp133效能优化
         
         
         INSERT INTO s_vr_tmp05 VALUES(g_glaq2_d[l_ac].*)  #160727-00019#36   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_ar_group ——> s_vr_tmp05
         LET l_ac = l_ac + 1
      END FOREACH
      CALL g_glaq2_d.deleteElement(l_ac)   
   END FOREACH 
   
   LET r_success = TRUE
   RETURN r_success
################################################################################
# Descriptions...: 自动产生凭证-建立临时表
# Memo...........:
# Usage..........: CALL s_voucher_cre_ar_tmp_table()
END FUNCTION
# Descriptions...: 細項沖帳作廢更新
# Memo...........: 
# Usage..........: CALL s_voucher_void_upd_glay(p_glayld,p_glaydocno)
#                  RETURNING r_success
# Input parameter: p_glayld       帳套
#                : p_glaydocno    傳票編號
# Return code....: r_success      更新結果
# Date & Author..: 14/02/13 By 02599
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_void_upd_glay(p_glayld,p_glaydocno)
   DEFINE p_glayld         LIKE glay_t.glayld         #帐别
   DEFINE p_glaydocno      LIKE glay_t.glaydocno      #傳票編號
   DEFINE r_success        LIKE type_t.num5
   DEFINE l_today          DATETIME YEAR TO SECOND
   
   WHENEVER ERROR CONTINUE
   
   LET r_success  = TRUE
   LET l_today = cl_get_current()
   #更新狀態碼='X', 修改者=g_user,修改日期=g_today
   UPDATE glay_t SET glaystus = 'X',
                     glaymodid = g_user,
                     glaymoddt = l_today
              WHERE glayent = g_enterprise
                AND glayld = p_glayld
                AND glaydocno = p_glaydocno
   IF SQLCA.SQLCODE THEN
      LET r_success = FALSE
#      CALL cl_errmsg('glaystus',p_glaydocno,'X',sqlca.sqlcode,1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaydocno
      LET g_errparam.code = sqlca.sqlcode
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF 
   RETURN r_success

END FUNCTION
################################################################################
# Descriptions...: 应收冲账自动产生凭证
# Memo...........:
# Usage..........: CALL s_voucher_gen_ar_3(p_ld,p_sum_type,p_wc)
#                       RETURNING r_success,g_glaq
# Input parameter: p_ld           帐套
#                : p_sum_type     汇总方式 
#                : p_wc           QBE条件(帐款来源)
# Return code....: r_success      成功否标识位
#                : g_glaq         傳票底稿清單
# Date & Author..: 2014/03/02 By Carrier
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_3(p_ld,p_sum_type,p_wc)
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE p_sum_type      LIKE type_t.chr1
   DEFINE p_wc            LIKE type_t.chr1000
   DEFINE r_success       LIKE type_t.num5
   #161128-00061#7---add---begin-----------
   #DEFINE l_xrda          RECORD LIKE xrda_t.*
   DEFINE l_xrda RECORD  #收款核銷單單頭檔
       xrdaent LIKE xrda_t.xrdaent, #企业代码
       xrdacomp LIKE xrda_t.xrdacomp, #所屬法人
       xrdald LIKE xrda_t.xrdald, #帳套別
       xrdadocno LIKE xrda_t.xrdadocno, #沖帳單號
       xrdadocdt LIKE xrda_t.xrdadocdt, #沖帳日期
       xrdasite LIKE xrda_t.xrdasite, #帳務組織
       xrda001 LIKE xrda_t.xrda001, #帳款單性質
       xrda003 LIKE xrda_t.xrda003, #帳務人員
       xrda004 LIKE xrda_t.xrda004, #帳款核銷客戶
       xrda005 LIKE xrda_t.xrda005, #收款客戶
       xrda006 LIKE xrda_t.xrda006, #一次性對象識別碼
       xrda007 LIKE xrda_t.xrda007, #產生方式
       xrda008 LIKE xrda_t.xrda008, #來源參考單號
       xrda009 LIKE xrda_t.xrda009, #沖帳批序號
       xrda010 LIKE xrda_t.xrda010, #集團代收付單號
       xrda011 LIKE xrda_t.xrda011, #差異處理
       xrda012 LIKE xrda_t.xrda012, #退款類型
       xrda013 LIKE xrda_t.xrda013, #分錄底稿是否可重新產生
       xrda014 LIKE xrda_t.xrda014, #拋轉傳票號碼
       xrda015 LIKE xrda_t.xrda015, #作廢理由碼
       xrda016 LIKE xrda_t.xrda016, #列印次數
       xrda017 LIKE xrda_t.xrda017, #MEMO備註
       xrdastus LIKE xrda_t.xrdastus, #確認否
       xrdaownid LIKE xrda_t.xrdaownid, #資料所有者
       xrdaowndp LIKE xrda_t.xrdaowndp, #資料所屬部門
       xrdacrtid LIKE xrda_t.xrdacrtid, #資料建立者
       xrdacrtdp LIKE xrda_t.xrdacrtdp, #資料建立部門
       xrdacrtdt LIKE xrda_t.xrdacrtdt, #資料創建日
       xrdamodid LIKE xrda_t.xrdamodid, #資料修改者
       xrdamoddt LIKE xrda_t.xrdamoddt, #最近修改日
       xrdaud001 LIKE xrda_t.xrdaud001, #自定義欄位(文字)001
       xrdaud002 LIKE xrda_t.xrdaud002, #自定義欄位(文字)002
       xrdaud003 LIKE xrda_t.xrdaud003, #自定義欄位(文字)003
       xrdaud004 LIKE xrda_t.xrdaud004, #自定義欄位(文字)004
       xrdaud005 LIKE xrda_t.xrdaud005, #自定義欄位(文字)005
       xrdaud006 LIKE xrda_t.xrdaud006, #自定義欄位(文字)006
       xrdaud007 LIKE xrda_t.xrdaud007, #自定義欄位(文字)007
       xrdaud008 LIKE xrda_t.xrdaud008, #自定義欄位(文字)008
       xrdaud009 LIKE xrda_t.xrdaud009, #自定義欄位(文字)009
       xrdaud010 LIKE xrda_t.xrdaud010, #自定義欄位(文字)010
       xrdaud011 LIKE xrda_t.xrdaud011, #自定義欄位(數字)011
       xrdaud012 LIKE xrda_t.xrdaud012, #自定義欄位(數字)012
       xrdaud013 LIKE xrda_t.xrdaud013, #自定義欄位(數字)013
       xrdaud014 LIKE xrda_t.xrdaud014, #自定義欄位(數字)014
       xrdaud015 LIKE xrda_t.xrdaud015, #自定義欄位(數字)015
       xrdaud016 LIKE xrda_t.xrdaud016, #自定義欄位(數字)016
       xrdaud017 LIKE xrda_t.xrdaud017, #自定義欄位(數字)017
       xrdaud018 LIKE xrda_t.xrdaud018, #自定義欄位(數字)018
       xrdaud019 LIKE xrda_t.xrdaud019, #自定義欄位(數字)019
       xrdaud020 LIKE xrda_t.xrdaud020, #自定義欄位(數字)020
       xrdaud021 LIKE xrda_t.xrdaud021, #自定義欄位(日期時間)021
       xrdaud022 LIKE xrda_t.xrdaud022, #自定義欄位(日期時間)022
       xrdaud023 LIKE xrda_t.xrdaud023, #自定義欄位(日期時間)023
       xrdaud024 LIKE xrda_t.xrdaud024, #自定義欄位(日期時間)024
       xrdaud025 LIKE xrda_t.xrdaud025, #自定義欄位(日期時間)025
       xrdaud026 LIKE xrda_t.xrdaud026, #自定義欄位(日期時間)026
       xrdaud027 LIKE xrda_t.xrdaud027, #自定義欄位(日期時間)027
       xrdaud028 LIKE xrda_t.xrdaud028, #自定義欄位(日期時間)028
       xrdaud029 LIKE xrda_t.xrdaud029, #自定義欄位(日期時間)029
       xrdaud030 LIKE xrda_t.xrdaud030, #自定義欄位(日期時間)030
       xrda103 LIKE xrda_t.xrda103, #原幣借方金額合計
       xrda104 LIKE xrda_t.xrda104, #原幣貸方金額合計
       xrda113 LIKE xrda_t.xrda113, #本幣借方金額合計
       xrda114 LIKE xrda_t.xrda114, #本幣貸方金額合計
       xrda123 LIKE xrda_t.xrda123, #本位幣二借方金額合計
       xrda124 LIKE xrda_t.xrda124, #本位幣二貸方金額合計
       xrda133 LIKE xrda_t.xrda133, #本位幣三借方金額合計
       xrda134 LIKE xrda_t.xrda134, #本位幣三貸方金額合計
       xrdacnfid LIKE xrda_t.xrdacnfid, #資料確認這
       xrdacnfdt LIKE xrda_t.xrdacnfdt, #資料確認日
       xrdapstid LIKE xrda_t.xrdapstid, #資料過帳者
       xrdapstdt LIKE xrda_t.xrdapstdt, #資料過帳日
       xrda018 LIKE xrda_t.xrda018  #來源類型(流通)
       END RECORD
   #161128-00061#7---add---end-----------
   DEFINE l_success       LIKE type_t.num5
   DEFINE l_ac            LIKE type_t.num5
   DEFINE l_ac1           LIKE type_t.num5
   DEFINE l_docno         LIKE glaq_t.glaqdocno
   DEFINE l_glaq002       LIKE glaq_t.glaq002
   DEFINE l_field         LIKE type_t.chr1000
   DEFINE l_field1        LIKE type_t.chr1000
   DEFINE l_field2        LIKE type_t.chr1000
   DEFINE l_field3        LIKE type_t.chr1000
   DEFINE l_field4        LIKE type_t.chr1000
   DEFINE l_group_field   LIKE type_t.chr1000
   DEFINE l_glad_r        RECORD 
                          glad005   LIKE glad_t.glad005,  #数量/金额管理否
                          glad007   LIKE glad_t.glad007,  #部门管理否
                          glad008   LIKE glad_t.glad008,  #利润成本管理否
                          glad009   LIKE glad_t.glad009,  #区域管理否
                          glad010   LIKE glad_t.glad010,  #交易客商管理否
                          glad011   LIKE glad_t.glad011,  #客群管理否
                          glad012   LIKE glad_t.glad012,  #产品类别管理否
                          glad013   LIKE glad_t.glad013,  #人员管理否
#                          glad014   LIKE glad_t.glad014,  #预算管理否
                          glad015   LIKE glad_t.glad015,  #专案管理否
                          glad016   LIKE glad_t.glad016,  #WBS管理否
                          glad017   LIKE glad_t.glad017,  #自由核算项1管理否
                          glad018   LIKE glad_t.glad018,  #自由核算项2管理否
                          glad019   LIKE glad_t.glad019,  #自由核算项3管理否
                          glad020   LIKE glad_t.glad020,  #自由核算项4管理否
                          glad021   LIKE glad_t.glad021,  #自由核算项5管理否
                          glad022   LIKE glad_t.glad022,  #自由核算项6管理否
                          glad023   LIKE glad_t.glad023,  #自由核算项7管理否
                          glad024   LIKE glad_t.glad024,  #自由核算项8管理否
                          glad025   LIKE glad_t.glad025,  #自由核算项9管理否
                          glad026   LIKE glad_t.glad026,  #自由核算项10管理否    
                          glad027   LIKE glad_t.glad027,  #账款客商管理否   
                          glad031   LIKE glad_t.glad031,  #經營方式管理否
                          glad032   LIKE glad_t.glad032,  #渠道管理否
                          glad033   LIKE glad_t.glad033   #品牌管理否
                          END RECORD
   
   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE

   #IF p_sum_type NOT MATCHES '[123]' THEN
   #   #产生凭证的汇总方式仅可为1或2或3
   #   INITIALIZE g_errparam TO NULL
   #   LET g_errparam.code = 'agl-00124'
   #   LET g_errparam.extend = ''
   #   LET g_errparam.popup = TRUE
   #   CALL cl_err()
   #
   #   RETURN r_success
   #END IF
   
   DELETE FROM s_vr_tmp04;     #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
   DELETE FROM s_vr_tmp05;   #160727-00019#36   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_ar_group ——> s_vr_tmp05
   DELETE FROM s_voucher_glbc;

   #1.定义CURSOR
   CALL s_voucher_gen_ar_2_def_cursor(p_ld,p_wc,p_sum_type,'') RETURNING l_success
   IF NOT l_success THEN
      RETURN r_success
   END IF
 
   #2.插入临时表
   FOREACH s_voucher_gen_ar_3_cs1 INTO l_xrda.*
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach s_voucher_gen_ar_3_cs1'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF
      
      #借 
      CALL s_voucher_gen_ar_3_ins_tmp('1',l_xrda.xrdald,l_xrda.xrdadocno,'')
           RETURNING l_success
      IF NOT l_success THEN
         RETURN r_success    
      END IF
         
      #贷
      CALL s_voucher_gen_ar_3_ins_tmp('2',l_xrda.xrdald,l_xrda.xrdadocno,'')
           RETURNING l_success
      IF NOT l_success THEN
         RETURN r_success  
      END IF
      
#      IF g_prog = 'axrt800' THEN   #170301-00030#8 by 09257 --mark 
      IF g_prog MATCHES 'axrt800*' THEN   #170301-00030#8 by 09257 --add   
         #借 
         CALL s_voucher_gen_ar_3_ins_tmp('3',l_xrda.xrdald,l_xrda.xrdadocno,'')
              RETURNING l_success
         IF NOT l_success THEN
            RETURN r_success    
         END IF
      END IF
      
   END FOREACH
   
   #3.按科目设置进行UPDATE,若有做不管理的字段,UPDATE至' '
   CALL s_voucher_gen_ar_2_upd_tmp(p_ld) 
        RETURNING l_success
   IF NOT l_success THEN
      RETURN r_success    
   END IF
   
   
   
   #5.插入凭证单头
   #CALL s_voucher_gen_ar_1_ins_glap(p_slip,p_sum_type)
   #     RETURNING r_success,r_start_no,r_end_no
   #IF NOT l_success THEN
   #   RETURN r_success,r_start_no,r_end_no       
   #END IF   
   #
   LET r_success = TRUE
   
   
   RETURN r_success
END FUNCTION
################################################################################
# Descriptions...: 处理借方科目及金额等
# Memo...........:
# Usage..........: CALL s_voucher_gen_ar_1_ins_tmp(p_type,p_xrdald,p_xrdadocno,p_xrda001)
#                  RETURNING r_success
# Input parameter: p_type         类型 '1'借 '2'贷
#                : p_xrdald       帐套
#                : p_xrdadocno    应收帐款单号
#                : p_xrda001      帳款單性質
# Return code....: r_success      成功否标识位
# Date & Author..: 2014/03/02 By Carrier
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_3_ins_tmp(p_type,p_xrdald,p_xrdadocno,p_xrda001)
   DEFINE p_type           LIKE type_t.chr1
   DEFINE p_xrdald         LIKE xrda_t.xrdald
   DEFINE p_xrdadocno      LIKE xrda_t.xrdadocno
   DEFINE p_xrda001        LIKE xrda_t.xrda001
   DEFINE l_xrcb022        LIKE xrcb_t.xrcb022
   DEFINE l_xrce015        LIKE xrce_t.xrce015
   DEFINE l_xrde002        LIKE xrde_t.xrde002
   DEFINE l_xrde013        LIKE xrde_t.xrde013
   DEFINE r_success        LIKE type_t.num5
   DEFINE l_success        LIKE type_t.num5
   DEFINE l_memo           LIKE glaq_t.glaq001
   DEFINE l_xrce002        LIKE xrce_t.xrce002
   DEFINE l_xrcadocno      LIKE xrca_t.xrcadocno
   DEFINE l_glaa004        LIKE glaa_t.glaa004   
   DEFINE l_glaa005        LIKE glaa_t.glaa005
   DEFINE l_glac016        LIKE glac_t.glac016
   DEFINE l_glaq020        LIKE glaq_t.glaq020
   DEFINE l_glaq021        LIKE glaq_t.glaq021
   DEFINE l_glaq022        LIKE glaq_t.glaq022
   DEFINE l_glaq023        LIKE glaq_t.glaq023
   DEFINE l_glaq024        LIKE glaq_t.glaq024
   DEFINE l_glaq051        LIKE glaq_t.glaq051
   DEFINE l_glaq052        LIKE glaq_t.glaq052
   DEFINE l_glaq053        LIKE glaq_t.glaq053
   DEFINE l_glaq027        LIKE glaq_t.glaq027
   DEFINE l_glaq028        LIKE glaq_t.glaq028
   DEFINE l_glaq029        LIKE glaq_t.glaq029
   DEFINE l_glaq030        LIKE glaq_t.glaq030
   DEFINE l_glaq031        LIKE glaq_t.glaq031
   DEFINE l_glaq032        LIKE glaq_t.glaq032
   DEFINE l_glaq033        LIKE glaq_t.glaq033
   DEFINE l_glaq034        LIKE glaq_t.glaq034
   DEFINE l_glaq035        LIKE glaq_t.glaq035
   DEFINE l_glaq036        LIKE glaq_t.glaq036
   DEFINE l_glaq037        LIKE glaq_t.glaq037
   DEFINE l_glaq038        LIKE glaq_t.glaq038
   #160509-00004#80--add--str--lujh
   DEFINE l_xrde108        LIKE xrde_t.xrde108
   DEFINE l_xrde118        LIKE xrde_t.xrde118
   DEFINE l_xrde007        LIKE xrde_t.xrde007
   DEFINE l_stae013        LIKE stae_t.stae013
   DEFINE l_stbc060        LIKE stbc_t.stbc060
   DEFINE l_ooef024        LIKE ooef_t.ooef024
   DEFINE l_xrce003        LIKE xrce_t.xrce003
   DEFINE l_xrce004        LIKE xrce_t.xrce004
   DEFINE l_xrce055        LIKE xrce_t.xrce055
   #160509-00004#80--add--end--lujh
   DEFINE l_tmp            RECORD 
                           docno       LIKE glaq_t.glaqdocno,
                           docdt       LIKE glap_t.glapdocdt,
                           sw          LIKE type_t.chr1,     
                           glaqent     LIKE glaq_t.glaqent,  
                           glaqcomp    LIKE glaq_t.glaqcomp, 
                           glaqld      LIKE glaq_t.glaqld,   
                           glaq001     LIKE glaq_t.glaq001,  
                           glaq002     LIKE glaq_t.glaq002,  
                           glaq005     LIKE glaq_t.glaq005,  
                           glaq006     LIKE glaq_t.glaq006,  
                           glaq007     LIKE glaq_t.glaq007,  
                           glaq009     LIKE glaq_t.glaq009,  
                           glaq011     LIKE glaq_t.glaq011,  
                           glaq012     LIKE glaq_t.glaq012,  
                           glaq013     LIKE glaq_t.glaq013,  
                           glaq014     LIKE glaq_t.glaq014,  
                           glaq015     LIKE glaq_t.glaq015,  
                           glaq016     LIKE glaq_t.glaq016,  
                           glaq017     LIKE glaq_t.glaq017,  
                           glaq018     LIKE glaq_t.glaq018,  
                           glaq019     LIKE glaq_t.glaq019,  
                           glaq020     LIKE glaq_t.glaq020,  
                           glaq021     LIKE glaq_t.glaq021,  
                           glaq022     LIKE glaq_t.glaq022,  
                           glaq023     LIKE glaq_t.glaq023,  
                           glaq024     LIKE glaq_t.glaq024,  
                           glaq025     LIKE glaq_t.glaq025,  
                           glaq027     LIKE glaq_t.glaq027,  
                           glaq028     LIKE glaq_t.glaq028,  
                           glaq051     LIKE glaq_t.glaq051,  #經營方式
                           glaq052     LIKE glaq_t.glaq052,  #渠道 
                           glaq053     LIKE glaq_t.glaq053,  #品牌
                           glaq029     LIKE glaq_t.glaq029,  
                           glaq030     LIKE glaq_t.glaq030,  
                           glaq031     LIKE glaq_t.glaq031,  
                           glaq032     LIKE glaq_t.glaq032,  
                           glaq033     LIKE glaq_t.glaq033,  
                           glaq034     LIKE glaq_t.glaq034,  
                           glaq035     LIKE glaq_t.glaq035,  
                           glaq036     LIKE glaq_t.glaq036,  
                           glaq037     LIKE glaq_t.glaq037,  
                           glaq038     LIKE glaq_t.glaq038,   
                           glbc004     LIKE glbc_t.glbc004,  #现金变动码
                           d           LIKE glaq_t.glaq003,  
                           c           LIKE glaq_t.glaq004,  
                           qty         LIKE glaq_t.glaq008,  
                           sum         LIKE glaq_t.glaq010,
                           glaq039     LIKE glaq_t.glaq039,
                           glaq040     LIKE glaq_t.glaq040,
                           glaq041     LIKE glaq_t.glaq041,
                           glaq042     LIKE glaq_t.glaq042,
                           glaq043     LIKE glaq_t.glaq043,
                           glaq044     LIKE glaq_t.glaq044,
                           seq         LIKE glaq_t.glaqseq,
                           source      LIKE type_t.chr100,
                           glaqseq     LIKE glaq_t.glaqseq,
                           xrca039     LIKE xrca_t.xrca039,
                           b_glaq021   LIKE glaq_t.glaq021,
                           b_glaq022   LIKE glaq_t.glaq022,
                           red         LIKE type_t.chr1       #红冲否(待抵单使用) #20150612 add lujh                           
                           END RECORD
   WHENEVER ERROR CONTINUE    

   LET r_success = FALSE                        
   INITIALIZE l_tmp.* TO NULL
   
   SELECT glaa004,glaa005 INTO l_glaa004,l_glaa005 
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald = p_xrdald
   
   LET l_glac016 = ''

   CASE p_type
        WHEN '1'  #借
               FOREACH s_voucher_gen_ar_3_cs2 USING p_xrdadocno INTO l_tmp.*,l_xrce015,l_xrde002,l_xrde013,l_xrde108,l_xrde118,l_xrde007   #160509-00004#80 add l_xrde108,l_xrde118,l_xrde007 lujh
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'foreach s_voucher_gen_ar_3_cs2'
                      LET g_errparam.popup = TRUE
                      CALL cl_err()

                      RETURN r_success
                   END IF
                      
                   #160509-00004#80--add--str--lujh
                   IF cl_null(l_xrde108) THEN LET l_xrde108 = 0 END IF
                   IF cl_null(l_xrde118) THEN LET l_xrde118 = 0 END IF
                   
#                   IF g_prog = 'axrt800' THEN   #170301-00030#8 by 09257 --mark 
                   IF g_prog MATCHES 'axrt800*' THEN   #170301-00030#8 by 09257 --add    
                      LET l_tmp.d = l_tmp.d - l_xrde118
                      LET l_tmp.sum = l_tmp.sum - l_xrde108
                   END IF
                   #160509-00004#80--add--end--lujh
                   
                   IF l_xrce015 = 'C' THEN 
                      LET l_tmp.sw = '2'
                      LET l_tmp.c = l_tmp.d
                      LET l_tmp.d = 0
                      LET l_tmp.glaq041 = l_tmp.glaq040
                      LET l_tmp.glaq040 = 0
                      LET l_tmp.glaq044 = l_tmp.glaq043
                      LET l_tmp.glaq043 = 0 
                   END IF
                   
                   IF l_xrde002 = '20' OR l_xrde002 = '21' OR l_xrde002 = '22' THEN 
                      LET l_tmp.glaq021 = l_xrde013
                      LET l_tmp.glaq022 = l_xrde013
                   END IF
                   
                   #161223-00028#1--add--str--lujh
                   IF l_tmp.d = 0 AND l_tmp.c = 0 THEN 
                      CONTINUE FOREACH
                   END IF
                   #161223-00028#1--add--end--lujh

                   IF cl_null(l_tmp.glaq001) THEN
                      CALL s_axrt300_get_meno(p_xrdald,p_xrdadocno,l_tmp.seq,l_tmp.glaq002)
                         RETURNING l_success,l_memo
                      LET l_tmp.glaq001 = l_tmp.glaq001,l_memo
                      IF cl_null(l_tmp.glaq001) THEN 
                         LET l_tmp.glaq001 = ''
                      END IF
                   END IF
                   
                   #150918-00001#3--add--str--lujh
                   IF cl_null(l_tmp.glaq001) THEN
                      #                 2:摘要/账套/科目编号  /程序编号/目的字段/单据编号/单据项次1/单据项次2
                      CALL s_account_item('2',p_xrdald,l_tmp.glaq002,'axrt400','glgb001',p_xrdadocno,l_tmp.seq,'')#160927-00008#1 mod 'xrde010'-->'glgb001'   #170901-00025#1---mod --  g_prog  ---> 'axrt400'
                      RETURNING l_memo
                      IF NOT cl_null(l_memo) THEN
                         LET l_tmp.glaq001 = l_memo
                      END IF
                   END IF
                   #150918-00001#3--add--end--lujh
                   
                   CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
                   
                   IF cl_null(l_tmp.glbc004) AND l_glac016 = 'Y' THEN 
                      CALL s_voucher_glad006_get(p_xrdald,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glbc004
                   END IF
                   
                   CALL s_voucher_get_glas003(p_xrdald,l_tmp.glaq002) 
                   RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                             l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                             l_glaq035,l_glaq036,l_glaq037,l_glaq038
                             
                   IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
                   IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
                   IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
                   IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
                   IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
                   IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
                   IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
                   IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
                   IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
                   IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
                   IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
                   IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
                   IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
                   IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
                   IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
                   IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
                   IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
                   IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
                   IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
                   IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF

                   INSERT INTO s_vr_tmp04 VALUES(l_tmp.*)  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'insert s_vr_tmp04'  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                      LET g_errparam.popup = TRUE
                      CALL cl_err()

                      RETURN r_success                   
                   END IF               
               END FOREACH          
        WHEN '2' #贷
               FOREACH s_voucher_gen_ar_3_cs3 USING p_xrdadocno INTO l_tmp.*,l_xrce015,l_xrce002,l_xrce003,l_xrce004,l_xrce055   #160509-00004#80 add xrce003,xrce004,xrce055 lujh
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'foreach s_voucher_gen_ar_3_cs3'
                      LET g_errparam.popup = TRUE
                      CALL cl_err()

                      RETURN r_success
                   END IF   
                   
                   #160509-00004#80--add--str--lujh   
#                   IF g_prog = 'axrt800' THEN    #170301-00030#8 by 09257 --mark
                   IF g_prog MATCHES 'axrt800*' THEN    #170301-00030#8 by 09257 --add
                      SELECT stae013 INTO l_stae013
                        FROM stae_t
                       WHERE staeent = g_enterprise
                         AND stae001 = l_xrce055
                         
                      SELECT stbc060 INTO l_stbc060
                        FROM stbc_t
                       WHERE stbcent = g_enterprise
                         AND stbc004 = l_xrce003
                         AND stbc005 = l_xrce004
                         
                      IF l_stae013 = '2' THEN           
                         SELECT ooef024 INTO l_tmp.glaq021
                           FROM ooef_t
                          WHERE ooefent = g_enterprise
                            AND ooef001 = l_stbc060
                            
                         LET l_tmp.glaq022 = l_tmp.glaq021
                      END IF
                      
                      IF l_stae013 = '3' THEN 
                         LET l_tmp.glaq021 = l_stbc060
                         LET l_tmp.glaq022 = l_tmp.glaq021
                      END IF
                   END IF
                   #160509-00004#80--add--end--lujh 
                   
                   IF l_xrce015 = 'D' THEN 
                      LET l_tmp.sw = '1'
                      LET l_tmp.d = l_tmp.c
                      LET l_tmp.c = 0
                      LET l_tmp.glaq040 = l_tmp.glaq041
                      LET l_tmp.glaq041 = 0
                      LET l_tmp.glaq043 = l_tmp.glaq044
                      LET l_tmp.glaq044 = 0
                   END IF
                   
                   #161223-00028#1--add--str--lujh
                   IF l_tmp.d = 0 AND l_tmp.c = 0 THEN 
                      CONTINUE FOREACH
                   END IF
                   #161223-00028#1--add--end--lujh
                   
                   #150918-00001#3--add--str--lujh
                   IF cl_null(l_tmp.glaq001) THEN
                      #                 2:摘要/账套/科目编号  /程序编号/目的字段/单据编号/单据项次1/单据项次2
                      CALL s_account_item('2',p_xrdald,l_tmp.glaq002,'axrt400','glgb001',p_xrdadocno,l_tmp.seq,'')#160927-00008#1 mod 'xrce010'-->'glgb001'    #170901-00025#1---mod --  g_prog  ---> 'axrt400'
                      RETURNING l_memo
                      IF NOT cl_null(l_memo) THEN
                         LET l_tmp.glaq001 = l_memo
                      END IF
                   END IF
                   #150918-00001#3--add--end--lujh

                   IF l_xrce002 = '30' OR l_xrce002 = '31' THEN
                      SELECT xrce003 INTO l_xrcadocno FROM xrce_t WHERE xrceent = g_enterprise
                         AND xrceld = p_xrdald
                         AND xrcedocno = p_xrdadocno
                         AND xrceseq = l_tmp.seq
                      IF cl_null(l_tmp.glaq001) THEN
                         CALL s_axrt300_get_meno(p_xrdald,l_xrcadocno,l_tmp.seq,l_tmp.glaq002)
                            RETURNING l_success,l_memo
                         LET l_tmp.glaq001 = l_tmp.glaq001,l_memo
                         IF cl_null(l_tmp.glaq001) THEN 
                            LET l_tmp.glaq001 = ''
                         END IF
                      END IF
                   END IF
                   
                   CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
                   
                   IF cl_null(l_tmp.glbc004) AND l_glac016 = 'Y' THEN 
                      CALL s_voucher_glad006_get(p_xrdald,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glbc004
                   END IF
                   
                   CALL s_voucher_get_glas003(p_xrdald,l_tmp.glaq002) 
                   RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                             l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                             l_glaq035,l_glaq036,l_glaq037,l_glaq038
                             
                   IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
                   IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
                   IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
                   IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
                   IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
                   IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
                   IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
                   IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
                   IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
                   IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
                   IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
                   IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
                   IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
                   IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
                   IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
                   IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
                   IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
                   IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
                   IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
                   IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF

                   INSERT INTO s_vr_tmp04 VALUES(l_tmp.*)  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'insert s_vr_tmp04'  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                      LET g_errparam.popup = TRUE
                      CALL cl_err()

                      RETURN r_success                   
                   END IF               
               END FOREACH  
        #160509-00004#80--add--str--lujh               
        WHEN '3'  #借
               FOREACH s_voucher_gen_ar_3_cs2 USING p_xrdadocno INTO l_tmp.*,l_xrce015,l_xrde002,l_xrde013,l_xrde108,l_xrde118,l_xrde007   #160509-00004#80 add l_xrde108,l_xrde118,l_xrde007 lujh
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'foreach s_voucher_gen_ar_3_cs2'
                      LET g_errparam.popup = TRUE
                      CALL cl_err()

                      RETURN r_success
                   END IF
                   
                   IF cl_null(l_xrde108) THEN LET l_xrde108 = 0 END IF
                   IF cl_null(l_xrde118) THEN LET l_xrde118 = 0 END IF
                   
                   LET l_tmp.d = l_xrde118
                   LET l_tmp.sum = l_xrde108
                   
                   SELECT glab005 INTO l_tmp.glaq002
                     FROM glab_t
                    WHERE glabent = g_enterprise
                      AND glabld = p_xrdald
                      AND glab001 = '13'
                      AND glab002 = '6736'
                      AND glab003 = '15'
                      
                   SELECT ooie040 INTO l_tmp.glaq018
                     FROM ooie_t
                    WHERE ooieent = g_enterprise
                      AND ooiesite = l_tmp.glaq017
                      AND ooie001 = l_xrde007
                      
                   IF l_xrce015 = 'C' THEN 
                      LET l_tmp.sw = '2'
                      LET l_tmp.c = l_tmp.d
                      LET l_tmp.d = 0
                      LET l_tmp.glaq041 = l_tmp.glaq040
                      LET l_tmp.glaq040 = 0
                      LET l_tmp.glaq044 = l_tmp.glaq043
                      LET l_tmp.glaq043 = 0 
                   END IF
                   
                   IF l_xrde002 = '20' OR l_xrde002 = '21' OR l_xrde002 = '22' THEN 
                      LET l_tmp.glaq021 = l_xrde013
                      LET l_tmp.glaq022 = l_xrde013
                   END IF
                   
                   #161223-00028#1--add--str--lujh
                   IF l_tmp.d = 0 AND l_tmp.c = 0 THEN 
                      CONTINUE FOREACH
                   END IF
                   #161223-00028#1--add--end--lujh

                   IF cl_null(l_tmp.glaq001) THEN
                      CALL s_axrt300_get_meno(p_xrdald,p_xrdadocno,l_tmp.seq,l_tmp.glaq002)
                         RETURNING l_success,l_memo
                      LET l_tmp.glaq001 = l_tmp.glaq001,l_memo
                      IF cl_null(l_tmp.glaq001) THEN 
                         LET l_tmp.glaq001 = ''
                      END IF
                   END IF
                   
                   #150918-00001#3--add--str--lujh
                   IF cl_null(l_tmp.glaq001) THEN
                      #                 2:摘要/账套/科目编号  /程序编号/目的字段/单据编号/单据项次1/单据项次2
                      CALL s_account_item('2',p_xrdald,l_tmp.glaq002,'axrt400','glgb001',p_xrdadocno,l_tmp.seq,'')#160927-00008#1 mod 'xrde010'-->'glgb001'  #170901-00025#1---mod --  g_prog  ---> 'axrt400'  
                      RETURNING l_memo
                      IF NOT cl_null(l_memo) THEN
                         LET l_tmp.glaq001 = l_memo
                      END IF
                   END IF
                   #150918-00001#3--add--end--lujh
                   
                   CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
                   
                   IF cl_null(l_tmp.glbc004) AND l_glac016 = 'Y' THEN 
                      CALL s_voucher_glad006_get(p_xrdald,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glbc004
                   END IF
                   
                   CALL s_voucher_get_glas003(p_xrdald,l_tmp.glaq002) 
                   RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                             l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                             l_glaq035,l_glaq036,l_glaq037,l_glaq038
                             
                   IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
                   IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
                   IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
                   IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
                   IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
                   IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
                   IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
                   IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
                   IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
                   IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
                   IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
                   IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
                   IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
                   IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
                   IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
                   IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
                   IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
                   IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
                   IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
                   IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF

                   INSERT INTO s_vr_tmp04 VALUES(l_tmp.*)  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = SQLCA.sqlcode
                      LET g_errparam.extend = 'insert s_vr_tmp04'  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                      LET g_errparam.popup = TRUE
                      CALL cl_err()

                      RETURN r_success                   
                   END IF               
               END FOREACH 
       #160509-00004#80--add--end--lujh               
   END CASE
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 应收立帐自动产生凭证
# Memo...........:
# Usage..........: CALL s_voucher_gen_ar_4(p_ld,p_sum_type,p_wc)
#                       RETURNING r_success,g_glaq
# Input parameter: p_ld           帐套
#                : p_sum_type     汇总方式 
#                : p_wc           QBE条件(帐款来源)
# Return code....: r_success      成功否标识位
#                : g_glaq         傳票底稿清單
# Date & Author..: 2014/05/05 By Zhangwei
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_4(p_ld,p_sum_type,p_wc,p_date)
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE p_date          LIKE type_t.dat
   DEFINE p_sum_type      LIKE type_t.chr1
   DEFINE p_wc            LIKE type_t.chr1000
   DEFINE r_success       LIKE type_t.num5
   #161128-00061#7---add---begin-----------
   #DEFINE l_xrca          RECORD LIKE xrca_t.*
   DEFINE l_xrca RECORD  #應收憑單單頭
       xrcaent LIKE xrca_t.xrcaent, #企業編號
       xrcaownid LIKE xrca_t.xrcaownid, #資料所有者
       xrcaowndp LIKE xrca_t.xrcaowndp, #資料所屬部門
       xrcacrtid LIKE xrca_t.xrcacrtid, #資料建立者
       xrcacrtdp LIKE xrca_t.xrcacrtdp, #資料建立部門
       xrcacrtdt LIKE xrca_t.xrcacrtdt, #資料創建日
       xrcamodid LIKE xrca_t.xrcamodid, #資料修改者
       xrcamoddt LIKE xrca_t.xrcamoddt, #最近修改日
       xrcacnfid LIKE xrca_t.xrcacnfid, #資料確認者
       xrcacnfdt LIKE xrca_t.xrcacnfdt, #資料確認日
       xrcapstid LIKE xrca_t.xrcapstid, #資料過帳者
       xrcapstdt LIKE xrca_t.xrcapstdt, #資料過帳日
       xrcastus LIKE xrca_t.xrcastus, #狀態碼
       xrcacomp LIKE xrca_t.xrcacomp, #法人
       xrcald LIKE xrca_t.xrcald, #帳套
       xrcadocno LIKE xrca_t.xrcadocno, #應收帳款單號碼
       xrcadocdt LIKE xrca_t.xrcadocdt, #帳款日期
       xrca001 LIKE xrca_t.xrca001, #帳款單性質
       xrcasite LIKE xrca_t.xrcasite, #帳務中心
       xrca003 LIKE xrca_t.xrca003, #帳務人員
       xrca004 LIKE xrca_t.xrca004, #帳款客戶編號
       xrca005 LIKE xrca_t.xrca005, #收款客戶
       xrca006 LIKE xrca_t.xrca006, #客戶分類
       xrca007 LIKE xrca_t.xrca007, #帳款類別
       xrca008 LIKE xrca_t.xrca008, #收款條件編號
       xrca009 LIKE xrca_t.xrca009, #應收款日/應扣抵日
       xrca010 LIKE xrca_t.xrca010, #容許票據到期日
       xrca011 LIKE xrca_t.xrca011, #稅別
       xrca012 LIKE xrca_t.xrca012, #稅率
       xrca013 LIKE xrca_t.xrca013, #含稅否
       xrca014 LIKE xrca_t.xrca014, #人員編號
       xrca015 LIKE xrca_t.xrca015, #部門編號
       xrca016 LIKE xrca_t.xrca016, #來源作業類型
       xrca017 LIKE xrca_t.xrca017, #產生方式
       xrca018 LIKE xrca_t.xrca018, #來源參考單號
       xrca019 LIKE xrca_t.xrca019, #系統產生對應單號(待抵帳款-預收)
       xrca020 LIKE xrca_t.xrca020, #信用狀申請流程否
       xrca021 LIKE xrca_t.xrca021, #商業發票號碼(IV no.)
       xrca022 LIKE xrca_t.xrca022, #出口報單號碼
       xrca023 LIKE xrca_t.xrca023, #發票客戶編號
       xrca024 LIKE xrca_t.xrca024, #發票客戶統一編號
       xrca025 LIKE xrca_t.xrca025, #發票客戶全名
       xrca026 LIKE xrca_t.xrca026, #發票客戶地址
       xrca028 LIKE xrca_t.xrca028, #發票類型
       xrca029 LIKE xrca_t.xrca029, #發票匯率
       xrca030 LIKE xrca_t.xrca030, #發票應開未稅金額
       xrca031 LIKE xrca_t.xrca031, #發票應開稅額
       xrca032 LIKE xrca_t.xrca032, #發票應開含稅金額
       xrca033 LIKE xrca_t.xrca033, #專案編號
       xrca034 LIKE xrca_t.xrca034, #責任中心
       xrca035 LIKE xrca_t.xrca035, #應收(借方)科目編號
       xrca036 LIKE xrca_t.xrca036, #收入(貸方)科目編號
       xrca037 LIKE xrca_t.xrca037, #分錄傳票產生否
       xrca038 LIKE xrca_t.xrca038, #拋轉傳票號碼
       xrca039 LIKE xrca_t.xrca039, #會計檢核附件份數
       xrca040 LIKE xrca_t.xrca040, #留置否
       xrca041 LIKE xrca_t.xrca041, #留置理由碼
       xrca042 LIKE xrca_t.xrca042, #留置設定日期
       xrca043 LIKE xrca_t.xrca043, #留置解除日期
       xrca044 LIKE xrca_t.xrca044, #留置原幣金額
       xrca045 LIKE xrca_t.xrca045, #留置說明
       xrca046 LIKE xrca_t.xrca046, #關係人否
       xrca047 LIKE xrca_t.xrca047, #多角序號
       xrca048 LIKE xrca_t.xrca048, #集團代收/代付單號
       xrca049 LIKE xrca_t.xrca049, #來源營運中心編號
       xrca050 LIKE xrca_t.xrca050, #交易原始單據份數
       xrca051 LIKE xrca_t.xrca051, #作廢理由碼
       xrca052 LIKE xrca_t.xrca052, #列印次數
       xrca053 LIKE xrca_t.xrca053, #備註
       xrca054 LIKE xrca_t.xrca054, #多帳期設定
       xrca055 LIKE xrca_t.xrca055, #繳款優惠條件
       xrca056 LIKE xrca_t.xrca056, #會計檢核附件狀態
       xrca057 LIKE xrca_t.xrca057, #交易對象識別碼
       xrca058 LIKE xrca_t.xrca058, #銷售分類
       xrca059 LIKE xrca_t.xrca059, #預算編號
       xrca060 LIKE xrca_t.xrca060, #發票開立原則
       xrca061 LIKE xrca_t.xrca061, #預計開立發票日期
       xrca062 LIKE xrca_t.xrca062, #多角性質
       xrca063 LIKE xrca_t.xrca063, #整帳批序號
       xrca064 LIKE xrca_t.xrca064, #訂金序次
       xrca065 LIKE xrca_t.xrca065, #發票編號
       xrca066 LIKE xrca_t.xrca066, #發票號碼
       xrca100 LIKE xrca_t.xrca100, #交易原幣別
       xrca101 LIKE xrca_t.xrca101, #原幣匯率
       xrca103 LIKE xrca_t.xrca103, #原幣未稅金額
       xrca104 LIKE xrca_t.xrca104, #原幣稅額
       xrca106 LIKE xrca_t.xrca106, #原幣直接折抵合計金額
       xrca107 LIKE xrca_t.xrca107, #原幣直接沖帳(調整)合計金額
       xrca108 LIKE xrca_t.xrca108, #原幣應收金額
       xrca113 LIKE xrca_t.xrca113, #本幣未稅金額
       xrca114 LIKE xrca_t.xrca114, #本幣稅額
       xrca116 LIKE xrca_t.xrca116, #本幣直接沖帳(調整)合計金額
       xrca117 LIKE xrca_t.xrca117, #本幣直接沖帳(調整)合計金額
       xrca118 LIKE xrca_t.xrca118, #本幣應收金額
       xrca120 LIKE xrca_t.xrca120, #本位幣二幣別
       xrca121 LIKE xrca_t.xrca121, #本位幣二匯率
       xrca123 LIKE xrca_t.xrca123, #本位幣二未稅金額
       xrca124 LIKE xrca_t.xrca124, #本位幣二稅額
       xrca126 LIKE xrca_t.xrca126, #本位幣二直接折抵合計金額
       xrca127 LIKE xrca_t.xrca127, #本位幣二直接沖帳(調整)合計金額
       xrca128 LIKE xrca_t.xrca128, #本位幣二應收金額
       xrca130 LIKE xrca_t.xrca130, #本位幣三幣別
       xrca131 LIKE xrca_t.xrca131, #本位幣三匯率
       xrca133 LIKE xrca_t.xrca133, #本位幣三未稅金額
       xrca134 LIKE xrca_t.xrca134, #本位幣三稅額
       xrca136 LIKE xrca_t.xrca136, #本位幣三直接折抵合計金額
       xrca137 LIKE xrca_t.xrca137, #本位幣三直接沖帳(調整)合計金額
       xrca138 LIKE xrca_t.xrca138, #本位幣三應收金額
       xrcaud001 LIKE xrca_t.xrcaud001, #自定義欄位(文字)001
       xrcaud002 LIKE xrca_t.xrcaud002, #自定義欄位(文字)002
       xrcaud003 LIKE xrca_t.xrcaud003, #自定義欄位(文字)003
       xrcaud004 LIKE xrca_t.xrcaud004, #自定義欄位(文字)004
       xrcaud005 LIKE xrca_t.xrcaud005, #自定義欄位(文字)005
       xrcaud006 LIKE xrca_t.xrcaud006, #自定義欄位(文字)006
       xrcaud007 LIKE xrca_t.xrcaud007, #自定義欄位(文字)007
       xrcaud008 LIKE xrca_t.xrcaud008, #自定義欄位(文字)008
       xrcaud009 LIKE xrca_t.xrcaud009, #自定義欄位(文字)009
       xrcaud010 LIKE xrca_t.xrcaud010, #自定義欄位(文字)010
       xrcaud011 LIKE xrca_t.xrcaud011, #自定義欄位(數字)011
       xrcaud012 LIKE xrca_t.xrcaud012, #自定義欄位(數字)012
       xrcaud013 LIKE xrca_t.xrcaud013, #自定義欄位(數字)013
       xrcaud014 LIKE xrca_t.xrcaud014, #自定義欄位(數字)014
       xrcaud015 LIKE xrca_t.xrcaud015, #自定義欄位(數字)015
       xrcaud016 LIKE xrca_t.xrcaud016, #自定義欄位(數字)016
       xrcaud017 LIKE xrca_t.xrcaud017, #自定義欄位(數字)017
       xrcaud018 LIKE xrca_t.xrcaud018, #自定義欄位(數字)018
       xrcaud019 LIKE xrca_t.xrcaud019, #自定義欄位(數字)019
       xrcaud020 LIKE xrca_t.xrcaud020, #自定義欄位(數字)020
       xrcaud021 LIKE xrca_t.xrcaud021, #自定義欄位(日期時間)021
       xrcaud022 LIKE xrca_t.xrcaud022, #自定義欄位(日期時間)022
       xrcaud023 LIKE xrca_t.xrcaud023, #自定義欄位(日期時間)023
       xrcaud024 LIKE xrca_t.xrcaud024, #自定義欄位(日期時間)024
       xrcaud025 LIKE xrca_t.xrcaud025, #自定義欄位(日期時間)025
       xrcaud026 LIKE xrca_t.xrcaud026, #自定義欄位(日期時間)026
       xrcaud027 LIKE xrca_t.xrcaud027, #自定義欄位(日期時間)027
       xrcaud028 LIKE xrca_t.xrcaud028, #自定義欄位(日期時間)028
       xrcaud029 LIKE xrca_t.xrcaud029, #自定義欄位(日期時間)029
       xrcaud030 LIKE xrca_t.xrcaud030  #自定義欄位(日期時間)030
       END RECORD

   #161128-00061#7---add--end-------------
   DEFINE l_success       LIKE type_t.num5
   DEFINE l_ac            LIKE type_t.num5
   DEFINE l_ac1           LIKE type_t.num5
   DEFINE l_docno         LIKE glaq_t.glaqdocno
   DEFINE l_glaq002       LIKE glaq_t.glaq002
   DEFINE l_field         LIKE type_t.chr1000
   DEFINE l_field1        LIKE type_t.chr1000
   DEFINE l_field2        LIKE type_t.chr1000
   DEFINE l_field3        LIKE type_t.chr1000
   DEFINE l_field4        LIKE type_t.chr1000
   DEFINE l_group_field   LIKE type_t.chr1000
   DEFINE l_xrcb022       LIKE xrcb_t.xrcb022
   DEFINE l_glad_r        RECORD 
                          glad005   LIKE glad_t.glad005,  #数量/金额管理否
                          glad007   LIKE glad_t.glad007,  #部门管理否
                          glad008   LIKE glad_t.glad008,  #利润成本管理否
                          glad009   LIKE glad_t.glad009,  #区域管理否
                          glad010   LIKE glad_t.glad010,  #交易客商管理否
                          glad011   LIKE glad_t.glad011,  #客群管理否
                          glad012   LIKE glad_t.glad012,  #产品类别管理否
                          glad013   LIKE glad_t.glad013,  #人员管理否
#                          glad014   LIKE glad_t.glad014,  #预算管理否
                          glad015   LIKE glad_t.glad015,  #专案管理否
                          glad016   LIKE glad_t.glad016,  #WBS管理否
                          glad017   LIKE glad_t.glad017,  #自由核算项1管理否
                          glad018   LIKE glad_t.glad018,  #自由核算项2管理否
                          glad019   LIKE glad_t.glad019,  #自由核算项3管理否
                          glad020   LIKE glad_t.glad020,  #自由核算项4管理否
                          glad021   LIKE glad_t.glad021,  #自由核算项5管理否
                          glad022   LIKE glad_t.glad022,  #自由核算项6管理否
                          glad023   LIKE glad_t.glad023,  #自由核算项7管理否
                          glad024   LIKE glad_t.glad024,  #自由核算项8管理否
                          glad025   LIKE glad_t.glad025,  #自由核算项9管理否
                          glad026   LIKE glad_t.glad026,  #自由核算项10管理否   
                          glad027   LIKE glad_t.glad027,  #账款客商管理否
                          glad031   LIKE glad_t.glad031,  #經營方式管理否
                          glad032   LIKE glad_t.glad032,  #渠道管理否
                          glad033   LIKE glad_t.glad033   #品牌管理否
                          END RECORD
   DEFINE l_tmp            RECORD 
                           docno       LIKE glaq_t.glaqdocno,
                           docdt       LIKE glap_t.glapdocdt,
                           sw          LIKE type_t.chr1,     
                           glaqent     LIKE glaq_t.glaqent,  
                           glaqcomp    LIKE glaq_t.glaqcomp, 
                           glaqld      LIKE glaq_t.glaqld,   
                           glaq001     LIKE glaq_t.glaq001,  
                           glaq002     LIKE glaq_t.glaq002,  
                           glaq005     LIKE glaq_t.glaq005,  
                           glaq006     LIKE glaq_t.glaq006,  
                           glaq007     LIKE glaq_t.glaq007,  
                           glaq009     LIKE glaq_t.glaq009,  
                           glaq011     LIKE glaq_t.glaq011,  
                           glaq012     LIKE glaq_t.glaq012,  
                           glaq013     LIKE glaq_t.glaq013,  
                           glaq014     LIKE glaq_t.glaq014,  
                           glaq015     LIKE glaq_t.glaq015,  
                           glaq016     LIKE glaq_t.glaq016,  
                           glaq017     LIKE glaq_t.glaq017,  
                           glaq018     LIKE glaq_t.glaq018,  
                           glaq019     LIKE glaq_t.glaq019,  
                           glaq020     LIKE glaq_t.glaq020,  
                           glaq021     LIKE glaq_t.glaq021,  
                           glaq022     LIKE glaq_t.glaq022,  
                           glaq023     LIKE glaq_t.glaq023,  
                           glaq024     LIKE glaq_t.glaq024,  
                           glaq025     LIKE glaq_t.glaq025,  
                           #glaq026     LIKE glaq_t.glaq026,    #no use 
                           glaq027     LIKE glaq_t.glaq027,  
                           glaq028     LIKE glaq_t.glaq028, 
                           glaq051     LIKE glaq_t.glaq051,  #經營方式
                           glaq052     LIKE glaq_t.glaq052,  #渠道 
                           glaq053     LIKE glaq_t.glaq053,  #品牌                           
                           glaq029     LIKE glaq_t.glaq029,  
                           glaq030     LIKE glaq_t.glaq030,  
                           glaq031     LIKE glaq_t.glaq031,  
                           glaq032     LIKE glaq_t.glaq032,  
                           glaq033     LIKE glaq_t.glaq033,  
                           glaq034     LIKE glaq_t.glaq034,  
                           glaq035     LIKE glaq_t.glaq035,  
                           glaq036     LIKE glaq_t.glaq036,  
                           glaq037     LIKE glaq_t.glaq037,  
                           glaq038     LIKE glaq_t.glaq038,   
                           d           LIKE glaq_t.glaq003,  
                           c           LIKE glaq_t.glaq004,  
                           qty         LIKE glaq_t.glaq008,  
                           sum         LIKE glaq_t.glaq010,
                           glaq039     LIKE glaq_t.glaq039,
                           glaq040     LIKE glaq_t.glaq040,
                           glaq041     LIKE glaq_t.glaq041,
                           glaq042     LIKE glaq_t.glaq042,
                           glaq043     LIKE glaq_t.glaq043,
                           glaq044     LIKE glaq_t.glaq044,
                           seq         LIKE glaq_t.glaqseq,
                           source      LIKE type_t.chr100,
                           glaqseq     LIKE glaq_t.glaqseq,
                           xrca039     LIKE xrca_t.xrca039,
                           b_glaq021   LIKE glaq_t.glaq021,
                           b_glaq022   LIKE glaq_t.glaq022,
                           red         LIKE type_t.chr1       #红冲否(待抵单使用) #20150612 add lujh                              
                           END RECORD

   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE

   #IF p_sum_type NOT MATCHES '[123]' THEN
   #   #产生凭证的汇总方式仅可为1或2或3
   #   INITIALIZE g_errparam TO NULL
   #   LET g_errparam.code = 'agl-00124'
   #   LET g_errparam.extend = ''
   #   LET g_errparam.popup = TRUE
   #   CALL cl_err()
   #
   #   RETURN r_success
   #END IF

   DELETE FROM s_vr_tmp04;     #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
   DELETE FROM s_vr_tmp05;   #160727-00019#36   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_ar_group ——> s_vr_tmp05
   DELETE FROM s_voucher_glbc;

   #1.定义CURSOR
   CALL s_voucher_gen_ar_2_def_cursor(p_ld,p_wc,p_sum_type,p_date) RETURNING l_success
   IF NOT l_success THEN
      RETURN r_success
   END IF

   #2.插入临时表
   #yangtt  mark---重評價時，不需抓來源資料值，故此處插入臨時表段mark
#   FOREACH s_voucher_gen_ar_4_cs2 INTO l_tmp.*,l_xrcb022
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 'foreach s_voucher_gen_ar_4_cs2'
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#
#         RETURN r_success
#      END IF
#      INSERT INTO s_voucher_ar_tmp VALUES(l_tmp.*)
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 'insert s_voucher_ar_tmp'
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#
#         RETURN r_success
#      END IF
#   END FOREACH
#
#   FOREACH s_voucher_gen_ar_4_cs3 INTO l_tmp.*,l_xrcb022
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 'foreach s_voucher_gen_ar_4_cs2'
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#
#         RETURN r_success
#      END IF
#      INSERT INTO s_voucher_ar_tmp VALUES(l_tmp.*)
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 'insert s_voucher_ar_tmp'
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#
#         RETURN r_success
#      END IF
#   END FOREACH
   #yangtt  mark---重評價時，不需抓來源資料值，故此處插入臨時表段mark

   FOREACH s_voucher_gen_ar_4_cs4 INTO l_tmp.*,l_xrcb022
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach s_voucher_gen_ar_4_cs2'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF
      INSERT INTO s_vr_tmp04 VALUES(l_tmp.*)  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'insert s_vr_tmp04'  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF
   END FOREACH

   FOREACH s_voucher_gen_ar_4_cs5 INTO l_tmp.*,l_xrcb022
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach s_voucher_gen_ar_4_cs2'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF
      INSERT INTO s_vr_tmp04 VALUES(l_tmp.*)  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'insert s_vr_tmp04'  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF
   END FOREACH

   #3.按科目设置进行UPDATE,若有做不管理的字段,UPDATE至' '
   CALL s_voucher_gen_ar_2_upd_tmp(p_ld) 
        RETURNING l_success
   IF NOT l_success THEN
      RETURN r_success    
   END IF

   LET r_success = TRUE

   RETURN r_success

END FUNCTION
################################################################################
# Descriptions...: 自动产生凭证-建立临时表
# Memo...........:
# Usage..........: CALL s_voucher_cre_nm_tmp_table()
#                  RETURNING r_success
# Input parameter: 
# Return code....: r_success      临时表建立成功否
# Date & Author..: 2014/07/04 By lujh
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_cre_nm_tmp_table()
   DEFINE r_success       LIKE type_t.num5
   
   WHENEVER ERROR CONTINUE
   LET r_success = FALSE
 
   DROP TABLE s_vr_tmp06;  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
   CREATE TEMP TABLE s_vr_tmp06(  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
   docno    LIKE glaq_t.glaqdocno,
   docdt    LIKE glap_t.glapdocdt, 
   sw       LIKE type_t.chr1,   
   glaqent  LIKE glaq_t.glaqent,
   glaqcomp LIKE glaq_t.glaqcomp,
   glaqld   LIKE glaq_t.glaqld,
   glaq001  LIKE glaq_t.glaq001,
   glaq002  LIKE glaq_t.glaq002,
   glaq005  LIKE glaq_t.glaq005,  #幣別
   glaq006  LIKE glaq_t.glaq006,  #匯率
   glaq007  LIKE glaq_t.glaq007,
   glaq009  LIKE glaq_t.glaq009,
   glaq010  LIKE glaq_t.glaq010,  #原幣金額
   glaq011  LIKE glaq_t.glaq011,
   glaq012  LIKE glaq_t.glaq012,
   glaq013  LIKE glaq_t.glaq013,
   glaq014  LIKE glaq_t.glaq014,
   glaq015  LIKE glaq_t.glaq015,
   glaq016  LIKE glaq_t.glaq016,   
   glaq017  LIKE glaq_t.glaq017,
   glaq018  LIKE glaq_t.glaq018,
   glaq019  LIKE glaq_t.glaq019,
   glaq020  LIKE glaq_t.glaq020,
   glaq021  LIKE glaq_t.glaq021,
   glaq022  LIKE glaq_t.glaq022,
   glaq023  LIKE glaq_t.glaq023,
   glaq024  LIKE glaq_t.glaq024,
   glaq025  LIKE glaq_t.glaq025,
   #glaq026  LIKE glaq_t.glaq026, #151111-00001#1 mark lujh
   glaq027  LIKE glaq_t.glaq027,
   glaq028  LIKE glaq_t.glaq028,
   glaq051  LIKE glaq_t.glaq051,  #經營方式
   glaq052  LIKE glaq_t.glaq052,  #渠道 
   glaq053  LIKE glaq_t.glaq053,  #品牌
   glaq029  LIKE glaq_t.glaq029,
   glaq030  LIKE glaq_t.glaq030,
   glaq031  LIKE glaq_t.glaq031,
   glaq032  LIKE glaq_t.glaq032,
   glaq033  LIKE glaq_t.glaq033,
   glaq034  LIKE glaq_t.glaq034,
   glaq035  LIKE glaq_t.glaq035,
   glaq036  LIKE glaq_t.glaq036,
   glaq037  LIKE glaq_t.glaq037,
   glaq038  LIKE glaq_t.glaq038,
   d        LIKE glaq_t.glaq003,
   c        LIKE glaq_t.glaq004,
   qty      LIKE glaq_t.glaq008,
   sum      LIKE glaq_t.glaq010,
   glaq039  LIKE glaq_t.glaq039,
   glaq040  LIKE glaq_t.glaq040,
   glaq041  LIKE glaq_t.glaq041,
   glaq042  LIKE glaq_t.glaq042,
   glaq043  LIKE glaq_t.glaq043,
   glaq044  LIKE glaq_t.glaq044,
   seq      LIKE glaq_t.glaqseq,
   source   LIKE type_t.chr100,
   glaqseq  LIKE glaq_t.glaqseq,
   seq2     LIKE glaq_t.glaqseq,
   glgb055  LIKE glgb_t.glgb055    #150807-00007#2 現金變動碼
   );
   
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'create'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   DROP TABLE s_vr_tmp07;  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_group ——> s_vr_tmp07
   CREATE TEMP TABLE s_vr_tmp07(  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_group ——> s_vr_tmp07
   docno    LIKE glaq_t.glaqdocno,
   docdt    LIKE glap_t.glapdocdt, 
   sw       LIKE type_t.chr1,   
   glaqent  LIKE glaq_t.glaqent,
   glaqcomp LIKE glaq_t.glaqcomp,
   glaqld   LIKE glaq_t.glaqld,
   glaq001  LIKE glaq_t.glaq001,
   glaq002  LIKE glaq_t.glaq002,
   glaq005  LIKE glaq_t.glaq005,
   glaq006  LIKE glaq_t.glaq006,
   glaq007  LIKE glaq_t.glaq007,
   glaq009  LIKE glaq_t.glaq009,
   glaq011  LIKE glaq_t.glaq011,
   glaq012  LIKE glaq_t.glaq012,
   glaq013  LIKE glaq_t.glaq013,
   glaq014  LIKE glaq_t.glaq014,
   glaq015  LIKE glaq_t.glaq015,
   glaq016  LIKE glaq_t.glaq016,   
   glaq017  LIKE glaq_t.glaq017,
   glaq018  LIKE glaq_t.glaq018,
   glaq019  LIKE glaq_t.glaq019,
   glaq020  LIKE glaq_t.glaq020,
   glaq021  LIKE glaq_t.glaq021,
   glaq022  LIKE glaq_t.glaq022,
   glaq023  LIKE glaq_t.glaq023,
   glaq024  LIKE glaq_t.glaq024,
   glaq025  LIKE glaq_t.glaq025,
   #glaq026  LIKE glaq_t.glaq026, #151111-00001#1 mark lujh
   glaq027  LIKE glaq_t.glaq027,
   glaq028  LIKE glaq_t.glaq028,
   glaq051  LIKE glaq_t.glaq051,  #經營方式
   glaq052  LIKE glaq_t.glaq052,  #渠道 
   glaq053  LIKE glaq_t.glaq053,  #品牌
   glaq029  LIKE glaq_t.glaq029,
   glaq030  LIKE glaq_t.glaq030,
   glaq031  LIKE glaq_t.glaq031,
   glaq032  LIKE glaq_t.glaq032,
   glaq033  LIKE glaq_t.glaq033,
   glaq034  LIKE glaq_t.glaq034,
   glaq035  LIKE glaq_t.glaq035,
   glaq036  LIKE glaq_t.glaq036,
   glaq037  LIKE glaq_t.glaq037,
   glaq038  LIKE glaq_t.glaq038,
   d        LIKE glaq_t.glaq003,
   c        LIKE glaq_t.glaq004,
   qty      LIKE glaq_t.glaq008,
   sum      LIKE glaq_t.glaq010,
   glaq039  LIKE glaq_t.glaq039,
   glaq040  LIKE glaq_t.glaq040,
   glaq041  LIKE glaq_t.glaq041,
   glaq042  LIKE glaq_t.glaq042,
   glaq043  LIKE glaq_t.glaq043,
   glaq044  LIKE glaq_t.glaq044,
   seq      LIKE glaq_t.glaqseq,
   source   LIKE type_t.chr100,
   glaqseq  LIKE glaq_t.glaqseq,
   xrca039  LIKE xrca_t.xrca039,
   glgb055  LIKE glgb_t.glgb055    #150807-00007#2 現金變動碼   
   );
   
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'create'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   DROP TABLE s_vr_tmp08;  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
   CREATE TEMP TABLE s_vr_tmp08(  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
   docno    LIKE glaq_t.glaqdocno,  #單據編號
   docdt    LIKE glap_t.glapdocdt, 
   sw       LIKE type_t.chr1,   
   glaqent  LIKE glaq_t.glaqent,
   glaqcomp LIKE glaq_t.glaqcomp,
   glaqld   LIKE glaq_t.glaqld,
   glaq001  LIKE glaq_t.glaq001,
   glaq002  LIKE glaq_t.glaq002,
   glaq005  LIKE glaq_t.glaq005,  #幣別
   glaq006  LIKE glaq_t.glaq006,  #匯率
   glaq007  LIKE glaq_t.glaq007,
   glaq009  LIKE glaq_t.glaq009,
   glaq010  LIKE glaq_t.glaq010,  #原幣金額
   glaq011  LIKE glaq_t.glaq011,
   glaq012  LIKE glaq_t.glaq012,
   glaq013  LIKE glaq_t.glaq013,
   glaq014  LIKE glaq_t.glaq014,
   glaq015  LIKE glaq_t.glaq015,
   glaq016  LIKE glaq_t.glaq016,   
   glaq017  LIKE glaq_t.glaq017,
   glaq018  LIKE glaq_t.glaq018,
   glaq019  LIKE glaq_t.glaq019,
   glaq020  LIKE glaq_t.glaq020,
   glaq021  LIKE glaq_t.glaq021,
   glaq022  LIKE glaq_t.glaq022,
   glaq023  LIKE glaq_t.glaq023,
   glaq024  LIKE glaq_t.glaq024,
   glaq025  LIKE glaq_t.glaq025,
  #glaq026  LIKE glaq_t.glaq026,  #151112-00009#3 mark
   glaq027  LIKE glaq_t.glaq027,
   glaq028  LIKE glaq_t.glaq028,
   glaq051  LIKE glaq_t.glaq051,  #經營方式
   glaq052  LIKE glaq_t.glaq052,  #渠道 
   glaq053  LIKE glaq_t.glaq053,  #品牌
   glaq029  LIKE glaq_t.glaq029,
   glaq030  LIKE glaq_t.glaq030,
   glaq031  LIKE glaq_t.glaq031,
   glaq032  LIKE glaq_t.glaq032,
   glaq033  LIKE glaq_t.glaq033,
   glaq034  LIKE glaq_t.glaq034,
   glaq035  LIKE glaq_t.glaq035,
   glaq036  LIKE glaq_t.glaq036,
   glaq037  LIKE glaq_t.glaq037,
   glaq038  LIKE glaq_t.glaq038,
   d        LIKE glaq_t.glaq003,
   c        LIKE glaq_t.glaq004,
   qty      LIKE glaq_t.glaq008,
   sum      LIKE glaq_t.glaq010,
   glaq039  LIKE glaq_t.glaq039,
   glaq040  LIKE glaq_t.glaq040,
   glaq041  LIKE glaq_t.glaq041,
   glaq042  LIKE glaq_t.glaq042,
   glaq043  LIKE glaq_t.glaq043,
   glaq044  LIKE glaq_t.glaq044,
   seq      LIKE glaq_t.glaqseq,  #項次一
   source   LIKE type_t.chr100,
   glaqseq  LIKE glaq_t.glaqseq,
   seq2     LIKE glaq_t.glaqseq,  #項次二
   state    LIKE type_t.chr1,     #單據性質
   year1    LIKE type_t.num5,     #年度
   month1   LIKE type_t.num5,     #期別
   xrca039  LIKE xrca_t.xrca039,  #會計檢核附件份數 #150429-00010#14
   glgb055  LIKE glgb_t.glgb055   #現金變動碼      #150429-00010#14
   );
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'create'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   
   #151203-00013#3 --s mark
   ##150825-00004#9 add ------
   #DROP TABLE s_voucher_fm_group;
   #CREATE TEMP TABLE s_voucher_fm_group(
   #docno    LIKE glaq_t.glaqdocno,  #單據編號
   #docdt    LIKE glap_t.glapdocdt, 
   #sw       LIKE type_t.chr1,   
   #glaqent  LIKE glaq_t.glaqent,
   #glaqcomp LIKE glaq_t.glaqcomp,
   #glaqld   LIKE glaq_t.glaqld,
   #glaq001  LIKE glaq_t.glaq001,
   #glaq002  LIKE glaq_t.glaq002,
   #glaq005  LIKE glaq_t.glaq005,  #幣別
   #glaq006  LIKE glaq_t.glaq006,  #匯率
   #glaq007  LIKE glaq_t.glaq007,
   #glaq009  LIKE glaq_t.glaq009,
   #glaq011  LIKE glaq_t.glaq011,
   #glaq012  LIKE glaq_t.glaq012,
   #glaq013  LIKE glaq_t.glaq013,
   #glaq014  LIKE glaq_t.glaq014,
   #glaq015  LIKE glaq_t.glaq015,
   #glaq016  LIKE glaq_t.glaq016,   
   #glaq017  LIKE glaq_t.glaq017,
   #glaq018  LIKE glaq_t.glaq018,
   #glaq019  LIKE glaq_t.glaq019,
   #glaq020  LIKE glaq_t.glaq020,
   #glaq021  LIKE glaq_t.glaq021,
   #glaq022  LIKE glaq_t.glaq022,
   #glaq023  LIKE glaq_t.glaq023,
   #glaq024  LIKE glaq_t.glaq024,
   #glaq025  LIKE glaq_t.glaq025,
  ##glaq026  LIKE glaq_t.glaq026,  #151112-00009#3 mark
   #glaq027  LIKE glaq_t.glaq027,
   #glaq028  LIKE glaq_t.glaq028,
   #glaq051  LIKE glaq_t.glaq051,  #經營方式
   #glaq052  LIKE glaq_t.glaq052,  #渠道 
   #glaq053  LIKE glaq_t.glaq053,  #品牌
   #glaq029  LIKE glaq_t.glaq029,
   #glaq030  LIKE glaq_t.glaq030,
   #glaq031  LIKE glaq_t.glaq031,
   #glaq032  LIKE glaq_t.glaq032,
   #glaq033  LIKE glaq_t.glaq033,
   #glaq034  LIKE glaq_t.glaq034,
   #glaq035  LIKE glaq_t.glaq035,
   #glaq036  LIKE glaq_t.glaq036,
   #glaq037  LIKE glaq_t.glaq037,
   #glaq038  LIKE glaq_t.glaq038,
   #d        LIKE glaq_t.glaq003,
   #c        LIKE glaq_t.glaq004,
   #qty      LIKE glaq_t.glaq008,
   #sum      LIKE glaq_t.glaq010,
   #glaq039  LIKE glaq_t.glaq039,
   #glaq040  LIKE glaq_t.glaq040,
   #glaq041  LIKE glaq_t.glaq041,
   #glaq042  LIKE glaq_t.glaq042,
   #glaq043  LIKE glaq_t.glaq043,
   #glaq044  LIKE glaq_t.glaq044,
   #seq      LIKE glaq_t.glaqseq,  #項次一
   #source   LIKE type_t.chr100,
   #glaqseq  LIKE glaq_t.glaqseq,
   #xrca039  LIKE xrca_t.xrca039,  #會計檢核附件份數 #150429-00010#14
   #glgb055  LIKE glgb_t.glgb055   #現金變動碼      #150429-00010#14
   #);
   #IF SQLCA.sqlcode THEN
   #   INITIALIZE g_errparam TO NULL
   #   LET g_errparam.code = SQLCA.sqlcode
   #   LET g_errparam.extend = 'create'
   #   LET g_errparam.popup = TRUE
   #   CALL cl_err()
   #   RETURN r_success
   #END IF
   ##150825-00004#9 add end---
   #151203-00013#3 --e mark
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION
# Descriptions...: 自动产生凭证 定义CURSOR
# Memo...........:
# Usage..........: CALL s_voucher_gen_nm_1_def_cursor(p_ld,p_wc)
#                  RETURNING r_success
# Input parameter: p_ld           帐套
#                : p_wc           QBE条件(帐款来源)
#                : p_sum_type     汇总方式
# Return code....: r_success      成功否标识位
# Date & Author..: 2014/07/04 By lujh
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_nm_1_def_cursor(p_ld,p_wc,p_sum_type,p_date)
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE p_wc            LIKE type_t.chr1000
   DEFINE p_sum_type      LIKE type_t.chr1
   DEFINE r_success       LIKE type_t.num5
   DEFINE l_sql           LIKE type_t.chr1000
   DEFINE l_glaa004       LIKE glaa_t.glaa004
   DEFINE l_field         LIKE type_t.chr50
   DEFINE p_date          LIKE type_t.dat
   DEFINE l_glab005d      LIKE glab_t.glab005      #借方科目
   DEFINE l_glab005c      LIKE glab_t.glab005      #贷方科目

   WHENEVER ERROR CONTINUE
   LET r_success = FALSE 

   #161128-00061#7---add---begin-----------
   #LET l_sql = "SELECT * FROM nmbs_t ",
   LET l_sql = "SELECT nmbsent,nmbssite,nmbscomp,nmbsld,nmbsdocno,nmbsdocdt,nmbs001,nmbs002,nmbs003,",
               "nmbs004,nmbsownid,nmbsowndp,nmbscrtid,nmbscrtdp,nmbscrtdt,nmbsmodid,nmbsmoddt,nmbscnfid,",
               "nmbscnfdt,nmbsstus,nmbsud001,nmbsud002,nmbsud003,nmbsud004,nmbsud005,nmbsud006,nmbsud007,",
               "nmbsud008,nmbsud009,nmbsud010,nmbsud011,nmbsud012,nmbsud013,nmbsud014,nmbsud015,nmbsud016,",
               "nmbsud017,nmbsud018,nmbsud019,nmbsud020,nmbsud021,nmbsud022,nmbsud023,nmbsud024,nmbsud025,",
               "nmbsud026,nmbsud027,nmbsud028,nmbsud029,nmbsud030 FROM nmbs_t ",
   #161128-00061#7---add---end-----------
               " WHERE nmbsld = '",p_ld CLIPPED,"'",
               "   AND nmbs003 IS NULL ",
               "   AND nmbsent = ",g_enterprise,  #161206-00023#1 add
               "   AND ",p_wc
   PREPARE s_voucher_gen_nm_1_p FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_nm_1_p'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   DECLARE s_voucher_gen_nm_1_cs CURSOR FOR s_voucher_gen_nm_1_p
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_nm_1_cs'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF

               #单号/日期/借/企业/法人/帐套/摘要/科目
#   LET l_sql = "SELECT nmbsdocno,nmbsdocdt,'',nmbsent,nmbscomp,nmbsld,'',nmbv001,",
#   LET l_sql = "SELECT nmbsdocno,nmbsdocdt,'',nmbsent,nmbscomp,nmbsld,'','',",   #161222-00031#1 mark xul
    LET l_sql = "SELECT nmbsdocno,nmbsdocdt,'',nmbsent,nmbscomp,nmbsld,nmbt005,'',",   #161222-00031#1 add xul
               #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
               "       nmbt100,nmbt101,'','',nmbt103,nmbt011,'',nmbt013,nmbt014,'','',",
               #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
               "       nmbt017,nmbt018,nmbt019,nmbt020,nmbt021,nmbt022,nmbt023,nmbt024,nmbt025,",
               #预算编号/专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10
               #"       nmbt026,nmbt027,nmbt028,nmbt031,nmbt032,nmbt033,nmbt034,nmbt035,nmbt036,nmbt037,nmbt038,nmbt039,nmbt040,nmbt041,nmbt042,nmbt043,",   #151111-00001#1 mark lujh
               "                nmbt027,nmbt028,nmbt031,nmbt032,nmbt033,nmbt034,nmbt035,nmbt036,nmbt037,nmbt038,nmbt039,nmbt040,nmbt041,nmbt042,nmbt043,",   #151111-00001#1 add lujh
               #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
              #"       nmbt113,'','',nmbt103,nmbt121,nmbt123,'',nmbt131,nmbt133,'',nmbtseq,'nmbv','','','',nmbt002,nmbt003,nmbt029,nmbt030 ", # 添加业务单号+项次 #150918-00001#5 mark 
               "       nmbt114,'','',nmbt103,nmbt121,nmbt123,'',nmbt131,nmbt133,'',nmbtseq,'nmbv','','','',nmbt002,nmbt003,nmbt029,nmbt030 ", # 添加业务单号+项次 #150918-00001#5
#              "       nmbv113,nmbv114,'',nmbt103,nmbt121,nmbv123,nmbv124,nmbt131,nmbv133,nmbv134,nmbtseq,'nmbv','',nmbvseq2 ",
#              "  FROM nmbs_t,nmbt_t,nmbv_t ",
               #       异动别
              #"      ,nmbt004",            #150707-00001#7 mark
              #"      ,nmbt004,nmbt001 ",        #150707-00001#7 #151013-00019#2 mark
               "      ,nmbt004,nmbt001,nmbt113", #151013-00019#2               
               "  FROM nmbs_t,nmbt_t ",
               " WHERE nmbsent   = ",g_enterprise,
               "   AND nmbsld    = '",p_ld CLIPPED,"'",
               "   AND nmbsdocno = ? ",
               "   AND nmbsent   = nmbtent ",
               "   AND nmbsld    = nmbtld  ",
               "   AND nmbsdocno = nmbtdocno "
#              "   AND nmbtent   = nmbvent ",
#              "   AND nmbtld    = nmbvld ",
#              "   AND nmbtdocno = nmbvdocno ",
#              "   AND nmbtseq   = nmbvseq "
   PREPARE s_voucher_gen_nm_1_p1 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_nm_1_p1'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   DECLARE s_voucher_gen_nm_1_cs1 CURSOR FOR s_voucher_gen_nm_1_p1
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_nm_1_cs1'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   
   #抓取nmbv_t資料
   LET l_sql = " SELECT nmbvseq2,nmbv001,nmbv103,nmbv113,nmbv123,",
               "        nmbv133,nmbv017,nmbv018,nmbv019,nmbv020,",
               "        nmbv021,nmbv022,nmbv023,nmbv024,nmbv025,",
               "        nmbv026,nmbv027,nmbv028,nmbv039,nmbv040,",
               "        nmbv041,nmbv042,nmbv029,nmbv030,nmbv031,",   #150807-00007#2 add nmbv042
               "        nmbv032,nmbv033,nmbv034,nmbv035,nmbv036,",
               "        nmbv037,nmbv038,nmbv100",                    #150918-00001#5 add nmbv100
               " FROM nmbv_t",
               " WHERE nmbvld = ? AND nmbvdocno = ? AND nmbvseq = ? ",
               "   AND nmbvent = ",g_enterprise,  #161206-00023#1 add
               " ORDER BY nmbvseq2"
   PREPARE s_voucher_gen_nmbv FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_nmbv'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   DECLARE s_voucher_gen_nmbv_cs CURSOR FOR s_voucher_gen_nmbv
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_nmbv_cs'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF 
   
   #150807-00007#2 add -----str 
   #抓取glbc_t資料
   LET l_sql = " SELECT glbcseq1,glbc004,glbc008,glbc009,glbc012,glbc014",
               "   FROM glbc_t,nmbt_t ",
               "  WHERE glbcent = nmbtent AND glbcdocno = nmbt002",
               "    AND glbcld = nmbtld  ",
               "    AND glbcseq = nmbt003 ",
               "    AND nmbtld = ? AND nmbtdocno = ? AND nmbtseq = ? ",
               "    AND nmbtent = ",g_enterprise,  #161206-00023#1 add
               " ORDER BY glbcseq1"               
   PREPARE s_voucher_gen_glbc FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_glbc'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   DECLARE s_voucher_gen_glbc_cs CURSOR FOR s_voucher_gen_glbc
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_glbc_cs'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF 
   
   #科目為現金科目
   #LET l_sql = "SELECT COUNT(*) FROM glac_t ",      #170615-00061#25 mark
   LET l_sql = "SELECT COUNT(glac002) FROM glac_t ", #170615-00061#25 add
               " WHERE glacent = ",g_enterprise," AND glac001 = ? ",
               "   AND glac002 = ? AND glac016 = 'Y' "
  PREPARE s_voucher_nm_glac_chk FROM l_sql
  IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_nm_glac_chk'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   
   #抓取glbc_t資料
   #LET l_sql = " SELECT COUNT(*) FROM glbc_t,nmbt_t ",        #170615-00061#25 mark
   LET l_sql = " SELECT COUNT(glbcdocno) FROM glbc_t,nmbt_t ", #170615-00061#25 add
               "  WHERE glbcent = nmbtent AND glbcdocno = nmbt002 ",
               "    AND glbcld = nmbtld ",
               "    AND glbcseq = nmbt003 ",
               "    AND glbcent = ",g_enterprise," AND nmbtdocno = ?",
               "    AND nmbtld = ? AND nmbtseq =  ? "
   PREPARE s_voucher_nm_glbc_chk FROM l_sql
  IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_nm_glbc_chk'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   #150807-00007#2 add -----end
   
   
   #从临时表中取科目
   LET l_sql = " SELECT DISTINCT docno,glaq002 FROM s_vr_tmp06 ",  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
               "  ORDER BY docno"
   PREPARE s_voucher_gen_nm_1_p2 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_nm_1_p2'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   DECLARE s_voucher_gen_nm_1_cs2 CURSOR FOR s_voucher_gen_nm_1_p2
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_nm_1_cs2'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   
   #从agli030取科目设置
   LET l_sql = " SELECT glad005,glad007,glad008,glad009,glad010,glad011,glad012,glad013,glad015,",
               "        glad016,glad017,glad018,glad019,glad020,glad021,glad022,glad023,glad024,glad025,",
               "        glad026,glad027,glad031,glad032,glad033 ",
               "   FROM glad_t ",
               "  WHERE gladent = ",g_enterprise,
               "    AND gladld  = '",p_ld CLIPPED,"'",
               "    AND glad001 = ? "
   PREPARE s_voucher_gen_nm_1_p3 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_nm_1_p3'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   DECLARE s_voucher_gen_nm_1_cs3 CURSOR FOR s_voucher_gen_nm_1_p3
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_nm_1_cs3'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF

   LET l_sql = " SELECT UNIQUE glaqcomp,docno,docdt",
              #"   FROM s_vr_tmp06 "  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06 #170509-00094#4 mark
               "   FROM s_vr_tmp07 "  #170509-00094#4 add
   PREPARE s_voucher_gen_nm_1_p4 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_nm_1_p4'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   DECLARE s_voucher_gen_nm_1_cs4 CURSOR FOR s_voucher_gen_nm_1_p4
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_nm_1_cs4'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF

   #用于生成glaq_t资料的临时表
   #170427-00074#1--add--s--xul
   IF g_prog ='anmt470' THEN
      LET l_sql = " SELECT docno ,docdt ,sw,glaqent,glaqcomp ,glaqld,glaq001,glaq002,glaq005,glaq006 ,glaq007,glaq009 ,",
                 #"        sum ,glaq011,glaq012 ,glaq013,glaq014,glaq015,glaq016,glaq017,glaq018,glaq019 ,glaq020 , ",      #170509-00094#10 mark
                  "        glaq011,glaq012 ,glaq013,glaq014,glaq015,glaq016,glaq017,glaq018,glaq019 ,glaq020 , ",           #170509-00094#10 add
                  "        glaq021,glaq022,glaq023,glaq024,glaq025,glaq027,glaq028,glaq051,glaq052,glaq053 , glaq029  , " ,
                  "        glaq030 ,glaq031,glaq032,glaq033,glaq034,glaq035,glaq036,glaq037,glaq038,d,c,qty,sum , ",
                  "        glaq039  ,glaq040 ,glaq041 ,glaq042 ,glaq043 ,glaq044 ,seq ,source ,glaqseq ,'' ,glgb055,",                  
                  "        CASE WHEN d <> 0 THEN 1 ELSE 2 END AS dcflag  FROM s_vr_tmp07 ",
                  "  ORDER BY dcflag,glaq002,d DESC ,c DESC " 
   ELSE
   #170427-00074#1--add--e--xul
     #LET l_sql = " SELECT * FROM s_vr_tmp06 ",  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06 #170509-00094#4 mark
      LET l_sql = " SELECT * FROM s_vr_tmp07 ",  #170509-00094#4 add
                 #" ORDER BY d desc,c "          #170509-00094#10 mark
                  " ORDER BY sw,d desc,c "       #170509-00094#10                   
               
   END IF #170427-00074#1 ADD xul             
   PREPARE s_voucher_gen_nm_1_p5 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_nm_1_p5'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   DECLARE s_voucher_gen_nm_1_cs5 CURSOR FOR s_voucher_gen_nm_1_p5
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_nm_1_cs5'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   
   LET l_sql = "UPDATE nmbs_t SET nmbs003 = ?,nmbs004 = ? ",
               " WHERE nmbsent   = ",g_enterprise,
               "   AND nmbsld    = '",p_ld,"'",
               "   AND nmbsdocno = ? "
   PREPARE s_voucher_gen_nm_1_p6 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_nm_1_p6'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   
   LET g_sql = "SELECT docno,docdt,sw,glaqent,glaqcomp,glaqld,glaq001,glaq002,glaq005,",
               "       glaq006,glaq007,glaq009,glaq011,glaq012,glaq013,glaq014,glaq015,glaq016,",
               "       glaq017,glaq018,glaq019,glaq020,glaq021,glaq022,glaq023,glaq024,glaq025, ",
               "       glaq026,glaq027,glaq028,glaq029,glaq030,glaq031,glaq032,glaq033,glaq034,",
               "       glaq035,glaq036,glaq037,glaq038,d,c,qty,sum,glaq039,glaq040,glaq041,",
               "       glaq042,glaq043,glaq044,seq,source,glaqseq,xrca039 ",
               "  FROM s_vr_tmp04 "  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
   PREPARE s_voucher_gen_nm_1_p7 FROM g_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_nm_1_p7'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   DECLARE s_voucher_gen_nm_1_cs7 CURSOR FOR s_voucher_gen_nm_1_p7
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_nm_1_cs7'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF 
   
   #170509-00094#4---add---start---
   SELECT glaa004
     INTO l_glaa004
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald = p_ld
   LET l_sql = "SELECT glad002,glac008",      
               "  FROM glad_t",
               "  LEFT JOIN glac_t ON glacent = gladent AND glad001 = glac002 AND glac001 = '",l_glaa004,"'",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld = '",p_ld,"'",
               "   AND glad001 = ?"
   PREPARE s_voucher_gen_nm_glad FROM l_sql    
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_nm_glad'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF        
   #170509-00094#4---add---end--
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION
###############################################################################################################
# Descriptions...: 自动产生凭证
# Memo...........:
# Usage..........: CALL s_voucher_gen_nm(p_type,p_ld,p_date,p_slip,p_sum_type,p_wc,p_preview,p_source)
#                       RETURNING r_success,g_glaq
# Input parameter: p_type         来源类型
#                                 1.anmt530 应收票據帳務處理
#                                 
#                : p_ld           帐套
#                : p_date         立帐日期
#                : p_slip         凭证单别
#                : p_sum_type     汇总方式 
#                : p_wc           ＱＢＥ的範圍條件
#                : p_preview      是否先預覽后再拋憑證（Y/N）
#                : p_source       來源
# Return code....: r_success      成功否标识位
#                : g_glaq         傳票底稿清單
# Date & Author..: 2012/07/04 By lujh
# Modify.........:
###############################################################################################################
PUBLIC FUNCTION s_voucher_gen_nm(p_type,p_ld,p_date,p_slip,p_sum_type,p_wc,p_preview,p_source)
   DEFINE p_type          LIKE type_t.chr2
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE p_date          LIKE glap_t.glapdocdt
   DEFINE p_slip          LIKE ooba_t.ooba002
   DEFINE p_sum_type      LIKE type_t.chr1
   DEFINE p_wc            LIKE type_t.chr1000
   DEFINE p_preview       LIKE type_t.chr1
   DEFINE p_source        LIKE type_t.chr10
   DEFINE r_success       LIKE type_t.num5
   DEFINE r_start_no      LIKE glap_t.glapdocno
   DEFINE r_end_no        LIKE glap_t.glapdocno
   DEFINE l_site          LIKE ooef_t.ooef001
   DEFINE l_success       LIKE type_t.num5
   
   
   WHENEVER ERROR CONTINUE
   
   LET r_success  = FALSE
   CALL g_glaq_d.clear()

   #检查事务中
   IF NOT s_transaction_chk('Y',1) THEN
      RETURN r_success
   END IF   

   
   IF cl_null(p_ld) THEN
      #帐套参数为空
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'agl-00121'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   #检查帐套是否正确
   CALL s_ld_chk_authorization(g_user,p_ld) RETURNING l_success
   IF l_success = FALSE THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'axr-00022'
      LET g_errparam.extend = p_ld
      LET g_errparam.popup = TRUE
      CALL cl_err()
 
      RETURN r_success
   END IF 
   
   
   #检查单别CALL s_aooi200_chk_slip()
   SELECT glaacomp INTO l_site FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald  = p_ld
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'sel glaacomp'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success 
   END IF
   #CALL s_aooi200_chk_slip(l_site,'',p_slip,'aglt310')
   #     RETURNING l_success
   #IF NOT l_success THEN
   #   RETURN r_success,r_start_no,r_end_no    
   #END IF
   
   IF cl_null(p_sum_type) THEN
      #产生凭证的汇总方式为空
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'agl-00123'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success 
   END IF
   
   IF cl_null(p_wc) THEN LET p_wc = " 1=1" END IF
   
   #CALL s_voucher_cre_nm_tmp_table() RETURNING r_success
   
   CASE p_type
        WHEN '1'   #AR-應收票據帳務處理自动产生凭证
                   CALL s_voucher_gen_nm_1(p_ld,p_sum_type,p_wc,p_source)
                        RETURNING r_success
   END CASE
   
   #150807-00007#2---add ---str
   #將明細資料彙總
   CALL s_voucher_gen_nm_1_ins_group_tmp(p_ld,'1') RETURNING l_success
   IF NOT l_success THEN
      RETURN r_success,r_start_no,r_end_no    
   END IF
   #150807-00007#2---add ---end
   
   IF p_preview = 'Y' THEN   #先預覽,不產生憑證
      RETURN r_success
   ELSE                      #不預覽,直接產生憑證
      #插入凭证单头
      CALL s_voucher_gen_nm_1_ins_glap(p_slip,p_date,p_ld,p_source)
         RETURNING r_success,r_start_no,r_end_no
      IF NOT r_success THEN
         RETURN r_success,r_start_no,r_end_no       
      END IF
      RETURN r_success,r_start_no,r_end_no      
   END IF
END FUNCTION
################################################################################
# Descriptions...: 应收立帐自动产生凭证
# Memo...........:
# Usage..........: CALL s_voucher_gen_nm_1(p_ld,p_sum_type,p_wc)
#                       RETURNING r_success,g_glaq
# Input parameter: p_ld           帐套
#                : p_sum_type     汇总方式 
#                : p_wc           QBE条件(帐款来源)
#                : p_source       單據來源  
# Return code....: r_success      成功否标识位
#                : g_glaq         傳票底稿清單
# Date & Author..: 2014/07/04 By lujh
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_nm_1(p_ld,p_sum_type,p_wc,p_source)
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE p_sum_type      LIKE type_t.chr1
   DEFINE p_wc            LIKE type_t.chr1000
   DEFINE p_source        LIKE type_t.chr10
   DEFINE r_success       LIKE type_t.num5
   #161128-00061#7---add---begin-----------
   #DEFINE l_nmbs          RECORD LIKE nmbs_t.*
   DEFINE l_nmbs RECORD  #帳務底稿主檔
       nmbsent LIKE nmbs_t.nmbsent, #企業編號
       nmbssite LIKE nmbs_t.nmbssite, #帳務中心
       nmbscomp LIKE nmbs_t.nmbscomp, #法人
       nmbsld LIKE nmbs_t.nmbsld, #帳套
       nmbsdocno LIKE nmbs_t.nmbsdocno, #帳務單號
       nmbsdocdt LIKE nmbs_t.nmbsdocdt, #帳務單日期
       nmbs001 LIKE nmbs_t.nmbs001, #作業來源
       nmbs002 LIKE nmbs_t.nmbs002, #附件張數
       nmbs003 LIKE nmbs_t.nmbs003, #傳票編號
       nmbs004 LIKE nmbs_t.nmbs004, #傳票日期
       nmbsownid LIKE nmbs_t.nmbsownid, #資料所有者
       nmbsowndp LIKE nmbs_t.nmbsowndp, #資料所屬部門
       nmbscrtid LIKE nmbs_t.nmbscrtid, #資料建立者
       nmbscrtdp LIKE nmbs_t.nmbscrtdp, #資料建立部門
       nmbscrtdt LIKE nmbs_t.nmbscrtdt, #資料創建日
       nmbsmodid LIKE nmbs_t.nmbsmodid, #資料修改者
       nmbsmoddt LIKE nmbs_t.nmbsmoddt, #最近修改日
       nmbscnfid LIKE nmbs_t.nmbscnfid, #資料確認者
       nmbscnfdt LIKE nmbs_t.nmbscnfdt, #資料確認日
       nmbsstus LIKE nmbs_t.nmbsstus, #狀態碼
       nmbsud001 LIKE nmbs_t.nmbsud001, #自定義欄位(文字)001
       nmbsud002 LIKE nmbs_t.nmbsud002, #自定義欄位(文字)002
       nmbsud003 LIKE nmbs_t.nmbsud003, #自定義欄位(文字)003
       nmbsud004 LIKE nmbs_t.nmbsud004, #自定義欄位(文字)004
       nmbsud005 LIKE nmbs_t.nmbsud005, #自定義欄位(文字)005
       nmbsud006 LIKE nmbs_t.nmbsud006, #自定義欄位(文字)006
       nmbsud007 LIKE nmbs_t.nmbsud007, #自定義欄位(文字)007
       nmbsud008 LIKE nmbs_t.nmbsud008, #自定義欄位(文字)008
       nmbsud009 LIKE nmbs_t.nmbsud009, #自定義欄位(文字)009
       nmbsud010 LIKE nmbs_t.nmbsud010, #自定義欄位(文字)010
       nmbsud011 LIKE nmbs_t.nmbsud011, #自定義欄位(數字)011
       nmbsud012 LIKE nmbs_t.nmbsud012, #自定義欄位(數字)012
       nmbsud013 LIKE nmbs_t.nmbsud013, #自定義欄位(數字)013
       nmbsud014 LIKE nmbs_t.nmbsud014, #自定義欄位(數字)014
       nmbsud015 LIKE nmbs_t.nmbsud015, #自定義欄位(數字)015
       nmbsud016 LIKE nmbs_t.nmbsud016, #自定義欄位(數字)016
       nmbsud017 LIKE nmbs_t.nmbsud017, #自定義欄位(數字)017
       nmbsud018 LIKE nmbs_t.nmbsud018, #自定義欄位(數字)018
       nmbsud019 LIKE nmbs_t.nmbsud019, #自定義欄位(數字)019
       nmbsud020 LIKE nmbs_t.nmbsud020, #自定義欄位(數字)020
       nmbsud021 LIKE nmbs_t.nmbsud021, #自定義欄位(日期時間)021
       nmbsud022 LIKE nmbs_t.nmbsud022, #自定義欄位(日期時間)022
       nmbsud023 LIKE nmbs_t.nmbsud023, #自定義欄位(日期時間)023
       nmbsud024 LIKE nmbs_t.nmbsud024, #自定義欄位(日期時間)024
       nmbsud025 LIKE nmbs_t.nmbsud025, #自定義欄位(日期時間)025
       nmbsud026 LIKE nmbs_t.nmbsud026, #自定義欄位(日期時間)026
       nmbsud027 LIKE nmbs_t.nmbsud027, #自定義欄位(日期時間)027
       nmbsud028 LIKE nmbs_t.nmbsud028, #自定義欄位(日期時間)028
       nmbsud029 LIKE nmbs_t.nmbsud029, #自定義欄位(日期時間)029
       nmbsud030 LIKE nmbs_t.nmbsud030  #自定義欄位(日期時間)030
       END RECORD

   #161128-00061#7---add---end-----------
   DEFINE l_success       LIKE type_t.num5
   DEFINE l_ac            LIKE type_t.num5
   DEFINE l_ac1           LIKE type_t.num5
   DEFINE l_docno         LIKE glaq_t.glaqdocno
   DEFINE l_glaq002       LIKE glaq_t.glaq002
   DEFINE l_field         LIKE type_t.chr1000
   DEFINE l_field1        LIKE type_t.chr1000
   DEFINE l_field2        LIKE type_t.chr1000
   DEFINE l_field3        LIKE type_t.chr1000
   DEFINE l_field4        LIKE type_t.chr1000
   DEFINE l_group_field   LIKE type_t.chr1000
   DEFINE l_slip          LIKE ooba_t.ooba002     #170509-00094#4 add
   DEFINE l_glad_r        RECORD 
                          glad005   LIKE glad_t.glad005,  #数量/金额管理否
                          glad007   LIKE glad_t.glad007,  #部门管理否
                          glad008   LIKE glad_t.glad008,  #利润成本管理否
                          glad009   LIKE glad_t.glad009,  #区域管理否
                          glad010   LIKE glad_t.glad010,  #交易客商管理否
                          glad011   LIKE glad_t.glad011,  #客群管理否
                          glad012   LIKE glad_t.glad012,  #产品类别管理否
                          glad013   LIKE glad_t.glad013,  #人员管理否
#                          glad014   LIKE glad_t.glad014,  #预算管理否
                          glad015   LIKE glad_t.glad015,  #专案管理否
                          glad016   LIKE glad_t.glad016,  #WBS管理否
                          glad017   LIKE glad_t.glad017,  #自由核算项1管理否
                          glad018   LIKE glad_t.glad018,  #自由核算项2管理否
                          glad019   LIKE glad_t.glad019,  #自由核算项3管理否
                          glad020   LIKE glad_t.glad020,  #自由核算项4管理否
                          glad021   LIKE glad_t.glad021,  #自由核算项5管理否
                          glad022   LIKE glad_t.glad022,  #自由核算项6管理否
                          glad023   LIKE glad_t.glad023,  #自由核算项7管理否
                          glad024   LIKE glad_t.glad024,  #自由核算项8管理否
                          glad025   LIKE glad_t.glad025,  #自由核算项9管理否
                          glad026   LIKE glad_t.glad026,  #自由核算项10管理否 
                          glad027   LIKE glad_t.glad027,  #账款客商管理否
                          glad031   LIKE glad_t.glad031,  #經營方式管理否
                          glad032   LIKE glad_t.glad032,  #渠道管理否
                          glad033   LIKE glad_t.glad033   #品牌管理否
                          END RECORD
   
   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE

   DELETE FROM s_vr_tmp06;   #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
   DELETE FROM s_vr_tmp07;   #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_group ——> s_vr_tmp07

   #1.定义CURSOR
   CALL s_voucher_gen_nm_1_def_cursor(p_ld,p_wc,p_sum_type,'') RETURNING l_success
   IF NOT l_success THEN
      RETURN r_success
   END IF
 
   #2.插入临时表
   FOREACH s_voucher_gen_nm_1_cs INTO l_nmbs.*
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach s_voucher_gen_nm_1_cs'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF
      
      #170509-00094#4---add---start---
      #取單別
      CALL s_aooi200_fin_get_slip(l_nmbs.nmbsdocno) RETURNING l_success,l_slip
      #紅字傳票
      CALL s_fin_get_doc_para(l_nmbs.nmbsld,l_nmbs.nmbscomp,l_slip,'D-FIN-1002') RETURNING g_dfin1002
      #170509-00094#4---add---end---       
      
      CALL s_voucher_gen_nm_1_ins_tmp(l_nmbs.nmbsld,l_nmbs.nmbsdocno,p_source)
           RETURNING l_success
      IF NOT l_success THEN
         RETURN r_success    
      END IF

   END FOREACH
   
   #170613-00041#1--add--str--lujh
   #2_1.检核agli060科目与核算项的设置
   CALL s_voucher_gen_hsx_chk('NM','','N10',p_ld) RETURNING l_success
   #170613-00041#1--add--end--lujh
   
   #3.按科目设置进行UPDATE,若有做不管理的字段,UPDATE至' '
   CALL s_voucher_gen_nm_1_upd_tmp(p_ld) 
        RETURNING l_success
   IF NOT l_success THEN
      RETURN r_success    
   END IF
   
   LET r_success = TRUE
   
   
   RETURN r_success
END FUNCTION
################################################################################
# Descriptions...: 处理借方科目及金额等
# Memo...........:
# Usage..........: CALL s_voucher_gen_nm_1_ins_tmp(p_nmbsld,p_nmbsdocno)
#                  RETURNING r_success
# Input parameter: p_nmbsld       帐套
#                : p_nmbsdocno    应收帐款单号
#                : p_source       單據來源
# Return code....: r_success      成功否标识位
# Date & Author..: 2014/07/04 By lujh
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_nm_1_ins_tmp(p_nmbsld,p_nmbsdocno,p_source)
   DEFINE p_nmbsld         LIKE nmbs_t.nmbsld
   DEFINE p_nmbsdocno      LIKE nmbs_t.nmbsdocno
   DEFINE p_source         LIKE type_t.chr10
   DEFINE r_success        LIKE type_t.num5
   DEFINE l_tmp            RECORD 
                           docno    LIKE glaq_t.glaqdocno,
                           docdt    LIKE glap_t.glapdocdt,
                           sw       LIKE type_t.chr1,     
                           glaqent  LIKE glaq_t.glaqent,  
                           glaqcomp LIKE glaq_t.glaqcomp, 
                           glaqld   LIKE glaq_t.glaqld,   
                           glaq001  LIKE glaq_t.glaq001,  
                           glaq002  LIKE glaq_t.glaq002,  
                           glaq005  LIKE glaq_t.glaq005,  #幣別
                           glaq006  LIKE glaq_t.glaq006,  #匯率
                           glaq007  LIKE glaq_t.glaq007,  
                           glaq009  LIKE glaq_t.glaq009, 
                           glaq010  LIKE glaq_t.glaq010,  #原幣金額                           
                           glaq011  LIKE glaq_t.glaq011,  
                           glaq012  LIKE glaq_t.glaq012,  
                           glaq013  LIKE glaq_t.glaq013,  
                           glaq014  LIKE glaq_t.glaq014,  
                           glaq015  LIKE glaq_t.glaq015,  
                           glaq016  LIKE glaq_t.glaq016,  
                           glaq017  LIKE glaq_t.glaq017,  
                           glaq018  LIKE glaq_t.glaq018,  
                           glaq019  LIKE glaq_t.glaq019,  
                           glaq020  LIKE glaq_t.glaq020,  
                           glaq021  LIKE glaq_t.glaq021,  
                           glaq022  LIKE glaq_t.glaq022,  
                           glaq023  LIKE glaq_t.glaq023,  
                           glaq024  LIKE glaq_t.glaq024,  
                           glaq025  LIKE glaq_t.glaq025,  
                           #glaq026  LIKE glaq_t.glaq026, #151111-00001#1 mark lujh  
                           glaq027  LIKE glaq_t.glaq027,  
                           glaq028  LIKE glaq_t.glaq028, 
                           glaq051  LIKE glaq_t.glaq051,  #經營方式
                           glaq052  LIKE glaq_t.glaq052,  #渠道 
                           glaq053  LIKE glaq_t.glaq053,  #品牌                           
                           glaq029  LIKE glaq_t.glaq029,  
                           glaq030  LIKE glaq_t.glaq030,  
                           glaq031  LIKE glaq_t.glaq031,  
                           glaq032  LIKE glaq_t.glaq032,  
                           glaq033  LIKE glaq_t.glaq033,  
                           glaq034  LIKE glaq_t.glaq034,  
                           glaq035  LIKE glaq_t.glaq035,  
                           glaq036  LIKE glaq_t.glaq036,  
                           glaq037  LIKE glaq_t.glaq037,  
                           glaq038  LIKE glaq_t.glaq038,                      
                           d        LIKE glaq_t.glaq003,  
                           c        LIKE glaq_t.glaq004,  
                           qty      LIKE glaq_t.glaq008,  
                           sum      LIKE glaq_t.glaq010,
                           glaq039  LIKE glaq_t.glaq039,
                           glaq040  LIKE glaq_t.glaq040,
                           glaq041  LIKE glaq_t.glaq041,
                           glaq042  LIKE glaq_t.glaq042,
                           glaq043  LIKE glaq_t.glaq043,
                           glaq044  LIKE glaq_t.glaq044,
                           seq      LIKE glaq_t.glaqseq,
                           source   LIKE type_t.chr100,
                           glaqseq  LIKE glaq_t.glaqseq,
                           seq2     LIKE glaq_t.glaqseq,
                           glgb055  LIKE glgb_t.glgb055             #150807-00007#2               
                           END RECORD
   DEFINE l_nmbb001  LIKE nmbb_t.nmbb001   #異動別
   DEFINE l_nmbt002  LIKE nmbt_t.nmbt002   #業務單號
   DEFINE l_nmbt003  LIKE nmbt_t.nmbt003   #項次 
   DEFINE l_nmbt029  LIKE nmbt_t.nmbt029   #科目
   DEFINE l_nmbt030  LIKE nmbt_t.nmbt030   #對方科目  
   DEFINE l_nmbvseq2 LIKE nmbv_t.nmbvseq2
   DEFINE l_nmbv001  LIKE nmbv_t.nmbv001
   DEFINE l_nmbv103  LIKE nmbv_t.nmbv103
   DEFINE l_nmbv113  LIKE nmbv_t.nmbv113
   DEFINE l_nmbv123  LIKE nmbv_t.nmbv123
   DEFINE l_nmbv133  LIKE nmbv_t.nmbv133  
   DEFINE l_cnt      LIKE type_t.num5
   DEFINE l_nmck026  LIKE nmck_t.nmck026
   DEFINE l_nmbb042  LIKE nmbb_t.nmbb042
   DEFINE l_nmbt100  LIKE nmbt_t.nmbt100 #幣別
   DEFINE l_nmbt101  LIKE nmbt_t.nmbt101 #匯率
   DEFINE l_nmbt103  LIKE nmbt_t.nmbt103 #原幣金額
   DEFINE l_nmbt113  LIKE nmbt_t.nmbt113
   DEFINE l_nmbt123  LIKE nmbt_t.nmbt123
   DEFINE l_nmbt133  LIKE nmbt_t.nmbt133
   DEFINE l_nmbt017  LIKE nmbt_t.nmbt017
   DEFINE l_nmbt018  LIKE nmbt_t.nmbt018
   DEFINE l_nmbt019  LIKE nmbt_t.nmbt019
   DEFINE l_nmbt020  LIKE nmbt_t.nmbt020
   DEFINE l_nmbt021  LIKE nmbt_t.nmbt021
   DEFINE l_nmbt022  LIKE nmbt_t.nmbt022
   DEFINE l_nmbt023  LIKE nmbt_t.nmbt023
   DEFINE l_nmbt024  LIKE nmbt_t.nmbt024
   DEFINE l_nmbt025  LIKE nmbt_t.nmbt025
   DEFINE l_nmbt026  LIKE nmbt_t.nmbt026
   DEFINE l_nmbt027  LIKE nmbt_t.nmbt027
   DEFINE l_nmbt028  LIKE nmbt_t.nmbt028
   DEFINE l_nmbt031  LIKE nmbt_t.nmbt031
   DEFINE l_nmbt032  LIKE nmbt_t.nmbt032
   DEFINE l_nmbt033  LIKE nmbt_t.nmbt033
   DEFINE l_nmbt034  LIKE nmbt_t.nmbt034
   DEFINE l_nmbt035  LIKE nmbt_t.nmbt035
   DEFINE l_nmbt036  LIKE nmbt_t.nmbt036
   DEFINE l_nmbt037  LIKE nmbt_t.nmbt037
   DEFINE l_nmbt038  LIKE nmbt_t.nmbt038
   DEFINE l_nmbt039  LIKE nmbt_t.nmbt039
   DEFINE l_nmbt040  LIKE nmbt_t.nmbt040
   DEFINE l_nmbt041  LIKE nmbt_t.nmbt041
   DEFINE l_nmbt042  LIKE nmbt_t.nmbt042
   DEFINE l_nmbt043  LIKE nmbt_t.nmbt043
   
   DEFINE l_nmbv017  LIKE nmbv_t.nmbv017
   DEFINE l_nmbv018  LIKE nmbv_t.nmbv018
   DEFINE l_nmbv019  LIKE nmbv_t.nmbv019
   DEFINE l_nmbv020  LIKE nmbv_t.nmbv020
   DEFINE l_nmbv021  LIKE nmbv_t.nmbv021
   DEFINE l_nmbv022  LIKE nmbv_t.nmbv022
   DEFINE l_nmbv023  LIKE nmbv_t.nmbv023
   DEFINE l_nmbv024  LIKE nmbv_t.nmbv024
   DEFINE l_nmbv025  LIKE nmbv_t.nmbv025
   DEFINE l_nmbv026  LIKE nmbv_t.nmbv026
   DEFINE l_nmbv027  LIKE nmbv_t.nmbv027
   DEFINE l_nmbv028  LIKE nmbv_t.nmbv028
   DEFINE l_nmbv039  LIKE nmbv_t.nmbv039
   DEFINE l_nmbv040  LIKE nmbv_t.nmbv040
   DEFINE l_nmbv041  LIKE nmbv_t.nmbv041
   DEFINE l_nmbv029  LIKE nmbv_t.nmbv020
   DEFINE l_nmbv030  LIKE nmbv_t.nmbv030
   DEFINE l_nmbv031  LIKE nmbv_t.nmbv031
   DEFINE l_nmbv032  LIKE nmbv_t.nmbv032
   DEFINE l_nmbv033  LIKE nmbv_t.nmbv033
   DEFINE l_nmbv034  LIKE nmbv_t.nmbv034
   DEFINE l_nmbv035  LIKE nmbv_t.nmbv035
   DEFINE l_nmbv036  LIKE nmbv_t.nmbv036
   DEFINE l_nmbv037  LIKE nmbv_t.nmbv037
   DEFINE l_nmbv038  LIKE nmbv_t.nmbv038
   #异动别
   DEFINE l_nmbt004      LIKE nmbt_t.nmbt004
   DEFINE l_nmbt001      LIKE nmbt_t.nmbt001   #150707-00001#7
   DEFINE l_nmbv042      LIKE nmbv_t.nmbv042   #150807-00007#2
   DEFINE l_glbcseq1     LIKE glbc_t.glbcseq1  #150807-00007#2
   DEFINE l_glaa004      LIKE glaa_t.glaa004   #150807-00007#2
   DEFINE l_nmbt103_1    LIKE nmbt_t.nmbt103   #150807-00007#2#原幣金額
   DEFINE l_nmbt113_1    LIKE nmbt_t.nmbt113   #150807-00007#2
   DEFINE l_nmbt123_1    LIKE nmbt_t.nmbt123   #150807-00007#2
   DEFINE l_nmbt133_1    LIKE nmbt_t.nmbt133   #150807-00007#2
   DEFINE l_nmbv100      LIKE nmbv_t.nmbv100   #150918-00001#5
   DEFINE l_nmbt113_orig LIKE nmbt_t.nmbt113   #151013-00019#2 
   DEFINE l_nmck044      LIKE nmck_t.nmck044   #160524-00055#3
   DEFINE l_nmck004      LIKE nmck_t.nmck004   #160524-00055#3 
   DEFINE l_nmci009      LIKE nmci_t.nmci009   #160524-00055#3
   DEFINE l_nmck010      LIKE nmck_t.nmck010   #160524-00055#3  
   WHENEVER ERROR CONTINUE    

   LET r_success = FALSE                        
   INITIALIZE l_tmp.* TO NULL
   LET l_glaa004 = ''
   SELECT glaa004 INTO l_glaa004 FROM glaa_t WHERE glaaent = g_enterprise AND glaald = p_nmbsld 

   #151013-00019#2 add nmbt113
   FOREACH s_voucher_gen_nm_1_cs1 USING p_nmbsdocno INTO l_tmp.*,l_nmbt002,l_nmbt003,l_nmbt029,l_nmbt030,l_nmbt004,l_nmbt001,l_nmbt113_orig  #150707-00001#7 add nmbt001   
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach s_voucher_gen_nm_1_cs1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      #151013-00019#2 add ------
      #因為只剩anmt311沒有走nmbt114金額所以這邊要先給
      IF p_source = 'anmt311' THEN
         LET l_tmp.d = l_nmbt113_orig
      END IF
      #151013-00019#2 add end---      
      LET l_nmbt100 = l_tmp.glaq005 #幣別
      LET l_nmbt101 = l_tmp.glaq006 #匯率
      LET l_nmbt103 = l_tmp.glaq010 #原幣金額
      LET l_nmbt113 = l_tmp.d       #本幣金額
      LET l_nmbt123 = l_tmp.glaq040 #本幣二金額
      LET l_nmbt133 = l_tmp.glaq043 #本幣三金額
      
      LET l_nmbt017 = l_tmp.glaq017
      LET l_nmbt018 = l_tmp.glaq018
      LET l_nmbt019 = l_tmp.glaq019
      LET l_nmbt020 = l_tmp.glaq020   
      LET l_nmbt021 = l_tmp.glaq021
      LET l_nmbt022 = l_tmp.glaq022
      LET l_nmbt023 = l_tmp.glaq023
      LET l_nmbt024 = l_tmp.glaq024  
      LET l_nmbt025 = l_tmp.glaq025
      #LET l_nmbt026 = l_tmp.glaq026     #151111-00001#1 mark lujh  
      LET l_nmbt027 = l_tmp.glaq027
      LET l_nmbt028 = l_tmp.glaq028  
      LET l_nmbt031 = l_tmp.glaq051
      LET l_nmbt032 = l_tmp.glaq052
      LET l_nmbt033 = l_tmp.glaq053
      LET l_nmbt034 = l_tmp.glaq029  
      LET l_nmbt035 = l_tmp.glaq030
      LET l_nmbt036 = l_tmp.glaq031  
      LET l_nmbt037 = l_tmp.glaq032
      LET l_nmbt038 = l_tmp.glaq033
      LET l_nmbt039 = l_tmp.glaq034
      LET l_nmbt040 = l_tmp.glaq035  
      LET l_nmbt041 = l_tmp.glaq036
      LET l_nmbt042 = l_tmp.glaq037
      LET l_nmbt043 = l_tmp.glaq038
            
      IF p_source = 'anmt311' THEN      
#         SELECT nmbb001 INTO l_nmbb001 FROM nmbb_t WHERE nmbbent = g_enterprise AND nmbbdocno = l_nmbt002 AND nmbbseq = l_nmbt003 
         LET l_nmbb001 = l_nmbt004
         IF cl_null(l_tmp.glaq001) THEN  #161222-00031#1 add xul
            #151013-00019#2 add ------
            #如果是anmt530需要抓摘要來放
            SELECT nmbb025 INTO l_tmp.glaq001
              FROM nmbb_t
             WHERE nmbbent = g_enterprise AND nmbbcomp = l_tmp.glaqcomp
               AND nmbbdocno = l_nmbt002 AND nmbbseq = l_nmbt003
            #151013-00019#2 add end--- 
          END IF  #161222-00031#1 add xul
      END IF 
      IF p_source = 'anmt470' THEN
         SELECT nmck026 INTO l_nmck026 FROM nmck_t WHERE nmckent = g_enterprise AND nmckcomp = l_tmp.glaqcomp AND nmckdocno = l_nmbt002 #资料来源 anmt440,anmt460
         IF cl_null(l_nmck026) THEN
            SELECT nmch001 INTO l_nmck026 FROM nmch_t WHERE nmchent = g_enterprise AND nmchcomp = l_tmp.glaqcomp AND nmchdocno = l_nmbt002  #资料来源 anmt450
         END IF
         #160524-00055#3 add s--
         SELECT nmci009 INTO l_nmci009 FROM nmci_t WHERE nmcient = g_enterprise AND nmcicomp = l_tmp.glaqcomp AND nmcidocno = l_nmbt002  #资料来源 anmt450
            AND nmciseq = l_nmbt003 #160803-00043#1 add 
         SELECT nmck044,nmck004,nmck010 INTO l_nmck044,l_nmck004,l_nmck010 FROM nmck_t 
          WHERE nmckent = g_enterprise AND nmckcomp = l_tmp.glaqcomp 
          #AND nmckdocno = (SELECT nmci003 FROM nmci_t WHERE nmcient = g_enterprise AND nmcicomp = l_tmp.glaqcomp AND nmcidocno = l_nmbt002)  #资料来源 anmt440,anmt460  #160803-00043#1 mark
          AND nmckdocno = (SELECT nmci003 FROM nmci_t WHERE nmcient = g_enterprise AND nmcicomp = l_tmp.glaqcomp AND nmcidocno = l_nmbt002 AND nmciseq = l_nmbt003)  #资料来源 anmt440,anmt460 #160803-00043#1 add
         #160524-00055#3 add e---          
      END IF 
      IF p_source = 'anmt530' THEN
         SELECT nmbb042 INTO l_nmbb042 FROM nmbb_t WHERE nmbbent = g_enterprise AND nmbbdocno = l_nmbt002 AND nmbbseq = l_nmbt003 
         IF cl_null(l_nmbb042) THEN
            SELECT nmcq001 INTO l_nmbb042 FROM nmcq_t WHERE nmcqent = g_enterprise AND nmcqdocno = l_nmbt002 AND nmcqcomp = l_tmp.glaqcomp
         END IF
      END IF
      
      
      #160524-00055#3 add s------------
      #票据异动&含保证金账户且&保证金账户跟来源账户不一致时，不考虑glbc,nmbv
     #IF l_nmck026 = '5' AND l_nmci009 = 'Y' AND l_nmck044 != l_nmck004  THEN   #161127-00007#1 mark
      IF l_nmck026 = '5' AND l_nmci009 = 'Y' AND ((l_nmck044 != l_nmck004) OR (l_nmck044 IS NULL AND l_nmck004 IS NOT NULL) OR (l_nmck044 IS NOT NULL AND l_nmck004 IS NULL))  THEN  #161127-00007#1 add
         LET l_tmp.glaq002 = l_nmbt029   #科目
         
         LET l_tmp.glaq005 = l_nmbt100   #幣別  
         #150918-00001#5 add ------
         IF p_source <> 'anmt311' THEN
            #如果是anmt470 & anmt530，匯率要取開立單據的為準
            SELECT nmck101 INTO l_tmp.glaq006
              FROM nmck_t
              LEFT JOIN nmci_t ON nmcient = nmckent AND nmci003 = nmckdocno
             WHERE nmckent = g_enterprise AND nmckcomp = l_tmp.glaqcomp AND nmcidocno = l_nmbt002
         ELSE
         #150918-00001#5 add end---
            LET l_tmp.glaq006 = l_nmbt101   #匯率
         END IF  #150918-00001#5
         LET l_tmp.glaq010 = l_nmbt103   #原幣金額
         LET l_tmp.d = l_nmbt113         #借方金額一
         LET l_tmp.glaq040 = l_nmbt123
         LET l_tmp.glaq043 = l_nmbt133
         LET l_tmp.c = 0                 #貸方金額
         LET l_tmp.glaq041 = 0           #貸方金額二
         LET l_tmp.glaq044 = 0           #貸方金額三 
         #LET l_tmp.glgb055 =''
 
         LET g_free_m.free_item_1 = l_tmp.glaq029
         LET g_free_m.free_item_2 = l_tmp.glaq030
         LET g_free_m.free_item_3 = l_tmp.glaq031
         LET g_free_m.free_item_4 = l_tmp.glaq032
         LET g_free_m.free_item_5 = l_tmp.glaq033
         LET g_free_m.free_item_6 = l_tmp.glaq034
         LET g_free_m.free_item_7 = l_tmp.glaq035
         LET g_free_m.free_item_8 = l_tmp.glaq036
         LET g_free_m.free_item_9 = l_tmp.glaq037
         LET g_free_m.free_item_10 = l_tmp.glaq038
         
         LET g_field_m.field1 = 'glgb029'
         LET g_field_m.field2 = 'glgb030'
         LET g_field_m.field3 = 'glgb031'
         LET g_field_m.field4 = 'glgb032'
         LET g_field_m.field5 = 'glgb033'
         LET g_field_m.field6 = 'glgb034'
         LET g_field_m.field7 = 'glgb035'
         LET g_field_m.field8 = 'glgb036'
         LET g_field_m.field9 = 'glgb037'
         LET g_field_m.field10 = 'glgb038'
         
         CALL s_account_item_free(l_tmp.glaqld,l_tmp.glaq002,p_source,l_tmp.docno,l_tmp.seq,'',g_free_m.*,g_field_m.*)
         RETURNING l_tmp.glaq029,l_tmp.glaq030,l_tmp.glaq031,l_tmp.glaq032,
                   l_tmp.glaq033,l_tmp.glaq034,l_tmp.glaq035,l_tmp.glaq036,
                   l_tmp.glaq037,l_tmp.glaq038
         #151111-00001#1--add--str--lujh
         LET l_tmp.sum = l_tmp.glaq010   #170324-00067#1
         INSERT INTO s_vr_tmp06 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
               
          LET l_tmp.glaq002 = l_nmbt030   #科目
          LET l_tmp.glaq005 = l_nmbt100   #幣別
          LET l_tmp.glaq006 = l_nmbt101   #匯率
          LET l_tmp.glaq010 = l_nmbt103   #原幣金額
          LET l_tmp.d = 0                 #借方金額
        # LET l_tmp.c =  l_tmp.d          #貸方金額
          LET l_tmp.c = l_nmbt113
          LET l_tmp.glaq041 = l_nmbt123   #貸方金額二
          LET l_tmp.glaq044 = l_nmbt133   #貸方金額三
          LET l_tmp.glaq040 = 0          #借方金額二
          LET l_tmp.glaq043 = 0           #借方金額三
          LET l_tmp.glgb055 = l_nmck010   #现金变动码 
 
         LET g_free_m.free_item_1 = l_tmp.glaq029
         LET g_free_m.free_item_2 = l_tmp.glaq030
         LET g_free_m.free_item_3 = l_tmp.glaq031
         LET g_free_m.free_item_4 = l_tmp.glaq032
         LET g_free_m.free_item_5 = l_tmp.glaq033
         LET g_free_m.free_item_6 = l_tmp.glaq034
         LET g_free_m.free_item_7 = l_tmp.glaq035
         LET g_free_m.free_item_8 = l_tmp.glaq036
         LET g_free_m.free_item_9 = l_tmp.glaq037
         LET g_free_m.free_item_10 = l_tmp.glaq038
         
         LET g_field_m.field1 = 'glgb029'
         LET g_field_m.field2 = 'glgb030'
         LET g_field_m.field3 = 'glgb031'
         LET g_field_m.field4 = 'glgb032'
         LET g_field_m.field5 = 'glgb033'
         LET g_field_m.field6 = 'glgb034'
         LET g_field_m.field7 = 'glgb035'
         LET g_field_m.field8 = 'glgb036'
         LET g_field_m.field9 = 'glgb037'
         LET g_field_m.field10 = 'glgb038'
         
         CALL s_account_item_free(l_tmp.glaqld,l_tmp.glaq002,p_source,l_tmp.docno,l_tmp.seq,'',g_free_m.*,g_field_m.*)
         RETURNING l_tmp.glaq029,l_tmp.glaq030,l_tmp.glaq031,l_tmp.glaq032,
                   l_tmp.glaq033,l_tmp.glaq034,l_tmp.glaq035,l_tmp.glaq036,
                   l_tmp.glaq037,l_tmp.glaq038
         #151111-00001#1--add--str--lujh
         LET l_tmp.sum = l_tmp.glaq010   #170324-00067#1
         INSERT INTO s_vr_tmp06 VALUES(l_tmp.*)    #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06

      END IF
      #160524-00055#3 add e----------      
      
      #l_nmbb001 = '1'#存入 l_nmbb001 = '3' #借方科目
      #l_nmck026 = '3' #應付票據扯票,l_nmck026 = '4' #應付票據作廢,l_nmck026 = '5' #應付票據兌現,l_nmck026 = '6' #應付票據到期未兌現,>>anmt450
      #l_nmck026 = '11' #付啟 ,l_nmck026 = '12' #匯款失敗>>anmt480
      #l_nmbb042 = '1' #應收票據收票 , l_nmbb042 = '9'  #應收票據轉付退票
      #IF l_nmbb001 = '1' OR l_nmbb001 = '3' OR l_nmck026 = '3' OR l_nmck026 = '4' OR l_nmck026 = '5' OR  #160524-00055#3
      IF l_nmbb001 = '1' OR l_nmbb001 = '3' OR l_nmck026 = '3' OR l_nmck026 = '4' OR (l_nmck026 = '5' AND ( l_nmci009 != 'Y' OR (l_nmci009 = 'Y' AND l_nmck044 = l_nmck004 )))  OR   #160524-00055#3     
         l_nmck026 = '6' OR l_nmck026 = '11' OR l_nmck026 = '12' OR l_nmbb042 = '1' OR l_nmbb042 = '9' THEN
         LET l_tmp.glaq002 = l_nmbt029   #科目
         
         LET l_tmp.glaq005 = l_nmbt100   #幣別
         
         #150918-00001#5 add ------
         IF p_source <> 'anmt311' THEN
            #如果是anmt470 & anmt530，匯率要取開立單據的為準
            SELECT nmck101 INTO l_tmp.glaq006
              FROM nmck_t
              LEFT JOIN nmci_t ON nmcient = nmckent AND nmci003 = nmckdocno
             WHERE nmckent = g_enterprise AND nmckcomp = l_tmp.glaqcomp AND nmcidocno = l_nmbt002
         ELSE
         #150918-00001#5 add end---
            LET l_tmp.glaq006 = l_nmbt101   #匯率
         END IF  #150918-00001#5
         LET l_tmp.glaq010 = l_nmbt103   #原幣金額
         LET l_tmp.d = l_nmbt113         #借方金額一
         LET l_tmp.glaq040 = l_nmbt123
         LET l_tmp.glaq043 = l_nmbt133
         LET l_tmp.c = 0                 #貸方金額
         LET l_tmp.glaq041 = 0           #貸方金額二
         LET l_tmp.glaq044 = 0           #貸方金額三
         #150807-00007#2--mark--str
#         SELECT MAX(seq2) + 1 INTO l_tmp.seq2 FROM s_voucher_nm_tmp WHERE docno = l_tmp.docno AND glaqld = l_tmp.glaqld
#                                                                   AND    seq = l_tmp.seq
#         IF cl_null(l_tmp.seq2) THEN
#            LET l_tmp.seq2 = 1
#         END IF 
         #150807-00007#2--mark--end
         #150807-00007#2--add--str
         LET l_cnt = 0 
         #151015 remark--s
         #150918-00001#5 mark ------
         EXECUTE s_voucher_nm_glac_chk USING l_glaa004,l_tmp.glaq002 INTO l_cnt
#         IF l_cnt > 0 AND g_prog = 'anmt311' THEN  #如果科目為現金科目   #151015 add anmt311   #170301-00030#8 by 09257 --mark
         IF l_cnt > 0 AND g_prog MATCHES 'anmt311*' THEN  #如果科目為現金科目   #170301-00030#8 by 09257 --add   
            LET l_cnt = 0
            EXECUTE s_voucher_nm_glbc_chk USING l_tmp.docno,l_tmp.glaqld,l_tmp.seq INTO l_cnt
            IF l_cnt > 0 THEN  #存在於 glbc_t
               FOREACH s_voucher_gen_glbc_cs USING l_tmp.glaqld,l_tmp.docno,l_tmp.seq INTO l_glbcseq1,l_nmbv042,l_nmbt103_1,l_nmbt113_1,l_nmbt123_1,l_nmbt133_1
                  SELECT MAX(seq2) + 1 INTO l_tmp.seq2
                    FROM s_vr_tmp06  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
                   WHERE docno = l_tmp.docno AND glaqld = l_tmp.glaqld AND seq = l_tmp.seq
                  IF cl_null(l_tmp.seq2) THEN
                      LET l_tmp.seq2 = 1
                  END IF
                  LET l_tmp.glaq010 = l_nmbt103_1   #原幣金額
                  LET l_tmp.d = l_nmbt113_1         #借方金額一
                  LET l_tmp.glaq040 = l_nmbt123_1
                  LET l_tmp.glaq043 = l_nmbt133_1
                  LET l_tmp.c = 0                   #貸方金額
                  LET l_tmp.glaq041 = 0             #貸方金額二
                  LET l_tmp.glaq044 = 0             #貸方金額三
                  LET l_tmp.glgb055  = l_nmbv042
                  IF cl_null(l_tmp.glaq001) THEN #151013-00019#2
                     #150918-00001#3--add--str--lujh
                     #                 2:摘要/账套    /科目编号     /程序编号/目的字段/单据编号/单据项次1/单据项次2
                     CALL s_account_item('2',l_tmp.glaqld,l_tmp.glaq002,p_source,'glgb001',l_tmp.docno,l_tmp.seq,'')
                     RETURNING l_tmp.glaq001
                     #150918-00001#3--add--end--lujh
                  END IF #151013-00019#2 
                  
                  #151111-00001#1--add--str--lujh
                  LET g_free_m.free_item_1 = l_tmp.glaq029
                  LET g_free_m.free_item_2 = l_tmp.glaq030
                  LET g_free_m.free_item_3 = l_tmp.glaq031
                  LET g_free_m.free_item_4 = l_tmp.glaq032
                  LET g_free_m.free_item_5 = l_tmp.glaq033
                  LET g_free_m.free_item_6 = l_tmp.glaq034
                  LET g_free_m.free_item_7 = l_tmp.glaq035
                  LET g_free_m.free_item_8 = l_tmp.glaq036
                  LET g_free_m.free_item_9 = l_tmp.glaq037
                  LET g_free_m.free_item_10 = l_tmp.glaq038
                  
                  LET g_field_m.field1 = 'glgb029'
                  LET g_field_m.field2 = 'glgb030'
                  LET g_field_m.field3 = 'glgb031'
                  LET g_field_m.field4 = 'glgb032'
                  LET g_field_m.field5 = 'glgb033'
                  LET g_field_m.field6 = 'glgb034'
                  LET g_field_m.field7 = 'glgb035'
                  LET g_field_m.field8 = 'glgb036'
                  LET g_field_m.field9 = 'glgb037'
                  LET g_field_m.field10 = 'glgb038'
                  
                  CALL s_account_item_free(l_tmp.glaqld,l_tmp.glaq002,p_source,l_tmp.docno,l_tmp.seq,'',g_free_m.*,g_field_m.*)
                  RETURNING l_tmp.glaq029,l_tmp.glaq030,l_tmp.glaq031,l_tmp.glaq032,
                            l_tmp.glaq033,l_tmp.glaq034,l_tmp.glaq035,l_tmp.glaq036,
                            l_tmp.glaq037,l_tmp.glaq038
                  #151111-00001#1--add--str--lujh
                  
                  #151015-----s
                  IF l_tmp.d > 0 THEN
                     LET l_tmp.sw = '1'
                  ELSE
                     LET l_tmp.sw = '2'
                  END IF
                  #151015-----e         
                  LET l_tmp.sum = l_tmp.glaq010   #170324-00067#1                  
                  INSERT INTO s_vr_tmp06 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
               END FOREACH
            ELSE
               SELECT MAX(seq2) + 1 INTO l_tmp.seq2
                 FROM s_vr_tmp06   #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
                WHERE docno = l_tmp.docno AND glaqld = l_tmp.glaqld AND seq = l_tmp.seq
               IF cl_null(l_tmp.seq2) THEN
                  LET l_tmp.seq2 = 1
               END IF
               
               IF cl_null(l_tmp.glaq001) THEN #151013-00019#2
                  #150918-00001#3--add--str--lujh
                  #                 2:摘要/账套    /科目编号     /程序编号/目的字段/单据编号/单据项次1/单据项次2
                  CALL s_account_item('2',l_tmp.glaqld,l_tmp.glaq002,p_source,'glgb001',l_tmp.docno,l_tmp.seq,'')
                  RETURNING l_tmp.glaq001
                  #150918-00001#3--add--end--lujh
               END IF #151013-00019#2
               
               #151111-00001#1--add--str--lujh
               LET g_free_m.free_item_1 = l_tmp.glaq029
               LET g_free_m.free_item_2 = l_tmp.glaq030
               LET g_free_m.free_item_3 = l_tmp.glaq031
               LET g_free_m.free_item_4 = l_tmp.glaq032
               LET g_free_m.free_item_5 = l_tmp.glaq033
               LET g_free_m.free_item_6 = l_tmp.glaq034
               LET g_free_m.free_item_7 = l_tmp.glaq035
               LET g_free_m.free_item_8 = l_tmp.glaq036
               LET g_free_m.free_item_9 = l_tmp.glaq037
               LET g_free_m.free_item_10 = l_tmp.glaq038
               
               LET g_field_m.field1 = 'glgb029'
               LET g_field_m.field2 = 'glgb030'
               LET g_field_m.field3 = 'glgb031'
               LET g_field_m.field4 = 'glgb032'
               LET g_field_m.field5 = 'glgb033'
               LET g_field_m.field6 = 'glgb034'
               LET g_field_m.field7 = 'glgb035'
               LET g_field_m.field8 = 'glgb036'
               LET g_field_m.field9 = 'glgb037'
               LET g_field_m.field10 = 'glgb038'
               
               CALL s_account_item_free(l_tmp.glaqld,l_tmp.glaq002,p_source,l_tmp.docno,l_tmp.seq,'',g_free_m.*,g_field_m.*)
               RETURNING l_tmp.glaq029,l_tmp.glaq030,l_tmp.glaq031,l_tmp.glaq032,
                         l_tmp.glaq033,l_tmp.glaq034,l_tmp.glaq035,l_tmp.glaq036,
                         l_tmp.glaq037,l_tmp.glaq038
               #151111-00001#1--add--str--lujh
               LET l_tmp.sum = l_tmp.glaq010   #170324-00067#1
               INSERT INTO s_vr_tmp06 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
            END IF
         ELSE
         #150918-00001#5 mark end---
         #151015 remark--e
            SELECT MAX(seq2) + 1 INTO l_tmp.seq2
              FROM s_vr_tmp06   #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
             WHERE docno = l_tmp.docno AND glaqld = l_tmp.glaqld AND seq = l_tmp.seq
            IF cl_null(l_tmp.seq2) THEN
               LET l_tmp.seq2 = 1
            END IF
            IF cl_null(l_tmp.glaq001) THEN #151013-00019#2
               #150918-00001#3--add--str--lujh
               #                 2:摘要/账套    /科目编号     /程序编号/目的字段/单据编号/单据项次1/单据项次2
               CALL s_account_item('2',l_tmp.glaqld,l_tmp.glaq002,p_source,'glgb001',l_tmp.docno,l_tmp.seq,'')
               RETURNING l_tmp.glaq001
               #150918-00001#3--add--end--lujh
            END IF #151013-00019#2
            
            #151111-00001#1--add--str--lujh
            LET g_free_m.free_item_1 = l_tmp.glaq029
            LET g_free_m.free_item_2 = l_tmp.glaq030
            LET g_free_m.free_item_3 = l_tmp.glaq031
            LET g_free_m.free_item_4 = l_tmp.glaq032
            LET g_free_m.free_item_5 = l_tmp.glaq033
            LET g_free_m.free_item_6 = l_tmp.glaq034
            LET g_free_m.free_item_7 = l_tmp.glaq035
            LET g_free_m.free_item_8 = l_tmp.glaq036
            LET g_free_m.free_item_9 = l_tmp.glaq037
            LET g_free_m.free_item_10 = l_tmp.glaq038
            
            LET g_field_m.field1 = 'glgb029'
            LET g_field_m.field2 = 'glgb030'
            LET g_field_m.field3 = 'glgb031'
            LET g_field_m.field4 = 'glgb032'
            LET g_field_m.field5 = 'glgb033'
            LET g_field_m.field6 = 'glgb034'
            LET g_field_m.field7 = 'glgb035'
            LET g_field_m.field8 = 'glgb036'
            LET g_field_m.field9 = 'glgb037'
            LET g_field_m.field10 = 'glgb038'
            
            CALL s_account_item_free(l_tmp.glaqld,l_tmp.glaq002,p_source,l_tmp.docno,l_tmp.seq,'',g_free_m.*,g_field_m.*)
            RETURNING l_tmp.glaq029,l_tmp.glaq030,l_tmp.glaq031,l_tmp.glaq032,
                      l_tmp.glaq033,l_tmp.glaq034,l_tmp.glaq035,l_tmp.glaq036,
                      l_tmp.glaq037,l_tmp.glaq038
            #151111-00001#1--add--str--lujh
            
            #albireo 151015-----s
            IF l_tmp.d > 0 THEN
               LET l_tmp.sw = '1'
            ELSE
               LET l_tmp.sw = '2'
            END IF
            #albireo 151015-----e     
            LET l_tmp.sum = l_tmp.glaq010   #170324-00067#1            
            INSERT INTO s_vr_tmp06 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
         END IF    #151015 remark  #150918-00001#5
         #150807-00007#2--add--end
        
        #INSERT INTO s_voucher_nm_tmp VALUES(l_tmp.*)  #150807-00007#2 mark
        #IF p_source <> 'anmt311' THEN   #anmt311不走該段邏輯                             #150707-00001#7 mark
        #anmt311但來源為4:繳款單者或13.员工缴款单,需產生貸方分錄                                           #150707-00001#7   
#         IF p_source <> 'anmt311' OR (p_source = 'anmt311' AND l_nmbt001 = '4') THEN     #150707-00001#7  #170723-00001#1 20170724 mark by 08172
         IF p_source <> 'anmt311' OR (p_source = 'anmt311' AND (l_nmbt001 = '4' OR l_nmbt001 = '13')) THEN  #170723-00001#1 20170724 add by 08172         
            LET l_cnt = 0
            #SELECT COUNT(*) INTO l_cnt         #170615-00061#25 mark
            SELECT COUNT(nmbvdocno) INTO l_cnt  #170615-00061#25 add
              FROM nmbv_t
             WHERE nmbvent = g_enterprise AND nmbvdocno = l_tmp.docno
               AND nmbvld = l_tmp.glaqld AND nmbvseq =  l_tmp.seq
            IF l_cnt > 0 THEN  #存在於 nmbv_t
               #150807-00007#2 add nmbv042
               #150918-00001#5 add nmbv100
               FOREACH s_voucher_gen_nmbv_cs USING l_tmp.glaqld,l_tmp.docno,l_tmp.seq
                    INTO l_nmbvseq2,l_nmbv001,l_nmbv103,l_nmbv113,l_nmbv123,
                         l_nmbv133,l_nmbv017,l_nmbv018,l_nmbv019,l_nmbv020,
                         l_nmbv021,l_nmbv022,l_nmbv023,l_nmbv024,l_nmbv025,
                         l_nmbv026,l_nmbv027,l_nmbv028,l_nmbv039,l_nmbv040,
                         l_nmbv041,l_nmbv042,l_nmbv029,l_nmbv030,l_nmbv031,
                         l_nmbv032,l_nmbv033,l_nmbv034,l_nmbv035,l_nmbv036,
                         l_nmbv037,l_nmbv038,l_nmbv100
                  
                  LET l_tmp.glaq002 = l_nmbv001     #科目
                 #LET l_tmp.glaq005 = l_nmbt100     #幣別 #150918-00001#5 mark
                  #150918-00001#5 add ------
                  LET l_tmp.glaq005 = l_nmbv100     #幣別
                  #若是匯差的部份，匯率=1
                  IF l_nmbv100 <> l_nmbt100 THEN
                     LET l_tmp.glaq006 = 1          #匯率
                  ELSE
                     LET l_tmp.glaq006 = l_nmbt101  #匯率
                  END IF
                  #150918-00001#5 add end---
                  LET l_tmp.glaq010 = l_nmbv103     #原幣金額
                  LET l_tmp.d = 0                   #借方金額
                  LET l_tmp.glaq040 = 0             #借方金額二
                  LET l_tmp.glaq043 = 0             #借方金額三
                  LET l_tmp.c = l_nmbv113           #貸方金額
                  LET l_tmp.glaq041 = l_nmbv123     #貸方金額二
                  LET l_tmp.glaq044 = l_nmbv133     #貸方金額三
                  #150918-00001#5 add ------
                  #170324-00067#1-----s
                   IF l_nmbv100 <> l_nmbt100 THEN
                     LET l_tmp.glaq006 = 1          #匯率
                     LET l_tmp.sum = l_nmbv113
                  ELSE
                     LET l_tmp.glaq006 = l_nmbt101  #匯率
                     LET l_tmp.sum = l_tmp.glaq010
                  END IF
                  #170324-00067#1-----e
                  #若為負數金額,則借貸方向要相反
                  IF l_tmp.c < 0 THEN
                     LET l_tmp.sw = '1'
                     LET l_tmp.d = l_tmp.c * -1
                     LET l_tmp.sum = l_tmp.sum * -1 #原幣
                     LET l_tmp.glaq010 = l_tmp.glaq010 * -1
                     LET l_tmp.c = 0
                     LET l_tmp.glaq040 = l_tmp.glaq041 * -1 #本位幣二
                     LET l_tmp.glaq041 = 0
                     LET l_tmp.glaq043 = l_tmp.glaq044 * -1 #本位幣三
                     LET l_tmp.glaq044 = 0
                  END IF
                  #150918-00001#5 add end---
                  #151124 mark by Reanna------
                  ##固定核算項目+自由核算項目
                  #LET l_tmp.glaq017 = l_nmbv017
                  #LET l_tmp.glaq018 = l_nmbv018
                  #LET l_tmp.glaq019 = l_nmbv019
                  #LET l_tmp.glaq020 = l_nmbv020
                  #LET l_tmp.glaq021 = l_nmbv021
                  #LET l_tmp.glaq022 = l_nmbv022
                  #LET l_tmp.glaq023 = l_nmbv023
                  #LET l_tmp.glaq024 = l_nmbv024
                  #LET l_tmp.glaq025 = l_nmbv025
                  ##LET l_tmp.glaq026 = l_nmbv026   #151111-00001#1 mark lujh  
                  #LET l_tmp.glaq027 = l_nmbv027
                  #LET l_tmp.glaq028 = l_nmbv028
                  #LET l_tmp.glaq051 = l_nmbv039
                  #LET l_tmp.glaq052 = l_nmbv040
                  #LET l_tmp.glaq053 = l_nmbv041
                  #LET l_tmp.glaq029 = l_nmbv029
                  #LET l_tmp.glaq030 = l_nmbv030
                  #LET l_tmp.glaq031 = l_nmbv031
                  #LET l_tmp.glaq032 = l_nmbv032
                  #LET l_tmp.glaq033 = l_nmbv033
                  #LET l_tmp.glaq034 = l_nmbv034
                  #LET l_tmp.glaq035 = l_nmbv035
                  #LET l_tmp.glaq036 = l_nmbv036
                  #LET l_tmp.glaq037 = l_nmbv037
                  #LET l_tmp.glaq038 = l_nmbv038
                  LET l_tmp.glgb055 = l_nmbv042   #150807-00007#2 add #151130 remark by Reanna
                  #151124 mark by Reanna end---
                  
                  SELECT MAX(seq2) + 1 INTO l_tmp.seq2
                    FROM s_vr_tmp06  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
                   WHERE docno = l_tmp.docno AND glaqld = l_tmp.glaqld AND  seq = l_tmp.seq
                  IF cl_null(l_tmp.seq2) THEN
                     LET l_tmp.seq2 = 1
                  END IF
                  IF cl_null(l_tmp.glaq001) THEN #151013-00019#2
                     #150918-00001#3--add--str--lujh
                     #                 2:摘要/账套    /科目编号     /程序编号/目的字段/单据编号/单据项次1/单据项次2
                     CALL s_account_item('2',l_tmp.glaqld,l_tmp.glaq002,p_source,'glgb001',l_tmp.docno,l_tmp.seq,'')
                     RETURNING l_tmp.glaq001
                     #150918-00001#3--add--end--lujh
                  END IF #151013-00019#2
                  
                  #151111-00001#1--add--str--lujh
                  LET g_free_m.free_item_1 = l_tmp.glaq029
                  LET g_free_m.free_item_2 = l_tmp.glaq030
                  LET g_free_m.free_item_3 = l_tmp.glaq031
                  LET g_free_m.free_item_4 = l_tmp.glaq032
                  LET g_free_m.free_item_5 = l_tmp.glaq033
                  LET g_free_m.free_item_6 = l_tmp.glaq034
                  LET g_free_m.free_item_7 = l_tmp.glaq035
                  LET g_free_m.free_item_8 = l_tmp.glaq036
                  LET g_free_m.free_item_9 = l_tmp.glaq037
                  LET g_free_m.free_item_10 = l_tmp.glaq038
                  
                  LET g_field_m.field1 = 'glgb029'
                  LET g_field_m.field2 = 'glgb030'
                  LET g_field_m.field3 = 'glgb031'
                  LET g_field_m.field4 = 'glgb032'
                  LET g_field_m.field5 = 'glgb033'
                  LET g_field_m.field6 = 'glgb034'
                  LET g_field_m.field7 = 'glgb035'
                  LET g_field_m.field8 = 'glgb036'
                  LET g_field_m.field9 = 'glgb037'
                  LET g_field_m.field10 = 'glgb038'
                  
                  CALL s_account_item_free(l_tmp.glaqld,l_tmp.glaq002,p_source,l_tmp.docno,l_tmp.seq,'',g_free_m.*,g_field_m.*)
                  RETURNING l_tmp.glaq029,l_tmp.glaq030,l_tmp.glaq031,l_tmp.glaq032,
                            l_tmp.glaq033,l_tmp.glaq034,l_tmp.glaq035,l_tmp.glaq036,
                            l_tmp.glaq037,l_tmp.glaq038
                  #151111-00001#1--add--str--lujh
                  
                  #albireo 151015-----s
                  IF l_tmp.d > 0 THEN
                     LET l_tmp.sw = '1'
                  ELSE
                     LET l_tmp.sw = '2'
                  END IF
                  #albireo 151015-----e                  
                 
                  INSERT INTO s_vr_tmp06 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
               END FOREACH
            ELSE  #不存在於 nmbv_t
                LET l_tmp.glaq002 = l_nmbt030   #科目
                LET l_tmp.glaq005 = l_nmbt100   #幣別
                LET l_tmp.glaq006 = l_nmbt101   #匯率
                LET l_tmp.glaq010 = l_nmbt103   #原幣金額
                LET l_tmp.d = 0                 #借方金額
              # LET l_tmp.c =  l_tmp.d          #貸方金額
                LET l_tmp.c = l_nmbt113
                LET l_tmp.glaq041 = l_nmbt123   #貸方金額二
                LET l_tmp.glaq044 = l_nmbt133   #貸方金額三
                 LET l_tmp.glaq040 = 0          #借方金額二
                LET l_tmp.glaq043 = 0           #借方金額三
                #151124 mark by Reanna------
                ##固定核算項目+自由核算項目
                #LET l_tmp.glaq017 = l_nmbt017
                #LET l_tmp.glaq018 = l_nmbt018
                #LET l_tmp.glaq019 = l_nmbt019
                #LET l_tmp.glaq020 = l_nmbt020
                #LET l_tmp.glaq021 = l_nmbt021
                #LET l_tmp.glaq022 = l_nmbt022
                #LET l_tmp.glaq023 = l_nmbt023
                #LET l_tmp.glaq024 = l_nmbt024
                #LET l_tmp.glaq025 = l_nmbt025
                ##LET l_tmp.glaq026 = l_nmbt026    #151111-00001#1 mark lujh  
                #LET l_tmp.glaq027 = l_nmbt027
                #LET l_tmp.glaq028 = l_nmbt028
                #LET l_tmp.glaq051 = l_nmbt031
                #LET l_tmp.glaq052 = l_nmbt032
                #LET l_tmp.glaq053 = l_nmbt033
                #LET l_tmp.glaq029 = l_nmbv029
                #LET l_tmp.glaq030 = l_nmbv030
                #LET l_tmp.glaq031 = l_nmbv031
                #LET l_tmp.glaq032 = l_nmbv032
                #LET l_tmp.glaq033 = l_nmbv033
                #LET l_tmp.glaq034 = l_nmbv034
                #LET l_tmp.glaq035 = l_nmbv035
                #LET l_tmp.glaq036 = l_nmbv036
                #LET l_tmp.glaq037 = l_nmbv037
                #LET l_tmp.glaq038 = l_nmbv038
                #151124 mark by Reanna end---
                #150807-00007#2--mark--str
#                SELECT MAX(seq2) + 1 INTO l_tmp.seq2 FROM s_voucher_nm_tmp WHERE docno = l_tmp.docno AND glaqld = l_tmp.glaqld
#                                                                   AND  seq = l_tmp.seq
#                IF cl_null(l_tmp.seq2) THEN
#                    LET l_tmp.seq2 = 1
#                END IF 
#                INSERT INTO  s_voucher_nm_tmp VALUES(l_tmp.*) 
                #150807-00007#2--mark--end
                
                
                #150807-00007#2--add--str
                LET l_cnt = 0
                EXECUTE s_voucher_nm_glac_chk USING l_glaa004,l_tmp.glaq002 INTO l_cnt
                IF l_cnt > 0 THEN  #如果科目為現金科目
                   LET l_cnt = 0
                   EXECUTE s_voucher_nm_glbc_chk USING l_tmp.docno,l_tmp.glaqld,l_tmp.seq INTO l_cnt
                   IF l_cnt > 0 THEN  #存在於 glbc_t
                      FOREACH s_voucher_gen_glbc_cs USING l_tmp.glaqld,l_tmp.docno,l_tmp.seq INTO l_glbcseq1,l_nmbv042,l_nmbt103_1,l_nmbt113_1,l_nmbt123_1,l_nmbt133_1
                         SELECT MAX(seq2) + 1 INTO l_tmp.seq2
                           FROM s_vr_tmp06  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
                          WHERE docno = l_tmp.docno AND glaqld = l_tmp.glaqld AND seq = l_tmp.seq
                         IF cl_null(l_tmp.seq2) THEN
                             LET l_tmp.seq2 = 1
                         END IF 
                         LET l_tmp.glaq010 = l_nmbt103_1   #原幣金額
                         LET l_tmp.d = 0                   #借方金額
                       # LET l_tmp.c =  l_tmp.d            #貸方金額
                         LET l_tmp.c = l_nmbt113_1
                         LET l_tmp.glaq041 = l_nmbt123_1   #貸方金額二
                         LET l_tmp.glaq044 = l_nmbt133_1   #貸方金額三
                          LET l_tmp.glaq040 = 0            #借方金額二
                         LET l_tmp.glaq043 = 0             #借方金額三
                         LET l_tmp.glgb055 = l_nmbv042
                         IF cl_null(l_tmp.glaq001) THEN #151013-00019#2
                            #150918-00001#3--add--str--lujh
                            #                 2:摘要/账套    /科目编号     /程序编号/目的字段/单据编号/单据项次1/单据项次2
                            CALL s_account_item('2',l_tmp.glaqld,l_tmp.glaq002,p_source,'glgb001',l_tmp.docno,l_tmp.seq,'')
                            RETURNING l_tmp.glaq001
                            #150918-00001#3--add--end--lujh
                         END IF #151013-00019#2
                         
                         #151111-00001#1--add--str--lujh
                         LET g_free_m.free_item_1 = l_tmp.glaq029
                         LET g_free_m.free_item_2 = l_tmp.glaq030
                         LET g_free_m.free_item_3 = l_tmp.glaq031
                         LET g_free_m.free_item_4 = l_tmp.glaq032
                         LET g_free_m.free_item_5 = l_tmp.glaq033
                         LET g_free_m.free_item_6 = l_tmp.glaq034
                         LET g_free_m.free_item_7 = l_tmp.glaq035
                         LET g_free_m.free_item_8 = l_tmp.glaq036
                         LET g_free_m.free_item_9 = l_tmp.glaq037
                         LET g_free_m.free_item_10 = l_tmp.glaq038
                         
                         LET g_field_m.field1 = 'glgb029'
                         LET g_field_m.field2 = 'glgb030'
                         LET g_field_m.field3 = 'glgb031'
                         LET g_field_m.field4 = 'glgb032'
                         LET g_field_m.field5 = 'glgb033'
                         LET g_field_m.field6 = 'glgb034'
                         LET g_field_m.field7 = 'glgb035'
                         LET g_field_m.field8 = 'glgb036'
                         LET g_field_m.field9 = 'glgb037'
                         LET g_field_m.field10 = 'glgb038'
                         
                         CALL s_account_item_free(l_tmp.glaqld,l_tmp.glaq002,p_source,l_tmp.docno,l_tmp.seq,'',g_free_m.*,g_field_m.*)
                         RETURNING l_tmp.glaq029,l_tmp.glaq030,l_tmp.glaq031,l_tmp.glaq032,
                                   l_tmp.glaq033,l_tmp.glaq034,l_tmp.glaq035,l_tmp.glaq036,
                                   l_tmp.glaq037,l_tmp.glaq038
                         #151111-00001#1--add--str--lujh
                         
                         #albireo 151015-----s
                         IF l_tmp.d > 0 THEN
                            LET l_tmp.sw = '1'
                         ELSE
                            LET l_tmp.sw = '2'
                         END IF
                         #albireo 151015-----e  
                         LET l_tmp.sum = l_tmp.glaq010   #170324-00067#1                         
                         INSERT INTO s_vr_tmp06 VALUES(l_tmp.*)   #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
                      END FOREACH
                   ELSE
                      SELECT MAX(seq2) + 1 INTO l_tmp.seq2
                        FROM s_vr_tmp06   #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
                       WHERE docno = l_tmp.docno AND glaqld = l_tmp.glaqld AND seq = l_tmp.seq
                      IF cl_null(l_tmp.seq2) THEN
                          LET l_tmp.seq2 = 1
                      END IF
                      IF cl_null(l_tmp.glaq001) THEN #151013-00019#2                      
                         #150918-00001#3--add--str--lujh
                         #                 2:摘要/账套    /科目编号     /程序编号/目的字段/单据编号/单据项次1/单据项次2
                         CALL s_account_item('2',l_tmp.glaqld,l_tmp.glaq002,p_source,'glgb001',l_tmp.docno,l_tmp.seq,'')
                         RETURNING l_tmp.glaq001
                         #150918-00001#3--add--end--lujh
                      END IF #151013-00019#2
                      
                      #151111-00001#1--add--str--lujh
                      LET g_free_m.free_item_1 = l_tmp.glaq029
                      LET g_free_m.free_item_2 = l_tmp.glaq030
                      LET g_free_m.free_item_3 = l_tmp.glaq031
                      LET g_free_m.free_item_4 = l_tmp.glaq032
                      LET g_free_m.free_item_5 = l_tmp.glaq033
                      LET g_free_m.free_item_6 = l_tmp.glaq034
                      LET g_free_m.free_item_7 = l_tmp.glaq035
                      LET g_free_m.free_item_8 = l_tmp.glaq036
                      LET g_free_m.free_item_9 = l_tmp.glaq037
                      LET g_free_m.free_item_10 = l_tmp.glaq038
                      
                      LET g_field_m.field1 = 'glgb029'
                      LET g_field_m.field2 = 'glgb030'
                      LET g_field_m.field3 = 'glgb031'
                      LET g_field_m.field4 = 'glgb032'
                      LET g_field_m.field5 = 'glgb033'
                      LET g_field_m.field6 = 'glgb034'
                      LET g_field_m.field7 = 'glgb035'
                      LET g_field_m.field8 = 'glgb036'
                      LET g_field_m.field9 = 'glgb037'
                      LET g_field_m.field10 = 'glgb038'
                      
                      CALL s_account_item_free(l_tmp.glaqld,l_tmp.glaq002,p_source,l_tmp.docno,l_tmp.seq,'',g_free_m.*,g_field_m.*)
                      RETURNING l_tmp.glaq029,l_tmp.glaq030,l_tmp.glaq031,l_tmp.glaq032,
                                l_tmp.glaq033,l_tmp.glaq034,l_tmp.glaq035,l_tmp.glaq036,
                                l_tmp.glaq037,l_tmp.glaq038
                      #151111-00001#1--add--str--lujh
                      
                      #albireo 151015-----s
                      IF l_tmp.d > 0 THEN
                         LET l_tmp.sw = '1'
                      ELSE
                         LET l_tmp.sw = '2'
                      END IF
                      #albireo 151015-----e     
                      LET l_tmp.sum = l_tmp.glaq010   #170324-00067#1                      
                      INSERT INTO  s_vr_tmp06 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
                   END IF
                ELSE
                   SELECT MAX(seq2) + 1 INTO l_tmp.seq2
                     FROM s_vr_tmp06  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
                    WHERE docno = l_tmp.docno AND glaqld = l_tmp.glaqld AND seq = l_tmp.seq
                   IF cl_null(l_tmp.seq2) THEN
                       LET l_tmp.seq2 = 1
                   END IF
                   IF cl_null(l_tmp.glaq001) THEN #151013-00019#2
                      #150918-00001#3--add--str--lujh
                      #                 2:摘要/账套    /科目编号     /程序编号/目的字段/单据编号/单据项次1/单据项次2
                      CALL s_account_item('2',l_tmp.glaqld,l_tmp.glaq002,p_source,'glgb001',l_tmp.docno,l_tmp.seq,'')
                      RETURNING l_tmp.glaq001
                      #150918-00001#3--add--end--lujh
                   END IF #151013-00019#2
                   
                   #151111-00001#1--add--str--lujh
                   LET g_free_m.free_item_1 = l_tmp.glaq029
                   LET g_free_m.free_item_2 = l_tmp.glaq030
                   LET g_free_m.free_item_3 = l_tmp.glaq031
                   LET g_free_m.free_item_4 = l_tmp.glaq032
                   LET g_free_m.free_item_5 = l_tmp.glaq033
                   LET g_free_m.free_item_6 = l_tmp.glaq034
                   LET g_free_m.free_item_7 = l_tmp.glaq035
                   LET g_free_m.free_item_8 = l_tmp.glaq036
                   LET g_free_m.free_item_9 = l_tmp.glaq037
                   LET g_free_m.free_item_10 = l_tmp.glaq038
                   
                   LET g_field_m.field1 = 'glgb029'
                   LET g_field_m.field2 = 'glgb030'
                   LET g_field_m.field3 = 'glgb031'
                   LET g_field_m.field4 = 'glgb032'
                   LET g_field_m.field5 = 'glgb033'
                   LET g_field_m.field6 = 'glgb034'
                   LET g_field_m.field7 = 'glgb035'
                   LET g_field_m.field8 = 'glgb036'
                   LET g_field_m.field9 = 'glgb037'
                   LET g_field_m.field10 = 'glgb038'
                   
                   CALL s_account_item_free(l_tmp.glaqld,l_tmp.glaq002,p_source,l_tmp.docno,l_tmp.seq,'',g_free_m.*,g_field_m.*)
                   RETURNING l_tmp.glaq029,l_tmp.glaq030,l_tmp.glaq031,l_tmp.glaq032,
                             l_tmp.glaq033,l_tmp.glaq034,l_tmp.glaq035,l_tmp.glaq036,
                             l_tmp.glaq037,l_tmp.glaq038
                   #151111-00001#1--add--str--lujh
                   
                   #albireo 151015-----s
                   IF l_tmp.d > 0 THEN
                      LET l_tmp.sw = '1'
                   ELSE
                      LET l_tmp.sw = '2'
                   END IF
                   #albireo 151015-----e    
                   LET l_tmp.sum = l_tmp.glaq010   #170324-00067#1                   
                   INSERT INTO  s_vr_tmp06 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
                END IF
                #150807-00007#2--add--end
            END IF
         END IF   #anmt311除外
      END IF
      
      #l_nmbb001 = '2' #提出 l_nmbb001 = '4' #貸方科目
      #l_nmck026 = '0' #應付票據自動產生 l_nmck026 = '1' #應付票據開立  l_nmck026 = '10' 付款單開立
      #l_nmbb042 = '2' #應收票據托收,l_nmbb042 = '4' #應收票據票貼，l_nmbb042 = '5' #應收票據轉付
      #l_nmbb042 = '6' #應收票據撤票,l_nmbb042 = '7' #應收票據跳票 ,l_nmbb042 = '8' #應收票據兌現
      IF l_nmbb001 = '2' OR l_nmbb001 = '4' OR l_nmck026 = '0' OR l_nmck026 = '1' OR l_nmck026 = '10' OR l_nmbb042 = '2'
         OR l_nmbb042 = '4' OR l_nmbb042 = '5' OR l_nmbb042 = '6' OR l_nmbb042 = '7' OR l_nmbb042 = '8' THEN
        #IF p_source <> 'anmt311' THEN  #anmt311 除非                                    #150707-00001#7 mark
         #anmt311但來源為4:繳款單者或13.员工缴款单,需產生貸方分錄
#         IF p_source <> 'anmt311' OR (p_source = 'anmt311' AND l_nmbt001 = '4') THEN     #150707-00001#7  #170723-00001#1 20170724 mark by 08172
         IF p_source <> 'anmt311' OR (p_source = 'anmt311' AND (l_nmbt001 = '4' OR l_nmbt001 = '13')) THEN     #170723-00001#1 20170724 add by 08172
            LET l_cnt = 0
            #SELECT COUNT(*) INTO l_cnt         #170615-00061#25 mark
            SELECT COUNT(nmbvdocno) INTO l_cnt  #170615-00061#25 add
              FROM nmbv_t
             WHERE nmbvent = g_enterprise AND nmbvdocno = l_tmp.docno
               AND nmbvld = l_tmp.glaqld AND nmbvseq =  l_tmp.seq
            IF l_cnt > 0 THEN  #存在於 nmbv_t
               #150918-00001#5 add nmbv100
               FOREACH s_voucher_gen_nmbv_cs USING l_tmp.glaqld,l_tmp.docno,l_tmp.seq
                     INTO l_nmbvseq2,l_nmbv001,l_nmbv103,l_nmbv113,l_nmbv123,
                          l_nmbv133,l_nmbv017,l_nmbv018,l_nmbv019,l_nmbv020,
                          l_nmbv021,l_nmbv022,l_nmbv023,l_nmbv024,l_nmbv025,
                          l_nmbv026,l_nmbv027,l_nmbv028,l_nmbv039,l_nmbv040,
                          l_nmbv041,l_nmbv042,l_nmbv029,l_nmbv030,l_nmbv031,  #150807-00007#2 add nmbv042
                          l_nmbv032,l_nmbv033,l_nmbv034,l_nmbv035,l_nmbv036,
                          l_nmbv037,l_nmbv038,l_nmbv100
                  
                  LET l_tmp.glaq002 = l_nmbv001   #科目
                 #LET l_tmp.glaq005 = l_nmbt100     #幣別 #150918-00001#5 mark
                  #150918-00001#5 add ------
                  LET l_tmp.glaq005 = l_nmbv100     #幣別
                  #若是匯差的部份，匯率=1
                  IF l_nmbv100 <> l_nmbt100 THEN
                     LET l_tmp.glaq006 = 1          #匯率
                  ELSE
                     LET l_tmp.glaq006 = l_nmbt101  #匯率
                  END IF
                  #150918-00001#5 add end---
                  
                  LET l_tmp.glaq010 = l_nmbv103   #原幣金額
                  LET l_tmp.d = l_nmbv113         #借方金額
                  LET l_tmp.glaq040 = l_nmbv123   #借方金額二
                  LET l_tmp.glaq043 = l_nmbv133   #借方金額三
                  LET l_tmp.c = 0                 #貸方金額
                  LET l_tmp.glaq041 = 0           #貸方金額二
                  LET l_tmp.glaq044 = 0           #貸方金額三
                  #170324-00067#1-----s
                   IF l_nmbv100 <> l_nmbt100 THEN
                     LET l_tmp.glaq006 = 1          #匯率
                     LET l_tmp.sum = l_nmbv113
                  ELSE
                     LET l_tmp.glaq006 = l_nmbt101  #匯率
                     LET l_tmp.sum = l_tmp.glaq010
                  END IF
                  #170324-00067#1-----e
                  #150918-00001#5 add ------
                  #若為負數金額,則借貸方向要相反
                  IF l_tmp.d < 0 THEN
                     LET l_tmp.sw = '2'
                     LET l_tmp.c = l_tmp.d * -1
                     LET l_tmp.sum = l_tmp.sum * -1 #原幣
                     LET l_tmp.glaq010 = l_tmp.glaq010 * -1
                     LET l_tmp.d = 0
                     LET l_tmp.glaq041 = l_tmp.glaq040 * -1 #本位幣二
                     LET l_tmp.glaq040 = 0
                     LET l_tmp.glaq044 = l_tmp.glaq043 * -1 #本位幣三
                     LET l_tmp.glaq043 = 0
                  END IF
                  #150918-00001#5 add end---
                  #151124 mark by Reanna------
                  ##固定核算項目+自由核算項目
                  #LET l_tmp.glaq017 = l_nmbv017
                  #LET l_tmp.glaq018 = l_nmbv018
                  #LET l_tmp.glaq019 = l_nmbv019
                  #LET l_tmp.glaq020 = l_nmbv020
                  #LET l_tmp.glaq021 = l_nmbv021
                  #LET l_tmp.glaq022 = l_nmbv022
                  #LET l_tmp.glaq023 = l_nmbv023
                  #LET l_tmp.glaq024 = l_nmbv024
                  #LET l_tmp.glaq025 = l_nmbv025
                  ##LET l_tmp.glaq026 = l_nmbv026   #151111-00001#1 mark lujh  
                  #LET l_tmp.glaq027 = l_nmbv027
                  #LET l_tmp.glaq028 = l_nmbv028
                  #LET l_tmp.glaq051 = l_nmbv039
                  #LET l_tmp.glaq052 = l_nmbv040
                  #LET l_tmp.glaq053 = l_nmbv041
                  #LET l_tmp.glaq029 = l_nmbv029
                  #LET l_tmp.glaq030 = l_nmbv030
                  #LET l_tmp.glaq031 = l_nmbv031
                  #LET l_tmp.glaq032 = l_nmbv032
                  #LET l_tmp.glaq033 = l_nmbv033
                  #LET l_tmp.glaq034 = l_nmbv034
                  #LET l_tmp.glaq035 = l_nmbv035
                  #LET l_tmp.glaq036 = l_nmbv036
                  #LET l_tmp.glaq037 = l_nmbv037
                  #LET l_tmp.glaq038 = l_nmbv038
                  LET l_tmp.glgb055  = l_nmbv042   #150807-00007#2 add #151130 remark by Reanna
                  #151124 mark by Reanna end---
                  
                  SELECT MAX(seq2) + 1 INTO l_tmp.seq2
                    FROM s_vr_tmp06  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
                   WHERE docno = l_tmp.docno AND glaqld = l_tmp.glaqld AND seq = l_tmp.seq
                  IF cl_null(l_tmp.seq2) THEN
                     LET l_tmp.seq2 = 1
                  END IF
                  IF cl_null(l_tmp.glaq001) THEN #151013-00019#2
                     #150918-00001#3--add--str--lujh
                     #                 2:摘要/账套    /科目编号     /程序编号/目的字段/单据编号/单据项次1/单据项次2
                     CALL s_account_item('2',l_tmp.glaqld,l_tmp.glaq002,p_source,'glgb001',l_tmp.docno,l_tmp.seq,'')
                     RETURNING l_tmp.glaq001
                     #150918-00001#3--add--end--lujh
                  END IF #151013-00019#2
                  
                  #151111-00001#1--add--str--lujh
                  LET g_free_m.free_item_1 = l_tmp.glaq029
                  LET g_free_m.free_item_2 = l_tmp.glaq030
                  LET g_free_m.free_item_3 = l_tmp.glaq031
                  LET g_free_m.free_item_4 = l_tmp.glaq032
                  LET g_free_m.free_item_5 = l_tmp.glaq033
                  LET g_free_m.free_item_6 = l_tmp.glaq034
                  LET g_free_m.free_item_7 = l_tmp.glaq035
                  LET g_free_m.free_item_8 = l_tmp.glaq036
                  LET g_free_m.free_item_9 = l_tmp.glaq037
                  LET g_free_m.free_item_10 = l_tmp.glaq038
                  
                  LET g_field_m.field1 = 'glgb029'
                  LET g_field_m.field2 = 'glgb030'
                  LET g_field_m.field3 = 'glgb031'
                  LET g_field_m.field4 = 'glgb032'
                  LET g_field_m.field5 = 'glgb033'
                  LET g_field_m.field6 = 'glgb034'
                  LET g_field_m.field7 = 'glgb035'
                  LET g_field_m.field8 = 'glgb036'
                  LET g_field_m.field9 = 'glgb037'
                  LET g_field_m.field10 = 'glgb038'
                  
                  CALL s_account_item_free(l_tmp.glaqld,l_tmp.glaq002,p_source,l_tmp.docno,l_tmp.seq,'',g_free_m.*,g_field_m.*)
                  RETURNING l_tmp.glaq029,l_tmp.glaq030,l_tmp.glaq031,l_tmp.glaq032,
                            l_tmp.glaq033,l_tmp.glaq034,l_tmp.glaq035,l_tmp.glaq036,
                            l_tmp.glaq037,l_tmp.glaq038
                  #151111-00001#1--add--str--lujh
                  
                  #albireo 151015-----s
                  IF l_tmp.d > 0 THEN
                     LET l_tmp.sw = '1'
                  ELSE
                     LET l_tmp.sw = '2'
                  END IF
                  #albireo 151015-----e                  
                  INSERT INTO s_vr_tmp06 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
               END FOREACH
            ELSE
               LET l_tmp.glaq002 = l_nmbt030   #科目
               LET l_tmp.glaq005 = l_nmbt100   #幣別
               LET l_tmp.glaq006 = l_nmbt101   #匯率
               LET l_tmp.glaq010 = l_nmbt103   #原幣金額
               LET l_tmp.d = l_nmbt113         #借方金額
               LET l_tmp.glaq040 = l_nmbt123   #借方金額二
               LET l_tmp.glaq043 = l_nmbt133   #借方金額三
               LET l_tmp.c =  0                #貸方金額
               LET l_tmp.glaq041 = 0           #貸方金額二
               LET l_tmp.glaq044 = 0           #貸方金額三
               #151124 mark by Reanna------
               ##固定核算項目+自由核算項目
               #LET l_tmp.glaq017 = l_nmbt017
               #LET l_tmp.glaq018 = l_nmbt018
               #LET l_tmp.glaq019 = l_nmbt019
               #LET l_tmp.glaq020 = l_nmbt020
               #LET l_tmp.glaq021 = l_nmbt021
               #LET l_tmp.glaq022 = l_nmbt022
               #LET l_tmp.glaq023 = l_nmbt023
               #LET l_tmp.glaq024 = l_nmbt024
               #LET l_tmp.glaq025 = l_nmbt025
               ##LET l_tmp.glaq026 = l_nmbt026    #151111-00001#1 mark lujh  
               #LET l_tmp.glaq027 = l_nmbt027
               #LET l_tmp.glaq028 = l_nmbt028
               #LET l_tmp.glaq051 = l_nmbt031
               #LET l_tmp.glaq052 = l_nmbt032
               #LET l_tmp.glaq053 = l_nmbt033
               #LET l_tmp.glaq029 = l_nmbv029
               #LET l_tmp.glaq030 = l_nmbv030
               #LET l_tmp.glaq031 = l_nmbv031
               #LET l_tmp.glaq032 = l_nmbv032
               #LET l_tmp.glaq033 = l_nmbv033
               #LET l_tmp.glaq034 = l_nmbv034
               #LET l_tmp.glaq035 = l_nmbv035
               #LET l_tmp.glaq036 = l_nmbv036
               #LET l_tmp.glaq037 = l_nmbv037
               #LET l_tmp.glaq038 = l_nmbv038
               #151124 mark by Reanna end---
               #150807-00007#2--mark--str
#              SELECT MAX(seq2) + 1 INTO l_tmp.seq2 FROM s_voucher_nm_tmp WHERE docno = l_tmp.docno AND glaqld = l_tmp.glaqld
#                                                                    AND  seq = l_tmp.seq
#              IF cl_null(l_tmp.seq2) THEN
#                 LET l_tmp.seq2 = 1
#              END IF
#              INSERT INTO  s_voucher_nm_tmp VALUES(l_tmp.*)
               #150807-00007#2--mark--end
               #150807-00007#2--add--str
               LET l_cnt = 0
               EXECUTE s_voucher_nm_glac_chk USING l_glaa004,l_tmp.glaq002 INTO l_cnt
               IF l_cnt > 0 THEN  #如果科目為現金科目
                  LET l_cnt = 0
                  EXECUTE s_voucher_nm_glbc_chk USING l_tmp.docno,l_tmp.glaqld,l_tmp.seq INTO l_cnt
                  IF l_cnt > 0 THEN  #存在於 glbc_t
                     FOREACH s_voucher_gen_glbc_cs USING l_tmp.glaqld,l_tmp.docno,l_tmp.seq INTO l_glbcseq1,l_nmbv042,l_nmbt103_1,l_nmbt113_1,l_nmbt123_1,l_nmbt133_1
                        SELECT MAX(seq2) + 1 INTO l_tmp.seq2
                          FROM s_vr_tmp06  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
                         WHERE docno = l_tmp.docno AND glaqld = l_tmp.glaqld AND seq = l_tmp.seq
                        IF cl_null(l_tmp.seq2) THEN
                            LET l_tmp.seq2 = 1
                        END IF
                        LET l_tmp.glaq010 = l_nmbt103_1   #原幣金額
                        LET l_tmp.d = l_nmbt113_1         #借方金額
                        LET l_tmp.glaq040 = l_nmbt123_1   #借方金額二
                        LET l_tmp.glaq043 = l_nmbt133_1   #借方金額三
                        LET l_tmp.c =  0                  #貸方金額
                        LET l_tmp.glaq041 = 0             #貸方金額二
                        LET l_tmp.glaq044 = 0             #貸方金額三
                        LET l_tmp.glgb055 = l_nmbv042
                        IF cl_null(l_tmp.glaq001) THEN #151013-00019#2
                           #150918-00001#3--add--str--lujh
                           #                 2:摘要/账套    /科目编号     /程序编号/目的字段/单据编号/单据项次1/单据项次2
                           CALL s_account_item('2',l_tmp.glaqld,l_tmp.glaq002,p_source,'glgb001',l_tmp.docno,l_tmp.seq,'')
                           RETURNING l_tmp.glaq001
                           #150918-00001#3--add--end--lujh
                        END IF #151013-00019#2
                        
                        #151111-00001#1--add--str--lujh
                        LET g_free_m.free_item_1 = l_tmp.glaq029
                        LET g_free_m.free_item_2 = l_tmp.glaq030
                        LET g_free_m.free_item_3 = l_tmp.glaq031
                        LET g_free_m.free_item_4 = l_tmp.glaq032
                        LET g_free_m.free_item_5 = l_tmp.glaq033
                        LET g_free_m.free_item_6 = l_tmp.glaq034
                        LET g_free_m.free_item_7 = l_tmp.glaq035
                        LET g_free_m.free_item_8 = l_tmp.glaq036
                        LET g_free_m.free_item_9 = l_tmp.glaq037
                        LET g_free_m.free_item_10 = l_tmp.glaq038
                        
                        LET g_field_m.field1 = 'glgb029'
                        LET g_field_m.field2 = 'glgb030'
                        LET g_field_m.field3 = 'glgb031'
                        LET g_field_m.field4 = 'glgb032'
                        LET g_field_m.field5 = 'glgb033'
                        LET g_field_m.field6 = 'glgb034'
                        LET g_field_m.field7 = 'glgb035'
                        LET g_field_m.field8 = 'glgb036'
                        LET g_field_m.field9 = 'glgb037'
                        LET g_field_m.field10 = 'glgb038'
                        
                        CALL s_account_item_free(l_tmp.glaqld,l_tmp.glaq002,p_source,l_tmp.docno,l_tmp.seq,'',g_free_m.*,g_field_m.*)
                        RETURNING l_tmp.glaq029,l_tmp.glaq030,l_tmp.glaq031,l_tmp.glaq032,
                                  l_tmp.glaq033,l_tmp.glaq034,l_tmp.glaq035,l_tmp.glaq036,
                                  l_tmp.glaq037,l_tmp.glaq038
                        #151111-00001#1--add--str--lujh
                        
                        #albireo 151015-----s
                        IF l_tmp.d > 0 THEN
                           LET l_tmp.sw = '1'
                        ELSE
                           LET l_tmp.sw = '2'
                        END IF
                        #albireo 151015-----e
                        LET l_tmp.sum = l_tmp.glaq010   #170324-00067#1
                        INSERT INTO s_vr_tmp06 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
                     END FOREACH
                  ELSE
                     SELECT MAX(seq2) + 1 INTO l_tmp.seq2
                       FROM s_vr_tmp06  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
                      WHERE docno = l_tmp.docno AND glaqld = l_tmp.glaqld AND seq = l_tmp.seq
                     IF cl_null(l_tmp.seq2) THEN
                         LET l_tmp.seq2 = 1
                     END IF
                     IF cl_null(l_tmp.glaq001) THEN #151013-00019#2
                        #150918-00001#3--add--str--lujh
                        #                 2:摘要/账套    /科目编号     /程序编号/目的字段/单据编号/单据项次1/单据项次2
                        CALL s_account_item('2',l_tmp.glaqld,l_tmp.glaq002,p_source,'glgb001',l_tmp.docno,l_tmp.seq,'')
                        RETURNING l_tmp.glaq001
                        #150918-00001#3--add--end--lujh
                     END IF #151013-00019#2
                     
                     #151111-00001#1--add--str--lujh
                     LET g_free_m.free_item_1 = l_tmp.glaq029
                     LET g_free_m.free_item_2 = l_tmp.glaq030
                     LET g_free_m.free_item_3 = l_tmp.glaq031
                     LET g_free_m.free_item_4 = l_tmp.glaq032
                     LET g_free_m.free_item_5 = l_tmp.glaq033
                     LET g_free_m.free_item_6 = l_tmp.glaq034
                     LET g_free_m.free_item_7 = l_tmp.glaq035
                     LET g_free_m.free_item_8 = l_tmp.glaq036
                     LET g_free_m.free_item_9 = l_tmp.glaq037
                     LET g_free_m.free_item_10 = l_tmp.glaq038
                     
                     LET g_field_m.field1 = 'glgb029'
                     LET g_field_m.field2 = 'glgb030'
                     LET g_field_m.field3 = 'glgb031'
                     LET g_field_m.field4 = 'glgb032'
                     LET g_field_m.field5 = 'glgb033'
                     LET g_field_m.field6 = 'glgb034'
                     LET g_field_m.field7 = 'glgb035'
                     LET g_field_m.field8 = 'glgb036'
                     LET g_field_m.field9 = 'glgb037'
                     LET g_field_m.field10 = 'glgb038'
                     
                     CALL s_account_item_free(l_tmp.glaqld,l_tmp.glaq002,p_source,l_tmp.docno,l_tmp.seq,'',g_free_m.*,g_field_m.*)
                     RETURNING l_tmp.glaq029,l_tmp.glaq030,l_tmp.glaq031,l_tmp.glaq032,
                               l_tmp.glaq033,l_tmp.glaq034,l_tmp.glaq035,l_tmp.glaq036,
                               l_tmp.glaq037,l_tmp.glaq038
                     #151111-00001#1--add--str--lujh
                     
                     #albireo 151015-----s
                     IF l_tmp.d > 0 THEN
                        LET l_tmp.sw = '1'
                     ELSE
                        LET l_tmp.sw = '2'
                     END IF
                     #albireo 151015-----e        
                     LET l_tmp.sum = l_tmp.glaq010   #170324-00067#1                     
                     INSERT INTO  s_vr_tmp06 VALUES(l_tmp.*)   #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
                  END IF 
               ELSE
                  SELECT MAX(seq2) + 1 INTO l_tmp.seq2
                    FROM s_vr_tmp06  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
                   WHERE docno = l_tmp.docno AND glaqld = l_tmp.glaqld AND seq = l_tmp.seq
                  IF cl_null(l_tmp.seq2) THEN
                      LET l_tmp.seq2 = 1
                  END IF
                  IF cl_null(l_tmp.glaq001) THEN #151013-00019#2
                     #150918-00001#3--add--str--lujh
                     #                 2:摘要/账套    /科目编号     /程序编号/目的字段/单据编号/单据项次1/单据项次2
                     CALL s_account_item('2',l_tmp.glaqld,l_tmp.glaq002,p_source,'glgb001',l_tmp.docno,l_tmp.seq,'')
                     RETURNING l_tmp.glaq001
                     #150918-00001#3--add--end--lujh
                  END IF #151013-00019#2
                  
                  #151111-00001#1--add--str--lujh
                  LET g_free_m.free_item_1 = l_tmp.glaq029
                  LET g_free_m.free_item_2 = l_tmp.glaq030
                  LET g_free_m.free_item_3 = l_tmp.glaq031
                  LET g_free_m.free_item_4 = l_tmp.glaq032
                  LET g_free_m.free_item_5 = l_tmp.glaq033
                  LET g_free_m.free_item_6 = l_tmp.glaq034
                  LET g_free_m.free_item_7 = l_tmp.glaq035
                  LET g_free_m.free_item_8 = l_tmp.glaq036
                  LET g_free_m.free_item_9 = l_tmp.glaq037
                  LET g_free_m.free_item_10 = l_tmp.glaq038
                  
                  LET g_field_m.field1 = 'glgb029'
                  LET g_field_m.field2 = 'glgb030'
                  LET g_field_m.field3 = 'glgb031'
                  LET g_field_m.field4 = 'glgb032'
                  LET g_field_m.field5 = 'glgb033'
                  LET g_field_m.field6 = 'glgb034'
                  LET g_field_m.field7 = 'glgb035'
                  LET g_field_m.field8 = 'glgb036'
                  LET g_field_m.field9 = 'glgb037'
                  LET g_field_m.field10 = 'glgb038'
                  
                  CALL s_account_item_free(l_tmp.glaqld,l_tmp.glaq002,p_source,l_tmp.docno,l_tmp.seq,'',g_free_m.*,g_field_m.*)
                  RETURNING l_tmp.glaq029,l_tmp.glaq030,l_tmp.glaq031,l_tmp.glaq032,
                            l_tmp.glaq033,l_tmp.glaq034,l_tmp.glaq035,l_tmp.glaq036,
                            l_tmp.glaq037,l_tmp.glaq038
                  #151111-00001#1--add--str--lujh
                  
                  #albireo 151015-----s
                  IF l_tmp.d > 0 THEN
                     LET l_tmp.sw = '1'
                  ELSE
                     LET l_tmp.sw = '2'
                  END IF
                  #albireo 151015-----e   

                  LET l_tmp.sum = l_tmp.glaq010   #170324-00067#1
                  INSERT INTO  s_vr_tmp06 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
               END IF
               #150807-00007#2--add--end
            END IF
         END IF  #anmt311 除非
         
         LET l_tmp.glaq002 = l_nmbt029   #科目
         LET l_tmp.glaq005 = l_nmbt100   #幣別
         #150918-00001#5 add ------
         IF p_source <> 'anmt311' THEN
            #如果是anmt470 & anmt530，匯率要取開立單據的為準
            SELECT nmbb005 INTO l_tmp.glaq006
              FROM nmbb_t
              LEFT JOIN nmcr_t ON nmbbent = nmcrent AND nmbbdocno = nmcr003 AND nmbb030 = nmcr001
             WHERE nmbbent = g_enterprise AND nmbbcomp = l_tmp.glaqcomp
               AND nmcrdocno = l_nmbt002 AND nmcrseq = l_nmbt003
         ELSE
         #150918-00001#5 add end---
            LET l_tmp.glaq006 = l_nmbt101   #匯率
         END IF  #150918-00001#5
         LET l_tmp.glaq010 = l_nmbt103   #原幣金額
         LET l_tmp.d = 0                 #借方金額
         LET l_tmp.c = l_nmbt113         #貸方金額
         LET l_tmp.glaq041 = l_nmbt123   #貸方金額二
         LET l_tmp.glaq044 = l_nmbt133   #貸方金額三
         LET l_tmp.glaq040 = 0           #借方金額二
         LET l_tmp.glaq043 = 0           #借方金額三
         LET l_tmp.glgb055 = ''
         #150807-00007#2--add--str
         LET l_cnt = 0
         #151015 remark--s
         #150918-00001#5 mark ------
         EXECUTE s_voucher_nm_glac_chk USING l_glaa004,l_tmp.glaq002 INTO l_cnt
         IF l_cnt > 0 THEN  #如果科目為現金科目
            LET l_cnt = 0
            EXECUTE s_voucher_nm_glbc_chk USING l_tmp.docno,l_tmp.glaqld,l_tmp.seq INTO l_cnt
            IF l_cnt > 0 THEN  #存在於 glbc_t
               FOREACH s_voucher_gen_glbc_cs USING l_tmp.glaqld,l_tmp.docno,l_tmp.seq INTO l_glbcseq1,l_nmbv042,l_nmbt103_1,l_nmbt113_1,l_nmbt123_1,l_nmbt133_1
                  SELECT MAX(seq2) + 1 INTO l_tmp.seq2
                    FROM s_vr_tmp06  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
                   WHERE docno = l_tmp.docno AND glaqld = l_tmp.glaqld AND seq = l_tmp.seq
                  IF cl_null(l_tmp.seq2) THEN
                      LET l_tmp.seq2 = 1
                  END IF
                  LET l_tmp.glaq010 = l_nmbt103_1   #原幣金額
                  LET l_tmp.d = 0                   #借方金額
                  LET l_tmp.c = l_nmbt113_1         #貸方金額
                  LET l_tmp.glaq041 = l_nmbt123_1   #貸方金額二
                  LET l_tmp.glaq044 = l_nmbt133_1   #貸方金額三
                  LET l_tmp.glaq040 = 0             #借方金額二
                  LET l_tmp.glaq043 = 0             #借方金額三
                  LET l_tmp.glgb055 = l_nmbv042
                  IF cl_null(l_tmp.glaq001) THEN #151013-00019#2
                     #150918-00001#3--add--str--lujh
                     #                 2:摘要/账套    /科目编号     /程序编号/目的字段/单据编号/单据项次1/单据项次2
                     CALL s_account_item('2',l_tmp.glaqld,l_tmp.glaq002,p_source,'glgb001',l_tmp.docno,l_tmp.seq,'')
                     RETURNING l_tmp.glaq001
                     #150918-00001#3--add--end--lujh
                  END IF #151013-00019#2
                  
                  #151111-00001#1--add--str--lujh
                  LET g_free_m.free_item_1 = l_tmp.glaq029
                  LET g_free_m.free_item_2 = l_tmp.glaq030
                  LET g_free_m.free_item_3 = l_tmp.glaq031
                  LET g_free_m.free_item_4 = l_tmp.glaq032
                  LET g_free_m.free_item_5 = l_tmp.glaq033
                  LET g_free_m.free_item_6 = l_tmp.glaq034
                  LET g_free_m.free_item_7 = l_tmp.glaq035
                  LET g_free_m.free_item_8 = l_tmp.glaq036
                  LET g_free_m.free_item_9 = l_tmp.glaq037
                  LET g_free_m.free_item_10 = l_tmp.glaq038
                  
                  LET g_field_m.field1 = 'glgb029'
                  LET g_field_m.field2 = 'glgb030'
                  LET g_field_m.field3 = 'glgb031'
                  LET g_field_m.field4 = 'glgb032'
                  LET g_field_m.field5 = 'glgb033'
                  LET g_field_m.field6 = 'glgb034'
                  LET g_field_m.field7 = 'glgb035'
                  LET g_field_m.field8 = 'glgb036'
                  LET g_field_m.field9 = 'glgb037'
                  LET g_field_m.field10 = 'glgb038'
                  
                  CALL s_account_item_free(l_tmp.glaqld,l_tmp.glaq002,p_source,l_tmp.docno,l_tmp.seq,'',g_free_m.*,g_field_m.*)
                  RETURNING l_tmp.glaq029,l_tmp.glaq030,l_tmp.glaq031,l_tmp.glaq032,
                            l_tmp.glaq033,l_tmp.glaq034,l_tmp.glaq035,l_tmp.glaq036,
                            l_tmp.glaq037,l_tmp.glaq038
                  #151111-00001#1--add--str--lujh
                  
                  #151015-----s
                  IF l_tmp.d > 0 THEN
                     LET l_tmp.sw = '1'
                  ELSE
                     LET l_tmp.sw = '2'
                  END IF
                  #151015-----e       
                  LET l_tmp.sum = l_tmp.glaq010   #170324-00067#1                  
                  INSERT INTO  s_vr_tmp06 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
               END FOREACH
            ELSE
               SELECT MAX(seq2) + 1 INTO l_tmp.seq2
                 FROM s_vr_tmp06  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
                WHERE docno = l_tmp.docno AND glaqld = l_tmp.glaqld AND seq = l_tmp.seq
               IF cl_null(l_tmp.seq2) THEN
                   LET l_tmp.seq2 = 1
               END IF
               IF cl_null(l_tmp.glaq001) THEN #151013-00019#2
                  #150918-00001#3--add--str--lujh
                  #                 2:摘要/账套    /科目编号     /程序编号/目的字段/单据编号/单据项次1/单据项次2
                  CALL s_account_item('2',l_tmp.glaqld,l_tmp.glaq002,p_source,'glgb001',l_tmp.docno,l_tmp.seq,'')
                  RETURNING l_tmp.glaq001
                  #150918-00001#3--add--end--lujh
               END IF #151013-00019#2
               
               #151111-00001#1--add--str--lujh
               LET g_free_m.free_item_1 = l_tmp.glaq029
               LET g_free_m.free_item_2 = l_tmp.glaq030
               LET g_free_m.free_item_3 = l_tmp.glaq031
               LET g_free_m.free_item_4 = l_tmp.glaq032
               LET g_free_m.free_item_5 = l_tmp.glaq033
               LET g_free_m.free_item_6 = l_tmp.glaq034
               LET g_free_m.free_item_7 = l_tmp.glaq035
               LET g_free_m.free_item_8 = l_tmp.glaq036
               LET g_free_m.free_item_9 = l_tmp.glaq037
               LET g_free_m.free_item_10 = l_tmp.glaq038
               
               LET g_field_m.field1 = 'glgb029'
               LET g_field_m.field2 = 'glgb030'
               LET g_field_m.field3 = 'glgb031'
               LET g_field_m.field4 = 'glgb032'
               LET g_field_m.field5 = 'glgb033'
               LET g_field_m.field6 = 'glgb034'
               LET g_field_m.field7 = 'glgb035'
               LET g_field_m.field8 = 'glgb036'
               LET g_field_m.field9 = 'glgb037'
               LET g_field_m.field10 = 'glgb038'
               
               CALL s_account_item_free(l_tmp.glaqld,l_tmp.glaq002,p_source,l_tmp.docno,l_tmp.seq,'',g_free_m.*,g_field_m.*)
               RETURNING l_tmp.glaq029,l_tmp.glaq030,l_tmp.glaq031,l_tmp.glaq032,
                         l_tmp.glaq033,l_tmp.glaq034,l_tmp.glaq035,l_tmp.glaq036,
                         l_tmp.glaq037,l_tmp.glaq038
               #151111-00001#1--add--str--lujh
               LET l_tmp.sum = l_tmp.glaq010   #170324-00067#1
               INSERT INTO  s_vr_tmp06 VALUES(l_tmp.*)   #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
            END IF
         ELSE
         #150918-00001#5 mark ------
         #151015 remark--e
            SELECT MAX(seq2) + 1 INTO l_tmp.seq2
              FROM s_vr_tmp06  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
             WHERE docno = l_tmp.docno AND glaqld = l_tmp.glaqld AND seq = l_tmp.seq
            IF cl_null(l_tmp.seq2) THEN
                LET l_tmp.seq2 = 1
            END IF
            IF cl_null(l_tmp.glaq001) THEN #151013-00019#2
               #150918-00001#3--add--str--lujh
               #                 2:摘要/账套    /科目编号     /程序编号/目的字段/单据编号/单据项次1/单据项次2
               CALL s_account_item('2',l_tmp.glaqld,l_tmp.glaq002,p_source,'glgb001',l_tmp.docno,l_tmp.seq,'')
               RETURNING l_tmp.glaq001
               #150918-00001#3--add--end--lujh
            END IF #151013-00019#2
            
            #151111-00001#1--add--str--lujh
            LET g_free_m.free_item_1 = l_tmp.glaq029
            LET g_free_m.free_item_2 = l_tmp.glaq030
            LET g_free_m.free_item_3 = l_tmp.glaq031
            LET g_free_m.free_item_4 = l_tmp.glaq032
            LET g_free_m.free_item_5 = l_tmp.glaq033
            LET g_free_m.free_item_6 = l_tmp.glaq034
            LET g_free_m.free_item_7 = l_tmp.glaq035
            LET g_free_m.free_item_8 = l_tmp.glaq036
            LET g_free_m.free_item_9 = l_tmp.glaq037
            LET g_free_m.free_item_10 = l_tmp.glaq038
            
            LET g_field_m.field1 = 'glgb029'
            LET g_field_m.field2 = 'glgb030'
            LET g_field_m.field3 = 'glgb031'
            LET g_field_m.field4 = 'glgb032'
            LET g_field_m.field5 = 'glgb033'
            LET g_field_m.field6 = 'glgb034'
            LET g_field_m.field7 = 'glgb035'
            LET g_field_m.field8 = 'glgb036'
            LET g_field_m.field9 = 'glgb037'
            LET g_field_m.field10 = 'glgb038'
            
            CALL s_account_item_free(l_tmp.glaqld,l_tmp.glaq002,p_source,l_tmp.docno,l_tmp.seq,'',g_free_m.*,g_field_m.*)
            RETURNING l_tmp.glaq029,l_tmp.glaq030,l_tmp.glaq031,l_tmp.glaq032,
                      l_tmp.glaq033,l_tmp.glaq034,l_tmp.glaq035,l_tmp.glaq036,
                      l_tmp.glaq037,l_tmp.glaq038
            #151111-00001#1--add--str--lujh
            
            #albireo 151015-----s
            IF l_tmp.d > 0 THEN
               LET l_tmp.sw = '1'
            ELSE
               LET l_tmp.sw = '2'
            END IF
            #albireo 151015-----e         
            LET l_tmp.sum = l_tmp.glaq010         #170324-00067#1   
            INSERT INTO  s_vr_tmp06 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
         END IF   #151015 remark  #150918-00001#5 mark
         #150807-00007#2--add--end
         #150807-00007#2--mark--end
#         SELECT MAX(seq2) + 1 INTO l_tmp.seq2 FROM s_voucher_nm_tmp WHERE docno = l_tmp.docno AND glaqld = l_tmp.glaqld
#                                                                   AND  seq = l_tmp.seq
#          IF cl_null(l_tmp.seq2) THEN
#             LET l_tmp.seq2 = 1
#          END IF 
#         INSERT INTO s_voucher_nm_tmp VALUES(l_tmp.*)   
         #150807-00007#2--mark-end         
      END IF      
   #  INSERT INTO s_voucher_nm_tmp VALUES(l_tmp.*)
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'insert s_vr_tmp06'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
   END FOREACH
   LET r_success = TRUE
   RETURN r_success
END FUNCTION
# Descriptions...: 自动产生凭证 - BY 科目的管理设置做UPDATE
# Memo...........:
# Usage..........: CALL s_voucher_gen_nm_1_upd_tmp()
#                  RETURNING r_success
# Input parameter: p_ld           帐套
# Return code....: r_success      成功否标识位
# Date & Author..: 2014/07/04 By lujh
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_nm_1_upd_tmp(p_ld)
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE r_success       LIKE type_t.num5
   DEFINE l_ld            LIKE glaa_t.glaald
   DEFINE l_glaq002       LIKE glaq_t.glaq002
   DEFINE l_docno         LIKE glaq_t.glaqdocno
   DEFINE l_upd_field     LIKE type_t.chr1000
   DEFINE l_sql           LIKE type_t.chr1000
   DEFINE l_glad_r        RECORD 
                          glad005   LIKE glad_t.glad005,  #数量/金额管理否
                          glad007   LIKE glad_t.glad007,  #部门管理否
                          glad008   LIKE glad_t.glad008,  #利润成本管理否
                          glad009   LIKE glad_t.glad009,  #区域管理否
                          glad010   LIKE glad_t.glad010,  #交易客商管理否
                          glad011   LIKE glad_t.glad011,  #客群管理否
                          glad012   LIKE glad_t.glad012,  #产品类别管理否
                          glad013   LIKE glad_t.glad013,  #人员管理否
#                          glad014   LIKE glad_t.glad014,  #预算管理否
                          glad015   LIKE glad_t.glad015,  #专案管理否
                          glad016   LIKE glad_t.glad016,  #WBS管理否
                          glad017   LIKE glad_t.glad017,  #自由核算项1管理否
                          glad018   LIKE glad_t.glad018,  #自由核算项2管理否
                          glad019   LIKE glad_t.glad019,  #自由核算项3管理否
                          glad020   LIKE glad_t.glad020,  #自由核算项4管理否
                          glad021   LIKE glad_t.glad021,  #自由核算项5管理否
                          glad022   LIKE glad_t.glad022,  #自由核算项6管理否
                          glad023   LIKE glad_t.glad023,  #自由核算项7管理否
                          glad024   LIKE glad_t.glad024,  #自由核算项8管理否
                          glad025   LIKE glad_t.glad025,  #自由核算项9管理否
                          glad026   LIKE glad_t.glad026,  #自由核算项10管理否   
                          glad027   LIKE glad_t.glad027,  #账款客商管理否 
                          glad031   LIKE glad_t.glad031,  #經營方式管理否
                          glad032   LIKE glad_t.glad032,  #渠道管理否
                          glad033   LIKE glad_t.glad033   #品牌管理否
                          END RECORD
   WHENEVER ERROR CONTINUE
   LET r_success = FALSE   
   FOREACH s_voucher_gen_nm_1_cs2 INTO l_docno,l_glaq002
       IF SQLCA.sqlcode THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code = SQLCA.sqlcode
          LET g_errparam.extend = 'foreach s_voucher_gen_nm_1_cs2'
          LET g_errparam.popup = TRUE
          CALL cl_err()

          RETURN r_success
       END IF  
       
       INITIALIZE l_glad_r.* TO NULL
       
       EXECUTE s_voucher_gen_nm_1_p3 USING l_glaq002 INTO l_glad_r.*

       LET l_upd_field = NULL
       IF l_glad_r.glad005 = 'N' OR cl_null(l_glad_r.glad005) THEN  #数量/金额不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq007 = ' ',qty = 0,glaq009 = 0"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq007 = ' ',glaq008 = 0,glaq009 = 0"
          END IF
       END IF
       IF l_glad_r.glad007 = 'N' OR cl_null(l_glad_r.glad007) THEN  #部门不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq018 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq018 = ' '"
          END IF
       END IF
       IF l_glad_r.glad008 = 'N' OR cl_null(l_glad_r.glad008) THEN  #利润成本不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq019 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq019 = ' '"
          END IF       
       END IF       

       IF l_glad_r.glad009 = 'N' OR cl_null(l_glad_r.glad009) THEN  #区域不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq020 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq020 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad010 = 'N' OR cl_null(l_glad_r.glad010) THEN  #交易客商不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq021 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq021 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad027 = 'N' OR cl_null(l_glad_r.glad027) THEN  #账款客商不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq022 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq022 = ' '"
          END IF       
       END IF
       IF l_glad_r.glad011 = 'N' OR cl_null(l_glad_r.glad011) THEN  #客群不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq023 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq023 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad012 = 'N' OR cl_null(l_glad_r.glad012) THEN  #产品类别不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq024 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq024 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad013 = 'N' OR cl_null(l_glad_r.glad013) THEN  #人员不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq025 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq025 = ' '"
          END IF       
       END IF        
#       IF l_glad_r.glad014 = 'N' OR cl_null(l_glad_r.glad014) THEN  #预算不管理
#          IF cl_null(l_upd_field) THEN
#             LET l_upd_field = "glaq026 = ' '"
#          ELSE
#             LET l_upd_field = l_upd_field CLIPPED,",glaq026 = ' '"
#          END IF       
#       END IF        
       IF l_glad_r.glad015 = 'N' OR cl_null(l_glad_r.glad015) THEN  #专案不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq027 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq027 = ' '"
          END IF       
       END IF        
       IF l_glad_r.glad016 = 'N' OR cl_null(l_glad_r.glad016) THEN  #WBS不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq028 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq028 = ' '"
          END IF       
       END IF       
       
       #150803-00019#1 add ------
       IF l_glad_r.glad031 = 'N' OR cl_null(l_glad_r.glad031) THEN  #經營方式不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq051 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq051 = ' '"
          END IF
       END IF
       IF l_glad_r.glad032 = 'N' OR cl_null(l_glad_r.glad032) THEN  #渠道不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq052 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq052 = ' '"
          END IF
       END IF
       IF l_glad_r.glad033 = 'N' OR cl_null(l_glad_r.glad033) THEN  #品牌不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq053 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq053 = ' '"
          END IF
       END IF
       #150803-00019#1 add end---

       IF l_glad_r.glad017 = 'N' OR cl_null(l_glad_r.glad017) THEN  #自由核算项1不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq029 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq029 = ' '"
          END IF       
       END IF        
       IF l_glad_r.glad018 = 'N' OR cl_null(l_glad_r.glad018) THEN  #自由核算项2不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq030 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq030 = ' '"
          END IF       
       END IF        
       IF l_glad_r.glad019 = 'N' OR cl_null(l_glad_r.glad019) THEN  #自由核算项3不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq031 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq031 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad020 = 'N' OR cl_null(l_glad_r.glad020) THEN  #自由核算项4不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq032 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq032 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad021 = 'N' OR cl_null(l_glad_r.glad021) THEN  #自由核算项5不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq033 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq033 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad022 = 'N' OR cl_null(l_glad_r.glad022) THEN  #自由核算项6不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq034 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq034 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad023 = 'N' OR cl_null(l_glad_r.glad023) THEN  #自由核算项7不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq035 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq035 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad024 = 'N' OR cl_null(l_glad_r.glad024) THEN  #自由核算项8不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq036 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq036 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad025 = 'N' OR cl_null(l_glad_r.glad025) THEN  #自由核算项9不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq037 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq037 = ' '"
          END IF       
       END IF        
       IF l_glad_r.glad026 = 'N' OR cl_null(l_glad_r.glad026) THEN  #自由核算项10不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq038 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq038 = ' '"
          END IF       
       END IF   
       
       IF NOT cl_null(l_upd_field) THEN
          LET l_sql = "UPDATE s_vr_tmp06 SET ",l_upd_field,  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
                      " WHERE glaqld  = '",p_ld CLIPPED,"'",
                      "   AND glaq002 = '",l_glaq002,"'"
          PREPARE s_voucher_gen_nm_1_upd_tmp_p1 FROM l_sql
          IF SQLCA.sqlcode THEN
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = SQLCA.sqlcode
             LET g_errparam.extend = 's_voucher_gen_nm_1_upd_tmp_p1'
             LET g_errparam.popup = TRUE
             CALL cl_err()

             RETURN r_success
          END IF
          EXECUTE s_voucher_gen_nm_1_upd_tmp_p1
          IF SQLCA.sqlcode THEN
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = SQLCA.sqlcode
             LET g_errparam.extend = 'execute s_voucher_gen_nm_1_upd_tmp_p1'
             LET g_errparam.popup = TRUE
             CALL cl_err()

             RETURN r_success
          END IF
       END IF

   END FOREACH
   
   LET r_success = TRUE
   RETURN r_success    
END FUNCTION
################################################################################
# Descriptions...: 自动生成凭证 - 产生凭证单头
# Memo...........:
# Usage..........: CALL s_voucher_gen_nm_1_ins_glap(p_slip,p_date,p_ld,p_source)
#                       RETURNING r_success,r_start_no,r_end_no
# Input parameter: p_slip         凭证单别
#                : p_date         傳票日期
#                : p_ld           帳套
#                : p_source       來源
# Return code....: r_success      成功否标识位
#                : r_start_no     生成的起始凭证单号
#                : r_end_no       生成的截止凭证单号
# Date & Author..: 2014/07/04 By lujh
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_nm_1_ins_glap(p_slip,p_date,p_ld,p_source)
DEFINE p_slip           LIKE type_t.chr20
DEFINE p_ld             LIKE glaa_t.glaald
DEFINE p_sum_type       LIKE type_t.chr1
DEFINE p_source         LIKE type_t.chr10
DEFINE p_date           LIKE glap_t.glapdocdt
DEFINE r_success        LIKE type_t.num5
DEFINE r_start_no       LIKE glap_t.glapdocno
DEFINE r_end_no         LIKE glap_t.glapdocno
 #161128-00061#7---add---begin-----------
   #DEFINE l_glap          RECORD LIKE glap_t.*
   DEFINE l_glap RECORD  #傳票憑證單頭檔
       glapent LIKE glap_t.glapent, #企業編號
       glapld LIKE glap_t.glapld, #帳套
       glapcomp LIKE glap_t.glapcomp, #法人
       glapdocno LIKE glap_t.glapdocno, #單號
       glapdocdt LIKE glap_t.glapdocdt, #單據日期
       glap001 LIKE glap_t.glap001, #傳票性質
       glap002 LIKE glap_t.glap002, #會計年度
       glap003 LIKE glap_t.glap003, #會計季別
       glap004 LIKE glap_t.glap004, #會計期別
       glap005 LIKE glap_t.glap005, #會計周別
       glap006 LIKE glap_t.glap006, #收支科目
       glap007 LIKE glap_t.glap007, #來源碼
       glap008 LIKE glap_t.glap008, #帳款類型
       glap009 LIKE glap_t.glap009, #總號
       glap010 LIKE glap_t.glap010, #借方總金額
       glap011 LIKE glap_t.glap011, #貸方總金額
       glap012 LIKE glap_t.glap012, #列印次數
       glap013 LIKE glap_t.glap013, #附件張數
       glap014 LIKE glap_t.glap014, #外幣憑證否
       glap015 LIKE glap_t.glap015, #原傳票編號
       glap016 LIKE glap_t.glap016, #來源帳套編號
       glap017 LIKE glap_t.glap017, #來源傳票編號
       glapownid LIKE glap_t.glapownid, #資料所有者
       glapowndp LIKE glap_t.glapowndp, #資料所屬部門
       glapcrtid LIKE glap_t.glapcrtid, #資料建立者
       glapcrtdp LIKE glap_t.glapcrtdp, #資料建立部門
       glapcrtdt LIKE glap_t.glapcrtdt, #資料創建日
       glapmodid LIKE glap_t.glapmodid, #資料修改者
       glapmoddt LIKE glap_t.glapmoddt, #最近修改日
       glapcnfid LIKE glap_t.glapcnfid, #資料確認者
       glapcnfdt LIKE glap_t.glapcnfdt, #資料確認日
       glappstid LIKE glap_t.glappstid, #資料過帳者
       glappstdt LIKE glap_t.glappstdt, #資料過帳日
       glapstus LIKE glap_t.glapstus, #狀態碼
       glapud001 LIKE glap_t.glapud001, #自定義欄位(文字)001
       glapud002 LIKE glap_t.glapud002, #自定義欄位(文字)002
       glapud003 LIKE glap_t.glapud003, #自定義欄位(文字)003
       glapud004 LIKE glap_t.glapud004, #自定義欄位(文字)004
       glapud005 LIKE glap_t.glapud005, #自定義欄位(文字)005
       glapud006 LIKE glap_t.glapud006, #自定義欄位(文字)006
       glapud007 LIKE glap_t.glapud007, #自定義欄位(文字)007
       glapud008 LIKE glap_t.glapud008, #自定義欄位(文字)008
       glapud009 LIKE glap_t.glapud009, #自定義欄位(文字)009
       glapud010 LIKE glap_t.glapud010, #自定義欄位(文字)010
       glapud011 LIKE glap_t.glapud011, #自定義欄位(數字)011
       glapud012 LIKE glap_t.glapud012, #自定義欄位(數字)012
       glapud013 LIKE glap_t.glapud013, #自定義欄位(數字)013
       glapud014 LIKE glap_t.glapud014, #自定義欄位(數字)014
       glapud015 LIKE glap_t.glapud015, #自定義欄位(數字)015
       glapud016 LIKE glap_t.glapud016, #自定義欄位(數字)016
       glapud017 LIKE glap_t.glapud017, #自定義欄位(數字)017
       glapud018 LIKE glap_t.glapud018, #自定義欄位(數字)018
       glapud019 LIKE glap_t.glapud019, #自定義欄位(數字)019
       glapud020 LIKE glap_t.glapud020, #自定義欄位(數字)020
       glapud021 LIKE glap_t.glapud021, #自定義欄位(日期時間)021
       glapud022 LIKE glap_t.glapud022, #自定義欄位(日期時間)022
       glapud023 LIKE glap_t.glapud023, #自定義欄位(日期時間)023
       glapud024 LIKE glap_t.glapud024, #自定義欄位(日期時間)024
       glapud025 LIKE glap_t.glapud025, #自定義欄位(日期時間)025
       glapud026 LIKE glap_t.glapud026, #自定義欄位(日期時間)026
       glapud027 LIKE glap_t.glapud027, #自定義欄位(日期時間)027
       glapud028 LIKE glap_t.glapud028, #自定義欄位(日期時間)028
       glapud029 LIKE glap_t.glapud029, #自定義欄位(日期時間)029
       glapud030 LIKE glap_t.glapud030  #自定義欄位(日期時間)030
       END RECORD

   #161128-00061#7---add---end-----------
DEFINE l_glaqent        LIKE glaq_t.glaqent
DEFINE l_glaqld         LIKE glaq_t.glaqld
DEFINE l_glaqcomp       LIKE glaq_t.glaqcomp
DEFINE l_docno          LIKE glap_t.glapdocno
DEFINE l_docdt          LIKE glap_t.glapdocdt
DEFINE l_glaq021        LIKE glaq_t.glaq021
DEFINE l_success        LIKE type_t.num5
DEFINE l_ooef008        LIKE ooef_t.ooef008
DEFINE l_ooef010        LIKE ooef_t.ooef010
DEFINE l_glaa001        LIKE glaa_t.glaa001
DEFINE l_nmbt100        LIKE nmbt_t.nmbt100
#150429-00010#14 add ------
DEFINE l_sql            STRING
DEFINE l_cnt            LIKE type_t.num5
DEFINE l_date           LIKE glap_t.glapdocdt
DEFINE l_glaa024        LIKE glaa_t.glaa024
DEFINE l_glaa100        LIKE glaa_t.glaa100
DEFINE l_glaa102        LIKE glaa_t.glaa102
#150429-00010#14 add end---
   
   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE
   LET r_start_no = NULL
   LET r_end_no   = NULL
   
   #1.定义CURSOR
   CALL s_voucher_gen_nm_1_def_cursor(p_ld,'','','') RETURNING l_success
   IF NOT l_success THEN
      RETURN r_success,r_start_no,r_end_no  
   END IF
   
   #150803-00018#1 add ------
   SELECT glaa100,glaa024,glaa102 INTO l_glaa100,l_glaa024,l_glaa102 FROM glaa_t WHERE glaaent = g_enterprise AND glaald = p_ld
   
   IF l_glaa100 = 'Y' THEN
      #161207-00051#1--mark--str--lujh
      #DELETE FROM s_fin_tmp  #160727-00019#31  2016/08/10  By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
      #CALL s_fin_continue_no_ins(p_ld,l_glaa024,p_slip,p_date,'3') RETURNING g_sub_success,g_errno
      #161207-00051#1--mark--end--lujh 
       
      DELETE FROM s_fin_tmp  #160727-00019#31  2016/08/10  By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
      IF NOT cl_null(p_date) THEN   #彙總類型是3的 p_date必傳
         CALL s_fin_continue_no_ins(p_ld,l_glaa024,p_slip,p_date,'3') RETURNING g_sub_success,g_errno
      ELSE
         LET l_sql = " SELECT DISTINCT docdt FROM s_vr_tmp06  "  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
         PREPARE continue_no_nm_pb1 FROM l_sql
         DECLARE continue_no_nm_cs1 CURSOR FOR continue_no_nm_pb1
         FOREACH continue_no_nm_cs1 INTO l_date
            CALL s_fin_continue_no_ins(p_ld,l_glaa024,p_slip,l_date,'3') RETURNING g_sub_success,g_errno
         END FOREACH
      END IF
   END IF
   LET l_sql = " SELECT docno FROM s_fin_tmp WHERE isuse = 'N' ORDER BY docno"  #160727-00019#31  2016/08/10  By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
   PREPARE continue_no_nm_pb2 FROM l_sql
   DECLARE continue_no_nm_cs2 CURSOR FOR continue_no_nm_pb2
   #150803-00018#1 add end---
   
   #若p_date不为空时,则表示凭证日期均为p_date
   IF NOT cl_null(p_date) THEN
      UPDATE s_vr_tmp06 SET docdt = p_date  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'update docdt'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success,r_start_no,r_end_no  
      END IF
   END IF
   
   
   FOREACH s_voucher_gen_nm_1_cs4 INTO l_glaqcomp,l_docno,l_docdt
      IF SQLCA.sqlcode THEN  
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_nm_1_cs4'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success,r_start_no,r_end_no
      END IF
      
      INITIALIZE l_glap.* TO NULL
      SELECT ooef008,ooef010 INTO l_ooef008,l_ooef010 FROM ooef_t
       WHERE ooefent = g_enterprise
         AND ooef001 = l_glaqcomp
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'sel ooef'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         LET r_start_no = NULL
         LET r_end_no   = NULL
         RETURN r_success,r_start_no,r_end_no
      END IF
      
      #帳套主幣別
      SELECT glaa001 INTO l_glaa001 
        FROM glaa_t
       WHERE glaaent = g_enterprise
         AND glaald = p_ld
         
      SELECT nmbt100 INTO l_nmbt100
        FROM nmbt_t
       WHERE nmbtent = g_enterprise
         AND nmbtld = p_ld
         AND nmbtdocno = l_docno
      
      #150803-00018#1 mark ------
      ##自动编号
      #CALL s_aooi200_fin_gen_docno(p_ld,'','',p_slip,l_docdt,'aglt310') RETURNING l_success,l_glap.glapdocno
      #IF NOT l_success THEN
      #   LET r_start_no = NULL
      #   LET r_end_no   = NULL
      #   RETURN r_success,r_start_no,r_end_no
      #END IF
      #150803-00018#1 mark end---
      
      #150803-00018#1 add ------
      #自动编号
      #凭证日期没有值,按单据日期来
      IF cl_null(p_date) THEN 
         LET l_glap.glapdocdt = l_docdt     # 單據日期
      ELSE
         LET l_glap.glapdocdt = p_date      # 單據日期
      END IF
      #SELECT count(*) INTO l_cnt
      SELECT count(1) INTO l_cnt
        FROM s_fin_tmp  #160727-00019#31  2016/08/10  By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
       WHERE isuse = 'N'
      IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
      IF l_cnt > 0 THEN
         FOREACH continue_no_nm_cs2 INTO l_glap.glapdocno
            UPDATE s_fin_tmp  #160727-00019#31  2016/08/10  By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
               SET isuse = 'Y'
             WHERE docno = l_glap.glapdocno
            #檢查是否號碼已被使用
            #SELECT count(*) INTO l_cnt #170615-00061#25 mark
            SELECT count(1) INTO l_cnt  #170615-00061#25 add
              FROM glap_t
             WHERE glapent = g_enterprise AND glapld = p_ld
               AND glapdocno=l_glap.glapdocno
            IF l_cnt = 0 THEN
               EXIT FOREACH
            END IF
         END FOREACH
         #假設整個單號都已被取用還是透過s_aooi200_fin_gen_docno取單號
         IF l_cnt > 0 THEN
            CALL s_aooi200_fin_gen_docno(p_ld,'','',p_slip,l_glap.glapdocdt,'aglt310') RETURNING g_sub_success,l_glap.glapdocno
         END IF
      ELSE
         CALL s_aooi200_fin_gen_docno(p_ld,'','',p_slip,l_glap.glapdocdt,'aglt310') RETURNING g_sub_success,l_glap.glapdocno
      END IF
      #150803-00018#1 add end---
      
      #处理起始单号,截止单号
      IF cl_null(r_start_no) THEN LET r_start_no = l_glap.glapdocno END IF
      LET r_end_no   = l_glap.glapdocno 
      
      LET l_glap.glapent   =  g_enterprise  # 企業代碼
      LET l_glap.glapld    =  p_ld          # 帳別
      LET l_glap.glapcomp  =  l_glaqcomp    # 法人
      LET l_glap.glapdocdt =  l_docdt       # 單據日期
      LET l_glap.glap001   = '1'            # 傳票性質
      
      # 會計年度/會計期別/會計季別/會計周別
      SELECT oogc015,oogc006,oogc007,oogc008 INTO l_glap.glap002,l_glap.glap004,l_glap.glap003,l_glap.glap005
        FROM oogc_t
       WHERE oogcent = g_enterprise
         AND oogc001 = l_ooef008
         AND oogc002 = l_ooef010
         AND oogc003 = l_glap.glapdocdt
      
      LET l_glap.glap006   =  ''         # 收支科目
      LET l_glap.glap007   =  'NM'       # 來源碼
      #LET l_glap.glap008   =  p_source  # 帳款類型  #150707-00001#4 mark
      #150707-00001#4--(s)
      #帳款類型
      CASE p_source
         WHEN 'anmt311'
            LET l_glap.glap008  = 'N10'
         WHEN 'anmt470'
            LET l_glap.glap008  = 'N20'
         WHEN 'anmt530'
            LET l_glap.glap008  = 'N30'
         WHEN 'anmt820'
            LET l_glap.glap008  = 'N40'
         WHEN 'anmt821'
            LET l_glap.glap008  = 'N45'            
         WHEN 'anmt822'
            LET l_glap.glap008  = 'N50'             
         OTHERWISE
            LET l_glap.glap008  = p_source
      END CASE      
      #150707-00001#4--(e)
      LET l_glap.glap009   =  0          # 總號
      LET l_glap.glap010   =  0          # 借方總金額
      LET l_glap.glap011   =  0          # 貸方總金額
      LET l_glap.glap012   =  0          # 列印次數
      LET l_glap.glap013   =  0          # 附件張數
      IF l_glaa001 = l_nmbt100 THEN 
         LET l_glap.glap014   =  'N'        # 外幣憑證否
      ELSE
         LET l_glap.glap014   =  'Y'        # 外幣憑證否
      END IF
      LET l_glap.glap015   =  ''         # 原傳票編號
      LET l_glap.glap016   =  ''         # 來源帳別編號
      LET l_glap.glap017   =  ''         # 來源傳票編號
      LET l_glap.glapownid =  g_user     # 資料所有者
      LET l_glap.glapowndp =  g_dept     # 資料所屬部門
      LET l_glap.glapcrtid =  g_user     # 資料建立者
      LET l_glap.glapcrtdp =  g_dept     # 資料建立部門
      LET l_glap.glapcrtdt =  cl_get_current()  # 資料創建日
      LET l_glap.glapmodid =  ''         # 資料修改者
      LET l_glap.glapmoddt =  ''         # 最近修改日
      LET l_glap.glapcnfid =  ''         # 資料確認者
      LET l_glap.glapcnfdt =  ''         # 資料確認日
      LET l_glap.glappstid =  ''         # 資料過帳者
      LET l_glap.glappstdt =  ''         # 資料過帳日
      LET l_glap.glapstus  =  'N'        # 狀態碼

       #161128-00061#7---add---begin-----------
      #INSERT INTO glap_t VALUES(l_glap.*)
      INSERT INTO glap_t (glapent,glapld,glapcomp,glapdocno,glapdocdt,glap001,glap002,glap003,glap004,
                          glap005,glap006,glap007,glap008,glap009,glap010,glap011,glap012,glap013,glap014,
                          glap015,glap016,glap017,glapownid,glapowndp,glapcrtid,glapcrtdp,glapcrtdt,
                          glapmodid,glapmoddt,glapcnfid,glapcnfdt,glappstid,glappstdt,glapstus,
                          glapud001,glapud002,glapud003,glapud004,glapud005,glapud006,glapud007,glapud008,
                          glapud009,glapud010,glapud011,glapud012,glapud013,glapud014,glapud015,glapud016,
                          glapud017,glapud018,glapud019,glapud020,glapud021,glapud022,glapud023,glapud024,
                          glapud025,glapud026,glapud027,glapud028,glapud029,glapud030)
       VALUES(l_glap.glapent,l_glap.glapld,l_glap.glapcomp,l_glap.glapdocno,l_glap.glapdocdt,l_glap.glap001,l_glap.glap002,l_glap.glap003,l_glap.glap004,
              l_glap.glap005,l_glap.glap006,l_glap.glap007,l_glap.glap008,l_glap.glap009,l_glap.glap010,l_glap.glap011,l_glap.glap012,l_glap.glap013,l_glap.glap014,
              l_glap.glap015,l_glap.glap016,l_glap.glap017,l_glap.glapownid,l_glap.glapowndp,l_glap.glapcrtid,l_glap.glapcrtdp,l_glap.glapcrtdt,
              l_glap.glapmodid,l_glap.glapmoddt,l_glap.glapcnfid,l_glap.glapcnfdt,l_glap.glappstid,l_glap.glappstdt,l_glap.glapstus,
              l_glap.glapud001,l_glap.glapud002,l_glap.glapud003,l_glap.glapud004,l_glap.glapud005,l_glap.glapud006,l_glap.glapud007,l_glap.glapud008,
              l_glap.glapud009,l_glap.glapud010,l_glap.glapud011,l_glap.glapud012,l_glap.glapud013,l_glap.glapud014,l_glap.glapud015,l_glap.glapud016,
              l_glap.glapud017,l_glap.glapud018,l_glap.glapud019,l_glap.glapud020,l_glap.glapud021,l_glap.glapud022,l_glap.glapud023,l_glap.glapud024,
              l_glap.glapud025,l_glap.glapud026,l_glap.glapud027,l_glap.glapud028,l_glap.glapud029,l_glap.glapud030)
      #161128-00061#7---add---end-----------
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'ins glap'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         LET r_start_no = NULL
         LET r_end_no   = NULL
         RETURN r_success,r_start_no,r_end_no         
      END IF
      
      #产生凭证单身
      CALL s_voucher_gen_nm_1_ins_glaq(l_glap.glapdocno,p_ld,l_glaqcomp,l_docno,l_docdt)
           RETURNING l_success
      IF NOT l_success THEN
         LET r_start_no = NULL
         LET r_end_no   = NULL
         RETURN r_success,r_start_no,r_end_no           
      END IF
  
   END FOREACH
   
   LET r_success = TRUE
   RETURN r_success,r_start_no,r_end_no
END FUNCTION
################################################################################
# Input parameter: p_glapdocno    凭证单号
#                : p_glaqent      企业编号
#                : p_glaqld       帐套
#                : p_glaqcomp     公司编号
#                : p_docno        来源单号
#                : p_docdt        凭证日期
# Return code....: r_success      成功否标识位
# Date & Author..: 2014/07/04 By lujh
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_nm_1_ins_glaq(p_glapdocno,p_glaqld,p_glaqcomp,p_docno,p_docdt)
   DEFINE p_sum_type          LIKE type_t.chr1
   DEFINE p_glapdocno         LIKE glap_t.glapdocno
   DEFINE p_glaqent           LIKE glaq_t.glaqent
   DEFINE p_glaqld            LIKE glaq_t.glaqld
   DEFINE p_glaqcomp          LIKE glaq_t.glaqcomp
   DEFINE p_docno             LIKE glaq_t.glaqdocno
   DEFINE p_docdt             LIKE glap_t.glapdocdt
   DEFINE p_glaq021           LIKE glaq_t.glaq021
   DEFINE r_success           LIKE type_t.num5
   DEFINE l_value             LIKE type_t.chr50
   #161128-00061#7---add---begin-----------
   #DEFINE l_glaq              RECORD LIKE glaq_t.*
   DEFINE l_glaq RECORD  #傳票憑證單身檔
       glaqent LIKE glaq_t.glaqent, #企業編號
       glaqcomp LIKE glaq_t.glaqcomp, #法人
       glaqld LIKE glaq_t.glaqld, #帳套
       glaqdocno LIKE glaq_t.glaqdocno, #單號
       glaqseq LIKE glaq_t.glaqseq, #項次
       glaq001 LIKE glaq_t.glaq001, #摘要
       glaq002 LIKE glaq_t.glaq002, #科目編號
       glaq003 LIKE glaq_t.glaq003, #借方金額
       glaq004 LIKE glaq_t.glaq004, #貸方金額
       glaq005 LIKE glaq_t.glaq005, #交易幣別
       glaq006 LIKE glaq_t.glaq006, #匯率
       glaq007 LIKE glaq_t.glaq007, #計價單位
       glaq008 LIKE glaq_t.glaq008, #數量
       glaq009 LIKE glaq_t.glaq009, #單價
       glaq010 LIKE glaq_t.glaq010, #原幣金額
       glaq011 LIKE glaq_t.glaq011, #票據編碼
       glaq012 LIKE glaq_t.glaq012, #票據日期
       glaq013 LIKE glaq_t.glaq013, #申請人
       glaq014 LIKE glaq_t.glaq014, #銀行帳號
       glaq015 LIKE glaq_t.glaq015, #款別編號
       glaq016 LIKE glaq_t.glaq016, #收支專案
       glaq017 LIKE glaq_t.glaq017, #營運據點
       glaq018 LIKE glaq_t.glaq018, #部門
       glaq019 LIKE glaq_t.glaq019, #利潤/成本中心
       glaq020 LIKE glaq_t.glaq020, #區域
       glaq021 LIKE glaq_t.glaq021, #收付款客商
       glaq022 LIKE glaq_t.glaq022, #帳款客戶
       glaq023 LIKE glaq_t.glaq023, #客群
       glaq024 LIKE glaq_t.glaq024, #產品類別
       glaq025 LIKE glaq_t.glaq025, #人員
       glaq026 LIKE glaq_t.glaq026, #no use
       glaq027 LIKE glaq_t.glaq027, #專案編號
       glaq028 LIKE glaq_t.glaq028, #WBS
       glaq029 LIKE glaq_t.glaq029, #自由核算項一
       glaq030 LIKE glaq_t.glaq030, #自由核算項二
       glaq031 LIKE glaq_t.glaq031, #自由核算項三
       glaq032 LIKE glaq_t.glaq032, #自由核算項四
       glaq033 LIKE glaq_t.glaq033, #自由核算項五
       glaq034 LIKE glaq_t.glaq034, #自由核算項六
       glaq035 LIKE glaq_t.glaq035, #自由核算項七
       glaq036 LIKE glaq_t.glaq036, #自由核算項八
       glaq037 LIKE glaq_t.glaq037, #自由核算項九
       glaq038 LIKE glaq_t.glaq038, #自由核算項十
       glaq039 LIKE glaq_t.glaq039, #匯率(本位幣二)
       glaq040 LIKE glaq_t.glaq040, #借方金額(本位幣二)
       glaq041 LIKE glaq_t.glaq041, #貸方金額(本位幣二)
       glaq042 LIKE glaq_t.glaq042, #匯率(本位幣三)
       glaq043 LIKE glaq_t.glaq043, #借方金額(本位幣三)
       glaq044 LIKE glaq_t.glaq044, #貸方金額(本位幣三)
       glaq051 LIKE glaq_t.glaq051, #經營方式
       glaq052 LIKE glaq_t.glaq052, #通路
       glaq053 LIKE glaq_t.glaq053, #品牌
       glaqud001 LIKE glaq_t.glaqud001, #自定義欄位(文字)001
       glaqud002 LIKE glaq_t.glaqud002, #自定義欄位(文字)002
       glaqud003 LIKE glaq_t.glaqud003, #自定義欄位(文字)003
       glaqud004 LIKE glaq_t.glaqud004, #自定義欄位(文字)004
       glaqud005 LIKE glaq_t.glaqud005, #自定義欄位(文字)005
       glaqud006 LIKE glaq_t.glaqud006, #自定義欄位(文字)006
       glaqud007 LIKE glaq_t.glaqud007, #自定義欄位(文字)007
       glaqud008 LIKE glaq_t.glaqud008, #自定義欄位(文字)008
       glaqud009 LIKE glaq_t.glaqud009, #自定義欄位(文字)009
       glaqud010 LIKE glaq_t.glaqud010, #自定義欄位(文字)010
       glaqud011 LIKE glaq_t.glaqud011, #自定義欄位(數字)011
       glaqud012 LIKE glaq_t.glaqud012, #自定義欄位(數字)012
       glaqud013 LIKE glaq_t.glaqud013, #自定義欄位(數字)013
       glaqud014 LIKE glaq_t.glaqud014, #自定義欄位(數字)014
       glaqud015 LIKE glaq_t.glaqud015, #自定義欄位(數字)015
       glaqud016 LIKE glaq_t.glaqud016, #自定義欄位(數字)016
       glaqud017 LIKE glaq_t.glaqud017, #自定義欄位(數字)017
       glaqud018 LIKE glaq_t.glaqud018, #自定義欄位(數字)018
       glaqud019 LIKE glaq_t.glaqud019, #自定義欄位(數字)019
       glaqud020 LIKE glaq_t.glaqud020, #自定義欄位(數字)020
       glaqud021 LIKE glaq_t.glaqud021, #自定義欄位(日期時間)021
       glaqud022 LIKE glaq_t.glaqud022, #自定義欄位(日期時間)022
       glaqud023 LIKE glaq_t.glaqud023, #自定義欄位(日期時間)023
       glaqud024 LIKE glaq_t.glaqud024, #自定義欄位(日期時間)024
       glaqud025 LIKE glaq_t.glaqud025, #自定義欄位(日期時間)025
       glaqud026 LIKE glaq_t.glaqud026, #自定義欄位(日期時間)026
       glaqud027 LIKE glaq_t.glaqud027, #自定義欄位(日期時間)027
       glaqud028 LIKE glaq_t.glaqud028, #自定義欄位(日期時間)028
       glaqud029 LIKE glaq_t.glaqud029, #自定義欄位(日期時間)029
       glaqud030 LIKE glaq_t.glaqud030  #自定義欄位(日期時間)030
       END RECORD
   #161128-00061#7---add---end-----------
   DEFINE l_xrca039           LIKE xrca_t.xrca039
   DEFINE l_last_xrcadocno    LIKE xrca_t.xrcadocno
   DEFINE l_foreign           LIKE type_t.chr1
   DEFINE l_glaa001           LIKE glaa_t.glaa001
   DEFINE l_glap010           LIKE glap_t.glap010
   DEFINE l_glap011           LIKE glap_t.glap011
   DEFINE l_glad_r            RECORD 
                              glad005   LIKE glad_t.glad005,  #数量/金额管理否
                              glad007   LIKE glad_t.glad007,  #部门管理否
                              glad008   LIKE glad_t.glad008,  #利润成本管理否
                              glad009   LIKE glad_t.glad009,  #区域管理否
                              glad010   LIKE glad_t.glad010,  #交易客商管理否
                              glad011   LIKE glad_t.glad011,  #客群管理否
                              glad012   LIKE glad_t.glad012,  #产品类别管理否
                              glad013   LIKE glad_t.glad013,  #人员管理否
#                              glad014   LIKE glad_t.glad014,  #预算管理否
                              glad015   LIKE glad_t.glad015,  #专案管理否
                              glad016   LIKE glad_t.glad016,  #WBS管理否
                              glad017   LIKE glad_t.glad017,  #自由核算项1管理否
                              glad018   LIKE glad_t.glad018,  #自由核算项2管理否
                              glad019   LIKE glad_t.glad019,  #自由核算项3管理否
                              glad020   LIKE glad_t.glad020,  #自由核算项4管理否
                              glad021   LIKE glad_t.glad021,  #自由核算项5管理否
                              glad022   LIKE glad_t.glad022,  #自由核算项6管理否
                              glad023   LIKE glad_t.glad023,  #自由核算项7管理否
                              glad024   LIKE glad_t.glad024,  #自由核算项8管理否
                              glad025   LIKE glad_t.glad025,  #自由核算项9管理否
                              glad026   LIKE glad_t.glad026,  #自由核算项10管理否    
                              glad027   LIKE glad_t.glad027,  #账款客商管理否
                              glad031   LIKE glad_t.glad031,  #經營方式管理否
                              glad032   LIKE glad_t.glad032,  #渠道管理否
                              glad033   LIKE glad_t.glad033   #品牌管理否
                              END RECORD
   DEFINE l_tmp               RECORD 
                              docno    LIKE glaq_t.glaqdocno,
                              docdt    LIKE glap_t.glapdocdt,
                              sw       LIKE type_t.chr1,       #1.借  2.贷
                              glaqent  LIKE glaq_t.glaqent,  
                              glaqcomp LIKE glaq_t.glaqcomp, 
                              glaqld   LIKE glaq_t.glaqld,   
                              glaq001  LIKE glaq_t.glaq001,  
                              glaq002  LIKE glaq_t.glaq002,  
                              glaq005  LIKE glaq_t.glaq005,  
                              glaq006  LIKE glaq_t.glaq006,  
                              glaq007  LIKE glaq_t.glaq007,  
                              glaq009  LIKE glaq_t.glaq009,
                             #glaq010  LIKE glaq_t.glaq010,  #170509-00094#4 mark                              
                              glaq011  LIKE glaq_t.glaq011,  
                              glaq012  LIKE glaq_t.glaq012,  
                              glaq013  LIKE glaq_t.glaq013,  
                              glaq014  LIKE glaq_t.glaq014,  
                              glaq015  LIKE glaq_t.glaq015,  
                              glaq016  LIKE glaq_t.glaq016,  
                              glaq017  LIKE glaq_t.glaq017,  
                              glaq018  LIKE glaq_t.glaq018,  
                              glaq019  LIKE glaq_t.glaq019,  
                              glaq020  LIKE glaq_t.glaq020,  
                              glaq021  LIKE glaq_t.glaq021,  
                              glaq022  LIKE glaq_t.glaq022,  
                              glaq023  LIKE glaq_t.glaq023,  
                              glaq024  LIKE glaq_t.glaq024,  
                              glaq025  LIKE glaq_t.glaq025,  
                              #glaq026  LIKE glaq_t.glaq026, #151111-00001#1 mark lujh 
                              glaq027  LIKE glaq_t.glaq027,  
                              glaq028  LIKE glaq_t.glaq028, 
                              glaq051  LIKE glaq_t.glaq051,  #經營方式
                              glaq052  LIKE glaq_t.glaq052,  #渠道 
                              glaq053  LIKE glaq_t.glaq053,  #品牌
                              glaq029  LIKE glaq_t.glaq029,  
                              glaq030  LIKE glaq_t.glaq030,  
                              glaq031  LIKE glaq_t.glaq031,  
                              glaq032  LIKE glaq_t.glaq032,  
                              glaq033  LIKE glaq_t.glaq033,  
                              glaq034  LIKE glaq_t.glaq034,  
                              glaq035  LIKE glaq_t.glaq035,  
                              glaq036  LIKE glaq_t.glaq036,  
                              glaq037  LIKE glaq_t.glaq037,  
                              glaq038  LIKE glaq_t.glaq038,   
                              d        LIKE glaq_t.glaq003,  
                              c        LIKE glaq_t.glaq004,  
                              qty      LIKE glaq_t.glaq008,  
                              sum      LIKE glaq_t.glaq010,
                              glaq039  LIKE glaq_t.glaq039,
                              glaq040  LIKE glaq_t.glaq040,
                              glaq041  LIKE glaq_t.glaq041,
                              glaq042  LIKE glaq_t.glaq042,
                              glaq043  LIKE glaq_t.glaq043,
                              glaq044  LIKE glaq_t.glaq044,
                              seq      LIKE glaq_t.glaqseq,
                              source   LIKE type_t.chr100,
                              glaqseq  LIKE glaq_t.glaqseq,
                              xrca039  LIKE xrca_t.xrca039,
                              glgb055  LIKE glgb_t.glgb055  #150807-00007#2                             
                              END RECORD
   DEFINE l_success           LIKE type_t.num5              #150817-00015#1
   
   WHENEVER ERROR CONTINUE
   LET r_success = FALSE
   
   
   SELECT glaa001 INTO l_glaa001 FROM glaa_t WHERE glaald = p_glaqld
      AND glaaent = g_enterprise  #161206-00023#1 add

   
   LET l_xrca039 = 0  #附件张数
   LET l_foreign = 'N' #外币凭证否
   
   INITIALIZE l_tmp.* TO NULL
   LET l_last_xrcadocno = NULL
   FOREACH s_voucher_gen_nm_1_cs5 INTO l_tmp.*
      IF SQLCA.sqlcode THEN  
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_nm_1_cs5'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF   
      INITIALIZE l_glaq.* TO NULL
      
      #汇总 附件张数 & update 来源单据的"抛转凭证单号"
      IF cl_null(l_last_xrcadocno) OR l_last_xrcadocno <> l_tmp.docno THEN
         #LET l_xrca039 = l_xrca039 + l_tmp.xrca039
         #
         EXECUTE s_voucher_gen_nm_1_p6 USING p_glapdocno,p_docdt,l_tmp.docno    
         IF SQLCA.sqlcode THEN  
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = 'execute s_voucher_gen_ar_2_cs10'
            LET g_errparam.popup = TRUE
            CALL cl_err()

            RETURN r_success
         END IF         
      END IF
      IF l_foreign = 'N' THEN
         IF l_tmp.glaq005 <> l_glaa001 THEN
            LET l_foreign = 'Y'
         END IF
      END IF
      
      LET l_glaq.glaqent   = l_tmp.glaqent    #企業代碼
      LET l_glaq.glaqcomp  = l_tmp.glaqcomp   #法人
      LET l_glaq.glaqld    = p_glaqld         #帳別
      LET l_glaq.glaqdocno = p_glapdocno      #單號
      #项次
      SELECT MAX(glaqseq) + 1 INTO l_glaq.glaqseq
        FROM glaq_t
       WHERE glaqent   = l_glaq.glaqent
         AND glaqld    = l_glaq.glaqld
         AND glaqdocno = l_glaq.glaqdocno
      IF cl_null(l_glaq.glaqseq) THEN
         LET l_glaq.glaqseq = 1
      END IF
      LET l_glaq.glaq001   = l_tmp.glaq001    #摘要
      LET l_glaq.glaq002   = l_tmp.glaq002    #科目編號
      LET l_glaq.glaq003   = l_tmp.d          #借方金額
      LET l_glaq.glaq004   = l_tmp.c          #貸方金額
      LET l_glaq.glaq005   = l_tmp.glaq005    #交易幣別
      LET l_glaq.glaq006   = l_tmp.glaq006    #匯率
      LET l_glaq.glaq007   = l_tmp.glaq007    #計價單位
      LET l_glaq.glaq008   = l_tmp.qty        #數量
      LET l_glaq.glaq009   = l_tmp.glaq009    #單價
     #LET l_glaq.glaq010   = l_tmp.sum        #原幣金額   #150817-00015#1 mark
     #LET l_glaq.glaq010   = l_tmp.glaq010    #原幣金額   #150817-00015#1 add  #170509-00094#4 mark
      LET l_glaq.glaq010   = l_tmp.sum        #原幣金額   #170509-00094#4 add
      LET l_glaq.glaq011   = l_tmp.glaq011    #票據編碼
      LET l_glaq.glaq012   = l_tmp.glaq012    #票據日期
      LET l_glaq.glaq013   = l_tmp.glaq013    #申請人
      LET l_glaq.glaq014   = l_tmp.glaq014    #銀行帳號
      LET l_glaq.glaq015   = l_tmp.glaq015    #結算方式
      LET l_glaq.glaq016   = l_tmp.glaq016    #收支項目
      LET l_glaq.glaq017   = l_tmp.glaq017    #營運據點
      LET l_glaq.glaq018   = l_tmp.glaq018    #部門
      LET l_glaq.glaq019   = l_tmp.glaq019    #利潤/成本中心
      LET l_glaq.glaq020   = l_tmp.glaq020    #區域
      LET l_glaq.glaq021   = l_tmp.glaq021    #交易客商      
      LET l_glaq.glaq022   = l_tmp.glaq022    #账款客商      
      LET l_glaq.glaq023   = l_tmp.glaq023    #客群
      LET l_glaq.glaq024   = l_tmp.glaq024    #產品類別
      LET l_glaq.glaq025   = l_tmp.glaq025    #人員
      #LET l_glaq.glaq026   = l_tmp.glaq026    #預算編號      #151111-00001#1 mark lujh  
      LET l_glaq.glaq027   = l_tmp.glaq027    #專案編號
      LET l_glaq.glaq028   = l_tmp.glaq028    #WBS
      LET l_glaq.glaq029   = l_tmp.glaq029    #自由核算項一
      LET l_glaq.glaq030   = l_tmp.glaq030    #自由核算項二
      LET l_glaq.glaq031   = l_tmp.glaq031    #自由核算項三
      LET l_glaq.glaq032   = l_tmp.glaq032    #自由核算項四
      LET l_glaq.glaq033   = l_tmp.glaq033    #自由核算項五
      LET l_glaq.glaq034   = l_tmp.glaq034    #自由核算項六
      LET l_glaq.glaq035   = l_tmp.glaq035    #自由核算項七
      LET l_glaq.glaq036   = l_tmp.glaq036    #自由核算項八
      LET l_glaq.glaq037   = l_tmp.glaq037    #自由核算項九
      LET l_glaq.glaq038   = l_tmp.glaq038    #自由核算項十
      
      LET l_glaq.glaq039   = l_tmp.glaq039
      LET l_glaq.glaq040   = l_tmp.glaq040
      LET l_glaq.glaq041   = l_tmp.glaq041
      LET l_glaq.glaq042   = l_tmp.glaq042
      LET l_glaq.glaq043   = l_tmp.glaq043
      LET l_glaq.glaq044   = l_tmp.glaq044
      LET l_glaq.glaq051   = l_tmp.glaq051   #經營方式
      LET l_glaq.glaq052   = l_tmp.glaq052   #渠道
      LET l_glaq.glaq053   = l_tmp.glaq053   #品牌

      #170322-00036#1 add s--- 
      #核算项如果没值,给个空格 
      IF l_glaq.glaq018 IS NULL THEN LET l_glaq.glaq018 = ' ' END IF
      IF l_glaq.glaq019 IS NULL THEN LET l_glaq.glaq019 = ' ' END IF
      IF l_glaq.glaq020 IS NULL THEN LET l_glaq.glaq020 = ' ' END IF
      IF l_glaq.glaq021 IS NULL THEN LET l_glaq.glaq021 = ' ' END IF
      IF l_glaq.glaq022 IS NULL THEN LET l_glaq.glaq022 = ' ' END IF
      IF l_glaq.glaq023 IS NULL THEN LET l_glaq.glaq023 = ' ' END IF
      IF l_glaq.glaq024 IS NULL THEN LET l_glaq.glaq024 = ' ' END IF
      IF l_glaq.glaq025 IS NULL THEN LET l_glaq.glaq025 = ' ' END IF
      IF l_glaq.glaq027 IS NULL THEN LET l_glaq.glaq027 = ' ' END IF
      IF l_glaq.glaq028 IS NULL THEN LET l_glaq.glaq028 = ' ' END IF
      IF l_glaq.glaq051 IS NULL THEN LET l_glaq.glaq051 = ' ' END IF
      IF l_glaq.glaq052 IS NULL THEN LET l_glaq.glaq052 = ' ' END IF
      IF l_glaq.glaq053 IS NULL THEN LET l_glaq.glaq053 = ' ' END IF
      IF l_glaq.glaq029 IS NULL THEN LET l_glaq.glaq029 = ' ' END IF
      IF l_glaq.glaq030 IS NULL THEN LET l_glaq.glaq030 = ' ' END IF
      IF l_glaq.glaq031 IS NULL THEN LET l_glaq.glaq031 = ' ' END IF
      IF l_glaq.glaq032 IS NULL THEN LET l_glaq.glaq032 = ' ' END IF
      IF l_glaq.glaq033 IS NULL THEN LET l_glaq.glaq033 = ' ' END IF
      IF l_glaq.glaq034 IS NULL THEN LET l_glaq.glaq034 = ' ' END IF
      IF l_glaq.glaq035 IS NULL THEN LET l_glaq.glaq035 = ' ' END IF
      IF l_glaq.glaq036 IS NULL THEN LET l_glaq.glaq036 = ' ' END IF
      IF l_glaq.glaq037 IS NULL THEN LET l_glaq.glaq037 = ' ' END IF
      IF l_glaq.glaq038 IS NULL THEN LET l_glaq.glaq038 = ' ' END IF
      #170322-00036#1 add e--- 
      
      #161128-00061#7---add---begin-----------
      #INSERT INTO glaq_t VALUES(l_glaq.*)
      INSERT INTO glaq_t (glaqent,glaqcomp,glaqld,glaqdocno,glaqseq,glaq001,glaq002,glaq003,glaq004,glaq005,
                          glaq006,glaq007,glaq008,glaq009,glaq010,glaq011,glaq012,glaq013,glaq014,glaq015,
                          glaq016,glaq017,glaq018,glaq019,glaq020,glaq021,glaq022,glaq023,glaq024,glaq025,
                          glaq026,glaq027,glaq028,glaq029,glaq030,glaq031,glaq032,glaq033,glaq034,glaq035,
                          glaq036,glaq037,glaq038,glaq039,glaq040,glaq041,glaq042,glaq043,glaq044,glaq051,
                          glaq052,glaq053,glaqud001,glaqud002,glaqud003,glaqud004,glaqud005,glaqud006,
                          glaqud007,glaqud008,glaqud009,glaqud010,glaqud011,glaqud012,glaqud013,glaqud014,
                          glaqud015,glaqud016,glaqud017,glaqud018,glaqud019,glaqud020,glaqud021,glaqud022,
                          glaqud023,glaqud024,glaqud025,glaqud026,glaqud027,glaqud028,glaqud029,glaqud030)
       VALUES(l_glaq.glaqent,l_glaq.glaqcomp,l_glaq.glaqld,l_glaq.glaqdocno,l_glaq.glaqseq,l_glaq.glaq001,l_glaq.glaq002,l_glaq.glaq003,l_glaq.glaq004,l_glaq.glaq005,
              l_glaq.glaq006,l_glaq.glaq007,l_glaq.glaq008,l_glaq.glaq009,l_glaq.glaq010,l_glaq.glaq011,l_glaq.glaq012,l_glaq.glaq013,l_glaq.glaq014,l_glaq.glaq015,
              l_glaq.glaq016,l_glaq.glaq017,l_glaq.glaq018,l_glaq.glaq019,l_glaq.glaq020,l_glaq.glaq021,l_glaq.glaq022,l_glaq.glaq023,l_glaq.glaq024,l_glaq.glaq025,
              l_glaq.glaq026,l_glaq.glaq027,l_glaq.glaq028,l_glaq.glaq029,l_glaq.glaq030,l_glaq.glaq031,l_glaq.glaq032,l_glaq.glaq033,l_glaq.glaq034,l_glaq.glaq035,
              l_glaq.glaq036,l_glaq.glaq037,l_glaq.glaq038,l_glaq.glaq039,l_glaq.glaq040,l_glaq.glaq041,l_glaq.glaq042,l_glaq.glaq043,l_glaq.glaq044,l_glaq.glaq051,
              l_glaq.glaq052,l_glaq.glaq053,l_glaq.glaqud001,l_glaq.glaqud002,l_glaq.glaqud003,l_glaq.glaqud004,l_glaq.glaqud005,l_glaq.glaqud006,
              l_glaq.glaqud007,l_glaq.glaqud008,l_glaq.glaqud009,l_glaq.glaqud010,l_glaq.glaqud011,l_glaq.glaqud012,l_glaq.glaqud013,l_glaq.glaqud014,
              l_glaq.glaqud015,l_glaq.glaqud016,l_glaq.glaqud017,l_glaq.glaqud018,l_glaq.glaqud019,l_glaq.glaqud020,l_glaq.glaqud021,l_glaq.glaqud022,
              l_glaq.glaqud023,l_glaq.glaqud024,l_glaq.glaqud025,l_glaq.glaqud026,l_glaq.glaqud027,l_glaq.glaqud028,l_glaq.glaqud029,l_glaq.glaqud030)
      #161128-00061#7---add---end-----------
      IF SQLCA.sqlcode THEN      
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'ins glaq'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF
      #150817-00015#1---add--str
      CALL s_voucher_ins_glac(p_glaqld,p_docdt,p_glapdocno,l_glaq.glaqseq,l_glaq.glaq002,l_tmp.glgb055,l_tmp.glaq021,l_glaq.*)
       RETURNING l_success
       
      IF l_success = FALSE THEN
         RETURN r_success
      END IF
      #150817-00015#1---add--end
      
      #170103-00019#1--add--str--
      #插入细项立冲账资料
      LET l_success = TRUE
      CALL s_pre_voucher_insert_glax(l_glaq.*) RETURNING l_success
      IF l_success = FALSE THEN
         RETURN r_success
      END IF
      #170103-00019#1--add--end
      
   END FOREACH

   #一笔凭证处理完毕后,对凭证单头进行更行
   #总借/贷
   SELECT SUM(glaq003),SUM(glaq004) INTO l_glap010,l_glap011
     FROM glaq_t
    WHERE glaqent   = g_enterprise
      AND glaqld    = p_glaqld
      AND glaqdocno = p_glapdocno
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'sel glaq'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   IF cl_null(l_glap010) THEN LET l_glap010 = 0 END IF
   IF cl_null(l_glap011) THEN LET l_glap011 = 0 END IF
   
   UPDATE glap_t SET glap010 = l_glap010,glap011 = l_glap011,glap014 = l_foreign
    WHERE glapent   = g_enterprise
      AND glapld    = p_glaqld
      AND glapdocno = p_glapdocno
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'upd glap_t'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_voucher_gen_nm_1_ins_group_tmp(p_ld,p_sum_type)
#                  RETURNING l_success
# Input parameter: p_ld           帐套
#                : p_sum_type     汇总方式 
# Return code....: r_success      成功否标识位
# Date & Author..: 2015/8/10 By 02291
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_nm_1_ins_group_tmp(p_ld,p_sum_type)
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE p_sum_type      LIKE type_t.chr1
   DEFINE p_wc            LIKE type_t.chr1000
   DEFINE r_success       LIKE type_t.num5
   #161128-00061#7---add---begin-----------
   #DEFINE l_xrca          RECORD LIKE xrca_t.*
   DEFINE l_xrca RECORD  #應收憑單單頭
       xrcaent LIKE xrca_t.xrcaent, #企業編號
       xrcaownid LIKE xrca_t.xrcaownid, #資料所有者
       xrcaowndp LIKE xrca_t.xrcaowndp, #資料所屬部門
       xrcacrtid LIKE xrca_t.xrcacrtid, #資料建立者
       xrcacrtdp LIKE xrca_t.xrcacrtdp, #資料建立部門
       xrcacrtdt LIKE xrca_t.xrcacrtdt, #資料創建日
       xrcamodid LIKE xrca_t.xrcamodid, #資料修改者
       xrcamoddt LIKE xrca_t.xrcamoddt, #最近修改日
       xrcacnfid LIKE xrca_t.xrcacnfid, #資料確認者
       xrcacnfdt LIKE xrca_t.xrcacnfdt, #資料確認日
       xrcapstid LIKE xrca_t.xrcapstid, #資料過帳者
       xrcapstdt LIKE xrca_t.xrcapstdt, #資料過帳日
       xrcastus LIKE xrca_t.xrcastus, #狀態碼
       xrcacomp LIKE xrca_t.xrcacomp, #法人
       xrcald LIKE xrca_t.xrcald, #帳套
       xrcadocno LIKE xrca_t.xrcadocno, #應收帳款單號碼
       xrcadocdt LIKE xrca_t.xrcadocdt, #帳款日期
       xrca001 LIKE xrca_t.xrca001, #帳款單性質
       xrcasite LIKE xrca_t.xrcasite, #帳務中心
       xrca003 LIKE xrca_t.xrca003, #帳務人員
       xrca004 LIKE xrca_t.xrca004, #帳款客戶編號
       xrca005 LIKE xrca_t.xrca005, #收款客戶
       xrca006 LIKE xrca_t.xrca006, #客戶分類
       xrca007 LIKE xrca_t.xrca007, #帳款類別
       xrca008 LIKE xrca_t.xrca008, #收款條件編號
       xrca009 LIKE xrca_t.xrca009, #應收款日/應扣抵日
       xrca010 LIKE xrca_t.xrca010, #容許票據到期日
       xrca011 LIKE xrca_t.xrca011, #稅別
       xrca012 LIKE xrca_t.xrca012, #稅率
       xrca013 LIKE xrca_t.xrca013, #含稅否
       xrca014 LIKE xrca_t.xrca014, #人員編號
       xrca015 LIKE xrca_t.xrca015, #部門編號
       xrca016 LIKE xrca_t.xrca016, #來源作業類型
       xrca017 LIKE xrca_t.xrca017, #產生方式
       xrca018 LIKE xrca_t.xrca018, #來源參考單號
       xrca019 LIKE xrca_t.xrca019, #系統產生對應單號(待抵帳款-預收)
       xrca020 LIKE xrca_t.xrca020, #信用狀申請流程否
       xrca021 LIKE xrca_t.xrca021, #商業發票號碼(IV no.)
       xrca022 LIKE xrca_t.xrca022, #出口報單號碼
       xrca023 LIKE xrca_t.xrca023, #發票客戶編號
       xrca024 LIKE xrca_t.xrca024, #發票客戶統一編號
       xrca025 LIKE xrca_t.xrca025, #發票客戶全名
       xrca026 LIKE xrca_t.xrca026, #發票客戶地址
       xrca028 LIKE xrca_t.xrca028, #發票類型
       xrca029 LIKE xrca_t.xrca029, #發票匯率
       xrca030 LIKE xrca_t.xrca030, #發票應開未稅金額
       xrca031 LIKE xrca_t.xrca031, #發票應開稅額
       xrca032 LIKE xrca_t.xrca032, #發票應開含稅金額
       xrca033 LIKE xrca_t.xrca033, #專案編號
       xrca034 LIKE xrca_t.xrca034, #責任中心
       xrca035 LIKE xrca_t.xrca035, #應收(借方)科目編號
       xrca036 LIKE xrca_t.xrca036, #收入(貸方)科目編號
       xrca037 LIKE xrca_t.xrca037, #分錄傳票產生否
       xrca038 LIKE xrca_t.xrca038, #拋轉傳票號碼
       xrca039 LIKE xrca_t.xrca039, #會計檢核附件份數
       xrca040 LIKE xrca_t.xrca040, #留置否
       xrca041 LIKE xrca_t.xrca041, #留置理由碼
       xrca042 LIKE xrca_t.xrca042, #留置設定日期
       xrca043 LIKE xrca_t.xrca043, #留置解除日期
       xrca044 LIKE xrca_t.xrca044, #留置原幣金額
       xrca045 LIKE xrca_t.xrca045, #留置說明
       xrca046 LIKE xrca_t.xrca046, #關係人否
       xrca047 LIKE xrca_t.xrca047, #多角序號
       xrca048 LIKE xrca_t.xrca048, #集團代收/代付單號
       xrca049 LIKE xrca_t.xrca049, #來源營運中心編號
       xrca050 LIKE xrca_t.xrca050, #交易原始單據份數
       xrca051 LIKE xrca_t.xrca051, #作廢理由碼
       xrca052 LIKE xrca_t.xrca052, #列印次數
       xrca053 LIKE xrca_t.xrca053, #備註
       xrca054 LIKE xrca_t.xrca054, #多帳期設定
       xrca055 LIKE xrca_t.xrca055, #繳款優惠條件
       xrca056 LIKE xrca_t.xrca056, #會計檢核附件狀態
       xrca057 LIKE xrca_t.xrca057, #交易對象識別碼
       xrca058 LIKE xrca_t.xrca058, #銷售分類
       xrca059 LIKE xrca_t.xrca059, #預算編號
       xrca060 LIKE xrca_t.xrca060, #發票開立原則
       xrca061 LIKE xrca_t.xrca061, #預計開立發票日期
       xrca062 LIKE xrca_t.xrca062, #多角性質
       xrca063 LIKE xrca_t.xrca063, #整帳批序號
       xrca064 LIKE xrca_t.xrca064, #訂金序次
       xrca065 LIKE xrca_t.xrca065, #發票編號
       xrca066 LIKE xrca_t.xrca066, #發票號碼
       xrca100 LIKE xrca_t.xrca100, #交易原幣別
       xrca101 LIKE xrca_t.xrca101, #原幣匯率
       xrca103 LIKE xrca_t.xrca103, #原幣未稅金額
       xrca104 LIKE xrca_t.xrca104, #原幣稅額
       xrca106 LIKE xrca_t.xrca106, #原幣直接折抵合計金額
       xrca107 LIKE xrca_t.xrca107, #原幣直接沖帳(調整)合計金額
       xrca108 LIKE xrca_t.xrca108, #原幣應收金額
       xrca113 LIKE xrca_t.xrca113, #本幣未稅金額
       xrca114 LIKE xrca_t.xrca114, #本幣稅額
       xrca116 LIKE xrca_t.xrca116, #本幣直接沖帳(調整)合計金額
       xrca117 LIKE xrca_t.xrca117, #本幣直接沖帳(調整)合計金額
       xrca118 LIKE xrca_t.xrca118, #本幣應收金額
       xrca120 LIKE xrca_t.xrca120, #本位幣二幣別
       xrca121 LIKE xrca_t.xrca121, #本位幣二匯率
       xrca123 LIKE xrca_t.xrca123, #本位幣二未稅金額
       xrca124 LIKE xrca_t.xrca124, #本位幣二稅額
       xrca126 LIKE xrca_t.xrca126, #本位幣二直接折抵合計金額
       xrca127 LIKE xrca_t.xrca127, #本位幣二直接沖帳(調整)合計金額
       xrca128 LIKE xrca_t.xrca128, #本位幣二應收金額
       xrca130 LIKE xrca_t.xrca130, #本位幣三幣別
       xrca131 LIKE xrca_t.xrca131, #本位幣三匯率
       xrca133 LIKE xrca_t.xrca133, #本位幣三未稅金額
       xrca134 LIKE xrca_t.xrca134, #本位幣三稅額
       xrca136 LIKE xrca_t.xrca136, #本位幣三直接折抵合計金額
       xrca137 LIKE xrca_t.xrca137, #本位幣三直接沖帳(調整)合計金額
       xrca138 LIKE xrca_t.xrca138, #本位幣三應收金額
       xrcaud001 LIKE xrca_t.xrcaud001, #自定義欄位(文字)001
       xrcaud002 LIKE xrca_t.xrcaud002, #自定義欄位(文字)002
       xrcaud003 LIKE xrca_t.xrcaud003, #自定義欄位(文字)003
       xrcaud004 LIKE xrca_t.xrcaud004, #自定義欄位(文字)004
       xrcaud005 LIKE xrca_t.xrcaud005, #自定義欄位(文字)005
       xrcaud006 LIKE xrca_t.xrcaud006, #自定義欄位(文字)006
       xrcaud007 LIKE xrca_t.xrcaud007, #自定義欄位(文字)007
       xrcaud008 LIKE xrca_t.xrcaud008, #自定義欄位(文字)008
       xrcaud009 LIKE xrca_t.xrcaud009, #自定義欄位(文字)009
       xrcaud010 LIKE xrca_t.xrcaud010, #自定義欄位(文字)010
       xrcaud011 LIKE xrca_t.xrcaud011, #自定義欄位(數字)011
       xrcaud012 LIKE xrca_t.xrcaud012, #自定義欄位(數字)012
       xrcaud013 LIKE xrca_t.xrcaud013, #自定義欄位(數字)013
       xrcaud014 LIKE xrca_t.xrcaud014, #自定義欄位(數字)014
       xrcaud015 LIKE xrca_t.xrcaud015, #自定義欄位(數字)015
       xrcaud016 LIKE xrca_t.xrcaud016, #自定義欄位(數字)016
       xrcaud017 LIKE xrca_t.xrcaud017, #自定義欄位(數字)017
       xrcaud018 LIKE xrca_t.xrcaud018, #自定義欄位(數字)018
       xrcaud019 LIKE xrca_t.xrcaud019, #自定義欄位(數字)019
       xrcaud020 LIKE xrca_t.xrcaud020, #自定義欄位(數字)020
       xrcaud021 LIKE xrca_t.xrcaud021, #自定義欄位(日期時間)021
       xrcaud022 LIKE xrca_t.xrcaud022, #自定義欄位(日期時間)022
       xrcaud023 LIKE xrca_t.xrcaud023, #自定義欄位(日期時間)023
       xrcaud024 LIKE xrca_t.xrcaud024, #自定義欄位(日期時間)024
       xrcaud025 LIKE xrca_t.xrcaud025, #自定義欄位(日期時間)025
       xrcaud026 LIKE xrca_t.xrcaud026, #自定義欄位(日期時間)026
       xrcaud027 LIKE xrca_t.xrcaud027, #自定義欄位(日期時間)027
       xrcaud028 LIKE xrca_t.xrcaud028, #自定義欄位(日期時間)028
       xrcaud029 LIKE xrca_t.xrcaud029, #自定義欄位(日期時間)029
       xrcaud030 LIKE xrca_t.xrcaud030  #自定義欄位(日期時間)030
       END RECORD

   #161128-00061#7---add--end-------------
   DEFINE l_success       LIKE type_t.num5
   DEFINE l_ac            LIKE type_t.num5
   DEFINE l_docno         LIKE glaq_t.glaqdocno
   DEFINE l_glaq002       LIKE glaq_t.glaq002
   DEFINE l_field         LIKE type_t.chr1000
   DEFINE l_field1        LIKE type_t.chr1000
   DEFINE l_field2        LIKE type_t.chr1000
   DEFINE l_field3        LIKE type_t.chr1000
   DEFINE l_field4        LIKE type_t.chr1000
   DEFINE l_field5        LIKE type_t.chr1000
   DEFINE l_group_field   LIKE type_t.chr1000
   DEFINE l_glad_r        RECORD 
                          glad005   LIKE glad_t.glad005,  #数量/金额管理否
                          glad007   LIKE glad_t.glad007,  #部门管理否
                          glad008   LIKE glad_t.glad008,  #利润成本管理否
                          glad009   LIKE glad_t.glad009,  #区域管理否
                          glad010   LIKE glad_t.glad010,  #客商管理否
                          glad011   LIKE glad_t.glad011,  #客群管理否
                          glad012   LIKE glad_t.glad012,  #产品类别管理否
                          glad013   LIKE glad_t.glad013,  #人员管理否
                          #glad014   LIKE glad_t.glad014,  #预算管理否       #151111-00001#1 mark lujh
                          glad015   LIKE glad_t.glad015,  #专案管理否
                          glad016   LIKE glad_t.glad016,  #WBS管理否
                          glad017   LIKE glad_t.glad017,  #自由核算项1管理否
                          glad018   LIKE glad_t.glad018,  #自由核算项2管理否
                          glad019   LIKE glad_t.glad019,  #自由核算项3管理否
                          glad020   LIKE glad_t.glad020,  #自由核算项4管理否
                          glad021   LIKE glad_t.glad021,  #自由核算项5管理否
                          glad022   LIKE glad_t.glad022,  #自由核算项6管理否
                          glad023   LIKE glad_t.glad023,  #自由核算项7管理否
                          glad024   LIKE glad_t.glad024,  #自由核算项8管理否
                          glad025   LIKE glad_t.glad025,  #自由核算项9管理否
                          glad026   LIKE glad_t.glad026,  #自由核算项10管理否 
                          glad027   LIKE glad_t.glad027,  #账款客商管理否    #151111-00001#1 add lujh  
                          glad031   LIKE glad_t.glad031,  #經營方式管理否
                          glad032   LIKE glad_t.glad032,  #渠道管理否
                          glad033   LIKE glad_t.glad033   #品牌管理否                          
                          END RECORD
   DEFINE l_glgb055       LIKE glgb_t.glgb055
   DEFINE l_glad002       LIKE glad_t.glad002           #170509-00094#4 add
   DEFINE l_glac008       LIKE glac_t.glac008           #170509-00094#4 add   
   
   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE
   
    #1.定义CURSOR
   CALL s_voucher_gen_nm_1_def_cursor(p_ld,'','','') RETURNING l_success
   IF NOT l_success THEN
      RETURN r_success
   END IF
   
   
   LET l_ac = 1
   FOREACH s_voucher_gen_nm_1_cs2 INTO l_docno,l_glaq002
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach s_anmt820_gen_nm_cs5'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF  
      
      INITIALIZE l_glad_r TO NULL 
      
      EXECUTE s_voucher_gen_nm_1_cs3 USING l_glaq002 INTO l_glad_r.*
      
      LET l_group_field = NULL
      
      LET l_group_field = ",glaq017"  #核算组织
      
      IF l_glad_r.glad007 = 'Y' THEN  #部门管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq018"
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq018"
         END IF
      END IF
      IF l_glad_r.glad008 = 'Y' THEN  #利润成本管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq019"
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq019"
         END IF       
      END IF       

      IF l_glad_r.glad009 = 'Y' THEN  #区域管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq020"
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq020 "
         END IF       
      END IF 
      #20151104 Unmark By 01727  维护了客商,但是产生的分录无资料
#160526-00024#1 mod--s---           
#      IF l_glad_r.glad010 = 'Y' THEN  #客商管理
#         IF cl_null(l_group_field) THEN
#            LET l_group_field = "glaq021,glaq022"
#         ELSE
#            LET l_group_field = l_group_field CLIPPED,",glaq021,glaq022"
#         END IF       
#      END IF
      IF l_glad_r.glad010 = 'Y' THEN  #客商管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = "glaq021"
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq021"
         END IF       
      END IF 
      IF l_glad_r.glad027 = 'Y' THEN  #客商管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = "glaq022"
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq022"
         END IF       
      END IF       
#160526-00024#1 mod--e---      
      IF l_glad_r.glad011 = 'Y' THEN  #客群管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq023 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq023 "
         END IF       
      END IF 
      IF l_glad_r.glad012 = 'Y' THEN  #产品类别管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq024 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq024 "
         END IF       
      END IF 
      IF l_glad_r.glad013 = 'Y' THEN  #人员管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq025 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq025"
         END IF       
      END IF   
      #151111-00001#1--mark--str--lujh      
      #IF l_glad_r.glad014 = 'Y' THEN  #预算管理
      #   IF cl_null(l_group_field) THEN
      #      LET l_group_field = ",glaq026 "
      #   ELSE
      #      LET l_group_field = l_group_field CLIPPED,",glaq026 "
      #   END IF       
      #END IF  
      #151111-00001#1--mark--end--lujh      
      IF l_glad_r.glad015 = 'Y' THEN  #专案管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq027 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq027 "
         END IF       
      END IF        
      IF l_glad_r.glad016 = 'Y' THEN  #WBS管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq028 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq028 "
         END IF       
      END IF

      IF l_glad_r.glad031 = 'Y' THEN  #經營方式管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq051 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq051 "
         END IF       
      END IF 
      IF l_glad_r.glad032 = 'Y' THEN  #經營方式管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq052 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq052 "
         END IF       
      END IF 
      IF l_glad_r.glad033 = 'Y' THEN  #經營方式管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq053 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq053 "
         END IF       
      END IF
      
      IF l_glad_r.glad017 = 'Y' THEN  #自由核算项1
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq029 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq029 "
         END IF       
      END IF  
      IF l_glad_r.glad018 = 'Y' THEN  #自由核算项2
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq030 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq030 "
         END IF       
      END IF   
      IF l_glad_r.glad019 = 'Y' THEN  #自由核算项3
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq031 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq031 "
         END IF       
      END IF 
      IF l_glad_r.glad020 = 'Y' THEN  #自由核算项4
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq032 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq032 "
         END IF       
      END IF 
      IF l_glad_r.glad021 = 'Y' THEN  #自由核算项5
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq033 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq033 "
         END IF       
      END IF  
      IF l_glad_r.glad022 = 'Y' THEN  #自由核算项6
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq034 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq034 "
         END IF       
      END IF  
      IF l_glad_r.glad023 = 'Y' THEN  #自由核算项7
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq035 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq035 "
         END IF       
      END IF  
      IF l_glad_r.glad024 = 'Y' THEN  #自由核算项8
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq036 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq036 "
         END IF       
      END IF  
      IF l_glad_r.glad025 = 'Y' THEN  #自由核算项9
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq037 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq037 "
         END IF       
      END IF  
      IF l_glad_r.glad026 = 'Y' THEN  #自由核算项10
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq038 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq038 "
         END IF       
      END IF       
      IF l_glad_r.glad005 = 'Y' THEN  #数量/金额管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq007"
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq007"
         END IF
      END IF
      
      LET l_field = NULL
      LET l_field1 = NULL
      LET l_field2 = NULL
      LET l_field3 = NULL
      LET l_field4 = NULL
      LET l_field5 = NULL
      
      LET l_field = "glaq017"    #核算组织
      
      IF l_glad_r.glad007 = 'Y' THEN  #部门管理
         IF cl_null(l_field) THEN
            LET l_field = "glaq018"
         ELSE
            LET l_field = l_field CLIPPED,",glaq018"
         END IF
      ELSE
         IF cl_null(l_field) THEN
            LET l_field = "''"
         ELSE
            LET l_field = l_field CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad008 = 'Y' THEN  #利润成本管理
         IF cl_null(l_field) THEN
            LET l_field = "glaq019"
         ELSE
            LET l_field = l_field CLIPPED,",glaq019"
         END IF 
      ELSE
         IF cl_null(l_field) THEN
            LET l_field = "''"
         ELSE
            LET l_field = l_field CLIPPED,",''"
         END IF         
      END IF       

      IF l_glad_r.glad009 = 'Y' THEN  #区域管理
         IF cl_null(l_field) THEN
            LET l_field = "glaq020"
         ELSE
            LET l_field = l_field CLIPPED,",glaq020 "
         END IF   
      ELSE
         IF cl_null(l_field) THEN
            LET l_field = "''"
         ELSE
            LET l_field = l_field CLIPPED,",''"
         END IF         
      END IF 
     #20151104 Unmark By 01727
#160526-00024#1 mod--s---      
#      IF l_glad_r.glad010 = 'Y' THEN  #客商管理
#         IF cl_null(l_field) THEN
#            LET l_field = "glaq021,glaq022"
#         ELSE
#            LET l_field = l_field CLIPPED,",glaq021,glaq022"
#         END IF       
#      ELSE
#         IF cl_null(l_field) THEN
#            LET l_field = "'',''"
#         ELSE
#            LET l_field = l_field CLIPPED,",'',''"
#         END IF
#      END IF 
      IF l_glad_r.glad010 = 'Y' THEN  #客商管理
         IF cl_null(l_field) THEN
            LET l_field = "glaq021"
         ELSE
            LET l_field = l_field CLIPPED,",glaq021"
         END IF       
      ELSE
         IF cl_null(l_field) THEN
            LET l_field = "''"
         ELSE
            LET l_field = l_field CLIPPED,",''"
         END IF
      END IF  
      IF l_glad_r.glad027 = 'Y' THEN  #客商管理
         IF cl_null(l_field) THEN
            LET l_field = "glaq022"
         ELSE
            LET l_field = l_field CLIPPED,",glaq022"
         END IF       
      ELSE
         IF cl_null(l_field) THEN
            LET l_field = "''"
         ELSE
            LET l_field = l_field CLIPPED,",''"
         END IF
      END IF       
#160526-00024#1 mod--e---       
     #20151104 Unmark By 01727 
      IF l_glad_r.glad011 = 'Y' THEN  #客群管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq023 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq023 "
         END IF   
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF 
      IF l_glad_r.glad012 = 'Y' THEN  #产品类别管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq024 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq024 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF 
      IF l_glad_r.glad013 = 'Y' THEN  #人员管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq025 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq025"
         END IF    
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
            
      #151111-00001#1--mark--str--lujh            
      #IF l_glad_r.glad014 = 'Y' THEN  #预算管理
      #   IF cl_null(l_field3) THEN
      #      LET l_field3 = "glaq026 "
      #   ELSE
      #      LET l_field3 = l_field3 CLIPPED,",glaq026 "
      #   END IF  
      #ELSE
      #   IF cl_null(l_field3) THEN
      #      LET l_field3 = "''"
      #   ELSE
      #      LET l_field3 = l_field3 CLIPPED,",''"
      #   END IF         
      #END IF   
      #151111-00001#1--mark--end--lujh            
      IF l_glad_r.glad015 = 'Y' THEN  #专案管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq027 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq027 "
         END IF 
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF        
      IF l_glad_r.glad016 = 'Y' THEN  #WBS管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq028 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq028 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF   
 
      IF l_glad_r.glad031 = 'Y' THEN  #經營方式管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq051 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq051 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad032 = 'Y' THEN  #渠道管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq052 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq052 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad033 = 'Y' THEN  #品牌管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq053 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq053 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF 
      
      IF l_glad_r.glad017 = 'Y' THEN  #自由核算项1
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq029 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq029 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad018 = 'Y' THEN  #自由核算项2
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq030 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq030 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad019 = 'Y' THEN  #自由核算项3
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq031 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq031 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad020 = 'Y' THEN  #自由核算项4
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq032 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq032 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad021 = 'Y' THEN  #自由核算项5
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq033 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq033 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad022 = 'Y' THEN  #自由核算项6
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq034 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq034 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad023 = 'Y' THEN  #自由核算项7
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq035 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq035 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad024 = 'Y' THEN  #自由核算项8
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq036 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq036 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad025 = 'Y' THEN  #自由核算项9
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq037 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq037 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF
      
      IF l_glad_r.glad026 = 'Y' THEN  #自由核算项10
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq038 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq038 "
         END IF      
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF         
      END IF


      IF l_glad_r.glad005 = 'Y' THEN  #数量/金额管理
         IF cl_null(l_field1) THEN
            LET l_field1 = "glaq007"
         ELSE
            LET l_field1 = l_field1 CLIPPED,",glaq007"
         END IF
         IF cl_null(l_field2) THEN
            LET l_field2 = "SUM(qty)"
         ELSE
            LET l_field2 = l_field2 CLIPPED,",SUM(qty)"
         END IF
      ELSE
         IF cl_null(l_field1) THEN
            LET l_field1 = "''"
         ELSE
            LET l_field1 = l_field1 CLIPPED,",''"
         END IF
         IF cl_null(l_field2) THEN
            LET l_field2 = "''"
         ELSE
            LET l_field2 = l_field2 CLIPPED,",''"
         END IF
      END IF
      IF NOT cl_null(l_glaq002) THEN 
         LET l_field4 = " glaq002 = '",l_glaq002,"'"
      ELSE
         LET l_field4 = " glaq002 IS NULL"
      END IF
      IF p_sum_type = '1' THEN 
         LET g_sql = "SELECT docno,docdt,'',glaqent,glaqcomp,'',glaq001,glaq002,glaq005,",
                     "       glaq006,",l_field1 CLIPPED,",",    
                     "       '','','','',glaq014,'','',",l_field CLIPPED,",",   #170428-00024#1 change '' to glaq014 lujh
                     "       ",l_field3 CLIPPED,",",    #20151104 Mod By 01727   "       '','',",l_field3 CLIPPED,",", --> "       ",l_field3 CLIPPED,",",
                     "       SUM(d),SUM(c),",l_field2 CLIPPED,",",
                     "       SUM(glaq010),glaq039,SUM(glaq040),SUM(glaq041),",
                     "       glaq042,SUM(glaq043),SUM(glaq044),'','','','',glgb055 ", #150807-00007#2 add glgb055
                     "  FROM s_vr_tmp06 ",  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_tmp ——> s_vr_tmp06
                     " WHERE docno = '",l_docno,"'",
                     "   AND ",l_field4,
                     " GROUP BY docno,docdt,glaqent,glaqcomp,glaq001,glaq002,glaq005,glaq006,glaq014,glaq039,glaq042 ",l_group_field,",glgb055,sw"   #150807-00007#2 add glgb055  #170428-00024#1 add glaq014 lujh
                     #albireo 151015 add sw                     
      END IF    
      
      PREPARE s_voucher_gen_nm_p7 FROM g_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_anmt820_gen_nm_p7'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF
      DECLARE s_voucher_gen_nm_cs7 CURSOR FOR s_voucher_gen_nm_p7
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_anmt820_gen_nm_cs7'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF 
      
      FOREACH s_voucher_gen_nm_cs7 INTO g_glaq3_d[l_ac].*
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = 'foreach s_anmt820_gen_nm_cs7'
            LET g_errparam.popup = TRUE
            CALL cl_err()

            RETURN r_success
         END IF
         
         #160802-00033#1 add s---
         LET g_glaq3_d[l_ac].glaqseq = l_ac
         IF g_glaq3_d[l_ac].d = 0 AND g_glaq3_d[l_ac].c = 0 THEN 
            CONTINUE FOREACH
         END IF         
         #160802-00033#1 add e---
         
         #170509-00094#4---add---start---
         LET l_glad002 = ''
         LET l_glac008 = ''
         EXECUTE s_voucher_gen_nm_glad USING g_glaq3_d[l_ac].glaq002 
            INTO l_glad002,l_glac008
         IF cl_null(l_glad002) THEN LET l_glad002 = 'N' END IF 
         #若單據別允許紅字傳票且按餘額類型產生時，需判斷該科目的正常餘額
         #正常餘額為借餘時就用借-貸的金額顯示
         #正常餘額為貸餘時就用貸-借的金額顯示      
         IF g_dfin1002 = 'Y' AND l_glad002 = 'Y' THEN
            IF l_glac008 = '1' THEN
               LET g_glaq3_d[l_ac].d = g_glaq3_d[l_ac].d - g_glaq3_d[l_ac].c
               LET g_glaq3_d[l_ac].c = 0
               LET g_glaq3_d[l_ac].glaq040 = g_glaq3_d[l_ac].glaq040 - g_glaq3_d[l_ac].glaq041
               LET g_glaq3_d[l_ac].glaq041 = 0
               LET g_glaq3_d[l_ac].glaq043 = g_glaq3_d[l_ac].glaq043 - g_glaq3_d[l_ac].glaq044
               LET g_glaq3_d[l_ac].glaq044 = 0
               IF g_glaq3_d[l_ac].d < 0 THEN
                  LET g_glaq3_d[l_ac].sum = g_glaq3_d[l_ac].sum * -1
               END IF
               LET g_glaq3_d[l_ac].sw = 1
            ELSE
               LET g_glaq3_d[l_ac].c = g_glaq3_d[l_ac].c - g_glaq3_d[l_ac].d
               LET g_glaq3_d[l_ac].d = 0
               LET g_glaq3_d[l_ac].glaq041 = g_glaq3_d[l_ac].glaq041 - g_glaq3_d[l_ac].glaq040
               LET g_glaq3_d[l_ac].glaq040 = 0
               LET g_glaq3_d[l_ac].glaq044 = g_glaq3_d[l_ac].glaq044 - g_glaq3_d[l_ac].glaq043
               LET g_glaq3_d[l_ac].glaq043 = 0
               IF g_glaq3_d[l_ac].c < 0 THEN
                  LET g_glaq3_d[l_ac].sum = g_glaq3_d[l_ac].sum * -1
               END IF
               LET g_glaq3_d[l_ac].sw = 2
            END IF
         ELSE
            IF (g_glaq3_d[l_ac].d - g_glaq3_d[l_ac].c) > 0 THEN
               LET g_glaq3_d[l_ac].d = g_glaq3_d[l_ac].d - g_glaq3_d[l_ac].c
               LET g_glaq3_d[l_ac].c = 0
               LET g_glaq3_d[l_ac].sw = 1
            ELSE
               LET g_glaq3_d[l_ac].c = g_glaq3_d[l_ac].c - g_glaq3_d[l_ac].d
               LET g_glaq3_d[l_ac].d = 0
               LET g_glaq3_d[l_ac].sw = 2
            END IF
         END IF     
         #170509-00094#4---add---end---  
         
         INSERT INTO s_vr_tmp07 VALUES(g_glaq3_d[l_ac].*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_nm_group ——> s_vr_tmp07
         LET l_ac = l_ac + 1
      END FOREACH
      CALL g_glaq3_d.deleteElement(l_ac)   
   END FOREACH 
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 將現金變動碼資訊插入臨時表
# Memo...........:
# Usage..........: s_voucher_ins_glbc_tmp(p_ld,p_docdt,p_glapdocno,p_glaqseq,p_xrdadocno)
#                  RETURNING r_success
# Input parameter: p_ld           帳套
#                : p_docdt        傳票日期
#                : p_glapdocno    傳票號碼
#                : p_glaqseq      項次
#                : p_xrdadocno    沖帳單號
# Return code....: r_success      正確與否
# Date & Author..: 2014/9/28  by lujh
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_ins_glbc_tmp(p_ld,p_docdt,p_glapdocno,p_glaqseq,p_xrdadocno)
   DEFINE p_ld           LIKE glaa_t.glaald
   DEFINE p_docdt        LIKE glap_t.glapdocdt
   DEFINE p_glapdocno    LIKE glap_t.glapdocno
   DEFINE p_glaqseq      LIKE glaq_t.glaqseq
   DEFINE p_xrdadocno    LIKE xrda_t.xrdadocno
   DEFINE l_glaa015      LIKE glaa_t.glaa015
   DEFINE l_glaa019      LIKE glaa_t.glaa019
   DEFINE l_n            LIKE type_t.num5
   DEFINE r_success      LIKE type_t.num5
   DEFINE l_sql          STRING
   DEFINE l_amt1         LIKE xrde_t.xrde109
   DEFINE l_amt2         LIKE xrde_t.xrde109
   DEFINE l_amt3         LIKE xrde_t.xrde109
   DEFINE l_amt4         LIKE xrde_t.xrde109
   #161128-00061#7---add---begin-----------
   #DEFINE l_glbc         RECORD LIKE glbc_t.*
   DEFINE l_glbc RECORD  #現金變動碼明細檔
       glbcent LIKE glbc_t.glbcent, #企業編號
       glbcld LIKE glbc_t.glbcld, #帳套
       glbccomp LIKE glbc_t.glbccomp, #營運據點
       glbcdocno LIKE glbc_t.glbcdocno, #傳票編號
       glbcseq LIKE glbc_t.glbcseq, #項次
       glbcseq1 LIKE glbc_t.glbcseq1, #序號
       glbc001 LIKE glbc_t.glbc001, #年度
       glbc002 LIKE glbc_t.glbc002, #期別
       glbc003 LIKE glbc_t.glbc003, #借貸別
       glbc004 LIKE glbc_t.glbc004, #現金變動碼
       glbc005 LIKE glbc_t.glbc005, #交易客商
       glbc006 LIKE glbc_t.glbc006, #交易幣別
       glbc007 LIKE glbc_t.glbc007, #匯率
       glbc008 LIKE glbc_t.glbc008, #原幣金額
       glbc009 LIKE glbc_t.glbc009, #本幣金額
       glbc010 LIKE glbc_t.glbc010, #資料來源
       glbc011 LIKE glbc_t.glbc011, #匯率(本位幣二)
       glbc012 LIKE glbc_t.glbc012, #金額(本位幣二)
       glbc013 LIKE glbc_t.glbc013, #匯率(本位幣三)
       glbc014 LIKE glbc_t.glbc014, #金額(本位幣三)
       glbcud001 LIKE glbc_t.glbcud001, #自定義欄位(文字)001
       glbcud002 LIKE glbc_t.glbcud002, #自定義欄位(文字)002
       glbcud003 LIKE glbc_t.glbcud003, #自定義欄位(文字)003
       glbcud004 LIKE glbc_t.glbcud004, #自定義欄位(文字)004
       glbcud005 LIKE glbc_t.glbcud005, #自定義欄位(文字)005
       glbcud006 LIKE glbc_t.glbcud006, #自定義欄位(文字)006
       glbcud007 LIKE glbc_t.glbcud007, #自定義欄位(文字)007
       glbcud008 LIKE glbc_t.glbcud008, #自定義欄位(文字)008
       glbcud009 LIKE glbc_t.glbcud009, #自定義欄位(文字)009
       glbcud010 LIKE glbc_t.glbcud010, #自定義欄位(文字)010
       glbcud011 LIKE glbc_t.glbcud011, #自定義欄位(數字)011
       glbcud012 LIKE glbc_t.glbcud012, #自定義欄位(數字)012
       glbcud013 LIKE glbc_t.glbcud013, #自定義欄位(數字)013
       glbcud014 LIKE glbc_t.glbcud014, #自定義欄位(數字)014
       glbcud015 LIKE glbc_t.glbcud015, #自定義欄位(數字)015
       glbcud016 LIKE glbc_t.glbcud016, #自定義欄位(數字)016
       glbcud017 LIKE glbc_t.glbcud017, #自定義欄位(數字)017
       glbcud018 LIKE glbc_t.glbcud018, #自定義欄位(數字)018
       glbcud019 LIKE glbc_t.glbcud019, #自定義欄位(數字)019
       glbcud020 LIKE glbc_t.glbcud020, #自定義欄位(數字)020
       glbcud021 LIKE glbc_t.glbcud021, #自定義欄位(日期時間)021
       glbcud022 LIKE glbc_t.glbcud022, #自定義欄位(日期時間)022
       glbcud023 LIKE glbc_t.glbcud023, #自定義欄位(日期時間)023
       glbcud024 LIKE glbc_t.glbcud024, #自定義欄位(日期時間)024
       glbcud025 LIKE glbc_t.glbcud025, #自定義欄位(日期時間)025
       glbcud026 LIKE glbc_t.glbcud026, #自定義欄位(日期時間)026
       glbcud027 LIKE glbc_t.glbcud027, #自定義欄位(日期時間)027
       glbcud028 LIKE glbc_t.glbcud028, #自定義欄位(日期時間)028
       glbcud029 LIKE glbc_t.glbcud029, #自定義欄位(日期時間)029
       glbcud030 LIKE glbc_t.glbcud030, #自定義欄位(日期時間)030
       glbc015 LIKE glbc_t.glbc015  #狀態碼
       END RECORD
   #161128-00061#7---add---end-----------
   DEFINE l_xrde         RECORD 
                         xrdeld       LIKE xrde_t.xrdeld,
                         xrdeorga     LIKE xrde_t.xrdeorga,
                         xrde015      LIKE xrde_t.xrde015,
                         xrde012      LIKE xrde_t.xrde012,
                         xrde003      LIKE xrde_t.xrde003,
                         xrde004      LIKE xrde_t.xrde004,
                         xrde100      LIKE xrde_t.xrde100,
                         xrde101      LIKE xrde_t.xrde101,
                         xrde109      LIKE xrde_t.xrde109,
                         xrde119      LIKE xrde_t.xrde119,
                         xrde121      LIKE xrde_t.xrde121,
                         xrde129      LIKE xrde_t.xrde129,
                         xrde131      LIKE xrde_t.xrde131,
                         xrde139      LIKE xrde_t.xrde139
                         END RECORD                    
   DEFINE l_glbc_tmp     RECORD
                         glbcent    LIKE glbc_t.glbcent,
                         glbcld     LIKE glbc_t.glbcld,
                         glbccomp   LIKE glbc_t.glbccomp, 
                         glbcdocno  LIKE glbc_t.glbcdocno,   
                         glbcseq    LIKE glbc_t.glbcseq,
                         glbc001    LIKE glbc_t.glbc001,
                         glbc002    LIKE glbc_t.glbc002,
                         glbc003    LIKE glbc_t.glbc003,
                         glbc004    LIKE glbc_t.glbc004,
                         glbc005    LIKE glbc_t.glbc005,
                         glbc006    LIKE glbc_t.glbc006,
                         glbc007    LIKE glbc_t.glbc007,
                         glbc008    LIKE glbc_t.glbc008,
                         glbc009    LIKE glbc_t.glbc009,
                         glbc010    LIKE glbc_t.glbc010,
                         glbc011    LIKE glbc_t.glbc011,
                         glbc012    LIKE glbc_t.glbc012,   
                         glbc013    LIKE glbc_t.glbc013,
                         glbc014    LIKE glbc_t.glbc014,
                         xrdadocno  LIKE xrda_t.xrdadocno
                         END RECORD
   
   LET r_success = TRUE
   
   LET l_amt1 = 0
   LET l_amt2 = 0
   LET l_amt3 = 0
   LET l_amt4 = 0
   
   #SELECT COUNT(*) INTO l_n FROM s_voucher_glbc WHERE xrdadocno = p_xrdadocno        #170615-00061#25 mark
   SELECT COUNT(xrdadocno) INTO l_n FROM s_voucher_glbc WHERE xrdadocno = p_xrdadocno #170615-00061#25 add
   
   IF l_n > 0 THEN 
      RETURN r_success
   END IF     
                         
   SELECT glaa015,glaa019 INTO l_glaa015,l_glaa019
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald  = p_ld
                                         
   LET l_sql = "SELECT xrdeld,xrdeorga,xrde015,xrde012,xrde003,xrde004,xrde100,xrde101,",
               "       xrde109,xrde119,xrde121,xrde129,xrde131,xrde139 ",
               "  FROM xrde_t ",
               #" WHERE xrdeent = '",g_enterprise,"'", #170615-00061#25 mark
               " WHERE xrdeent = ",g_enterprise," ",   #170615-00061#25 add
               "   AND xrdeld  = '",p_ld,"'",
               "   AND xrdedocno = '",p_xrdadocno,"'",
               "   AND xrde002 = '10' ",
               "   AND xrde006 IN ('10','20') "
   PREPARE s_voucher_ins_glbc_p1 FROM l_sql
   DECLARE s_voucher_ins_glbc_c1 CURSOR FOR s_voucher_ins_glbc_p1
   
   #161128-00061#7---add---begin-----------
   #LET l_sql = "SELECT * FROM glbc_t  ",
   LET l_sql = "SELECT glbcent,glbcld,glbccomp,glbcdocno,glbcseq,glbcseq1,glbc001,glbc002,",
               "glbc003,glbc004,glbc005,glbc006,glbc007,glbc008,glbc009,glbc010,glbc011,",
               "glbc012,glbc013,glbc014,glbcud001,glbcud002,glbcud003,glbcud004,glbcud005,",
               "glbcud006,glbcud007,glbcud008,glbcud009,glbcud010,glbcud011,glbcud012,",
               "glbcud013,glbcud014,glbcud015,glbcud016,glbcud017,glbcud018,glbcud019,",
               "glbcud020,glbcud021,glbcud022,glbcud023,glbcud024,glbcud025,glbcud026,",
               "glbcud027,glbcud028,glbcud029,glbcud030,glbc015 FROM glbc_t  ",
   #161128-00061#7---add---end-----------
               #" WHERE glbcent = '",g_enterprise,"'", #170615-00061#25 mark
               " WHERE glbcent = ",g_enterprise," ",   #170615-00061#25 add
               "   AND glbcld  = '",p_ld,"'",
               "   AND glbcdocno = ? ",
               "   AND glbcseq = ? "
   PREPARE s_voucher_ins_glbc_p2 FROM l_sql
   DECLARE s_voucher_ins_glbc_c2 CURSOR FOR s_voucher_ins_glbc_p2
   
   FOREACH s_voucher_ins_glbc_c1 INTO l_xrde.*
      IF l_amt1 = 0 THEN 
         LET l_amt1 = l_xrde.xrde109
      END IF
      IF l_amt2 = 0 THEN 
         LET l_amt2 = l_xrde.xrde119
      END IF
      IF l_amt3 = 0 THEN 
         LET l_amt3 = l_xrde.xrde129
      END IF
      IF l_amt4 = 0 THEN 
         LET l_amt4 = l_xrde.xrde139
      END IF
    
      FOREACH s_voucher_ins_glbc_c2 USING l_xrde.xrde003,l_xrde.xrde004 INTO l_glbc.*
         LET l_glbc_tmp.glbcent   = g_enterprise
         LET l_glbc_tmp.glbcld    = p_ld
         LET l_glbc_tmp.glbccomp  = l_glbc.glbccomp
         LET l_glbc_tmp.glbcdocno = p_glapdocno
         LET l_glbc_tmp.glbcseq   = l_glbc.glbcseq
         LET l_glbc_tmp.glbc001   = l_glbc.glbc001
         LET l_glbc_tmp.glbc002   = l_glbc.glbc002 
         LET l_glbc_tmp.glbc003   = l_glbc.glbc003 
         LET l_glbc_tmp.glbc004   = l_glbc.glbc004
         LET l_glbc_tmp.glbc005   = l_glbc.glbc005
         LET l_glbc_tmp.glbc006   = l_glbc.glbc006
         LET l_glbc_tmp.glbc007   = l_glbc.glbc007
         LET l_glbc_tmp.glbc010   ='1' 
         LET l_glbc_tmp.xrdadocno = p_xrdadocno
         
         IF l_amt1 > l_glbc.glbc008 THEN 
            LET l_glbc_tmp.glbc008   = l_glbc.glbc008
            LET l_glbc_tmp.glbc009   = l_glbc.glbc009
         
            #--以下視主帳套有無啟用本位幣
            IF l_glaa015 = 'Y' THEN 
               LET l_glbc_tmp.glbc011 = l_glbc.glbc011
               LET l_glbc_tmp.glbc012 = l_glbc.glbc012
            END IF
            IF l_glaa019 = 'Y' THEN 
               LET l_glbc_tmp.glbc013 = l_glbc.glbc013
               LET l_glbc_tmp.glbc014 = l_glbc.glbc014
            END IF 
            
            LET l_amt1 = l_xrde.xrde109 - l_glbc.glbc008
            LET l_amt2 = l_xrde.xrde119 - l_glbc.glbc009
            LET l_amt3 = l_xrde.xrde129 - l_glbc.glbc012
            LET l_amt4 = l_xrde.xrde139 - l_glbc.glbc014
         ELSE
            LET l_glbc_tmp.glbc008   = l_amt1
            LET l_glbc_tmp.glbc009   = l_amt2
         
            #--以下視主帳套有無啟用本位幣
            IF l_glaa015 = 'Y' THEN 
               LET l_glbc_tmp.glbc011 = l_glbc.glbc011
               LET l_glbc_tmp.glbc012 = l_amt3
            END IF
            IF l_glaa019 = 'Y' THEN 
               LET l_glbc_tmp.glbc013 = l_glbc.glbc013
               LET l_glbc_tmp.glbc014 = l_amt4
            END IF 
         END IF 
         
         INSERT INTO s_voucher_glbc VALUES(l_glbc_tmp.*)
         IF SQLCA.sqlcode THEN
            LET r_success = FALSE
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = 'ins s_voucher_glbc'
            LET g_errparam.popup = TRUE
            CALL cl_err()
         
            RETURN r_success
         END IF 
      END FOREACH 
   END FOREACH 
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 插入glbc表
# Memo...........:
# Usage..........: CALL s_voucher_ins_glac(p_ld,p_docdt,p_glapdocno,p_seq,p_glaq002,l_glaq)
#                  RETURNING r_success
# Input parameter: p_ld           账套
#                : p_docdt        单据日期
#                : p_glapdocno    凭证单号
#                : p_seq          凭证项次
#                : p_glaq002      科目编号
#                : p_glbc004      现金变动码
#                : p_glbc005      关系人
#                : l_glaq         单身数组
# Return code....: r_success      成功否标识位
# Date & Author..: 2014/12/10 By lujh
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_ins_glac(p_ld,p_docdt,p_glapdocno,p_seq,p_glaq002,p_glbc004,p_glbc005,l_glaq)
   DEFINE p_ld           LIKE glaa_t.glaald
   DEFINE p_docdt        LIKE glga_t.glgadocdt
   DEFINE p_glapdocno    LIKE glap_t.glapdocno
   DEFINE p_seq          LIKE glaq_t.glaqseq
   DEFINE p_glaq002      LIKE glaq_t.glaq002
   DEFINE p_glbc004      LIKE glbc_t.glbc004
   DEFINE p_glbc005      LIKE glbc_t.glbc005
   DEFINE r_success      LIKE type_t.num5
    #161128-00061#7---add---begin-----------
   #DEFINE l_glbc         RECORD LIKE glbc_t.*
   DEFINE l_glbc RECORD  #現金變動碼明細檔
       glbcent LIKE glbc_t.glbcent, #企業編號
       glbcld LIKE glbc_t.glbcld, #帳套
       glbccomp LIKE glbc_t.glbccomp, #營運據點
       glbcdocno LIKE glbc_t.glbcdocno, #傳票編號
       glbcseq LIKE glbc_t.glbcseq, #項次
       glbcseq1 LIKE glbc_t.glbcseq1, #序號
       glbc001 LIKE glbc_t.glbc001, #年度
       glbc002 LIKE glbc_t.glbc002, #期別
       glbc003 LIKE glbc_t.glbc003, #借貸別
       glbc004 LIKE glbc_t.glbc004, #現金變動碼
       glbc005 LIKE glbc_t.glbc005, #交易客商
       glbc006 LIKE glbc_t.glbc006, #交易幣別
       glbc007 LIKE glbc_t.glbc007, #匯率
       glbc008 LIKE glbc_t.glbc008, #原幣金額
       glbc009 LIKE glbc_t.glbc009, #本幣金額
       glbc010 LIKE glbc_t.glbc010, #資料來源
       glbc011 LIKE glbc_t.glbc011, #匯率(本位幣二)
       glbc012 LIKE glbc_t.glbc012, #金額(本位幣二)
       glbc013 LIKE glbc_t.glbc013, #匯率(本位幣三)
       glbc014 LIKE glbc_t.glbc014, #金額(本位幣三)
       glbcud001 LIKE glbc_t.glbcud001, #自定義欄位(文字)001
       glbcud002 LIKE glbc_t.glbcud002, #自定義欄位(文字)002
       glbcud003 LIKE glbc_t.glbcud003, #自定義欄位(文字)003
       glbcud004 LIKE glbc_t.glbcud004, #自定義欄位(文字)004
       glbcud005 LIKE glbc_t.glbcud005, #自定義欄位(文字)005
       glbcud006 LIKE glbc_t.glbcud006, #自定義欄位(文字)006
       glbcud007 LIKE glbc_t.glbcud007, #自定義欄位(文字)007
       glbcud008 LIKE glbc_t.glbcud008, #自定義欄位(文字)008
       glbcud009 LIKE glbc_t.glbcud009, #自定義欄位(文字)009
       glbcud010 LIKE glbc_t.glbcud010, #自定義欄位(文字)010
       glbcud011 LIKE glbc_t.glbcud011, #自定義欄位(數字)011
       glbcud012 LIKE glbc_t.glbcud012, #自定義欄位(數字)012
       glbcud013 LIKE glbc_t.glbcud013, #自定義欄位(數字)013
       glbcud014 LIKE glbc_t.glbcud014, #自定義欄位(數字)014
       glbcud015 LIKE glbc_t.glbcud015, #自定義欄位(數字)015
       glbcud016 LIKE glbc_t.glbcud016, #自定義欄位(數字)016
       glbcud017 LIKE glbc_t.glbcud017, #自定義欄位(數字)017
       glbcud018 LIKE glbc_t.glbcud018, #自定義欄位(數字)018
       glbcud019 LIKE glbc_t.glbcud019, #自定義欄位(數字)019
       glbcud020 LIKE glbc_t.glbcud020, #自定義欄位(數字)020
       glbcud021 LIKE glbc_t.glbcud021, #自定義欄位(日期時間)021
       glbcud022 LIKE glbc_t.glbcud022, #自定義欄位(日期時間)022
       glbcud023 LIKE glbc_t.glbcud023, #自定義欄位(日期時間)023
       glbcud024 LIKE glbc_t.glbcud024, #自定義欄位(日期時間)024
       glbcud025 LIKE glbc_t.glbcud025, #自定義欄位(日期時間)025
       glbcud026 LIKE glbc_t.glbcud026, #自定義欄位(日期時間)026
       glbcud027 LIKE glbc_t.glbcud027, #自定義欄位(日期時間)027
       glbcud028 LIKE glbc_t.glbcud028, #自定義欄位(日期時間)028
       glbcud029 LIKE glbc_t.glbcud029, #自定義欄位(日期時間)029
       glbcud030 LIKE glbc_t.glbcud030, #自定義欄位(日期時間)030
       glbc015 LIKE glbc_t.glbc015  #狀態碼
       END RECORD
   #161128-00061#7---add---end-----------
   DEFINE l_year         LIKE type_t.num5
   DEFINE l_month        LIKE type_t.num5 
   DEFINE l_sql          STRING
   DEFINE l_glaa004      LIKE glaa_t.glaa004
   DEFINE l_glac016      LIKE glac_t.glac016
   #161128-00061#7---add---begin-----------
   #DEFINE l_glaq              RECORD LIKE glaq_t.*
   DEFINE l_glaq RECORD  #傳票憑證單身檔
       glaqent LIKE glaq_t.glaqent, #企業編號
       glaqcomp LIKE glaq_t.glaqcomp, #法人
       glaqld LIKE glaq_t.glaqld, #帳套
       glaqdocno LIKE glaq_t.glaqdocno, #單號
       glaqseq LIKE glaq_t.glaqseq, #項次
       glaq001 LIKE glaq_t.glaq001, #摘要
       glaq002 LIKE glaq_t.glaq002, #科目編號
       glaq003 LIKE glaq_t.glaq003, #借方金額
       glaq004 LIKE glaq_t.glaq004, #貸方金額
       glaq005 LIKE glaq_t.glaq005, #交易幣別
       glaq006 LIKE glaq_t.glaq006, #匯率
       glaq007 LIKE glaq_t.glaq007, #計價單位
       glaq008 LIKE glaq_t.glaq008, #數量
       glaq009 LIKE glaq_t.glaq009, #單價
       glaq010 LIKE glaq_t.glaq010, #原幣金額
       glaq011 LIKE glaq_t.glaq011, #票據編碼
       glaq012 LIKE glaq_t.glaq012, #票據日期
       glaq013 LIKE glaq_t.glaq013, #申請人
       glaq014 LIKE glaq_t.glaq014, #銀行帳號
       glaq015 LIKE glaq_t.glaq015, #款別編號
       glaq016 LIKE glaq_t.glaq016, #收支專案
       glaq017 LIKE glaq_t.glaq017, #營運據點
       glaq018 LIKE glaq_t.glaq018, #部門
       glaq019 LIKE glaq_t.glaq019, #利潤/成本中心
       glaq020 LIKE glaq_t.glaq020, #區域
       glaq021 LIKE glaq_t.glaq021, #收付款客商
       glaq022 LIKE glaq_t.glaq022, #帳款客戶
       glaq023 LIKE glaq_t.glaq023, #客群
       glaq024 LIKE glaq_t.glaq024, #產品類別
       glaq025 LIKE glaq_t.glaq025, #人員
       glaq026 LIKE glaq_t.glaq026, #no use
       glaq027 LIKE glaq_t.glaq027, #專案編號
       glaq028 LIKE glaq_t.glaq028, #WBS
       glaq029 LIKE glaq_t.glaq029, #自由核算項一
       glaq030 LIKE glaq_t.glaq030, #自由核算項二
       glaq031 LIKE glaq_t.glaq031, #自由核算項三
       glaq032 LIKE glaq_t.glaq032, #自由核算項四
       glaq033 LIKE glaq_t.glaq033, #自由核算項五
       glaq034 LIKE glaq_t.glaq034, #自由核算項六
       glaq035 LIKE glaq_t.glaq035, #自由核算項七
       glaq036 LIKE glaq_t.glaq036, #自由核算項八
       glaq037 LIKE glaq_t.glaq037, #自由核算項九
       glaq038 LIKE glaq_t.glaq038, #自由核算項十
       glaq039 LIKE glaq_t.glaq039, #匯率(本位幣二)
       glaq040 LIKE glaq_t.glaq040, #借方金額(本位幣二)
       glaq041 LIKE glaq_t.glaq041, #貸方金額(本位幣二)
       glaq042 LIKE glaq_t.glaq042, #匯率(本位幣三)
       glaq043 LIKE glaq_t.glaq043, #借方金額(本位幣三)
       glaq044 LIKE glaq_t.glaq044, #貸方金額(本位幣三)
       glaq051 LIKE glaq_t.glaq051, #經營方式
       glaq052 LIKE glaq_t.glaq052, #通路
       glaq053 LIKE glaq_t.glaq053, #品牌
       glaqud001 LIKE glaq_t.glaqud001, #自定義欄位(文字)001
       glaqud002 LIKE glaq_t.glaqud002, #自定義欄位(文字)002
       glaqud003 LIKE glaq_t.glaqud003, #自定義欄位(文字)003
       glaqud004 LIKE glaq_t.glaqud004, #自定義欄位(文字)004
       glaqud005 LIKE glaq_t.glaqud005, #自定義欄位(文字)005
       glaqud006 LIKE glaq_t.glaqud006, #自定義欄位(文字)006
       glaqud007 LIKE glaq_t.glaqud007, #自定義欄位(文字)007
       glaqud008 LIKE glaq_t.glaqud008, #自定義欄位(文字)008
       glaqud009 LIKE glaq_t.glaqud009, #自定義欄位(文字)009
       glaqud010 LIKE glaq_t.glaqud010, #自定義欄位(文字)010
       glaqud011 LIKE glaq_t.glaqud011, #自定義欄位(數字)011
       glaqud012 LIKE glaq_t.glaqud012, #自定義欄位(數字)012
       glaqud013 LIKE glaq_t.glaqud013, #自定義欄位(數字)013
       glaqud014 LIKE glaq_t.glaqud014, #自定義欄位(數字)014
       glaqud015 LIKE glaq_t.glaqud015, #自定義欄位(數字)015
       glaqud016 LIKE glaq_t.glaqud016, #自定義欄位(數字)016
       glaqud017 LIKE glaq_t.glaqud017, #自定義欄位(數字)017
       glaqud018 LIKE glaq_t.glaqud018, #自定義欄位(數字)018
       glaqud019 LIKE glaq_t.glaqud019, #自定義欄位(數字)019
       glaqud020 LIKE glaq_t.glaqud020, #自定義欄位(數字)020
       glaqud021 LIKE glaq_t.glaqud021, #自定義欄位(日期時間)021
       glaqud022 LIKE glaq_t.glaqud022, #自定義欄位(日期時間)022
       glaqud023 LIKE glaq_t.glaqud023, #自定義欄位(日期時間)023
       glaqud024 LIKE glaq_t.glaqud024, #自定義欄位(日期時間)024
       glaqud025 LIKE glaq_t.glaqud025, #自定義欄位(日期時間)025
       glaqud026 LIKE glaq_t.glaqud026, #自定義欄位(日期時間)026
       glaqud027 LIKE glaq_t.glaqud027, #自定義欄位(日期時間)027
       glaqud028 LIKE glaq_t.glaqud028, #自定義欄位(日期時間)028
       glaqud029 LIKE glaq_t.glaqud029, #自定義欄位(日期時間)029
       glaqud030 LIKE glaq_t.glaqud030  #自定義欄位(日期時間)030
       END RECORD
   #161128-00061#7---add---end-----------
   
   LET r_success = TRUE
   SELECT glaa004 INTO l_glaa004 
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald = p_ld
   
   SELECT glac016 INTO l_glac016 
     FROM glac_t
    WHERE glacent = g_enterprise
      AND glac001 = l_glaa004
      AND glac002 = p_glaq002
      
   IF l_glac016 = 'N' OR cl_null(l_glac016) THEN 
      RETURN r_success
   END IF 
   
   LET l_year = YEAR(p_docdt)
   LET l_month = MONTH(p_docdt)

   LET l_glbc.glbcent   = g_enterprise
   LET l_glbc.glbcld    = p_ld
   LET l_glbc.glbccomp  = l_glaq.glaqcomp 
   LET l_glbc.glbcdocno = p_glapdocno
   LET l_glbc.glbcseq   = p_seq
   LET l_glbc.glbc001   = l_year
   LET l_glbc.glbc002   = l_month
   
   SELECT MAX(glbcseq1) + 1 INTO l_glbc.glbcseq1
     FROM glbc_t
    WHERE glbcent = g_enterprise
      AND glbcld =  l_glbc.glbcld
      AND glbcdocno = l_glbc.glbcdocno
      AND glbcseq = l_glbc.glbcseq
      AND glbc001 = l_glbc.glbc001
      AND glbc002 = l_glbc.glbc002   
   IF cl_null(l_glbc.glbcseq1) OR l_glbc.glbcseq1 = 0 THEN 
      LET l_glbc.glbcseq1 = 1
   END IF
   
   IF l_glaq.glaq003 <> 0 AND l_glaq.glaq004 = 0 THEN 
      LET l_glbc.glbc003 = '1'
   END IF
   
   IF l_glaq.glaq004 <> 0 AND l_glaq.glaq003 = 0 THEN 
      LET l_glbc.glbc003 = '2'
   END IF
   
   LET l_glbc.glbc004   = p_glbc004
   LET l_glbc.glbc005   = p_glbc005
   LET l_glbc.glbc006   = l_glaq.glaq005
   LET l_glbc.glbc007   = l_glaq.glaq006
   LET l_glbc.glbc008   = l_glaq.glaq010
   IF l_glbc.glbc003 = '1' THEN 
      LET l_glbc.glbc009 = l_glaq.glaq003
      LET l_glbc.glbc012 = l_glaq.glaq040
      LET l_glbc.glbc014 = l_glaq.glaq043
   ELSE
      LET l_glbc.glbc009 = l_glaq.glaq004
      LET l_glbc.glbc012 = l_glaq.glaq041
      LET l_glbc.glbc014 = l_glaq.glaq044
   END IF
   LET l_glbc.glbc010   ='1' 
   LET l_glbc.glbc011 = l_glaq.glaq039
   LET l_glbc.glbc013 = l_glaq.glaq042
   LET l_glbc.glbc015 = 'Y'      #151013-00016#6
   INSERT INTO glbc_t VALUES(l_glbc.*)
   
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'ins glbc_t'
      LET g_errparam.popup = TRUE
      CALL cl_err()
   
      LET r_success = FALSE
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 渠道編號檢查
# Memo...........:
# Usage..........: CALL s_voucher_glaq052_chk(p_glaq052)
# Date & Author..: 2014/10/13 By 02599
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_glaq052_chk(p_glaq052)
   DEFINE p_glaq052         LIKE glaq_t.glaq052
   DEFINE l_oojdstus        LIKE oojd_t.oojdstus
   
   LET g_errno = ''
   SELECT oojdstus INTO l_oojdstus FROM oojd_t
   WHERE oojdent=g_enterprise AND oojd001=p_glaq052
   
   CASE
     WHEN SQLCA.SQLCODE = 100
        LET g_errno = 'aoo-00298'
     WHEN l_oojdstus = 'N'
        LET g_errno = 'aoo-00300'
   END CASE
END FUNCTION

################################################################################
# Descriptions...: 檢查經營方式是否正確
# Memo...........:
# Usage..........: CALL s_voucher_glaq051_chk(p_glaq051)
# Date & Author..: 2014/10/13 By 02599
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_glaq051_chk(p_glaq051)
   DEFINE p_glaq051         LIKE glaq_t.glaq051
   DEFINE l_cnt             LIKE type_t.num5
   
   LET g_errno = ''
   LET l_cnt=0
   #SELECT COUNT(*) INTO l_cnt FROM gzcb_t      #170615-00061#25 mark
   SELECT COUNT(gzcb002) INTO l_cnt FROM gzcb_t #170615-00061#25 add
   WHERE gzcb001='6013' AND gzcb002=p_glaq051
   
   IF l_cnt=0 THEN
      LET g_errno = 'agl-00289'
   END IF
END FUNCTION
################################################################################################
# Descriptions...: 自动产生凭证 定义CURSOR
# Memo...........:
# Usage..........: CALL s_voucher_gen_fm_1_def_cursor(p_ld,p_wc,p_sum_type,p_date,p_source)
#                  RETURNING r_success
# Input parameter: p_ld           帐套
#                : p_wc           QBE条件(帐款来源)
#                : p_sum_type     汇总方式
#                : p_source       資料來源于
# Return code....: r_success      成功否标识位
# Date & Author..: 2014/10/20 By jingll
# Modify.........:
################################################################################################
PUBLIC FUNCTION s_voucher_gen_fm_1_def_cursor(p_ld,p_wc,p_sum_type,p_date,p_source)
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE p_wc            LIKE type_t.chr1000
   DEFINE p_sum_type      LIKE type_t.chr1
   DEFINE p_source        LIKE type_t.chr10
   DEFINE r_success       LIKE type_t.num5
   DEFINE l_sql           LIKE type_t.chr1000  
   DEFINE l_glaa004       LIKE glaa_t.glaa004   
   DEFINE l_field         LIKE type_t.chr50
   DEFINE p_date          LIKE type_t.dat
   DEFINE l_glab005d      LIKE glab_t.glab005      #借方科目
   DEFINE l_glab005c      LIKE glab_t.glab005      #贷方科目

   WHENEVER ERROR CONTINUE
   LET r_success = FALSE 

#yangtt--2016/03/15--mark--str--
#   IF p_source = 'afmt075' THEN
#      LET l_sql = "SELECT * FROM fmay_t ",
#                  " WHERE fmay003 = '",p_ld CLIPPED,"'",
#                  "   AND fmay007 IS NULL ",
#                  "   AND ",p_wc
#      PREPARE s_voucher_gen_fm_1_p FROM l_sql
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 's_voucher_gen_fm_1_p'
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#         RETURN r_success
#      END IF
#      DECLARE s_voucher_gen_fm_1_cs CURSOR FOR s_voucher_gen_fm_1_p
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 's_voucher_gen_fm_1_cs'
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#        RETURN r_success
#      END IF            
#   END IF
#   
#   IF p_source = 'afmt090' THEN 
#      LET l_sql = "SELECT * FROM fmbb_t ",
#                  " WHERE fmbb003 = '",p_ld CLIPPED,"'",
#                  "   AND fmbb006 IS NULL ",
#                  "   AND ",p_wc
#      PREPARE s_voucher_gen_fm_2_p FROM l_sql
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 's_voucher_gen_fm_2_p'
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#         RETURN r_success
#      END IF
#      DECLARE s_voucher_gen_fm_2_cs CURSOR FOR s_voucher_gen_fm_2_p
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 's_voucher_gen_fm_2_cs'
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#         RETURN r_success
#      END IF            
#   END IF
#yangtt--2016/03/15--mark--end--
   
   #宣告抓取符合條件的單據之單頭
   #150429-00010#14 add ------
   IF p_source = 'afmt570' THEN
      #161128-00061#7---add---begin-----------
      #LET l_sql = "SELECT * FROM fmna_t ",
      LET l_sql = "SELECT fmnaent,fmnadocno,fmnacomp,fmnasite,fmnadocdt,fmna001,fmna002,fmna003,fmna004,",
                  "fmna005,fmna006,fmnaownid,fmnaowndp,fmnacrtid,fmnacrtdp,fmnacrtdt,fmnamodid,fmnamoddt,",
                  "fmnacnfid,fmnacnfdt,fmnapstid,fmnapstdt,fmnastus,fmnaud001,fmnaud002,fmnaud003,fmnaud004,",
                  "fmnaud005,fmnaud006,fmnaud007,fmnaud008,fmnaud009,fmnaud010,fmnaud011,fmnaud012,fmnaud013,",
                  "fmnaud014,fmnaud015,fmnaud016,fmnaud017,fmnaud018,fmnaud019,fmnaud020,fmnaud021,fmnaud022,",
                  "fmnaud023,fmnaud024,fmnaud025,fmnaud026,fmnaud027,fmnaud028,fmnaud029,fmnaud030 FROM fmna_t ",
      #161128-00061#7---add---end-----------
                  " WHERE fmna001 = '",p_ld CLIPPED,"'",
                  "   AND fmna005 IS NULL ",
                  "   AND fmnaent = ",g_enterprise,  #161206-00023#1 add
                  "   AND ",p_wc
      PREPARE s_voucher_gen_fm_3_p FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_3_p'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_3_cs CURSOR FOR s_voucher_gen_fm_3_p
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_3_cs'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
   END IF
   #150429-00010#14 add end---
   
   #140804-00008#13 add ------
   IF p_source = 'afmt555' THEN
      #161128-00061#7---add---begin-----------
      #LET l_sql = "SELECT * FROM fmmq_t ",
      LET l_sql = "SELECT fmmqent,fmmqdocno,fmmqdocdt,fmmqsite,fmmq001,fmmq002,fmmq003,fmmq004,fmmqownid,",
                  "fmmqowndp,fmmqcrtid,fmmqcrtdp,fmmqcrtdt,fmmqmodid,fmmqmoddt,fmmqcnfid,fmmqcnfdt,fmmqpstid,",
                  "fmmqpstdt,fmmqstus,fmmqud001,fmmqud002,fmmqud003,fmmqud004,fmmqud005,fmmqud006,fmmqud007,",
                  "fmmqud008,fmmqud009,fmmqud010,fmmqud011,fmmqud012,fmmqud013,fmmqud014,fmmqud015,fmmqud016,",
                  "fmmqud017,fmmqud018,fmmqud019,fmmqud020,fmmqud021,fmmqud022,fmmqud023,fmmqud024,fmmqud025,",
                  "fmmqud026,fmmqud027,fmmqud028,fmmqud029,fmmqud030 FROM fmmq_t ",
      #161128-00061#7---add---end-----------
                  " WHERE fmmq001 = '",p_ld CLIPPED,"'",
                  "   AND fmmq004 IS NULL ",
                  "   AND fmmqent = ",g_enterprise,  #161206-00023#1 add
                  "   AND ",p_wc
      PREPARE s_voucher_gen_fm_4_p FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_4_p'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_4_cs CURSOR FOR s_voucher_gen_fm_4_p
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_4_cs'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
   END IF
   #140804-00008#13 add end---
   
   #140804-00008#20 albireo 150520-s
   IF p_source = 'afmt595' THEN
      #161128-00061#7---add---begin----------- 
      #LET l_sql = "SELECT * FROM fmne_t ",
      LET l_sql = "SELECT fmneent,fmneownid,fmneowndp,fmnecrtid,fmnecrtdp,fmnecrtdt,fmnemodid,fmnemoddt,",
                  "fmnecnfid,fmnecnfdt,fmnepstid,fmnepstdt,fmnestus,fmnedocno,fmnecomp,fmnesite,fmnedocdt,",
                  "fmne001,fmne002,fmne003,fmne004,fmne005,fmneud001,fmneud002,fmneud003,fmneud004,fmneud005,",
                  "fmneud006,fmneud007,fmneud008,fmneud009,fmneud010,fmneud011,fmneud012,fmneud013,fmneud014,",
                  "fmneud015,fmneud016,fmneud017,fmneud018,fmneud019,fmneud020,fmneud021,fmneud022,fmneud023,",
                  "fmneud024,fmneud025,fmneud026,fmneud027,fmneud028,fmneud029,fmneud030 FROM fmne_t ",
      #161128-00061#7---add---end-----------
                  " WHERE fmne001 = '",p_ld CLIPPED,"'",
                  "   AND fmne004 IS NULL ",
                  "   AND fmneent = ",g_enterprise,  #161206-00023#1 add
                  "   AND ",p_wc
      PREPARE s_voucher_gen_fm_5_p FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_p'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_5_cs CURSOR FOR s_voucher_gen_fm_5_p
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_cs'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
   END IF 
   #140804-00008#20 albireo 150520-e 
   
   #140804-00008#18 hans 150525 -s
   IF p_source = 'afmt585' THEN
      #161128-00061#7---add---begin-----------
      #LET l_sql = "SELECT * FROM fmmw_t ",
      LET l_sql = "SELECT fmmwent,fmmwdocno,fmmwcomp,fmmwsite,fmmwdocdt,fmmw001,fmmw002,fmmw003,fmmw004,",
                  "fmmw005,fmmwownid,fmmwowndp,fmmwcrtid,fmmwcrtdp,fmmwcrtdt,fmmwmodid,fmmwmoddt,fmmwcnfid,",
                  "fmmwcnfdt,fmmwpstid,fmmwpstdt,fmmwstus,fmmwud001,fmmwud002,fmmwud003,fmmwud004,fmmwud005,",
                  "fmmwud006,fmmwud007,fmmwud008,fmmwud009,fmmwud010,fmmwud011,fmmwud012,fmmwud013,fmmwud014,",
                  "fmmwud015,fmmwud016,fmmwud017,fmmwud018,fmmwud019,fmmwud020,fmmwud021,fmmwud022,fmmwud023,",
                  "fmmwud024,fmmwud025,fmmwud026,fmmwud027,fmmwud028,fmmwud029,fmmwud030 FROM fmmw_t ",
      #161128-00061#7---add---end-----------
                  " WHERE fmmw001 = '",p_ld CLIPPED,"'",
                  "   AND fmmw004 IS NULL ",
                  "   AND fmmwent = ",g_enterprise,  #161206-00023#1 add
                  "   AND ",p_wc
      PREPARE s_voucher_gen_fm_6_p FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_6_p'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_6_cs CURSOR FOR s_voucher_gen_fm_6_p
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_6_cs'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
   END IF
   #140804-00008#18 hans 150525 -e
   
   #140804-00008#15 add ------
   IF p_source = 'afmt565' THEN
      #161128-00061#7---add---begin-----------
      #LET l_sql = "SELECT * FROM fmmu_t ",
       LET l_sql = "SELECT fmmuent,fmmudocno,fmmusite,fmmu001,fmmu002,fmmu003,fmmu004,fmmudocdt,fmmuownid,",
                   "fmmuowndp,fmmucrtid,fmmucrtdp,fmmucrtdt,fmmumodid,fmmumoddt,fmmucnfid,fmmucnfdt,fmmupstid,",
                   "fmmupstdt,fmmustus,fmmuud001,fmmuud002,fmmuud003,fmmuud004,fmmuud005,fmmuud006,fmmuud007,",
                   "fmmuud008,fmmuud009,fmmuud010,fmmuud011,fmmuud012,fmmuud013,fmmuud014,fmmuud015,fmmuud016,",
                   "fmmuud017,fmmuud018,fmmuud019,fmmuud020,fmmuud021,fmmuud022,fmmuud023,fmmuud024,fmmuud025,",
                   "fmmuud026,fmmuud027,fmmuud028,fmmuud029,fmmuud030 FROM fmmu_t ",
      #161128-00061#7---add---end-----------
                  " WHERE fmmu001 = '",p_ld CLIPPED,"'",
                  "   AND fmmu004 IS NULL ",
                  "   AND fmmuent = ",g_enterprise,  #161206-00023#1 add
                  "   AND ",p_wc
      PREPARE s_voucher_gen_fm_7_p FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_7_p'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_7_cs CURSOR FOR s_voucher_gen_fm_7_p
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_7_cs'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
   END IF
   #140804-00008#15 add end---
   
   #140804-00008#9 add ------
   IF p_source = 'afmt535' THEN
     #161128-00061#7---add---begin-----------
     #LET l_sql = "SELECT * FROM fmml_t ",
      LET l_sql = "SELECT fmmlent,fmml001,fmmldocno,fmml003,fmml004,fmml005,fmml006,fmml007,fmmldocdt,",
                  "fmmlownid,fmmlowndp,fmmlcrtid,fmmlcrtdp,fmmlcrtdt,fmmlmodid,fmmlmoddt,fmmlcnfid,",
                  "fmmlcnfdt,fmmlpstid,fmmlpstdt,fmmlstus,fmmlud001,fmmlud002,fmmlud003,fmmlud004,",
                  "fmmlud005,fmmlud006,fmmlud007,fmmlud008,fmmlud009,fmmlud010,fmmlud011,fmmlud012,",
                  "fmmlud013,fmmlud014,fmmlud015,fmmlud016,fmmlud017,fmmlud018,fmmlud019,fmmlud020,",
                  "fmmlud021,fmmlud022,fmmlud023,fmmlud024,fmmlud025,fmmlud026,fmmlud027,fmmlud028,",
                  "fmmlud029,fmmlud030 FROM fmml_t ",
     #161128-00061#7---add---end-----------
                  " WHERE fmml003 = '",p_ld CLIPPED,"'",
                  "   AND fmml007 IS NULL ",
                  "   AND fmmlent = ",g_enterprise,  #161206-00023#1 add
                  "   AND ",p_wc
      PREPARE s_voucher_gen_fm_8_p FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_8_p'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_8_cs CURSOR FOR s_voucher_gen_fm_8_p
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_8_cs'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
   END IF
   #140804-00008#9 add end---
   
   
#yangtt--2016/03/15--mark--str--
#   IF p_source = 'afmt075' THEN
#               #单号/日期/借/企业/法人/帐套/摘要/科目
#      LET l_sql = "SELECT fmay002,fmaycrtdt,'',fmayent,fmay004,fmay003,'','',",
#                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
#                  "       fmbe008,fmbe010,'','',fmbe009,'','',fmayownid,'','','',",
#                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
#                  "       fmbe026,fmbe027,fmbe028,fmbe029,fmbe030,fmbe031,fmbe032,fmbe033,fmbe034,",
#                  #预算编号/专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10
#                  "       fmbe035,fmbe036,fmbe037,fmbe038,fmbe039,fmbe040,fmbe041,fmbe042,fmbe043,fmbe044,fmbe045,fmbe046,fmbe047,fmbe048,fmbe049,fmbe050,",
#                  #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
#                  "       fmbe011,'','',fmbe009,fmbe013,fmbe014,'',fmbe015,fmbe016,'',fmbe002,'fmbe','','','','','',fmbe012,fmbe051,'','' ", 
#                  "  FROM fmay_t,fmbe_t ",
#                  " WHERE fmayent   = ",g_enterprise,
#                  "   AND fmay003    = '",p_ld CLIPPED,"'",
#                  "   AND fmay002 = ? ",
#                  "   AND fmayent   = fmbeent ",
#                  "   AND fmay002 = fmbe001 "
#      PREPARE s_voucher_gen_fm_1_p1 FROM l_sql            
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 's_voucher_gen_fm_1_p1'
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#
#         RETURN r_success
#      END IF
#      DECLARE s_voucher_gen_fm_1_cs1 CURSOR FOR s_voucher_gen_fm_1_p1
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 's_voucher_gen_fm_1_cs1'
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#
#         RETURN r_success
#      END IF                       
#   END IF 
#
#   IF p_source = 'afmt090' THEN
#                  #单号/日期/借/企业/法人/帐套/摘要/科目
#      LET l_sql = "SELECT fmbb008,fmbbcrtdt,'',fmbbent,fmbb002,fmbb003,'','',",
#                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
#                  "       fmbb011,'1','','',fmbb017,'','',fmbbownid,'','','',",
#                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
#                  "       fmbb029,fmbb030,fmbb031,fmbb032,fmbb033,fmbb034,fmbb035,fmbb036,fmbb037,",
#                  #预算编号/专案编号/WBS/經營方式/渠道/品牌/自由核算项1~10
#                  "       fmbb038,fmbb039,fmbb040,fmbb041,fmbb042,fmbb043,fmbb044,fmbb045,fmbb046,fmbb047,fmbb048,fmbb049,fmbb050,fmbb051,fmbb052,fmbb053,",
#                  #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
#                  "       fmbb017,'','',fmbb017,'1',fmbb022,'','1',fmbb027,'',fmbb009,'fmbb','','',fmbb007,fmbb004,fmbb005,fmbb010,fmbb028,'','' ", 
#                  "  FROM fmbb_t ",
#                  " WHERE fmbbent   = ",g_enterprise,
#                  "   AND fmbb003    = '",p_ld CLIPPED,"'",
#                  "   AND fmbb004 = ?",
#                  "   AND fmbb005 = ? "
#      PREPARE s_voucher_gen_fm_2_p1 FROM l_sql            
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 's_voucher_gen_fm_2_p1'
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#
#         RETURN r_success
#      END IF
#      DECLARE s_voucher_gen_fm_2_cs1 CURSOR FOR s_voucher_gen_fm_2_p1  
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 's_voucher_gen_fm_2_cs1'
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#
#         RETURN r_success
#      END IF                       
#   END IF
#yangtt--2016/03/15--mark--end--
       
   #150429-00010#14 add ------
   IF p_source = 'afmt570' THEN
     ##借：重評價科目   #151203 mark
      #借：對方科目     #151203      
                   #单号/日期/借/企业/法人/帐套/摘要/科目
     #LET l_sql = "SELECT fmnadocno,fmnadocdt,'1',fmnaent,fmnacomp,fmna001,fmnb031,fmnb028,",   #151203 mark
      LET l_sql = "SELECT fmnadocno,fmnadocdt,'1',fmnaent,fmnacomp,fmna001,fmnb031,fmnb029,",   #151203      
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                  "       fmnb100,fmnb101,'',0,0,'','',fmna006,'','','',",
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmnasite,fmnb007,fmnb008,fmnb009,fmnb005,fmnb006,fmnb010,fmnb011,fmnb012,",
                  #预算编号/专案编号/WBS/經營方式/渠道/品牌
                 #"       '',fmnb013,fmnb014,fmnb015,fmnb016,fmnb017,", #151112-00009#3 mark
                  "       fmnb013,fmnb014,fmnb015,fmnb016,fmnb017,",    #151112-00009#3
                  #自由核算項1~5
                  "       fmnb018,fmnb019,fmnb020,fmnb021,fmnb022,",
                  #自由核算項6~10
                  "       fmnb023,fmnb024,fmnb025,fmnb026,fmnb027,",
                  #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
                  "       fmnb115,0,0,fmnb115,fmnb125,fmnb124,0,fmnb135,fmnb134,0,",
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                  "       fmnbseq,'fmna','','','',fmna002,fmna003,'',''",
                  "  FROM fmna_t,fmnb_t ",
                  " WHERE fmnaent = ",g_enterprise,
                  "   AND fmna001 = '",p_ld,"'",
                  "   AND fmnadocno = ?",
                  "   AND fmnaent = fmnbent AND fmnadocno = fmnbdocno"
      PREPARE s_voucher_gen_fm_3_p1 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_3_p1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_3_cs1 CURSOR FOR s_voucher_gen_fm_3_p1
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_3_cs1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      
     ##貸：對方科目    #151203 mark
      #貸：重評價科目  #151203      
                   #单号/日期/借/企业/法人/帐套/摘要/科目
     #LET l_sql = "SELECT fmnadocno,fmnadocdt,'2',fmnaent,fmnacomp,fmna001,fmnb031,fmnb029,",   #151203 mark
      LET l_sql = "SELECT fmnadocno,fmnadocdt,'2',fmnaent,fmnacomp,fmna001,fmnb031,fmnb028,",   #151203      
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                  "       fmnb100,fmnb101,'',0,0,'','',fmna006,'','','',",
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmnasite,fmnb007,fmnb008,fmnb009,fmnb005,fmnb006,fmnb010,fmnb011,fmnb012,",
                  #预算编号/专案编号/WBS/經營方式/渠道/品牌
                 #"       '',fmnb013,fmnb014,fmnb015,fmnb016,fmnb017,", #151112-00009#3 mark
                  "       fmnb013,fmnb014,fmnb015,fmnb016,fmnb017,",    #151112-00009#3
                  #自由核算項1~5
                  "       fmnb018,fmnb019,fmnb020,fmnb021,fmnb022,",
                  #自由核算項6~10
                  "       fmnb023,fmnb024,fmnb025,fmnb026,fmnb027,",
                  #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
                  "       0,fmnb115,0,fmnb115,fmnb125,0,fmnb124,fmnb135,0,fmnb134,",
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                  "       fmnbseq,'fmna','','','',fmna002,fmna003,'',''",
                  "  FROM fmna_t,fmnb_t ",
                  " WHERE fmnaent = ",g_enterprise,
                  "   AND fmna001 = '",p_ld CLIPPED,"'",
                  "   AND fmnadocno = ?",
                  "   AND fmnaent = fmnbent AND fmnadocno = fmnbdocno"
      PREPARE s_voucher_gen_fm_3_p2 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_3_p2'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_3_cs2 CURSOR FOR s_voucher_gen_fm_3_p2
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_3_cs2'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
   END IF
   #150429-00010#14 add end---
   
   #140804-00008#13 add ------
   IF p_source = 'afmt555' THEN
      #借：公允價值變動科目
                   #单号/日期/借/企业/法人/帐套/摘要/科目
      LET l_sql = "SELECT fmmqdocno,fmmqdocdt,'1',fmmqent,'',fmmq001,fmmr036,fmmr011,",
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                  "       fmmr003,fmmr005,'',0,0,'','','','','','',",
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmmqsite,fmmr015,fmmr016,fmmr017,fmmr013,fmmr014,fmmr018,fmmr019,fmmr020,",
                  #预算编号/专案编号/WBS/經營方式/渠道/品牌
                 #"       '',fmmr021,fmmr022,fmmr023,fmmr024,fmmr025,", #151112-00009#3 mark
                  "       fmmr021,fmmr022,fmmr023,fmmr024,fmmr025,",    #151112-00009#3
                  #自由核算項1~5
                  "       fmmr026,fmmr027,fmmr028,fmmr029,fmmr030,",
                  #自由核算項6~10
                  "       fmmr031,fmmr032,fmmr033,fmmr034,fmmr035,",
                  #借(本幣)/贷/计价数量/原币金额/本位幣二匯率/本位幣二/貸方金額/本位幣三匯率/借方金額/貸方金額
                  #"       fmmr004,0,0,fmmr006,fmmr007,fmmr008,0,fmmr009,fmmr010,0,", #170920-00070#1 mark
                  "       fmmr006,0,0,fmmr004,fmmr007,fmmr008,0,fmmr009,fmmr010,0,",  #170920-00070#1 add                
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                  "       fmmrseq,'fmmq','','','',fmmq002,fmmq003,'',''",
                  "  FROM fmmq_t,fmmr_t ",
                  " WHERE fmmqent = ",g_enterprise,
                  "   AND fmmq001 = '",p_ld,"'",
                  "   AND fmmqdocno = ?",
                  "   AND fmmqent = fmmrent AND fmmqdocno = fmmrdocno"
      PREPARE s_voucher_gen_fm_4_p1 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_4_p1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_4_cs1 CURSOR FOR s_voucher_gen_fm_4_p1
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_4_cs1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      
      #貸：公允價值損益科目
                   #单号/日期/借/企业/法人/帐套/摘要/科目
      LET l_sql = "SELECT fmmqdocno,fmmqdocdt,'2',fmmqent,'',fmmq001,fmmr036,fmmr012,",
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                  "       fmmr003,fmmr005,'',0,0,'','','','','','',",
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmmqsite,fmmr015,fmmr016,fmmr017,fmmr013,fmmr014,fmmr018,fmmr019,fmmr020,",
                  #预算编号/专案编号/WBS/經營方式/渠道/品牌
                 #"       '',fmmr021,fmmr022,fmmr023,fmmr024,fmmr025,", #151112-00009#3 mark
                  "       fmmr021,fmmr022,fmmr023,fmmr024,fmmr025,",    #151112-00009#3
                  #自由核算項1~5
                  "       fmmr026,fmmr027,fmmr028,fmmr029,fmmr030,",
                  #自由核算項6~10
                  "       fmmr031,fmmr032,fmmr033,fmmr034,fmmr035,",
                  #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
                 #"       0,fmmr004,0,fmmr006,fmmr007,0,fmmr008,fmmr009,0,fmmr010,", #170920-00070#1 mark
                  "       0,fmmr006,0,fmmr004,fmmr007,0,fmmr008,fmmr009,0,fmmr010,", #170920-00070#1 add                 
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                  "       fmmrseq,'fmmq','','','',fmmq002,fmmq003,'',''",
                  "  FROM fmmq_t,fmmr_t ",
                  " WHERE fmmqent = ",g_enterprise,
                  "   AND fmmq001 = '",p_ld,"'",
                  "   AND fmmqdocno = ?",
                  "   AND fmmqent = fmmrent AND fmmqdocno = fmmrdocno"
      PREPARE s_voucher_gen_fm_4_p2 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_4_p2'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_4_cs2 CURSOR FOR s_voucher_gen_fm_4_p2
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_4_cs2'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
   END IF
   #140804-00008#13 add end---
   
   ##140804-00008#20 albireo 150520-s
   IF p_source = 'afmt595' THEN
      #1.本金>>會計科目一>>貸:投資本金科目fmnf029
                   #单号/日期/借/企业/法人/帐套/摘要/科目
     #LET l_sql = "SELECT fmnedocno,fmnedocdt,'1',fmneent,fmnecomp,fmne001,fmnf032,fmnf031,", #151112-00009#3 mark
      LET l_sql = "SELECT fmnedocno,fmnedocdt,'2',fmneent,fmnecomp,fmne001,fmnf032,fmnf029,", #151112-00009#3
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                 #"       fmnf100,fmnf111,'',0,0,'','','',fmnf005,'','',",       #151112-00009#3 mark
                  "       fmnf100,fmnf111,'',0,fmnf101,'','','',fmnf005,'','',", #151112-00009#3
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmnesite,fmnf008,fmnf009,fmnf010,fmnf006,fmnf007,fmnf011,fmnf012,fmnf013,",
                  #预算编号/专案编号/WBS/經營方式/渠道/品牌
                 #"       '',fmnf014,fmnf015,fmnf016,fmnf017,fmnf018,", #151112-00009#3 mark
                  "       fmnf014,fmnf015,fmnf016,fmnf017,fmnf018,",    #151112-00009#3
                  #自由核算項1~5
                  "       fmnf019,fmnf020,fmnf021,fmnf022,fmnf023,",
                  #自由核算項6~10
                  "       fmnf024,fmnf025,fmnf026,fmnf027,fmnf028,",
                  #借(本幣)/贷/计价数量/原币金额/本位幣二匯率/本位幣二/貸方金額/本位幣三匯率/借方金額/貸方金額
                 #"       (fmnf112+fmnf113),0,0, (fmnf101+fmnf102),fmnf121,(fmnf122+fmnf123),0,fmnf131,(fmnf132+fmnf133),0,", #151112-00009#3 mark
                  "       0,fmnf112,0,fmnf101,fmnf121,0,fmnf112,fmnf131,0,fmnf132,", #151112-00009#3
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                  "       fmnfseq,'fmnf','','',fmnf003,fmne002,fmne003,'',''",       #150924-00006#8 mark #151112-00009#3 remark
                 #"       fmnfseq,'fmnf','','',fmnf003,fmne002,fmne003,'',fmnf033",  #150924-00006#8      #151112-00009#3 mark
                  "  FROM fmnf_t,fmne_t ",
                  " WHERE fmneent = ",g_enterprise,
                  "   AND fmne001 = '",p_ld,"'",
                  "   AND fmnedocno = ?",
                  "   AND fmnf003 = '1' ",
                  "   AND fmneent = fmnfent AND fmnedocno = fmnfdocno"
      PREPARE s_voucher_gen_fm_5_p1 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_p1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_5_cs1 CURSOR FOR s_voucher_gen_fm_5_p1
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_cs1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      #1.本金>>會計科目二>>貸:投資收益科目 or 借:投資損失科目 fmnf030
                   #单号/日期/借/企业/法人/帐套/摘要/科目
      LET l_sql = "SELECT fmnedocno,fmnedocdt,'2',fmneent,'',fmne001,fmnf032,fmnf030,", #150924-00006#8 mark #151112-00009#3 remark
     #LET l_sql = "SELECT fmnedocno,fmnedocdt,'2',fmneent,'',fmne001,fmnf032,'',",      #150924-00006#8      #151112-00009#3 mark
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                 #"       fmnf100,fmnf111,'',0,0,'','','','','','',",            #151112-00009#3 mark
                  "       fmnf100,fmnf035,'',0,fmnf102,'','','',fmnf005,'','',", #151112-00009#3
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmnesite,fmnf008,fmnf009,fmnf010,fmnf006,fmnf007,fmnf011,fmnf012,fmnf013,",
                  #预算编号/专案编号/WBS/經營方式/渠道/品牌
                 #"       '',fmnf014,fmnf015,fmnf016,fmnf017,fmnf018,", #151112-00009#3 mark
                  "       fmnf014,fmnf015,fmnf016,fmnf017,fmnf018,",    #151112-00009#3
                  #自由核算項1~5
                  "       fmnf019,fmnf020,fmnf021,fmnf022,fmnf023,",
                  #自由核算項6~10
                  "       fmnf024,fmnf025,fmnf026,fmnf027,fmnf028,",
                  #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
                 #"       0,fmnf113,0,fmnf102,fmnf121,0,fmnf123,fmnf131,0,fmnf133,", #151112-00009#3 mark
                  "       0,fmnf113,0,fmnf102,fmnf121,0,fmnf123,fmnf131,0,fmnf133,", #151112-00009#3
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                  "       fmnfseq,'fmnf','','',fmnf003,fmne002,fmne003,'',''",
                  "  FROM fmnf_t,fmne_t ",
                  " WHERE fmneent = ",g_enterprise,
                  "   AND fmne001 = '",p_ld,"'",
                  "   AND fmnedocno = ?",
                  "   AND fmnf003 = '1' ",
                  "   AND fmneent = fmnfent AND fmnedocno = fmnfdocno"
      PREPARE s_voucher_gen_fm_5_p2 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_p2'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_5_cs2 CURSOR FOR s_voucher_gen_fm_5_p2
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_cs2'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      #1.本金>>銀存科目>>借：銀行存款fmnf031
                   #单号/日期/借/企业/法人/帐套/摘要/科目
     #LET l_sql = "SELECT fmnedocno,fmnedocdt,'2',fmneent,'',fmne001,fmnf032,fmnf029,", #151112-00009#3 mark
      LET l_sql = "SELECT fmnedocno,fmnedocdt,'1',fmneent,'',fmne001,fmnf032,fmnf031,", #151112-00009#3
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                 #"       fmnf100,fmnf111,'',0,0,'','','','','','',",       #151112-00009#3 mark
                  "       fmnf100,fmnf038,'',0,fmnf037,'','','','','','',", #151112-00009#3
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmnesite,fmnf008,fmnf009,fmnf010,fmnf006,fmnf007,fmnf011,fmnf012,fmnf013,",
                  #预算编号/专案编号/WBS/經營方式/渠道/品牌
                 #"       '',fmnf014,fmnf015,fmnf016,fmnf017,fmnf018,", #151112-00009#3 mark
                  "       fmnf014,fmnf015,fmnf016,fmnf017,fmnf018,",    #151112-00009#3
                  #自由核算項1~5
                  "       fmnf019,fmnf020,fmnf021,fmnf022,fmnf023,",
                  #自由核算項6~10
                  "       fmnf024,fmnf025,fmnf026,fmnf027,fmnf028,",
                  #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
                 #"       0,(fmmy003*fmmj007*fmnf111),0,(fmmy003*fmmj007),fmnf121,0,0,fmnf131,0,0,", #151112-00009#3 mark
                  "       fmnf039,0,0,fmnf037,fmnf121,0,0,fmnf131,0,0,",                             #151112-00009#3
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                 #"       fmnfseq,'fmnf','','',fmnf003,fmne002,fmne003,'',''",      #151112-00009#3 mark
                  "       fmnfseq,'fmnf','','',fmnf003,fmne002,fmne003,'',fmnf033", #151112-00009#3
                 #"  FROM fmnf_t,fmne_t,fmmy_t,fmmj_t ",  #151112-00009#3 mark
                  "  FROM fmnf_t,fmne_t ",                #151112-00009#3
                  " WHERE fmneent = ",g_enterprise,
                  "   AND fmne001 = '",p_ld,"'",
                  "   AND fmnedocno = ?",
                  "   AND fmnf003 = '1' ",
                  "   AND fmneent = fmnfent AND fmnedocno = fmnfdocno"#, #151112-00009#3 mark ,
                  #151112-00009#3 mark ------
                  #"   AND fmnfent = fmmyent ",
                  #"   AND fmnf002 = fmmydocno ",
                  #"   AND fmmyent = fmmjent ",
                  #"   AND fmmy001 = fmmjdocno "
                  #151112-00009#3 mark end---
      PREPARE s_voucher_gen_fm_5_p3 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_p3'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_5_cs3 CURSOR FOR s_voucher_gen_fm_5_p3
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_cs3'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      
      #151112-00009#3 add ------
      #1.本金>>匯差科目>>正數在貸方，負數在借方
                   #单号/日期/借/企业/法人/帐套/摘要/科目
      LET l_sql = "SELECT fmnedocno,fmnedocdt,'2',fmneent,'',fmne001,fmnf032,'',",
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                  "       fmnf100,fmnf111,'',0,fmnf036,'','','',fmnf005,'','',",
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmnesite,fmnf008,fmnf009,fmnf010,fmnf006,fmnf007,fmnf011,fmnf012,fmnf013,",
                  #专案编号/WBS/經營方式/渠道/品牌
                  "       fmnf014,fmnf015,fmnf016,fmnf017,fmnf018,",
                  #自由核算項1~5
                  "       fmnf019,fmnf020,fmnf021,fmnf022,fmnf023,",
                  #自由核算項6~10
                  "       fmnf024,fmnf025,fmnf026,fmnf027,fmnf028,",
                  #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
                  "       0,fmnf036,0,fmnf036,fmnf121,0,0,fmnf131,0,0,",
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                  "       fmnfseq,'fmnf','','',fmnf003,fmne002,fmne003,'',''",
                  "  FROM fmnf_t,fmne_t ",
                  " WHERE fmneent = ",g_enterprise,
                  "   AND fmne001 = '",p_ld,"'",
                  "   AND fmnedocno = ?",
                  "   AND fmnf003 = '1' ",
                  "   AND fmneent = fmnfent AND fmnedocno = fmnfdocno"
      PREPARE s_voucher_gen_fm_5_p4 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_p4'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_5_cs4 CURSOR FOR s_voucher_gen_fm_5_p4
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_cs4'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      #151112-00009#3 add end---
      
      #151112-00009#3 mark ------
      ##貸:投資收益(或損失)
      #            #单号/日期/借/企业/法人/帐套/摘要/科目
      #LET l_sql = "SELECT docno,'','2',glaqent,'','','','',",
      #            #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
      #            "       '',0,'',0,0,'','','','','','',",
      #            #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
      #            "       '','','','','','','','','',",
      #           #预算编号/专案编号/WBS/經營方式/渠道/品牌
      #           #"       '','','','','','',", #151112-00009#3 mark
      #            "       '','','','','',",    #151112-00009#3
      #            #自由核算項1~5
      #            "       '','','','','',",
      #            #自由核算項6~10
      #            "      '','','','','',",
      #            #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
      #            "       0,0,0,0,0,0,0,0,0,0,",
      #            #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
      #            "       seq,'fmnf','','','1',0,0,'','' ",
      #            "   FROM s_voucher_fm_tmp  ", 
      #            " WHERE state = '1' ",
      #            "  GROUP BY docno,glaqent,seq"
      #PREPARE s_voucher_gen_fm_5_p4 FROM l_sql
      #IF SQLCA.sqlcode THEN
      #   INITIALIZE g_errparam TO NULL
      #   LET g_errparam.code = SQLCA.sqlcode
      #   LET g_errparam.extend = 's_voucher_gen_fm_5_p4'
      #   LET g_errparam.popup = TRUE
      #   CALL cl_err()
      #   RETURN r_success
      #END IF
      #DECLARE s_voucher_gen_fm_5_cs4 CURSOR FOR s_voucher_gen_fm_5_p4
      #IF SQLCA.sqlcode THEN
      #   INITIALIZE g_errparam TO NULL
      #   LET g_errparam.code = SQLCA.sqlcode
      #   LET g_errparam.extend = 's_voucher_gen_fm_5_cs4'
      #   LET g_errparam.popup = TRUE
      #   CALL cl_err()
      #   RETURN r_success
      #END IF
      ##貸:投資收益(或損失)用 抓第一筆資料出來
      #LET l_sql = " SELECT * FROM s_voucher_fm_tmp ",
      #            "  WHERE docno = ? AND glaqent = ? AND seq = ? "
      #PREPARE s_voucher_gen_fm_5_p5 FROM l_sql
      #IF SQLCA.sqlcode THEN
      #   INITIALIZE g_errparam TO NULL
      #   LET g_errparam.code = SQLCA.sqlcode
      #   LET g_errparam.extend = 's_voucher_gen_fm_5_p5'
      #   LET g_errparam.popup = TRUE
      #   CALL cl_err()
      #   RETURN r_success
      #END IF
      #DECLARE s_voucher_gen_fm_5_cs5 CURSOR FOR s_voucher_gen_fm_5_p5
      #IF SQLCA.sqlcode THEN
      #   INITIALIZE g_errparam TO NULL
      #   LET g_errparam.code = SQLCA.sqlcode
      #   LET g_errparam.extend = 's_voucher_gen_fm_5_cs5'
      #   LET g_errparam.popup = TRUE
      #   CALL cl_err()
      #   RETURN r_success
      #END IF
      #151112-00009#3 mark end---
      
      ##################
      
      #2.費用>>會計科目一>>借：#費用科目
                   #单号/日期/借/企业/法人/帐套/摘要/科目
     #LET l_sql = "SELECT fmnedocno,fmnedocdt,'1',fmneent,fmnecomp,fmne001,fmnf032,fmnf030,", #151112-00009#3 mark
      LET l_sql = "SELECT fmnedocno,fmnedocdt,'1',fmneent,fmnecomp,fmne001,fmnf032,fmnf029,", #151112-00009#3
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                 #"       fmnf100,fmnf111,'',0,0,'','','',fmnf005,'','',",       #151112-00009#3 mark
                  "       fmnf100,fmnf111,'',0,fmnf101,'','','',fmnf005,'','',", #151112-00009#3
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmnesite,fmnf008,fmnf009,fmnf010,fmnf006,fmnf007,fmnf011,fmnf012,fmnf013,",
                  #预算编号/专案编号/WBS/經營方式/渠道/品牌
                 #"       '',fmnf014,fmnf015,fmnf016,fmnf017,fmnf018,", #151112-00009#3 mark
                  "       fmnf014,fmnf015,fmnf016,fmnf017,fmnf018,",    #151112-00009#3
                  #自由核算項1~5
                  "       fmnf019,fmnf020,fmnf021,fmnf022,fmnf023,",
                  #自由核算項6~10
                  "       fmnf024,fmnf025,fmnf026,fmnf027,fmnf028,",
                  #借(本幣)/贷/计价数量/原币金额/本位幣二匯率/本位幣二/貸方金額/本位幣三匯率/借方金額/貸方金額
                 #"       fmnf113,0,0,fmnf102,fmnf121,fmnf123,0,fmnf131,fmnf133,0,", #151112-00009#3 mark
                  "       fmnf112,0,0,fmnf101,fmnf121,fmnf122,0,fmnf131,fmnf132,0,", #151112-00009#3
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                  "       fmnfseq,'fmnf','','',fmnf003,fmne002,fmne003,'',''",
                  "  FROM fmnf_t,fmne_t ",
                  " WHERE fmneent = ",g_enterprise,
                  "   AND fmne001 = '",p_ld,"'",
                  "   AND fmnedocno = ?",
                  "   AND fmnf003 = '2' ",
                  "   AND fmneent = fmnfent AND fmnedocno = fmnfdocno"
      PREPARE s_voucher_gen_fm_5_p6 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_p1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_5_cs6 CURSOR FOR s_voucher_gen_fm_5_p6
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_cs6'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      #2.費用>>銀存科目>>貸：費用對象科目
                   #单号/日期/借/企业/法人/帐套/摘要/科目
      LET l_sql = "SELECT fmnedocno,fmnedocdt,'2',fmneent,'',fmne001,fmnf032,fmnf031,",
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                 #"       fmnf100,fmnf111,'',0,0,'','','','','','',",       #151112-00009#3 mark
                  "       fmnf100,fmnf038,'',0,fmnf037,'','','','','','',", #151112-00009#3
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmnesite,fmnf008,fmnf009,fmnf010,fmnf006,fmnf007,fmnf011,fmnf012,fmnf013,",
                  #预算编号/专案编号/WBS/經營方式/渠道/品牌
                 #"       '',fmnf014,fmnf015,fmnf016,fmnf017,fmnf018,", #151112-00009#3 mark
                  "       fmnf014,fmnf015,fmnf016,fmnf017,fmnf018,",    #151112-00009#3
                  #自由核算項1~5
                  "       fmnf019,fmnf020,fmnf021,fmnf022,fmnf023,",
                  #自由核算項6~10
                  "       fmnf024,fmnf025,fmnf026,fmnf027,fmnf028,",
                  #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
                 #"       0,fmnf113,0,fmnf102,fmnf121,0,fmnf123,fmnf131,0,fmnf133,", #151112-00009#3 mark
                  "       0,fmnf039,0,fmnf037,fmnf121,0,0,fmnf131,0,0,",             #151112-00009#3
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                 #"       fmnfseq,'fmnf','','',fmnf003,fmne002,fmne003,'',''",      #150924-00006#8 mark
                  "       fmnfseq,'fmnf','','',fmnf003,fmne002,fmne003,'',fmnf033", #150924-00006#8
                  "  FROM fmnf_t,fmne_t ",
                  " WHERE fmneent = ",g_enterprise,
                  "   AND fmne001 = '",p_ld,"'",
                  "   AND fmnedocno = ?",
                  "   AND fmnf003 = '2' ",
                  "   AND fmneent = fmnfent AND fmnedocno = fmnfdocno"
      PREPARE s_voucher_gen_fm_5_p7 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_p7'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_5_cs7 CURSOR FOR s_voucher_gen_fm_5_p7
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_cs7'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      ##################
      #151112-00009#3 mark ------
      ##150924-00006#8 add ------
      ##貸：購買單費用
      #LET l_sql = " SELECT fmmk003,fmmk005",
      #            "   FROM fmmk_t",
      #            "  WHERE fmmkent = ",g_enterprise,
      #            "    AND fmmk001 = ?"
      #PREPARE s_voucher_gen_fm_5_p8 FROM l_sql
      #IF SQLCA.sqlcode THEN
      #   INITIALIZE g_errparam TO NULL
      #   LET g_errparam.code = SQLCA.sqlcode
      #   LET g_errparam.extend = 's_voucher_gen_fm_5_p8'
      #   LET g_errparam.popup = TRUE
      #   CALL cl_err()
      #   RETURN r_success
      #END IF
      #DECLARE s_voucher_gen_fm_5_cs8 CURSOR FOR s_voucher_gen_fm_5_p8
      #IF SQLCA.sqlcode THEN
      #   INITIALIZE g_errparam TO NULL
      #   LET g_errparam.code = SQLCA.sqlcode
      #   LET g_errparam.extend = 's_voucher_gen_fm_5_cs8'
      #   LET g_errparam.popup = TRUE
      #   CALL cl_err()
      #   RETURN r_success
      #END IF
      ##150924-00006#8 add end--
      #151112-00009#3 mark end---
      
      ##################
      
      #151112-00009#3 add ------
      #3.利息收入>>會計科目一>>貸:投資本金科目fmnf029
                   #单号/日期/借/企业/法人/帐套/摘要/科目
      LET l_sql = "SELECT fmnedocno,fmnedocdt,'2',fmneent,fmnecomp,fmne001,fmnf032,fmnf029,",
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                  "       fmnf100,fmnf111,'',0,fmnf101,'','','',fmnf005,'','',",
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmnesite,fmnf008,fmnf009,fmnf010,fmnf006,fmnf007,fmnf011,fmnf012,fmnf013,",
                  #专案编号/WBS/經營方式/渠道/品牌
                  "       fmnf014,fmnf015,fmnf016,fmnf017,fmnf018,",
                  #自由核算項1~5
                  "       fmnf019,fmnf020,fmnf021,fmnf022,fmnf023,",
                  #自由核算項6~10
                  "       fmnf024,fmnf025,fmnf026,fmnf027,fmnf028,",
                  #借(本幣)/贷/计价数量/原币金额/本位幣二匯率/本位幣二/貸方金額/本位幣三匯率/借方金額/貸方金額
                  "       0,fmnf112,0,fmnf101,fmnf121,0,fmnf112,fmnf131,0,fmnf132,",
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                  "       fmnfseq,'fmnf','','',fmnf003,fmne002,fmne003,'',''",
                  "  FROM fmnf_t,fmne_t ",
                  " WHERE fmneent = ",g_enterprise,
                  "   AND fmne001 = '",p_ld,"'",
                  "   AND fmnedocno = ?",
                  "   AND fmnf003 = '3' ",
                  "   AND fmneent = fmnfent AND fmnedocno = fmnfdocno"
      PREPARE s_voucher_gen_fm_5_p9 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_p9'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_5_cs9 CURSOR FOR s_voucher_gen_fm_5_p9
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_cs9'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      #3.利息收入>>會計科目二>>貸:投資收益科目 or 借:投資損失科目 fmnf030
                   #单号/日期/借/企业/法人/帐套/摘要/科目
      LET l_sql = "SELECT fmnedocno,fmnedocdt,'2',fmneent,'',fmne001,fmnf032,fmnf030,",
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                  "       fmnf100,fmnf035,'',0,fmnf102,'','','',fmnf005,'','',",
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmnesite,fmnf008,fmnf009,fmnf010,fmnf006,fmnf007,fmnf011,fmnf012,fmnf013,",
                  #专案编号/WBS/經營方式/渠道/品牌
                  "       fmnf014,fmnf015,fmnf016,fmnf017,fmnf018,",
                  #自由核算項1~5
                  "       fmnf019,fmnf020,fmnf021,fmnf022,fmnf023,",
                  #自由核算項6~10
                  "       fmnf024,fmnf025,fmnf026,fmnf027,fmnf028,",
                  #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
                  "       0,fmnf113,0,fmnf102,fmnf121,0,fmnf123,fmnf131,0,fmnf133,",
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                  "       fmnfseq,'fmnf','','',fmnf003,fmne002,fmne003,'',''",
                  "  FROM fmnf_t,fmne_t ",
                  " WHERE fmneent = ",g_enterprise,
                  "   AND fmne001 = '",p_ld,"'",
                  "   AND fmnedocno = ?",
                  "   AND fmnf003 = '3' ",
                  "   AND fmneent = fmnfent AND fmnedocno = fmnfdocno"
      PREPARE s_voucher_gen_fm_5_p10 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_p10'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_5_cs10 CURSOR FOR s_voucher_gen_fm_5_p10
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_cs10'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      #3.利息收入>>銀存科目>>借：銀行存款fmnf031
                   #单号/日期/借/企业/法人/帐套/摘要/科目
      LET l_sql = "SELECT fmnedocno,fmnedocdt,'1',fmneent,'',fmne001,fmnf032,fmnf031,",
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                  "       fmnf100,fmnf038,'',0,fmnf037,'','','','','','',",
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmnesite,fmnf008,fmnf009,fmnf010,fmnf006,fmnf007,fmnf011,fmnf012,fmnf013,",
                  #专案编号/WBS/經營方式/渠道/品牌
                  "       fmnf014,fmnf015,fmnf016,fmnf017,fmnf018,",
                  #自由核算項1~5
                  "       fmnf019,fmnf020,fmnf021,fmnf022,fmnf023,",
                  #自由核算項6~10
                  "       fmnf024,fmnf025,fmnf026,fmnf027,fmnf028,",
                  #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
                  "       fmnf039,0,0,fmnf037,fmnf121,0,0,fmnf131,0,0,",
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                  "       fmnfseq,'fmnf','','',fmnf003,fmne002,fmne003,'',fmnf033",
                  "  FROM fmnf_t,fmne_t ",
                  " WHERE fmneent = ",g_enterprise,
                  "   AND fmne001 = '",p_ld,"'",
                  "   AND fmnedocno = ?",
                  "   AND fmnf003 = '3' ",
                  "   AND fmneent = fmnfent AND fmnedocno = fmnfdocno"
      PREPARE s_voucher_gen_fm_5_p11 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_p11'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_5_cs11 CURSOR FOR s_voucher_gen_fm_5_p11
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_cs11'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      #3.利息收入>>匯差科目>>正數是貸方，負數在借方
                   #单号/日期/借/企业/法人/帐套/摘要/科目
      LET l_sql = "SELECT fmnedocno,fmnedocdt,'2',fmneent,'',fmne001,fmnf032,'',",
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                  "       fmnf100,fmnf111,'',0,fmnf036,'','','',fmnf005,'','',",
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmnesite,fmnf008,fmnf009,fmnf010,fmnf006,fmnf007,fmnf011,fmnf012,fmnf013,",
                  #专案编号/WBS/經營方式/渠道/品牌
                  "       fmnf014,fmnf015,fmnf016,fmnf017,fmnf018,",
                  #自由核算項1~5
                  "       fmnf019,fmnf020,fmnf021,fmnf022,fmnf023,",
                  #自由核算項6~10
                  "       fmnf024,fmnf025,fmnf026,fmnf027,fmnf028,",
                  #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
                  "       0,fmnf036,0,fmnf036,fmnf121,0,0,fmnf131,0,0,",
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                  "       fmnfseq,'fmnf','','',fmnf003,fmne002,fmne003,'',''",
                  "  FROM fmnf_t,fmne_t ",
                  " WHERE fmneent = ",g_enterprise,
                  "   AND fmne001 = '",p_ld,"'",
                  "   AND fmnedocno = ?",
                  "   AND fmnf003 = '3' ",
                  "   AND fmneent = fmnfent AND fmnedocno = fmnfdocno"
      PREPARE s_voucher_gen_fm_5_p12 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_p12'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_5_cs12 CURSOR FOR s_voucher_gen_fm_5_p12
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_cs12'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      
      ##################
      
      #4.已宣告未領取利息>>會計科目一>>貸:投資本金科目fmnf029
                   #单号/日期/借/企业/法人/帐套/摘要/科目
      LET l_sql = "SELECT fmnedocno,fmnedocdt,'2',fmneent,fmnecomp,fmne001,fmnf032,fmnf029,",
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                  "       fmnf100,fmnf111,'',0,fmnf101,'','','',fmnf005,'','',",
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmnesite,fmnf008,fmnf009,fmnf010,fmnf006,fmnf007,fmnf011,fmnf012,fmnf013,",
                  #专案编号/WBS/經營方式/渠道/品牌
                  "       fmnf014,fmnf015,fmnf016,fmnf017,fmnf018,",
                  #自由核算項1~5
                  "       fmnf019,fmnf020,fmnf021,fmnf022,fmnf023,",
                  #自由核算項6~10
                  "       fmnf024,fmnf025,fmnf026,fmnf027,fmnf028,",
                  #借(本幣)/贷/计价数量/原币金额/本位幣二匯率/本位幣二/貸方金額/本位幣三匯率/借方金額/貸方金額
                  "       0,fmnf112,0,fmnf101,fmnf121,0,fmnf112,fmnf131,0,fmnf132,",
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                  "       fmnfseq,'fmnf','','',fmnf003,fmne002,fmne003,'',''",
                  "  FROM fmnf_t,fmne_t ",
                  " WHERE fmneent = ",g_enterprise,
                  "   AND fmne001 = '",p_ld,"'",
                  "   AND fmnedocno = ?",
                  "   AND fmnf003 = '4' ",
                  "   AND fmneent = fmnfent AND fmnedocno = fmnfdocno"
      PREPARE s_voucher_gen_fm_5_p13 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_p13'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_5_cs13 CURSOR FOR s_voucher_gen_fm_5_p13
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_cs13'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      #4.已宣告未領取利息>>銀存科目>>借：銀行存款fmnf031
                   #单号/日期/借/企业/法人/帐套/摘要/科目
      LET l_sql = "SELECT fmnedocno,fmnedocdt,'1',fmneent,'',fmne001,fmnf032,fmnf031,",
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                  "       fmnf100,fmnf038,'',0,fmnf037,'','','','','','',",
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmnesite,fmnf008,fmnf009,fmnf010,fmnf006,fmnf007,fmnf011,fmnf012,fmnf013,",
                  #专案编号/WBS/經營方式/渠道/品牌
                  "       fmnf014,fmnf015,fmnf016,fmnf017,fmnf018,",
                  #自由核算項1~5
                  "       fmnf019,fmnf020,fmnf021,fmnf022,fmnf023,",
                  #自由核算項6~10
                  "       fmnf024,fmnf025,fmnf026,fmnf027,fmnf028,",
                  #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
                  "       fmnf039,0,0,fmnf037,fmnf121,0,0,fmnf131,0,0,",
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                  "       fmnfseq,'fmnf','','',fmnf003,fmne002,fmne003,'',fmnf033",
                  "  FROM fmnf_t,fmne_t ",
                  " WHERE fmneent = ",g_enterprise,
                  "   AND fmne001 = '",p_ld,"'",
                  "   AND fmnedocno = ?",
                  "   AND fmnf003 = '4' ",
                  "   AND fmneent = fmnfent AND fmnedocno = fmnfdocno"
      PREPARE s_voucher_gen_fm_5_p14 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_p14'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_5_cs14 CURSOR FOR s_voucher_gen_fm_5_p14
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_cs14'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      
      ##################
      
      #5.已宣告未領取股利>>會計科目一>>貸:投資本金科目fmnf029
                   #单号/日期/借/企业/法人/帐套/摘要/科目
      LET l_sql = "SELECT fmnedocno,fmnedocdt,'2',fmneent,fmnecomp,fmne001,fmnf032,fmnf029,",
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                  "       fmnf100,fmnf111,'',0,fmnf101,'','','',fmnf005,'','',",
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmnesite,fmnf008,fmnf009,fmnf010,fmnf006,fmnf007,fmnf011,fmnf012,fmnf013,",
                  #专案编号/WBS/經營方式/渠道/品牌
                  "       fmnf014,fmnf015,fmnf016,fmnf017,fmnf018,",
                  #自由核算項1~5
                  "       fmnf019,fmnf020,fmnf021,fmnf022,fmnf023,",
                  #自由核算項6~10
                  "       fmnf024,fmnf025,fmnf026,fmnf027,fmnf028,",
                  #借(本幣)/贷/计价数量/原币金额/本位幣二匯率/本位幣二/貸方金額/本位幣三匯率/借方金額/貸方金額
                  "       0,fmnf112,0,fmnf101,fmnf121,0,fmnf112,fmnf131,0,fmnf132,",
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                  "       fmnfseq,'fmnf','','',fmnf003,fmne002,fmne003,'',''",
                  "  FROM fmnf_t,fmne_t ",
                  " WHERE fmneent = ",g_enterprise,
                  "   AND fmne001 = '",p_ld,"'",
                  "   AND fmnedocno = ?",
                  "   AND fmnf003 = '5' ",
                  "   AND fmneent = fmnfent AND fmnedocno = fmnfdocno"
      PREPARE s_voucher_gen_fm_5_p15 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_p15'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_5_cs15 CURSOR FOR s_voucher_gen_fm_5_p15
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_cs15'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      #5.已宣告未領取股利>>銀存科目>>借：銀行存款fmnf031
                   #单号/日期/借/企业/法人/帐套/摘要/科目
      LET l_sql = "SELECT fmnedocno,fmnedocdt,'1',fmneent,'',fmne001,fmnf032,fmnf031,",
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                  "       fmnf100,fmnf038,'',0,fmnf037,'','','','','','',",
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmnesite,fmnf008,fmnf009,fmnf010,fmnf006,fmnf007,fmnf011,fmnf012,fmnf013,",
                  #专案编号/WBS/經營方式/渠道/品牌
                  "       fmnf014,fmnf015,fmnf016,fmnf017,fmnf018,",
                  #自由核算項1~5
                  "       fmnf019,fmnf020,fmnf021,fmnf022,fmnf023,",
                  #自由核算項6~10
                  "       fmnf024,fmnf025,fmnf026,fmnf027,fmnf028,",
                  #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
                  "       fmnf039,0,0,fmnf037,fmnf121,0,0,fmnf131,0,0,",
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                  "       fmnfseq,'fmnf','','',fmnf003,fmne002,fmne003,'',fmnf033",
                  "  FROM fmnf_t,fmne_t ",
                  " WHERE fmneent = ",g_enterprise,
                  "   AND fmne001 = '",p_ld,"'",
                  "   AND fmnedocno = ?",
                  "   AND fmnf003 = '5' ",
                  "   AND fmneent = fmnfent AND fmnedocno = fmnfdocno"
      PREPARE s_voucher_gen_fm_5_p16 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_p16'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_5_cs16 CURSOR FOR s_voucher_gen_fm_5_p16
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_5_cs16'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      #151112-00009#3 add end---
   END IF
   ##140804-00008#20 albireo 150520-e

  
   #140804-00008#18 hans 150525 -s
    IF p_source = 'afmt585' THEN
      #借： #對方科目
                   #单号/日期/借/企业/法人/帐套/摘要/科目
     #LET l_sql = "SELECT fmmwdocno,fmmwdocdt,'1',fmmwent,fmmwcomp,fmmw001,fmmx133,fmmx030,", #150924-00006#8 mark
      LET l_sql = "SELECT fmmwdocno,fmmwdocdt,'1',fmmwent,fmmwcomp,fmmw001,fmmx133,fmmx030,", #150924-00006#8
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                 #"       fmmx100,fmmx111,'',0,0,'','','',fmmx005,'','',",       #151013-00019#7 mark
                 #"       fmmx100,fmmx111,'',0,fmmx101,'','','',fmmx005,'','',", #151013-00019#7
                  "       fmmx100,fmmx103,'',0,fmmx102,'','','',fmmx005,'','',", #151117-00001#7
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmmwsite,fmmx008,fmmx009,fmmx010,fmmx006,fmmx007,fmmx011,fmmx012,fmmx013,",
                  #预算编号/专案编号/WBS/經營方式/渠道/品牌
                 #"       '',fmmx014,fmmx015,fmmx016,fmmx017,fmmx018,", #151112-00009#3 mark
                  "       fmmx014,fmmx015,fmmx016,fmmx017,fmmx018,",    #151112-00009#3
                  #自由核算項1~5
                  "       fmmx019,fmmx020,fmmx021,fmmx022,fmmx023,",
                  #自由核算項6~10
                  "       fmmx024,fmmx025,fmmx026,fmmx027,fmmx028,",
                  #借(本幣)/贷/计价数量/原币金额/本位幣二匯率/本位幣二/貸方金額/本位幣三匯率/借方金額/貸方金額
                  #"       fmmx112,0,0, fmmx101,fmmx121,fmmx122,0,fmmx131,fmmx132,0,",
                  "        fmmx104,0,0,fmmx102,fmmx121,0,fmmx122,fmmx131,0,fmmx132, ",     #151117-00001#7
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼/費用科目
                 #"       fmmxseq,'fmmx','','',fmmx003,fmmw002,fmmw003,'',''",         #150924-00006#8 mark
                  "       fmmxseq,'fmmx','','',fmmx003,fmmw002,fmmw003,'',fmmx031,fmmx029", #150924-00006#8
                  "  FROM fmmw_t,fmmx_t ",
                  " WHERE fmmwent = ",g_enterprise,
                  "   AND fmmw001 = '",p_ld,"'",
                  "   AND fmmwdocno = ?",     
                  "   AND fmmwent = fmmxent AND fmmwdocno = fmmxdocno"
      PREPARE s_voucher_gen_fm_6_p1 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_6_p1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_6_cs1 CURSOR FOR s_voucher_gen_fm_6_p1
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_6_cs1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      
      #貸：收入科目
                   #单号/日期/借/企业/法人/帐套/摘要/科目
     #LET l_sql = "SELECT fmmwdocno,fmmwdocdt,'2',fmmwent,fmmwcomp,fmmw001,fmmx133,fmmx029,", #150924-00006#8 mark
      LET l_sql = "SELECT fmmwdocno,fmmwdocdt,'2',fmmwent,fmmwcomp,fmmw001,fmmx133,fmmx033,", #150924-00006#8
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                 #"       fmmx100,fmmx111,'',0,0,'','','',fmmx005,'','',",       #151013-00019#7 mark
                  "      fmmx100,fmmx111,'',0,fmmx101,'','','',fmmx005,'','',", #151013-00019#7
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmmwsite,fmmx008,fmmx009,fmmx010,fmmx006,fmmx007,fmmx011,fmmx012,fmmx013,",
                  #预算编号/专案编号/WBS/經營方式/渠道/品牌
                 #"       '',fmmx014,fmmx015,fmmx016,fmmx017,fmmx018,", #151112-00009#3 mark
                  "       fmmx014,fmmx015,fmmx016,fmmx017,fmmx018,",    #151112-00009#3
                  #自由核算項1~5
                  "       fmmx019,fmmx020,fmmx021,fmmx022,fmmx023,",
                  #自由核算項6~10
                  "       fmmx024,fmmx025,fmmx026,fmmx027,fmmx028,",
                  #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
                  "       0,fmmx112,0,fmmx101,fmmx121,0,fmmx122,fmmx131,0,fmmx132,",
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼/費用科目
                 #"       fmmxseq,'fmmx','','',fmmx003,fmmw002,fmmw003,'',''",              #150924-00006#8 mark
                  "       fmmxseq,'fmmx','','',fmmx003,fmmw002,fmmw003,'',fmmx031,fmmx004", #150924-00006#8
                  "  FROM fmmw_t,fmmx_t ",
                  " WHERE fmmwent = ",g_enterprise,
                  "   AND fmmw001 = '",p_ld,"'",
                  "   AND fmmwdocno = ?",
                  "   AND fmmwent = fmmxent AND fmmwdocno = fmmxdocno"
      PREPARE s_voucher_gen_fm_6_p2 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_6_p2'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_6_cs2 CURSOR FOR s_voucher_gen_fm_6_p2
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_6_cs2'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
   END IF
   #140804-00008#18 hans 150525 -e
   
   #140804-00008#15 add ------
   IF p_source = 'afmt565' THEN
      #借：應收股利/利息科目
                   #单号/日期/借/企业/法人/帐套/摘要/科目
      LET l_sql = "SELECT fmmudocno,fmmudocdt,'1',fmmuent,'',fmmu001,fmng046,fmng020,",
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                 #"       fmng003,fmng008,'',0,0,'','',fmmu004,'','','',",       #151013-00019#7 mark
                  "       fmng003,fmng008,'',0,fmng005,'','',fmmu004,'','','',", #151013-00019#7
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmmusite,fmng025,fmng026,fmng027,fmng023,fmng024,fmng028,fmng029,fmng030,",
                  #预算编号/专案编号/WBS/經營方式/渠道/品牌
                 #"       '',fmng031,fmng032,fmng033,fmng034,fmng035,", #151112-00009#3 mark
                  "       fmng031,fmng032,fmng033,fmng034,fmng035,",    #151112-00009#3
                  #自由核算項1~5
                  "       fmng036,fmng037,fmng038,fmng039,fmng040,",
                  #自由核算項6~10
                  "       fmng041,fmng042,fmng043,fmng044,fmng045,",
                  #借(本幣)/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
                  "       fmng009,0,0,fmng005,fmng012,fmng013,0,fmng016,fmng017,0,",
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                  "       fmngseq,'fmmu','','','',fmmu002,fmmu003,'',''",
                  "  FROM fmmu_t,fmng_t ",
                  " WHERE fmmuent = ",g_enterprise,
                  "   AND fmmu001 = '",p_ld,"'",
                  "   AND fmmudocno = ?",
                  "   AND fmmuent = fmngent AND fmmudocno = fmngdocno"
      PREPARE s_voucher_gen_fm_7_p1 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_7_p1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_7_cs1 CURSOR FOR s_voucher_gen_fm_7_p1
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_7_cs1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      
      #貸：投資收益科目
                   #单号/日期/借/企业/法人/帐套/摘要/科目
      LET l_sql = "SELECT fmmudocno,fmmudocdt,'2',fmmuent,'',fmmu001,fmng046,fmng022,",
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                 #"       fmng003,fmng008,'',0,0,'','',fmmu004,'','','',",       #151013-00019#7 mark
                  "       fmng003,fmng008,'',0,fmng007,'','',fmmu004,'','','',", #151013-00019#7
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmmusite,fmng025,fmng026,fmng027,fmng023,fmng024,fmng028,fmng029,fmng030,",
                  #预算编号/专案编号/WBS/經營方式/渠道/品牌
                 #"       '',fmng031,fmng032,fmng033,fmng034,fmng035,", #151112-00009#3 mark
                  "       fmng031,fmng032,fmng033,fmng034,fmng035,",    #151112-00009#3
                  #自由核算項1~5
                  "       fmng036,fmng037,fmng038,fmng039,fmng040,",
                  #自由核算項6~10
                  "       fmng041,fmng042,fmng043,fmng044,fmng045,",
                  #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
                  "       0,fmng011,0,fmng007,fmng012,0,fmng015,fmng016,0,fmng019,",
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                  "       fmngseq,'fmmu','','','',fmmu002,fmmu003,'',''",
                  "  FROM fmmu_t,fmng_t ",
                  " WHERE fmmuent = ",g_enterprise,
                  "   AND fmmu001 = '",p_ld,"'",
                  "   AND fmmudocno = ?",
                  "   AND fmmuent = fmngent AND fmmudocno = fmngdocno"
      PREPARE s_voucher_gen_fm_7_p2 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_7_p2'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_7_cs2 CURSOR FOR s_voucher_gen_fm_7_p2
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_7_cs2'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      
      #利息調整科目
                   #单号/日期/借/企业/法人/帐套/摘要/科目
      LET l_sql = "SELECT fmmudocno,fmmudocdt,'1',fmmuent,'',fmmu001,fmng046,fmng021,",
                  #币别/汇率/计价单位/单价/原幣金額/票据编号/票据日期/申请人/银行帐号/结算方式/收支项目
                 #"       fmng003,fmng008,'',0,0,'','',fmmu004,'','','',",       #151013-00019#7 mark
                  "       fmng003,fmng008,'',0,fmng006,'','',fmmu004,'','','',", #151013-00019#7
                  #营运据点/部门/利润中心/区域/交易客户/帐款客户/客群/产品类别/人员
                  "       fmmusite,fmng025,fmng026,fmng027,fmng023,fmng024,fmng028,fmng029,fmng030,",
                  #预算编号/专案编号/WBS/經營方式/渠道/品牌
                 #"       '',fmng031,fmng032,fmng033,fmng034,fmng035,", #151112-00009#3 mark
                  "       fmng031,fmng032,fmng033,fmng034,fmng035,",    #151112-00009#3
                  #自由核算項1~5
                  "       fmng036,fmng037,fmng038,fmng039,fmng040,",
                  #自由核算項6~10
                  "       fmng041,fmng042,fmng043,fmng044,fmng045,",
                  #借/贷/计价数量/原币金额/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
                  "       fmng010,0,0,fmng006,fmng012,fmng014,0,fmng016,fmng018,0,",
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                  "       fmngseq,'fmmu','','','',fmmu002,fmmu003,'',''",
                  "  FROM fmmu_t,fmng_t ",
                  " WHERE fmmuent = ",g_enterprise,
                  "   AND fmmu001 = '",p_ld,"'",
                  "   AND fmmudocno = ?",
                  "   AND fmmuent = fmngent AND fmmudocno = fmngdocno"
      PREPARE s_voucher_gen_fm_7_p3 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_7_p3'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_7_cs3 CURSOR FOR s_voucher_gen_fm_7_p3
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_7_cs3'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
   END IF
   #140804-00008#15 add end---
   
   #140804-00008#9 add ------
   IF p_source = 'afmt535' THEN
      #借：投資類型科目
                   #單號/日期/借/企業/法人/帳套/摘要/科目
      LET l_sql = "SELECT fmmldocno,fmmldocdt,'1',fmmlent,fmml004,fmml003,fmmm043,fmmm006,",
                  #幣別/匯率/計價單位/單價/原幣金額/票據編號/票據日期/申請人/銀行帳號/結算方式/收支專案
                  "       fmmm007,fmmm009,'',0,0,'','',fmml007,'','','',",
                  #營運據點/部門/利潤中心/區域/交易客戶/帳款客戶/客群/產品類別/人員
                  "       fmml001,fmmm022,fmmm023,fmmm024,fmmm020,fmmm021,fmmm025,fmmm026,fmmm027,",
                  #預算編號/專案編號/WBS/經營方式/管道/品牌
                 #"       '',fmmm028,fmmm029,fmmm030,fmmm031,fmmm032,",  #151112-00009#3 mark
                  "       fmmm028,fmmm029,fmmm030,fmmm031,fmmm032,",     #151112-00009#3
                  #自由核算項1~5
                  "       fmmm033,fmmm034,fmmm035,fmmm036,fmmm037,",
                  #自由核算項6~10
                  "       fmmm038,fmmm039,fmmm040,fmmm041,fmmm042,",
                  #借(本幣)/貸/計價數量/原幣金額/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
                  "       fmmm010,0,0,fmmm008,fmmm013,fmmm014,0,fmmm015,fmmm016,0,",
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                  "       fmmmseq,'fmml','','','',fmml005,fmml006,'','',",
                  #額外資料:投資單號/來源/費用類型
                  "       fmmm003,fmmm004,fmmm005 ",
                  "  FROM fmml_t,fmmm_t ",
                  " WHERE fmmlent = ",g_enterprise,
                  "   AND fmml003 = '",p_ld,"'",
                  "   AND fmmldocno = ?",
                  "   AND fmmlent = fmmment AND fmmldocno = fmmm001"
      PREPARE s_voucher_gen_fm_8_p1 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_8_p1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_8_cs1 CURSOR FOR s_voucher_gen_fm_8_p1
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_8_cs1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      
      #貸：支付方式科目
                   #單號/日期/借/企業/法人/帳套/摘要/科目
     #LET l_sql = "SELECT fmmldocno,fmmldocdt,'2',fmmlent,fmml004,fmml003,fmmm043,'',",      #150924-00006#8 mark
      #貸：對方科目
      LET l_sql = "SELECT fmmldocno,fmmldocdt,'2',fmmlent,fmml004,fmml003,fmmm043,fmmm046,", #150924-00006#8
                  #幣別/匯率/計價單位/單價/原幣金額/票據編號/票據日期/申請人/銀行帳號/結算方式/收支專案
                  "       fmmm007,fmmm009,'',0,0,'','',fmml007,'','','',",
                  #營運據點/部門/利潤中心/區域/交易客戶/帳款客戶/客群/產品類別/人員
                  "       fmml001,fmmm022,fmmm023,fmmm024,fmmm020,fmmm021,fmmm025,fmmm026,fmmm027,",
                  #預算編號/專案編號/WBS/經營方式/管道/品牌
                 #"       '',fmmm028,fmmm029,fmmm030,fmmm031,fmmm032,", #151112-00009#3 mark
                  "       fmmm028,fmmm029,fmmm030,fmmm031,fmmm032,",    #151112-00009#3
                  #自由核算項1~5
                  "       fmmm033,fmmm034,fmmm035,fmmm036,fmmm037,",
                  #自由核算項6~10
                  "       fmmm038,fmmm039,fmmm040,fmmm041,fmmm042,",
                  #借/貸/計價數量/原幣金額/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
                  "       0,fmmm010,0,fmmm008,fmmm013,0,fmmm014,fmmm015,0,fmmm016,",
                  #項次一/來源/--/項次二/單據性質/年度/期別/會計檢核附件份數/現金變動碼
                 #"       fmmmseq,'fmml','','','',fmml005,fmml006,'','',",       #150924-00006#8 mark
                  "       fmmmseq,'fmml','','','',fmml005,fmml006,'',fmmm045,",  #150924-00006#8
                  #額外資料:投資單號/來源/費用類型
                  "       fmmm003,fmmm004,fmmm005 ",                  
                  "  FROM fmml_t,fmmm_t ",
                  " WHERE fmmlent = ",g_enterprise,
                  "   AND fmml003 = '",p_ld,"'",
                  "   AND fmmldocno = ?",
                  "   AND fmmlent = fmmment AND fmmldocno = fmmm001"
      PREPARE s_voucher_gen_fm_8_p2 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_8_p2'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_8_cs2 CURSOR FOR s_voucher_gen_fm_8_p2
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_8_cs2'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF      
   END IF
   
   #140804-00008#9 add end---
   
   
   
   #从临时表中取科目
   LET l_sql = " SELECT DISTINCT docno,glaq002 FROM s_vr_tmp08 ",  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               "  ORDER BY docno"
   PREPARE s_voucher_gen_fm_1_p2 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_fm_1_p2'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   DECLARE s_voucher_gen_fm_1_cs2 CURSOR FOR s_voucher_gen_fm_1_p2
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_fm_1_cs2'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   
   
   
   #从agli030取科目设置
   LET l_sql = " SELECT glad005,glad007,glad008,glad009,glad010,glad011,glad012,glad013,glad015,",
               "        glad016,glad017,glad018,glad019,glad020,glad021,glad022,glad023,glad024,glad025,",
               "        glad026,glad027,glad031,glad032,glad033 ",
               "   FROM glad_t ",
               "  WHERE gladent = ",g_enterprise,
               "    AND gladld  = '",p_ld CLIPPED,"'",
               "    AND glad001 = ? "
   PREPARE s_voucher_gen_fm_1_p3 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_fm_1_p3'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   DECLARE s_voucher_gen_fm_1_cs3 CURSOR FOR s_voucher_gen_fm_1_p3
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_fm_1_cs3'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   
   
   
   LET l_sql = " SELECT UNIQUE glaqcomp,docno,docdt",
               "   FROM s_vr_tmp08 "  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
   PREPARE s_voucher_gen_fm_1_p4 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_fm_1_p4'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   DECLARE s_voucher_gen_fm_1_cs4 CURSOR FOR s_voucher_gen_fm_1_p4
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_fm_1_cs4'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF

   
   
   #用于生成glaq_t资料的临时表
   LET l_sql = " SELECT * FROM s_vr_tmp08 ",  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
              #" ORDER BY d desc,c "               #170509-00094#11 mark
               " ORDER BY sw,glaq002,d desc,c "    #170509-00094#11 add
   PREPARE s_voucher_gen_fm_1_p5 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_fm_1_p5'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   DECLARE s_voucher_gen_fm_1_cs5 CURSOR FOR s_voucher_gen_fm_1_p5
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_fm_1_cs5'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   
   
   
#yangtt--2016/03/15--mark--str--
#   IF p_source = 'afmt075' THEN
#      LET l_sql = "UPDATE fmay_t SET fmay007 = ? ",
#                  " WHERE fmayent = ",g_enterprise,
#                  "   AND fmay003 = '",p_ld,"'",
#                  "   AND fmay002 = ? "
#   END IF
#   
#    IF p_source = 'afmt090' THEN
#      LET l_sql = "UPDATE fmbb_t SET fmbb006 = ? ",
#                  " WHERE fmbbent = ",g_enterprise,
#                  "   AND fmbb003 = '",p_ld,"'",
#                  "   AND fmbb004 = ? ",
#                  "   AND fmbb005 = ? "
#   END IF
#yangtt--2016/03/15--mark--end--
   
   #150429-00010#14 add ------
   IF p_source = 'afmt570' THEN
      LET l_sql = "UPDATE fmna_t SET fmna005 = ? ",
                  " WHERE fmnaent   = ",g_enterprise,
                  "   AND fmna001   = '",p_ld,"'",
                  "   AND fmnadocno = ? "
   END IF
   #150429-00010#14 add end---
   
   #140804-00008#13 add ------
   IF p_source = 'afmt555' THEN
      LET l_sql = "UPDATE fmmq_t SET fmmq004 = ? ",
                  " WHERE fmmqent   = ",g_enterprise,
                  "   AND fmmq001   = '",p_ld,"'",
                  "   AND fmmqdocno = ? "
   END IF
   #140804-00008#13 add end---
      
   # #140804-00008#20 albireo 150520-s
   IF p_source = 'afmt595' THEN
      LET l_sql = "UPDATE fmne_t SET fmne004 = ? ",
                  " WHERE fmneent   = ",g_enterprise,
                  "   AND fmne001   = '",p_ld,"'",
                  "   AND fmnedocno = ? "
   END IF
   # #140804-00008#20 albireo 150520-e
   
   #140804-00008#18 Hans 150525-s
   IF p_source = 'afmt585' THEN
      LET l_sql = "UPDATE fmmw_t SET fmmw004 = ? ",
                  " WHERE fmmwent   = ",g_enterprise,
                  "   AND fmmw001   = '",p_ld,"'",
                  "   AND fmmwdocno = ? "
   END IF
   #140804-00008#18 Hans 150525-e
   
   #140804-00008#15 add ------
   IF p_source = 'afmt565' THEN
      LET l_sql = "UPDATE fmmu_t SET fmmu004 = ? ",
                  " WHERE fmmuent   = ",g_enterprise,
                  "   AND fmmu001   = '",p_ld,"'",
                  "   AND fmmudocno = ? "
   END IF
   #140804-00008#15 add end---
   
   #140804-00008#9 add ------
   IF p_source = 'afmt535' THEN
      LET l_sql = "UPDATE fmml_t SET fmml007 = ? ",
                  " WHERE fmmlent = ",g_enterprise,
                  "   AND fmml003 = '",p_ld,"'",
                  "   AND fmmldocno = ? "
   END IF
   #140804-00008#9 add end---
      
   PREPARE s_voucher_gen_fm_1_p6 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_fm_1_p6'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   
   #151203-00013#3 --s mark
   ##150825-00004#9 add ------
   ##从临时表中取科目+幣別
   #LET l_sql = " SELECT DISTINCT glaq002,glaq005,sw FROM s_voucher_fm_tmp "
   #PREPARE s_voucher_gen_fm_1_p8 FROM l_sql
   #DECLARE s_voucher_gen_fm_1_cs8 CURSOR FOR s_voucher_gen_fm_1_p8
   #
   ##从临时表中取該科目+幣別第一筆資訊
   #LET l_sql = " SELECT * FROM s_voucher_fm_tmp ",
   #            "  WHERE glaq002 = ? AND glaq005 = ? AND sw = ?",
   #            "  ORDER BY docno"
   #PREPARE s_voucher_gen_fm_1_p9 FROM l_sql
   #DECLARE s_voucher_gen_fm_1_cs9 SCROLL CURSOR FOR s_voucher_gen_fm_1_p9
   #
   ##从临时表中取該科目+幣別第一筆資訊
   #LET l_sql = " SELECT SUM(d),SUM(c),SUM(sum),SUM(glaq040),SUM(glaq041),",
   #            "        SUM(glaq043),SUM(glaq044)",
   #            "   FROM s_voucher_fm_tmp ",
   #            "  WHERE glaq002 = ? AND glaq005 = ? AND sw = ?",
   #            "  ORDER BY docno"
   #PREPARE s_voucher_gen_fm_1_p10 FROM l_sql
   #DECLARE s_voucher_gen_fm_1_cs10 CURSOR FOR s_voucher_gen_fm_1_p10
   ##150825-00004#9 add end---
   #151203-00013#3 --e mark
   
   LET g_sql = "SELECT docno,docdt,sw,glaqent,glaqcomp,glaqld,glaq001,glaq002,glaq005,",
               "       glaq006,glaq007,glaq009,glaq011,glaq012,glaq013,glaq014,glaq015,glaq016,",
               "       glaq017,glaq018,glaq019,glaq020,glaq021,glaq022,glaq023,glaq024,glaq025, ",
              #"       glaq026,glaq027,glaq028,glaq029,glaq030,glaq031,glaq032,glaq033,glaq034,", #151112-00009#3 mark
               "       glaq027,glaq028,glaq029,glaq030,glaq031,glaq032,glaq033,glaq034,",         #151112-00009#3
               "       glaq035,glaq036,glaq037,glaq038,d,c,qty,sum,glaq039,glaq040,glaq041,",
               "       glaq042,glaq043,glaq044,seq,source,glaqseq,xrca039 ",
               "  FROM s_vr_tmp04 "  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
   PREPARE s_voucher_gen_fm_1_p7 FROM g_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_fm_1_p7'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   DECLARE s_voucher_gen_fm_1_cs7 CURSOR FOR s_voucher_gen_fm_1_p7
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_fm_1_cs7'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF 
   
   #170509-00094#7---add---start---
   SELECT glaa004
     INTO l_glaa004
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald = p_ld
   LET l_sql = "SELECT glad002,glac008",      
               "  FROM glad_t",
               "  LEFT JOIN glac_t ON glacent = gladent AND glad001 = glac002 AND glac001 = '",l_glaa004,"'",
               " WHERE gladent = ",g_enterprise,
               "   AND gladld = '",p_ld,"'",
               "   AND glad001 = ?"
   PREPARE s_voucher_gen_fm_glad FROM l_sql    
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_fm_glad'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF        
   #170509-00094#7---add---end--   
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 融資系統憑證預覽
# Memo...........:
# Usage..........: CALL s_voucher_gen_fm(p_type,p_ld,p_date,p_slip,p_sum_type,p_wc,p_preview,p_source)
#                       RETURNING r_success,g_glaq
# Input parameter: p_type         来源类型
#                                 1.afmt075 应收票據帳務處理                              
#                : p_ld           帐套
#                : p_date         立帐日期
#                : p_slip         凭证单别
#                : p_sum_type     汇总方式 
#                : p_wc           ＱＢＥ的範圍條件
#                : p_preview      是否先預覽后再拋憑證（Y/N）
#                : p_source       來源
# Return code....: r_success      成功否标识位
#                : g_glaq         傳票底稿清單
# Date & Author..: 2012/10/17 By jingll
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_fm(p_type,p_ld,p_date,p_slip,p_sum_type,p_wc,p_preview,p_source)
   DEFINE p_type          LIKE type_t.chr2
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE p_date          LIKE glap_t.glapdocdt
   DEFINE p_slip          LIKE ooba_t.ooba002
   DEFINE p_sum_type      LIKE type_t.chr1
   DEFINE p_wc            LIKE type_t.chr1000
   DEFINE p_preview       LIKE type_t.chr1
   DEFINE p_source        LIKE type_t.chr10
   DEFINE r_success       LIKE type_t.num5
   DEFINE r_start_no      LIKE glap_t.glapdocno
   DEFINE r_end_no        LIKE glap_t.glapdocno
   DEFINE l_site          LIKE ooef_t.ooef001
   DEFINE l_success       LIKE type_t.num5
   
   
   WHENEVER ERROR CONTINUE
   
   LET r_success  = FALSE
   LET g_dfin1002 = 'N'
   CALL g_glaq_d.clear()

   #检查事务中
   IF NOT s_transaction_chk('Y',1) THEN
      RETURN r_success
   END IF   

   
   IF cl_null(p_ld) THEN
      #帐套参数为空
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'agl-00121'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   
   
   #检查帐套是否正确
   CALL s_ld_chk_authorization(g_user,p_ld) RETURNING l_success
   IF l_success = FALSE THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'axr-00022'
      LET g_errparam.extend = p_ld
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF 
   
   
   SELECT glaacomp INTO l_site FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald  = p_ld
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'sel glaacomp'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success 
   END IF
   
   
   IF cl_null(p_sum_type) THEN
      #产生凭证的汇总方式为空
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'agl-00123'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success 
   END IF
   
   IF cl_null(p_wc) THEN LET p_wc = " 1=1" END IF
   
   CALL s_voucher_cre_nm_tmp_table() RETURNING r_success
   
   CASE p_type
        #yangtt--2016/03/15--mark--str
#        WHEN '1'   #AFM償還本息帳款憑證預覽
#            CALL s_voucher_gen_fm_1(p_ld,p_sum_type,p_wc,p_source)
#                 RETURNING r_success
        #yangtt--2016/03/15--mark--end
        #150429-00010#14 add ------
        WHEN '3'   #AFM月底重評價傳票(afmt570)
            CALL s_voucher_gen_fm_3(p_ld,p_sum_type,p_wc,p_source)
                 RETURNING r_success
        #150429-00010#14 add end---
        
        #140804-00008#13 add ------
        WHEN '4'   #公允價值調整傳票(afmt555)
            CALL s_voucher_gen_fm_4(p_ld,p_sum_type,p_wc,p_source)
                 RETURNING r_success
        #140804-00008#13 add end---
        
        ##140804-00008#20  albireo 150520-s
        WHEN '5'    #平倉帳務傳票(afmt595)
            CALL s_voucher_gen_fm_5(p_ld,p_sum_type,p_wc,p_source)
                 RETURNING r_success           
        ##140804-00008#20  albireo 150520-e
        
        #140804-00008#18  Hans 150525-s
        WHEN '6'    #收息業務單傳票(afmt585)
            CALL s_voucher_gen_fm_6(p_ld,p_sum_type,p_wc,p_source)
                 RETURNING r_success           
        #140804-00008#18  Hans 150525-e
        
        #140804-00008#15 add ------
        WHEN '7'    #計提投資收益帳務單(afmt565)
            CALL s_voucher_gen_fm_7(p_ld,p_sum_type,p_wc,p_source)
                 RETURNING r_success
        #140804-00008#15 add end---
        
        #140804-00008#9 add ------
        WHEN '8'    #投資購買帳務單(afmt535)
            CALL s_voucher_gen_fm_8(p_ld,p_sum_type,p_wc,p_source)
                 RETURNING r_success
        #140804-00008#9 add end---
   END CASE
   
   #150924-00006#8 add ------
   #將明細資料彙總
   CALL s_voucher_gen_fm_1_ins_group_tmp(p_ld,'1') RETURNING l_success
   IF NOT l_success THEN
      RETURN r_success,r_start_no,r_end_no
   END IF
   #150924-00006#8 add end---
   
   IF p_preview = 'Y' THEN   #先預覽,不產生憑證
      #RETURN r_success                     #150429-00010#14 mark
      RETURN r_success,r_start_no,r_end_no  #150429-00010#14
   ELSE                      #不預覽,直接產生憑證
      #插入凭证单头
      CALL s_voucher_gen_fm_1_ins_glap(p_slip,p_date,p_ld,p_source)
         RETURNING r_success,r_start_no,r_end_no
      IF NOT r_success THEN
         RETURN r_success,r_start_no,r_end_no       
      END IF
      RETURN r_success,r_start_no,r_end_no      
   END IF
END FUNCTION
################################################################################
# Memo...........:
# Usage..........: CALL s_voucher_gen_fm_1(p_ld,p_sum_type,p_wc,p_source)
#                       RETURNING r_success,g_glaq
# Input parameter: p_ld           帐套
#                : p_sum_type     汇总方式 
#                : p_wc           QBE条件(帐款来源)
#                : p_source       資料來源于 
# Return code....: r_success      成功否标识位
#                : g_glaq         傳票底稿清單
# Date & Author..: 2014/10/17 By jingll
################################################################################
PUBLIC FUNCTION s_voucher_gen_fm_1(p_ld,p_sum_type,p_wc,p_source)
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE p_sum_type      LIKE type_t.chr1
   DEFINE p_wc            LIKE type_t.chr1000
   DEFINE p_source        LIKE type_t.chr10
   DEFINE r_success       LIKE type_t.num5
#yangtt--2016/03/15--mark--str--
#   DEFINE l_fmay          RECORD LIKE fmay_t.*
#   DEFINE l_fmbb          RECORD LIKE fmbb_t.*
#   DEFINE l_success       LIKE type_t.num5
#   DEFINE l_ac            LIKE type_t.num5
#   DEFINE l_ac1           LIKE type_t.num5
#   DEFINE l_docno         LIKE glaq_t.glaqdocno
#   DEFINE l_glaq002       LIKE glaq_t.glaq002
#   DEFINE l_field         LIKE type_t.chr1000
#   DEFINE l_field1        LIKE type_t.chr1000
#   DEFINE l_field2        LIKE type_t.chr1000
#   DEFINE l_field3        LIKE type_t.chr1000
#   DEFINE l_field4        LIKE type_t.chr1000
#   DEFINE l_group_field   LIKE type_t.chr1000
#   DEFINE l_glad_r        RECORD 
#                          glad005   LIKE glad_t.glad005,  #数量/金额管理否
#                          glad007   LIKE glad_t.glad007,  #部门管理否
#                          glad008   LIKE glad_t.glad008,  #利润成本管理否
#                          glad009   LIKE glad_t.glad009,  #区域管理否
#                          glad010   LIKE glad_t.glad010,  #交易客商管理否
#                          glad011   LIKE glad_t.glad011,  #客群管理否
#                          glad012   LIKE glad_t.glad012,  #产品类别管理否
#                          glad013   LIKE glad_t.glad013,  #人员管理否
##                         glad014   LIKE glad_t.glad014,  #预算管理否
#                          glad015   LIKE glad_t.glad015,  #专案管理否
#                          glad016   LIKE glad_t.glad016,  #WBS管理否
#                          glad017   LIKE glad_t.glad017,  #自由核算项1管理否
#                          glad018   LIKE glad_t.glad018,  #自由核算项2管理否
#                          glad019   LIKE glad_t.glad019,  #自由核算项3管理否
#                          glad020   LIKE glad_t.glad020,  #自由核算项4管理否
#                          glad021   LIKE glad_t.glad021,  #自由核算项5管理否
#                          glad022   LIKE glad_t.glad022,  #自由核算项6管理否
#                          glad023   LIKE glad_t.glad023,  #自由核算项7管理否
#                          glad024   LIKE glad_t.glad024,  #自由核算项8管理否
#                          glad025   LIKE glad_t.glad025,  #自由核算项9管理否
#                          glad026   LIKE glad_t.glad026,  #自由核算项10管理否 
#                          glad027   LIKE glad_t.glad027,  #账款客商管理否
#                          glad031   LIKE glad_t.glad031,  #經營方式管理否
#                          glad032   LIKE glad_t.glad032,  #渠道管理否
#                          glad033   LIKE glad_t.glad033   #品牌管理否
#                          END RECORD
#   
#   WHENEVER ERROR CONTINUE
#   LET r_success  = FALSE
#
#   DELETE FROM s_voucher_nm_tmp;
#   DELETE FROM s_voucher_nm_group;
#
#   #1.定义CURSOR
#   CALL s_voucher_gen_fm_1_def_cursor(p_ld,p_wc,p_sum_type,'',p_source) RETURNING l_success  
#   IF NOT l_success THEN
#      RETURN r_success
#   END IF
# 
#
#   #2.插入临时表
#   IF p_source = 'afmt075' THEN
#      FOREACH s_voucher_gen_fm_1_cs INTO l_fmay.*
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 'foreach s_voucher_gen_fm_1_cs'
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#
#         RETURN r_success
#      END IF
#      
#      CALL s_voucher_gen_fm_1_ins_tmp(l_fmay.fmay003,l_fmay.fmay002)
#           RETURNING l_success
#      IF NOT l_success THEN
#         RETURN r_success    
#      END IF
#
#      END FOREACH
#   END IF
#
#    IF p_source = 'afmt090' THEN
#      FOREACH s_voucher_gen_fm_2_cs INTO l_fmbb.*
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 'foreach s_voucher_gen_fm_2_cs'
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#
#         RETURN r_success
#      END IF
#      
#      CALL s_voucher_gen_fm_2_ins_tmp(l_fmbb.fmbb003,l_fmbb.fmbb004,l_fmbb.fmbb005)
#           RETURNING l_success
#      IF NOT l_success THEN
#         RETURN r_success    
#      END IF
#
#      END FOREACH
#   END IF 
# 
#      
#   #3.按科目设置进行UPDATE,若有做不管理的字段,UPDATE至' '
#   CALL s_voucher_gen_fm_1_upd_tmp(p_ld)
#        RETURNING l_success
#   IF NOT l_success THEN
#      RETURN r_success    
#   END IF
#   
#   LET r_success = TRUE
#   
#   
#   RETURN r_success
#yangtt--2016/03/15--mark--end--  
END FUNCTION

################################################################################
# Descriptions...: 月底重評價傳票>>afmt570
# Memo...........: 150429-00010#14
# Usage..........: CALL s_voucher_gen_fm_3(p_ld,p_sum_type,p_wc,p_source)
#                       RETURNING r_success,g_glaq
# Input parameter: p_ld           帐套
#                : p_sum_type     汇总方式 
#                : p_wc           QBE条件(帐款来源)
#                : p_source       資料來源于 
# Return code....: r_success      成功否标识位
#                : g_glaq         傳票底稿清單
# Date & Author..: 2015/05/09 By Reanna
################################################################################
PUBLIC FUNCTION s_voucher_gen_fm_3(p_ld,p_sum_type,p_wc,p_source)
DEFINE p_ld            LIKE glaa_t.glaald
DEFINE p_sum_type      LIKE type_t.chr1
DEFINE p_wc            LIKE type_t.chr1000
DEFINE p_source        LIKE type_t.chr10
#161128-00061#7---add---begin-----------
#DEFINE l_fmna          RECORD LIKE fmna_t.*
DEFINE l_fmna RECORD  #投資重評價帳務單頭檔
       fmnaent LIKE fmna_t.fmnaent, #企業編號
       fmnadocno LIKE fmna_t.fmnadocno, #單據編號
       fmnacomp LIKE fmna_t.fmnacomp, #法人
       fmnasite LIKE fmna_t.fmnasite, #帳務中心
       fmnadocdt LIKE fmna_t.fmnadocdt, #單據日期
       fmna001 LIKE fmna_t.fmna001, #帳套
       fmna002 LIKE fmna_t.fmna002, #年度
       fmna003 LIKE fmna_t.fmna003, #期別
       fmna004 LIKE fmna_t.fmna004, #來源
       fmna005 LIKE fmna_t.fmna005, #憑證號碼
       fmna006 LIKE fmna_t.fmna006, #帳務人員
       fmnaownid LIKE fmna_t.fmnaownid, #資料所有者
       fmnaowndp LIKE fmna_t.fmnaowndp, #資料所屬部門
       fmnacrtid LIKE fmna_t.fmnacrtid, #資料建立者
       fmnacrtdp LIKE fmna_t.fmnacrtdp, #資料建立部門
       fmnacrtdt LIKE fmna_t.fmnacrtdt, #資料創建日
       fmnamodid LIKE fmna_t.fmnamodid, #資料修改者
       fmnamoddt LIKE fmna_t.fmnamoddt, #最近修改日
       fmnacnfid LIKE fmna_t.fmnacnfid, #資料確認者
       fmnacnfdt LIKE fmna_t.fmnacnfdt, #資料確認日
       fmnapstid LIKE fmna_t.fmnapstid, #資料過帳者
       fmnapstdt LIKE fmna_t.fmnapstdt, #資料過帳日
       fmnastus LIKE fmna_t.fmnastus, #狀態碼
       fmnaud001 LIKE fmna_t.fmnaud001, #自定義欄位(文字)001
       fmnaud002 LIKE fmna_t.fmnaud002, #自定義欄位(文字)002
       fmnaud003 LIKE fmna_t.fmnaud003, #自定義欄位(文字)003
       fmnaud004 LIKE fmna_t.fmnaud004, #自定義欄位(文字)004
       fmnaud005 LIKE fmna_t.fmnaud005, #自定義欄位(文字)005
       fmnaud006 LIKE fmna_t.fmnaud006, #自定義欄位(文字)006
       fmnaud007 LIKE fmna_t.fmnaud007, #自定義欄位(文字)007
       fmnaud008 LIKE fmna_t.fmnaud008, #自定義欄位(文字)008
       fmnaud009 LIKE fmna_t.fmnaud009, #自定義欄位(文字)009
       fmnaud010 LIKE fmna_t.fmnaud010, #自定義欄位(文字)010
       fmnaud011 LIKE fmna_t.fmnaud011, #自定義欄位(數字)011
       fmnaud012 LIKE fmna_t.fmnaud012, #自定義欄位(數字)012
       fmnaud013 LIKE fmna_t.fmnaud013, #自定義欄位(數字)013
       fmnaud014 LIKE fmna_t.fmnaud014, #自定義欄位(數字)014
       fmnaud015 LIKE fmna_t.fmnaud015, #自定義欄位(數字)015
       fmnaud016 LIKE fmna_t.fmnaud016, #自定義欄位(數字)016
       fmnaud017 LIKE fmna_t.fmnaud017, #自定義欄位(數字)017
       fmnaud018 LIKE fmna_t.fmnaud018, #自定義欄位(數字)018
       fmnaud019 LIKE fmna_t.fmnaud019, #自定義欄位(數字)019
       fmnaud020 LIKE fmna_t.fmnaud020, #自定義欄位(數字)020
       fmnaud021 LIKE fmna_t.fmnaud021, #自定義欄位(日期時間)021
       fmnaud022 LIKE fmna_t.fmnaud022, #自定義欄位(日期時間)022
       fmnaud023 LIKE fmna_t.fmnaud023, #自定義欄位(日期時間)023
       fmnaud024 LIKE fmna_t.fmnaud024, #自定義欄位(日期時間)024
       fmnaud025 LIKE fmna_t.fmnaud025, #自定義欄位(日期時間)025
       fmnaud026 LIKE fmna_t.fmnaud026, #自定義欄位(日期時間)026
       fmnaud027 LIKE fmna_t.fmnaud027, #自定義欄位(日期時間)027
       fmnaud028 LIKE fmna_t.fmnaud028, #自定義欄位(日期時間)028
       fmnaud029 LIKE fmna_t.fmnaud029, #自定義欄位(日期時間)029
       fmnaud030 LIKE fmna_t.fmnaud030  #自定義欄位(日期時間)030
       END RECORD

#161128-00061#7---add---begin-----------
#DEFINE l_glab011       LIKE glab_t.glab011    #150825-00004#9 #151203-00013#3 mark
DEFINE r_success       LIKE type_t.num5
DEFINE l_success       LIKE type_t.num5        #170509-00094#7 add
DEFINE l_slip          LIKE ooba_t.ooba002     #170509-00094#7 add
   
   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE
   
   #1.定义CURSOR
   CALL s_voucher_gen_fm_1_def_cursor(p_ld,p_wc,p_sum_type,'',p_source) RETURNING g_sub_success
   IF NOT g_sub_success THEN
      RETURN r_success
   END IF
   
   DELETE FROM s_vr_tmp08;  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
   
   #2.插入临时表
   FOREACH s_voucher_gen_fm_3_cs INTO l_fmna.*
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach s_voucher_gen_fm_3_cs'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      
      #170509-00094#7---add---start---
      #取單別
      CALL s_aooi200_fin_get_slip(l_fmna.fmnadocno) RETURNING l_success,l_slip
      #紅字傳票
      CALL s_fin_get_doc_para(p_ld,l_fmna.fmnacomp,l_slip,'D-FIN-1002') RETURNING g_dfin1002
      #170509-00094#7---add---end---  
      
      #借:重評價科目
      CALL s_voucher_gen_fm_3_ins_tmp('31',l_fmna.fmna001,l_fmna.fmnadocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      
      #貸:對方科目
      CALL s_voucher_gen_fm_3_ins_tmp('32',l_fmna.fmna001,l_fmna.fmnadocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      
      #151203-00013#3 --s mark
      ##150825-00004#9 add ------
      ##如果重評價設定(agli171)成依幣別彙總，在進這裡做處理
      #SELECT glab011 INTO l_glab011
      #  FROM glab_t
      # WHERE glabent = g_enterprise
      #   AND glabld  = p_ld
      #   AND glab001 = '25'
      #   AND glab002 = '8318'
      #   AND glab003 = '8318_11'
      #IF l_glab011 = '3' THEN  #3:依幣別匯總
      #   CALL s_voucher_gen_fm_2_ins_group_tmp(l_fmna.fmna001)
      #        RETURNING g_sub_success
      #   IF NOT g_sub_success THEN RETURN r_success END IF
      #END IF
      ##150825-00004#9 add end---
      #151203-00013#3 --e mark
      
   END FOREACH
   
   #3.按科目设置进行UPDATE,若有做不管理的字段,UPDATE至' '
   CALL s_voucher_gen_fm_1_upd_tmp(p_ld)
        RETURNING g_sub_success
   IF NOT g_sub_success THEN
      RETURN r_success
   END IF
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 月底重評價傳票>>afmt555
# Memo...........: 140804-00008#13
# Usage..........: CALL s_voucher_gen_fm_4(p_ld,p_sum_type,p_wc,p_source)
#                       RETURNING r_success,g_glaq
# Input parameter: p_ld           帐套
#                : p_sum_type     汇总方式 
#                : p_wc           QBE条件(帐款来源)
#                : p_source       資料來源于 
# Return code....: r_success      成功否标识位
#                : g_glaq         傳票底稿清單
# Date & Author..: 2015/05/18 By Hans
################################################################################
PUBLIC FUNCTION s_voucher_gen_fm_4(p_ld,p_sum_type,p_wc,p_source)
DEFINE p_ld            LIKE glaa_t.glaald
DEFINE p_sum_type      LIKE type_t.chr1
DEFINE p_wc            LIKE type_t.chr1000
DEFINE p_source        LIKE type_t.chr10
#161128-00061#7---add---begin-----------
#DEFINE l_fmmq          RECORD LIKE fmmq_t.*
DEFINE l_fmmq RECORD  #公允價值調整單頭檔
       fmmqent LIKE fmmq_t.fmmqent, #企業編號
       fmmqdocno LIKE fmmq_t.fmmqdocno, #公允價值調整帳務單號
       fmmqdocdt LIKE fmmq_t.fmmqdocdt, #單據日期
       fmmqsite LIKE fmmq_t.fmmqsite, #帳務中心
       fmmq001 LIKE fmmq_t.fmmq001, #帳套
       fmmq002 LIKE fmmq_t.fmmq002, #年度
       fmmq003 LIKE fmmq_t.fmmq003, #期別
       fmmq004 LIKE fmmq_t.fmmq004, #憑證編號
       fmmqownid LIKE fmmq_t.fmmqownid, #資料所有者
       fmmqowndp LIKE fmmq_t.fmmqowndp, #資料所屬部門
       fmmqcrtid LIKE fmmq_t.fmmqcrtid, #資料建立者
       fmmqcrtdp LIKE fmmq_t.fmmqcrtdp, #資料建立部門
       fmmqcrtdt LIKE fmmq_t.fmmqcrtdt, #資料創建日
       fmmqmodid LIKE fmmq_t.fmmqmodid, #資料修改者
       fmmqmoddt LIKE fmmq_t.fmmqmoddt, #最近修改日
       fmmqcnfid LIKE fmmq_t.fmmqcnfid, #資料確認者
       fmmqcnfdt LIKE fmmq_t.fmmqcnfdt, #資料確認日
       fmmqpstid LIKE fmmq_t.fmmqpstid, #資料過帳者
       fmmqpstdt LIKE fmmq_t.fmmqpstdt, #資料過帳日
       fmmqstus LIKE fmmq_t.fmmqstus, #狀態碼
       fmmqud001 LIKE fmmq_t.fmmqud001, #自定義欄位(文字)001
       fmmqud002 LIKE fmmq_t.fmmqud002, #自定義欄位(文字)002
       fmmqud003 LIKE fmmq_t.fmmqud003, #自定義欄位(文字)003
       fmmqud004 LIKE fmmq_t.fmmqud004, #自定義欄位(文字)004
       fmmqud005 LIKE fmmq_t.fmmqud005, #自定義欄位(文字)005
       fmmqud006 LIKE fmmq_t.fmmqud006, #自定義欄位(文字)006
       fmmqud007 LIKE fmmq_t.fmmqud007, #自定義欄位(文字)007
       fmmqud008 LIKE fmmq_t.fmmqud008, #自定義欄位(文字)008
       fmmqud009 LIKE fmmq_t.fmmqud009, #自定義欄位(文字)009
       fmmqud010 LIKE fmmq_t.fmmqud010, #自定義欄位(文字)010
       fmmqud011 LIKE fmmq_t.fmmqud011, #自定義欄位(數字)011
       fmmqud012 LIKE fmmq_t.fmmqud012, #自定義欄位(數字)012
       fmmqud013 LIKE fmmq_t.fmmqud013, #自定義欄位(數字)013
       fmmqud014 LIKE fmmq_t.fmmqud014, #自定義欄位(數字)014
       fmmqud015 LIKE fmmq_t.fmmqud015, #自定義欄位(數字)015
       fmmqud016 LIKE fmmq_t.fmmqud016, #自定義欄位(數字)016
       fmmqud017 LIKE fmmq_t.fmmqud017, #自定義欄位(數字)017
       fmmqud018 LIKE fmmq_t.fmmqud018, #自定義欄位(數字)018
       fmmqud019 LIKE fmmq_t.fmmqud019, #自定義欄位(數字)019
       fmmqud020 LIKE fmmq_t.fmmqud020, #自定義欄位(數字)020
       fmmqud021 LIKE fmmq_t.fmmqud021, #自定義欄位(日期時間)021
       fmmqud022 LIKE fmmq_t.fmmqud022, #自定義欄位(日期時間)022
       fmmqud023 LIKE fmmq_t.fmmqud023, #自定義欄位(日期時間)023
       fmmqud024 LIKE fmmq_t.fmmqud024, #自定義欄位(日期時間)024
       fmmqud025 LIKE fmmq_t.fmmqud025, #自定義欄位(日期時間)025
       fmmqud026 LIKE fmmq_t.fmmqud026, #自定義欄位(日期時間)026
       fmmqud027 LIKE fmmq_t.fmmqud027, #自定義欄位(日期時間)027
       fmmqud028 LIKE fmmq_t.fmmqud028, #自定義欄位(日期時間)028
       fmmqud029 LIKE fmmq_t.fmmqud029, #自定義欄位(日期時間)029
       fmmqud030 LIKE fmmq_t.fmmqud030  #自定義欄位(日期時間)030
       END RECORD

#161128-00061#7---add---end-----------
DEFINE r_success       LIKE type_t.num5
DEFINE l_success       LIKE type_t.num5        #170509-00094#7 add
DEFINE l_slip          LIKE ooba_t.ooba002     #170509-00094#7 add

   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE
   
   #1.定义CURSOR
   CALL s_voucher_gen_fm_1_def_cursor(p_ld,p_wc,p_sum_type,'',p_source) RETURNING g_sub_success
   IF NOT g_sub_success THEN
      RETURN r_success
   END IF
   
   DELETE FROM s_vr_tmp08;  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
   
   #2.插入临时表
   FOREACH s_voucher_gen_fm_4_cs INTO l_fmmq.*
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach s_voucher_gen_fm_4_cs'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF

      #170509-00094#7---add---start---
      #取單別
      CALL s_aooi200_fin_get_slip(l_fmmq.fmmqdocno) RETURNING l_success,l_slip
      #紅字傳票
      CALL s_fin_get_doc_para(p_ld,'',l_slip,'D-FIN-1002') RETURNING g_dfin1002
      #170509-00094#7---add---end--- 
      
      #借:重評價科目
      CALL s_voucher_gen_fm_3_ins_tmp('41',l_fmmq.fmmq001,l_fmmq.fmmqdocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      
      #貸:對方科目
      CALL s_voucher_gen_fm_3_ins_tmp('42',l_fmmq.fmmq001,l_fmmq.fmmqdocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      
   END FOREACH
   
   #3.按科目设置进行UPDATE,若有做不管理的字段,UPDATE至' '
   CALL s_voucher_gen_fm_1_upd_tmp(p_ld)
        RETURNING g_sub_success
   IF NOT g_sub_success THEN
      RETURN r_success
   END IF
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 平倉帳務單傳票>>afmt595
# Memo...........: 140804-00008#20
# Usage..........: CALL s_voucher_gen_fm_5(p_ld,p_sum_type,p_wc,p_source)
#                       RETURNING r_success,g_glaq
# Input parameter: p_ld           帐套
#                : p_sum_type     汇总方式 
#                : p_wc           QBE条件(帐款来源)
#                : p_source       資料來源于 
# Return code....: r_success      成功否标识位
#                : g_glaq         傳票底稿清單
# Date & Author..: 2015/05/20 By albireo
################################################################################
PUBLIC FUNCTION s_voucher_gen_fm_5(p_ld,p_sum_type,p_wc,p_source)
DEFINE p_ld            LIKE glaa_t.glaald
DEFINE p_sum_type      LIKE type_t.chr1
DEFINE p_wc            LIKE type_t.chr1000
DEFINE p_source        LIKE type_t.chr10
#161128-00061#7---add---begin-----------
#DEFINE l_fmne          RECORD LIKE fmne_t.*
DEFINE l_fmne RECORD  #平倉出售帳務單頭檔
       fmneent LIKE fmne_t.fmneent, #企業編號
       fmneownid LIKE fmne_t.fmneownid, #資料所有者
       fmneowndp LIKE fmne_t.fmneowndp, #資料所屬部門
       fmnecrtid LIKE fmne_t.fmnecrtid, #資料建立者
       fmnecrtdp LIKE fmne_t.fmnecrtdp, #資料建立部門
       fmnecrtdt LIKE fmne_t.fmnecrtdt, #資料創建日
       fmnemodid LIKE fmne_t.fmnemodid, #資料修改者
       fmnemoddt LIKE fmne_t.fmnemoddt, #最近修改日
       fmnecnfid LIKE fmne_t.fmnecnfid, #資料確認者
       fmnecnfdt LIKE fmne_t.fmnecnfdt, #資料確認日
       fmnepstid LIKE fmne_t.fmnepstid, #資料過帳者
       fmnepstdt LIKE fmne_t.fmnepstdt, #資料過帳日
       fmnestus LIKE fmne_t.fmnestus, #狀態碼
       fmnedocno LIKE fmne_t.fmnedocno, #單號
       fmnecomp LIKE fmne_t.fmnecomp, #法人
       fmnesite LIKE fmne_t.fmnesite, #帳務中心
       fmnedocdt LIKE fmne_t.fmnedocdt, #單據日期
       fmne001 LIKE fmne_t.fmne001, #帳套
       fmne002 LIKE fmne_t.fmne002, #年度
       fmne003 LIKE fmne_t.fmne003, #期別
       fmne004 LIKE fmne_t.fmne004, #憑證號碼
       fmne005 LIKE fmne_t.fmne005, #帳務人員
       fmneud001 LIKE fmne_t.fmneud001, #自定義欄位(文字)001
       fmneud002 LIKE fmne_t.fmneud002, #自定義欄位(文字)002
       fmneud003 LIKE fmne_t.fmneud003, #自定義欄位(文字)003
       fmneud004 LIKE fmne_t.fmneud004, #自定義欄位(文字)004
       fmneud005 LIKE fmne_t.fmneud005, #自定義欄位(文字)005
       fmneud006 LIKE fmne_t.fmneud006, #自定義欄位(文字)006
       fmneud007 LIKE fmne_t.fmneud007, #自定義欄位(文字)007
       fmneud008 LIKE fmne_t.fmneud008, #自定義欄位(文字)008
       fmneud009 LIKE fmne_t.fmneud009, #自定義欄位(文字)009
       fmneud010 LIKE fmne_t.fmneud010, #自定義欄位(文字)010
       fmneud011 LIKE fmne_t.fmneud011, #自定義欄位(數字)011
       fmneud012 LIKE fmne_t.fmneud012, #自定義欄位(數字)012
       fmneud013 LIKE fmne_t.fmneud013, #自定義欄位(數字)013
       fmneud014 LIKE fmne_t.fmneud014, #自定義欄位(數字)014
       fmneud015 LIKE fmne_t.fmneud015, #自定義欄位(數字)015
       fmneud016 LIKE fmne_t.fmneud016, #自定義欄位(數字)016
       fmneud017 LIKE fmne_t.fmneud017, #自定義欄位(數字)017
       fmneud018 LIKE fmne_t.fmneud018, #自定義欄位(數字)018
       fmneud019 LIKE fmne_t.fmneud019, #自定義欄位(數字)019
       fmneud020 LIKE fmne_t.fmneud020, #自定義欄位(數字)020
       fmneud021 LIKE fmne_t.fmneud021, #自定義欄位(日期時間)021
       fmneud022 LIKE fmne_t.fmneud022, #自定義欄位(日期時間)022
       fmneud023 LIKE fmne_t.fmneud023, #自定義欄位(日期時間)023
       fmneud024 LIKE fmne_t.fmneud024, #自定義欄位(日期時間)024
       fmneud025 LIKE fmne_t.fmneud025, #自定義欄位(日期時間)025
       fmneud026 LIKE fmne_t.fmneud026, #自定義欄位(日期時間)026
       fmneud027 LIKE fmne_t.fmneud027, #自定義欄位(日期時間)027
       fmneud028 LIKE fmne_t.fmneud028, #自定義欄位(日期時間)028
       fmneud029 LIKE fmne_t.fmneud029, #自定義欄位(日期時間)029
       fmneud030 LIKE fmne_t.fmneud030  #自定義欄位(日期時間)030
       END RECORD

#161128-00061#7---add---end-----------
DEFINE r_success       LIKE type_t.num5
DEFINE l_success       LIKE type_t.num5        #170509-00094#7 add
DEFINE l_slip          LIKE ooba_t.ooba002     #170509-00094#7 add
   
   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE
   
   #1.定义CURSOR
   CALL s_voucher_gen_fm_1_def_cursor(p_ld,p_wc,p_sum_type,'',p_source) RETURNING g_sub_success
   IF NOT g_sub_success THEN
      RETURN r_success
   END IF
   
   DELETE FROM s_vr_tmp08;  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
   
   #2.插入临时表
   FOREACH s_voucher_gen_fm_5_cs INTO l_fmne.*
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach s_voucher_gen_fm_5_cs'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      
      #170509-00094#7---add---start---
      #取單別
      CALL s_aooi200_fin_get_slip(l_fmne.fmnedocno) RETURNING l_success,l_slip
      #紅字傳票
      CALL s_fin_get_doc_para(p_ld,l_fmne.fmnecomp,l_slip,'D-FIN-1002') RETURNING g_dfin1002
      #170509-00094#7---add---end--- 
      
      #151112-00009#3 mark ------
      ##借:對方科目
      #CALL s_voucher_gen_fm_3_ins_tmp('51',l_fmne.fmne001,l_fmne.fmnedocno)
      #     RETURNING g_sub_success
      #IF NOT g_sub_success THEN RETURN r_success END IF
      #
      ##貸:利息科目
      #CALL s_voucher_gen_fm_3_ins_tmp('52',l_fmne.fmne001,l_fmne.fmnedocno)
      #     RETURNING g_sub_success
      #IF NOT g_sub_success THEN RETURN r_success END IF
      #
      ##貸:平倉收入
      #CALL s_voucher_gen_fm_3_ins_tmp('53',l_fmne.fmne001,l_fmne.fmnedocno)
      #     RETURNING g_sub_success
      #IF NOT g_sub_success THEN RETURN r_success END IF
      #
      ##貸:投資收益(或損失)
      #CALL s_voucher_gen_fm_3_ins_tmp('54',l_fmne.fmne001,l_fmne.fmnedocno)
      #     RETURNING g_sub_success
      #IF NOT g_sub_success THEN RETURN r_success END IF
      #151112-00009#3 mark end---
      
      #151112-00009#3 add ------
      #1.本金
      #會計科目一>>貸:投資本金科目fmnf029
      CALL s_voucher_gen_fm_3_ins_tmp('51',l_fmne.fmne001,l_fmne.fmnedocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      #會計科目二>>貸:投資收益科目 or 借:投資損失科目 fmnf030
      CALL s_voucher_gen_fm_3_ins_tmp('52',l_fmne.fmne001,l_fmne.fmnedocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      #銀存科目>>借：銀行存款fmnf031
      CALL s_voucher_gen_fm_3_ins_tmp('53',l_fmne.fmne001,l_fmne.fmnedocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      #匯差處理
      CALL s_voucher_gen_fm_3_ins_tmp('54',l_fmne.fmne001,l_fmne.fmnedocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      #151112-00009#3 add end---
      
      #2.費用
      #借:費用科目
      CALL s_voucher_gen_fm_3_ins_tmp('55',l_fmne.fmne001,l_fmne.fmnedocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      #貸:費用對象科目
      CALL s_voucher_gen_fm_3_ins_tmp('56',l_fmne.fmne001,l_fmne.fmnedocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      
      #151112-00009#3 add ------
      #3.利息收入
      #會計科目一>>貸:應收股利/利息科目fmnf029
      CALL s_voucher_gen_fm_3_ins_tmp('57',l_fmne.fmne001,l_fmne.fmnedocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      #會計科目二>>貸:利息收入fmnf030
      CALL s_voucher_gen_fm_3_ins_tmp('58',l_fmne.fmne001,l_fmne.fmnedocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      #銀存科目>>借：銀行存款fmnf031
      CALL s_voucher_gen_fm_3_ins_tmp('59',l_fmne.fmne001,l_fmne.fmnedocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      #匯差處理
      CALL s_voucher_gen_fm_3_ins_tmp('5A',l_fmne.fmne001,l_fmne.fmnedocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      
      #4.已宣告未領取利息
      #會計科目一>>貸：已宣告未發放股利科目fmnf029
      CALL s_voucher_gen_fm_3_ins_tmp('5B',l_fmne.fmne001,l_fmne.fmnedocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      IF NOT g_sub_success THEN RETURN r_success END IF
      #銀存科目>>借：銀行存款fmnf031
      CALL s_voucher_gen_fm_3_ins_tmp('5C',l_fmne.fmne001,l_fmne.fmnedocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      
      #5.已宣告未領取股利
      #會計科目一>>貸：已宣告未領取利息科目fmnf029
      CALL s_voucher_gen_fm_3_ins_tmp('5D',l_fmne.fmne001,l_fmne.fmnedocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      IF NOT g_sub_success THEN RETURN r_success END IF
      #銀存科目>>借：銀行存款fmnf031
      CALL s_voucher_gen_fm_3_ins_tmp('5E',l_fmne.fmne001,l_fmne.fmnedocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      #151112-00009#3 add end---
   END FOREACH
   
   #3.按科目设置进行UPDATE,若有做不管理的字段,UPDATE至' '
   CALL s_voucher_gen_fm_1_upd_tmp(p_ld)
        RETURNING g_sub_success
   IF NOT g_sub_success THEN
      RETURN r_success
   END IF
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 收息業務單>>afmt585
# Memo...........: 140804-00008#18
# Usage..........: CALL s_voucher_gen_fm_6(p_ld,p_sum_type,p_wc,p_source)
#                       RETURNING r_success,g_glaq
# Input parameter: p_ld           帳套
#                : p_sum_type     汇总方式 
#                : p_wc           QBE条件(帐款来源)
#                : p_source       資料來源于 
# Return code....: r_success      成功否标识位
#                : g_glaq         傳票底稿清單
# Date & Author..: 2015/05/25 By Hans
################################################################################
PUBLIC FUNCTION s_voucher_gen_fm_6(p_ld,p_sum_type,p_wc,p_source)
DEFINE p_ld            LIKE glaa_t.glaald
DEFINE p_sum_type      LIKE type_t.chr1
DEFINE p_wc            LIKE type_t.chr1000
DEFINE p_source        LIKE type_t.chr10
#161128-00061#7---add---begin-----------
#DEFINE l_fmmw          RECORD LIKE fmmw_t.*
DEFINE l_fmmw RECORD  #收息帳務單頭檔
       fmmwent LIKE fmmw_t.fmmwent, #企業編號
       fmmwdocno LIKE fmmw_t.fmmwdocno, #單號
       fmmwcomp LIKE fmmw_t.fmmwcomp, #法人
       fmmwsite LIKE fmmw_t.fmmwsite, #營運據點
       fmmwdocdt LIKE fmmw_t.fmmwdocdt, #單據日期
       fmmw001 LIKE fmmw_t.fmmw001, #帳套
       fmmw002 LIKE fmmw_t.fmmw002, #年度
       fmmw003 LIKE fmmw_t.fmmw003, #期別
       fmmw004 LIKE fmmw_t.fmmw004, #憑證號碼
       fmmw005 LIKE fmmw_t.fmmw005, #帳務人員
       fmmwownid LIKE fmmw_t.fmmwownid, #資料所有者
       fmmwowndp LIKE fmmw_t.fmmwowndp, #資料所屬部門
       fmmwcrtid LIKE fmmw_t.fmmwcrtid, #資料建立者
       fmmwcrtdp LIKE fmmw_t.fmmwcrtdp, #資料建立部門
       fmmwcrtdt LIKE fmmw_t.fmmwcrtdt, #資料創建日
       fmmwmodid LIKE fmmw_t.fmmwmodid, #資料修改者
       fmmwmoddt LIKE fmmw_t.fmmwmoddt, #最近修改日
       fmmwcnfid LIKE fmmw_t.fmmwcnfid, #資料確認者
       fmmwcnfdt LIKE fmmw_t.fmmwcnfdt, #資料確認日
       fmmwpstid LIKE fmmw_t.fmmwpstid, #資料過帳者
       fmmwpstdt LIKE fmmw_t.fmmwpstdt, #資料過帳日
       fmmwstus LIKE fmmw_t.fmmwstus, #狀態碼
       fmmwud001 LIKE fmmw_t.fmmwud001, #自定義欄位(文字)001
       fmmwud002 LIKE fmmw_t.fmmwud002, #自定義欄位(文字)002
       fmmwud003 LIKE fmmw_t.fmmwud003, #自定義欄位(文字)003
       fmmwud004 LIKE fmmw_t.fmmwud004, #自定義欄位(文字)004
       fmmwud005 LIKE fmmw_t.fmmwud005, #自定義欄位(文字)005
       fmmwud006 LIKE fmmw_t.fmmwud006, #自定義欄位(文字)006
       fmmwud007 LIKE fmmw_t.fmmwud007, #自定義欄位(文字)007
       fmmwud008 LIKE fmmw_t.fmmwud008, #自定義欄位(文字)008
       fmmwud009 LIKE fmmw_t.fmmwud009, #自定義欄位(文字)009
       fmmwud010 LIKE fmmw_t.fmmwud010, #自定義欄位(文字)010
       fmmwud011 LIKE fmmw_t.fmmwud011, #自定義欄位(數字)011
       fmmwud012 LIKE fmmw_t.fmmwud012, #自定義欄位(數字)012
       fmmwud013 LIKE fmmw_t.fmmwud013, #自定義欄位(數字)013
       fmmwud014 LIKE fmmw_t.fmmwud014, #自定義欄位(數字)014
       fmmwud015 LIKE fmmw_t.fmmwud015, #自定義欄位(數字)015
       fmmwud016 LIKE fmmw_t.fmmwud016, #自定義欄位(數字)016
       fmmwud017 LIKE fmmw_t.fmmwud017, #自定義欄位(數字)017
       fmmwud018 LIKE fmmw_t.fmmwud018, #自定義欄位(數字)018
       fmmwud019 LIKE fmmw_t.fmmwud019, #自定義欄位(數字)019
       fmmwud020 LIKE fmmw_t.fmmwud020, #自定義欄位(數字)020
       fmmwud021 LIKE fmmw_t.fmmwud021, #自定義欄位(日期時間)021
       fmmwud022 LIKE fmmw_t.fmmwud022, #自定義欄位(日期時間)022
       fmmwud023 LIKE fmmw_t.fmmwud023, #自定義欄位(日期時間)023
       fmmwud024 LIKE fmmw_t.fmmwud024, #自定義欄位(日期時間)024
       fmmwud025 LIKE fmmw_t.fmmwud025, #自定義欄位(日期時間)025
       fmmwud026 LIKE fmmw_t.fmmwud026, #自定義欄位(日期時間)026
       fmmwud027 LIKE fmmw_t.fmmwud027, #自定義欄位(日期時間)027
       fmmwud028 LIKE fmmw_t.fmmwud028, #自定義欄位(日期時間)028
       fmmwud029 LIKE fmmw_t.fmmwud029, #自定義欄位(日期時間)029
       fmmwud030 LIKE fmmw_t.fmmwud030  #自定義欄位(日期時間)030
       END RECORD

#161128-00061#7---add---end-----------
DEFINE r_success       LIKE type_t.num5
DEFINE l_success       LIKE type_t.num5        #170509-00094#7 add
DEFINE l_slip          LIKE ooba_t.ooba002     #170509-00094#7 add

   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE

   #1.定义CURSOR
   CALL s_voucher_gen_fm_1_def_cursor(p_ld,p_wc,p_sum_type,'',p_source) RETURNING g_sub_success
   IF NOT g_sub_success THEN
      RETURN r_success
   END IF
   
   DELETE FROM s_vr_tmp08;  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
   
   #2.插入临时表
   FOREACH s_voucher_gen_fm_6_cs INTO l_fmmw.*
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach s_voucher_gen_fm_6_cs'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      
      #170509-00094#7---add---start---
      #取單別
      CALL s_aooi200_fin_get_slip(l_fmmw.fmmwdocno) RETURNING l_success,l_slip
      #紅字傳票
      CALL s_fin_get_doc_para(p_ld,l_fmmw.fmmwcomp,l_slip,'D-FIN-1002') RETURNING g_dfin1002
      #170509-00094#7---add---end--- 
      
      #借:對方科目
      CALL s_voucher_gen_fm_3_ins_tmp('61',l_fmmw.fmmw001,l_fmmw.fmmwdocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
   
      #貸:收入科目
      CALL s_voucher_gen_fm_3_ins_tmp('62',l_fmmw.fmmw001,l_fmmw.fmmwdocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
   
   END FOREACH
   
   #3.按科目设置进行UPDATE,若有做不管理的字段,UPDATE至' '
   CALL s_voucher_gen_fm_1_upd_tmp(p_ld)
        RETURNING g_sub_success
   IF NOT g_sub_success THEN
      RETURN r_success
   END IF

   LET r_success = TRUE
   RETURN r_success

END FUNCTION

################################################################################
# Descriptions...: 計提投資收益傳票>>afmt565
# Memo...........: #140804-00008#15
# Usage..........: CALL s_voucher_gen_fm_7(p_ld,p_sum_type,p_wc,p_source)
#                       RETURNING r_success,g_glaq
# Input parameter: p_ld           帐套
#                : p_sum_type     汇总方式 
#                : p_wc           QBE条件(帐款来源)
#                : p_source       資料來源于 
# Return code....: r_success      成功否标识位
#                : g_glaq         傳票底稿清單
# Date & Author..: 2015/05/27 By Reanna
################################################################################
PUBLIC FUNCTION s_voucher_gen_fm_7(p_ld,p_sum_type,p_wc,p_source)
DEFINE p_ld            LIKE glaa_t.glaald
DEFINE p_sum_type      LIKE type_t.chr1
DEFINE p_wc            LIKE type_t.chr1000
DEFINE p_source        LIKE type_t.chr10
#161128-00061#7---add---begin-----------
#DEFINE l_fmmu          RECORD LIKE fmmu_t.*
DEFINE l_fmmu RECORD  #計提收益帳務單頭檔
       fmmuent LIKE fmmu_t.fmmuent, #企業編號
       fmmudocno LIKE fmmu_t.fmmudocno, #公允價值調整帳務單號
       fmmusite LIKE fmmu_t.fmmusite, #帳務中心
       fmmu001 LIKE fmmu_t.fmmu001, #帳套
       fmmu002 LIKE fmmu_t.fmmu002, #年度
       fmmu003 LIKE fmmu_t.fmmu003, #期別
       fmmu004 LIKE fmmu_t.fmmu004, #傳票編號
       fmmudocdt LIKE fmmu_t.fmmudocdt, #單據日期
       fmmuownid LIKE fmmu_t.fmmuownid, #資料所有者
       fmmuowndp LIKE fmmu_t.fmmuowndp, #資料所屬部門
       fmmucrtid LIKE fmmu_t.fmmucrtid, #資料建立者
       fmmucrtdp LIKE fmmu_t.fmmucrtdp, #資料建立部門
       fmmucrtdt LIKE fmmu_t.fmmucrtdt, #資料創建日
       fmmumodid LIKE fmmu_t.fmmumodid, #資料修改者
       fmmumoddt LIKE fmmu_t.fmmumoddt, #最近修改日
       fmmucnfid LIKE fmmu_t.fmmucnfid, #資料確認者
       fmmucnfdt LIKE fmmu_t.fmmucnfdt, #資料確認日
       fmmupstid LIKE fmmu_t.fmmupstid, #資料過帳者
       fmmupstdt LIKE fmmu_t.fmmupstdt, #資料過帳日
       fmmustus LIKE fmmu_t.fmmustus, #狀態碼
       fmmuud001 LIKE fmmu_t.fmmuud001, #自定義欄位(文字)001
       fmmuud002 LIKE fmmu_t.fmmuud002, #自定義欄位(文字)002
       fmmuud003 LIKE fmmu_t.fmmuud003, #自定義欄位(文字)003
       fmmuud004 LIKE fmmu_t.fmmuud004, #自定義欄位(文字)004
       fmmuud005 LIKE fmmu_t.fmmuud005, #自定義欄位(文字)005
       fmmuud006 LIKE fmmu_t.fmmuud006, #自定義欄位(文字)006
       fmmuud007 LIKE fmmu_t.fmmuud007, #自定義欄位(文字)007
       fmmuud008 LIKE fmmu_t.fmmuud008, #自定義欄位(文字)008
       fmmuud009 LIKE fmmu_t.fmmuud009, #自定義欄位(文字)009
       fmmuud010 LIKE fmmu_t.fmmuud010, #自定義欄位(文字)010
       fmmuud011 LIKE fmmu_t.fmmuud011, #自定義欄位(數字)011
       fmmuud012 LIKE fmmu_t.fmmuud012, #自定義欄位(數字)012
       fmmuud013 LIKE fmmu_t.fmmuud013, #自定義欄位(數字)013
       fmmuud014 LIKE fmmu_t.fmmuud014, #自定義欄位(數字)014
       fmmuud015 LIKE fmmu_t.fmmuud015, #自定義欄位(數字)015
       fmmuud016 LIKE fmmu_t.fmmuud016, #自定義欄位(數字)016
       fmmuud017 LIKE fmmu_t.fmmuud017, #自定義欄位(數字)017
       fmmuud018 LIKE fmmu_t.fmmuud018, #自定義欄位(數字)018
       fmmuud019 LIKE fmmu_t.fmmuud019, #自定義欄位(數字)019
       fmmuud020 LIKE fmmu_t.fmmuud020, #自定義欄位(數字)020
       fmmuud021 LIKE fmmu_t.fmmuud021, #自定義欄位(日期時間)021
       fmmuud022 LIKE fmmu_t.fmmuud022, #自定義欄位(日期時間)022
       fmmuud023 LIKE fmmu_t.fmmuud023, #自定義欄位(日期時間)023
       fmmuud024 LIKE fmmu_t.fmmuud024, #自定義欄位(日期時間)024
       fmmuud025 LIKE fmmu_t.fmmuud025, #自定義欄位(日期時間)025
       fmmuud026 LIKE fmmu_t.fmmuud026, #自定義欄位(日期時間)026
       fmmuud027 LIKE fmmu_t.fmmuud027, #自定義欄位(日期時間)027
       fmmuud028 LIKE fmmu_t.fmmuud028, #自定義欄位(日期時間)028
       fmmuud029 LIKE fmmu_t.fmmuud029, #自定義欄位(日期時間)029
       fmmuud030 LIKE fmmu_t.fmmuud030  #自定義欄位(日期時間)030
       END RECORD

#161128-00061#7---add---end-----------
DEFINE r_success       LIKE type_t.num5
DEFINE l_success       LIKE type_t.num5        #170509-00094#7 add
DEFINE l_slip          LIKE ooba_t.ooba002     #170509-00094#7 add
   
   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE
   
   #1.定义CURSOR
   CALL s_voucher_gen_fm_1_def_cursor(p_ld,p_wc,p_sum_type,'',p_source) RETURNING g_sub_success
   IF NOT g_sub_success THEN
      RETURN r_success
   END IF
   
   DELETE FROM s_vr_tmp08;  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
   
   #2.插入临时表
   FOREACH s_voucher_gen_fm_7_cs INTO l_fmmu.*
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach s_voucher_gen_fm_7_cs'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF

      #170509-00094#7---add---start---
      #取單別
      CALL s_aooi200_fin_get_slip(l_fmmu.fmmudocno) RETURNING l_success,l_slip
      #紅字傳票
      CALL s_fin_get_doc_para(p_ld,'',l_slip,'D-FIN-1002') RETURNING g_dfin1002
      #170509-00094#7---add---end--- 
      
      #借:應收股利/利息科目
      CALL s_voucher_gen_fm_3_ins_tmp('71',l_fmmu.fmmu001,l_fmmu.fmmudocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      
      #貸:投資收益科目
      CALL s_voucher_gen_fm_3_ins_tmp('72',l_fmmu.fmmu001,l_fmmu.fmmudocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      
      #利息調整科目
      CALL s_voucher_gen_fm_3_ins_tmp('73',l_fmmu.fmmu001,l_fmmu.fmmudocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      
   END FOREACH
   
   #3.按科目设置进行UPDATE,若有做不管理的字段,UPDATE至' '
   CALL s_voucher_gen_fm_1_upd_tmp(p_ld)
        RETURNING g_sub_success
   IF NOT g_sub_success THEN
      RETURN r_success
   END IF
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 投資購買傳票>>afmt535
# Memo...........: #140804-00008#9
# Usage..........: CALL s_voucher_gen_fm_8(p_ld,p_sum_type,p_wc,p_source)
#                       RETURNING r_success,g_glaq
# Input parameter: p_ld           帐套
#                : p_sum_type     汇总方式 
#                : p_wc           QBE条件(帐款来源)
#                : p_source       資料來源于 
# Return code....: r_success      成功否标识位
#                : g_glaq         傳票底稿清單
# Date & Author..: 2015/05/27 By Reanna
################################################################################
PUBLIC FUNCTION s_voucher_gen_fm_8(p_ld,p_sum_type,p_wc,p_source)
DEFINE p_ld            LIKE glaa_t.glaald
DEFINE p_sum_type      LIKE type_t.chr1
DEFINE p_wc            LIKE type_t.chr1000
DEFINE p_source        LIKE type_t.chr10
#161128-00061#7---add---begin-----------
#DEFINE l_fmml          RECORD LIKE fmml_t.*
DEFINE l_fmml RECORD  #投資購買帳務單頭檔
       fmmlent LIKE fmml_t.fmmlent, #企業編號
       fmml001 LIKE fmml_t.fmml001, #帳務中心
       fmmldocno LIKE fmml_t.fmmldocno, #投資購買帳務單號
       fmml003 LIKE fmml_t.fmml003, #帳套
       fmml004 LIKE fmml_t.fmml004, #歸屬法人組織
       fmml005 LIKE fmml_t.fmml005, #年度
       fmml006 LIKE fmml_t.fmml006, #期別
       fmml007 LIKE fmml_t.fmml007, #傳票編號
       fmmldocdt LIKE fmml_t.fmmldocdt, #單據日期
       fmmlownid LIKE fmml_t.fmmlownid, #資料所有者
       fmmlowndp LIKE fmml_t.fmmlowndp, #資料所屬部門
       fmmlcrtid LIKE fmml_t.fmmlcrtid, #資料建立者
       fmmlcrtdp LIKE fmml_t.fmmlcrtdp, #資料建立部門
       fmmlcrtdt LIKE fmml_t.fmmlcrtdt, #資料創建日
       fmmlmodid LIKE fmml_t.fmmlmodid, #資料修改者
       fmmlmoddt LIKE fmml_t.fmmlmoddt, #最近修改日
       fmmlcnfid LIKE fmml_t.fmmlcnfid, #資料確認者
       fmmlcnfdt LIKE fmml_t.fmmlcnfdt, #資料確認日
       fmmlpstid LIKE fmml_t.fmmlpstid, #資料過帳者
       fmmlpstdt LIKE fmml_t.fmmlpstdt, #資料過帳日
       fmmlstus LIKE fmml_t.fmmlstus, #狀態碼
       fmmlud001 LIKE fmml_t.fmmlud001, #自定義欄位(文字)001
       fmmlud002 LIKE fmml_t.fmmlud002, #自定義欄位(文字)002
       fmmlud003 LIKE fmml_t.fmmlud003, #自定義欄位(文字)003
       fmmlud004 LIKE fmml_t.fmmlud004, #自定義欄位(文字)004
       fmmlud005 LIKE fmml_t.fmmlud005, #自定義欄位(文字)005
       fmmlud006 LIKE fmml_t.fmmlud006, #自定義欄位(文字)006
       fmmlud007 LIKE fmml_t.fmmlud007, #自定義欄位(文字)007
       fmmlud008 LIKE fmml_t.fmmlud008, #自定義欄位(文字)008
       fmmlud009 LIKE fmml_t.fmmlud009, #自定義欄位(文字)009
       fmmlud010 LIKE fmml_t.fmmlud010, #自定義欄位(文字)010
       fmmlud011 LIKE fmml_t.fmmlud011, #自定義欄位(數字)011
       fmmlud012 LIKE fmml_t.fmmlud012, #自定義欄位(數字)012
       fmmlud013 LIKE fmml_t.fmmlud013, #自定義欄位(數字)013
       fmmlud014 LIKE fmml_t.fmmlud014, #自定義欄位(數字)014
       fmmlud015 LIKE fmml_t.fmmlud015, #自定義欄位(數字)015
       fmmlud016 LIKE fmml_t.fmmlud016, #自定義欄位(數字)016
       fmmlud017 LIKE fmml_t.fmmlud017, #自定義欄位(數字)017
       fmmlud018 LIKE fmml_t.fmmlud018, #自定義欄位(數字)018
       fmmlud019 LIKE fmml_t.fmmlud019, #自定義欄位(數字)019
       fmmlud020 LIKE fmml_t.fmmlud020, #自定義欄位(數字)020
       fmmlud021 LIKE fmml_t.fmmlud021, #自定義欄位(日期時間)021
       fmmlud022 LIKE fmml_t.fmmlud022, #自定義欄位(日期時間)022
       fmmlud023 LIKE fmml_t.fmmlud023, #自定義欄位(日期時間)023
       fmmlud024 LIKE fmml_t.fmmlud024, #自定義欄位(日期時間)024
       fmmlud025 LIKE fmml_t.fmmlud025, #自定義欄位(日期時間)025
       fmmlud026 LIKE fmml_t.fmmlud026, #自定義欄位(日期時間)026
       fmmlud027 LIKE fmml_t.fmmlud027, #自定義欄位(日期時間)027
       fmmlud028 LIKE fmml_t.fmmlud028, #自定義欄位(日期時間)028
       fmmlud029 LIKE fmml_t.fmmlud029, #自定義欄位(日期時間)029
       fmmlud030 LIKE fmml_t.fmmlud030  #自定義欄位(日期時間)030
       END RECORD

#161128-00061#7---add---end-----------
DEFINE r_success       LIKE type_t.num5
DEFINE l_success       LIKE type_t.num5        #170509-00094#7 add
DEFINE l_slip          LIKE ooba_t.ooba002     #170509-00094#7 add
   
   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE
   
   #1.定义CURSOR
   CALL s_voucher_gen_fm_1_def_cursor(p_ld,p_wc,p_sum_type,'',p_source) RETURNING g_sub_success
   IF NOT g_sub_success THEN
      RETURN r_success
   END IF
   
   DELETE FROM s_vr_tmp08;  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
   
   #2.插入临时表
   FOREACH s_voucher_gen_fm_8_cs INTO l_fmml.*
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach s_voucher_gen_fm_8_cs'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      
      #170509-00094#7---add---start---
      #取單別
      CALL s_aooi200_fin_get_slip(l_fmml.fmmldocno) RETURNING l_success,l_slip
      #紅字傳票
      CALL s_fin_get_doc_para(p_ld,'',l_slip,'D-FIN-1002') RETURNING g_dfin1002
      #170509-00094#7---add---end--- 
      
      #借:投資類型科目
      CALL s_voucher_gen_fm_3_ins_tmp('81',l_fmml.fmml003,l_fmml.fmmldocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      
      #貸:支付方式科目
      CALL s_voucher_gen_fm_3_ins_tmp('82',l_fmml.fmml003,l_fmml.fmmldocno)
           RETURNING g_sub_success
      IF NOT g_sub_success THEN RETURN r_success END IF
      
   END FOREACH
   
   #3.按科目设置进行UPDATE,若有做不管理的字段,UPDATE至' '
   CALL s_voucher_gen_fm_1_upd_tmp(p_ld)
        RETURNING g_sub_success
   IF NOT g_sub_success THEN
      RETURN r_success
   END IF
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION
################################################################################
# Descriptions...: 处理借方科目及金额等
# Memo...........:
# Usage..........: CALL s_voucher_gen_fm_1_ins_tmp(p_fmay003,p_fmay002)
#                  RETURNING r_success
# Input parameter: p_nmbsld       帐套
#                : p_nmbsdocno    应收帐款单号
# Return code....: r_success      成功否标识位
# Date & Author..: 2014/10/20 By jingll
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_fm_1_ins_tmp(p_fmay003,p_fmay002)
   DEFINE p_fmay003        LIKE fmay_t.fmay003  #帳套
   DEFINE p_fmay002        LIKE fmay_t.fmay002  #單號
   DEFINE r_success        LIKE type_t.num5
#yangtt--2016/03/15--mark--str--
#   DEFINE l_tmp            RECORD 
#                           docno    LIKE glaq_t.glaqdocno,
#                           docdt    LIKE glap_t.glapdocdt,
#                           sw       LIKE type_t.chr1,     
#                           glaqent  LIKE glaq_t.glaqent,  
#                           glaqcomp LIKE glaq_t.glaqcomp, 
#                           glaqld   LIKE glaq_t.glaqld,   
#                           glaq001  LIKE glaq_t.glaq001,  
#                           glaq002  LIKE glaq_t.glaq002,  
#                           glaq005  LIKE glaq_t.glaq005,  #幣別
#                           glaq006  LIKE glaq_t.glaq006,  #匯率
#                           glaq007  LIKE glaq_t.glaq007,  
#                           glaq009  LIKE glaq_t.glaq009, 
#                           glaq010  LIKE glaq_t.glaq010,  #原幣金額                           
#                           glaq011  LIKE glaq_t.glaq011,  
#                           glaq012  LIKE glaq_t.glaq012,  
#                           glaq013  LIKE glaq_t.glaq013,  
#                           glaq014  LIKE glaq_t.glaq014,  
#                           glaq015  LIKE glaq_t.glaq015,  
#                           glaq016  LIKE glaq_t.glaq016,  
#                           glaq017  LIKE glaq_t.glaq017,  
#                           glaq018  LIKE glaq_t.glaq018,  
#                           glaq019  LIKE glaq_t.glaq019,  
#                           glaq020  LIKE glaq_t.glaq020,  
#                           glaq021  LIKE glaq_t.glaq021,  
#                           glaq022  LIKE glaq_t.glaq022,  
#                           glaq023  LIKE glaq_t.glaq023,  
#                           glaq024  LIKE glaq_t.glaq024,  
#                           glaq025  LIKE glaq_t.glaq025,  
#                          #glaq026  LIKE glaq_t.glaq026,  #151112-00009#3 mark
#                           glaq027  LIKE glaq_t.glaq027,  
#                           glaq028  LIKE glaq_t.glaq028, 
#                           glaq051  LIKE glaq_t.glaq051,  #經營方式
#                           glaq052  LIKE glaq_t.glaq052,  #渠道 
#                           glaq053  LIKE glaq_t.glaq053,  #品牌                           
#                           glaq029  LIKE glaq_t.glaq029,  
#                           glaq030  LIKE glaq_t.glaq030,  
#                           glaq031  LIKE glaq_t.glaq031,  
#                           glaq032  LIKE glaq_t.glaq032,  
#                           glaq033  LIKE glaq_t.glaq033,  
#                           glaq034  LIKE glaq_t.glaq034,  
#                           glaq035  LIKE glaq_t.glaq035,  
#                           glaq036  LIKE glaq_t.glaq036,  
#                           glaq037  LIKE glaq_t.glaq037,  
#                           glaq038  LIKE glaq_t.glaq038,                      
#                           d        LIKE glaq_t.glaq003,  
#                           c        LIKE glaq_t.glaq004,  
#                           qty      LIKE glaq_t.glaq008,  
#                           sum      LIKE glaq_t.glaq010,
#                           glaq039  LIKE glaq_t.glaq039,
#                           glaq040  LIKE glaq_t.glaq040,
#                           glaq041  LIKE glaq_t.glaq041,
#                           glaq042  LIKE glaq_t.glaq042,
#                           glaq043  LIKE glaq_t.glaq043,
#                           glaq044  LIKE glaq_t.glaq044,
#                           seq      LIKE glaq_t.glaqseq, #項次一
#                           source   LIKE type_t.chr100,
#                           glaqseq  LIKE glaq_t.glaqseq, 
#                           seq2     LIKE glaq_t.glaqseq, #項次二
#                           state    LIKE type_t.chr1,    #單據性質  
#                           year1    LIKE type_t.num5,    #年度
#                           month1   LIKE type_t.num5,    #期別
#                           xrca039  LIKE xrca_t.xrca039, #會計檢核附件份數  #150429-00010#14
#                           glgb055  LIKE glgb_t.glgb055  #現金變動碼       #150429-00010#14
#                           END RECORD
#  DEFINE l_fmbe012       LIKE fmbe_t.fmbe012
#  DEFINE l_fmbe051       LIKE fmbe_t.fmbe051
#  DEFINE l_fmbe008       LIKE fmbe_t.fmbe008
#  DEFINE l_fmbe009       LIKE fmbe_t.fmbe009
#  DEFINE l_fmbe010       LIKE fmbe_t.fmbe010
#  DEFINE l_fmbe011       LIKE fmbe_t.fmbe011
#  DEFINE l_fmbe014       LIKE fmbe_t.fmbe014
#  DEFINE l_fmbe016       LIKE fmbe_t.fmbe016
#  DEFINE l_glac016       LIKE glac_t.glac016     #150814-00006#3 add 
#  DEFINE l_glaa004       LIKE glaa_t.glaa004     #150814-00006#3 add
#   
#   WHENEVER ERROR CONTINUE    
#
#   LET r_success = FALSE                        
#   INITIALIZE l_tmp.* TO NULL                                       
#   #150814-00006#3--add--str--
#   SELECT glaa004,glaa005 INTO l_glaa004 FROM glaa_t
#    WHERE glaaent = g_enterprise AND glaald = p_fmay003
#   #150814-00006#3--add--end 
#   
#   FOREACH s_voucher_gen_fm_1_cs1 USING p_fmay002 INTO l_tmp.*,l_fmbe012,l_fmbe051  #來源單號，項次,還款科目，對方科目
#   
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 'foreach s_voucher_gen_fm_1_cs1'
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#
#         RETURN r_success
#      END IF
#      LET l_fmbe008 = l_tmp.glaq005 #幣別
#      LET l_fmbe010 = l_tmp.glaq006 #匯率
#      LET l_fmbe009 = l_tmp.glaq010 #原幣金額
#      LET l_fmbe011 = l_tmp.d       #本幣一金額
#      LET l_fmbe014 = l_tmp.glaq040 #本幣二金額
#      LET l_fmbe016 = l_tmp.glaq043 #本幣三金額
#      
#      #借放
#      LET l_tmp.glaq002 = l_fmbe051   #科目
#      LET l_tmp.glaq005 = l_fmbe008   #幣別
#      LET l_tmp.glaq006 = l_fmbe010   #匯率
#      LET l_tmp.glaq010 = l_fmbe009   #原幣金額
#      LET l_tmp.d = l_fmbe011         #借方金額一
#      LET l_tmp.glaq040 = l_fmbe014   #借方二金額 
#      LET l_tmp.glaq043 = l_fmbe016   #借方三金額        
#      LET l_tmp.c = 0                 #貸方金額
#      LET l_tmp.glaq041 = 0           #貸方金額二
#      LET l_tmp.glaq044 = 0           #貸方金額三
#            
#      SELECT MAX(seq2) + 1 INTO l_tmp.seq2 FROM s_voucher_fm_tmp WHERE docno = l_tmp.docno AND glaqld = l_tmp.glaqld
#                                                                   AND    seq = l_tmp.seq
#      IF cl_null(l_tmp.seq2) THEN
#         LET l_tmp.seq2 = 1
#      END IF 
#      #150814-00006#3--add--str--
#      #现金变动码预设值
#      CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
#      IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
#         CALL s_voucher_glad006_get(p_fmay003,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
#      END IF 
#      #150814-00006#3--add--end
#      INSERT INTO s_voucher_fm_tmp VALUES(l_tmp.*)
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 'insert s_voucher_fm_tmp'
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#
#         RETURN r_success                   
#      END IF               
#      
#      #貸方
#      LET l_tmp.glaq002 = l_fmbe012   #科目
#      LET l_tmp.glaq005 = l_fmbe008   #幣別
#      LET l_tmp.glaq006 = l_fmbe010   #匯率
#      LET l_tmp.glaq010 = l_fmbe009   #原幣金額
#      LET l_tmp.d = 0                 #借方金額一
#      LET l_tmp.glaq040 = 0 
#      LET l_tmp.glaq043 = 0           
#      LET l_tmp.c = l_fmbe011          #貸方金額
#      LET l_tmp.glaq041 = l_fmbe014    #貸方金額二
#      LET l_tmp.glaq044 = l_fmbe016    #貸方金額三
#            
#      SELECT MAX(seq2) + 1 INTO l_tmp.seq2 FROM s_voucher_fm_tmp WHERE docno = l_tmp.docno AND glaqld = l_tmp.glaqld
#                                                                   AND    seq = l_tmp.seq
#      IF cl_null(l_tmp.seq2) THEN
#         LET l_tmp.seq2 = 1
#      END IF 
#      #150814-00006#3--add--str--
#      #现金变动码预设值
#      CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
#      IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
#         CALL s_voucher_glad006_get(p_fmay003,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
#      END IF 
#      #150814-00006#3--add--end
#      INSERT INTO s_voucher_fm_tmp VALUES(l_tmp.*)
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 'insert s_voucher_fm_tmp'
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#
#         RETURN r_success                   
#      END IF               
#   END FOREACH        
#         
#   LET r_success = TRUE
#yangtt--2016/03/15--mark--end--
   RETURN r_success
END FUNCTION
################################################################################
# Descriptions...: 自动产生凭证 - BY 科目的管理设置做UPDATE
# Memo...........:
# Usage..........: CALL s_voucher_gen_fm_1_upd_tmp(p_ld)
#                  RETURNING r_success
# Input parameter: p_ld           帐套
# Return code....: r_success      成功否标识位
# Date & Author..: 2014/10/20 By jingll
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_fm_1_upd_tmp(p_ld)
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE r_success       LIKE type_t.num5
   DEFINE l_ld            LIKE glaa_t.glaald
   DEFINE l_glaq002       LIKE glaq_t.glaq002
   DEFINE l_docno         LIKE glaq_t.glaqdocno
   DEFINE l_upd_field     LIKE type_t.chr1000
   DEFINE l_sql           LIKE type_t.chr1000
   DEFINE l_glad_r        RECORD 
                          glad005   LIKE glad_t.glad005,  #数量/金额管理否
                          glad007   LIKE glad_t.glad007,  #部门管理否
                          glad008   LIKE glad_t.glad008,  #利润成本管理否
                          glad009   LIKE glad_t.glad009,  #区域管理否
                          glad010   LIKE glad_t.glad010,  #交易客商管理否
                          glad011   LIKE glad_t.glad011,  #客群管理否
                          glad012   LIKE glad_t.glad012,  #产品类别管理否
                          glad013   LIKE glad_t.glad013,  #人员管理否
#                          glad014   LIKE glad_t.glad014,  #预算管理否
                          glad015   LIKE glad_t.glad015,  #专案管理否
                          glad016   LIKE glad_t.glad016,  #WBS管理否
                          glad017   LIKE glad_t.glad017,  #自由核算项1管理否
                          glad018   LIKE glad_t.glad018,  #自由核算项2管理否
                          glad019   LIKE glad_t.glad019,  #自由核算项3管理否
                          glad020   LIKE glad_t.glad020,  #自由核算项4管理否
                          glad021   LIKE glad_t.glad021,  #自由核算项5管理否
                          glad022   LIKE glad_t.glad022,  #自由核算项6管理否
                          glad023   LIKE glad_t.glad023,  #自由核算项7管理否
                          glad024   LIKE glad_t.glad024,  #自由核算项8管理否
                          glad025   LIKE glad_t.glad025,  #自由核算项9管理否
                          glad026   LIKE glad_t.glad026,  #自由核算项10管理否   
                          glad027   LIKE glad_t.glad027,  #账款客商管理否 
                          glad031   LIKE glad_t.glad031,  #經營方式管理否
                          glad032   LIKE glad_t.glad032,  #渠道管理否
                          glad033   LIKE glad_t.glad033   #品牌管理否
                          END RECORD
   WHENEVER ERROR CONTINUE
   LET r_success = FALSE   
   
   FOREACH s_voucher_gen_fm_1_cs2 INTO l_docno,l_glaq002
       IF SQLCA.sqlcode THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code = SQLCA.sqlcode
          LET g_errparam.extend = 'foreach s_voucher_gen_nm_1_cs2'
          LET g_errparam.popup = TRUE
          CALL cl_err()

          RETURN r_success
       END IF  
       
       INITIALIZE l_glad_r.* TO NULL
       
       EXECUTE s_voucher_gen_fm_1_p3 USING l_glaq002 INTO l_glad_r.*

       LET l_upd_field = NULL
       IF l_glad_r.glad005 = 'N' OR cl_null(l_glad_r.glad005) THEN  #数量/金额不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq007 = ' ',qty = 0,glaq009 = 0"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq007 = ' ',glaq008 = 0,glaq009 = 0"
          END IF
       END IF
       IF l_glad_r.glad007 = 'N' OR cl_null(l_glad_r.glad007) THEN  #部门不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq018 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq018 = ' '"
          END IF
       END IF
       IF l_glad_r.glad008 = 'N' OR cl_null(l_glad_r.glad008) THEN  #利润成本不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq019 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq019 = ' '"
          END IF       
       END IF       

       IF l_glad_r.glad009 = 'N' OR cl_null(l_glad_r.glad009) THEN  #区域不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq020 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq020 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad010 = 'N' OR cl_null(l_glad_r.glad010) THEN  #交易客商不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq021 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq021 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad027 = 'N' OR cl_null(l_glad_r.glad027) THEN  #账款客商不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq022 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq022 = ' '"
          END IF       
       END IF
       IF l_glad_r.glad011 = 'N' OR cl_null(l_glad_r.glad011) THEN  #客群不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq023 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq023 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad012 = 'N' OR cl_null(l_glad_r.glad012) THEN  #产品类别不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq024 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq024 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad013 = 'N' OR cl_null(l_glad_r.glad013) THEN  #人员不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq025 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq025 = ' '"
          END IF       
       END IF        
#       IF l_glad_r.glad014 = 'N' OR cl_null(l_glad_r.glad014) THEN  #预算不管理
#          IF cl_null(l_upd_field) THEN
#             LET l_upd_field = "glaq026 = ' '"
#          ELSE
#             LET l_upd_field = l_upd_field CLIPPED,",glaq026 = ' '"
#          END IF       
#       END IF        
       IF l_glad_r.glad015 = 'N' OR cl_null(l_glad_r.glad015) THEN  #专案不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq027 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq027 = ' '"
          END IF       
       END IF        
       IF l_glad_r.glad016 = 'N' OR cl_null(l_glad_r.glad016) THEN  #WBS不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq028 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq028 = ' '"
          END IF       
       END IF
       #150429-00010#14 add ------
       IF l_glad_r.glad031 = 'N' OR cl_null(l_glad_r.glad031) THEN  #經營方式不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq051 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq051 = ' '"
          END IF
       END IF
       IF l_glad_r.glad032 = 'N' OR cl_null(l_glad_r.glad032) THEN  #渠道不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq052 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq052 = ' '"
          END IF
       END IF
       IF l_glad_r.glad033 = 'N' OR cl_null(l_glad_r.glad033) THEN  #品牌不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq053 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq053 = ' '"
          END IF
       END IF
       #150429-00010#14 add end---
       IF l_glad_r.glad017 = 'N' OR cl_null(l_glad_r.glad017) THEN  #自由核算项1不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq029 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq029 = ' '"
          END IF       
       END IF        
       IF l_glad_r.glad018 = 'N' OR cl_null(l_glad_r.glad018) THEN  #自由核算项2不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq030 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq030 = ' '"
          END IF       
       END IF        
       IF l_glad_r.glad019 = 'N' OR cl_null(l_glad_r.glad019) THEN  #自由核算项3不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq031 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq031 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad020 = 'N' OR cl_null(l_glad_r.glad020) THEN  #自由核算项4不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq032 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq032 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad021 = 'N' OR cl_null(l_glad_r.glad021) THEN  #自由核算项5不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq033 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq033 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad022 = 'N' OR cl_null(l_glad_r.glad022) THEN  #自由核算项6不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq034 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq034 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad023 = 'N' OR cl_null(l_glad_r.glad023) THEN  #自由核算项7不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq035 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq035 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad024 = 'N' OR cl_null(l_glad_r.glad024) THEN  #自由核算项8不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq036 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq036 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad025 = 'N' OR cl_null(l_glad_r.glad025) THEN  #自由核算项9不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq037 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq037 = ' '"
          END IF       
       END IF        
       IF l_glad_r.glad026 = 'N' OR cl_null(l_glad_r.glad026) THEN  #自由核算项10不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq038 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq038 = ' '"
          END IF       
       END IF   
       
       IF NOT cl_null(l_upd_field) THEN
          LET l_sql = "UPDATE s_vr_tmp08 SET ",l_upd_field,  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
                      " WHERE glaqld  = '",p_ld CLIPPED,"'",
                      "   AND glaq002 = '",l_glaq002,"'"
          PREPARE s_voucher_gen_fm_1_upd_tmp_p1 FROM l_sql
          IF SQLCA.sqlcode THEN
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = SQLCA.sqlcode
             LET g_errparam.extend = 's_voucher_gen_fm_1_upd_tmp_p1'
             LET g_errparam.popup = TRUE
             CALL cl_err()

             RETURN r_success
          END IF
          EXECUTE s_voucher_gen_fm_1_upd_tmp_p1
          IF SQLCA.sqlcode THEN
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = SQLCA.sqlcode
             LET g_errparam.extend = 'execute s_voucher_gen_fm_1_upd_tmp_p1'
             LET g_errparam.popup = TRUE
             CALL cl_err()

             RETURN r_success
          END IF
       END IF

   END FOREACH
   
   LET r_success = TRUE
   RETURN r_success    
END FUNCTION
################################################################################
# Descriptions...: 自动生成凭证 - 产生凭证单头
# Memo...........:
# Usage..........: CALL s_voucher_gen_fm_1_ins_glap(p_slip,p_date,p_ld,p_source)
#                       RETURNING r_success,r_start_no,r_end_no
# Input parameter: p_slip         凭证单别
#                : p_date         傳票日期
#                : p_ld           帳套
#                : p_source       來源
# Return code....: r_success      成功否标识位
#                : r_start_no     生成的起始凭证单号
#                : r_end_no       生成的截止凭证单号
# Date & Author..: 2014/10/20 By jingll
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_fm_1_ins_glap(p_slip,p_date,p_ld,p_source)
DEFINE p_slip           LIKE ooba_t.ooba002
DEFINE p_ld             LIKE glaa_t.glaald
DEFINE p_sum_type       LIKE type_t.chr1
DEFINE p_source         LIKE type_t.chr10
DEFINE p_date           LIKE glap_t.glapdocdt
DEFINE r_success        LIKE type_t.num5
DEFINE r_start_no       LIKE glap_t.glapdocno
DEFINE r_end_no         LIKE glap_t.glapdocno
 #161128-00061#7---add---begin-----------
   #DEFINE l_glap          RECORD LIKE glap_t.*
   DEFINE l_glap RECORD  #傳票憑證單頭檔
       glapent LIKE glap_t.glapent, #企業編號
       glapld LIKE glap_t.glapld, #帳套
       glapcomp LIKE glap_t.glapcomp, #法人
       glapdocno LIKE glap_t.glapdocno, #單號
       glapdocdt LIKE glap_t.glapdocdt, #單據日期
       glap001 LIKE glap_t.glap001, #傳票性質
       glap002 LIKE glap_t.glap002, #會計年度
       glap003 LIKE glap_t.glap003, #會計季別
       glap004 LIKE glap_t.glap004, #會計期別
       glap005 LIKE glap_t.glap005, #會計周別
       glap006 LIKE glap_t.glap006, #收支科目
       glap007 LIKE glap_t.glap007, #來源碼
       glap008 LIKE glap_t.glap008, #帳款類型
       glap009 LIKE glap_t.glap009, #總號
       glap010 LIKE glap_t.glap010, #借方總金額
       glap011 LIKE glap_t.glap011, #貸方總金額
       glap012 LIKE glap_t.glap012, #列印次數
       glap013 LIKE glap_t.glap013, #附件張數
       glap014 LIKE glap_t.glap014, #外幣憑證否
       glap015 LIKE glap_t.glap015, #原傳票編號
       glap016 LIKE glap_t.glap016, #來源帳套編號
       glap017 LIKE glap_t.glap017, #來源傳票編號
       glapownid LIKE glap_t.glapownid, #資料所有者
       glapowndp LIKE glap_t.glapowndp, #資料所屬部門
       glapcrtid LIKE glap_t.glapcrtid, #資料建立者
       glapcrtdp LIKE glap_t.glapcrtdp, #資料建立部門
       glapcrtdt LIKE glap_t.glapcrtdt, #資料創建日
       glapmodid LIKE glap_t.glapmodid, #資料修改者
       glapmoddt LIKE glap_t.glapmoddt, #最近修改日
       glapcnfid LIKE glap_t.glapcnfid, #資料確認者
       glapcnfdt LIKE glap_t.glapcnfdt, #資料確認日
       glappstid LIKE glap_t.glappstid, #資料過帳者
       glappstdt LIKE glap_t.glappstdt, #資料過帳日
       glapstus LIKE glap_t.glapstus, #狀態碼
       glapud001 LIKE glap_t.glapud001, #自定義欄位(文字)001
       glapud002 LIKE glap_t.glapud002, #自定義欄位(文字)002
       glapud003 LIKE glap_t.glapud003, #自定義欄位(文字)003
       glapud004 LIKE glap_t.glapud004, #自定義欄位(文字)004
       glapud005 LIKE glap_t.glapud005, #自定義欄位(文字)005
       glapud006 LIKE glap_t.glapud006, #自定義欄位(文字)006
       glapud007 LIKE glap_t.glapud007, #自定義欄位(文字)007
       glapud008 LIKE glap_t.glapud008, #自定義欄位(文字)008
       glapud009 LIKE glap_t.glapud009, #自定義欄位(文字)009
       glapud010 LIKE glap_t.glapud010, #自定義欄位(文字)010
       glapud011 LIKE glap_t.glapud011, #自定義欄位(數字)011
       glapud012 LIKE glap_t.glapud012, #自定義欄位(數字)012
       glapud013 LIKE glap_t.glapud013, #自定義欄位(數字)013
       glapud014 LIKE glap_t.glapud014, #自定義欄位(數字)014
       glapud015 LIKE glap_t.glapud015, #自定義欄位(數字)015
       glapud016 LIKE glap_t.glapud016, #自定義欄位(數字)016
       glapud017 LIKE glap_t.glapud017, #自定義欄位(數字)017
       glapud018 LIKE glap_t.glapud018, #自定義欄位(數字)018
       glapud019 LIKE glap_t.glapud019, #自定義欄位(數字)019
       glapud020 LIKE glap_t.glapud020, #自定義欄位(數字)020
       glapud021 LIKE glap_t.glapud021, #自定義欄位(日期時間)021
       glapud022 LIKE glap_t.glapud022, #自定義欄位(日期時間)022
       glapud023 LIKE glap_t.glapud023, #自定義欄位(日期時間)023
       glapud024 LIKE glap_t.glapud024, #自定義欄位(日期時間)024
       glapud025 LIKE glap_t.glapud025, #自定義欄位(日期時間)025
       glapud026 LIKE glap_t.glapud026, #自定義欄位(日期時間)026
       glapud027 LIKE glap_t.glapud027, #自定義欄位(日期時間)027
       glapud028 LIKE glap_t.glapud028, #自定義欄位(日期時間)028
       glapud029 LIKE glap_t.glapud029, #自定義欄位(日期時間)029
       glapud030 LIKE glap_t.glapud030  #自定義欄位(日期時間)030
       END RECORD

   #161128-00061#7---add---end-----------
DEFINE l_glaqent        LIKE glaq_t.glaqent
DEFINE l_glaqld         LIKE glaq_t.glaqld
DEFINE l_glaqcomp       LIKE glaq_t.glaqcomp
DEFINE l_docno          LIKE glap_t.glapdocno
DEFINE l_docdt          LIKE glap_t.glapdocdt
DEFINE l_glaq021        LIKE glaq_t.glaq021
DEFINE l_success        LIKE type_t.num5
DEFINE l_ooef008        LIKE ooef_t.ooef008
DEFINE l_ooef010        LIKE ooef_t.ooef010
DEFINE l_glaa001        LIKE glaa_t.glaa001
 DEFINE l_fmbe008        LIKE fmbe_t.fmbe008  #幣別  
#150429-00010#14 add ------
DEFINE l_sql            STRING
DEFINE l_cnt            LIKE type_t.num5
DEFINE l_date           LIKE glap_t.glapdocdt
DEFINE l_prog           LIKE type_t.chr10
DEFINE l_glca002        LIKE glca_t.glca002
DEFINE l_glaq003        LIKE glaq_t.glaq003  #借方金額
DEFINE l_glaq004        LIKE glaq_t.glaq004  #貸方金額
DEFINE l_glaa024        LIKE glaa_t.glaa024
DEFINE l_glaa100        LIKE glaa_t.glaa100
DEFINE l_glaa102        LIKE glaa_t.glaa102
#150429-00010#14 add end---
DEFINE l_glap007        LIKE glap_t.glap007  #150829 來源類型
   
   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE
   LET r_start_no = NULL
   LET r_end_no   = NULL
   
   #150429-00010#14 add ------
   CASE p_source
        WHEN 'afmt570'
            SELECT (CASE WHEN glca002 = '2' THEN 'Y' ELSE 'N' END) INTO l_glca002
              FROM glca_t
             WHERE glcaent = g_enterprise
               AND glcald  = p_ld AND glca001 = 'FM'
   END CASE
   IF l_glca002 = 'Y' THEN
      LET l_prog = 'aglt350'
      LET l_glap007 = 'AC'   #150829
   ELSE
      LET l_prog = 'aglt310'
      LET l_glap007 = 'FM'  #150829
   END IF   
   #150429-00010#14 add end---
   
   
   #1.定义CURSOR
   CALL s_voucher_gen_fm_1_def_cursor(p_ld,'','','',p_source) RETURNING l_success
   IF NOT l_success THEN
      RETURN r_success,r_start_no,r_end_no  
   END IF

   #150429-00010#14 add ------
   SELECT glaa100,glaa024,glaa102 INTO l_glaa100,l_glaa024,l_glaa102 FROM glaa_t WHERE glaaent = g_enterprise AND glaald = p_ld
   
   IF l_glaa100 = 'Y' THEN
      #161207-00051#1--mark--str--lujh
      #DELETE FROM s_fin_tmp  #160727-00019#31  2016/08/10  By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
      #CALL s_fin_continue_no_ins(p_ld,l_glaa024,p_slip,p_date,'3') RETURNING g_sub_success,g_errno
      #161207-00051#1--mark--str--lujh 
       
      DELETE FROM s_fin_tmp  #160727-00019#31  2016/08/10  By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
      IF NOT cl_null(p_date) THEN   #彙總類型是3的 p_date必傳
         CALL s_fin_continue_no_ins(p_ld,l_glaa024,p_slip,p_date,'3') RETURNING g_sub_success,g_errno
      ELSE
         LET l_sql = " SELECT DISTINCT docdt FROM s_vr_tmp08  "  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
         PREPARE continue_no_fm_pb1 FROM l_sql
         DECLARE continue_no_fm_cs1 CURSOR FOR continue_no_fm_pb1
         FOREACH continue_no_fm_cs1 INTO l_date
            CALL s_fin_continue_no_ins(p_ld,l_glaa024,p_slip,l_date,'3') RETURNING g_sub_success,g_errno
         END FOREACH
      END IF
   END IF
   LET l_sql = " SELECT docno FROM s_fin_tmp WHERE isuse = 'N' ORDER BY docno"  #160727-00019#31  2016/08/10  By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
   PREPARE continue_no_fm_pb2 FROM l_sql
   DECLARE continue_no_fm_cs2 CURSOR FOR continue_no_fm_pb2
   #150429-00010#14 add end---
   
   #若p_date不为空时,则表示凭证日期均为p_date
   IF NOT cl_null(p_date) THEN
      UPDATE s_vr_tmp08 SET docdt = p_date  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'update docdt'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success,r_start_no,r_end_no  
      END IF
   END IF
  
   #150429-00010#14 add ------
   #會計科目不可為空
   #LET l_sql = "SELECT COUNT(*) FROM s_vr_tmp08 ",  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08 #170615-00061#25 mark
   LET l_sql = "SELECT COUNT(1) FROM s_vr_tmp08 ",   #170615-00061#25 add                                            
               " WHERE glaq002 IS NULL"
   PREPARE chk_glaq002_pre FROM l_sql
   EXECUTE chk_glaq002_pre INTO l_cnt
   IF l_cnt > 0 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code   = 'axr-00068'
      LET g_errparam.extend = ''
      CALL cl_err()
      RETURN r_success,r_start_no,r_end_no
   END IF
   
   SELECT SUM(CASE WHEN c IS NULL THEN 0 ELSE c END),
          SUM(CASE WHEN d IS NULL THEN 0 ELSE d END)
     INTO l_glaq003,l_glaq004
     FROM s_vr_tmp08   #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
   #借貸金額
   IF cl_null(l_glaq003) THEN LET l_glaq003 = 0  END IF
   IF cl_null(l_glaq004) THEN LET l_glaq004 = 0  END IF
  #IF NOT (l_glaq003 > 0) THEN   #借方金額不可為0或為負數  #151120-00004#1
   IF l_glaq003 = 0 THEN         #借方金額不可為0         #151120-00004#1
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code   = 'aap-00076'
      LET g_errparam.extend = ''
      CALL cl_err()
      RETURN r_success,r_start_no,r_end_no
   END IF
  #IF NOT (l_glaq004 > 0) THEN   #貸方金額不可為0或為負數  #151120-00004#1 mark
   IF l_glaq004 = 0 THEN         #借方金額不可為0         #151120-00004#1      
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code   = 'aap-00076'
      LET g_errparam.extend = ''
      CALL cl_err()
      RETURN r_success,r_start_no,r_end_no
   END IF
   IF l_glaq003 <> l_glaq004 THEN   #依據借貸不平衡時,若為 1.不能拋 2.拋過去由總帳修改
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code   = 'agl-00250'
      LET g_errparam.extend = ''
      CALL cl_err()
      IF l_glaa102 = '1' THEN 
         RETURN r_success,r_start_no,r_end_no
      END IF
   END IF
   #150429-00010#14 add end---
   
   FOREACH s_voucher_gen_fm_1_cs4 INTO l_glaqcomp,l_docno,l_docdt
      IF SQLCA.sqlcode THEN  
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_1_cs4'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success,r_start_no,r_end_no
      END IF
      
      INITIALIZE l_glap.* TO NULL
      SELECT ooef008,ooef010 INTO l_ooef008,l_ooef010 FROM ooef_t
       WHERE ooefent = g_enterprise
         AND ooef001 = l_glaqcomp
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'sel ooef'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         LET r_start_no = NULL
         LET r_end_no   = NULL
         RETURN r_success,r_start_no,r_end_no
      END IF
      
      #帳套主幣別
      SELECT glaa001 INTO l_glaa001 
        FROM glaa_t
       WHERE glaaent = g_enterprise
         AND glaald = p_ld
      #yangtt--2016/03/15--mark--str--
#      IF p_source = 'afmt075' THEN     
#         SELECT DISTINCT fmbe008 INTO l_fmbe008
#          FROM fmbe_t
#          WHERE fmbeent = g_enterprise
#            AND fmbe001 = l_docno
#      END IF
#            
#      IF p_source = 'afmt090' THEN     
#         SELECT DISTINCT fmbb011 INTO l_fmbe008
#          FROM fmbb_t
#          WHERE fmbbent = g_enterprise
#            AND fmbb008 = l_docno
#      END IF
      #yangtt--2016/03/15--mark--end--
      
      #150429-00010#14 add ------
      IF p_source = 'afmt570' THEN
         SELECT DISTINCT fmnb100 INTO l_fmbe008
          FROM fmnb_t
          WHERE fmnbent = g_enterprise
            AND fmnbdocno = l_docno
      END IF
      #150429-00010#14 add end---
      
      #140804-00008#13 add ------
      IF p_source = 'afmt555' THEN
         SELECT DISTINCT fmmr003 INTO l_fmbe008
          FROM fmmr_t
          WHERE fmmrent = g_enterprise
            AND fmmrdocno = l_docno
      END IF
      #140804-00008#13 add end---
      
      ##140804-00008#20 albireo 150520-s
      IF p_source = 'afmt595' THEN
         SELECT DISTINCT fmnf100 INTO l_fmbe008
          FROM fmnf_t
          WHERE fmnfent = g_enterprise
            AND fmnfdocno = l_docno
      END IF      
      ##140804-00008#20 albireo 150520-e
      
      ##140804-00008#18 Hans 150525-s
      IF p_source = 'afmt585' THEN
         SELECT DISTINCT fmmx100 INTO l_fmbe008
           FROM fmmx_t
          WHERE fmmxfent = g_enterprise
            AND fmmxdocno = l_docno
      END IF      
      ##140804-00008#18 Hans 150525-e
      
      #140804-00008#15 add ------
      IF p_source = 'afmt565' THEN
         SELECT DISTINCT fmng003 INTO l_fmbe008
           FROM fmng_t
          WHERE fmngent = g_enterprise
            AND fmngdocno = l_docno
      END IF
      #140804-00008#15 add end---
      
      #140804-00008#9 add ------
      IF p_source = 'afmt535' THEN
         SELECT DISTINCT fmmm007 INTO l_fmbe008
           FROM fmmm_t
          WHERE fmmment = g_enterprise
            AND fmmm001 = l_docno
      END IF
      #140804-00008#9 add end---
      
      ##150429-00010#14 mark ------
      ##自动编号
      #CALL s_aooi200_fin_gen_docno(p_ld,'','',p_slip,l_docdt,'aglt310') RETURNING l_success,l_glap.glapdocno
      #IF NOT l_success THEN
      #   LET r_start_no = NULL
      #   LET r_end_no   = NULL
      #   RETURN r_success,r_start_no,r_end_no
      #END IF
      ##150429-00010#14 mark end---
      
      #150429-00010#14 add ------
      #自动编号
      #凭证日期没有值,按单据日期来
      IF cl_null(p_date) THEN 
         LET l_glap.glapdocdt = l_docdt     # 單據日期
      ELSE
         LET l_glap.glapdocdt = p_date      # 單據日期
      END IF
      #SELECT count(*) INTO l_cnt #170615-00061#25 mark
      SELECT count(1) INTO l_cnt  #170615-00061#25 add
        FROM s_fin_tmp  #160727-00019#31  2016/08/10  By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
       WHERE isuse = 'N'
      IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
      IF l_cnt > 0 THEN
         FOREACH continue_no_fm_cs2 INTO l_glap.glapdocno
            UPDATE s_fin_tmp  #160727-00019#31  2016/08/10  By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
               SET isuse = 'Y'
             WHERE docno = l_glap.glapdocno
            #檢查是否號碼已被使用
            #SELECT count(*) INTO l_cnt        #170615-00061#25 mark
            SELECT count(glapdocno) INTO l_cnt #170615-00061#25 add
              FROM glap_t
             WHERE glapent = g_enterprise AND glapld = p_ld
               AND glapdocno=l_glap.glapdocno
            IF l_cnt = 0 THEN
               EXIT FOREACH
            END IF
         END FOREACH
         #假設整個單號都已被取用還是透過s_aooi200_fin_gen_docno取單號
         IF l_cnt > 0 THEN
            CALL s_aooi200_fin_gen_docno(p_ld,'','',p_slip,l_glap.glapdocdt,l_prog) RETURNING g_sub_success,l_glap.glapdocno
         END IF
      ELSE
         CALL s_aooi200_fin_gen_docno(p_ld,'','',p_slip,l_glap.glapdocdt,l_prog) RETURNING g_sub_success,l_glap.glapdocno
      END IF
      #150429-00010#14 add end---
      
      
      #处理起始单号,截止单号
      IF cl_null(r_start_no) THEN LET r_start_no = l_glap.glapdocno END IF
      LET r_end_no   = l_glap.glapdocno 
      
      LET l_glap.glapent   =  g_enterprise  # 企業代碼
      LET l_glap.glapld    =  p_ld          # 帳別
      LET l_glap.glapcomp  =  l_glaqcomp    # 法人
      LET l_glap.glapdocdt =  l_docdt       # 單據日期
      LET l_glap.glap001   = '1'            # 傳票性質
      
      # 會計年度/會計期別/會計季別/會計周別
      SELECT oogc015,oogc006,oogc007,oogc008 INTO l_glap.glap002,l_glap.glap004,l_glap.glap003,l_glap.glap005
        FROM oogc_t
       WHERE oogcent = g_enterprise
         AND oogc001 = l_ooef008
         AND oogc002 = l_ooef010
         AND oogc003 = l_glap.glapdocdt
      
      LET l_glap.glap006   =  ''         # 收支科目
     #LET l_glap.glap007   =  'FM'       # 來源碼   #150829 mark
      LET l_glap.glap007   =  l_glap007  # 來源碼   #150829
     #LET l_glap.glap008   =  p_source   # 帳款類型 #150429-00010#14 mark
      #150429-00010#14 add ------
      #帳款類型
      CASE p_source
         WHEN 'afmt570'
            LET l_glap.glap008  = 'M10'
         WHEN 'afmt555'
            LET l_glap.glap008  = 'M30'
         WHEN 'afmt595'
            LET l_glap.glap008  = 'M60'
         WHEN 'afmt585'
            LET l_glap.glap008  = 'M50'
         #140804-00008#15 add ------
         WHEN 'afmt565'
            LET l_glap.glap008  = 'M40'
         #140804-00008#15 add end---
         #140804-00008#9 add ------
         WHEN 'afmt535'
            LET l_glap.glap008  = 'M20'
         #140804-00008#9 add end---
         OTHERWISE
            LET l_glap.glap008  = p_source
      END CASE
      #150429-00010#14 add end---
      LET l_glap.glap009   =  0          # 總號
      LET l_glap.glap010   =  0          # 借方總金額
      LET l_glap.glap011   =  0          # 貸方總金額
      LET l_glap.glap012   =  0          # 列印次數
      LET l_glap.glap013   =  0          # 附件張數
      IF l_glaa001 = l_fmbe008 THEN    #幣別 
         LET l_glap.glap014   =  'N'        # 外幣憑證否
      ELSE
         LET l_glap.glap014   =  'Y'        # 外幣憑證否
      END IF
      LET l_glap.glap015   =  ''         # 原傳票編號
      LET l_glap.glap016   =  ''         # 來源帳別編號
      LET l_glap.glap017   =  ''         # 來源傳票編號
      LET l_glap.glapownid =  g_user     # 資料所有者
      LET l_glap.glapowndp =  g_dept     # 資料所屬部門
      LET l_glap.glapcrtid =  g_user     # 資料建立者
      LET l_glap.glapcrtdp =  g_dept     # 資料建立部門
      LET l_glap.glapcrtdt =  cl_get_current()  # 資料創建日
      LET l_glap.glapmodid =  ''         # 資料修改者
      LET l_glap.glapmoddt =  ''         # 最近修改日
      LET l_glap.glapcnfid =  ''         # 資料確認者
      LET l_glap.glapcnfdt =  ''         # 資料確認日
      LET l_glap.glappstid =  ''         # 資料過帳者
      LET l_glap.glappstdt =  ''         # 資料過帳日
      LET l_glap.glapstus  =  'N'        # 狀態碼

       #161128-00061#7---add---begin-----------
      #INSERT INTO glap_t VALUES(l_glap.*)
      INSERT INTO glap_t (glapent,glapld,glapcomp,glapdocno,glapdocdt,glap001,glap002,glap003,glap004,
                          glap005,glap006,glap007,glap008,glap009,glap010,glap011,glap012,glap013,glap014,
                          glap015,glap016,glap017,glapownid,glapowndp,glapcrtid,glapcrtdp,glapcrtdt,
                          glapmodid,glapmoddt,glapcnfid,glapcnfdt,glappstid,glappstdt,glapstus,
                          glapud001,glapud002,glapud003,glapud004,glapud005,glapud006,glapud007,glapud008,
                          glapud009,glapud010,glapud011,glapud012,glapud013,glapud014,glapud015,glapud016,
                          glapud017,glapud018,glapud019,glapud020,glapud021,glapud022,glapud023,glapud024,
                          glapud025,glapud026,glapud027,glapud028,glapud029,glapud030)
       VALUES(l_glap.glapent,l_glap.glapld,l_glap.glapcomp,l_glap.glapdocno,l_glap.glapdocdt,l_glap.glap001,l_glap.glap002,l_glap.glap003,l_glap.glap004,
              l_glap.glap005,l_glap.glap006,l_glap.glap007,l_glap.glap008,l_glap.glap009,l_glap.glap010,l_glap.glap011,l_glap.glap012,l_glap.glap013,l_glap.glap014,
              l_glap.glap015,l_glap.glap016,l_glap.glap017,l_glap.glapownid,l_glap.glapowndp,l_glap.glapcrtid,l_glap.glapcrtdp,l_glap.glapcrtdt,
              l_glap.glapmodid,l_glap.glapmoddt,l_glap.glapcnfid,l_glap.glapcnfdt,l_glap.glappstid,l_glap.glappstdt,l_glap.glapstus,
              l_glap.glapud001,l_glap.glapud002,l_glap.glapud003,l_glap.glapud004,l_glap.glapud005,l_glap.glapud006,l_glap.glapud007,l_glap.glapud008,
              l_glap.glapud009,l_glap.glapud010,l_glap.glapud011,l_glap.glapud012,l_glap.glapud013,l_glap.glapud014,l_glap.glapud015,l_glap.glapud016,
              l_glap.glapud017,l_glap.glapud018,l_glap.glapud019,l_glap.glapud020,l_glap.glapud021,l_glap.glapud022,l_glap.glapud023,l_glap.glapud024,
              l_glap.glapud025,l_glap.glapud026,l_glap.glapud027,l_glap.glapud028,l_glap.glapud029,l_glap.glapud030)
      #161128-00061#7---add---end-----------
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'ins glap'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         LET r_start_no = NULL
         LET r_end_no   = NULL
         RETURN r_success,r_start_no,r_end_no         
      END IF
      
      #产生凭证单身
      CALL s_voucher_gen_fm_1_ins_glaq(l_glap.glapdocno,p_ld,l_glaqcomp,l_docno,l_docdt)
           RETURNING l_success
      IF NOT l_success THEN
         LET r_start_no = NULL
         LET r_end_no   = NULL
         RETURN r_success,r_start_no,r_end_no           
      END IF
  
   END FOREACH
   
   LET r_success = TRUE
   RETURN r_success,r_start_no,r_end_no
END FUNCTION
################################################################################
# Input parameter: p_glapdocno    凭证单号
#                : p_glaqent      企业编号
#                : p_glaqld       帐套
#                : p_glaqcomp     公司编号
#                : p_docno        来源单号
#                : p_docdt        凭证日期
# Return code....: r_success      成功否标识位
# Date & Author..: 2014/10/20 By jingll
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_fm_1_ins_glaq(p_glapdocno,p_glaqld,p_glaqcomp,p_docno,p_docdt)
DEFINE p_sum_type          LIKE type_t.chr1
   DEFINE p_glapdocno         LIKE glap_t.glapdocno
   DEFINE p_glaqent           LIKE glaq_t.glaqent
   DEFINE p_glaqld            LIKE glaq_t.glaqld
   DEFINE p_glaqcomp          LIKE glaq_t.glaqcomp
   DEFINE p_docno             LIKE glaq_t.glaqdocno
   DEFINE p_docdt             LIKE glap_t.glapdocdt
   DEFINE p_glaq021           LIKE glaq_t.glaq021
   DEFINE r_success           LIKE type_t.num5
   DEFINE l_value             LIKE type_t.chr50
   #161128-00061#7---add---begin-----------
   #DEFINE l_glaq              RECORD LIKE glaq_t.*
   DEFINE l_glaq RECORD  #傳票憑證單身檔
       glaqent LIKE glaq_t.glaqent, #企業編號
       glaqcomp LIKE glaq_t.glaqcomp, #法人
       glaqld LIKE glaq_t.glaqld, #帳套
       glaqdocno LIKE glaq_t.glaqdocno, #單號
       glaqseq LIKE glaq_t.glaqseq, #項次
       glaq001 LIKE glaq_t.glaq001, #摘要
       glaq002 LIKE glaq_t.glaq002, #科目編號
       glaq003 LIKE glaq_t.glaq003, #借方金額
       glaq004 LIKE glaq_t.glaq004, #貸方金額
       glaq005 LIKE glaq_t.glaq005, #交易幣別
       glaq006 LIKE glaq_t.glaq006, #匯率
       glaq007 LIKE glaq_t.glaq007, #計價單位
       glaq008 LIKE glaq_t.glaq008, #數量
       glaq009 LIKE glaq_t.glaq009, #單價
       glaq010 LIKE glaq_t.glaq010, #原幣金額
       glaq011 LIKE glaq_t.glaq011, #票據編碼
       glaq012 LIKE glaq_t.glaq012, #票據日期
       glaq013 LIKE glaq_t.glaq013, #申請人
       glaq014 LIKE glaq_t.glaq014, #銀行帳號
       glaq015 LIKE glaq_t.glaq015, #款別編號
       glaq016 LIKE glaq_t.glaq016, #收支專案
       glaq017 LIKE glaq_t.glaq017, #營運據點
       glaq018 LIKE glaq_t.glaq018, #部門
       glaq019 LIKE glaq_t.glaq019, #利潤/成本中心
       glaq020 LIKE glaq_t.glaq020, #區域
       glaq021 LIKE glaq_t.glaq021, #收付款客商
       glaq022 LIKE glaq_t.glaq022, #帳款客戶
       glaq023 LIKE glaq_t.glaq023, #客群
       glaq024 LIKE glaq_t.glaq024, #產品類別
       glaq025 LIKE glaq_t.glaq025, #人員
       glaq026 LIKE glaq_t.glaq026, #no use
       glaq027 LIKE glaq_t.glaq027, #專案編號
       glaq028 LIKE glaq_t.glaq028, #WBS
       glaq029 LIKE glaq_t.glaq029, #自由核算項一
       glaq030 LIKE glaq_t.glaq030, #自由核算項二
       glaq031 LIKE glaq_t.glaq031, #自由核算項三
       glaq032 LIKE glaq_t.glaq032, #自由核算項四
       glaq033 LIKE glaq_t.glaq033, #自由核算項五
       glaq034 LIKE glaq_t.glaq034, #自由核算項六
       glaq035 LIKE glaq_t.glaq035, #自由核算項七
       glaq036 LIKE glaq_t.glaq036, #自由核算項八
       glaq037 LIKE glaq_t.glaq037, #自由核算項九
       glaq038 LIKE glaq_t.glaq038, #自由核算項十
       glaq039 LIKE glaq_t.glaq039, #匯率(本位幣二)
       glaq040 LIKE glaq_t.glaq040, #借方金額(本位幣二)
       glaq041 LIKE glaq_t.glaq041, #貸方金額(本位幣二)
       glaq042 LIKE glaq_t.glaq042, #匯率(本位幣三)
       glaq043 LIKE glaq_t.glaq043, #借方金額(本位幣三)
       glaq044 LIKE glaq_t.glaq044, #貸方金額(本位幣三)
       glaq051 LIKE glaq_t.glaq051, #經營方式
       glaq052 LIKE glaq_t.glaq052, #通路
       glaq053 LIKE glaq_t.glaq053, #品牌
       glaqud001 LIKE glaq_t.glaqud001, #自定義欄位(文字)001
       glaqud002 LIKE glaq_t.glaqud002, #自定義欄位(文字)002
       glaqud003 LIKE glaq_t.glaqud003, #自定義欄位(文字)003
       glaqud004 LIKE glaq_t.glaqud004, #自定義欄位(文字)004
       glaqud005 LIKE glaq_t.glaqud005, #自定義欄位(文字)005
       glaqud006 LIKE glaq_t.glaqud006, #自定義欄位(文字)006
       glaqud007 LIKE glaq_t.glaqud007, #自定義欄位(文字)007
       glaqud008 LIKE glaq_t.glaqud008, #自定義欄位(文字)008
       glaqud009 LIKE glaq_t.glaqud009, #自定義欄位(文字)009
       glaqud010 LIKE glaq_t.glaqud010, #自定義欄位(文字)010
       glaqud011 LIKE glaq_t.glaqud011, #自定義欄位(數字)011
       glaqud012 LIKE glaq_t.glaqud012, #自定義欄位(數字)012
       glaqud013 LIKE glaq_t.glaqud013, #自定義欄位(數字)013
       glaqud014 LIKE glaq_t.glaqud014, #自定義欄位(數字)014
       glaqud015 LIKE glaq_t.glaqud015, #自定義欄位(數字)015
       glaqud016 LIKE glaq_t.glaqud016, #自定義欄位(數字)016
       glaqud017 LIKE glaq_t.glaqud017, #自定義欄位(數字)017
       glaqud018 LIKE glaq_t.glaqud018, #自定義欄位(數字)018
       glaqud019 LIKE glaq_t.glaqud019, #自定義欄位(數字)019
       glaqud020 LIKE glaq_t.glaqud020, #自定義欄位(數字)020
       glaqud021 LIKE glaq_t.glaqud021, #自定義欄位(日期時間)021
       glaqud022 LIKE glaq_t.glaqud022, #自定義欄位(日期時間)022
       glaqud023 LIKE glaq_t.glaqud023, #自定義欄位(日期時間)023
       glaqud024 LIKE glaq_t.glaqud024, #自定義欄位(日期時間)024
       glaqud025 LIKE glaq_t.glaqud025, #自定義欄位(日期時間)025
       glaqud026 LIKE glaq_t.glaqud026, #自定義欄位(日期時間)026
       glaqud027 LIKE glaq_t.glaqud027, #自定義欄位(日期時間)027
       glaqud028 LIKE glaq_t.glaqud028, #自定義欄位(日期時間)028
       glaqud029 LIKE glaq_t.glaqud029, #自定義欄位(日期時間)029
       glaqud030 LIKE glaq_t.glaqud030  #自定義欄位(日期時間)030
       END RECORD
   #161128-00061#7---add---end-----------
   DEFINE l_xrca039           LIKE xrca_t.xrca039
   DEFINE l_last_xrcadocno    LIKE xrca_t.xrcadocno
   DEFINE l_foreign           LIKE type_t.chr1
   DEFINE l_glaa001           LIKE glaa_t.glaa001
   DEFINE l_glap010           LIKE glap_t.glap010
   DEFINE l_glap011           LIKE glap_t.glap011
   DEFINE l_glad_r            RECORD 
                              glad005   LIKE glad_t.glad005,  #数量/金额管理否
                              glad007   LIKE glad_t.glad007,  #部门管理否
                              glad008   LIKE glad_t.glad008,  #利润成本管理否
                              glad009   LIKE glad_t.glad009,  #区域管理否
                              glad010   LIKE glad_t.glad010,  #交易客商管理否
                              glad011   LIKE glad_t.glad011,  #客群管理否
                              glad012   LIKE glad_t.glad012,  #产品类别管理否
                              glad013   LIKE glad_t.glad013,  #人员管理否
#                              glad014   LIKE glad_t.glad014,  #预算管理否
                              glad015   LIKE glad_t.glad015,  #专案管理否
                              glad016   LIKE glad_t.glad016,  #WBS管理否
                              glad017   LIKE glad_t.glad017,  #自由核算项1管理否
                              glad018   LIKE glad_t.glad018,  #自由核算项2管理否
                              glad019   LIKE glad_t.glad019,  #自由核算项3管理否
                              glad020   LIKE glad_t.glad020,  #自由核算项4管理否
                              glad021   LIKE glad_t.glad021,  #自由核算项5管理否
                              glad022   LIKE glad_t.glad022,  #自由核算项6管理否
                              glad023   LIKE glad_t.glad023,  #自由核算项7管理否
                              glad024   LIKE glad_t.glad024,  #自由核算项8管理否
                              glad025   LIKE glad_t.glad025,  #自由核算项9管理否
                              glad026   LIKE glad_t.glad026,  #自由核算项10管理否
                              glad027   LIKE glad_t.glad027,  #账款客商管理否
                              glad031   LIKE glad_t.glad031,  #經營方式管理否
                              glad032   LIKE glad_t.glad032,  #渠道管理否
                              glad033   LIKE glad_t.glad033   #品牌管理否
                              END RECORD
   DEFINE l_tmp               RECORD
                              docno    LIKE glaq_t.glaqdocno,
                              docdt    LIKE glap_t.glapdocdt,
                              sw       LIKE type_t.chr1,       #1.借  2.贷
                              glaqent  LIKE glaq_t.glaqent,
                              glaqcomp LIKE glaq_t.glaqcomp,
                              glaqld   LIKE glaq_t.glaqld,
                              glaq001  LIKE glaq_t.glaq001,
                              glaq002  LIKE glaq_t.glaq002,
                              glaq005  LIKE glaq_t.glaq005,
                              glaq006  LIKE glaq_t.glaq006,
                              glaq007  LIKE glaq_t.glaq007,
                              glaq009  LIKE glaq_t.glaq009,
                              glaq010  LIKE glaq_t.glaq010,  
                              glaq011  LIKE glaq_t.glaq011,
                              glaq012  LIKE glaq_t.glaq012,
                              glaq013  LIKE glaq_t.glaq013,
                              glaq014  LIKE glaq_t.glaq014,
                              glaq015  LIKE glaq_t.glaq015,
                              glaq016  LIKE glaq_t.glaq016,
                              glaq017  LIKE glaq_t.glaq017,
                              glaq018  LIKE glaq_t.glaq018,
                              glaq019  LIKE glaq_t.glaq019,
                              glaq020  LIKE glaq_t.glaq020,
                              glaq021  LIKE glaq_t.glaq021,
                              glaq022  LIKE glaq_t.glaq022,
                              glaq023  LIKE glaq_t.glaq023,
                              glaq024  LIKE glaq_t.glaq024,
                              glaq025  LIKE glaq_t.glaq025,
                             #glaq026  LIKE glaq_t.glaq026,  #151112-00009#3 mark
                              glaq027  LIKE glaq_t.glaq027,
                              glaq028  LIKE glaq_t.glaq028,
                              glaq051  LIKE glaq_t.glaq051,  #經營方式
                              glaq052  LIKE glaq_t.glaq052,  #渠道
                              glaq053  LIKE glaq_t.glaq053,  #品牌
                              glaq029  LIKE glaq_t.glaq029,
                              glaq030  LIKE glaq_t.glaq030,
                              glaq031  LIKE glaq_t.glaq031,
                              glaq032  LIKE glaq_t.glaq032,
                              glaq033  LIKE glaq_t.glaq033,
                              glaq034  LIKE glaq_t.glaq034,
                              glaq035  LIKE glaq_t.glaq035,
                              glaq036  LIKE glaq_t.glaq036,
                              glaq037  LIKE glaq_t.glaq037,
                              glaq038  LIKE glaq_t.glaq038,
                              d        LIKE glaq_t.glaq003,
                              c        LIKE glaq_t.glaq004,
                              qty      LIKE glaq_t.glaq008,
                              sum      LIKE glaq_t.glaq010,
                              glaq039  LIKE glaq_t.glaq039,
                              glaq040  LIKE glaq_t.glaq040,
                              glaq041  LIKE glaq_t.glaq041,
                              glaq042  LIKE glaq_t.glaq042,
                              glaq043  LIKE glaq_t.glaq043,
                              glaq044  LIKE glaq_t.glaq044,
                              seq      LIKE glaq_t.glaqseq,
                              source   LIKE type_t.chr100,
                              glaqseq  LIKE glaq_t.glaqseq,
                              #xrca039  LIKE xrca_t.xrca039,
                              seq2     LIKE glaq_t.glaqseq, #項次二          #150429-00010#14
                              state    LIKE type_t.chr1,    #單據性質
                              year1    LIKE type_t.num5,    #年度
                              month1   LIKE type_t.num5,    #期別
                              xrca039  LIKE xrca_t.xrca039, #會計檢核附件份數 #150429-00010#14
                              glgb055  LIKE glgb_t.glgb055  #現金變動碼       #150429-00010#14
                              END RECORD
   DEFINE l_success           LIKE type_t.num5              #170103-00019#22
   
   WHENEVER ERROR CONTINUE
   LET r_success = FALSE
   
   
   SELECT glaa001 INTO l_glaa001 FROM glaa_t WHERE glaald = p_glaqld      
      AND glaaent = g_enterprise  #161206-00023#1 add
   
   LET l_xrca039 = 0  #附件张数
   LET l_foreign = 'N' #外币凭证否
   
   INITIALIZE l_tmp.* TO NULL
   LET l_last_xrcadocno = NULL
   FOREACH s_voucher_gen_fm_1_cs5 INTO l_tmp.*
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_1_cs5'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      INITIALIZE l_glaq.* TO NULL
      
      #汇总 附件张数 & update 来源单据的"抛转凭证单号"
      IF cl_null(l_last_xrcadocno) OR l_last_xrcadocno <> l_tmp.docno THEN
         #LET l_xrca039 = l_xrca039 + l_tmp.xrca039
         #
         EXECUTE s_voucher_gen_fm_1_p6 USING p_glapdocno,l_tmp.docno
         IF SQLCA.sqlcode THEN  
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = 's_voucher_gen_fm_1_p6'
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN r_success
         END IF
      END IF
      IF l_foreign = 'N' THEN
         IF l_tmp.glaq005 <> l_glaa001 THEN
            LET l_foreign = 'Y'
         END IF
      END IF
      
      LET l_glaq.glaqent   = l_tmp.glaqent    #企業代碼
      LET l_glaq.glaqcomp  = l_tmp.glaqcomp   #法人
      LET l_glaq.glaqld    = p_glaqld         #帳別
      LET l_glaq.glaqdocno = p_glapdocno      #單號
      #项次
      SELECT MAX(glaqseq) + 1 INTO l_glaq.glaqseq
        FROM glaq_t
       WHERE glaqent   = l_glaq.glaqent
         AND glaqld    = l_glaq.glaqld
         AND glaqdocno = l_glaq.glaqdocno
      IF cl_null(l_glaq.glaqseq) THEN
         LET l_glaq.glaqseq = 1
      END IF
      LET l_glaq.glaq001   = l_tmp.glaq001    #摘要
      LET l_glaq.glaq002   = l_tmp.glaq002    #科目編號
      LET l_glaq.glaq003   = l_tmp.d          #借方金額
      LET l_glaq.glaq004   = l_tmp.c          #貸方金額
      LET l_glaq.glaq005   = l_tmp.glaq005    #交易幣別
      LET l_glaq.glaq006   = l_tmp.glaq006    #匯率
      LET l_glaq.glaq007   = l_tmp.glaq007    #計價單位
      LET l_glaq.glaq008   = l_tmp.qty        #數量
      LET l_glaq.glaq009   = l_tmp.glaq009    #單價
     #LET l_glaq.glaq010   = l_tmp.sum        #原幣金額      170509-00094#7 mark
      LET l_glaq.glaq010   = l_tmp.glaq010    #原幣金額      170509-00094#7 add
      LET l_glaq.glaq011   = l_tmp.glaq011    #票據編碼
      LET l_glaq.glaq012   = l_tmp.glaq012    #票據日期
      LET l_glaq.glaq013   = l_tmp.glaq013    #申請人
      LET l_glaq.glaq014   = l_tmp.glaq014    #銀行帳號
      LET l_glaq.glaq015   = l_tmp.glaq015    #結算方式
      LET l_glaq.glaq016   = l_tmp.glaq016    #收支項目
      LET l_glaq.glaq017   = l_tmp.glaq017    #營運據點
      LET l_glaq.glaq018   = l_tmp.glaq018    #部門
      LET l_glaq.glaq019   = l_tmp.glaq019    #利潤/成本中心
      LET l_glaq.glaq020   = l_tmp.glaq020    #區域
      LET l_glaq.glaq021   = l_tmp.glaq021    #交易客商
      LET l_glaq.glaq022   = l_tmp.glaq022    #账款客商
      LET l_glaq.glaq023   = l_tmp.glaq023    #客群
      LET l_glaq.glaq024   = l_tmp.glaq024    #產品類別
      LET l_glaq.glaq025   = l_tmp.glaq025    #人員
     #LET l_glaq.glaq026   = l_tmp.glaq026    #預算編號  #151112-00009#3 mark
      LET l_glaq.glaq027   = l_tmp.glaq027    #專案編號
      LET l_glaq.glaq028   = l_tmp.glaq028    #WBS
      LET l_glaq.glaq029   = l_tmp.glaq029    #自由核算項一
      LET l_glaq.glaq030   = l_tmp.glaq030    #自由核算項二
      LET l_glaq.glaq031   = l_tmp.glaq031    #自由核算項三
      LET l_glaq.glaq032   = l_tmp.glaq032    #自由核算項四
      LET l_glaq.glaq033   = l_tmp.glaq033    #自由核算項五
      LET l_glaq.glaq034   = l_tmp.glaq034    #自由核算項六
      LET l_glaq.glaq035   = l_tmp.glaq035    #自由核算項七
      LET l_glaq.glaq036   = l_tmp.glaq036    #自由核算項八
      LET l_glaq.glaq037   = l_tmp.glaq037    #自由核算項九
      LET l_glaq.glaq038   = l_tmp.glaq038    #自由核算項十
      
      LET l_glaq.glaq039   = l_tmp.glaq039
      LET l_glaq.glaq040   = l_tmp.glaq040
      LET l_glaq.glaq041   = l_tmp.glaq041
      LET l_glaq.glaq042   = l_tmp.glaq042
      LET l_glaq.glaq043   = l_tmp.glaq043
      LET l_glaq.glaq044   = l_tmp.glaq044
      LET l_glaq.glaq051   = l_tmp.glaq051   #經營方式
      LET l_glaq.glaq052   = l_tmp.glaq052   #渠道
      LET l_glaq.glaq053   = l_tmp.glaq053   #品牌


      #170322-00036#1 add s--- 
      #核算项如果没值,给个空格 
      IF l_glaq.glaq018 IS NULL THEN LET l_glaq.glaq018 = ' ' END IF
      IF l_glaq.glaq019 IS NULL THEN LET l_glaq.glaq019 = ' ' END IF
      IF l_glaq.glaq020 IS NULL THEN LET l_glaq.glaq020 = ' ' END IF
      IF l_glaq.glaq021 IS NULL THEN LET l_glaq.glaq021 = ' ' END IF
      IF l_glaq.glaq022 IS NULL THEN LET l_glaq.glaq022 = ' ' END IF
      IF l_glaq.glaq023 IS NULL THEN LET l_glaq.glaq023 = ' ' END IF
      IF l_glaq.glaq024 IS NULL THEN LET l_glaq.glaq024 = ' ' END IF
      IF l_glaq.glaq025 IS NULL THEN LET l_glaq.glaq025 = ' ' END IF
      IF l_glaq.glaq027 IS NULL THEN LET l_glaq.glaq027 = ' ' END IF
      IF l_glaq.glaq028 IS NULL THEN LET l_glaq.glaq028 = ' ' END IF
      IF l_glaq.glaq051 IS NULL THEN LET l_glaq.glaq051 = ' ' END IF
      IF l_glaq.glaq052 IS NULL THEN LET l_glaq.glaq052 = ' ' END IF
      IF l_glaq.glaq053 IS NULL THEN LET l_glaq.glaq053 = ' ' END IF
      IF l_glaq.glaq029 IS NULL THEN LET l_glaq.glaq029 = ' ' END IF
      IF l_glaq.glaq030 IS NULL THEN LET l_glaq.glaq030 = ' ' END IF
      IF l_glaq.glaq031 IS NULL THEN LET l_glaq.glaq031 = ' ' END IF
      IF l_glaq.glaq032 IS NULL THEN LET l_glaq.glaq032 = ' ' END IF
      IF l_glaq.glaq033 IS NULL THEN LET l_glaq.glaq033 = ' ' END IF
      IF l_glaq.glaq034 IS NULL THEN LET l_glaq.glaq034 = ' ' END IF
      IF l_glaq.glaq035 IS NULL THEN LET l_glaq.glaq035 = ' ' END IF
      IF l_glaq.glaq036 IS NULL THEN LET l_glaq.glaq036 = ' ' END IF
      IF l_glaq.glaq037 IS NULL THEN LET l_glaq.glaq037 = ' ' END IF
      IF l_glaq.glaq038 IS NULL THEN LET l_glaq.glaq038 = ' ' END IF
      #170322-00036#1 add e--- 
      
      
      #161128-00061#7---add---begin-----------
      #INSERT INTO glaq_t VALUES(l_glaq.*)
      INSERT INTO glaq_t (glaqent,glaqcomp,glaqld,glaqdocno,glaqseq,glaq001,glaq002,glaq003,glaq004,glaq005,
                          glaq006,glaq007,glaq008,glaq009,glaq010,glaq011,glaq012,glaq013,glaq014,glaq015,
                          glaq016,glaq017,glaq018,glaq019,glaq020,glaq021,glaq022,glaq023,glaq024,glaq025,
                          glaq026,glaq027,glaq028,glaq029,glaq030,glaq031,glaq032,glaq033,glaq034,glaq035,
                          glaq036,glaq037,glaq038,glaq039,glaq040,glaq041,glaq042,glaq043,glaq044,glaq051,
                          glaq052,glaq053,glaqud001,glaqud002,glaqud003,glaqud004,glaqud005,glaqud006,
                          glaqud007,glaqud008,glaqud009,glaqud010,glaqud011,glaqud012,glaqud013,glaqud014,
                          glaqud015,glaqud016,glaqud017,glaqud018,glaqud019,glaqud020,glaqud021,glaqud022,
                          glaqud023,glaqud024,glaqud025,glaqud026,glaqud027,glaqud028,glaqud029,glaqud030)
       VALUES(l_glaq.glaqent,l_glaq.glaqcomp,l_glaq.glaqld,l_glaq.glaqdocno,l_glaq.glaqseq,l_glaq.glaq001,l_glaq.glaq002,l_glaq.glaq003,l_glaq.glaq004,l_glaq.glaq005,
              l_glaq.glaq006,l_glaq.glaq007,l_glaq.glaq008,l_glaq.glaq009,l_glaq.glaq010,l_glaq.glaq011,l_glaq.glaq012,l_glaq.glaq013,l_glaq.glaq014,l_glaq.glaq015,
              l_glaq.glaq016,l_glaq.glaq017,l_glaq.glaq018,l_glaq.glaq019,l_glaq.glaq020,l_glaq.glaq021,l_glaq.glaq022,l_glaq.glaq023,l_glaq.glaq024,l_glaq.glaq025,
              l_glaq.glaq026,l_glaq.glaq027,l_glaq.glaq028,l_glaq.glaq029,l_glaq.glaq030,l_glaq.glaq031,l_glaq.glaq032,l_glaq.glaq033,l_glaq.glaq034,l_glaq.glaq035,
              l_glaq.glaq036,l_glaq.glaq037,l_glaq.glaq038,l_glaq.glaq039,l_glaq.glaq040,l_glaq.glaq041,l_glaq.glaq042,l_glaq.glaq043,l_glaq.glaq044,l_glaq.glaq051,
              l_glaq.glaq052,l_glaq.glaq053,l_glaq.glaqud001,l_glaq.glaqud002,l_glaq.glaqud003,l_glaq.glaqud004,l_glaq.glaqud005,l_glaq.glaqud006,
              l_glaq.glaqud007,l_glaq.glaqud008,l_glaq.glaqud009,l_glaq.glaqud010,l_glaq.glaqud011,l_glaq.glaqud012,l_glaq.glaqud013,l_glaq.glaqud014,
              l_glaq.glaqud015,l_glaq.glaqud016,l_glaq.glaqud017,l_glaq.glaqud018,l_glaq.glaqud019,l_glaq.glaqud020,l_glaq.glaqud021,l_glaq.glaqud022,
              l_glaq.glaqud023,l_glaq.glaqud024,l_glaq.glaqud025,l_glaq.glaqud026,l_glaq.glaqud027,l_glaq.glaqud028,l_glaq.glaqud029,l_glaq.glaqud030)
      #161128-00061#7---add---end-----------
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'ins glaq'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      
      #170103-00019#22 add ------
      #插入细项立冲账资料
      LET l_success = TRUE
      CALL s_pre_voucher_insert_glax(l_glaq.*) RETURNING l_success
      IF l_success = FALSE THEN
         RETURN r_success
      END IF
      #170103-00019#22 add end---
      
   END FOREACH
   
   #一笔凭证处理完毕后,对凭证单头进行更行
   #总借/贷
   SELECT SUM(glaq003),SUM(glaq004) INTO l_glap010,l_glap011
     FROM glaq_t
    WHERE glaqent   = g_enterprise
      AND glaqld    = p_glaqld
      AND glaqdocno = p_glapdocno
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'sel glaq'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   IF cl_null(l_glap010) THEN LET l_glap010 = 0 END IF
   IF cl_null(l_glap011) THEN LET l_glap011 = 0 END IF
   
   UPDATE glap_t SET glap010 = l_glap010,glap011 = l_glap011,glap014 = l_foreign
    WHERE glapent   = g_enterprise
      AND glapld    = p_glaqld
      AND glapdocno = p_glapdocno
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'upd glap_t'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION
################################################################################
# Descriptions...: 处理借方科目及金额等
# Memo...........:
# Usage..........: CALL s_voucher_gen_fm_2_ins_tmp(p_fmbb003,p_fmbb004,p_fmbb005)
#                  RETURNING r_success
# Input parameter: p_fmbb003      帐套
#                : p_fmbb004      年度
#                : p_fmbb005      期别
# Return code....: r_success      成功否标识位
# Date & Author..: 2014/10/20 By jingll
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_fm_2_ins_tmp(p_fmbb003,p_fmbb004,p_fmbb005)
   DEFINE p_fmbb003        LIKE fmbb_t.fmbb003  #帳套
   DEFINE p_fmbb004        LIKE fmbb_t.fmbb004  #年度
   DEFINE p_fmbb005        LIKE fmbb_t.fmbb005  #期别
   
   DEFINE r_success        LIKE type_t.num5
   #yangtt--2016/03/15--mark--str--
#   DEFINE l_tmp            RECORD 
#                           docno    LIKE glaq_t.glaqdocno,
#                           docdt    LIKE glap_t.glapdocdt,
#                           sw       LIKE type_t.chr1,     
#                           glaqent  LIKE glaq_t.glaqent,  
#                           glaqcomp LIKE glaq_t.glaqcomp, 
#                           glaqld   LIKE glaq_t.glaqld,   
#                           glaq001  LIKE glaq_t.glaq001,  
#                           glaq002  LIKE glaq_t.glaq002,  
#                           glaq005  LIKE glaq_t.glaq005,  #幣別
#                           glaq006  LIKE glaq_t.glaq006,  #匯率
#                           glaq007  LIKE glaq_t.glaq007,  
#                           glaq009  LIKE glaq_t.glaq009, 
#                           glaq010  LIKE glaq_t.glaq010,  #原幣金額                           
#                           glaq011  LIKE glaq_t.glaq011,  
#                           glaq012  LIKE glaq_t.glaq012,  
#                           glaq013  LIKE glaq_t.glaq013,  
#                           glaq014  LIKE glaq_t.glaq014,  
#                           glaq015  LIKE glaq_t.glaq015,  
#                           glaq016  LIKE glaq_t.glaq016,  
#                           glaq017  LIKE glaq_t.glaq017,  
#                           glaq018  LIKE glaq_t.glaq018,  
#                           glaq019  LIKE glaq_t.glaq019,  
#                           glaq020  LIKE glaq_t.glaq020,  
#                           glaq021  LIKE glaq_t.glaq021,  
#                           glaq022  LIKE glaq_t.glaq022,  
#                           glaq023  LIKE glaq_t.glaq023,  
#                           glaq024  LIKE glaq_t.glaq024,  
#                           glaq025  LIKE glaq_t.glaq025,  
#                          #glaq026  LIKE glaq_t.glaq026,  #151112-00009#3 mark
#                           glaq027  LIKE glaq_t.glaq027,  
#                           glaq028  LIKE glaq_t.glaq028, 
#                           glaq051  LIKE glaq_t.glaq051,  #經營方式
#                           glaq052  LIKE glaq_t.glaq052,  #渠道 
#                           glaq053  LIKE glaq_t.glaq053,  #品牌                           
#                           glaq029  LIKE glaq_t.glaq029,  
#                           glaq030  LIKE glaq_t.glaq030,  
#                           glaq031  LIKE glaq_t.glaq031,  
#                           glaq032  LIKE glaq_t.glaq032,  
#                           glaq033  LIKE glaq_t.glaq033,  
#                           glaq034  LIKE glaq_t.glaq034,  
#                           glaq035  LIKE glaq_t.glaq035,  
#                           glaq036  LIKE glaq_t.glaq036,  
#                           glaq037  LIKE glaq_t.glaq037,  
#                           glaq038  LIKE glaq_t.glaq038,                      
#                           d        LIKE glaq_t.glaq003,  
#                           c        LIKE glaq_t.glaq004,  
#                           qty      LIKE glaq_t.glaq008,  
#                           sum      LIKE glaq_t.glaq010,
#                           glaq039  LIKE glaq_t.glaq039,
#                           glaq040  LIKE glaq_t.glaq040,
#                           glaq041  LIKE glaq_t.glaq041,
#                           glaq042  LIKE glaq_t.glaq042,
#                           glaq043  LIKE glaq_t.glaq043,
#                           glaq044  LIKE glaq_t.glaq044,
#                           seq      LIKE glaq_t.glaqseq, #項次一
#                           source   LIKE type_t.chr100,
#                           glaqseq  LIKE glaq_t.glaqseq,
#                           seq2     LIKE glaq_t.glaqseq, #項次二
#                           state    LIKE type_t.chr1,    #單據性質  
#                           year1    LIKE type_t.num5,    #年度
#                           month1   LIKE type_t.num5,    #期別 
#                           xrca039  LIKE xrca_t.xrca039, #會計檢核附件份數  #150429-00010#14
#                           glgb055  LIKE glgb_t.glgb055  #現金變動碼       #150429-00010#14
#                           END RECORD
#                           
#  DEFINE l_fmbb010       LIKE fmbb_t.fmbb010   #会计科目
#  DEFINE l_fmbb028       LIKE fmbb_t.fmbb028   #对方科目
#  DEFINE l_fmbb011       LIKE fmbb_t.fmbb011   #币别
#  DEFINE l_fmbb012       LIKE fmbb_t.fmbb012   #汇率
#  DEFINE l_fmbb013       LIKE fmbb_t.fmbb013   #原币金额
#  DEFINE l_fmbb017       LIKE fmbb_t.fmbb017   #匯兌損益一
#  DEFINE l_fmbb022       LIKE fmbb_t.fmbb022   #匯兌損益二  
#  DEFINE l_fmbb027       LIKE fmbb_t.fmbb027   #匯兌損益三
#  DEFINE l_fmbb007       LIKE fmbb_t.fmbb007   #來源單據性質
#  DEFINE l_glac016       LIKE glac_t.glac016     #150814-00006#3 add 
#  DEFINE l_glaa004       LIKE glaa_t.glaa004     #150814-00006#3 add
#  
#   WHENEVER ERROR CONTINUE    
#
#   LET r_success = FALSE                        
#   INITIALIZE l_tmp.* TO NULL                                       
#   #150814-00006#3--add--str--
#   SELECT glaa004,glaa005 INTO l_glaa004 FROM glaa_t
#    WHERE glaaent = g_enterprise AND glaald = p_fmbb003
#   #150814-00006#3--add--end 
#   
#   FOREACH s_voucher_gen_fm_2_cs1 USING p_fmbb004,p_fmbb005 INTO l_tmp.*,l_fmbb010,l_fmbb028  #會計科目，對方科目
#   
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 'foreach s_voucher_gen_fm_2_cs1'
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#
#         RETURN r_success
#      END IF
#      
#      LET l_fmbb007 = l_tmp.state   #來源單據性質
#      LET l_fmbb011 = l_tmp.glaq005 #幣別
#      LET l_fmbb012 = l_tmp.glaq006 #匯率
#      LET l_fmbb013 = l_tmp.glaq010 #原幣金額
#      LET l_fmbb017 = l_tmp.d       #損益一金額
#      LET l_fmbb022 = l_tmp.glaq040 #損益二金額
#      LET l_fmbb027 = l_tmp.glaq043 #損益三金額
#      
#      #償還本金，利息，其他，應計利息
#      IF l_fmbb007 = '1' OR l_fmbb007 = '2' AND l_fmbb007 = '3' AND l_fmbb007 = '6' THEN
#         #借方
#         LET l_tmp.glaq002 = l_fmbb010   #科目
#         LET l_tmp.glaq005 = l_fmbb011   #幣別
#         LET l_tmp.glaq006 = l_fmbb012   #匯率
#         LET l_tmp.glaq010 = l_fmbb013   #原幣金額
#         LET l_tmp.d = l_fmbb017         #借方金額一
#         LET l_tmp.glaq040 = l_fmbb022   #借方二金額 
#         LET l_tmp.glaq043 = l_fmbb027   #借方三金額        
#         LET l_tmp.c = 0                 #貸方金額
#         LET l_tmp.glaq041 = 0           #貸方金額二
#         LET l_tmp.glaq044 = 0           #貸方金額三
#               
#         SELECT MAX(seq2) + 1 INTO l_tmp.seq2 FROM s_voucher_fm_tmp WHERE docno = l_tmp.docno   #單號
#                                                                      AND glaqld = l_tmp.glaqld #帳套 
#                                                                      AND year1 = l_tmp.year1   #年度
#                                                                      AND month1 = l_tmp.month1 #期別
#                                                                      AND seq = l_tmp.seq       #項次
#                                                                      
#         IF cl_null(l_tmp.seq2) THEN
#            LET l_tmp.seq2 = 1
#         END IF 
#         #150814-00006#3--add--str--
#         #现金变动码预设值
#         CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
#         IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
#            CALL s_voucher_glad006_get(p_fmbb003,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
#         END IF 
#         #150814-00006#3--add--end
#         INSERT INTO s_voucher_fm_tmp VALUES(l_tmp.*)
#         IF SQLCA.sqlcode THEN
#            INITIALIZE g_errparam TO NULL
#            LET g_errparam.code = SQLCA.sqlcode
#            LET g_errparam.extend = 'insert s_voucher_fm_tmp'
#            LET g_errparam.popup = TRUE
#            CALL cl_err()
#        
#            RETURN r_success                   
#         END IF
#         #貸方  
#         LET l_tmp.glaq002 = l_fmbb028   #科目
#         LET l_tmp.glaq005 = l_fmbb011   #幣別
#         LET l_tmp.glaq006 = l_fmbb012   #匯率
#         LET l_tmp.glaq010 = l_fmbb013   #原幣金額
#         LET l_tmp.d = 0         #借方金額一
#         LET l_tmp.glaq040 = 0   #借方二金額 
#         LET l_tmp.glaq043 = 0   #借方三金額        
#         LET l_tmp.c = l_fmbb017                #貸方金額
#         LET l_tmp.glaq041 = l_fmbb022          #貸方金額二
#         LET l_tmp.glaq044 = l_fmbb027          #貸方金額三
#         SELECT MAX(seq2) + 1 INTO l_tmp.seq2 FROM s_voucher_fm_tmp WHERE docno = l_tmp.docno   #單號
#                                                                      AND glaqld = l_tmp.glaqld #帳套 
#                                                                      AND year1 = l_tmp.year1   #年度
#                                                                      AND month1 = l_tmp.month1 #期別
#                                                                      AND seq = l_tmp.seq       #項次
#         IF cl_null(l_tmp.seq2) THEN
#            LET l_tmp.seq2 = 1
#         END IF 
#         #150814-00006#3--add--str--
#         #现金变动码预设值
#         CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
#         IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
#            CALL s_voucher_glad006_get(p_fmbb003,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
#         END IF 
#         #150814-00006#3--add--end
#         INSERT INTO s_voucher_fm_tmp VALUES(l_tmp.*)
#         IF SQLCA.sqlcode THEN
#            INITIALIZE g_errparam TO NULL
#            LET g_errparam.code = SQLCA.sqlcode
#            LET g_errparam.extend = 'insert s_voucher_fm_tmp'
#            LET g_errparam.popup = TRUE
#            CALL cl_err()
#        
#            RETURN r_success                   
#         END IF       
#      END IF     
#                
#      #本金到帳，融資費用           
#      IF l_fmbb007 = '4' OR l_fmbb007 = '5' THEN
#         #借方
#         LET l_tmp.glaq002 = l_fmbb028   #對方科目
#         LET l_tmp.glaq005 = l_fmbb011   #幣別
#         LET l_tmp.glaq006 = l_fmbb012   #匯率
#         LET l_tmp.glaq010 = l_fmbb013   #原幣金額
#         LET l_tmp.d = l_fmbb017         #借方金額一
#         LET l_tmp.glaq040 = l_fmbb022   #借方二金額 
#         LET l_tmp.glaq043 = l_fmbb027   #借方三金額        
#         LET l_tmp.c = 0                 #貸方金額
#         LET l_tmp.glaq041 = 0           #貸方金額二
#         LET l_tmp.glaq044 = 0           #貸方金額三
#               
#         SELECT MAX(seq2) + 1 INTO l_tmp.seq2 FROM s_voucher_fm_tmp WHERE docno = l_tmp.docno   #單號
#                                                                      AND glaqld = l_tmp.glaqld #帳套 
#                                                                      AND year1 = l_tmp.year1   #年度
#                                                                      AND month1 = l_tmp.month1 #期別
#                                                                      AND seq = l_tmp.seq       #項次
#         IF cl_null(l_tmp.seq2) THEN
#            LET l_tmp.seq2 = 1
#         END IF 
#         #150814-00006#3--add--str--
#         #现金变动码预设值
#         CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
#         IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
#            CALL s_voucher_glad006_get(p_fmbb003,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
#         END IF 
#         #150814-00006#3--add--end
#         INSERT INTO s_voucher_fm_tmp VALUES(l_tmp.*)
#         IF SQLCA.sqlcode THEN
#            INITIALIZE g_errparam TO NULL
#            LET g_errparam.code = SQLCA.sqlcode
#            LET g_errparam.extend = 'insert s_voucher_fm_tmp'
#            LET g_errparam.popup = TRUE
#            CALL cl_err()
#        
#            RETURN r_success                   
#         END IF
#         #貸方  
#         LET l_tmp.glaq002 = l_fmbb010   #科目
#         LET l_tmp.glaq005 = l_fmbb011   #幣別
#         LET l_tmp.glaq006 = l_fmbb012   #匯率
#         LET l_tmp.glaq010 = l_fmbb013   #原幣金額
#         LET l_tmp.d = 0         #借方金額一
#         LET l_tmp.glaq040 = 0   #借方二金額 
#         LET l_tmp.glaq043 = 0   #借方三金額        
#         LET l_tmp.c = l_fmbb017                #貸方金額
#         LET l_tmp.glaq041 = l_fmbb022          #貸方金額二
#         LET l_tmp.glaq044 = l_fmbb027          #貸方金額三
#         SELECT MAX(seq2) + 1 INTO l_tmp.seq2 FROM s_voucher_fm_tmp WHERE docno = l_tmp.docno   #單號
#                                                                      AND glaqld = l_tmp.glaqld #帳套 
#                                                                      AND year1 = l_tmp.year1   #年度
#                                                                      AND month1 = l_tmp.month1 #期別
#                                                                      AND seq = l_tmp.seq       #項次
#         IF cl_null(l_tmp.seq2) THEN
#            LET l_tmp.seq2 = 1
#         END IF 
#         #150814-00006#3--add--str--
#         #现金变动码预设值
#         CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
#         IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
#            CALL s_voucher_glad006_get(p_fmbb003,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
#         END IF 
#         #150814-00006#3--add--end
#         INSERT INTO s_voucher_fm_tmp VALUES(l_tmp.*)
#         IF SQLCA.sqlcode THEN
#            INITIALIZE g_errparam TO NULL
#            LET g_errparam.code = SQLCA.sqlcode
#            LET g_errparam.extend = 'insert s_voucher_fm_tmp'
#            LET g_errparam.popup = TRUE
#            CALL cl_err()
#        
#            RETURN r_success                   
#         END IF            
#      END IF      
#   END FOREACH        
#         
#   LET r_success = TRUE
   #yangtt--2016/03/15--mark--end--
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 重評價產生傳票
# Memo...........: #150429-00010#14
# Usage..........: CALL s_voucher_gen_fm_3_ins_tmp(p_type,p_ld,p_docno)
# Date & Author..: 2015/05/08 By Reanna
# Modify.........: 150825 #150820-00011#2  By Jessy 使用缺省會科(glab005)取代資金帳戶科目(fmnc003)
################################################################################
PUBLIC FUNCTION s_voucher_gen_fm_3_ins_tmp(p_type,p_ld,p_docno)
DEFINE p_type           LIKE type_t.chr5        #類型
DEFINE p_ld             LIKE fmna_t.fmna001     #帳套
DEFINE p_docno          LIKE fmna_t.fmnadocno   #帳款編號
DEFINE l_tmp            RECORD
                           docno    LIKE glaq_t.glaqdocno,
                           docdt    LIKE glap_t.glapdocdt,
                           sw       LIKE type_t.chr1,
                           glaqent  LIKE glaq_t.glaqent,
                           glaqcomp LIKE glaq_t.glaqcomp,
                           glaqld   LIKE glaq_t.glaqld,
                           glaq001  LIKE glaq_t.glaq001,
                           glaq002  LIKE glaq_t.glaq002,
                           glaq005  LIKE glaq_t.glaq005,  #幣別
                           glaq006  LIKE glaq_t.glaq006,  #匯率
                           glaq007  LIKE glaq_t.glaq007,
                           glaq009  LIKE glaq_t.glaq009,
                           glaq010  LIKE glaq_t.glaq010,  #原幣金額
                           glaq011  LIKE glaq_t.glaq011,
                           glaq012  LIKE glaq_t.glaq012,
                           glaq013  LIKE glaq_t.glaq013,
                           glaq014  LIKE glaq_t.glaq014,
                           glaq015  LIKE glaq_t.glaq015,
                           glaq016  LIKE glaq_t.glaq016,
                           glaq017  LIKE glaq_t.glaq017,
                           glaq018  LIKE glaq_t.glaq018,
                           glaq019  LIKE glaq_t.glaq019,
                           glaq020  LIKE glaq_t.glaq020,
                           glaq021  LIKE glaq_t.glaq021,
                           glaq022  LIKE glaq_t.glaq022,
                           glaq023  LIKE glaq_t.glaq023,
                           glaq024  LIKE glaq_t.glaq024,
                           glaq025  LIKE glaq_t.glaq025,
                          #glaq026  LIKE glaq_t.glaq026,  #151112-00009#3 mark
                           glaq027  LIKE glaq_t.glaq027,
                           glaq028  LIKE glaq_t.glaq028,
                           glaq051  LIKE glaq_t.glaq051,  #經營方式
                           glaq052  LIKE glaq_t.glaq052,  #渠道
                           glaq053  LIKE glaq_t.glaq053,  #品牌
                           glaq029  LIKE glaq_t.glaq029,
                           glaq030  LIKE glaq_t.glaq030,
                           glaq031  LIKE glaq_t.glaq031,
                           glaq032  LIKE glaq_t.glaq032,
                           glaq033  LIKE glaq_t.glaq033,
                           glaq034  LIKE glaq_t.glaq034,
                           glaq035  LIKE glaq_t.glaq035,
                           glaq036  LIKE glaq_t.glaq036,
                           glaq037  LIKE glaq_t.glaq037,
                           glaq038  LIKE glaq_t.glaq038,
                           d        LIKE glaq_t.glaq003,
                           c        LIKE glaq_t.glaq004,
                           qty      LIKE glaq_t.glaq008,
                           sum      LIKE glaq_t.glaq010,
                           glaq039  LIKE glaq_t.glaq039,
                           glaq040  LIKE glaq_t.glaq040,
                           glaq041  LIKE glaq_t.glaq041,
                           glaq042  LIKE glaq_t.glaq042,
                           glaq043  LIKE glaq_t.glaq043,
                           glaq044  LIKE glaq_t.glaq044,
                           seq      LIKE glaq_t.glaqseq, #項次一
                           source   LIKE type_t.chr100,
                           glaqseq  LIKE glaq_t.glaqseq,
                           seq2     LIKE glaq_t.glaqseq, #項次二
                           state    LIKE type_t.chr1,    #單據性質
                           year1    LIKE type_t.num5,    #年度
                           month1   LIKE type_t.num5,    #期別
                           xrca039  LIKE xrca_t.xrca039, #會計檢核附件份數
                           glgb055  LIKE glgb_t.glgb055  #現金變動碼
                           END RECORD
DEFINE l_glaq020        LIKE glaq_t.glaq020
DEFINE l_glaq021        LIKE glaq_t.glaq021
DEFINE l_glaq022        LIKE glaq_t.glaq022
DEFINE l_glaq023        LIKE glaq_t.glaq023
DEFINE l_glaq024        LIKE glaq_t.glaq024
DEFINE l_glaq051        LIKE glaq_t.glaq051
DEFINE l_glaq052        LIKE glaq_t.glaq052
DEFINE l_glaq053        LIKE glaq_t.glaq053
DEFINE l_glaq027        LIKE glaq_t.glaq027
DEFINE l_glaq028        LIKE glaq_t.glaq028
DEFINE l_glaq029        LIKE glaq_t.glaq029
DEFINE l_glaq030        LIKE glaq_t.glaq030
DEFINE l_glaq031        LIKE glaq_t.glaq031
DEFINE l_glaq032        LIKE glaq_t.glaq032
DEFINE l_glaq033        LIKE glaq_t.glaq033
DEFINE l_glaq034        LIKE glaq_t.glaq034
DEFINE l_glaq035        LIKE glaq_t.glaq035
DEFINE l_glaq036        LIKE glaq_t.glaq036
DEFINE l_glaq037        LIKE glaq_t.glaq037
DEFINE l_glaq038        LIKE glaq_t.glaq038
DEFINE l_glaa001        LIKE glaa_t.glaa001
DEFINE r_success        LIKE type_t.num5
#140804-00008#20 albireo 150520-s
DEFINE l_fmmj003        LIKE fmmj_t.fmmj003   #投資類型
DEFINE l_fmmb008        LIKE fmmb_t.fmmb008
DEFINE l_fmmb013        LIKE fmmb_t.fmmb013
DEFINE l_fmnf004        LIKE fmnf_t.fmnf004   #收支方式   影響平倉分錄
DEFINE l_fmmy003        LIKE fmmy_t.fmmy003   #平倉數量
DEFINE l_fmmj007        LIKE fmmj_t.fmmj007   #購買單價
DEFINE l_account1       LIKE type_t.num20_6   #本幣1
DEFINE l_account2       LIKE type_t.num20_6   #本幣2
DEFINE l_account3       LIKE type_t.num20_6   #本幣3
#140804-00008#20 albireo 150520-e
DEFINE l_fmmqsite       LIKE fmmq_t.fmmqsite
DEFINE l_fmmq001        LIKE fmmq_t.fmmq001
#140804-00008#9--(s)
DEFINE l_fmmm003        LIKE fmmm_t.fmmm003
DEFINE l_fmmm004        LIKE fmmm_t.fmmm004
DEFINE l_fmmm005        LIKE fmmm_t.fmmm005
DEFINE l_fmmm008        LIKE fmmm_t.fmmm008
DEFINE l_fmmm010        LIKE fmmm_t.fmmm010
DEFINE l_fmmm014        LIKE fmmm_t.fmmm014
DEFINE l_fmmm016        LIKE fmmm_t.fmmm016
DEFINE l_fmmjsite       LIKE fmmj_t.fmmjsite
DEFINE l_fmmj011        LIKE fmmj_t.fmmj011
DEFINE l_fmmj002        LIKE fmmj_t.fmmj002
DEFINE l_fmmj013        LIKE fmmj_t.fmmj013
DEFINE l_fmmk003        LIKE fmmk_t.fmmk003
DEFINE l_fmmk006        LIKE fmmk_t.fmmk006
DEFINE l_fmmk007        LIKE fmmk_t.fmmk007
DEFINE l_fmmk008        LIKE fmmk_t.fmmk008
DEFINE l_nmbb003        LIKE nmbb_t.nmbb003
DEFINE l_glad034        LIKE glad_t.glad034
DEFINE l_cnt            LIKE type_t.num5
#140804-00008#9--(e)
#140804-00008#15--(s)
DEFINE l_sum_d          LIKE glaq_t.glaq003
DEFINE l_sum_c          LIKE glaq_t.glaq003
#140804-00008#15--(e)
#DEFINE l_glab011        LIKE glab_t.glab011    #150825-00004#9 #151203-00013#3 mark
#150924-00006#8 add ------
DEFINE l_fmmx004        LIKE fmmx_t.fmmx004
DEFINE l_fmmx030        LIKE fmmx_t.fmmx030
DEFINE l_fmmj005        LIKE fmmj_t.fmmj005
DEFINE l_fmmj008        LIKE fmmj_t.fmmj008
DEFINE l_fmmj015        LIKE fmmj_t.fmmj015
DEFINE l_fmmj016        LIKE fmmj_t.fmmj016
DEFINE l_fmmj017        LIKE fmmj_t.fmmj017
DEFINE l_fmmjdocno      LIKE fmmj_t.fmmjdocno
DEFINE l_fmma003        LIKE fmma_t.fmma003
DEFINE l_fmmk005        LIKE fmmk_t.fmmk005
DEFINE l_fmmk0052       LIKE fmmk_t.fmmk005
DEFINE l_fmmk0053       LIKE fmmk_t.fmmk005
DEFINE l_fmmk0054       LIKE fmmk_t.fmmk005
#150924-00006#8 add end---
DEFINE l_glac016        LIKE glac_t.glac016     #150814-00006#3 add 
DEFINE l_glaa004        LIKE glaa_t.glaa004     #150814-00006#3 add
#151027  ---s---
DEFINE l_fmmx001       LIKE fmmx_t.fmmx001
DEFINE l_fmmx002       LIKE fmmx_t.fmmx002
DEFINE l_fmmx029       LIKE fmmx_t.fmmx029
DEFINE l_fmmx101       LIKE fmmx_t.fmmx101
DEFINE l_fmmx112       LIKE fmmx_t.fmmx112
DEFINE l_fmmv001       LIKE fmmv_t.fmmv001
DEFINE l_fmng005       LIKE fmng_t.fmng005
DEFINE l_fmng009       LIKE fmng_t.fmng009
DEFINE l_fmng013       LIKE fmng_t.fmng013
DEFINE l_fmng017       LIKE fmng_t.fmng017
#151027  ---e---

   WHENEVER ERROR CONTINUE

   LET r_success = FALSE
   INITIALIZE l_tmp.* TO NULL
   #150814-00006#3--add--str--
   SELECT glaa004,glaa005 INTO l_glaa004 FROM glaa_t
    WHERE glaaent = g_enterprise AND glaald = p_ld
   #150814-00006#3--add--end 
   
   CASE p_type
      WHEN '31' #借:對方科目   #151203 mod
         #151203-00013#3 --s mark
         ##150825-00004#9 add ------
         ##抓取重評價設定(agli171)彙總方式
         #SELECT glab011 INTO l_glab011
         #  FROM glab_t
         # WHERE glabent = g_enterprise
         #   AND glabld  = p_ld
         #   AND glab001 = '25'
         #   AND glab002 = '8318'
         #   AND glab003 = '8318_11'
         ##150825-00004#9 add end---
         #151203-00013#3 --e mark
         FOREACH s_voucher_gen_fm_3_cs1 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_3_cs1'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            #若為負數金額,則借貸方向要相反
            IF l_tmp.d < 0 THEN 
               LET l_tmp.sw = '2'
               LET l_tmp.c = l_tmp.d * -1
               LET l_tmp.sum = l_tmp.sum * -1  #原幣
               LET l_tmp.glaq010 = l_tmp.glaq010 * -1
               LET l_tmp.d = 0
               LET l_tmp.glaq041 = l_tmp.glaq040 * -1 #本位幣二
               LET l_tmp.glaq040 = 0
               LET l_tmp.glaq044 = l_tmp.glaq043 * -1 #本位幣三
               LET l_tmp.glaq043 = 0
            END IF
            
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF
            
            #因重評價可能原幣OK本幣OK但本幣二or三要作重評
            IF (l_tmp.c = 0 AND l_tmp.d = 0 AND 
                l_tmp.glaq040 = 0 AND l_tmp.glaq041 = 0 AND 
                l_tmp.glaq043 = 0 AND l_tmp.glaq044 = 0) OR
               (cl_null(l_tmp.c) AND cl_null(l_tmp.d) AND 
                cl_null(l_tmp.glaq040) AND cl_null(l_tmp.glaq041) AND
                cl_null(l_tmp.glaq043) AND cl_null(l_tmp.glaq044)
                ) THEN CONTINUE FOREACH END IF
            #151203-00013#3 --s mark
            ##150825-00004#9 add ------
            ##如果重評價設定(agli171)成依幣別彙總，彙總時幣別再給本幣這邊先不給
            #IF l_glab011 <> '3' THEN  #3:依幣別匯總
            #   CALL s_ld_sel_glaa(p_ld,'glaa001') RETURNING g_sub_success,l_tmp.glaq005
            #   LET l_tmp.glaq006 = 1
            #END IF
            ##150825-00004#9 add end---
            #151203-00013#3 --e mark
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
      
      WHEN '32' #貸:重評價科目   #151203 mod
         #151203-00013#3 --s mark
         ##150825-00004#9 add ------
         ##抓取重評價設定(agli171)彙總方式
         #SELECT glab011 INTO l_glab011
         #  FROM glab_t
         # WHERE glabent = g_enterprise
         #   AND glabld  = p_ld
         #   AND glab001 = '25'
         #   AND glab002 = '8318'
         #   AND glab003 = '8318_11'
         ##150825-00004#9 add end---
         #151203-00013#3 --e mark
         FOREACH s_voucher_gen_fm_3_cs2 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_3_cs2'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            #若為負數金額,則借貸方向要相反
            IF l_tmp.c < 0 THEN 
               LET l_tmp.sw = '1'
               LET l_tmp.d = l_tmp.c * -1
               LET l_tmp.sum = l_tmp.sum * -1 #原幣
               LET l_tmp.glaq010 = l_tmp.glaq010 * -1
               LET l_tmp.c = 0
               LET l_tmp.glaq040 = l_tmp.glaq041 * -1 #本位幣二
               LET l_tmp.glaq041 = 0
               LET l_tmp.glaq043 = l_tmp.glaq044 * -1 #本位幣三
               LET l_tmp.glaq044 = 0
            END IF
            CALL s_ld_sel_glaa(p_ld,'glaa001') RETURNING g_sub_success,l_glaa001
            IF l_glaa001 <> l_tmp.glaq005 THEN 
               LET l_tmp.glaq010 = 0
            END IF
            
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF
            
            #因重評價可能原幣OK本幣OK但本幣二or三要作重評
            IF (l_tmp.c = 0 AND l_tmp.d = 0 AND 
                l_tmp.glaq040 = 0 AND l_tmp.glaq041 = 0 AND 
                l_tmp.glaq043 = 0 AND l_tmp.glaq044 = 0) OR
               (cl_null(l_tmp.c) AND cl_null(l_tmp.d) AND 
                cl_null(l_tmp.glaq040) AND cl_null(l_tmp.glaq041) AND
                cl_null(l_tmp.glaq043) AND cl_null(l_tmp.glaq044)
                ) THEN CONTINUE FOREACH END IF
            
            #151203-00013#3 --s mark
            ##150825-00004#9 add ------
            ##如果重評價設定(agli171)成依幣別彙總，彙總時幣別再給本幣這邊先不給
            #IF l_glab011 <> '3' THEN  #3:依幣別匯總
            #   CALL s_ld_sel_glaa(p_ld,'glaa001') RETURNING g_sub_success,l_tmp.glaq005
            #   LET l_tmp.glaq006 = 1
            #END IF
            ##150825-00004#9 add end---
            #151203-00013#3 --e mark
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
         
      
      WHEN '41' #借:公允價值變動科目
         FOREACH s_voucher_gen_fm_4_cs1 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_4_cs1'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            #若為負數金額,則借貸方向要相反
            IF l_tmp.d = 0 THEN CONTINUE FOREACH END IF
            IF cl_null(l_tmp.d) THEN CONTINUE FOREACH END IF
            IF l_tmp.d < 0 THEN 
               LET l_tmp.sw = '2'
               LET l_tmp.c = l_tmp.d * -1
               LET l_tmp.sum = l_tmp.sum * -1 #原幣
               LET l_tmp.glaq010 = l_tmp.glaq010 * -1
               LET l_tmp.d = 0
               LET l_tmp.glaq041 = l_tmp.glaq040 * -1
               LET l_tmp.glaq040 = 0
               LET l_tmp.glaq044 = l_tmp.glaq043 * -1
               LET l_tmp.glaq043 = 0
            END IF
            #CALL s_ld_sel_glaa(p_ld,'glaa001') RETURNING g_sub_success,l_tmp.glaq005 #170920-00070#1  mark
            #LET l_tmp.glaq006 = 1                                                    #170920-00070#1  mark
            #取得法人
            SELECT fmmqsite INTO l_fmmqsite
              FROM fmmq_t
             WHERE fmmqent = g_enterprise
               AND fmmqdocno = p_docno
            #取得營運據點所屬法人
            CALL s_fin_orga_get_comp_ld(l_fmmqsite)
                 RETURNING g_sub_success,g_errno,l_tmp.glaqcomp,l_fmmq001
            
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF
   
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
         
      WHEN '42' #貸:公允价值损益科目
         FOREACH s_voucher_gen_fm_4_cs2 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_4_cs2'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            #若為負數金額,則借貸方向要相反
            IF l_tmp.c = 0 THEN CONTINUE FOREACH END IF
            IF cl_null(l_tmp.c) THEN CONTINUE FOREACH END IF 
            IF l_tmp.c < 0 THEN 
               LET l_tmp.sw = '1'
               LET l_tmp.d = l_tmp.c * -1
               LET l_tmp.sum = l_tmp.sum * -1 #原幣
               LET l_tmp.glaq010 = l_tmp.glaq010 * -1
               LET l_tmp.c = 0
               LET l_tmp.glaq040 = l_tmp.glaq041 * -1
               LET l_tmp.glaq041 = 0
               LET l_tmp.glaq043 = l_tmp.glaq044 * -1
               LET l_tmp.glaq044 = 0
            END IF
            CALL s_ld_sel_glaa(p_ld,'glaa001') RETURNING g_sub_success,l_glaa001
            IF l_glaa001 <> l_tmp.glaq005 THEN
               LET l_tmp.glaq010 = 0
            END IF
            #取得法人
            SELECT fmmqsite INTO l_fmmqsite
              FROM fmmq_t
             WHERE fmmqent = g_enterprise
               AND fmmqdocno = p_docno
            #取得營運據點所屬法人
            CALL s_fin_orga_get_comp_ld(l_fmmqsite)
              RETURNING g_sub_success,g_errno,l_tmp.glaqcomp,l_fmmq001
            
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF
            
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end 
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
                  
                  
      ##140804-00008#20 albireo 150520-s
      #EX:
      #借:銀存500
      #   利息25
      #              貸:應收利息25
      #                 短期投資400
      #                 投資收益100
      WHEN '51'   #1.本金>>會計科目一>>貸:投資本金科目fmnf029
         FOREACH s_voucher_gen_fm_5_cs1 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_5_cs1'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            #151112-00009#3 mark ------
            ##如果是保證金金額要多扣購買成本-----s
            #LET l_fmnf004 = NULL
            #SELECT fmnf004 INTO l_fmnf004 FROM fmnf_t
            # WHERE fmnfent = g_enterprise
            #   AND fmnfdocno = l_tmp.docno
            #   AND fmnfseq   = l_tmp.seq
            #IF l_fmnf004 = '1' THEN
            #   LET l_fmmy003  = NULL
            #   LET l_fmmj007  = NULL
            #   SELECT fmmy003,fmmj007
            #     INTO l_fmmy003,l_fmmj007
            #     FROM fmnf_t,fmmy_t,fmmj_t
            #    WHERE fmnfent = fmmyent
            #      AND fmnf002 = fmmydocno
            #      AND fmmyent = fmmjent
            #      AND fmmy001 = fmmjdocno
            #      AND fmnfent = g_enterprise
            #      AND fmnfdocno = l_tmp.docno
            #      AND fmnfseq   = l_tmp.seq
            #   IF cl_null(l_fmmy003)THEN LET l_fmmy003 = 0 END IF
            #   IF cl_null(l_fmmj007)THEN LET l_fmmj007 = 0 END IF
            #    
            #   LET l_tmp.sum = l_tmp.sum - (l_fmmy003 * l_fmmj007)
            #   CALL s_afm_rate_money(l_tmp.glaqld,l_tmp.glaq006,l_tmp.glaq039,l_tmp.glaq042,l_tmp.sum)
            #        RETURNING l_tmp.d,l_tmp.glaq040,l_tmp.glaq043
            #END IF
            ##如果是保證金金額要多扣購買成本-----e
            
            #160408-00009#1 remark-----s
            ##若為負數金額,則借貸方向要相反
            IF l_tmp.d < 0 THEN 
               LET l_tmp.sw = '2'
               LET l_tmp.c = l_tmp.d * -1
               LET l_tmp.d = 0
               LET l_tmp.glaq041 = l_tmp.glaq040 * -1
               LET l_tmp.glaq040 = 0
               LET l_tmp.glaq044 = l_tmp.glaq043 * -1
               LET l_tmp.glaq043 = 0
            END IF
            #151112-00009#3 mark end---
            #160408-00009#1 remark-----e
            
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) AND cl_null(l_tmp.glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) AND cl_null(l_tmp.glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) AND cl_null(l_tmp.glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) AND cl_null(l_tmp.glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) AND cl_null(l_tmp.glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) AND cl_null(l_tmp.glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) AND cl_null(l_tmp.glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) AND cl_null(l_tmp.glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) AND cl_null(l_tmp.glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) AND cl_null(l_tmp.glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) AND cl_null(l_tmp.glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) AND cl_null(l_tmp.glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) AND cl_null(l_tmp.glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) AND cl_null(l_tmp.glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) AND cl_null(l_tmp.glaq033) THEN LET l_tmp.glaq033 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) AND cl_null(l_tmp.glaq034) THEN LET l_tmp.glaq034 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) AND cl_null(l_tmp.glaq035) THEN LET l_tmp.glaq035 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) AND cl_null(l_tmp.glaq036) THEN LET l_tmp.glaq036 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) AND cl_null(l_tmp.glaq037) THEN LET l_tmp.glaq037 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) AND cl_null(l_tmp.glaq038) THEN LET l_tmp.glaq038 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
   
      WHEN '52'   #1.本金>>會計科目二>>貸:投資收益科目 or 借:投資損失科目 fmnf030
         FOREACH s_voucher_gen_fm_5_cs2 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_5_cs2'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            #151112-00009#3 mark ------
            ##150924-00006#8 add ------
            ##抓取利息科目(afmi520)
            #SELECT fmmb005 INTO l_tmp.glaq002
            #  FROM fmnf_t
            #  LEFT JOIN fmmy_t ON fmmyent = fmnfent AND fmmydocno = fmnf002
            #  LEFT JOIN fmmj_t ON fmmjent = fmmyent AND fmmjdocno = fmmy001
            #  LEFT JOIN fmmb_t ON fmmbent = fmmjent AND fmmb001 = fmmj003
            # WHERE fmnfent = g_enterprise
            #   AND fmnfdocno = p_docno
            #   AND fmnf003 = '1'
            #   AND fmmb002 = l_tmp.glaqld
            ##150924-00006#8 add end---
            #151112-00009#3 mark end---
            #若為負數金額,則借貸方向要相反
            IF l_tmp.c < 0 THEN
               LET l_tmp.sw = '1'
               LET l_tmp.d = l_tmp.c * -1
               LET l_tmp.sum = l_tmp.sum * -1 #原幣
               LET l_tmp.glaq010 = l_tmp.glaq010 * -1
               LET l_tmp.c = 0
               LET l_tmp.glaq040 = l_tmp.glaq041 * -1
               LET l_tmp.glaq041 = 0
               LET l_tmp.glaq043 = l_tmp.glaq044 * -1
               LET l_tmp.glaq044 = 0
            END IF
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) AND cl_null(l_tmp.glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) AND cl_null(l_tmp.glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) AND cl_null(l_tmp.glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) AND cl_null(l_tmp.glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) AND cl_null(l_tmp.glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) AND cl_null(l_tmp.glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) AND cl_null(l_tmp.glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) AND cl_null(l_tmp.glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) AND cl_null(l_tmp.glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) AND cl_null(l_tmp.glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) AND cl_null(l_tmp.glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) AND cl_null(l_tmp.glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) AND cl_null(l_tmp.glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) AND cl_null(l_tmp.glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) AND cl_null(l_tmp.glaq033) THEN LET l_tmp.glaq033 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) AND cl_null(l_tmp.glaq034) THEN LET l_tmp.glaq034 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) AND cl_null(l_tmp.glaq035) THEN LET l_tmp.glaq035 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) AND cl_null(l_tmp.glaq036) THEN LET l_tmp.glaq036 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) AND cl_null(l_tmp.glaq037) THEN LET l_tmp.glaq037 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) AND cl_null(l_tmp.glaq038) THEN LET l_tmp.glaq038 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
   
      WHEN '53'   #1.本金>>銀存科目>>借：銀行存款fmnf031
         FOREACH s_voucher_gen_fm_5_cs3 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_5_cs3'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            #151112-00009#3 mark ------
            ##如果是保證金類型不走這塊
            #LET l_fmnf004 = NULL
            #SELECT fmnf004 INTO l_fmnf004 FROM fmnf_t
            # WHERE fmnfent = g_enterprise
            #   AND fmnfdocno = l_tmp.docno
            #   AND fmnfseq   = l_tmp.seq
            #IF l_fmnf004 = '1' THEN
            #   CONTINUE FOREACH
            #END IF
            ##150924-00006#8 add ------
            ##計算面值
            ##面值/購買數量/出售數量/本金/已宣告未發放股利/已到期未領取利息
            #SELECT fmmj017,fmmj005,fmmy003,fmmj008,fmmj015,fmmj016
            #  INTO l_fmmj017,l_fmmj005,l_fmmy003,l_fmmj008,l_fmmj015,l_fmmj016
            #  FROM fmmj_t
            #  LEFT JOIN fmmy_t ON fmmyent = fmmjent AND fmmy001 = fmmjdocno
            #  LEFT JOIN fmnf_t ON fmnfent = fmmyent AND fmnf002 = fmmydocno
            # WHERE fmmjent = g_enterprise
            #   AND fmnfdocno = p_docno
            #   AND fmnf003 = '1'
            #IF cl_null(l_fmmj017) THEN LET l_fmmj017 = 0 END IF
            #IF cl_null(l_fmmj005) THEN LET l_fmmj005 = 0 END IF
            #IF cl_null(l_fmmy003) THEN LET l_fmmy003 = 0 END IF
            #IF cl_null(l_fmmj008) THEN LET l_fmmj008 = 0 END IF
            #IF cl_null(l_fmmj015) THEN LET l_fmmj015 = 0 END IF
            #IF cl_null(l_fmmj016) THEN LET l_fmmj016 = 0 END IF
            ##若不是全部出售則要計算出售的比例：面值*出售數量/購買數量
            #IF l_fmmj005 - l_fmmy003 <> 0 THEN
            #   LET l_tmp.sum = l_fmmj017 * l_fmmy003 / l_fmmj005
            #   LET l_tmp.sum = s_curr_round(l_tmp.glaqcomp,l_tmp.glaq005,l_tmp.sum,'2')
            #ELSE
            #   LET l_tmp.sum = l_fmmj017
            #END IF
            ##150924-00006#8 add end---
            ##原幣金額推各金額
            ##l_tmp.sum(原幣金額)
            #CALL s_afm_rate_money(l_tmp.glaqld,l_tmp.glaq006,l_tmp.glaq039,l_tmp.glaq042,l_tmp.sum)
            #     RETURNING l_tmp.c,l_tmp.glaq041,l_tmp.glaq044
            
            #160408-00009#1 remark-----s
            ##150924-00006#8 mark ------
            ###若為負數金額,則借貸方向要相反
            IF l_tmp.c < 0 THEN 
               LET l_tmp.sw = '1'
               LET l_tmp.d = l_tmp.c * -1
               LET l_tmp.c = 0
               LET l_tmp.glaq040 = l_tmp.glaq041 * -1
               LET l_tmp.glaq041 = 0
               LET l_tmp.glaq043 = l_tmp.glaq044 * -1
               LET l_tmp.glaq044 = 0
            END IF
            ##150924-00006#8 mark end---
            #160408-00009#1 remark-----e
            #151112-00009#3 mark end---
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) AND cl_null(l_tmp.glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) AND cl_null(l_tmp.glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) AND cl_null(l_tmp.glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) AND cl_null(l_tmp.glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) AND cl_null(l_tmp.glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) AND cl_null(l_tmp.glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) AND cl_null(l_tmp.glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) AND cl_null(l_tmp.glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) AND cl_null(l_tmp.glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) AND cl_null(l_tmp.glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) AND cl_null(l_tmp.glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) AND cl_null(l_tmp.glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) AND cl_null(l_tmp.glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) AND cl_null(l_tmp.glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) AND cl_null(l_tmp.glaq033) THEN LET l_tmp.glaq033 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) AND cl_null(l_tmp.glaq034) THEN LET l_tmp.glaq034 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) AND cl_null(l_tmp.glaq035) THEN LET l_tmp.glaq035 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) AND cl_null(l_tmp.glaq036) THEN LET l_tmp.glaq036 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) AND cl_null(l_tmp.glaq037) THEN LET l_tmp.glaq037 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) AND cl_null(l_tmp.glaq038) THEN LET l_tmp.glaq038 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            #151112-00009#3 mark ------
            ##150924-00006#8 add ------
            ##若有差異金額在這處理
            ##差異金額=本金-面值-已宣告未發放股利-已到期未領取利息
            #LET l_tmp.sum = l_fmmj008 - l_fmmj017 - l_fmmj015 - l_fmmj016
            #IF l_tmp.sum <> 0 THEN
            #   #若不是全部出售則要計算出售的比例：差異金額*出售數量/購買數量
            #   IF l_fmmj005 - l_fmmy003 <> 0 THEN
            #      LET l_tmp.sum = l_tmp.sum * l_fmmy003 / l_fmmj005
            #      LET l_tmp.sum = s_curr_round(l_tmp.glaqcomp,l_tmp.glaq005,l_tmp.sum,'2')
            #   ELSE
            #      LET l_tmp.sum = l_fmmj017
            #   END IF
            #   #原幣金額推各金額
            #   #l_tmp.sum(原幣金額)
            #   CALL s_afm_rate_money(l_tmp.glaqld,l_tmp.glaq006,l_tmp.glaq039,l_tmp.glaq042,l_tmp.sum)
            #        RETURNING l_tmp.c,l_tmp.glaq041,l_tmp.glaq044
            #   IF l_tmp.sum < 0 THEN #差異科目<0放借方
            #      LET l_tmp.sw = '1'
            #      LET l_tmp.d = l_tmp.c * -1
            #      LET l_tmp.sum = l_tmp.sum * -1 #原幣
            #      LET l_tmp.c = 0
            #      LET l_tmp.glaq040 = l_tmp.glaq041 * -1 #本位幣二
            #      LET l_tmp.glaq041 = 0
            #      LET l_tmp.glaq043 = l_tmp.glaq044 * -1 #本位幣三
            #      LET l_tmp.glaq044 = 0
            #   ELSE
            #      LET l_tmp.sw = '2'
            #      LET l_tmp.c = l_tmp.c
            #      LET l_tmp.sum = l_tmp.sum #原幣
            #      LET l_tmp.d = 0
            #      LET l_tmp.glaq041 = l_tmp.glaq041 #本位幣二
            #      LET l_tmp.glaq040 = 0
            #      LET l_tmp.glaq044 = l_tmp.glaq044 #本位幣三
            #      LET l_tmp.glaq043 = 0
            #   END IF
            #   #抓取差異科目(afmi520)
            #   SELECT fmmb009 INTO l_tmp.glaq002
            #     FROM fmnf_t
            #     LEFT JOIN fmmy_t ON fmmyent = fmnfent AND fmmydocno = fmnf002
            #     LEFT JOIN fmmj_t ON fmmjent = fmmyent AND fmmjdocno = fmmy001
            #     LEFT JOIN fmmb_t ON fmmbent = fmmjent AND fmmb001 = fmmj003
            #    WHERE fmnfent = g_enterprise
            #      AND fmnfdocno = p_docno
            #      AND fmnf003 = '1'
            #      AND fmmb002 = l_tmp.glaqld
            #   CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
            #        RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
            #                  l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
            #                  l_glaq035,l_glaq036,l_glaq037,l_glaq038
            #   IF NOT cl_null(l_glaq020) AND cl_null(l_tmp.glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            #   IF NOT cl_null(l_glaq021) AND cl_null(l_tmp.glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            #   IF NOT cl_null(l_glaq022) AND cl_null(l_tmp.glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            #   IF NOT cl_null(l_glaq023) AND cl_null(l_tmp.glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            #   IF NOT cl_null(l_glaq024) AND cl_null(l_tmp.glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            #   IF NOT cl_null(l_glaq051) AND cl_null(l_tmp.glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            #   IF NOT cl_null(l_glaq052) AND cl_null(l_tmp.glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            #   IF NOT cl_null(l_glaq053) AND cl_null(l_tmp.glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            #   IF NOT cl_null(l_glaq027) AND cl_null(l_tmp.glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            #   IF NOT cl_null(l_glaq028) AND cl_null(l_tmp.glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            #   IF NOT cl_null(l_glaq029) AND cl_null(l_tmp.glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            #   IF NOT cl_null(l_glaq030) AND cl_null(l_tmp.glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            #   IF NOT cl_null(l_glaq031) AND cl_null(l_tmp.glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            #   IF NOT cl_null(l_glaq032) AND cl_null(l_tmp.glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            #   IF NOT cl_null(l_glaq033) AND cl_null(l_tmp.glaq033) THEN LET l_tmp.glaq033 = l_glaq033 END IF
            #   IF NOT cl_null(l_glaq034) AND cl_null(l_tmp.glaq034) THEN LET l_tmp.glaq034 = l_glaq034 END IF
            #   IF NOT cl_null(l_glaq035) AND cl_null(l_tmp.glaq035) THEN LET l_tmp.glaq035 = l_glaq035 END IF
            #   IF NOT cl_null(l_glaq036) AND cl_null(l_tmp.glaq036) THEN LET l_tmp.glaq036 = l_glaq036 END IF
            #   IF NOT cl_null(l_glaq037) AND cl_null(l_tmp.glaq037) THEN LET l_tmp.glaq037 = l_glaq037 END IF
            #   IF NOT cl_null(l_glaq038) AND cl_null(l_tmp.glaq038) THEN LET l_tmp.glaq038 = l_glaq038 END IF
            #   IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            #   #150814-00006#3--add--str--
            #   #现金变动码预设值
            #   CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            #   IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
            #      CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            #   END IF 
            #   #150814-00006#3--add--end
            #   INSERT INTO s_voucher_fm_tmp VALUES(l_tmp.*)
            #   IF SQLCA.sqlcode THEN
            #      INITIALIZE g_errparam TO NULL
            #      LET g_errparam.code = SQLCA.sqlcode
            #      LET g_errparam.extend = 'insert s_voucher_fm_tmp'
            #      LET g_errparam.popup = FALSE
            #      CALL cl_err()
            #      RETURN r_success
            #   END IF
            #END IF
            ##150924-00006#8 add end---
            #151112-00009#3 mark end---
         END FOREACH
      #151112-00009#3 add ------
      WHEN '54'   #1.本金>>匯差科目>>正數在貸方，負數在借方
         FOREACH s_voucher_gen_fm_5_cs4 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_5_cs4'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            #取得投資類型
            SELECT fmmj003 INTO l_fmmj003
              FROM fmnf_t,fmne_t,fmmy_t,fmmj_t
             WHERE fmneent = g_enterprise
               AND fmne001 = p_ld
               AND fmnedocno =  l_tmp.docno
               AND fmnfseq = l_tmp.seq
               AND fmneent = fmnfent AND fmnedocno = fmnfdocno
               AND fmnfent = fmmyent AND fmnf002 = fmmydocno
               AND fmmyent = fmmjent AND fmmy001 = fmmjdocno
            IF l_tmp.c > 0 THEN #收益
               SELECT fmmb014 INTO l_tmp.glaq002 FROM fmmb_t
                WHERE fmmbent = g_enterprise
                  AND fmmb001 = l_fmmj003
                  AND fmmb002 = p_ld
            ELSE
               SELECT fmmb015 INTO l_tmp.glaq002 FROM fmmb_t
                WHERE fmmbent = g_enterprise
                  AND fmmb001 = l_fmmj003
                  AND fmmb002 = p_ld
            END IF
            #若為負數金額,則借貸方向要相反
            IF l_tmp.c < 0 THEN 
               LET l_tmp.sw = '1'
               LET l_tmp.d = l_tmp.c * -1
               LET l_tmp.sum = l_tmp.sum * -1 #原幣
               LET l_tmp.glaq010 = l_tmp.glaq010 * -1
               LET l_tmp.c = 0
               LET l_tmp.glaq040 = l_tmp.glaq041 * -1
               LET l_tmp.glaq041 = 0
               LET l_tmp.glaq043 = l_tmp.glaq044 * -1
               LET l_tmp.glaq044 = 0
            END IF
            CALL s_ld_sel_glaa(p_ld,'glaa001') RETURNING g_sub_success,l_tmp.glaq005
            LET l_tmp.glaq006 = 1
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) AND cl_null(l_tmp.glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) AND cl_null(l_tmp.glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) AND cl_null(l_tmp.glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) AND cl_null(l_tmp.glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) AND cl_null(l_tmp.glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) AND cl_null(l_tmp.glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) AND cl_null(l_tmp.glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) AND cl_null(l_tmp.glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) AND cl_null(l_tmp.glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) AND cl_null(l_tmp.glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) AND cl_null(l_tmp.glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) AND cl_null(l_tmp.glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) AND cl_null(l_tmp.glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) AND cl_null(l_tmp.glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) AND cl_null(l_tmp.glaq033) THEN LET l_tmp.glaq033 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) AND cl_null(l_tmp.glaq034) THEN LET l_tmp.glaq034 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) AND cl_null(l_tmp.glaq035) THEN LET l_tmp.glaq035 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) AND cl_null(l_tmp.glaq036) THEN LET l_tmp.glaq036 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) AND cl_null(l_tmp.glaq037) THEN LET l_tmp.glaq037 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) AND cl_null(l_tmp.glaq038) THEN LET l_tmp.glaq038 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
      #151112-00009#3 add end---
      #151112-00009#3 mark ------
      #WHEN '54'   #貸:投資收益
      #   FOREACH s_voucher_gen_fm_5_cs4 INTO l_tmp.*
      #      IF SQLCA.sqlcode THEN
      #         INITIALIZE g_errparam TO NULL
      #         LET g_errparam.code = SQLCA.sqlcode
      #         LET g_errparam.extend = 'foreach s_voucher_gen_fm_5_cs4'
      #         LET g_errparam.popup = FALSE
      #         CALL cl_err()
      #         RETURN r_success
      #      END IF
      #      FOREACH s_voucher_gen_fm_5_cs5 USING l_tmp.docno,l_tmp.glaqent,l_tmp.seq INTO l_tmp.*
      #         IF SQLCA.sqlcode THEN
      #            INITIALIZE g_errparam TO NULL
      #            LET g_errparam.code = SQLCA.sqlcode
      #            LET g_errparam.extend = 'foreach s_voucher_gen_fm_5_cs5'
      #            LET g_errparam.popup = FALSE
      #            CALL cl_err()
      #            RETURN r_success
      #         END IF
      #         EXIT FOREACH
      #      END FOREACH
      #      #因為無來源所以原幣回推時都給本幣設定
      #      #計算各方金額
      #      SELECT 0,SUM(d-c),0,SUM(glaq040-glaq041),0,SUM(glaq043-glaq044) 
      #        INTO l_tmp.d,l_tmp.c,l_tmp.glaq040,l_tmp.glaq041,l_tmp.glaq043,l_tmp.glaq044
      #        FROM s_voucher_fm_tmp
      #       WHERE glaqent = l_tmp.glaqent
      #         AND docno   = l_tmp.docno
      #         AND seq     = l_tmp.seq 
      #      CALL s_ld_sel_glaa(p_ld,'glaa001') RETURNING g_sub_success,l_tmp.glaq005
      #      LET l_tmp.glaq006 = 1
      #      LET l_tmp.glaq010 = l_tmp.c
      #      #科目
      #      #依平倉單串購買單抓投資類型抓收益損失科目
      #      LET l_fmmj003 = NULL
      #     #SELECT fmmj003 INTO l_fmmj003                        #150924-00006#8 mark
      #      SELECT fmmj003,fmmjdocno INTO l_fmmj003,l_fmmjdocno  #150924-00006#8
      #        FROM fmnf_t,fmmy_t,fmmj_t
      #       WHERE fmnfent = fmmyent
      #         AND fmnf002 = fmmydocno
      #         AND fmmyent = fmmjent
      #         AND fmmy001 = fmmjdocno
      #         AND fmnfent = g_enterprise
      #         AND fmnfdocno = l_tmp.docno
      #         AND fmnfseq   = l_tmp.seq
      #      LET l_tmp.glaq002 = NULL
      #      SELECT fmmb008,fmmb013 INTO l_fmmb008,l_fmmb013 FROM fmmb_t
      #       WHERE fmmbent = g_enterprise
      #         AND fmmb001 = l_fmmj003
      #         AND fmmb002 = l_tmp.glaqld
      #      LET l_tmp.glaq002 = l_fmmb008
      #      #150924-00006#8 add ------
      #      #若投資類型(afmi510-fmma003)处理方式=1:計入投資成本，則購買單費用要分開列出來
      #      SELECT fmma003 INTO l_fmma003
      #        FROM fmma_t
      #       WHERE fmmaent = g_enterprise
      #         AND fmma001 = l_fmmj003
      #      LET l_fmmk005 = 0
      #      IF l_fmma003 = '1' THEN
      #         SELECT SUM(fmmk005) INTO l_fmmk005
      #           FROM fmmk_t
      #          WHERE fmmkent = g_enterprise
      #            AND fmmk001 = l_fmmjdocno
      #         IF cl_null(l_fmmk005) THEN LET l_fmmk005 = 0 END IF
      #         IF l_fmmk005 <> 0 THEN
      #            CALL s_afm_rate_money(l_tmp.glaqld,l_tmp.glaq006,l_tmp.glaq039,l_tmp.glaq042,l_fmmk005)
      #                 RETURNING l_fmmk0052,l_fmmk0053,l_fmmk0054
      #            LET l_tmp.c = l_tmp.c - l_fmmk0052
      #            LET l_tmp.glaq010 = l_tmp.glaq010 - l_fmmk005
      #            LET l_tmp.glaq041 = l_tmp.glaq041 - l_fmmk0053
      #            LET l_tmp.glaq044 = l_tmp.glaq044 - l_fmmk0054
      #         END IF
      #      END IF
      #      #150924-00006#8 add end---
      #      #若為負數金額,則借貸方向要相反
      #      IF l_tmp.c < 0 THEN 
      #         LET l_tmp.sw = '1'
      #         LET l_tmp.d = l_tmp.c * -1
      #         LET l_tmp.glaq010 = l_tmp.glaq010 * -1
      #         LET l_tmp.c = 0
      #         LET l_tmp.glaq040 = l_tmp.glaq041 * -1
      #         LET l_tmp.glaq041 = 0
      #         LET l_tmp.glaq043 = l_tmp.glaq044 * -1
      #         LET l_tmp.glaq044 = 0
      #         LET l_tmp.glaq002 = l_fmmb013
      #      END IF
      #      #若無核算項則看有沒有預設，有就抓
      #      CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
      #           RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
      #                     l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
      #                     l_glaq035,l_glaq036,l_glaq037,l_glaq038
      #      IF NOT cl_null(l_glaq020) AND cl_null(l_tmp.glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
      #      IF NOT cl_null(l_glaq021) AND cl_null(l_tmp.glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
      #      IF NOT cl_null(l_glaq022) AND cl_null(l_tmp.glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
      #      IF NOT cl_null(l_glaq023) AND cl_null(l_tmp.glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
      #      IF NOT cl_null(l_glaq024) AND cl_null(l_tmp.glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
      #      IF NOT cl_null(l_glaq051) AND cl_null(l_tmp.glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
      #      IF NOT cl_null(l_glaq052) AND cl_null(l_tmp.glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
      #      IF NOT cl_null(l_glaq053) AND cl_null(l_tmp.glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
      #      IF NOT cl_null(l_glaq027) AND cl_null(l_tmp.glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
      #      IF NOT cl_null(l_glaq028) AND cl_null(l_tmp.glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
      #      IF NOT cl_null(l_glaq029) AND cl_null(l_tmp.glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
      #      IF NOT cl_null(l_glaq030) AND cl_null(l_tmp.glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
      #      IF NOT cl_null(l_glaq031) AND cl_null(l_tmp.glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
      #      IF NOT cl_null(l_glaq032) AND cl_null(l_tmp.glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
      #      IF NOT cl_null(l_glaq033) AND cl_null(l_tmp.glaq033) THEN LET l_tmp.glaq033 = l_glaq033 END IF
      #      IF NOT cl_null(l_glaq034) AND cl_null(l_tmp.glaq034) THEN LET l_tmp.glaq034 = l_glaq034 END IF
      #      IF NOT cl_null(l_glaq035) AND cl_null(l_tmp.glaq035) THEN LET l_tmp.glaq035 = l_glaq035 END IF
      #      IF NOT cl_null(l_glaq036) AND cl_null(l_tmp.glaq036) THEN LET l_tmp.glaq036 = l_glaq036 END IF
      #      IF NOT cl_null(l_glaq037) AND cl_null(l_tmp.glaq037) THEN LET l_tmp.glaq037 = l_glaq037 END IF
      #      IF NOT cl_null(l_glaq038) AND cl_null(l_tmp.glaq038) THEN LET l_tmp.glaq038 = l_glaq038 END IF
      #      LET l_tmp.sum = l_tmp.glaq010
      #      IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
      #      #150814-00006#3--add--str--
      #      #现金变动码预设值
      #      CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
      #      IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
      #         CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
      #      END IF 
      #      #150814-00006#3--add--end
      #      INSERT INTO s_voucher_fm_tmp VALUES(l_tmp.*)
      #      IF SQLCA.sqlcode THEN
      #         INITIALIZE g_errparam TO NULL
      #         LET g_errparam.code = SQLCA.sqlcode
      #         LET g_errparam.extend = 'insert s_voucher_fm_tmp'
      #         LET g_errparam.popup = FALSE
      #         CALL cl_err()
      #         RETURN r_success
      #      END IF
      #      #150924-00006#8 add ------
      #      #l_fmmk005<>0表示有購買單的費用，且要分開列出來
      #      IF l_fmmk005 <> 0 THEN
      #         #抓取購買單(afmt530)的每一筆費用的費用類型/金額
      #         FOREACH s_voucher_gen_fm_5_cs8 USING l_fmmjdocno INTO l_fmmk003,l_fmmk005
      #            DISPLAY l_fmmk003,"/",l_fmmk005
      #            IF cl_null(l_fmmk005) THEN LET l_fmmk005 = 0 END IF
      #            #推出原幣/本幣二/本幣三
      #            CALL s_afm_rate_money(l_tmp.glaqld,l_tmp.glaq006,l_tmp.glaq039,l_tmp.glaq042,l_fmmk005)
      #                 RETURNING l_fmmk0052,l_fmmk0053,l_fmmk0054
      #            DISPLAY l_fmmk0052,"/",l_fmmk0053,"/",l_fmmk0054
      #            #費用都放貸方
      #            LET l_tmp.d = 0
      #            LET l_tmp.c = l_fmmk0052
      #            LET l_tmp.glaq010 = l_fmmk005
      #            LET l_tmp.glaq040 = 0
      #            LET l_tmp.glaq041 = l_fmmk0053
      #            LET l_tmp.glaq043 = 0
      #            LET l_tmp.glaq044 = l_fmmk0054
      #            #抓取費用會科(afmi540)
      #            LET l_tmp.glaq002 = ""
      #            SELECT fmmd003 INTO l_tmp.glaq002
      #              FROM fmmd_t
      #             WHERE fmmdent = g_enterprise
      #               AND fmmdld = p_ld
      #               AND fmmd001 = l_fmmj003  #投資類型
      #               AND fmmd002 = l_fmmk003  #投資費用類型
      #            DISPLAY l_tmp.glaq002
      #            #若無核算項則看有沒有預設，有就抓
      #            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
      #                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
      #                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
      #                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
      #            IF NOT cl_null(l_glaq020) AND cl_null(l_tmp.glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
      #            IF NOT cl_null(l_glaq021) AND cl_null(l_tmp.glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
      #            IF NOT cl_null(l_glaq022) AND cl_null(l_tmp.glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
      #            IF NOT cl_null(l_glaq023) AND cl_null(l_tmp.glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
      #            IF NOT cl_null(l_glaq024) AND cl_null(l_tmp.glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
      #            IF NOT cl_null(l_glaq051) AND cl_null(l_tmp.glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
      #            IF NOT cl_null(l_glaq052) AND cl_null(l_tmp.glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
      #            IF NOT cl_null(l_glaq053) AND cl_null(l_tmp.glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
      #            IF NOT cl_null(l_glaq027) AND cl_null(l_tmp.glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
      #            IF NOT cl_null(l_glaq028) AND cl_null(l_tmp.glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
      #            IF NOT cl_null(l_glaq029) AND cl_null(l_tmp.glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
      #            IF NOT cl_null(l_glaq030) AND cl_null(l_tmp.glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
      #            IF NOT cl_null(l_glaq031) AND cl_null(l_tmp.glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
      #            IF NOT cl_null(l_glaq032) AND cl_null(l_tmp.glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
      #            IF NOT cl_null(l_glaq033) AND cl_null(l_tmp.glaq033) THEN LET l_tmp.glaq033 = l_glaq033 END IF
      #            IF NOT cl_null(l_glaq034) AND cl_null(l_tmp.glaq034) THEN LET l_tmp.glaq034 = l_glaq034 END IF
      #            IF NOT cl_null(l_glaq035) AND cl_null(l_tmp.glaq035) THEN LET l_tmp.glaq035 = l_glaq035 END IF
      #            IF NOT cl_null(l_glaq036) AND cl_null(l_tmp.glaq036) THEN LET l_tmp.glaq036 = l_glaq036 END IF
      #            IF NOT cl_null(l_glaq037) AND cl_null(l_tmp.glaq037) THEN LET l_tmp.glaq037 = l_glaq037 END IF
      #            IF NOT cl_null(l_glaq038) AND cl_null(l_tmp.glaq038) THEN LET l_tmp.glaq038 = l_glaq038 END IF
      #            LET l_tmp.sum = l_tmp.glaq010
      #            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
      #            #150814-00006#3--add--str--
      #            #现金变动码预设值
      #            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
      #            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
      #               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
      #            END IF 
      #            #150814-00006#3--add--end
      #            INSERT INTO s_voucher_fm_tmp VALUES(l_tmp.*)
      #            IF SQLCA.sqlcode THEN
      #               INITIALIZE g_errparam TO NULL
      #               LET g_errparam.code = SQLCA.sqlcode
      #               LET g_errparam.extend = 'insert s_voucher_fm_tmp'
      #               LET g_errparam.popup = FALSE
      #               CALL cl_err()
      #               RETURN r_success
      #            END IF
      #         END FOREACH
      #      END IF
      #      #150924-00006#8 add end---
      #   END FOREACH
      #151112-00009#3 mark ------ 
         
      WHEN '55'   #2.費用>>會計科目一>>借：#費用科目
         FOREACH s_voucher_gen_fm_5_cs6 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_5_cs6'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            #160408-00009#1 remark-----s
            #151112-00009#3 mark ------
            ##若為負數金額,則借貸方向要相反
            IF l_tmp.d < 0 THEN 
               LET l_tmp.sw = '2'
               LET l_tmp.c = l_tmp.d * -1
               LET l_tmp.glaq010 = l_tmp.glaq010 * -1
               LET l_tmp.sum = l_tmp.sum * -1 #原幣
               LET l_tmp.d = 0
               LET l_tmp.glaq041 = l_tmp.glaq040 * -1
               LET l_tmp.glaq040 = 0
               LET l_tmp.glaq044 = l_tmp.glaq043 * -1
               LET l_tmp.glaq043 = 0
            END IF
            #151112-00009#3 mark end---
            ##160408-00009#1 remark-----e
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) AND cl_null(l_tmp.glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) AND cl_null(l_tmp.glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) AND cl_null(l_tmp.glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) AND cl_null(l_tmp.glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) AND cl_null(l_tmp.glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) AND cl_null(l_tmp.glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) AND cl_null(l_tmp.glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) AND cl_null(l_tmp.glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) AND cl_null(l_tmp.glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) AND cl_null(l_tmp.glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) AND cl_null(l_tmp.glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) AND cl_null(l_tmp.glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) AND cl_null(l_tmp.glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) AND cl_null(l_tmp.glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) AND cl_null(l_tmp.glaq033) THEN LET l_tmp.glaq033 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) AND cl_null(l_tmp.glaq034) THEN LET l_tmp.glaq034 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) AND cl_null(l_tmp.glaq035) THEN LET l_tmp.glaq035 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) AND cl_null(l_tmp.glaq036) THEN LET l_tmp.glaq036 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) AND cl_null(l_tmp.glaq037) THEN LET l_tmp.glaq037 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) AND cl_null(l_tmp.glaq038) THEN LET l_tmp.glaq038 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
         
      WHEN '56'   #2.費用>>銀存科目>>貸：費用對象科目
         FOREACH s_voucher_gen_fm_5_cs7 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_5_cs7'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            
            #160408-00009#1 remark-----s
            #151112-00009#3 mark ------
            #若為負數金額,則借貸方向要相反
            IF l_tmp.c < 0 THEN 
               LET l_tmp.sw = '1'
               LET l_tmp.d = l_tmp.c * -1
               LET l_tmp.glaq010 = l_tmp.glaq010 * -1
               LET l_tmp.sum = l_tmp.sum * -1 #原幣
               LET l_tmp.c = 0
               LET l_tmp.glaq040 = l_tmp.glaq041 * -1
               LET l_tmp.glaq041 = 0
               LET l_tmp.glaq043 = l_tmp.glaq044 * -1
               LET l_tmp.glaq044 = 0
            END IF
            #151112-00009#3 mark end---
            #160408-00009#1 remark-----e
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) AND cl_null(l_tmp.glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) AND cl_null(l_tmp.glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) AND cl_null(l_tmp.glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) AND cl_null(l_tmp.glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) AND cl_null(l_tmp.glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) AND cl_null(l_tmp.glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) AND cl_null(l_tmp.glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) AND cl_null(l_tmp.glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) AND cl_null(l_tmp.glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) AND cl_null(l_tmp.glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) AND cl_null(l_tmp.glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) AND cl_null(l_tmp.glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) AND cl_null(l_tmp.glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) AND cl_null(l_tmp.glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) AND cl_null(l_tmp.glaq033) THEN LET l_tmp.glaq033 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) AND cl_null(l_tmp.glaq034) THEN LET l_tmp.glaq034 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) AND cl_null(l_tmp.glaq035) THEN LET l_tmp.glaq035 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) AND cl_null(l_tmp.glaq036) THEN LET l_tmp.glaq036 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) AND cl_null(l_tmp.glaq037) THEN LET l_tmp.glaq037 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) AND cl_null(l_tmp.glaq038) THEN LET l_tmp.glaq038 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
      ##140804-00008#20 albireo 150520-e
      #151112-00009#3 add ------
      WHEN '57'   #3.利息收入>>會計科目一>>貸:應收股利/利息科目fmnf029
         FOREACH s_voucher_gen_fm_5_cs9 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_5_cs9'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            
            #160408-00009#1-----s
            #若為負數金額,則借貸方向要相反
            IF l_tmp.c < 0 THEN 
               LET l_tmp.sw = '1'
               LET l_tmp.d = l_tmp.c * -1
               LET l_tmp.glaq010 = l_tmp.glaq010 * -1
               LET l_tmp.sum = l_tmp.sum * -1 #原幣
               LET l_tmp.c = 0
               LET l_tmp.glaq040 = l_tmp.glaq041 * -1
               LET l_tmp.glaq041 = 0
               LET l_tmp.glaq043 = l_tmp.glaq044 * -1
               LET l_tmp.glaq044 = 0
            END IF
            #160408-00009#1-----e
            
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) AND cl_null(l_tmp.glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) AND cl_null(l_tmp.glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) AND cl_null(l_tmp.glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) AND cl_null(l_tmp.glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) AND cl_null(l_tmp.glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) AND cl_null(l_tmp.glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) AND cl_null(l_tmp.glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) AND cl_null(l_tmp.glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) AND cl_null(l_tmp.glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) AND cl_null(l_tmp.glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) AND cl_null(l_tmp.glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) AND cl_null(l_tmp.glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) AND cl_null(l_tmp.glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) AND cl_null(l_tmp.glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) AND cl_null(l_tmp.glaq033) THEN LET l_tmp.glaq033 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) AND cl_null(l_tmp.glaq034) THEN LET l_tmp.glaq034 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) AND cl_null(l_tmp.glaq035) THEN LET l_tmp.glaq035 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) AND cl_null(l_tmp.glaq036) THEN LET l_tmp.glaq036 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) AND cl_null(l_tmp.glaq037) THEN LET l_tmp.glaq037 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) AND cl_null(l_tmp.glaq038) THEN LET l_tmp.glaq038 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
      WHEN '58'   #3.利息收入>>會計科目二>>貸:利息收入fmnf030
         FOREACH s_voucher_gen_fm_5_cs10 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_5_cs10'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            #160408-00009#1-----s
            #若為負數金額,則借貸方向要相反
            IF l_tmp.c < 0 THEN 
               LET l_tmp.sw = '1'
               LET l_tmp.d = l_tmp.c * -1
               LET l_tmp.glaq010 = l_tmp.glaq010 * -1
               LET l_tmp.sum = l_tmp.sum * -1 #原幣
               LET l_tmp.c = 0
               LET l_tmp.glaq040 = l_tmp.glaq041 * -1
               LET l_tmp.glaq041 = 0
               LET l_tmp.glaq043 = l_tmp.glaq044 * -1
               LET l_tmp.glaq044 = 0
            END IF
            #160408-00009#1-----e
            
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) AND cl_null(l_tmp.glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) AND cl_null(l_tmp.glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) AND cl_null(l_tmp.glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) AND cl_null(l_tmp.glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) AND cl_null(l_tmp.glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) AND cl_null(l_tmp.glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) AND cl_null(l_tmp.glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) AND cl_null(l_tmp.glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) AND cl_null(l_tmp.glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) AND cl_null(l_tmp.glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) AND cl_null(l_tmp.glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) AND cl_null(l_tmp.glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) AND cl_null(l_tmp.glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) AND cl_null(l_tmp.glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) AND cl_null(l_tmp.glaq033) THEN LET l_tmp.glaq033 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) AND cl_null(l_tmp.glaq034) THEN LET l_tmp.glaq034 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) AND cl_null(l_tmp.glaq035) THEN LET l_tmp.glaq035 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) AND cl_null(l_tmp.glaq036) THEN LET l_tmp.glaq036 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) AND cl_null(l_tmp.glaq037) THEN LET l_tmp.glaq037 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) AND cl_null(l_tmp.glaq038) THEN LET l_tmp.glaq038 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
      WHEN '59'   #3.利息收入>>銀存科目>>借：銀行存款fmnf031
         FOREACH s_voucher_gen_fm_5_cs11 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_5_cs11'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            
            #160408-00009#1-----s

            ##若為負數金額,則借貸方向要相反
            IF l_tmp.d < 0 THEN 
               LET l_tmp.sw = '2'
               LET l_tmp.c = l_tmp.d * -1
               LET l_tmp.glaq010 = l_tmp.glaq010 * -1
               LET l_tmp.sum = l_tmp.sum * -1 #原幣
               LET l_tmp.d = 0
               LET l_tmp.glaq041 = l_tmp.glaq040 * -1
               LET l_tmp.glaq040 = 0
               LET l_tmp.glaq044 = l_tmp.glaq043 * -1
               LET l_tmp.glaq043 = 0
            END IF

            ##160408-00009#1-----e
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) AND cl_null(l_tmp.glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) AND cl_null(l_tmp.glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) AND cl_null(l_tmp.glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) AND cl_null(l_tmp.glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) AND cl_null(l_tmp.glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) AND cl_null(l_tmp.glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) AND cl_null(l_tmp.glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) AND cl_null(l_tmp.glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) AND cl_null(l_tmp.glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) AND cl_null(l_tmp.glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) AND cl_null(l_tmp.glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) AND cl_null(l_tmp.glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) AND cl_null(l_tmp.glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) AND cl_null(l_tmp.glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) AND cl_null(l_tmp.glaq033) THEN LET l_tmp.glaq033 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) AND cl_null(l_tmp.glaq034) THEN LET l_tmp.glaq034 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) AND cl_null(l_tmp.glaq035) THEN LET l_tmp.glaq035 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) AND cl_null(l_tmp.glaq036) THEN LET l_tmp.glaq036 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) AND cl_null(l_tmp.glaq037) THEN LET l_tmp.glaq037 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) AND cl_null(l_tmp.glaq038) THEN LET l_tmp.glaq038 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
      WHEN '5A'   #3.利息收入>>匯差科目>>正數在貸方，負數在借方
         FOREACH s_voucher_gen_fm_5_cs12 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_5_cs12'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            #取得投資類型
            SELECT fmmj003 INTO l_fmmj003
              FROM fmnf_t,fmne_t,fmmy_t,fmmj_t
             WHERE fmneent = g_enterprise
               AND fmne001 = p_ld
               AND fmnedocno =  l_tmp.docno
               AND fmnfseq = l_tmp.seq
               AND fmneent = fmnfent AND fmnedocno = fmnfdocno
               AND fmnfent = fmmyent AND fmnf002 = fmmydocno
               AND fmmyent = fmmjent AND fmmy001 = fmmjdocno
            IF l_tmp.c > 0 THEN #收益
               SELECT fmmb014 INTO l_tmp.glaq002 FROM fmmb_t
                WHERE fmmbent = g_enterprise
                  AND fmmb001 = l_fmmj003
                  AND fmmb002 = p_ld
            ELSE
               SELECT fmmb015 INTO l_tmp.glaq002 FROM fmmb_t
                WHERE fmmbent = g_enterprise
                  AND fmmb001 = l_fmmj003
                  AND fmmb002 = p_ld
            END IF
            #若為負數金額,則借貸方向要相反
            IF l_tmp.c < 0 THEN
               LET l_tmp.sw = '1'
               LET l_tmp.d = l_tmp.c * -1
               LET l_tmp.sum = l_tmp.sum * -1 #原幣
               LET l_tmp.glaq010 = l_tmp.glaq010 * -1
               LET l_tmp.c = 0
               LET l_tmp.glaq040 = l_tmp.glaq041 * -1
               LET l_tmp.glaq041 = 0
               LET l_tmp.glaq043 = l_tmp.glaq044 * -1
               LET l_tmp.glaq044 = 0
            END IF
            CALL s_ld_sel_glaa(p_ld,'glaa001') RETURNING g_sub_success,l_tmp.glaq005
            LET l_tmp.glaq006 = 1
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) AND cl_null(l_tmp.glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) AND cl_null(l_tmp.glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) AND cl_null(l_tmp.glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) AND cl_null(l_tmp.glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) AND cl_null(l_tmp.glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) AND cl_null(l_tmp.glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) AND cl_null(l_tmp.glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) AND cl_null(l_tmp.glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) AND cl_null(l_tmp.glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) AND cl_null(l_tmp.glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) AND cl_null(l_tmp.glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) AND cl_null(l_tmp.glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) AND cl_null(l_tmp.glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) AND cl_null(l_tmp.glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) AND cl_null(l_tmp.glaq033) THEN LET l_tmp.glaq033 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) AND cl_null(l_tmp.glaq034) THEN LET l_tmp.glaq034 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) AND cl_null(l_tmp.glaq035) THEN LET l_tmp.glaq035 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) AND cl_null(l_tmp.glaq036) THEN LET l_tmp.glaq036 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) AND cl_null(l_tmp.glaq037) THEN LET l_tmp.glaq037 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) AND cl_null(l_tmp.glaq038) THEN LET l_tmp.glaq038 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
      WHEN '5B'   #4.已宣告未領取利息>>會計科目一>>貸：已宣告未發放股利科目fmnf029
         FOREACH s_voucher_gen_fm_5_cs13 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_5_cs13'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            #160408-00009#1-----s

            ##若為負數金額,則借貸方向要相反
            IF l_tmp.c < 0 THEN
               LET l_tmp.sw = '1'
               LET l_tmp.d = l_tmp.c * -1
               LET l_tmp.sum = l_tmp.sum * -1 #原幣
               LET l_tmp.glaq010 = l_tmp.glaq010 * -1
               LET l_tmp.c = 0
               LET l_tmp.glaq040 = l_tmp.glaq041 * -1
               LET l_tmp.glaq041 = 0
               LET l_tmp.glaq043 = l_tmp.glaq044 * -1
               LET l_tmp.glaq044 = 0
            END IF
            ##160408-00009#1-----e            
            
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) AND cl_null(l_tmp.glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) AND cl_null(l_tmp.glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) AND cl_null(l_tmp.glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) AND cl_null(l_tmp.glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) AND cl_null(l_tmp.glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) AND cl_null(l_tmp.glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) AND cl_null(l_tmp.glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) AND cl_null(l_tmp.glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) AND cl_null(l_tmp.glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) AND cl_null(l_tmp.glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) AND cl_null(l_tmp.glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) AND cl_null(l_tmp.glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) AND cl_null(l_tmp.glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) AND cl_null(l_tmp.glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) AND cl_null(l_tmp.glaq033) THEN LET l_tmp.glaq033 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) AND cl_null(l_tmp.glaq034) THEN LET l_tmp.glaq034 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) AND cl_null(l_tmp.glaq035) THEN LET l_tmp.glaq035 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) AND cl_null(l_tmp.glaq036) THEN LET l_tmp.glaq036 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) AND cl_null(l_tmp.glaq037) THEN LET l_tmp.glaq037 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) AND cl_null(l_tmp.glaq038) THEN LET l_tmp.glaq038 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
      WHEN '5C'   #4.已宣告未領取利息>>銀存科目>>借：銀行存款fmnf031
         FOREACH s_voucher_gen_fm_5_cs14 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_5_cs14'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            
            #160408-00009#1-----s
            ##若為負數金額,則借貸方向要相反
            IF l_tmp.d < 0 THEN 
               LET l_tmp.sw = '2'
               LET l_tmp.c = l_tmp.d * -1
               LET l_tmp.glaq010 = l_tmp.glaq010 * -1
               LET l_tmp.sum = l_tmp.sum * -1 #原幣
               LET l_tmp.d = 0
               LET l_tmp.glaq041 = l_tmp.glaq040 * -1
               LET l_tmp.glaq040 = 0
               LET l_tmp.glaq044 = l_tmp.glaq043 * -1
               LET l_tmp.glaq043 = 0
            END IF
            ##160408-00009#1-----e            
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) AND cl_null(l_tmp.glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) AND cl_null(l_tmp.glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) AND cl_null(l_tmp.glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) AND cl_null(l_tmp.glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) AND cl_null(l_tmp.glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) AND cl_null(l_tmp.glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) AND cl_null(l_tmp.glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) AND cl_null(l_tmp.glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) AND cl_null(l_tmp.glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) AND cl_null(l_tmp.glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) AND cl_null(l_tmp.glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) AND cl_null(l_tmp.glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) AND cl_null(l_tmp.glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) AND cl_null(l_tmp.glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) AND cl_null(l_tmp.glaq033) THEN LET l_tmp.glaq033 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) AND cl_null(l_tmp.glaq034) THEN LET l_tmp.glaq034 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) AND cl_null(l_tmp.glaq035) THEN LET l_tmp.glaq035 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) AND cl_null(l_tmp.glaq036) THEN LET l_tmp.glaq036 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) AND cl_null(l_tmp.glaq037) THEN LET l_tmp.glaq037 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) AND cl_null(l_tmp.glaq038) THEN LET l_tmp.glaq038 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
      WHEN '5D'   #5.已宣告未領取股利>>會計科目一>>貸：已宣告未領取利息科目fmnf029
         FOREACH s_voucher_gen_fm_5_cs15 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_5_cs15'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            
            #160408-00009#1-----s
            IF l_tmp.c < 0 THEN
               LET l_tmp.sw = '1'
               LET l_tmp.d = l_tmp.c * -1
               LET l_tmp.sum = l_tmp.sum * -1 #原幣
               LET l_tmp.glaq010 = l_tmp.glaq010 * -1
               LET l_tmp.c = 0
               LET l_tmp.glaq040 = l_tmp.glaq041 * -1
               LET l_tmp.glaq041 = 0
               LET l_tmp.glaq043 = l_tmp.glaq044 * -1
               LET l_tmp.glaq044 = 0
            END IF
            ##160408-00009#1-----e
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) AND cl_null(l_tmp.glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) AND cl_null(l_tmp.glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) AND cl_null(l_tmp.glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) AND cl_null(l_tmp.glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) AND cl_null(l_tmp.glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) AND cl_null(l_tmp.glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) AND cl_null(l_tmp.glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) AND cl_null(l_tmp.glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) AND cl_null(l_tmp.glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) AND cl_null(l_tmp.glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) AND cl_null(l_tmp.glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) AND cl_null(l_tmp.glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) AND cl_null(l_tmp.glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) AND cl_null(l_tmp.glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) AND cl_null(l_tmp.glaq033) THEN LET l_tmp.glaq033 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) AND cl_null(l_tmp.glaq034) THEN LET l_tmp.glaq034 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) AND cl_null(l_tmp.glaq035) THEN LET l_tmp.glaq035 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) AND cl_null(l_tmp.glaq036) THEN LET l_tmp.glaq036 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) AND cl_null(l_tmp.glaq037) THEN LET l_tmp.glaq037 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) AND cl_null(l_tmp.glaq038) THEN LET l_tmp.glaq038 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
      WHEN '5E'   #5.已宣告未領取股利>>銀存科目>>借：銀行存款fmnf031
         FOREACH s_voucher_gen_fm_5_cs16 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_5_cs16'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            
            #160408-00009#1-----s

            ##若為負數金額,則借貸方向要相反
            IF l_tmp.d < 0 THEN 
               LET l_tmp.sw = '2'
               LET l_tmp.c = l_tmp.d * -1
               LET l_tmp.glaq010 = l_tmp.glaq010 * -1
               LET l_tmp.sum = l_tmp.sum * -1 #原幣
               LET l_tmp.d = 0
               LET l_tmp.glaq041 = l_tmp.glaq040 * -1
               LET l_tmp.glaq040 = 0
               LET l_tmp.glaq044 = l_tmp.glaq043 * -1
               LET l_tmp.glaq043 = 0
            END IF
            ##160408-00009#1-----e            
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) AND cl_null(l_tmp.glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) AND cl_null(l_tmp.glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) AND cl_null(l_tmp.glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) AND cl_null(l_tmp.glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) AND cl_null(l_tmp.glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) AND cl_null(l_tmp.glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) AND cl_null(l_tmp.glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) AND cl_null(l_tmp.glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) AND cl_null(l_tmp.glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) AND cl_null(l_tmp.glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) AND cl_null(l_tmp.glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) AND cl_null(l_tmp.glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) AND cl_null(l_tmp.glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) AND cl_null(l_tmp.glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) AND cl_null(l_tmp.glaq033) THEN LET l_tmp.glaq033 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) AND cl_null(l_tmp.glaq034) THEN LET l_tmp.glaq034 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) AND cl_null(l_tmp.glaq035) THEN LET l_tmp.glaq035 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) AND cl_null(l_tmp.glaq036) THEN LET l_tmp.glaq036 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) AND cl_null(l_tmp.glaq037) THEN LET l_tmp.glaq037 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) AND cl_null(l_tmp.glaq038) THEN LET l_tmp.glaq038 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
      #151112-00009#3 add end---
       
       
      #140804-00008#18 Hans 150525-s
      WHEN '61'   #借:對方科目 
        #FOREACH s_voucher_gen_fm_6_cs1 USING p_docno INTO l_tmp.*            #150924-00006#8 mark
         FOREACH s_voucher_gen_fm_6_cs1 USING p_docno INTO l_tmp.*,l_fmmx029  #150924-00006#8
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_6_cs1'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            
            #150924-00006#8 add ------
            CASE
               WHEN l_tmp.state = '1' #1:收息單 貸:fmmx030利息費用科目
               ##151117-00001#7  ----s---
#                  #抓取afmt565的金額 
#                  #投資組織 /收息單號
#                  SELECT fmmx001,fmmx002 
#                   INTO l_fmmx001,l_fmmx002
#                   FROM fmmx_t 
#                  WHERE fmmxent = g_enterprise
#                    AND fmmxdocno = l_tmp.docno
#                    AND fmmxseq  = l_tmp.seq
#          
#                #投資購買單號
#                SELECT fmmv001 INTO l_fmmv001 FROM fmmv_t
#                WHERE fmmvent = g_enterprise
#                  AND fmmvdocno = l_fmmx002    
#                  
#                  #本期計息原幣/本幣一/二/三     
#                  SELECT SUM(fmng005),SUM(fmng009), 
#                         SUM(fmng013),SUM(fmng017)
#                    INTO l_fmng005,l_fmng009,l_fmng013,l_fmng017
#                    FROM fmmu_t,fmng_t
#                   WHERE fmmuent = fmngent AND fmmuent = g_enterprise
#                     AND fmmudocno = fmngdocno
#                     AND fmng001 = l_fmmx001
#                     AND fmng002 = l_fmmv001
#                     AND (fmmu002*100+fmmu003) <= (l_tmp.year1 * 100 + l_tmp.month1) 
#                  IF cl_null(l_fmng005) THEN LET l_fmng005 = 0 END IF
#                  IF cl_null(l_fmng009) THEN LET l_fmng009 = 0 END IF
#                  IF cl_null(l_fmng013) THEN LET l_fmng013 = 0 END IF
#                  IF cl_null(l_fmng017) THEN LET l_fmng017 = 0 END IF                     
                  ##151117-00001#7  ----e---
                  LET l_tmp.sw = '2' 
                  LET l_tmp.c = l_tmp.d
                  LET l_tmp.d = 0
                  LET l_tmp.glaq041 = l_tmp.glaq040
                  LET l_tmp.glaq040 = 0
                  LET l_tmp.glaq044 = l_tmp.glaq043
                  LET l_tmp.glaq043 = 0
                  ###151117-00001#7  ----s---
#                  LET l_fmmx112 = l_tmp.c                    
#                  LET l_fmmx101 = l_tmp.sum                   
#                  LET l_tmp.c       =  l_tmp.c - l_fmng009
#                  LET l_tmp.glaq041 = l_tmp.glaq041 - l_fmng013
#                  LET l_tmp.glaq044 = l_tmp.glaq044 - l_fmng017
#                  LET l_tmp.glaq010 = l_tmp.glaq010 - l_fmng005 
#                  LET l_tmp.sum     = l_tmp.sum - l_fmng005
                   ##151117-00001#7  ----e---
               WHEN l_tmp.state = '2' #2:費用單
                  #費用單科目改放費用科目 借費用  貸銀存
                  #LET l_tmp.glaq002 = l_fmmx030 #151105
            END CASE
            #150924-00006#8 add end---
            
            #若為負數金額,則借貸方向要相反
            IF l_tmp.d < 0 THEN 
               LET l_tmp.sw = '2'
               LET l_tmp.c = l_tmp.d * -1
               LET l_tmp.sum = l_tmp.sum * -1 #原幣
               LET l_tmp.glaq010 = l_tmp.glaq010 * -1
               LET l_tmp.d = 0
               LET l_tmp.glaq041 = l_tmp.glaq040 * -1
               LET l_tmp.glaq040 = 0
               LET l_tmp.glaq044 = l_tmp.glaq043 * -1
               LET l_tmp.glaq043 = 0
            END IF
#            CALL s_ld_sel_glaa(p_ld,'glaa001') RETURNING g_sub_success,l_tmp.glaq005
#            LET l_tmp.glaq006 = 1
            
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF                                
            #151117-00001#7---s--
#           IF  l_tmp.state = '1' THEN #fmmx030的科目
#               LET l_tmp.glaq002 = l_fmmx029
#               LET l_tmp.c       = l_fmng009 
#               LET l_tmp.sum     = l_fmng005
#               LET l_tmp.glaq010 = l_fmng005               
#               LET l_tmp.glaq041 = l_fmng013 
#               LET l_tmp.glaq044 = l_fmng017       
#               IF l_tmp.c <> 0 THEN   #151105            
#                  INSERT INTO s_voucher_fm_tmp VALUES(l_tmp.*)
#                  IF SQLCA.sqlcode THEN
#                     INITIALIZE g_errparam TO NULL
#                     LET g_errparam.code = SQLCA.sqlcode
#                     LET g_errparam.extend =  'insert s_voucher_fm_tmp'
#                     LET g_errparam.popup = FALSE
#                     CALL cl_err()
#                     RETURN r_success
#                  END IF   
#               END IF                #151105        
#            END IF
            #根據匯差金額 >0  貸方: 取匯收科目 fmmb014  else  借方: 取匯損科目 fmmb015 
            LET l_tmp.glaq002 =''
            SELECT fmmx108,fmmx002  #取匯差金額/收息單號
              INTO l_tmp.sum,l_fmmx002
              FROM fmmx_t
             WHERE fmmxent = g_enterprise
               AND fmmxdocno = l_tmp.docno AND fmmxseq = l_tmp.seq
             #投資購買單號
             SELECT fmmv001 INTO l_fmmv001 FROM fmmv_t
              WHERE fmmvent = g_enterprise   
                AND fmmvdocno = l_fmmx002       
             #取得投資購買類型
             SELECT fmmj003 INTO l_fmmj003
               FROM fmmj_t 
              WHERE fmmjent = g_enterprise
                AND fmmjdocno = l_fmmv001
            #幣別一律給本幣匯率一律給1    
            CALL s_ld_sel_glaa(p_ld,'glaa001') RETURNING g_sub_success,l_tmp.glaq005  
            IF  l_tmp.sum <> 0 THEN
               IF l_tmp.sum > 0 THEN
                 #貸 取匯收科目 fmmb014
                 SELECT fmmb014 INTO l_tmp.glaq002 FROM fmmb_t
                  WHERE fmmb001 = l_fmmj003 #購買單投資類型
                    AND fmmb002 = p_ld      #帳套
                    AND fmmbent = g_enterprise   
                  LET l_tmp.sw = '2' 
                  LET l_tmp.c = l_tmp.sum
                  LET l_tmp.glaq010 = l_tmp.sum
                  LET l_tmp.d = 0
                  LET l_tmp.glaq006 = 1  #匯率
                  LET l_tmp.glaq039 = 1  #匯率(本位幣二)
                  LET l_tmp.glaq040 = 0  #借方金額(本位幣二)
                  LET l_tmp.glaq041 = 0  #貸方金額(本位幣二)
                  LET l_tmp.glaq042 = 1  #匯率(本位幣三)   
                  LET l_tmp.glaq043 = 0  #借方金額(本位幣三)
                  LET l_tmp.glaq044 = 0  #貸方金額(本位幣三)
               ELSE  #借 匯損科目 fmmb015
                 SELECT fmmb015 INTO l_tmp.glaq002 FROM fmmb_t
                  WHERE fmmb001 = l_fmmj003 #購買單投資類型
                    AND fmmb002 = p_ld      #帳套
                    AND fmmbent = g_enterprise   
                  LET l_tmp.sum = l_tmp.sum  * -1 #金額轉正
                  LET l_tmp.sw = '1' 
                  LET l_tmp.c = 0
                  LET l_tmp.d = l_tmp.sum
                  LET l_tmp.glaq010 = l_tmp.sum
                  LET l_tmp.glaq006 = 1  #匯率
                  LET l_tmp.glaq039 = 1  #匯率(本位幣二)
                  LET l_tmp.glaq040 = 0  #借方金額(本位幣二)
                  LET l_tmp.glaq041 = 0  #貸方金額(本位幣二)
                  LET l_tmp.glaq042 = 1  #匯率(本位幣三)   
                  LET l_tmp.glaq043 = 0  #借方金額(本位幣三)
                  LET l_tmp.glaq044 = 0  #貸方金額(本位幣三)
               END IF    
               IF NOT cl_null(l_tmp.glaq002)THEN
                  INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
                     LET g_errparam.popup = FALSE
                     CALL cl_err()
                     RETURN r_success
                  END IF            
               END IF              
            END IF
            #151117-00001#7---e--- 
               
         END FOREACH
         
      WHEN '62'   #貸:費用對象科目
        #FOREACH s_voucher_gen_fm_6_cs2 USING p_docno INTO l_tmp.*,l_fmmx004  #150924-00006#8 mark
         FOREACH s_voucher_gen_fm_6_cs2 USING p_docno INTO l_tmp.*,l_fmmx004  #150924-00006#8
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_6_cs2'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            
            #150924-00006#8 add ------
            IF l_fmmx004 = '2' THEN #2:利息自動轉本金 不用現金變動碼
               LET l_tmp.glgb055 = ''
            END IF
            
            CASE
               WHEN l_tmp.state = '1' #1:收息單
                  #收息單是 借銀存  貸收入
                  LET l_tmp.sw = '1'
                  LET l_tmp.d = l_tmp.c
                  LET l_tmp.c = 0
                  LET l_tmp.glaq040 = l_tmp.glaq041
                  LET l_tmp.glaq041 = 0
                  LET l_tmp.glaq043 = l_tmp.glaq044
                  LET l_tmp.glaq044 = 0
               WHEN l_tmp.state = '2' #2:費用單
               
            END CASE
            #150924-00006#8 add end---
            
            #若為負數金額,則借貸方向要相反
            IF l_tmp.c < 0 THEN 
               LET l_tmp.sw = '1'
               LET l_tmp.d = l_tmp.c * -1
               LET l_tmp.sum = l_tmp.sum * -1 #原幣
               LET l_tmp.glaq010 = l_tmp.glaq010 * -1
               LET l_tmp.c = 0
               LET l_tmp.glaq040 = l_tmp.glaq041 * -1
               LET l_tmp.glaq041 = 0
               LET l_tmp.glaq043 = l_tmp.glaq044 * -1
               LET l_tmp.glaq044 = 0
            END IF
#            CALL s_ld_sel_glaa(p_ld,'glaa001') RETURNING g_sub_success,l_tmp.glaq005
#            LET l_tmp.glaq006 = 1
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            # 貸利息fmmx029
            IF l_tmp.state = '1' THEN #1:收息單            
               SELECT fmmx029,fmmx107,fmmx105,fmmx106,fmmx105
                 INTO l_tmp.glaq002,l_tmp.c,l_tmp.glaq010,l_tmp.glaq006,l_tmp.sum
                 FROM fmmx_t
                WHERE fmmxent = g_enterprise AND fmmxdocno = l_tmp.docno
                  AND fmmxseq = l_tmp.seq
               LET l_tmp.d = 0 
               LET l_tmp.sw = '2'
               LET l_tmp.glaq041 = l_tmp.glaq040
               LET l_tmp.glaq040 = 0
               LET l_tmp.glaq044 = l_tmp.glaq043
               LET l_tmp.glaq043 = 0
               IF l_tmp.c > 0 THEN
                  INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)      #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08           
               END IF
            END IF
         END FOREACH  
      #140804-00008#18 Hans 150525-e
   
      #140804-00008#15 add ------
      WHEN '71' #借:應收股利/利息科目
         FOREACH s_voucher_gen_fm_7_cs1 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_7_cs1'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            #抓取歸屬法人
            CALL s_ld_sel_glaa(p_ld,'glaacomp') RETURNING g_sub_success,l_tmp.glaqcomp
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
      
      WHEN '72' #貸:投資收益科目
         FOREACH s_voucher_gen_fm_7_cs2 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_7_cs2'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            #抓取歸屬法人
            CALL s_ld_sel_glaa(p_ld,'glaacomp') RETURNING g_sub_success,l_tmp.glaqcomp
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
     
      WHEN '73' #利息調整科目
         #該科目放置原則：
         #計提金額$(借方)<投資收益$(貸方)，表示該科目在借方
         #計提金額$(借方)>投資收益$(貸方)，表示該科目在貸方
         FOREACH s_voucher_gen_fm_7_cs3 USING p_docno INTO l_tmp.*
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_7_cs3'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            #計算目前借貸各方總額
            SELECT SUM(d),SUM(c) INTO l_sum_d,l_sum_c
              FROM s_vr_tmp08  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
             WHERE glaqent = l_tmp.glaqent
               AND docno   = l_tmp.docno
            #計提金額$>投資收益$，表示該科目在貸方
            IF l_sum_d > l_sum_c THEN
               #170509-00094#7---add---start---
               IF l_tmp.d < 0 THEN
                  LET l_tmp.d = l_tmp.d * -1
               END IF
               IF l_tmp.sum < 0 THEN
                  LET l_tmp.sum = l_tmp.sum * -1
               END IF
               IF l_tmp.glaq010 < 0 THEN
                  LET l_tmp.glaq010 = l_tmp.glaq010 * -1
               END IF
               #170509-00094#7---add---end---
               LET l_tmp.sw = '2'
               LET l_tmp.c = l_tmp.d 
               LET l_tmp.sum = l_tmp.sum  #原幣
               LET l_tmp.d = 0
               LET l_tmp.glaq041 = l_tmp.glaq040  #本位幣二
               LET l_tmp.glaq040 = 0
               LET l_tmp.glaq044 = l_tmp.glaq043  #本位幣三
               LET l_tmp.glaq043 = 0
            END IF
            #抓取歸屬法人
            CALL s_ld_sel_glaa(p_ld,'glaacomp') RETURNING g_sub_success,l_tmp.glaqcomp
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
      #140804-00008#15 add end---
      
      
      #140804-00008#9 add ------
      WHEN '81' #借:投資類型科目
         FOREACH s_voucher_gen_fm_8_cs1 USING p_docno INTO l_tmp.*,l_fmmm003,l_fmmm004,l_fmmm005
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_8_cs1'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            IF l_fmmm004 <> '4' THEN
               #支付方式非 2:使用市場帳戶資金/3:銀行帳戶支付 不產生分錄
               LET l_fmmj011 = ''
               SELECT fmmj011 INTO l_fmmj011
                 FROM fmmj_t
                WHERE fmmjent = g_enterprise
                  AND fmmjdocno = l_fmmm003
               IF l_fmmj011 NOT MATCHES '[23]' THEN
                  CONTINUE FOREACH
               END IF
            END IF
            
            #-----本金金額處理-----(s)
            #是否單身有來源為面值
            LET l_cnt = 0
            SELECT COUNT (fmmm004) INTO l_cnt
              FROM fmml_t,fmmm_t
             WHERE fmmlent = fmmment
               AND fmmldocno = fmmm001
               AND fmmlent = g_enterprise
               AND fmmldocno = p_docno
               AND fmmm004 = '5'
            #有面值
            IF l_cnt > 0 THEN
            #利息調整分錄計算:本金-面值(金額為負責借貸相反)   
            #本金分錄計算    :面值-已宣告未發放股利-已到期未領取利息               
               CASE l_fmmm004 
                  WHEN '1'  
                     #150924-00006#8 mark ------
                     ##原幣fmmm008/本幣fmmm010/本位幣二fmmm014/本位幣三fmmm016
                     #LET l_fmmm008 = 0   LET l_fmmm010 = 0   LET l_fmmm014 = 0   LET l_fmmm016 = 0    
                     ##本金(來源1) - 面額(來源5)                    
                     #SELECT SUM (CASE fmmm004 WHEN '1' THEN fmmm008 ELSE fmmm008 * -1 END),
                     #       SUM (CASE fmmm004 WHEN '1' THEN fmmm010 ELSE fmmm010 * -1 END),
                     #       SUM (CASE fmmm004 WHEN '1' THEN fmmm014 ELSE fmmm014 * -1 END),
                     #       SUM (CASE fmmm004 WHEN '1' THEN fmmm016 ELSE fmmm016 * -1 END)
                     #  INTO l_fmmm008,l_fmmm010,l_fmmm014,l_fmmm016
                     #  FROM fmml_t, fmmm_t
                     # WHERE fmmlent = fmmment
                     #   AND fmmldocno = fmmm001
                     #   AND fmmlent = g_enterprise
                     #   AND fmmldocno = p_docno
                     #   AND fmmm003 = l_fmmm003
                     #   AND fmmm004 NOT IN ('2','3','4')
                     #IF cl_null(l_fmmm008) THEN LET l_fmmm008 = 0 END IF
                     #IF cl_null(l_fmmm010) THEN LET l_fmmm010 = 0 END IF
                     #IF cl_null(l_fmmm014) THEN LET l_fmmm014 = 0 END IF
                     #IF cl_null(l_fmmm016) THEN LET l_fmmm016 = 0 END IF
                     #LET l_tmp.sum = l_fmmm008
                     #LET l_tmp.d = l_fmmm010
                     #LET l_tmp.glaq040 = l_fmmm014
                     #LET l_tmp.glaq043 = l_fmmm016
                     ##若為負數金額,則借貸方向要相反
                     #IF l_tmp.d < 0 THEN 
                     #   LET l_tmp.sw = '2'
                     #   LET l_tmp.c = l_tmp.d * -1
                     #   LET l_tmp.sum = l_tmp.sum * -1 #原幣
                     #   LET l_tmp.d = 0
                     #   LET l_tmp.glaq041 = l_tmp.glaq040 * -1 #本位幣二
                     #   LET l_tmp.glaq040 = 0
                     #   LET l_tmp.glaq044 = l_tmp.glaq043 * -1 #本位幣三
                     #   LET l_tmp.glaq043 = 0
                     #END IF
                     #150924-00006#8 mark end---
                     #150924-00006#8 add ------
                     LET l_fmmm008 = 0  LET l_fmmm010 = 0   LET l_fmmm014 = 0   LET l_fmmm016 = 0
                    ##差異金額 = 本金(來源1) - 面額(來源5) - 已宣告未發放股利(來源2) - 已到期未領取利息(來源3)
                     #差異金額 = 本金(來源1) - 面額(來源5)    #160223-00009#1 mod
                     SELECT SUM (CASE fmmm004 WHEN '1' THEN fmmm008 ELSE fmmm008 * -1 END),
                            SUM (CASE fmmm004 WHEN '1' THEN fmmm010 ELSE fmmm010 * -1 END),
                            SUM (CASE fmmm004 WHEN '1' THEN fmmm014 ELSE fmmm014 * -1 END),
                            SUM (CASE fmmm004 WHEN '1' THEN fmmm016 ELSE fmmm016 * -1 END)
                       INTO l_fmmm008,l_fmmm010,l_fmmm014,l_fmmm016
                       FROM fmml_t, fmmm_t
                      WHERE fmmlent = fmmment
                        AND fmmldocno = fmmm001
                        AND fmmlent = g_enterprise
                        AND fmmldocno = p_docno
                        AND fmmm003 = l_fmmm003
                       #AND fmmm004 NOT IN ('4')
                        AND fmmm004 IN ('1','5')  #160223-00009#1 mod
                     IF cl_null(l_fmmm008) THEN LET l_fmmm008 = 0 END IF
                     IF cl_null(l_fmmm010) THEN LET l_fmmm010 = 0 END IF
                     IF cl_null(l_fmmm014) THEN LET l_fmmm014 = 0 END IF
                     IF cl_null(l_fmmm016) THEN LET l_fmmm016 = 0 END IF
                     #天哥舉例(2015/09/28)
                     #本金800  面值900  已宣告未發放股利30
                     #借：投資科目900
                     #    應收股息30
                     #    貸：銀行存款800
                     #        差異科目130
                     #本金900  面值800  已宣告未發放股利30
                     #借：投資科目800
                     #    應收股息30
                     #    差異科目70
                     #    貸：銀行存款900
                     IF l_fmmm008 <> 0 THEN
                        #抓取差異科目(afmi520) 利息調整科目fmmb009
                        SELECT fmmb009 INTO l_tmp.glaq002
                          FROM fmmm_t
                          LEFT JOIN fmmj_t ON fmmjent = fmmment AND fmmjdocno = fmmm003
                          LEFT JOIN fmmb_t ON fmmbent = fmmjent AND fmmb001 = fmmj003
                         WHERE fmmment = g_enterprise
                           AND fmmm001 = p_docno
                           AND fmmm003 = l_fmmm003
                           AND fmmm004 = '1'
                           AND fmmb002 = l_tmp.glaqld
                        IF l_fmmm008 > 0 THEN #差異科目>0放借方
                           LET l_tmp.sw = '1'
                           LET l_tmp.d = l_fmmm010
                           LET l_tmp.sum = l_fmmm008 #原幣
                           LET l_tmp.c = 0
                           LET l_tmp.glaq040 = l_fmmm014 #本位幣二
                           LET l_tmp.glaq041 = 0
                           LET l_tmp.glaq043 = l_fmmm016 #本位幣三
                           LET l_tmp.glaq044 = 0
                        ELSE
                           LET l_tmp.sw = '2'
                           LET l_tmp.c = l_fmmm010 * -1
                           LET l_tmp.sum = l_fmmm008 * -1 #原幣
                           LET l_tmp.d = 0
                           LET l_tmp.glaq041 = l_fmmm014 * -1 #本位幣二
                           LET l_tmp.glaq040 = 0
                           LET l_tmp.glaq044 = l_fmmm016 * -1 #本位幣三
                           LET l_tmp.glaq043 = 0
                        END IF
                     #151013-00019#7 add ------
                     ELSE
                        CONTINUE FOREACH
                     #151013-00019#7 add end---
                     END IF
                     #150924-00006#8 add end---
                  
                  WHEN '5'
                     #150924-00006#8 mark ------
                     ##原幣fmmm008/本幣fmmm010/本位幣二fmmm014/本位幣三fmmm016
                     #LET l_fmmm008 = 0   LET l_fmmm010 = 0   LET l_fmmm014 = 0   LET l_fmmm016 = 0
                     ##面額(來源5) - 已宣告未發放股利(來源2) - 已到期未領取利息(來源3)
                     #SELECT SUM (CASE fmmm004 WHEN '5' THEN fmmm008 ELSE fmmm008 * -1 END),
                     #       SUM (CASE fmmm004 WHEN '5' THEN fmmm010 ELSE fmmm010 * -1 END),
                     #       SUM (CASE fmmm004 WHEN '5' THEN fmmm014 ELSE fmmm014 * -1 END),
                     #       SUM (CASE fmmm004 WHEN '5' THEN fmmm016 ELSE fmmm016 * -1 END)
                     #  INTO l_fmmm008,l_fmmm010,l_fmmm014,l_fmmm016
                     #  FROM fmml_t, fmmm_t
                     # WHERE fmmlent = fmmment
                     #   AND fmmldocno = fmmm001
                     #   AND fmmlent = g_enterprise
                     #   AND fmmldocno = p_docno
                     #   AND fmmm003 = l_fmmm003
                     #   AND fmmm004 NOT IN ('1','4')
                     #IF cl_null(l_fmmm008) THEN LET l_fmmm008 = 0 END IF
                     #IF cl_null(l_fmmm010) THEN LET l_fmmm010 = 0 END IF
                     #IF cl_null(l_fmmm014) THEN LET l_fmmm014 = 0 END IF
                     #IF cl_null(l_fmmm016) THEN LET l_fmmm016 = 0 END IF
                     #LET l_tmp.sum = l_fmmm008
                     #LET l_tmp.d = l_fmmm010
                     #LET l_tmp.glaq040 = l_fmmm014
                     #LET l_tmp.glaq043 = l_fmmm016
                     #150924-00006#8 mark end---

               END CASE
            ELSE
            #無面值
            #本金分錄計算:面值-已宣告未發放股利-已到期未領取利息             
               CASE l_fmmm004 
                  WHEN '1'
                     #原幣fmmm008/本幣fmmm010/本位幣二fmmm014/本位幣三fmmm016
                     LET l_fmmm008 = 0   LET l_fmmm010 = 0   LET l_fmmm014 = 0   LET l_fmmm016 = 0   
                     #本金(來源1) - 已宣告未發放股利(來源2) - 已到期未領取利息(來源3)                    
                     SELECT SUM (CASE fmmm004 WHEN '1' THEN fmmm008 ELSE fmmm008 * -1 END),
                            SUM (CASE fmmm004 WHEN '1' THEN fmmm010 ELSE fmmm010 * -1 END),
                            SUM (CASE fmmm004 WHEN '1' THEN fmmm014 ELSE fmmm014 * -1 END),
                            SUM (CASE fmmm004 WHEN '1' THEN fmmm016 ELSE fmmm016 * -1 END)
                       INTO l_fmmm008,l_fmmm010,l_fmmm014,l_fmmm016
                       FROM fmml_t, fmmm_t
                      WHERE fmmlent = fmmment
                        AND fmmldocno = fmmm001
                        AND fmmlent = g_enterprise
                        AND fmmldocno = p_docno
                        AND fmmm003 = l_fmmm003
                       #AND fmmm004 NOT IN ('4')
                        AND fmmm004 IN ('1')   #160223-00009#1 mod                          
                     IF cl_null(l_fmmm008) THEN LET l_fmmm008 = 0 END IF
                     IF cl_null(l_fmmm010) THEN LET l_fmmm010 = 0 END IF
                     IF cl_null(l_fmmm014) THEN LET l_fmmm014 = 0 END IF
                     IF cl_null(l_fmmm016) THEN LET l_fmmm016 = 0 END IF
                     LET l_tmp.sum = l_fmmm008
                     LET l_tmp.d = l_fmmm010
                     LET l_tmp.glaq040 = l_fmmm014
                     LET l_tmp.glaq043 = l_fmmm016
               END CASE
            END IF
            #-----本金金額處理-----(e)
            
            CALL s_pre_voucher_glad034_get(p_ld,l_tmp.glaq002) RETURNING l_glad034
            IF l_glad034 = 'N' OR cl_null(l_glad034) THEN    #科目未啟用多幣別管理
               CALL s_ld_sel_glaa(p_ld,'glaa001') RETURNING g_sub_success,l_tmp.glaq005
               LET l_tmp.glaq006 = 1
               IF l_tmp.d <> 0 THEN
                  LET l_tmp.sum = l_tmp.d
               END IF
               IF l_tmp.c <> 0 THEN
                  LET l_tmp.sum = l_tmp.c
               END IF 
            END IF
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            LET l_tmp.glaq010 = l_tmp.sum
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            
         END FOREACH
      
      WHEN '82' #貸:支付方式科目
         FOREACH s_voucher_gen_fm_8_cs2 USING p_docno INTO l_tmp.*,l_fmmm003,l_fmmm004,l_fmmm005
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_fm_8_cs2'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            IF l_fmmm004 <> '4' THEN
               #支付方式非 2:使用市場帳戶資金/3:銀行帳戶支付 不產生分錄
               LET l_fmmj011 = ''
               SELECT fmmj011 INTO l_fmmj011
                 FROM fmmj_t
                WHERE fmmjent = g_enterprise
                  AND fmmjdocno = l_fmmm003
               IF l_fmmj011 NOT MATCHES '[23]' THEN
                  CONTINUE FOREACH
               END IF
            END IF
            #-----本金金額處理-----(s)
            #是否單身有來源為面值
            LET l_cnt = 0
            SELECT COUNT (fmmm004) INTO l_cnt
              FROM fmml_t,fmmm_t
             WHERE fmmlent = fmmment
               AND fmmldocno = fmmm001
               AND fmmlent = g_enterprise
               AND fmmldocno = p_docno
               AND fmmm004 = '5'
            #有面值
            IF l_cnt > 0 THEN
            #利息調整分錄計算:本金-面值(金額為負責借貸相反)
            #本金分錄計算    :面值-已宣告未發放股利-已到期未領取利息
               CASE l_fmmm004
                  WHEN '1'
                     #150924-00006#8 mark ------
                     ##原幣fmmm008/本幣fmmm010/本位幣二fmmm014/本位幣三fmmm016
                     #LET l_fmmm008 = 0   LET l_fmmm010 = 0   LET l_fmmm014 = 0   LET l_fmmm016 = 0
                     ##本金(來源1) - 面額(來源5)
                     #SELECT SUM (CASE fmmm004 WHEN '1' THEN fmmm008 ELSE fmmm008 * -1 END),
                     #       SUM (CASE fmmm004 WHEN '1' THEN fmmm010 ELSE fmmm010 * -1 END),
                     #       SUM (CASE fmmm004 WHEN '1' THEN fmmm014 ELSE fmmm014 * -1 END),
                     #       SUM (CASE fmmm004 WHEN '1' THEN fmmm016 ELSE fmmm016 * -1 END)
                     #  INTO l_fmmm008,l_fmmm010,l_fmmm014,l_fmmm016
                     #  FROM fmml_t, fmmm_t
                     # WHERE fmmlent = fmmment
                     #   AND fmmldocno = fmmm001
                     #   AND fmmlent = g_enterprise
                     #   AND fmmldocno = p_docno
                     #   AND fmmm003 = l_fmmm003
                     #   AND fmmm004 NOT IN ('2','3','4')
                     #IF cl_null(l_fmmm008) THEN LET l_fmmm008 = 0 END IF
                     #IF cl_null(l_fmmm010) THEN LET l_fmmm010 = 0 END IF
                     #IF cl_null(l_fmmm014) THEN LET l_fmmm014 = 0 END IF
                     #IF cl_null(l_fmmm016) THEN LET l_fmmm016 = 0 END IF
                     #LET l_tmp.sum = l_fmmm008
                     #LET l_tmp.c = l_fmmm010
                     #LET l_tmp.glaq041 = l_fmmm014
                     #LET l_tmp.glaq044 = l_fmmm016
                     ##若為負數金額,則借貸方向要相反
                     #IF l_tmp.c < 0 THEN 
                     #   LET l_tmp.sw = '1'
                     #   LET l_tmp.d = l_tmp.c * -1
                     #   LET l_tmp.sum = l_tmp.sum * -1 #原幣
                     #   LET l_tmp.c = 0
                     #   LET l_tmp.glaq040 = l_tmp.glaq041 * -1 #本位幣二
                     #   LET l_tmp.glaq041 = 0
                     #   LET l_tmp.glaq043 = l_tmp.glaq044 * -1 #本位幣三
                     #   LET l_tmp.glaq044 = 0
                     #END IF
                     #150924-00006#8 mark end---
                     #150924-00006#8 add ------
                     LET l_fmmm008 = 0  LET l_fmmm010 = 0   LET l_fmmm014 = 0   LET l_fmmm016 = 0
                     ##對方科目銀存金額 = 本金(來源1) - 已宣告未發放股利(來源2) - 已到期未領取利息(來源3)
                     #對方科目銀存金額 = 本金(來源1) - 已宣告未發放股利(來源2)    #160223-00009#1 mod
                     SELECT SUM (CASE fmmm004 WHEN '1' THEN fmmm008 ELSE fmmm008 * -1 END),
                            SUM (CASE fmmm004 WHEN '1' THEN fmmm010 ELSE fmmm010 * -1 END),
                            SUM (CASE fmmm004 WHEN '1' THEN fmmm014 ELSE fmmm014 * -1 END),
                            SUM (CASE fmmm004 WHEN '1' THEN fmmm016 ELSE fmmm016 * -1 END)
                       INTO l_fmmm008,l_fmmm010,l_fmmm014,l_fmmm016
                       FROM fmml_t, fmmm_t
                      WHERE fmmlent = fmmment
                        AND fmmldocno = fmmm001
                        AND fmmlent = g_enterprise
                        AND fmmldocno = p_docno
                        AND fmmm003 = l_fmmm003
                       #AND fmmm004 NOT IN ('4','5')
                        AND fmmm004 NOT IN ('2','3','4','5')  #160223-00009#1 mod                         
                     IF cl_null(l_fmmm008) THEN LET l_fmmm008 = 0 END IF
                     IF cl_null(l_fmmm010) THEN LET l_fmmm010 = 0 END IF
                     IF cl_null(l_fmmm014) THEN LET l_fmmm014 = 0 END IF
                     IF cl_null(l_fmmm016) THEN LET l_fmmm016 = 0 END IF
                     LET l_tmp.sum = l_fmmm008
                     LET l_tmp.c = l_fmmm010
                     LET l_tmp.glaq041 = l_fmmm014
                     LET l_tmp.glaq044 = l_fmmm016
                     #若為負數金額,則借貸方向要相反
                     IF l_tmp.c < 0 THEN 
                        LET l_tmp.sw = '1'
                        LET l_tmp.d = l_tmp.c * -1
                        LET l_tmp.sum = l_tmp.sum * -1 #原幣
                        LET l_tmp.glaq010 = l_tmp.glaq010 * -1
                        LET l_tmp.c = 0
                        LET l_tmp.glaq040 = l_tmp.glaq041 * -1 #本位幣二
                        LET l_tmp.glaq041 = 0
                        LET l_tmp.glaq043 = l_tmp.glaq044 * -1 #本位幣三
                        LET l_tmp.glaq044 = 0
                     END IF
                     #150924-00006#8 add end---
                     
                  WHEN '5'
                     #150924-00006#8 mark ------
                     ##原幣fmmm008/本幣fmmm010/本位幣二fmmm014/本位幣三fmmm016
                     #LET l_fmmm008 = 0   LET l_fmmm010 = 0   LET l_fmmm014 = 0   LET l_fmmm016 = 0
                     ##面額(來源5) - 已宣告未發放股利(來源2) - 已到期未領取利息(來源3)
                     #SELECT SUM (CASE fmmm004 WHEN '5' THEN fmmm008 ELSE fmmm008 * -1 END),
                     #       SUM (CASE fmmm004 WHEN '5' THEN fmmm010 ELSE fmmm010 * -1 END),
                     #       SUM (CASE fmmm004 WHEN '5' THEN fmmm014 ELSE fmmm014 * -1 END),
                     #       SUM (CASE fmmm004 WHEN '5' THEN fmmm016 ELSE fmmm016 * -1 END)
                     #  INTO l_fmmm008,l_fmmm010,l_fmmm014,l_fmmm016
                     #  FROM fmml_t, fmmm_t
                     # WHERE fmmlent = fmmment
                     #   AND fmmldocno = fmmm001
                     #   AND fmmlent = g_enterprise
                     #   AND fmmldocno = p_docno
                     #   AND fmmm003 = l_fmmm003
                     #   AND fmmm004 NOT IN ('1','4')
                     #IF cl_null(l_fmmm008) THEN LET l_fmmm008 = 0 END IF
                     #IF cl_null(l_fmmm010) THEN LET l_fmmm010 = 0 END IF
                     #IF cl_null(l_fmmm014) THEN LET l_fmmm014 = 0 END IF
                     #IF cl_null(l_fmmm016) THEN LET l_fmmm016 = 0 END IF
                     #LET l_tmp.sum = l_fmmm008
                     #LET l_tmp.c = l_fmmm010
                     #LET l_tmp.glaq041 = l_fmmm014
                     #LET l_tmp.glaq044 = l_fmmm016
                     #150924-00006#8 mark end---
                     CONTINUE FOREACH #150924-00006#8
                     
               END CASE
            ELSE
            #無面值
            #本金分錄計算:面值-已宣告未發放股利-已到期未領取利息
               CASE l_fmmm004
                  WHEN '1'
                     #原幣fmmm008/本幣fmmm010/本位幣二fmmm014/本位幣三fmmm016
                     LET l_fmmm008 = 0   LET l_fmmm010 = 0   LET l_fmmm014 = 0   LET l_fmmm016 = 0
                     #本金(來源1) - 已宣告未發放股利(來源2) - 已到期未領取利息(來源3)
                     SELECT SUM (CASE fmmm004 WHEN '1' THEN fmmm008 ELSE fmmm008 * -1 END),
                            SUM (CASE fmmm004 WHEN '1' THEN fmmm010 ELSE fmmm010 * -1 END),
                            SUM (CASE fmmm004 WHEN '1' THEN fmmm014 ELSE fmmm014 * -1 END),
                            SUM (CASE fmmm004 WHEN '1' THEN fmmm016 ELSE fmmm016 * -1 END)
                       INTO l_fmmm008,l_fmmm010,l_fmmm014,l_fmmm016
                       FROM fmml_t, fmmm_t
                      WHERE fmmlent = fmmment
                        AND fmmldocno = fmmm001
                        AND fmmlent = g_enterprise
                        AND fmmldocno = p_docno
                        AND fmmm003 = l_fmmm003
                        AND fmmm004 NOT IN ('4')
                     IF cl_null(l_fmmm008) THEN LET l_fmmm008 = 0 END IF
                     IF cl_null(l_fmmm010) THEN LET l_fmmm010 = 0 END IF
                     IF cl_null(l_fmmm014) THEN LET l_fmmm014 = 0 END IF
                     IF cl_null(l_fmmm016) THEN LET l_fmmm016 = 0 END IF
                     LET l_tmp.sum = l_fmmm008
                     LET l_tmp.c = l_fmmm010
                     LET l_tmp.glaq041 = l_fmmm014
                     LET l_tmp.glaq044 = l_fmmm016
               END CASE
            END IF
            #-----本金金額處理-----(e)
            
            #150924-00006#8 mark (直接取畫面上的對方科目)------
            ##-----取貸方科目-----(s)
            #LET l_fmmjsite = ''  LET l_fmmj011 = ''   LET l_fmmj002 = ''   LET l_fmmj013 = ''
            #SELECT fmmjsite,fmmj011,fmmj002,fmmj013
            #  INTO l_fmmjsite,l_fmmj011,l_fmmj002,l_fmmj013
            #  FROM fmmj_t
            # WHERE fmmjent = g_enterprise
            #   AND fmmjdocno = l_fmmm003
            #IF l_fmmm004 <> '4' THEN
            #   CASE l_fmmj011 #投資購買單支付方式
            #      WHEN '2'    #2:使用市場帳戶資金
            #         #150820-00011#2-----s
            #         #SELECT fmnc003 INTO l_tmp.glaq002
            #         #  FROM fmnc_t
            #         # WHERE fmncent = g_enterprise
            #         #   AND fmncsite= l_fmmjsite
            #         #   AND fmnc001 = l_tmp.glaqld
            #         #   AND fmnc002 = l_fmmj002
            #         SELECT glab005 INTO l_tmp.glaq002
            #           FROM glab_t
            #          WHERE glabent = g_enterprise
            #            AND glabld  =  l_tmp.glaqld
            #            AND glab001 = '40'
            #            AND glab002 = '40'
            #           #AND glab003 = l_fmmj002  #150924-00006#8 mark
            #            AND glab003 = l_fmmj013  #150924-00006#8
            #         #150820-00011#2-----e
            #      WHEN '3'    #3:銀行帳戶支付
            #         SELECT glab005 INTO l_tmp.glaq002
            #           FROM glab_t
            #          WHERE glabent = g_enterprise
            #            AND glabld  =  l_tmp.glaqld
            #            AND glab001 = '40'
            #            AND glab002 = '40'
            #            AND glab003 = l_fmmj013
            #   END CASE
            #ELSE
            #   LET l_fmmk003 = '' LET l_fmmk006 = '' LET l_fmmk007 = '' LET l_fmmk008 = ''
            #   SELECT fmmk003,fmmk006,fmmk007,fmmk008
            #     INTO l_fmmk003,l_fmmk006,l_fmmk007,l_fmmk008
            #     FROM fmmk_t
            #    WHERE fmmkent = g_enterprise
            #      AND fmmk001 = l_fmmm003
            #      AND fmmk003 = l_fmmm005
            #   IF l_fmmk006 = 'N' THEN
            #      #取得銀行帳戶
            #      LET l_nmbb003 = ''
            #      SELECT nmbb003 INTO l_nmbb003
            #        FROM nmbb_t
            #       WHERE nmbbent   = g_enterprise
            #         AND nmbbcomp  = l_tmp.glaqcomp
            #         AND nmbbdocno = l_fmmk007
            #         AND nmbbseq   = l_fmmk008
            #      #銀行帳戶科目
            #      SELECT glab005 INTO l_tmp.glaq002
            #        FROM glab_t
            #       WHERE glabent = g_enterprise
            #         AND glabld  =  l_tmp.glaqld
            #         AND glab001 = '40'
            #         AND glab002 = '40'
            #         AND glab003 = l_nmbb003
            #   ELSE
            #      #交易市場帳戶科目
            #      #150820-00011#2-----s
            #      #SELECT fmnc003 INTO l_tmp.glaq002
            #      #  FROM fmnc_t
            #      # WHERE fmncent = g_enterprise
            #      #   AND fmncsite= l_fmmjsite
            #      #   AND fmnc001 = l_tmp.glaqld
            #      #   AND fmnc002 = l_fmmj002
            #      SELECT glab005 INTO l_tmp.glaq002
            #        FROM glab_t
            #       WHERE glabent = g_enterprise
            #         AND glabld  =  l_tmp.glaqld
            #         AND glab001 = '40'
            #         AND glab002 = '40'
            #        #AND glab003 = l_fmmj002  #150924-00006#8 mark
            #         AND glab003 = l_fmmj013  #150924-00006#8
            #      #150820-00011#2-----e 
            #   END IF
            #END IF
            #-----取貸方科目-----(e)
            #150924-00006#8 mark (直接取畫面上的對方科目) end---
            
            CALL s_pre_voucher_glad034_get(p_ld,l_tmp.glaq002) RETURNING l_glad034
            IF l_glad034 = 'N' OR cl_null(l_glad034) THEN    #科目未啟用多幣別管理
               CALL s_ld_sel_glaa(p_ld,'glaa001') RETURNING g_sub_success,l_tmp.glaq005
               LET l_tmp.glaq006 = 1
               IF l_tmp.d <> 0 THEN
                  LET l_tmp.sum = l_tmp.d
               END IF
               IF l_tmp.c <> 0 THEN
                  LET l_tmp.sum = l_tmp.c
               END IF
            END IF
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF
            IF (l_tmp.c = 0 AND l_tmp.d = 0) OR (cl_null(l_tmp.c) AND cl_null(l_tmp.d)) THEN CONTINUE FOREACH END IF
            LET l_tmp.glaq010 = l_tmp.sum
            #150814-00006#3--add--str--
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            #150814-00006#3--add--end
            INSERT INTO s_vr_tmp08 VALUES(l_tmp.*)  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp08'  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
      #140804-00008#9 add end---
   END CASE
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........: #150924-00006#8
# Usage..........: CALL s_voucher_gen_fm_1_ins_group_tmp()
#                  RETURNING l_success
# Input parameter: p_ld           帐套
#                : p_sum_type     汇总方式 
# Return code....: r_success      成功否标识位
# Date & Author..: 2015/09/30 By Reanna
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_fm_1_ins_group_tmp(p_ld,p_sum_type)
DEFINE p_ld            LIKE glaa_t.glaald
DEFINE p_sum_type      LIKE type_t.chr1
DEFINE p_wc            LIKE type_t.chr1000
DEFINE r_success       LIKE type_t.num5
#161128-00061#7---add---begin-----------
#DEFINE l_xrca          RECORD LIKE xrca_t.*
DEFINE l_xrca RECORD  #應收憑單單頭
       xrcaent LIKE xrca_t.xrcaent, #企業編號
       xrcaownid LIKE xrca_t.xrcaownid, #資料所有者
       xrcaowndp LIKE xrca_t.xrcaowndp, #資料所屬部門
       xrcacrtid LIKE xrca_t.xrcacrtid, #資料建立者
       xrcacrtdp LIKE xrca_t.xrcacrtdp, #資料建立部門
       xrcacrtdt LIKE xrca_t.xrcacrtdt, #資料創建日
       xrcamodid LIKE xrca_t.xrcamodid, #資料修改者
       xrcamoddt LIKE xrca_t.xrcamoddt, #最近修改日
       xrcacnfid LIKE xrca_t.xrcacnfid, #資料確認者
       xrcacnfdt LIKE xrca_t.xrcacnfdt, #資料確認日
       xrcapstid LIKE xrca_t.xrcapstid, #資料過帳者
       xrcapstdt LIKE xrca_t.xrcapstdt, #資料過帳日
       xrcastus LIKE xrca_t.xrcastus, #狀態碼
       xrcacomp LIKE xrca_t.xrcacomp, #法人
       xrcald LIKE xrca_t.xrcald, #帳套
       xrcadocno LIKE xrca_t.xrcadocno, #應收帳款單號碼
       xrcadocdt LIKE xrca_t.xrcadocdt, #帳款日期
       xrca001 LIKE xrca_t.xrca001, #帳款單性質
       xrcasite LIKE xrca_t.xrcasite, #帳務中心
       xrca003 LIKE xrca_t.xrca003, #帳務人員
       xrca004 LIKE xrca_t.xrca004, #帳款客戶編號
       xrca005 LIKE xrca_t.xrca005, #收款客戶
       xrca006 LIKE xrca_t.xrca006, #客戶分類
       xrca007 LIKE xrca_t.xrca007, #帳款類別
       xrca008 LIKE xrca_t.xrca008, #收款條件編號
       xrca009 LIKE xrca_t.xrca009, #應收款日/應扣抵日
       xrca010 LIKE xrca_t.xrca010, #容許票據到期日
       xrca011 LIKE xrca_t.xrca011, #稅別
       xrca012 LIKE xrca_t.xrca012, #稅率
       xrca013 LIKE xrca_t.xrca013, #含稅否
       xrca014 LIKE xrca_t.xrca014, #人員編號
       xrca015 LIKE xrca_t.xrca015, #部門編號
       xrca016 LIKE xrca_t.xrca016, #來源作業類型
       xrca017 LIKE xrca_t.xrca017, #產生方式
       xrca018 LIKE xrca_t.xrca018, #來源參考單號
       xrca019 LIKE xrca_t.xrca019, #系統產生對應單號(待抵帳款-預收)
       xrca020 LIKE xrca_t.xrca020, #信用狀申請流程否
       xrca021 LIKE xrca_t.xrca021, #商業發票號碼(IV no.)
       xrca022 LIKE xrca_t.xrca022, #出口報單號碼
       xrca023 LIKE xrca_t.xrca023, #發票客戶編號
       xrca024 LIKE xrca_t.xrca024, #發票客戶統一編號
       xrca025 LIKE xrca_t.xrca025, #發票客戶全名
       xrca026 LIKE xrca_t.xrca026, #發票客戶地址
       xrca028 LIKE xrca_t.xrca028, #發票類型
       xrca029 LIKE xrca_t.xrca029, #發票匯率
       xrca030 LIKE xrca_t.xrca030, #發票應開未稅金額
       xrca031 LIKE xrca_t.xrca031, #發票應開稅額
       xrca032 LIKE xrca_t.xrca032, #發票應開含稅金額
       xrca033 LIKE xrca_t.xrca033, #專案編號
       xrca034 LIKE xrca_t.xrca034, #責任中心
       xrca035 LIKE xrca_t.xrca035, #應收(借方)科目編號
       xrca036 LIKE xrca_t.xrca036, #收入(貸方)科目編號
       xrca037 LIKE xrca_t.xrca037, #分錄傳票產生否
       xrca038 LIKE xrca_t.xrca038, #拋轉傳票號碼
       xrca039 LIKE xrca_t.xrca039, #會計檢核附件份數
       xrca040 LIKE xrca_t.xrca040, #留置否
       xrca041 LIKE xrca_t.xrca041, #留置理由碼
       xrca042 LIKE xrca_t.xrca042, #留置設定日期
       xrca043 LIKE xrca_t.xrca043, #留置解除日期
       xrca044 LIKE xrca_t.xrca044, #留置原幣金額
       xrca045 LIKE xrca_t.xrca045, #留置說明
       xrca046 LIKE xrca_t.xrca046, #關係人否
       xrca047 LIKE xrca_t.xrca047, #多角序號
       xrca048 LIKE xrca_t.xrca048, #集團代收/代付單號
       xrca049 LIKE xrca_t.xrca049, #來源營運中心編號
       xrca050 LIKE xrca_t.xrca050, #交易原始單據份數
       xrca051 LIKE xrca_t.xrca051, #作廢理由碼
       xrca052 LIKE xrca_t.xrca052, #列印次數
       xrca053 LIKE xrca_t.xrca053, #備註
       xrca054 LIKE xrca_t.xrca054, #多帳期設定
       xrca055 LIKE xrca_t.xrca055, #繳款優惠條件
       xrca056 LIKE xrca_t.xrca056, #會計檢核附件狀態
       xrca057 LIKE xrca_t.xrca057, #交易對象識別碼
       xrca058 LIKE xrca_t.xrca058, #銷售分類
       xrca059 LIKE xrca_t.xrca059, #預算編號
       xrca060 LIKE xrca_t.xrca060, #發票開立原則
       xrca061 LIKE xrca_t.xrca061, #預計開立發票日期
       xrca062 LIKE xrca_t.xrca062, #多角性質
       xrca063 LIKE xrca_t.xrca063, #整帳批序號
       xrca064 LIKE xrca_t.xrca064, #訂金序次
       xrca065 LIKE xrca_t.xrca065, #發票編號
       xrca066 LIKE xrca_t.xrca066, #發票號碼
       xrca100 LIKE xrca_t.xrca100, #交易原幣別
       xrca101 LIKE xrca_t.xrca101, #原幣匯率
       xrca103 LIKE xrca_t.xrca103, #原幣未稅金額
       xrca104 LIKE xrca_t.xrca104, #原幣稅額
       xrca106 LIKE xrca_t.xrca106, #原幣直接折抵合計金額
       xrca107 LIKE xrca_t.xrca107, #原幣直接沖帳(調整)合計金額
       xrca108 LIKE xrca_t.xrca108, #原幣應收金額
       xrca113 LIKE xrca_t.xrca113, #本幣未稅金額
       xrca114 LIKE xrca_t.xrca114, #本幣稅額
       xrca116 LIKE xrca_t.xrca116, #本幣直接沖帳(調整)合計金額
       xrca117 LIKE xrca_t.xrca117, #本幣直接沖帳(調整)合計金額
       xrca118 LIKE xrca_t.xrca118, #本幣應收金額
       xrca120 LIKE xrca_t.xrca120, #本位幣二幣別
       xrca121 LIKE xrca_t.xrca121, #本位幣二匯率
       xrca123 LIKE xrca_t.xrca123, #本位幣二未稅金額
       xrca124 LIKE xrca_t.xrca124, #本位幣二稅額
       xrca126 LIKE xrca_t.xrca126, #本位幣二直接折抵合計金額
       xrca127 LIKE xrca_t.xrca127, #本位幣二直接沖帳(調整)合計金額
       xrca128 LIKE xrca_t.xrca128, #本位幣二應收金額
       xrca130 LIKE xrca_t.xrca130, #本位幣三幣別
       xrca131 LIKE xrca_t.xrca131, #本位幣三匯率
       xrca133 LIKE xrca_t.xrca133, #本位幣三未稅金額
       xrca134 LIKE xrca_t.xrca134, #本位幣三稅額
       xrca136 LIKE xrca_t.xrca136, #本位幣三直接折抵合計金額
       xrca137 LIKE xrca_t.xrca137, #本位幣三直接沖帳(調整)合計金額
       xrca138 LIKE xrca_t.xrca138, #本位幣三應收金額
       xrcaud001 LIKE xrca_t.xrcaud001, #自定義欄位(文字)001
       xrcaud002 LIKE xrca_t.xrcaud002, #自定義欄位(文字)002
       xrcaud003 LIKE xrca_t.xrcaud003, #自定義欄位(文字)003
       xrcaud004 LIKE xrca_t.xrcaud004, #自定義欄位(文字)004
       xrcaud005 LIKE xrca_t.xrcaud005, #自定義欄位(文字)005
       xrcaud006 LIKE xrca_t.xrcaud006, #自定義欄位(文字)006
       xrcaud007 LIKE xrca_t.xrcaud007, #自定義欄位(文字)007
       xrcaud008 LIKE xrca_t.xrcaud008, #自定義欄位(文字)008
       xrcaud009 LIKE xrca_t.xrcaud009, #自定義欄位(文字)009
       xrcaud010 LIKE xrca_t.xrcaud010, #自定義欄位(文字)010
       xrcaud011 LIKE xrca_t.xrcaud011, #自定義欄位(數字)011
       xrcaud012 LIKE xrca_t.xrcaud012, #自定義欄位(數字)012
       xrcaud013 LIKE xrca_t.xrcaud013, #自定義欄位(數字)013
       xrcaud014 LIKE xrca_t.xrcaud014, #自定義欄位(數字)014
       xrcaud015 LIKE xrca_t.xrcaud015, #自定義欄位(數字)015
       xrcaud016 LIKE xrca_t.xrcaud016, #自定義欄位(數字)016
       xrcaud017 LIKE xrca_t.xrcaud017, #自定義欄位(數字)017
       xrcaud018 LIKE xrca_t.xrcaud018, #自定義欄位(數字)018
       xrcaud019 LIKE xrca_t.xrcaud019, #自定義欄位(數字)019
       xrcaud020 LIKE xrca_t.xrcaud020, #自定義欄位(數字)020
       xrcaud021 LIKE xrca_t.xrcaud021, #自定義欄位(日期時間)021
       xrcaud022 LIKE xrca_t.xrcaud022, #自定義欄位(日期時間)022
       xrcaud023 LIKE xrca_t.xrcaud023, #自定義欄位(日期時間)023
       xrcaud024 LIKE xrca_t.xrcaud024, #自定義欄位(日期時間)024
       xrcaud025 LIKE xrca_t.xrcaud025, #自定義欄位(日期時間)025
       xrcaud026 LIKE xrca_t.xrcaud026, #自定義欄位(日期時間)026
       xrcaud027 LIKE xrca_t.xrcaud027, #自定義欄位(日期時間)027
       xrcaud028 LIKE xrca_t.xrcaud028, #自定義欄位(日期時間)028
       xrcaud029 LIKE xrca_t.xrcaud029, #自定義欄位(日期時間)029
       xrcaud030 LIKE xrca_t.xrcaud030  #自定義欄位(日期時間)030
       END RECORD

#161128-00061#7---add---end-----------
DEFINE l_success       LIKE type_t.num5
DEFINE l_ac            LIKE type_t.num5
DEFINE l_docno         LIKE glaq_t.glaqdocno
DEFINE l_glaq002       LIKE glaq_t.glaq002
DEFINE l_field         LIKE type_t.chr1000
DEFINE l_field1        LIKE type_t.chr1000
DEFINE l_field2        LIKE type_t.chr1000
DEFINE l_field3        LIKE type_t.chr1000
DEFINE l_field4        LIKE type_t.chr1000
DEFINE l_field5        LIKE type_t.chr1000
DEFINE l_group_field   LIKE type_t.chr1000
DEFINE l_glad_r        RECORD
                       glad005   LIKE glad_t.glad005,  #数量/金额管理否
                       glad007   LIKE glad_t.glad007,  #部门管理否
                       glad008   LIKE glad_t.glad008,  #利润成本管理否
                       glad009   LIKE glad_t.glad009,  #区域管理否
                       glad010   LIKE glad_t.glad010,  #客商管理否
                       glad011   LIKE glad_t.glad011,  #客群管理否
                       glad012   LIKE glad_t.glad012,  #产品类别管理否
                       glad013   LIKE glad_t.glad013,  #人员管理否
                       glad014   LIKE glad_t.glad014,  #预算管理否
                       glad015   LIKE glad_t.glad015,  #专案管理否
                       glad016   LIKE glad_t.glad016,  #WBS管理否
                       glad017   LIKE glad_t.glad017,  #自由核算项1管理否
                       glad018   LIKE glad_t.glad018,  #自由核算项2管理否
                       glad019   LIKE glad_t.glad019,  #自由核算项3管理否
                       glad020   LIKE glad_t.glad020,  #自由核算项4管理否
                       glad021   LIKE glad_t.glad021,  #自由核算项5管理否
                       glad022   LIKE glad_t.glad022,  #自由核算项6管理否
                       glad023   LIKE glad_t.glad023,  #自由核算项7管理否
                       glad024   LIKE glad_t.glad024,  #自由核算项8管理否
                       glad025   LIKE glad_t.glad025,  #自由核算项9管理否
                       glad026   LIKE glad_t.glad026,  #自由核算项10管理否
                       glad031   LIKE glad_t.glad031,  #經營方式管理否
                       glad032   LIKE glad_t.glad032,  #渠道管理否
                       glad033   LIKE glad_t.glad033   #品牌管理否
                       END RECORD
DEFINE l_glgb055       LIKE glgb_t.glgb055
DEFINE l_glad002       LIKE glad_t.glad002           #170509-00094#7 add
DEFINE l_glac008       LIKE glac_t.glac008           #170509-00094#7 add 
DEFINE l_sw            LIKE type_t.chr1              #170509-00094#11 add

   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE
   
   #1.定义CURSOR
   CALL s_voucher_gen_fm_1_def_cursor(p_ld,'',p_sum_type,'','') RETURNING l_success  
   IF NOT l_success THEN
      RETURN r_success
   END IF
   
   LET l_ac = 1
   FOREACH s_voucher_gen_fm_1_cs2 INTO l_docno,l_glaq002
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach s_anmt820_gen_nm_cs5'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      
      INITIALIZE l_glad_r TO NULL
      
      EXECUTE s_voucher_gen_fm_1_cs3 USING l_glaq002 INTO l_glad_r.*
      
      LET l_group_field = NULL
      
      LET l_group_field = ",glaq017"  #核算组织
      
      IF l_glad_r.glad007 = 'Y' THEN  #部门管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq018"
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq018"
         END IF
      END IF
      IF l_glad_r.glad008 = 'Y' THEN  #利润成本管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq019"
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq019"
         END IF
      END IF
      IF l_glad_r.glad009 = 'Y' THEN  #区域管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq020"
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq020 "
         END IF
      END IF
      #IF l_glad_r.glad010 = 'Y' THEN  #客商管理
      #   IF cl_null(l_group_field) THEN
      #      LET l_group_field = "glaq021,glaq022"
      #   ELSE
      #      LET l_group_field = l_group_field CLIPPED,",glaq021,glaq022"
      #   END IF
      #END IF
      IF l_glad_r.glad011 = 'Y' THEN  #客群管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq023 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq023 "
         END IF
      END IF
      IF l_glad_r.glad012 = 'Y' THEN  #产品类别管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq024 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq024 "
         END IF
      END IF
      IF l_glad_r.glad013 = 'Y' THEN  #人员管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq025 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq025"
         END IF
      END IF
      #151112-00009#3 mark ------
      #IF l_glad_r.glad014 = 'Y' THEN  #预算管理
      #   IF cl_null(l_group_field) THEN
      #      LET l_group_field = ",glaq026 "
      #   ELSE
      #      LET l_group_field = l_group_field CLIPPED,",glaq026 "
      #   END IF
      #END IF
      #151112-00009#3 mark end---
      IF l_glad_r.glad015 = 'Y' THEN  #专案管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq027 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq027 "
         END IF
      END IF
      IF l_glad_r.glad016 = 'Y' THEN  #WBS管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq028 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq028 "
         END IF
      END IF
      IF l_glad_r.glad031 = 'Y' THEN  #經營方式管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq051 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq051 "
         END IF
      END IF
      IF l_glad_r.glad032 = 'Y' THEN  #經營方式管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq052 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq052 "
         END IF
      END IF
      IF l_glad_r.glad033 = 'Y' THEN  #經營方式管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq053 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq053 "
         END IF
      END IF
      IF l_glad_r.glad017 = 'Y' THEN  #自由核算项1
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq029 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq029 "
         END IF
      END IF
      IF l_glad_r.glad018 = 'Y' THEN  #自由核算项2
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq030 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq030 "
         END IF
      END IF
      IF l_glad_r.glad019 = 'Y' THEN  #自由核算项3
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq031 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq031 "
         END IF
      END IF
      IF l_glad_r.glad020 = 'Y' THEN  #自由核算项4
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq032 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq032 "
         END IF
      END IF
      IF l_glad_r.glad021 = 'Y' THEN  #自由核算项5
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq033 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq033 "
         END IF
      END IF
      IF l_glad_r.glad022 = 'Y' THEN  #自由核算项6
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq034 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq034 "
         END IF
      END IF
      IF l_glad_r.glad023 = 'Y' THEN  #自由核算项7
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq035 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq035 "
         END IF
      END IF
      IF l_glad_r.glad024 = 'Y' THEN  #自由核算项8
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq036 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq036 "
         END IF
      END IF
      IF l_glad_r.glad025 = 'Y' THEN  #自由核算项9
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq037 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq037 "
         END IF
      END IF
      IF l_glad_r.glad026 = 'Y' THEN  #自由核算项10
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq038 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq038 "
         END IF
      END IF
      IF l_glad_r.glad005 = 'Y' THEN  #数量/金额管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq007"
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq007"
         END IF
      END IF
      
      LET l_field = NULL
      LET l_field1 = NULL
      LET l_field2 = NULL
      LET l_field3 = NULL
      LET l_field4 = NULL
      LET l_field5 = NULL
      
      LET l_field = "glaq017"    #核算组织
      
      IF l_glad_r.glad007 = 'Y' THEN  #部门管理
         IF cl_null(l_field) THEN
            LET l_field = "glaq018"
         ELSE
            LET l_field = l_field CLIPPED,",glaq018"
         END IF
      ELSE
         IF cl_null(l_field) THEN
            LET l_field = "''"
         ELSE
            LET l_field = l_field CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad008 = 'Y' THEN  #利润成本管理
         IF cl_null(l_field) THEN
            LET l_field = "glaq019"
         ELSE
            LET l_field = l_field CLIPPED,",glaq019"
         END IF
      ELSE
         IF cl_null(l_field) THEN
            LET l_field = "''"
         ELSE
            LET l_field = l_field CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad009 = 'Y' THEN  #区域管理
         IF cl_null(l_field) THEN
            LET l_field = "glaq020"
         ELSE
            LET l_field = l_field CLIPPED,",glaq020 "
         END IF
      ELSE
         IF cl_null(l_field) THEN
            LET l_field = "''"
         ELSE
            LET l_field = l_field CLIPPED,",''"
         END IF
      END IF
      #IF l_glad_r.glad010 = 'Y' THEN  #客商管理
      #   IF cl_null(l_field) THEN
      #      LET l_field = "glaq021,glaq022"
      #   ELSE
      #      LET l_field = l_field CLIPPED,",glaq021,glaq022"
      #   END IF
      #ELSE
      #   IF cl_null(l_field) THEN
      #      LET l_field = "''"
      #   ELSE
      #      LET l_field = l_field CLIPPED,",''"
      #   END IF
      #END IF
      IF l_glad_r.glad011 = 'Y' THEN  #客群管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq023 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq023 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad012 = 'Y' THEN  #产品类别管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq024 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq024 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad013 = 'Y' THEN  #人员管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq025 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq025"
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      #151112-00009#3 mark---
      #IF l_glad_r.glad014 = 'Y' THEN  #预算管理
      #   IF cl_null(l_field3) THEN
      #      LET l_field3 = "glaq026 "
      #   ELSE
      #      LET l_field3 = l_field3 CLIPPED,",glaq026 "
      #   END IF
      #ELSE
      #   IF cl_null(l_field3) THEN
      #      LET l_field3 = "''"
      #   ELSE
      #      LET l_field3 = l_field3 CLIPPED,",''"
      #   END IF
      #END IF
      #151112-00009#3 mark end---
      IF l_glad_r.glad015 = 'Y' THEN  #专案管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq027 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq027 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad016 = 'Y' THEN  #WBS管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq028 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq028 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad031 = 'Y' THEN  #經營方式管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq051 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq051 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad032 = 'Y' THEN  #渠道管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq052 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq052 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad033 = 'Y' THEN  #品牌管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq053 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq053 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad017 = 'Y' THEN  #自由核算项1
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq029 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq029 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad018 = 'Y' THEN  #自由核算项2
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq030 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq030 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad019 = 'Y' THEN  #自由核算项3
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq031 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq031 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad020 = 'Y' THEN  #自由核算项4
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq032 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq032 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad021 = 'Y' THEN  #自由核算项5
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq033 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq033 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad022 = 'Y' THEN  #自由核算项6
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq034 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq034 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad023 = 'Y' THEN  #自由核算项7
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq035 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq035 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad024 = 'Y' THEN  #自由核算项8
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq036 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq036 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad025 = 'Y' THEN  #自由核算项9
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq037 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq037 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad026 = 'Y' THEN  #自由核算项10
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq038 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq038 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad005 = 'Y' THEN  #数量/金额管理
         IF cl_null(l_field1) THEN
            LET l_field1 = "glaq007"
         ELSE
            LET l_field1 = l_field1 CLIPPED,",glaq007"
         END IF
         IF cl_null(l_field2) THEN
            LET l_field2 = "SUM(qty)"
         ELSE
            LET l_field2 = l_field2 CLIPPED,",SUM(qty)"
         END IF
      ELSE
         IF cl_null(l_field1) THEN
            LET l_field1 = "''"
         ELSE
            LET l_field1 = l_field1 CLIPPED,",''"
         END IF
         IF cl_null(l_field2) THEN
            LET l_field2 = "''"
         ELSE
            LET l_field2 = l_field2 CLIPPED,",''"
         END IF
      END IF
      IF NOT cl_null(l_glaq002) THEN
         LET l_field4 = " glaq002 = '",l_glaq002,"'"
      ELSE
         LET l_field4 = " glaq002 IS NULL"
      END IF
      IF p_sum_type = '1' THEN
        #LET g_sql = "SELECT docno,docdt,'',glaqent,glaqcomp,'',glaq001,glaq002,glaq005,",      #170509-00094#7 mark
        #LET g_sql = "SELECT docno,docdt,'',glaqent,glaqcomp,glaqld,glaq001,glaq002,glaq005,",  #170509-00094#7 add   #170509-00094#11 mark
         LET g_sql = "SELECT docno,docdt,sw,glaqent,glaqcomp,glaqld,glaq001,glaq002,glaq005,",  #170509-00094#11 add
                     "       glaq006,",l_field1 CLIPPED,",",
                     "       '','','','','','','',",l_field CLIPPED,",",
                     "       '','',",l_field3 CLIPPED,",", 
                     "       SUM(d),SUM(c),",l_field2 CLIPPED,",",
                    #"       SUM(glaq010),glaq039,SUM(glaq040),SUM(glaq041),",                   #170509-00094#11 mark
                     "       SUM(sum),glaq039,SUM(glaq040),SUM(glaq041),",                       #170509-00094#11 add
                    #"       glaq042,SUM(glaq043),SUM(glaq044),'','','','',glgb055",             #170509-00094#7 mark
                     "       glaq042,SUM(glaq043),SUM(glaq044),seq,'','','',glgb055",            #170509-00094#7 add
                     "  FROM s_vr_tmp08 ",  #160727-00019#38   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_fm_tmp ——> s_vr_tmp08
                     " WHERE docno = '",l_docno,"'",
                     "   AND ",l_field4,
                    #" GROUP BY docno,docdt,glaqent,glaqcomp,glaq001,glaq002,glaq005,glaq006,glaq039,glaq042",l_group_field,",glgb055"   #170509-00094#7 mark
                    #" GROUP BY docno,docdt,glaqent,glaqcomp,glaqld,glaq001,glaq002,glaq005,glaq006,glaq039,",    #170509-00094#7 add  #170509-00094#11 mark
                     " GROUP BY sw,docno,docdt,glaqent,glaqcomp,glaqld,glaq001,glaq002,glaq005,glaq006,glaq039,", #170509-00094#11 add  
                     "          glaq042",l_group_field,",seq,glgb055"                                            #170509-00094#7 add
                     
      END IF
      PREPARE s_voucher_gen_fm_p1 FROM g_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_p1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_fm_cs1 CURSOR FOR s_voucher_gen_fm_p1
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_fm_cs1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      
      FOREACH s_voucher_gen_fm_cs1 INTO g_glaq3_d[l_ac].*
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = 'foreach s_voucher_gen_fm_cs1'
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN r_success
         END IF       
        #INSERT INTO s_voucher_fm_group VALUES(g_glaq3_d[l_ac].*)     #170509-00094#7 mark
         
         #170509-00094#7---add---start---
         EXECUTE s_voucher_gen_fm_glad USING g_glaq3_d[l_ac].glaq002 
            INTO l_glad002,l_glac008
         IF cl_null(l_glad002) THEN LET l_glad002 = 'N' END IF 
         #若單據別允許紅字傳票且按餘額類型產生時，需判斷該科目的正常餘額
         #正常餘額為借餘時就用借-貸的金額顯示
         #正常餘額為貸餘時就用貸-借的金額顯示      
         IF g_dfin1002 = 'Y' AND l_glad002 = 'Y' THEN
            IF l_glac008 = '1' THEN
               LET g_glaq3_d[l_ac].d = g_glaq3_d[l_ac].d - g_glaq3_d[l_ac].c
               LET g_glaq3_d[l_ac].c = 0
               LET g_glaq3_d[l_ac].glaq040 = g_glaq3_d[l_ac].glaq040 - g_glaq3_d[l_ac].glaq041
               LET g_glaq3_d[l_ac].glaq041 = 0
               LET g_glaq3_d[l_ac].glaq043 = g_glaq3_d[l_ac].glaq043 - g_glaq3_d[l_ac].glaq044
               LET g_glaq3_d[l_ac].glaq044 = 0
               IF g_glaq3_d[l_ac].d < 0 THEN
                  LET g_glaq3_d[l_ac].sum = g_glaq3_d[l_ac].sum * -1
               END IF
               LET l_sw = '1'         #170509-00094#11 add
            ELSE
               LET g_glaq3_d[l_ac].c = g_glaq3_d[l_ac].c - g_glaq3_d[l_ac].d
               LET g_glaq3_d[l_ac].d = 0
               LET g_glaq3_d[l_ac].glaq041 = g_glaq3_d[l_ac].glaq041 - g_glaq3_d[l_ac].glaq040
               LET g_glaq3_d[l_ac].glaq040 = 0
               LET g_glaq3_d[l_ac].glaq044 = g_glaq3_d[l_ac].glaq044 - g_glaq3_d[l_ac].glaq043
               LET g_glaq3_d[l_ac].glaq043 = 0
               IF g_glaq3_d[l_ac].c < 0 THEN
                  LET g_glaq3_d[l_ac].sum = g_glaq3_d[l_ac].sum * -1
               END IF
               LET l_sw = '2'         #170509-00094#11 add
            END IF
         ELSE
            IF (g_glaq3_d[l_ac].d - g_glaq3_d[l_ac].c) > 0 THEN
               LET g_glaq3_d[l_ac].d = g_glaq3_d[l_ac].d - g_glaq3_d[l_ac].c
               LET g_glaq3_d[l_ac].c = 0
               LET l_sw = '1'         #170509-00094#11 add
            ELSE
               LET g_glaq3_d[l_ac].c = g_glaq3_d[l_ac].c - g_glaq3_d[l_ac].d
               LET g_glaq3_d[l_ac].d = 0
               LET l_sw = '2'         #170509-00094#11 add
            END IF
         END IF      
         
         UPDATE s_vr_tmp08
            SET d = g_glaq3_d[l_ac].d,
                c = g_glaq3_d[l_ac].c,
                glaq010 = g_glaq3_d[l_ac].sum,
                glaq040 = g_glaq3_d[l_ac].glaq040,
                glaq041 = g_glaq3_d[l_ac].glaq041,
                glaq043 = g_glaq3_d[l_ac].glaq043,
                sw = l_sw,                  #170509-00094#11 add
                glaq044 = g_glaq3_d[l_ac].glaq044
          WHERE glaqld = g_glaq3_d[l_ac].glaqld
            AND glaq002 = g_glaq3_d[l_ac].glaq002
            AND seq = g_glaq3_d[l_ac].seq
            AND sw = g_glaq3_d[l_ac].sw     #170509-00094#11 add
         #170509-00094#7---add---end---  
         
         LET l_ac = l_ac + 1
      END FOREACH
      CALL g_glaq3_d.deleteElement(l_ac)
   
   END FOREACH
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 重評價依幣別彙總(AFM)
# Memo...........: #150825-00004#9
# Usage..........: CALL s_voucher_gen_fm_2_ins_group_tmp()
# Date & Author..: 2015/08/27 By Reanna
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_fm_2_ins_group_tmp(p_ld)
DEFINE p_ld             LIKE fmna_t.fmna001     #帳套
#DEFINE l_tmp            RECORD
#                          docno    LIKE glaq_t.glaqdocno,
#                          docdt    LIKE glap_t.glapdocdt,
#                          sw       LIKE type_t.chr1,
#                          glaqent  LIKE glaq_t.glaqent,
#                          glaqcomp LIKE glaq_t.glaqcomp,
#                          glaqld   LIKE glaq_t.glaqld,
#                          glaq001  LIKE glaq_t.glaq001,
#                          glaq002  LIKE glaq_t.glaq002,
#                          glaq005  LIKE glaq_t.glaq005,  #幣別
#                          glaq006  LIKE glaq_t.glaq006,  #匯率
#                          glaq007  LIKE glaq_t.glaq007,
#                          glaq009  LIKE glaq_t.glaq009,
#                          glaq011  LIKE glaq_t.glaq011,
#                          glaq012  LIKE glaq_t.glaq012,
#                          glaq013  LIKE glaq_t.glaq013,
#                          glaq014  LIKE glaq_t.glaq014,
#                          glaq015  LIKE glaq_t.glaq015,
#                          glaq016  LIKE glaq_t.glaq016,
#                          glaq017  LIKE glaq_t.glaq017,
#                          glaq018  LIKE glaq_t.glaq018,
#                          glaq019  LIKE glaq_t.glaq019,
#                          glaq020  LIKE glaq_t.glaq020,
#                          glaq021  LIKE glaq_t.glaq021,
#                          glaq022  LIKE glaq_t.glaq022,
#                          glaq023  LIKE glaq_t.glaq023,
#                          glaq024  LIKE glaq_t.glaq024,
#                          glaq025  LIKE glaq_t.glaq025,
#                         #glaq026  LIKE glaq_t.glaq026,  #151112-00009#3 mark
#                          glaq027  LIKE glaq_t.glaq027,
#                          glaq028  LIKE glaq_t.glaq028,
#                          glaq051  LIKE glaq_t.glaq051,  #經營方式
#                          glaq052  LIKE glaq_t.glaq052,  #渠道
#                          glaq053  LIKE glaq_t.glaq053,  #品牌
#                          glaq029  LIKE glaq_t.glaq029,
#                          glaq030  LIKE glaq_t.glaq030,
#                          glaq031  LIKE glaq_t.glaq031,
#                          glaq032  LIKE glaq_t.glaq032,
#                          glaq033  LIKE glaq_t.glaq033,
#                          glaq034  LIKE glaq_t.glaq034,
#                          glaq035  LIKE glaq_t.glaq035,
#                          glaq036  LIKE glaq_t.glaq036,
#                          glaq037  LIKE glaq_t.glaq037,
#                          glaq038  LIKE glaq_t.glaq038,
#                          d        LIKE glaq_t.glaq003,
#                          c        LIKE glaq_t.glaq004,
#                          qty      LIKE glaq_t.glaq008,
#                          sum      LIKE glaq_t.glaq010,
#                          glaq039  LIKE glaq_t.glaq039,
#                          glaq040  LIKE glaq_t.glaq040,
#                          glaq041  LIKE glaq_t.glaq041,
#                          glaq042  LIKE glaq_t.glaq042,
#                          glaq043  LIKE glaq_t.glaq043,
#                          glaq044  LIKE glaq_t.glaq044,
#                          seq      LIKE glaq_t.glaqseq, #項次一
#                          source   LIKE type_t.chr100,
#                          glaqseq  LIKE glaq_t.glaqseq,
#                          xrca039  LIKE xrca_t.xrca039, #會計檢核附件份數
#                          glgb055  LIKE glgb_t.glgb055  #現金變動碼
#                       END RECORD
#DEFINE l_glaq002       LIKE glaq_t.glaq002
#DEFINE l_glaq005       LIKE glaq_t.glaq005
#DEFINE l_sw            LIKE type_t.chr1   #1.借  2.貸
#DEFINE r_success       LIKE type_t.num5
#
#   WHENEVER ERROR CONTINUE
#
#   LET r_success = FALSE
#   INITIALIZE l_tmp.* TO NULL
#   
#   #先撈出科目+幣別
#   FOREACH s_voucher_gen_fm_1_cs8 INTO l_glaq002,l_glaq005,l_sw
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 'foreach s_voucher_gen_fm_1_cs8'
#         LET g_errparam.popup = FALSE
#         CALL cl_err()
#         RETURN r_success
#      END IF
#      
#      IF cl_null(l_glaq002) OR cl_null(l_glaq005) THEN CONTINUE FOREACH END IF
#      
#      #在依科目+幣別撈取第一筆
#      OPEN s_voucher_gen_fm_1_cs9 USING l_glaq002,l_glaq005,l_sw
#      FETCH FIRST s_voucher_gen_fm_1_cs9 INTO l_tmp.*
#      
#      #合計該科目+幣別的金額
#      EXECUTE s_voucher_gen_fm_1_cs10 USING l_glaq002,l_glaq005,l_sw
#                                       INTO l_tmp.d,l_tmp.c,l_tmp.sum,l_tmp.glaq040,l_tmp.glaq041,
#                                            l_tmp.glaq043,l_tmp.glaq044
#      #項次
#      SELECT MAX(seq)+1 INTO l_tmp.seq FROM s_voucher_fm_group
#      IF cl_null(l_tmp.seq) THEN LET l_tmp.seq = 1 END IF
#      
#      CALL s_ld_sel_glaa(p_ld,'glaa001') RETURNING g_sub_success,l_tmp.glaq005
#      LET l_tmp.glaq006 = 1
#      
#      INSERT INTO s_voucher_fm_group VALUES(l_tmp.*)
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 'insert s_voucher_fm_group'
#         LET g_errparam.popup = FALSE
#         CALL cl_err()
#         RETURN r_success
#      END IF
#   END FOREACH
#   
#   LET r_success = TRUE
#   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 利润/成本中心检查
# Memo...........:
# Usage..........: CALL s_voucher_glaq019_chk(p_glaq019,p_docdt)
# Date & Author..: 2015/1/14 By 02599
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_glaq019_chk(p_glaq019,p_docdt)
   DEFINE p_glaq019      LIKE glaq_t.glaq019     #传入参数1    传入需要检查的利润/成本中心编号
   DEFINE p_docdt        LIKE glap_t.glapdocdt   #传入参数2    传入使用部门资料的日期
   #161128-00061#7---add---begin-----------
   #DEFINE l_ooeg         RECORD LIKE ooeg_t.*    #为以后扩展新的检查做预留，目前检查ooegstus，ooeg006，ooeg007
   DEFINE l_ooeg RECORD  #部門資料檔
       ooegent LIKE ooeg_t.ooegent, #企業編號
       ooegownid LIKE ooeg_t.ooegownid, #資料所有者
       ooegowndp LIKE ooeg_t.ooegowndp, #資料所屬部門
       ooegcrtid LIKE ooeg_t.ooegcrtid, #資料建立者
       ooegcrtdp LIKE ooeg_t.ooegcrtdp, #資料建立部門
       ooegcrtdt LIKE ooeg_t.ooegcrtdt, #資料創建日
       ooegmodid LIKE ooeg_t.ooegmodid, #資料修改者
       ooegmoddt LIKE ooeg_t.ooegmoddt, #最近修改日
       ooegstus LIKE ooeg_t.ooegstus, #狀態碼
       ooeg001 LIKE ooeg_t.ooeg001, #部門編號
       ooeg002 LIKE ooeg_t.ooeg002, #上層部門
       ooeg003 LIKE ooeg_t.ooeg003, #責任中心類型
       ooeg004 LIKE ooeg_t.ooeg004, #所屬責任中心
       ooeg005 LIKE ooeg_t.ooeg005, #會計部門
       ooeg006 LIKE ooeg_t.ooeg006, #生效日期
       ooeg007 LIKE ooeg_t.ooeg007, #失效日期
       ooeg008 LIKE ooeg_t.ooeg008, #費用類別
       ooeg009 LIKE ooeg_t.ooeg009, #歸屬法人
       ooeg010 LIKE ooeg_t.ooeg010, #部門名稱
       ooegud001 LIKE ooeg_t.ooegud001, #自定義欄位(文字)001
       ooegud002 LIKE ooeg_t.ooegud002, #自定義欄位(文字)002
       ooegud003 LIKE ooeg_t.ooegud003, #自定義欄位(文字)003
       ooegud004 LIKE ooeg_t.ooegud004, #自定義欄位(文字)004
       ooegud005 LIKE ooeg_t.ooegud005, #自定義欄位(文字)005
       ooegud006 LIKE ooeg_t.ooegud006, #自定義欄位(文字)006
       ooegud007 LIKE ooeg_t.ooegud007, #自定義欄位(文字)007
       ooegud008 LIKE ooeg_t.ooegud008, #自定義欄位(文字)008
       ooegud009 LIKE ooeg_t.ooegud009, #自定義欄位(文字)009
       ooegud010 LIKE ooeg_t.ooegud010, #自定義欄位(文字)010
       ooegud011 LIKE ooeg_t.ooegud011, #自定義欄位(數字)011
       ooegud012 LIKE ooeg_t.ooegud012, #自定義欄位(數字)012
       ooegud013 LIKE ooeg_t.ooegud013, #自定義欄位(數字)013
       ooegud014 LIKE ooeg_t.ooegud014, #自定義欄位(數字)014
       ooegud015 LIKE ooeg_t.ooegud015, #自定義欄位(數字)015
       ooegud016 LIKE ooeg_t.ooegud016, #自定義欄位(數字)016
       ooegud017 LIKE ooeg_t.ooegud017, #自定義欄位(數字)017
       ooegud018 LIKE ooeg_t.ooegud018, #自定義欄位(數字)018
       ooegud019 LIKE ooeg_t.ooegud019, #自定義欄位(數字)019
       ooegud020 LIKE ooeg_t.ooegud020, #自定義欄位(數字)020
       ooegud021 LIKE ooeg_t.ooegud021, #自定義欄位(日期時間)021
       ooegud022 LIKE ooeg_t.ooegud022, #自定義欄位(日期時間)022
       ooegud023 LIKE ooeg_t.ooegud023, #自定義欄位(日期時間)023
       ooegud024 LIKE ooeg_t.ooegud024, #自定義欄位(日期時間)024
       ooegud025 LIKE ooeg_t.ooegud025, #自定義欄位(日期時間)025
       ooegud026 LIKE ooeg_t.ooegud026, #自定義欄位(日期時間)026
       ooegud027 LIKE ooeg_t.ooegud027, #自定義欄位(日期時間)027
       ooegud028 LIKE ooeg_t.ooegud028, #自定義欄位(日期時間)028
       ooegud029 LIKE ooeg_t.ooegud029, #自定義欄位(日期時間)029
       ooegud030 LIKE ooeg_t.ooegud030, #自定義欄位(日期時間)030
       ooeg011 LIKE ooeg_t.ooeg011, #部門主管員工編號
       ooeg012 LIKE ooeg_t.ooeg012  #部門核決層級
       END RECORD

   #161128-00061#7---add---end-----------

   WHENEVER ERROR CONTINUE
   INITIALIZE l_ooeg.* TO NULL

   LET g_errno =''
   #检查传入变量是否为空
   IF p_glaq019 IS NULL THEN
      LET g_errno = 'sub-00191'
      RETURN 
   END IF
    IF p_docdt IS NULL THEN
      LET g_errno = 'sub-00265'
      RETURN 
   END IF
   #161128-00061#7---add---begin-----------
   #SELECT * INTO l_ooeg.* 
   SELECT ooegent,ooegownid,ooegowndp,ooegcrtid,ooegcrtdp,ooegcrtdt,ooegmodid,ooegmoddt,
          ooegstus,ooeg001,ooeg002,ooeg003,ooeg004,ooeg005,ooeg006,ooeg007,ooeg008,ooeg009,
          ooeg010,ooegud001,ooegud002,ooegud003,ooegud004,ooegud005,ooegud006,ooegud007,
          ooegud008,ooegud009,ooegud010,ooegud011,ooegud012,ooegud013,ooegud014,ooegud015,
          ooegud016,ooegud017,ooegud018,ooegud019,ooegud020,ooegud021,ooegud022,ooegud023,
          ooegud024,ooegud025,ooegud026,ooegud027,ooegud028,ooegud029,ooegud030,ooeg011,ooeg012 INTO l_ooeg.* 
   #161128-00061#7---add---end-----------
   FROM ooeg_t WHERE ooegent = g_enterprise AND ooeg001 = p_glaq019

   CASE WHEN SQLCA.SQLCODE = 100       LET g_errno = 'aoo-00008'
        #WHEN l_ooeg.ooegstus ='N'      LET g_errno = 'aoo-00029'#160321-00016#19 mark
        WHEN l_ooeg.ooegstus ='N'      LET g_errno = 'sub-01302' #160321-00016#19 add
        WHEN p_docdt < l_ooeg.ooeg006  LET g_errno = 'sub-00266'
        WHEN l_ooeg.ooeg007 IS NOT NULL
             IF p_docdt >= l_ooeg.ooeg007 THEN
                LET g_errno = 'sub-00267'
             END IF
        OTHERWISE                     LET g_errno = SQLCA.SQLCODE USING '-------'
   END CASE
   #IF NOT (l_ooeg.ooeg003 = '1' OR l_ooeg.ooeg003 = '2' OR l_ooeg.ooeg003 = '3') THEN #170329-00074#1 mark
   IF NOT (l_ooeg.ooeg003 = '2' OR l_ooeg.ooeg003 = '3' OR l_ooeg.ooeg003 = '4' OR l_ooeg.ooeg003 = '5') THEN #170329-00074#1 add
      #LET g_errno = 'agl-00305' #170329-00074#1 mark
      LET g_errno = 'sub-01436' #170329-00074#1 add
   END IF
END FUNCTION

################################################################################
# Descriptions...: WBS检查
# Memo...........:
# Usage..........: CALL s_voucher_glaq028_chk(p_glaq027,p_glaq028)
# Date & Author..: 2015/1/14 By 02599
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_glaq028_chk(p_glaq027,p_glaq028)
   DEFINE p_glaq027     LIKE glaq_t.glaq027
   DEFINE p_glaq028     LIKE glaq_t.glaq028
   DEFINE l_pjaa006     LIKE pjaa_t.pjaa006
   DEFINE l_pjbb012     LIKE pjbb_t.pjbb012
   DEFINE l_cnt         LIKE type_t.num5

   WHENEVER ERROR CONTINUE
   LET g_errno =''
   
   IF NOT cl_null(p_glaq027) THEN
      SELECT pjaa006 INTO l_pjaa006 FROM pjaa_t WHERE pjaaent=g_enterprise AND pjaa001=p_glaq027
      SELECT pjbb012 INTO l_pjbb012 FROM pjbb_t 
       WHERE pjbbent=g_enterprise AND pjbb001=p_glaq027 AND pjbb002=p_glaq028
      IF l_pjaa006 ='3' THEN
         CASE 
            WHEN SQLCA.SQLCODE = 100       LET g_errno = 'apj-00009'
            WHEN l_pjbb012 <>'1     '      LET g_errno = 'apj-00015'
            OTHERWISE                      LET g_errno = SQLCA.SQLCODE USING '-------'
         END CASE 
      ELSE
         CASE 
            WHEN SQLCA.SQLCODE = 100       LET g_errno = 'apj-00013'
            WHEN l_pjbb012 <>'1     '      LET g_errno = 'apj-00014'
            OTHERWISE                      LET g_errno = SQLCA.SQLCODE USING '-------'
         END CASE 
      END IF
   ELSE
      #SELECT COUNT(*) INTO l_cnt FROM pjbb_t        #170615-00061#25 mark
      SELECT COUNT(pjbb002) INTO l_cnt FROM pjbb_t   #170615-00061#25 add
       WHERE pjbbent=g_enterprise  AND pjbb002=p_glaq028
      IF l_cnt=0 THEN
         LET g_errno = 'apj-00013'
      END IF
      #SELECT COUNT(*) INTO l_cnt FROM pjbb_t       #170615-00061#25 mark
      SELECT COUNT(pjbb002) INTO l_cnt FROM pjbb_t  #170615-00061#25 add
       WHERE pjbbent=g_enterprise  AND pjbb002=p_glaq028 AND pjbb012='1'
      IF l_cnt=0 THEN
         LET g_errno = 'apj-00014'
      END IF
   END IF
END FUNCTION
################################################################################
# Descriptions...: 现金变动码检查
# Memo...........:
# Usage..........: CALL s_voucher_glbc004_chk(p_glaa005,p_glbc004)
# Input parameter: p_glaa005      现金变动码参照表
#                : p_glbc004      现金变动码
# Date & Author..: 2015/01/31 By lujh
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_glbc004_chk(p_glaa005,p_glbc004)
   DEFINE p_glaa005      LIKE glaa_t.glaa005
   DEFINE p_glbc004      LIKE glbc_t.glbc004
   DEFINE l_nmaistus     LIKE nmai_t.nmaistus
   
   LET g_errno = ''
      
   SELECT nmaistus INTO l_nmaistus FROM nmai_t 
    WHERE nmaient = g_enterprise 
      AND nmai001 = p_glaa005
      AND nmai002 = p_glbc004 
      
   CASE
      WHEN SQLCA.SQLCODE = 100    LET g_errno = 'anm-00126'
      #WHEN l_nmaistus = 'N'       LET g_errno = 'abg-00002' #160321-00016#19 mark
      WHEN l_nmaistus = 'N'       LET g_errno = 'sub-01302'  #160321-00016#19 add
   END CASE
END FUNCTION
# 根据设置清空交易客商的值
PUBLIC FUNCTION s_voucher_gen_ar_2_glaq021_upd(p_ld)
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE r_success       LIKE type_t.num5
   DEFINE l_ld            LIKE glaa_t.glaald
   DEFINE l_glaq002       LIKE glaq_t.glaq002
   DEFINE l_docno         LIKE glaq_t.glaqdocno
   DEFINE l_upd_field     LIKE type_t.chr1000
   DEFINE l_sql           LIKE type_t.chr1000
   DEFINE l_glad_r        RECORD 
                          glad005   LIKE glad_t.glad005,  #数量/金额管理否
                          glad007   LIKE glad_t.glad007,  #部门管理否
                          glad008   LIKE glad_t.glad008,  #利润成本管理否
                          glad009   LIKE glad_t.glad009,  #区域管理否
                          glad010   LIKE glad_t.glad010,  #产品类别管理否
                          glad011   LIKE glad_t.glad011,  #客群管理否
                          glad012   LIKE glad_t.glad012,  #产品类别管理否
                          glad013   LIKE glad_t.glad013,  #人员管理否
                          glad015   LIKE glad_t.glad015,  #专案管理否
                          glad016   LIKE glad_t.glad016,  #WBS管理否
                          glad017   LIKE glad_t.glad017,  #自由核算项1管理否
                          glad018   LIKE glad_t.glad018,  #自由核算项2管理否
                          glad019   LIKE glad_t.glad019,  #自由核算项3管理否
                          glad020   LIKE glad_t.glad020,  #自由核算项4管理否
                          glad021   LIKE glad_t.glad021,  #自由核算项5管理否
                          glad022   LIKE glad_t.glad022,  #自由核算项6管理否
                          glad023   LIKE glad_t.glad023,  #自由核算项7管理否
                          glad024   LIKE glad_t.glad024,  #自由核算项8管理否
                          glad025   LIKE glad_t.glad025,  #自由核算项9管理否
                          glad026   LIKE glad_t.glad026,  #自由核算项10管理否  
                          glad027   LIKE glad_t.glad027,  #账款客商管理否   
                          glad031   LIKE glad_t.glad031,  #經營方式管理否
                          glad032   LIKE glad_t.glad032,  #渠道管理否
                          glad033   LIKE glad_t.glad033   #品牌管理否                          
                          END RECORD
   WHENEVER ERROR CONTINUE
   LET r_success = FALSE   
   FOREACH s_voucher_gen_ar_2_cs5 INTO l_glaq002
       IF SQLCA.sqlcode THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code = SQLCA.sqlcode
          LET g_errparam.extend = 'foreach s_voucher_gen_ar_1_cs5'
          LET g_errparam.popup = TRUE
          CALL cl_err()

          RETURN r_success
       END IF  
       
       EXECUTE s_voucher_gen_ar_2_cs6 USING l_glaq002 INTO l_glad_r.*

       LET l_upd_field = NULL
       
       IF l_glad_r.glad010 = 'N' THEN  #交易客商不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq021 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq021 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad027 = 'N' THEN  #账款客商不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq022 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq022 = ' '"
          END IF       
       END IF 

       IF NOT cl_null(l_upd_field) THEN
          LET l_sql = "UPDATE s_vr_tmp04 SET ",l_upd_field,  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar_tmp ——> s_vr_tmp04
                      " WHERE glaqld  = '",p_ld CLIPPED,"'",
                      "   AND glaq002 = '",l_glaq002,"'"
          PREPARE s_voucher_gen_ar_2_upd_tmp_p2 FROM l_sql
          IF SQLCA.sqlcode THEN
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = SQLCA.sqlcode
             LET g_errparam.extend = 's_voucher_gen_ar_2_upd_tmp_p2'
             LET g_errparam.popup = TRUE
             CALL cl_err()

             RETURN r_success
          END IF
          EXECUTE s_voucher_gen_ar_2_upd_tmp_p2
          IF SQLCA.sqlcode THEN
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = SQLCA.sqlcode
             LET g_errparam.extend = 'execute s_voucher_gen_ar_2_upd_tmp_p2'
             LET g_errparam.popup = TRUE
             CALL cl_err()

             RETURN r_success
          END IF
          
          #20151123--add--str--lujh
          LET l_sql = "UPDATE s_vr_tmp05 SET ",l_upd_field,  #160727-00019#36   16/08/15 By 08734      临时表长度超过15码的减少到15码以下 s_voucher_ar_group ——> s_vr_tmp05
                      " WHERE glaq002 = '",l_glaq002,"'"
          PREPARE s_voucher_gen_ar_2_upd_tmp_p3 FROM l_sql
          IF SQLCA.sqlcode THEN
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = SQLCA.sqlcode
             LET g_errparam.extend = 's_voucher_gen_ar_2_upd_tmp_p3'
             LET g_errparam.popup = TRUE
             CALL cl_err()
          
             RETURN r_success
          END IF
          EXECUTE s_voucher_gen_ar_2_upd_tmp_p3
          IF SQLCA.sqlcode THEN
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = SQLCA.sqlcode
             LET g_errparam.extend = 'execute s_voucher_gen_ar_2_upd_tmp_p3'
             LET g_errparam.popup = TRUE
             CALL cl_err()
          
             RETURN r_success
          END IF
          #20151123--add--end--lujh
       END IF

   END FOREACH
   
   LET r_success = TRUE
   RETURN r_success    
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_voucher_make_sql_desc(p_glae001)
#                  RETURNING r_sql
# Input parameter: p_glae001      自由核算項類型
# Return code....: r_sql          组合后SQL语句
# Date & Author..: 2015/02/05 By 02599
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_make_sql_desc(p_glae001)
   DEFINE p_glae001   LIKE glae_t.glae001   #核算项类型
   DEFINE r_sql       STRING
   DEFINE l_glae003   LIKE glae_t.glae003   #来源档案
   DEFINE l_glae004   LIKE glae_t.glae004   #来源编号栏位
   DEFINE l_glae005   LIKE glae_t.glae005   #来源说明档案
   DEFINE l_glae006   LIKE glae_t.glae006   #来源说明栏位  
   DEFINE l_dzeb002   LIKE dzeb_t.dzeb002   #栏位代号
   DEFINE l_dzeb006   LIKE dzeb_t.dzeb002   #栏位属性    
   DEFINE l_sql     STRING
   DEFINE li_sql1   STRING    #抓主档表的key
   DEFINE li_sql2   STRING    #抓对应多语言表的key 
   #抓取主表的key放入数组
   DEFINE li_main    DYNAMIC ARRAY OF RECORD
          dzeb002    LIKE dzeb_t.dzeb002       
   END RECORD 
   #抓取多语言表的key放入数组
   DEFINE li_dlang    DYNAMIC ARRAY OF RECORD
          dzeb002    LIKE dzeb_t.dzeb002       
   END RECORD 
   DEFINE l_where   STRING    #组出的对应的抓取说明的where条件    
   DEFINE l_i,l_i2,l_i3       LIKE type_t.num5
   
   #初始化
   CALL li_main.clear()
   CALL li_dlang.clear()
    
   #抓取来源档案，来源说明档案，来源说明栏位
   SELECT glae003,glae004,glae005,glae006 INTO l_glae003,l_glae004,l_glae005,l_glae006 FROM glae_t
    WHERE glaeent = g_enterprise
      AND glae001 = p_glae001
      
   #抓取主档key
   LET l_i = 1
   LET li_sql1 = " SELECT dzeb002 FROM dzeb_t ",
                 "  WHERE dzeb001 = '",l_glae003,"'",
                 "    AND dzeb004 = 'Y'", 
                 "  ORDER BY dzeb021 " 
   PREPARE s_voucher_pr FROM li_sql1
   DECLARE s_voucher_cs CURSOR FOR s_voucher_pr
   FOREACH s_voucher_cs INTO li_main[l_i].dzeb002
       LET l_i = l_i +1
   END FOREACH
   #真实数组长度
   LET l_i = l_i -1  
   
   #抓取多语言档key
   LET l_i2 = 1
   LET li_sql2 = " SELECT dzeb002 FROM dzeb_t ",
                 " WHERE dzeb001 = '",l_glae005,"'" ,
                  "  AND dzeb004 = 'Y'",
                 " ORDER BY dzeb021 "
   PREPARE s_voucher_pr2 FROM li_sql2
   DECLARE s_voucher_cs2 CURSOR FOR s_voucher_pr2
   FOREACH s_voucher_cs2 INTO li_dlang[l_i2].dzeb002
       LET l_i2 = l_i2 +1
   END FOREACH
   #真实数组长度
   LET l_i2 = l_i2 -1  

   
   #组合where条件 
   LET l_where = '1=1'
   FOR  l_i3 = 1 TO  l_i 
       LET l_where = l_where," AND ", li_main[l_i3].dzeb002, " = " ,li_dlang[l_i3].dzeb002
   END FOR    
   
   #组出的基础sql   
   LET r_sql = " SELECT ", l_glae006 ," FROM ",l_glae005 ,',',l_glae003,
               " WHERE " , l_glae004," = ?",
               "   AND " ,l_where
   #组sql               
   LET l_sql = "SELECT dzeb002,dzeb006 FROM dzeb_t ",
               " WHERE dzeb001 = '",l_glae005,"'",
               "   AND dzeb004 = 'Y'"
   PREPARE s_voucher_make_sql_pre1 FROM l_sql
   DECLARE s_voucher_make_sql_cs1 CURSOR FOR s_voucher_make_sql_pre1
   FOREACH s_voucher_make_sql_cs1 INTO l_dzeb002,l_dzeb006
      #判断是否有ent栏位
      IF l_dzeb006 = 'N802' THEN
         #LET r_sql = r_sql CLIPPED," AND ",l_dzeb002 ," ='",g_enterprise,"' " #170615-00061#25 mark
         LET r_sql = r_sql CLIPPED," AND ",l_dzeb002 ," = ",g_enterprise," "   #170615-00061#25 add
      END IF 
      
      IF l_dzeb006 = 'C800' THEN
         LET r_sql = r_sql CLIPPED," AND ",l_dzeb002 ," ='",g_dlang,"' "
      END IF

   END FOREACH
   RETURN r_sql
END FUNCTION

################################################################################
# Descriptions...: 自由核算項說明
# Memo...........:
# Usage..........: CALL s_voucher_free_account_desc(p_glaf001,p_glaf002)
#                  RETURNING r_desc 
# Input parameter: p_glaf001      自由核算項類型
#                : p_glaf002      自由核算項值
# Return code....: r_desc         自由核算項說明
# Date & Author..: 2015/02/05 By 02599
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_free_account_desc(p_glaf001,p_glaf002)
   DEFINE p_glaf001     LIKE glaf_t.glaf001
   DEFINE p_glaf002     LIKE glaf_t.glaf002
   DEFINE l_glae002     LIKE glae_t.glae002     #资料来源
   DEFINE l_sql         STRING                  #组的抓取资料的sql
   DEFINE r_desc        STRING
   
   #自由核算项
   LET l_glae002 = ''
   LET l_sql = ''
   LET r_desc= ''
   SELECT glae002 INTO l_glae002 FROM glae_t
    WHERE glaeent = g_enterprise
      AND glae001 = p_glaf001
   IF l_glae002 = '2' THEN
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] =p_glaf001
      LET g_ref_fields[2] =p_glaf002
      CALL ap_ref_array2(g_ref_fields,"SELECT glafl004 FROM glafl_t WHERE glaflent='"||g_enterprise||"' AND glafl001=? AND glafl002=? AND glafl003='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET r_desc= g_rtn_fields[1]
   ELSE
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = p_glaf002
      CALL s_voucher_make_sql_desc(p_glaf001) RETURNING l_sql
      CALL ap_ref_array2(g_ref_fields,l_sql,"") RETURNING g_rtn_fields
      LET r_desc= g_rtn_fields[1]
   END IF
   
   RETURN r_desc
END FUNCTION
################################################################################
# Descriptions...: 抓取科目预设现金变动码
# Memo...........: #150814-00006#3 根据借贷方向设置现金变动码预设值
# Usage..........: CALL s_voucher_glad006_get(p_ld,p_glad001,p_amt_d,p_amt_c)
#                  RETURNING r_glbc004
# Input parameter: p_ld           帐套
#                  p_glad001      科目
#                  p_amt_d        借方金额
#                  p_amt_c        贷方金额
# Return code....: r_glbc004      现金变动码
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_glad006_get(p_ld,p_glad001,p_amt_d,p_amt_c)
   DEFINE p_ld          LIKE glaa_t.glaald
   DEFINE p_glad001     LIKE glad_t.glad001
   DEFINE r_glad006     LIKE glad_t.glad006
   #150814-00006#3--add--str--
   DEFINE p_amt_d       LIKE glaq_t.glaq003  #借方金額
   DEFINE p_amt_c       LIKE glaq_t.glaq003  #貸方金額
   DEFINE l_glad006     LIKE glad_t.glad006  #借方現金變動碼
   DEFINE l_glad036     LIKE glad_t.glad036  #貸方現金變動碼
   DEFINE r_glbc004     LIKE glbc_t.glbc004  #返回現金變動碼
   DEFINE l_glac008     LIKE glac_t.glac008  
   #150814-00006#3--add--end
   
   #150814-00006#3--mod--str--
#   LET r_glad006 = ''
   LET r_glbc004 = ''
   LET l_glad006 = ''
   LET l_glad036 = ''
   SELECT glad006,glad036 INTO l_glad006,l_glad036
     FROM glad_t
    WHERE gladent = g_enterprise
      AND gladld = p_ld
      AND glad001 = p_glad001
   IF p_amt_d <> 0 THEN #借方 
      LET r_glbc004=l_glad006 
   END IF
   IF p_amt_c <> 0 THEN #貸方
      LET r_glbc004=l_glad036 
   END IF
   IF p_amt_d = 0 AND p_amt_c=0 THEN
      SELECT glac008 INTO l_glac008 FROM glac_t 
       WHERE glacent=g_enterprise 
         AND glac001=(SELECT glaa004 FROM glaa_t WHERE glaaent=g_enterprise AND glaald=p_ld) 
         AND glac002=p_glad001
         
      IF l_glac008='1' THEN #借方
         LET r_glbc004=l_glad006 
      ELSE #貸方
         LET r_glbc004=l_glad036
      END IF
   END IF
#   RETURN  r_glad006   
   RETURN  r_glbc004
   #150814-00006#3--mod--end
END FUNCTION
# 抓取现金科目否
PUBLIC FUNCTION s_voucher_glac016_get(p_glaa004,p_glaq002)
   DEFINE p_glaa004         LIKE glaa_t.glaa004
   DEFINE p_glaq002         LIKE glaq_t.glaq002
   DEFINE r_glac016         LIKE glac_t.glac016
   
   SELECT glac016 INTO r_glac016 
     FROM glac_t
    WHERE glacent = g_enterprise
      AND glac001 = p_glaa004
      AND glac002 = p_glaq002
   
   RETURN r_glac016
END FUNCTION

################################################################################
# Descriptions...: 抓取agli051中設置科目對應的預設值
# Memo...........:
# Usage..........: CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,p_glas002)
#                  RETURNING r_glas003
# Input parameter: p_glasld       帳套
#                : p_glas001      科目編號
#                : p_glas002      核算項類型
# Return code....: r_glas003      默認值
# Date & Author..: 2015/02/11 By 02599
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_get_fix_default_value(p_glasld,p_glas001,p_glas002)
   DEFINE p_glasld          LIKE glas_t.glasld
   DEFINE p_glas001         LIKE glas_t.glas001
   DEFINE p_glas002         LIKE glas_t.glas002
   DEFINE r_glas003         LIKE glas_t.glas003
   
   LET r_glas003=''
   SELECT glas003 INTO r_glas003 FROM glas_t
   WHERE glasent=g_enterprise AND glasld=p_glasld
   AND glas001=p_glas001 AND glas002=p_glas002
   IF cl_null(r_glas003) THEN LET r_glas003 = ' ' END IF #160704-00011#7 add
   
   RETURN r_glas003
END FUNCTION
# 抓取agli051的设置
PUBLIC FUNCTION s_voucher_get_glas003(p_glasld,p_glas001)
   DEFINE p_glasld         LIKE glas_t.glasld
   DEFINE p_glas001        LIKE glas_t.glas001
   DEFINE l_glas002        LIKE glas_t.glas002
   DEFINE l_sql            STRING
   DEFINE r_glaq020        LIKE glaq_t.glaq020
   DEFINE r_glaq021        LIKE glaq_t.glaq021
   DEFINE r_glaq022        LIKE glaq_t.glaq022
   DEFINE r_glaq023        LIKE glaq_t.glaq023
   DEFINE r_glaq024        LIKE glaq_t.glaq024
   DEFINE r_glaq051        LIKE glaq_t.glaq051
   DEFINE r_glaq052        LIKE glaq_t.glaq052
   DEFINE r_glaq053        LIKE glaq_t.glaq053
   DEFINE r_glaq027        LIKE glaq_t.glaq027
   DEFINE r_glaq028        LIKE glaq_t.glaq028
   DEFINE r_glaq029        LIKE glaq_t.glaq029
   DEFINE r_glaq030        LIKE glaq_t.glaq030
   DEFINE r_glaq031        LIKE glaq_t.glaq031
   DEFINE r_glaq032        LIKE glaq_t.glaq032
   DEFINE r_glaq033        LIKE glaq_t.glaq033
   DEFINE r_glaq034        LIKE glaq_t.glaq034
   DEFINE r_glaq035        LIKE glaq_t.glaq035
   DEFINE r_glaq036        LIKE glaq_t.glaq036
   DEFINE r_glaq037        LIKE glaq_t.glaq037
   DEFINE r_glaq038        LIKE glaq_t.glaq038
   
   LET l_sql = "SELECT glas002 FROM glas_t ",
               #" WHERE glasent = '",g_enterprise,"'", #170615-00061#25 mark
               " WHERE glasent = ",g_enterprise," ",   #170615-00061#25 add
               "   AND glasld = '",p_glasld,"'",
               "   AND glas001 = '",p_glas001,"'"
               
   PREPARE s_voucher_gen_ar_2_p20 FROM l_sql
   DECLARE s_voucher_gen_ar_2_cs20 CURSOR FOR s_voucher_gen_ar_2_p20
 
   FOREACH s_voucher_gen_ar_2_cs20 INTO l_glas002
      CASE 
         WHEN l_glas002 = '4'
            CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,'4')  RETURNING r_glaq020   
         WHEN l_glas002 = '5'            
            CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,'5')  RETURNING r_glaq021
         WHEN l_glas002 = '6'
            CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,'6')  RETURNING r_glaq022
         WHEN l_glas002 = '7'
            CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,'7')  RETURNING r_glaq023
         WHEN l_glas002 = '8'
            CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,'8')  RETURNING r_glaq024
         WHEN l_glas002 = '9'
            CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,'9')  RETURNING r_glaq051
         WHEN l_glas002 = '10'
            CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,'10') RETURNING r_glaq052
         WHEN l_glas002 = '11'
            CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,'11') RETURNING r_glaq053
         WHEN l_glas002 = '13'
            CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,'13') RETURNING r_glaq027
         WHEN l_glas002 = '14'
            CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,'14') RETURNING r_glaq028
         WHEN l_glas002 = '15'
            CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,'15') RETURNING r_glaq029
         WHEN l_glas002 = '16'
            CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,'16') RETURNING r_glaq030
         WHEN l_glas002 = '17'
            CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,'17') RETURNING r_glaq031
         WHEN l_glas002 = '18'
            CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,'18') RETURNING r_glaq032
         WHEN l_glas002 = '19'
            CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,'19') RETURNING r_glaq033
         WHEN l_glas002 = '20'
            CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,'20') RETURNING r_glaq034
         WHEN l_glas002 = '21'
            CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,'21') RETURNING r_glaq035
         WHEN l_glas002 = '22'
            CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,'22') RETURNING r_glaq036
         WHEN l_glas002 = '23'
            CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,'23') RETURNING r_glaq037
         WHEN l_glas002 = '24'
            CALL s_voucher_get_fix_default_value(p_glasld,p_glas001,'24') RETURNING r_glaq038
            
      END CASE
   END FOREACH
   
   RETURN  r_glaq020,r_glaq021,r_glaq022,r_glaq023,r_glaq024,r_glaq051,r_glaq052,r_glaq053,
           r_glaq027,r_glaq028,r_glaq029,r_glaq030,r_glaq031,r_glaq032,r_glaq033,r_glaq034,
           r_glaq035,r_glaq036,r_glaq037,r_glaq038
END FUNCTION

################################################################################
# Descriptions...: 獲取科目下層科目，并組成字符串返回
# Memo...........:
# Usage..........: CALL s_voucher_get_glac_str(p_glac001,p_glac002)
#                  RETURNING r_str
# Input parameter: p_glac001      科目參照表號
#                : p_glac002      科目編號
# Return code....: r_str          下層明細科目或獨立組成的字符串
# Date & Author..: 2015/05/15 By 02599
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_get_glac_str(p_glac001,p_glac002)
   DEFINE p_glac001            LIKE glac_t.glac001
   DEFINE p_glac002            LIKE glac_t.glac002
   DEFINE r_str                STRING
   DEFINE l_glac003            LIKE glac_t.glac003
   DEFINE l_glac_str1          STRING
   DEFINE l_glac_str2          STRING
   DEFINE l_glac002            STRING
   DEFINE l_i                  LIKE type_t.num5
   
   WHENEVER ERROR CONTINUE
   LET r_str=''
   #(1).传入参数为空，返回
   #170816-00007#130 by 09773 mod(S)
#   IF cl_null(p_glac001) OR cl_null(p_glac002) THEN
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.extend = ''
#      LET g_errparam.code   = 'sub-00110'
#      LET g_errparam.popup  = TRUE 
#      CALL cl_err()
#      RETURN r_str
#   END IF
   #170816-00007#130 by 09773 mod(E)
   
   #170816-00007#130 by 09773 add(S)
   #修改錯誤訊息報錯內容
   LET g_msg = ''
   LET g_colname_1 = ''
   LET g_comment_1 = ''
   IF cl_null(p_glac001) THEN
      CALL s_azzi902_get_gzzd("agli021","lbl_glac001") RETURNING g_colname_1,g_comment_1  #會計科目參照表號 
      LET g_msg = g_colname_1   
   END IF
   IF cl_null(p_glac002) THEN
      LET g_colname_1 = ''
      LET g_comment_1 = ''    
      CALL s_azzi902_get_gzzd("agli021","lbl_glac002") RETURNING g_colname_1,g_comment_1   #會計科目編號
      IF g_msg IS NULL THEN   
         LET g_msg = g_colname_1   
      ELSE   
         LET g_msg = g_msg,",",g_colname_1
      END IF        
   END IF
   IF NOT cl_null(g_msg) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = ''
      LET g_errparam.code = 'sub-00788'  #%1傳入值為空(錯誤)
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_msg 
      CALL cl_err()
      RETURN r_str
   END IF 
   #170816-00007#130 by 09773 add(S)
   
   #(2)判斷傳入的科目是否為統治科目，當非統治科目時，返回傳入科目
   SELECT glac003 INTO l_glac003 FROM glac_t 
    WHERE glacent = g_enterprise
      AND glac001 = p_glac001 AND glac002 = p_glac002
   IF l_glac003 <> '1' THEN
      LET r_str = "'",p_glac002,"'"
      RETURN r_str
   END IF
   
   #(3)當傳入的科目為統治科目時，抓取下層科目
   LET l_glac_str1="'",p_glac002,"'"  #統治科目組合
   LET l_glac_str2=''                 #明細科目組合
   
   LET l_i = 0 #避免出現死循環，如果循環次數超過1000次，結束循環
   WHILE TRUE
      #當統治科目組合不為空時繼續抓取下層科目
      IF NOT cl_null(l_glac_str1) THEN
         LET l_glac002 = "(",l_glac_str1,")"
         CALL s_voucher_get_glac_str_1(p_glac001,l_glac002) RETURNING l_glac_str1,l_glac_str2
         #當明細科目組合有值時，將科目加入返回值中
         IF NOT cl_null(l_glac_str2) THEN
            IF cl_null(r_str) THEN
               LET r_str = l_glac_str2
            ELSE
               LET r_str = r_str,",",l_glac_str2
            END IF
         END IF
      ELSE
         EXIT WHILE
      END IF
      LET l_i = l_i +1
      IF l_i >1000 THEN
         EXIT WHILE
      END IF 
   END WHILE
   
   RETURN r_str
END FUNCTION

################################################################################
# Descriptions...: 抓取下層科目，并將統治科目放入r_str1，明細科目放入r_str2 ,返回查詢結果r_str1，r_str2
# Memo...........:
# Usage..........: CALL s_voucher_get_glac_str_1(p_glac002)
#                  RETURNING r_str1,r_str2
# Input parameter: p_glac001      科目參照表號
#                : p_glac002      科目
# Return code....: r_str1         統治科目組合
#                : r_str2         明細科目組合
# Date & Author..: 2015/5/15 By 2599
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_get_glac_str_1(p_glac001,p_glac002)
   DEFINE p_glac001         LIKE glac_t.glac001
   DEFINE p_glac002         STRING
   DEFINE r_str1            STRING
   DEFINE r_str2            STRING
   DEFINE l_glac002         LIKE glac_t.glac002
   DEFINE l_glac003         LIKE glac_t.glac003
   DEFINE l_sql             STRING
   
   LET r_str1 = ''
   LET r_str2 = ''
   LET l_sql="SELECT glac002,glac003 FROM glac_t ",
             " WHERE glacent = ",g_enterprise,
             "   AND glac001 = '",p_glac001,"'",
             "   AND glac002 <> glac004",
             "   AND glac004 IN  ",p_glac002,
             "   AND glacstus = 'Y'"
   PREPARE s_voucher_sel_glac_pr FROM l_sql
   DECLARE s_voucher_sel_glac_cs CURSOR FOR s_voucher_sel_glac_pr
   
   FOREACH s_voucher_sel_glac_cs INTO l_glac002,l_glac003
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'FOREACH s_voucher_sel_glac_cs'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         EXIT FOREACH
      END IF
      IF l_glac003 = '1' THEN
         IF cl_null(r_str1) THEN
            LET r_str1="'",l_glac002,"'"
         ELSE
            LET r_str1=r_str1,",'",l_glac002,"'"
         END IF
      ELSE
         IF cl_null(r_str2) THEN
            LET r_str2="'",l_glac002,"'"
         ELSE
            LET r_str2=r_str2,",'",l_glac002,"'"
         END IF
      END IF
   END FOREACH
   RETURN r_str1,r_str2
END FUNCTION

################################################################################
# Descriptions...: 分摊金额来源资料检核
# Memo...........: #151103-00017#1 add
# Usage..........: CALL s_voucher_glan_chk(p_glanld,p_glandocno,p_docdt)
#                  RETURNING r_success
# Input parameter: p_glanld       账套
#                : p_glandocno    单号
#                : p_docdt        单据日期
# Return code....: r_success      检核结果
# Date & Author..: 2015/11/04 By 02599
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_glan_chk(p_glanld,p_glandocno,p_docdt)
   DEFINE p_glanld           LIKE glan_t.glanld
   DEFINE p_glandocno        LIKE glan_t.glandocno
   DEFINE p_docdt            LIKE glal_t.glaldocdt
   DEFINE r_success          LIKE type_t.num5
   DEFINE l_success          LIKE type_t.num5
   #161128-00061#7---add---begin-----------
   #DEFINE l_glan             RECORD LIKE glan_t.*
   DEFINE l_glan RECORD  #分攤金額來源檔
       glanent LIKE glan_t.glanent, #企業編號
       glanownid LIKE glan_t.glanownid, #資料所有者
       glanowndp LIKE glan_t.glanowndp, #資料所屬部門
       glancrtid LIKE glan_t.glancrtid, #資料建立者
       glancrtdp LIKE glan_t.glancrtdp, #資料建立部門
       glancrtdt LIKE glan_t.glancrtdt, #資料創建日
       glanmodid LIKE glan_t.glanmodid, #資料修改者
       glanmoddt LIKE glan_t.glanmoddt, #最近修改日
       glancnfid LIKE glan_t.glancnfid, #資料確認者
       glancnfdt LIKE glan_t.glancnfdt, #資料確認日
       glanpstid LIKE glan_t.glanpstid, #資料過帳者
       glanpstdt LIKE glan_t.glanpstdt, #資料過帳日
       glanstus LIKE glan_t.glanstus, #狀態碼
       glanld LIKE glan_t.glanld, #帳套(套)編號
       glandocno LIKE glan_t.glandocno, #分攤編號
       glanseq LIKE glan_t.glanseq, #項次
       glan001 LIKE glan_t.glan001, #科目編號
       glan002 LIKE glan_t.glan002, #分攤百分比
       glan003 LIKE glan_t.glan003, #營運據點
       glan004 LIKE glan_t.glan004, #部門
       glan005 LIKE glan_t.glan005, #利潤/成本中心
       glan006 LIKE glan_t.glan006, #區域
       glan007 LIKE glan_t.glan007, #收付款客商
       glan008 LIKE glan_t.glan008, #帳款客商
       glan009 LIKE glan_t.glan009, #客群
       glan010 LIKE glan_t.glan010, #產品類別
       glan011 LIKE glan_t.glan011, #人員
       glan012 LIKE glan_t.glan012, #no use
       glan013 LIKE glan_t.glan013, #專案編號
       glan014 LIKE glan_t.glan014, #WBS
       glan015 LIKE glan_t.glan015, #餘額來源
       glan016 LIKE glan_t.glan016, #餘額性質
       glan017 LIKE glan_t.glan017, #來源性質
       glan018 LIKE glan_t.glan018, #餘額來源年度
       glan019 LIKE glan_t.glan019, #餘額來源期別
       glan051 LIKE glan_t.glan051, #經營方式
       glan052 LIKE glan_t.glan052, #通路
       glan053 LIKE glan_t.glan053, #品牌
       glanud001 LIKE glan_t.glanud001, #自定義欄位(文字)001
       glanud002 LIKE glan_t.glanud002, #自定義欄位(文字)002
       glanud003 LIKE glan_t.glanud003, #自定義欄位(文字)003
       glanud004 LIKE glan_t.glanud004, #自定義欄位(文字)004
       glanud005 LIKE glan_t.glanud005, #自定義欄位(文字)005
       glanud006 LIKE glan_t.glanud006, #自定義欄位(文字)006
       glanud007 LIKE glan_t.glanud007, #自定義欄位(文字)007
       glanud008 LIKE glan_t.glanud008, #自定義欄位(文字)008
       glanud009 LIKE glan_t.glanud009, #自定義欄位(文字)009
       glanud010 LIKE glan_t.glanud010, #自定義欄位(文字)010
       glanud011 LIKE glan_t.glanud011, #自定義欄位(數字)011
       glanud012 LIKE glan_t.glanud012, #自定義欄位(數字)012
       glanud013 LIKE glan_t.glanud013, #自定義欄位(數字)013
       glanud014 LIKE glan_t.glanud014, #自定義欄位(數字)014
       glanud015 LIKE glan_t.glanud015, #自定義欄位(數字)015
       glanud016 LIKE glan_t.glanud016, #自定義欄位(數字)016
       glanud017 LIKE glan_t.glanud017, #自定義欄位(數字)017
       glanud018 LIKE glan_t.glanud018, #自定義欄位(數字)018
       glanud019 LIKE glan_t.glanud019, #自定義欄位(數字)019
       glanud020 LIKE glan_t.glanud020, #自定義欄位(數字)020
       glanud021 LIKE glan_t.glanud021, #自定義欄位(日期時間)021
       glanud022 LIKE glan_t.glanud022, #自定義欄位(日期時間)022
       glanud023 LIKE glan_t.glanud023, #自定義欄位(日期時間)023
       glanud024 LIKE glan_t.glanud024, #自定義欄位(日期時間)024
       glanud025 LIKE glan_t.glanud025, #自定義欄位(日期時間)025
       glanud026 LIKE glan_t.glanud026, #自定義欄位(日期時間)026
       glanud027 LIKE glan_t.glanud027, #自定義欄位(日期時間)027
       glanud028 LIKE glan_t.glanud028, #自定義欄位(日期時間)028
       glanud029 LIKE glan_t.glanud029, #自定義欄位(日期時間)029
       glanud030 LIKE glan_t.glanud030  #自定義欄位(日期時間)030
       END RECORD

   #161128-00061#7---add---end-----------
   DEFINE l_sql              STRING
   DEFINE l_glad007          LIKE glad_t.glad007     #部門管理否
   DEFINE l_glad008          LIKE glad_t.glad008     #利潤成本中心管理
   DEFINE l_glad009          LIKE glad_t.glad009     #區域管理
   DEFINE l_glad010          LIKE glad_t.glad010     #交易客商管理
   DEFINE l_glad027          LIKE glad_t.glad027     #账款客商管理
   DEFINE l_glad011          LIKE glad_t.glad011     #客群管理否
   DEFINE l_glad012          LIKE glad_t.glad012     #產品類別
   DEFINE l_glad013          LIKE glad_t.glad013     #人員
   DEFINE l_glad015          LIKE glad_t.glad015     #专案管理否
   DEFINE l_glad016          LIKE glad_t.glad016     #wbs管理
   DEFINE l_glad031          LIKE glad_t.glad031     #經營方式管理否
   DEFINE l_glad032          LIKE glad_t.glad032     #渠道管理否
   DEFINE l_glad033          LIKE glad_t.glad033     #品牌管理否
   DEFINE l_msg              STRING     #组合报错信息
   DEFINE l_msg1             STRING     #组合报错信息
   DEFINE l_errno            LIKE type_t.chr10
   DEFINE l_errmsg           STRING     #组合报错信息
   
   LET r_success = TRUE
   
   #161128-00061#7---add---begin-----------
   #LET l_sql="SELECT * FROM glan_t ",
   LET l_sql="SELECT glanent,glanownid,glanowndp,glancrtid,glancrtdp,glancrtdt,glanmodid,glanmoddt,",
             "glancnfid,glancnfdt,glanpstid,glanpstdt,glanstus,glanld,glandocno,glanseq,glan001,",
             "glan002,glan003,glan004,glan005,glan006,glan007,glan008,glan009,glan010,glan011,glan012,",
             "glan013,glan014,glan015,glan016,glan017,glan018,glan019,glan051,glan052,glan053,glanud001,",
             "glanud002,glanud003,glanud004,glanud005,glanud006,glanud007,glanud008,glanud009,glanud010,",
             "glanud011,glanud012,glanud013,glanud014,glanud015,glanud016,glanud017,glanud018,glanud019,",
             "glanud020,glanud021,glanud022,glanud023,glanud024,glanud025,glanud026,glanud027,glanud028,",
             "glanud029,glanud030 FROM glan_t ",
   #161128-00061#7---add---end-----------
             " WHERE glanent=",g_enterprise," AND glanld='",p_glanld,"' AND glandocno='",p_glandocno,"'"
   PREPARE s_voucher_glan_pr FROM l_sql
   DECLARE s_voucher_glan_cs CURSOR FOR s_voucher_glan_pr
   
   FOREACH s_voucher_glan_cs INTO l_glan.*
      IF SQLCA.sqlcode THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code = SQLCA.sqlcode
          LET g_errparam.extend = 'foreach:'
          LET g_errparam.popup = TRUE
          CALL cl_err()

          EXIT FOREACH
       END IF
       
       #组合报错信息
       LET l_msg = p_glandocno||'/'||l_glan.glanseq
       LET l_msg1 = p_glandocno||'/'||l_glan.glanseq||'/'||l_glan.glan001
       #科目
       IF NOT cl_null(l_glan.glan001) THEN
          CALL s_voucher_glaq002_chk(p_glanld,l_glan.glan001)
          IF NOT cl_null(g_errno) THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = g_errno
             #160321-00016#19 --s add
             LET g_errparam.replace[1] = 'agli030'
             LET g_errparam.replace[2] = cl_get_progname('agli030',g_lang,"2")
             LET g_errparam.exeprog = 'agli030'
             #160321-00016#19 --e add
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF 
       END IF
       
       #营运据点检查   
       IF NOT cl_null(l_glan.glan003) THEN 
          CALL s_voucher_glaq017_chk(l_glan.glan003)
          IF NOT cl_null(g_errno) THEN
             LET r_success = FALSE
             LET l_errmsg = l_msg||'/'||l_glan.glan003
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_errmsg
             LET g_errparam.code   = g_errno
             LET g_errparam.popup  = TRUE 
             #160321-00016#1--s
             LET g_errparam.replace[1]='aooi100'
             LET g_errparam.replace[2] = cl_get_progname('aooi100',g_lang,"2")
             LET g_errparam.exeprog  = "aooi100"             
             #160321-00016#1--e             
             CALL cl_err()
          END IF 
       ELSE
          LET r_success = FALSE
          INITIALIZE g_errparam TO NULL
          LET g_errparam.extend = l_msg1
          LET g_errparam.code   = 'agl-00291'
          LET g_errparam.popup  = TRUE 
          CALL cl_err()
       END IF
       ################################################################################################
       #依據帳別，科目編號，判斷該科目是否启用
       #部門管理， 利潤成本中心管理，區域管理，交易客商管理，客群管理，產品類別，人員，預算，專案，wbs管理，账款客商管理
       #1.清空核算项管理值
       LET l_glad007 = ''  LET l_glad008 = ''  LET l_glad009 = ''  LET l_glad010 = ''  LET l_glad027 = ''   LET l_glad011 = ''
       LET l_glad012 = ''  LET l_glad013 = ''  LET l_glad015 = ''  LET l_glad016 = ''  LET l_glad031 = ''   LET l_glad032 = ''  LET l_glad033 = ''   
       
       #2.重新依账套，科目抓取核算项管理值(细部核算项)
       CALL s_voucher_fix_acc_open_chk(p_glanld,l_glan.glan001)
       RETURNING l_glad007,l_glad008,l_glad009,l_glad010,l_glad027,l_glad011,l_glad012,l_glad013,l_glad015,l_glad016,l_glad031,l_glad032,l_glad033
                  
       #======================================
       #固定核算项检查
       #如果启用改固定核算项勾选，则对该核算项的值进行检查
       #======================================  
       #該科目做部門管理時，部門不可空白  
       IF l_glad007 = 'Y' THEN
          IF cl_null(l_glan.glan004) THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00043"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             #部门检查          
             CALL s_department_chk(l_glan.glan004,p_docdt) RETURNING l_success
             IF l_success = FALSE THEN
                LET r_success = FALSE
                #160321-00016#19 --s add
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = g_errno
                LET g_errparam.replace[1] = 'aooi125'
                LET g_errparam.replace[2] = cl_get_progname('aooi125',g_lang,"2")
                LET g_errparam.exeprog = 'aooi125'
                #160321-00016#19 --e add
                CALL cl_err()
             END IF
          END IF
       ELSE
          IF l_glan.glan004 <> ' ' THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       END IF
      
       #該科目做利潤成本管理時，利潤成本不可空白  
       IF l_glad008 = 'Y'  THEN
          IF cl_null(l_glan.glan005) THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00044"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             #利润成本中心检查         
             CALL s_voucher_glaq019_chk(l_glan.glan005,p_docdt) 
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
                LET l_errmsg = l_msg||'/'||l_glan.glan005
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = g_errno
                #160321-00016#19 --s add
                LET g_errparam.replace[1] = 'aooi125'
                LET g_errparam.replace[2] = cl_get_progname('aooi125',g_lang,"2")
                LET g_errparam.exeprog = 'aooi125'
                #160321-00016#19 --e add
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
          END IF
       ELSE
          IF l_glan.glan005 <> ' ' THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       END IF 
       
       #該科目做區域管理時，區域不可空白  
       IF l_glad009 = 'Y'  THEN
          IF cl_null(l_glan.glan006) THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00045"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE 
             #区域检查
             CALL s_azzi650_chk_exist('287',l_glan.glan006) RETURNING l_success
             IF NOT l_success THEN
                LET r_success = FALSE
             END IF
          END IF
       ELSE
          IF l_glan.glan006 <> ' ' THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       END IF 
       
       #該科目做交易客商管理時，客商不可空白  
       IF l_glad010 = 'Y'  THEN
          IF cl_null(l_glan.glan007) THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00046"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             #客商检查
             CALL s_voucher_glaq021_chk(l_glan.glan007)
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
                LET l_errmsg = l_msg||'/'||l_glan.glan007
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = g_errno
                #160321-00016#19 --s add
                LET g_errparam.replace[1] = 'apmm100'
                LET g_errparam.replace[2] = cl_get_progname('apmm100',g_lang,"2")
                LET g_errparam.exeprog = 'apmm100'
                #160321-00016#19 --e add
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF 
          END IF
       ELSE
          IF l_glan.glan007 <> ' ' THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       END IF 
       
       #該科目做账款客商管理時，客商不可空白
       IF l_glad027 = 'Y'  THEN
          IF cl_null(l_glan.glan008) THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "axr-00215"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             #客商检查
             CALL s_voucher_glaq021_chk(l_glan.glan008)
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
                LET l_errmsg = l_msg||'/'||l_glan.glan008
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = g_errno
                #160321-00016#19 --s add
                LET g_errparam.replace[1] = 'apmm100'
                LET g_errparam.replace[2] = cl_get_progname('apmm100',g_lang,"2")
                LET g_errparam.exeprog = 'apmm100'
                #160321-00016#19 --e add
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
          END IF
       ELSE
          IF l_glan.glan008 <> ' ' THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       END IF 
       
       #該科目做客群管理時，客群不可空白  
       IF l_glad011 = 'Y'  THEN
          IF cl_null(l_glan.glan009) THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00047"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             #客群检查
             CALL s_azzi650_chk_exist('281',l_glan.glan009) RETURNING l_success
             IF NOT l_success THEN
                LET r_success = FALSE
             END IF
          END IF
       ELSE
          IF l_glan.glan009 <> ' ' THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       END IF 
       
       #該科目做產品分類管理時，不可空白  
       IF l_glad012 = 'Y'  THEN
          IF cl_null(l_glan.glan010) THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00068"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             #产品分类检查 
             CALL s_voucher_glaq024_chk(l_glan.glan010)
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
                LET l_errmsg = l_msg||'/'||l_glan.glan010
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = g_errno
                #160321-00016#19 --s add
                LET g_errparam.replace[1] = 'arti202'
                LET g_errparam.replace[2] = cl_get_progname('arti202',g_lang,"2")
                LET g_errparam.exeprog = 'arti202'
                #160321-00016#19 --e add
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
          END IF
       ELSE
          IF l_glan.glan010 <> ' ' THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       END IF 
       
       #該科目做經營方式管理時，不可空白  
       IF l_glad031 = 'Y'  THEN
          IF cl_null(l_glan.glan051) THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00286"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             #經營方式检查
             CALL s_voucher_glaq051_chk(l_glan.glan051)
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
                LET l_errmsg = l_msg||'/'||l_glan.glan051
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = g_errno
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
          END IF
       ELSE
          IF l_glan.glan051 <> ' ' THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       END IF
       
       #該科目做渠道管理時，不可空白  
       IF l_glad032 = 'Y'  THEN
          IF cl_null(l_glan.glan052) THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00287"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             #渠道检查
             CALL s_voucher_glaq052_chk(l_glan.glan052)
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
                LET l_errmsg = l_msg||'/'||l_glan.glan052
                INITIALIZE g_errparam TO NULL
                LET g_errparam.extend = l_errmsg
                LET g_errparam.code   = g_errno
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
             END IF
         END IF
       ELSE
          IF l_glan.glan052 <> ' ' THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       END IF
       
       #該科目做品牌管理時，不可空白  
       IF l_glad033 = 'Y'  THEN
          IF cl_null(l_glan.glan053) THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00288"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             #品牌检查
             CALL s_azzi650_chk_exist('2002',l_glan.glan053) RETURNING l_success
             IF NOT l_success THEN
                LET r_success = FALSE
             END IF 
          END IF
       ELSE
          IF l_glan.glan053 <> ' ' THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       END IF
       
       #該科目做人員管理時，不可空白  
       IF l_glad013 = 'Y'  THEN
          IF cl_null(l_glan.glan011) THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00069"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             #人员检查
             CALL s_employee_chk(l_glan.glan011) RETURNING l_success
             IF NOT l_success THEN
                LET r_success = FALSE
             END IF 
          END IF
       ELSE
          IF l_glan.glan011 <> ' ' THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       END IF 
       
       #該科目做專案管理時，不可空白  
       IF l_glad015 = 'Y'  THEN
          IF cl_null(l_glan.glan013) THEN
             #LET r_success = FALSE               #170111-00005#1 mark
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             #LET g_errparam.code   = "agl-00071" #170111-00005#1 mark
             LET g_errparam.code   = "agl-00541" #170111-00005#1 add
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             CALL s_aap_project_chk(l_glan.glan013) RETURNING l_success,g_errno
             IF NOT l_success THEN
                LET r_success = FALSE
                LET l_errmsg = l_msg||'/'||l_glan.glan013
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = g_errno
                LET g_errparam.extend = l_errmsg
                #160321-00016#19 --s add
                LET g_errparam.replace[1] = 'apjm200'
                LET g_errparam.replace[2] = cl_get_progname('apjm200',g_lang,"2")
                LET g_errparam.exeprog = 'apjm200'
                #160321-00016#19 --e add
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF
          END IF
       ELSE
          IF l_glan.glan013 <> ' ' THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             LET g_errparam.code   = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       END IF 
       
       #該科目做WBS管理時，不可空白  
       IF l_glad016 = 'Y'  THEN
          IF cl_null(l_glan.glan014) THEN
             #LET r_success = FALSE               #170111-00005#1 mark
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend = l_msg1
             #LET g_errparam.code   = "agl-00072" #170111-00005#1 mark
             LET g_errparam.code   = "agl-00542"  #170111-00005#1 add
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          ELSE
             CALL s_voucher_glaq028_chk(l_glan.glan013,l_glan.glan014) 
             IF NOT cl_null(g_errno) THEN
                LET r_success = FALSE
                LET l_errmsg = l_msg||'/'||l_glan.glan014
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = g_errno
                LET g_errparam.extend = l_errmsg
                LET g_errparam.popup = TRUE
                CALL cl_err()
             END IF
          END IF
       ELSE
          IF l_glan.glan014 <> ' ' THEN
             LET r_success = FALSE
             INITIALIZE g_errparam TO NULL
             LET g_errparam.extend= l_msg1
             LET g_errparam.code    = "agl-00357"
             LET g_errparam.popup  = TRUE 
             CALL cl_err()
          END IF
       END IF
   END FOREACH
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 自動產生憑證
# Memo...........: #151008-00009#4
# Usage..........: CALL s_voucher_gen_ar1(p_type,p_ld,p_date,p_slip,p_sum_type,p_wc,p_preview,p_source)
#                  RETURNING r_success,g_glaq
# Input parameter: p_type         来源类型
#                                 1.axrt470 遞延類型                              
#                : p_ld           帳套
#                : p_date         立帳日期
#                : p_slip         憑證單別
#                : p_sum_type     彙總方式 
#                : p_wc           ＱＢＥ的範圍條件
#                : p_preview      是否先預覽后再拋憑證（Y/N）
#                : p_source       來源
# Return code....: r_success      成功否
#                : g_glaq         傳票底稿清單
# Date & Author..: 160118 By Jessy
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar1(p_type,p_ld,p_date,p_slip,p_sum_type,p_wc,p_preview,p_source)
DEFINE p_type          LIKE type_t.chr2
DEFINE p_ld            LIKE glaa_t.glaald
DEFINE p_date          LIKE glap_t.glapdocdt
DEFINE p_slip          LIKE ooba_t.ooba002
DEFINE p_sum_type      LIKE type_t.chr1
DEFINE p_wc            LIKE type_t.chr1000
DEFINE p_preview       LIKE type_t.chr1
DEFINE p_source        LIKE type_t.chr10
DEFINE r_success       LIKE type_t.num5
DEFINE r_start_no      LIKE glap_t.glapdocno
DEFINE r_end_no        LIKE glap_t.glapdocno
DEFINE l_site          LIKE ooef_t.ooef001
DEFINE l_success       LIKE type_t.num5
   
   
   WHENEVER ERROR CONTINUE
   
   LET r_success  = FALSE
   CALL g_glaq_d.clear()

   #检查事务中
   IF NOT s_transaction_chk('Y',1) THEN
      RETURN r_success
   END IF   

   
   IF cl_null(p_ld) THEN
      #帐套参数为空
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'agl-00121'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   
   
   #检查帐套是否正确
   CALL s_ld_chk_authorization(g_user,p_ld) RETURNING l_success
   IF l_success = FALSE THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'axr-00022'
      LET g_errparam.extend = p_ld
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF 
   
   
   SELECT glaacomp INTO l_site FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald  = p_ld
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'sel glaacomp'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success 
   END IF
   
   
   IF cl_null(p_sum_type) THEN
      #产生凭证的汇总方式为空
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'agl-00123'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success 
   END IF
   
   IF cl_null(p_wc) THEN LET p_wc = " 1=1" END IF

   CASE p_type
        WHEN '1'   #AR遞延沖轉
            CALL s_voucher_gen_ar_5(p_ld,p_sum_type,p_wc,p_source) RETURNING r_success
   END CASE
   
   #將明細資料彙總
   CALL s_voucher_gen_ar_5_ins_group_tmp(p_ld,'1') RETURNING l_success 
   IF NOT l_success THEN
      RETURN r_success,r_start_no,r_end_no
   END IF
   
   IF p_preview = 'Y' THEN   #先預覽,不產生憑證
      RETURN r_success,r_start_no,r_end_no 
   ELSE                      #不預覽,直接產生憑證
      #插入凭证单头
      CALL s_voucher_gen_ar_5_ins_glap(p_slip,p_date,p_ld,p_source) RETURNING r_success,r_start_no,r_end_no
      IF NOT r_success THEN
         RETURN r_success,r_start_no,r_end_no       
      END IF
      RETURN r_success,r_start_no,r_end_no      
   END IF
      
END FUNCTION

################################################################################
# Descriptions...: 自动产生凭证 定义CURSOR
# Memo...........: #151008-00009#4
# Usage..........: CALL s_voucher_gen_ar_5_def_cursor(p_ld,p_wc,p_sum_type,p_date,p_source)
#                  RETURNING r_success
# Input parameter: p_ld           帐套
#                : p_wc           QBE条件(帐款来源)
#                : p_sum_type     汇总方式
#                : p_source       資料來源于
# Return code....: r_success      成功否标识位
# Date & Author..: 160118 By Jessy
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_5_def_cursor(p_ld,p_wc,p_sum_type,p_date,p_source)
DEFINE p_ld            LIKE glaa_t.glaald
DEFINE p_wc            LIKE type_t.chr1000
DEFINE p_sum_type      LIKE type_t.chr1
DEFINE p_source        LIKE type_t.chr10
DEFINE p_date          LIKE type_t.dat
DEFINE r_success       LIKE type_t.num5
DEFINE l_sql           LIKE type_t.chr1000  
DEFINE l_glaa004       LIKE glaa_t.glaa004   
DEFINE l_field         LIKE type_t.chr50
DEFINE l_glab005d      LIKE glab_t.glab005      #借方科目
DEFINE l_glab005c      LIKE glab_t.glab005      #贷方科目

   WHENEVER ERROR CONTINUE
   LET r_success = FALSE 

   IF p_source = 'axrt470' THEN
      #161128-00061#7---add---begin-----------
      #LET l_sql = "SELECT * FROM xrep_t ",
      LET l_sql = "SELECT xrepent,xrepsite,xrepcomp,xrepdocno,xrepdocdt,xrepld,xrep001,xrep002,xrep003,",
                  "xrep004,xrep005,xrepstus,xrepownid,xrepowndp,xrepcrtid,xrepcrtdp,xrepcrtdt,xrepmodid,",
                  "xrepmoddt,xrepcnfid,xrepcnfdt,xrepud001,xrepud002,xrepud003,xrepud004,xrepud005,",
                  "xrepud006,xrepud007,xrepud008,xrepud009,xrepud010,xrepud011,xrepud012,xrepud013,",
                  "xrepud014,xrepud015,xrepud016,xrepud017,xrepud018,xrepud019,xrepud020,xrepud021,",
                  "xrepud022,xrepud023,xrepud024,xrepud025,xrepud026,xrepud027,xrepud028,xrepud029,",
                  "xrepud030 FROM xrep_t ",
      #161128-00061#7---add---end-----------
                  " WHERE xrepent = ",g_enterprise,
                  "   AND xrepld = '",p_ld CLIPPED,"'",
                  "   AND xrep004 IS NULL ",
                  "   AND ",p_wc
      PREPARE s_voucher_gen_ar_5_p FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_ar_5_p'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_ar_5_cs CURSOR FOR s_voucher_gen_ar_5_p
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_ar_5_cs'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
   END IF

   IF p_source = 'axrt470' THEN
      #借：遞延收入科目
                   #單號/日期/借/企業/法人/帳套/摘要/科目
      LET l_sql = "SELECT xrepdocno,xrepdocdt,'1',xrepent,xrepcomp,xrepld,xreq039,xreq012,",
                  #幣別/匯率/計價單位/單價/原幣金額/票據編號/票據日期/申請人/銀行帳號/款別編號/收支專案
                  "       xreq100,xreq101,'',0,0,'','','','','','',",
                  #營運據點/部門/利潤中心/區域/交易客戶/帳款客戶/客群/產品類別/人員
#                  "       xreqorga,xreq018,xreq019,xreq020,xreq016,xreq017,xreq021,xreq022,xreq023,", #160407-00019#2 mark
                  "       xreqorga,xreq018,xreq019,xreq020,xreq017,xreq016,xreq021,xreq022,xreq023,", #160407-00019#2 add
                  #專案編號/WBS/經營方式/渠道/品牌
                  "       xreq024,xreq025,xreq026,xreq027,xreq028,",  
                  #自由核算項1~5
                  "       xreq029,xreq030,xreq031,xreq032,xreq033,",
                  #自由核算項6~10
                  "       xreq034,xreq035,xreq036,xreq037,xreq038,",
                  #借(本幣)/貸/計價數量/總計/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
                  "       xreq113,0,0,xreq103,xreq121,xreq123,0,xreq131,xreq133,0, ",
                  #項次一/來源/項次二/現金變動碼
                  "       xreqseq,'xrep','','',xreq003 ",
                  "  FROM xrep_t,xreq_t ",
                  " WHERE xrepent = ",g_enterprise,
                  "   AND xrepld = '",p_ld,"'",
                  "   AND xrepdocno = ?",
                  "   AND xrepent = xreqent AND xrepdocno = xreqdocno AND xrepld = xreqld"
      PREPARE s_voucher_gen_ar_5_p1 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_ar_5_p1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_ar_5_cs1 CURSOR FOR s_voucher_gen_ar_5_p1
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_ar_5_cs1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      
      #貸：遞延沖轉科目
                   #單號/日期/借/企業/法人/帳套/摘要/科目
      LET l_sql = "SELECT xrepdocno,xrepdocdt,'2',xrepent,xrepcomp,xrepld,xreq039,xreq013,",
                  #幣別/匯率/計價單位/單價/原幣金額/票據編號/票據日期/申請人/銀行帳號/款別編號/收支專案
                  "       xreq100,xreq101,'',0,0,'','','','','','',",
                  #營運據點/部門/利潤中心/區域/交易客戶/帳款客戶/客群/產品類別/人員
#                  "       xreqorga,xreq018,xreq019,xreq020,xreq016,xreq017,xreq021,xreq022,xreq023,", #160407-00019#2 mark
                  "       xreqorga,xreq018,xreq019,xreq020,xreq017,xreq016,xreq021,xreq022,xreq023,", #160407-00019#2 add
                  #專案編號/WBS/經營方式/渠道/品牌
                  "       xreq024,xreq025,xreq026,xreq027,xreq028,",  
                  #自由核算項1~5
                  "       xreq029,xreq030,xreq031,xreq032,xreq033,",
                  #自由核算項6~10
                  "       xreq034,xreq035,xreq036,xreq037,xreq038,",
                  #借(本幣)/貸/計價數量/總計/本位幣二匯率/借方金額/貸方金額/本位幣三匯率/借方金額/貸方金額
                  "       0,xreq113,0,xreq103,xreq121,0,xreq123,xreq131,0,xreq133, ",
                  #項次一/來源/項次二/現金變動碼
                  "       xreqseq,'xrep','','',xreq003 ",
                  "  FROM xrep_t,xreq_t ",
                  " WHERE xrepent = ",g_enterprise,
                  "   AND xrepld = '",p_ld,"'",
                  "   AND xrepdocno = ?",
                  "   AND xrepent = xreqent AND xrepdocno = xreqdocno AND xrepld = xreqld"
      PREPARE s_voucher_gen_ar_5_p2 FROM l_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_ar_5_p2'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_ar_5_cs2 CURSOR FOR s_voucher_gen_ar_5_p2
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_ar_5_cs2'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF      
   END IF

   #从临时表中取科目
   LET l_sql = " SELECT DISTINCT docno,glaq002 FROM s_vr_tmp02 ",  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar1_tmp ——> s_vr_tmp02
               "  ORDER BY docno"
   PREPARE s_voucher_gen_ar_5_p3 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_5_p3'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_5_cs3 CURSOR FOR s_voucher_gen_ar_5_p3
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_5_cs3'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   
   #从agli030取科目设置
   LET l_sql = " SELECT glad005,glad007,glad008,glad009,glad010,glad011,glad012,glad013,glad015,",
               "        glad016,glad017,glad018,glad019,glad020,glad021,glad022,glad023,glad024,glad025,",
               "        glad026,glad027,glad031,glad032,glad033 ",
               "   FROM glad_t ",
               "  WHERE gladent = ",g_enterprise,
               "    AND gladld  = '",p_ld CLIPPED,"'",
               "    AND glad001 = ? "
   PREPARE s_voucher_gen_ar_5_p4 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_5_p4'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_5_cs4 CURSOR FOR s_voucher_gen_ar_5_p4
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_5_cs4'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   
   LET l_sql = " SELECT UNIQUE glaqcomp,docno,docdt",
               "   FROM s_vr_tmp02 "  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar1_tmp ——> s_vr_tmp02
   PREPARE s_voucher_gen_ar_5_p5 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_5_p5'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_5_cs5 CURSOR FOR s_voucher_gen_ar_5_p5
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_5_cs5'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   
   #用于生成glaq_t资料的临时表
   LET l_sql = " SELECT * FROM s_vr_tmp02 ",  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar1_tmp ——> s_vr_tmp02
               " ORDER BY d desc,c "
   PREPARE s_voucher_gen_ar_5_p6 FROM l_sql
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_5_p6'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   DECLARE s_voucher_gen_ar_5_cs6 CURSOR FOR s_voucher_gen_ar_5_p6
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_5_cs6'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF

   IF p_source = 'axrt470' THEN
      LET l_sql = "UPDATE xrep_t SET xrep004 = ? ",
                  " WHERE xrepent = ",g_enterprise,
                  "   AND xrepld = '",p_ld,"'",
                  "   AND xrepdocno = ? "
   END IF

   PREPARE s_voucher_gen_ar_5_p7 FROM l_sql  #(s_voucher_gen_fm_1_ins_glaq)
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 's_voucher_gen_ar_5_p7'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF

   #LET g_sql = "SELECT docno,docdt,sw,glaqent,glaqcomp,glaqld,glaq001,glaq002,glaq005,glaq006,",
   #               "    glaq007,glaq009,glaq010,glaq011,glaq012,glaq013,glaq014,glaq015,glaq016,",
   #               "    glaq017,glaq018,glaq019,glaq020,glaq021,glaq022,glaq023,glaq024,glaq025, ",
   #               "    glaq027,glaq028,glaq051,glaq052,glaq053,glaq029,glaq030,glaq031,glaq032,", 
   #               "    glaq033,glaq034,glaq035,glaq036,glaq037,glaq038,d,c,qty,sum,glaq039,glaq040,",
   #               "    glaq041,glaq042,glaq043,glaq044,seq,source,glaqseq,glgb055 ",
   #               "  FROM s_voucher_ar1_tmp "
   #PREPARE s_voucher_gen_ar_5_p8 FROM g_sql
   #IF SQLCA.sqlcode THEN
   #   INITIALIZE g_errparam TO NULL
   #   LET g_errparam.code = SQLCA.sqlcode
   #   LET g_errparam.extend = 's_voucher_gen_ar_5_p8'
   #   LET g_errparam.popup = TRUE
   #   CALL cl_err()
   #   RETURN r_success
   #END IF
   #DECLARE s_voucher_gen_ar_5_cs8 CURSOR FOR s_voucher_gen_ar_5_p8
   #IF SQLCA.sqlcode THEN
   #   INITIALIZE g_errparam TO NULL
   #   LET g_errparam.code = SQLCA.sqlcode
   #   LET g_errparam.extend = 's_voucher_gen_ar_5_cs8'
   #   LET g_errparam.popup = TRUE
   #   CALL cl_err()
   #   RETURN r_success
   #END IF 

   LET r_success = TRUE
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 遞延沖轉傳票axrt470
# Memo...........: #151008-00009#4
# Usage..........: CALL s_voucher_gen_ar_5(p_ld,p_sum_type,p_wc,p_source)
#                  RETURNING r_success,g_glaq
# Input parameter: p_ld           帐套
#                : p_sum_type     汇总方式 
#                : p_wc           QBE条件(帐款来源)
#                : p_source       資料來源于 
# Return code....: r_success      成功否
#                : g_glaq         傳票底稿清單
# Date & Author..: 160118 By Jessy
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_5(p_ld,p_sum_type,p_wc,p_source)
DEFINE p_ld            LIKE glaa_t.glaald
DEFINE p_sum_type      LIKE type_t.chr1
DEFINE p_wc            LIKE type_t.chr1000
DEFINE p_source        LIKE type_t.chr10
#161128-00061#7---add---begin-----------
#DEFINE l_xrep          RECORD LIKE xrep_t.*  
DEFINE l_xrep RECORD  #各期遞延沖轉主檔
       xrepent LIKE xrep_t.xrepent, #企業編號
       xrepsite LIKE xrep_t.xrepsite, #帳務中心
       xrepcomp LIKE xrep_t.xrepcomp, #法人
       xrepdocno LIKE xrep_t.xrepdocno, #單據號碼
       xrepdocdt LIKE xrep_t.xrepdocdt, #單據日期
       xrepld LIKE xrep_t.xrepld, #帳套
       xrep001 LIKE xrep_t.xrep001, #年度
       xrep002 LIKE xrep_t.xrep002, #期別
       xrep003 LIKE xrep_t.xrep003, #帳務人員
       xrep004 LIKE xrep_t.xrep004, #傳票號碼
       xrep005 LIKE xrep_t.xrep005, #第一期系統認列
       xrepstus LIKE xrep_t.xrepstus, #狀態碼
       xrepownid LIKE xrep_t.xrepownid, #資料所有者
       xrepowndp LIKE xrep_t.xrepowndp, #資料所屬部門
       xrepcrtid LIKE xrep_t.xrepcrtid, #資料建立者
       xrepcrtdp LIKE xrep_t.xrepcrtdp, #資料建立部門
       xrepcrtdt LIKE xrep_t.xrepcrtdt, #資料創建日
       xrepmodid LIKE xrep_t.xrepmodid, #資料修改者
       xrepmoddt LIKE xrep_t.xrepmoddt, #最近修改日
       xrepcnfid LIKE xrep_t.xrepcnfid, #資料確認者
       xrepcnfdt LIKE xrep_t.xrepcnfdt, #資料確認日
       xrepud001 LIKE xrep_t.xrepud001, #自定義欄位(文字)001
       xrepud002 LIKE xrep_t.xrepud002, #自定義欄位(文字)002
       xrepud003 LIKE xrep_t.xrepud003, #自定義欄位(文字)003
       xrepud004 LIKE xrep_t.xrepud004, #自定義欄位(文字)004
       xrepud005 LIKE xrep_t.xrepud005, #自定義欄位(文字)005
       xrepud006 LIKE xrep_t.xrepud006, #自定義欄位(文字)006
       xrepud007 LIKE xrep_t.xrepud007, #自定義欄位(文字)007
       xrepud008 LIKE xrep_t.xrepud008, #自定義欄位(文字)008
       xrepud009 LIKE xrep_t.xrepud009, #自定義欄位(文字)009
       xrepud010 LIKE xrep_t.xrepud010, #自定義欄位(文字)010
       xrepud011 LIKE xrep_t.xrepud011, #自定義欄位(數字)011
       xrepud012 LIKE xrep_t.xrepud012, #自定義欄位(數字)012
       xrepud013 LIKE xrep_t.xrepud013, #自定義欄位(數字)013
       xrepud014 LIKE xrep_t.xrepud014, #自定義欄位(數字)014
       xrepud015 LIKE xrep_t.xrepud015, #自定義欄位(數字)015
       xrepud016 LIKE xrep_t.xrepud016, #自定義欄位(數字)016
       xrepud017 LIKE xrep_t.xrepud017, #自定義欄位(數字)017
       xrepud018 LIKE xrep_t.xrepud018, #自定義欄位(數字)018
       xrepud019 LIKE xrep_t.xrepud019, #自定義欄位(數字)019
       xrepud020 LIKE xrep_t.xrepud020, #自定義欄位(數字)020
       xrepud021 LIKE xrep_t.xrepud021, #自定義欄位(日期時間)021
       xrepud022 LIKE xrep_t.xrepud022, #自定義欄位(日期時間)022
       xrepud023 LIKE xrep_t.xrepud023, #自定義欄位(日期時間)023
       xrepud024 LIKE xrep_t.xrepud024, #自定義欄位(日期時間)024
       xrepud025 LIKE xrep_t.xrepud025, #自定義欄位(日期時間)025
       xrepud026 LIKE xrep_t.xrepud026, #自定義欄位(日期時間)026
       xrepud027 LIKE xrep_t.xrepud027, #自定義欄位(日期時間)027
       xrepud028 LIKE xrep_t.xrepud028, #自定義欄位(日期時間)028
       xrepud029 LIKE xrep_t.xrepud029, #自定義欄位(日期時間)029
       xrepud030 LIKE xrep_t.xrepud030  #自定義欄位(日期時間)030
       END RECORD

#161128-00061#7---add---end------------
DEFINE r_success       LIKE type_t.num5
   
   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE
   
   #1.定义CURSOR
   CALL s_voucher_gen_ar_5_def_cursor(p_ld,p_wc,p_sum_type,'',p_source) RETURNING g_sub_success
   IF NOT g_sub_success THEN
      RETURN r_success
   END IF
   
   DELETE FROM s_vr_tmp02;  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar1_tmp ——> s_vr_tmp02
   
   #2.插入临时表
   FOREACH s_voucher_gen_ar_5_cs INTO l_xrep.* 
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach s_voucher_gen_ar_5_cs'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      #借:投資類型科目
      CALL s_voucher_gen_ar_5_ins_tmp('91',l_xrep.xrepld,l_xrep.xrepdocno) 
           RETURNING g_sub_success 
      IF NOT g_sub_success THEN RETURN r_success END IF
      
      #貸:支付方式科目
      CALL s_voucher_gen_ar_5_ins_tmp('92',l_xrep.xrepld,l_xrep.xrepdocno) 
           RETURNING g_sub_success 
      IF NOT g_sub_success THEN RETURN r_success END IF
      
   END FOREACH
   
   #3.按科目设置进行UPDATE,若有做不管理的字段,UPDATE至' '
   CALL s_voucher_gen_ar_5_upd_tmp(p_ld) RETURNING g_sub_success
   IF NOT g_sub_success THEN
      RETURN r_success
   END IF
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 產生傳票
# Memo...........: #151008-00009#4
# Usage..........: CALL s_voucher_gen_ar_5_ins_tmp(p_type,p_ld,p_docno)
#                  RETURNING 回传参数
# Date & Author..: 160118 By Jessy
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_5_ins_tmp(p_type,p_ld,p_docno)
DEFINE p_type           LIKE type_t.chr5        #類型
DEFINE p_ld             LIKE glaq_t.glaqld      #帳套     
DEFINE p_docno          LIKE glaq_t.glaqdocno   #帳款編號 
DEFINE l_tmp            RECORD
       docno            LIKE glaq_t.glaqdocno,  #單據編號
       docdt            LIKE glap_t.glapdocdt, 
       sw               LIKE type_t.chr1,   
       glaqent          LIKE glaq_t.glaqent,
       glaqcomp         LIKE glaq_t.glaqcomp,
       glaqld           LIKE glaq_t.glaqld,
       glaq001          LIKE glaq_t.glaq001,  #摘要
       glaq002          LIKE glaq_t.glaq002,  #科目
       glaq005          LIKE glaq_t.glaq005,  #幣別
       glaq006          LIKE glaq_t.glaq006,  #匯率
       glaq007          LIKE glaq_t.glaq007,  #單位
       glaq009          LIKE glaq_t.glaq009,  #單價
       glaq010          LIKE glaq_t.glaq010,  #原幣金額
       glaq011          LIKE glaq_t.glaq011,  #票據編碼
       glaq012          LIKE glaq_t.glaq012,  #票據日期
       glaq013          LIKE glaq_t.glaq013,  #申請人
       glaq014          LIKE glaq_t.glaq014,  #銀行帳號
       glaq015          LIKE glaq_t.glaq015,  #款別編號
       glaq016          LIKE glaq_t.glaq016,  #收支項目 
       glaq017          LIKE glaq_t.glaq017,  #營運據點
       glaq018          LIKE glaq_t.glaq018,  #部門
       glaq019          LIKE glaq_t.glaq019,  #利潤/成本中心
       glaq020          LIKE glaq_t.glaq020,  #區域
       glaq021          LIKE glaq_t.glaq021,  #交易客商
       glaq022          LIKE glaq_t.glaq022,  #帳款客戶
       glaq023          LIKE glaq_t.glaq023,  #客群
       glaq024          LIKE glaq_t.glaq024,  #產品類別
       glaq025          LIKE glaq_t.glaq025,  #人員    
       glaq027          LIKE glaq_t.glaq027,  #專案編號
       glaq028          LIKE glaq_t.glaq028,  #WBS
       glaq051          LIKE glaq_t.glaq051,  #經營方式
       glaq052          LIKE glaq_t.glaq052,  #渠道 
       glaq053          LIKE glaq_t.glaq053,  #品牌
       glaq029          LIKE glaq_t.glaq029,  #自由核算項
       glaq030          LIKE glaq_t.glaq030,  
       glaq031          LIKE glaq_t.glaq031,  
       glaq032          LIKE glaq_t.glaq032,  
       glaq033          LIKE glaq_t.glaq033,
       glaq034          LIKE glaq_t.glaq034,  
       glaq035          LIKE glaq_t.glaq035,  
       glaq036          LIKE glaq_t.glaq036,  
       glaq037          LIKE glaq_t.glaq037,  
       glaq038          LIKE glaq_t.glaq038,  
       d                LIKE glaq_t.glaq003,  #借方金額
       c                LIKE glaq_t.glaq004,  #貸方金額
       qty              LIKE glaq_t.glaq008,  #數量
       sum              LIKE glaq_t.glaq010,  #總計
       glaq039          LIKE glaq_t.glaq039,  #匯率(本位幣二)
       glaq040          LIKE glaq_t.glaq040,  #借方金額(本位幣二)
       glaq041          LIKE glaq_t.glaq041,  #貸方金額(本位幣二)
       glaq042          LIKE glaq_t.glaq042,  #匯率(本位幣三)
       glaq043          LIKE glaq_t.glaq043,  #借方金額(本位幣三)
       glaq044          LIKE glaq_t.glaq044,  #貸方金額(本位幣三)
       seq              LIKE glaq_t.glaqseq,  #項次
       source           LIKE type_t.chr100,   #來源
       glaqseq          LIKE glaq_t.glaqseq,  #項次
       glgb055          LIKE glgb_t.glgb055   #現金變動碼   
                        END RECORD
DEFINE l_memo           LIKE glaq_t.glaq001
DEFINE l_xreq003        LIKE xreq_t.xreq003 
DEFINE l_glaq020        LIKE glaq_t.glaq020
DEFINE l_glaq021        LIKE glaq_t.glaq021
DEFINE l_glaq022        LIKE glaq_t.glaq022
DEFINE l_glaq023        LIKE glaq_t.glaq023
DEFINE l_glaq024        LIKE glaq_t.glaq024
DEFINE l_glaq051        LIKE glaq_t.glaq051
DEFINE l_glaq052        LIKE glaq_t.glaq052
DEFINE l_glaq053        LIKE glaq_t.glaq053
DEFINE l_glaq027        LIKE glaq_t.glaq027
DEFINE l_glaq028        LIKE glaq_t.glaq028
DEFINE l_glaq029        LIKE glaq_t.glaq029
DEFINE l_glaq030        LIKE glaq_t.glaq030
DEFINE l_glaq031        LIKE glaq_t.glaq031
DEFINE l_glaq032        LIKE glaq_t.glaq032
DEFINE l_glaq033        LIKE glaq_t.glaq033
DEFINE l_glaq034        LIKE glaq_t.glaq034
DEFINE l_glaq035        LIKE glaq_t.glaq035
DEFINE l_glaq036        LIKE glaq_t.glaq036
DEFINE l_glaq037        LIKE glaq_t.glaq037
DEFINE l_glaq038        LIKE glaq_t.glaq038
DEFINE l_glaa001        LIKE glaa_t.glaa001
DEFINE l_glaa004        LIKE glaa_t.glaa004
DEFINE l_glac016        LIKE glac_t.glac016
DEFINE l_glad034        LIKE glad_t.glad034
DEFINE l_prog           LIKE type_t.chr100
DEFINE r_success        LIKE type_t.num5

   WHENEVER ERROR CONTINUE

   LET r_success = FALSE
   INITIALIZE l_tmp.* TO NULL
   
   CASE p_type
      WHEN '91' #借:遞延收入科目
         FOREACH s_voucher_gen_ar_5_cs1 USING p_docno INTO l_tmp.*,l_xreq003 
            #將數值轉正數(避免異動類型為4折讓沖轉時,金額呈現負數)
            IF l_xreq003 = '4' THEN
               LET l_tmp.sum = s_math_abs(l_tmp.sum)
               LET l_tmp.c = s_math_abs(l_tmp.c)
               LET l_tmp.d = s_math_abs(l_tmp.d)
               LET l_tmp.glaq010 = s_math_abs(l_tmp.glaq010)
               LET l_tmp.glaq040 = s_math_abs(l_tmp.glaq040)
               LET l_tmp.glaq041 = s_math_abs(l_tmp.glaq041)
               LET l_tmp.glaq043 = s_math_abs(l_tmp.glaq043)
               LET l_tmp.glaq044 = s_math_abs(l_tmp.glaq044)
            END IF
         
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_ar_5_cs1'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            #若異動類型為4折讓沖銷,則借貸方向要相反
            IF l_tmp.d = 0 THEN CONTINUE FOREACH END IF
            IF cl_null(l_tmp.d) THEN CONTINUE FOREACH END IF
            IF l_xreq003 = '4' THEN  
               LET l_tmp.sw = '2'
               LET l_tmp.c = l_tmp.d  
               LET l_tmp.sum = l_tmp.sum  #原幣
               LET l_tmp.d = 0                   
               LET l_tmp.glaq041 = l_tmp.glaq040
               LET l_tmp.glaq040 = 0             
               LET l_tmp.glaq044 = l_tmp.glaq043
               LET l_tmp.glaq043 = 0
            END IF
            
            CALL s_pre_voucher_glad034_get(p_ld,l_tmp.glaq002) RETURNING l_glad034
            #科目未啟用多幣別管理
            IF l_glad034 = 'N' OR cl_null(l_glad034) THEN    
               CALL s_ld_sel_glaa(p_ld,'glaa001') RETURNING g_sub_success,l_tmp.glaq005
               LET l_tmp.glaq006 = 1
               IF l_tmp.d <> 0 THEN
                  LET l_tmp.sum = l_tmp.d
               END IF
               IF l_tmp.c <> 0 THEN
                  LET l_tmp.sum = l_tmp.c
               END IF 
            END IF
            LET l_tmp.glaq010 = l_tmp.sum
            
            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF
   
            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 
            
            #摘要值設定
            LET l_prog = g_prog
            IF cl_null(l_tmp.glaq001) THEN
               #                 2:摘要/账套/科目编号  /程序编号/目的字段/单据编号/单据项次1/单据项次2
               CALL s_account_item('2',p_ld,l_tmp.glaq002,l_prog,'glgb001',p_docno,l_tmp.seq,'') #160927-00008#1 mod 'xreq039'-->'glgb001'
               RETURNING l_memo
               IF NOT cl_null(l_memo) THEN
                  LET l_tmp.glaq001 = l_memo
               END IF
            END IF
            
            INSERT INTO s_vr_tmp02 VALUES(l_tmp.*)  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar1_tmp ——> s_vr_tmp02
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp02'  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar1_tmp ——> s_vr_tmp02
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH
         
      WHEN '92' #貸:遞延沖轉科目
         FOREACH s_voucher_gen_ar_5_cs2 USING p_docno INTO l_tmp.*,l_xreq003 
            #將數值轉正數(避免異動類型為4折讓沖轉時,金額呈現負數)
            IF l_xreq003 = '4' THEN 
               LET l_tmp.sum = s_math_abs(l_tmp.sum)
               LET l_tmp.c = s_math_abs(l_tmp.c)
               LET l_tmp.d = s_math_abs(l_tmp.d)
               LET l_tmp.glaq010 = s_math_abs(l_tmp.glaq010)
               LET l_tmp.glaq040 = s_math_abs(l_tmp.glaq040)
               LET l_tmp.glaq041 = s_math_abs(l_tmp.glaq041)
               LET l_tmp.glaq043 = s_math_abs(l_tmp.glaq043)
               LET l_tmp.glaq044 = s_math_abs(l_tmp.glaq044)
            END IF
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_ar_5_cs2'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
            #若異動類型為4折讓沖銷,則借貸方向要相反
            IF l_tmp.c = 0 THEN CONTINUE FOREACH END IF
            IF cl_null(l_tmp.c) THEN CONTINUE FOREACH END IF 
            IF l_xreq003 = '4' THEN 
               LET l_tmp.sw = '1'
               LET l_tmp.d = l_tmp.c
               LET l_tmp.sum = l_tmp.sum #原幣
               LET l_tmp.c = 0                    
               LET l_tmp.glaq040 = l_tmp.glaq041 
               LET l_tmp.glaq041 = 0              
               LET l_tmp.glaq043 = l_tmp.glaq044 
               LET l_tmp.glaq044 = 0
            END IF 
  
            #科目未啟用多幣別管理
            CALL s_pre_voucher_glad034_get(p_ld,l_tmp.glaq002) RETURNING l_glad034
            IF l_glad034 = 'N' OR cl_null(l_glad034) THEN    
               CALL s_ld_sel_glaa(p_ld,'glaa001') RETURNING g_sub_success,l_tmp.glaq005
               LET l_tmp.glaq006 = 1
               IF l_tmp.d <> 0 THEN
                  LET l_tmp.sum = l_tmp.d
               END IF
               IF l_tmp.c <> 0 THEN
                  LET l_tmp.sum = l_tmp.c
               END IF
            END IF
            LET l_tmp.glaq010 = l_tmp.sum

            #若無核算項則看有沒有預設，有就抓
            CALL s_voucher_get_glas003(p_ld,l_tmp.glaq002)
                 RETURNING l_glaq020,l_glaq021,l_glaq022,l_glaq023,l_glaq024,l_glaq051,l_glaq052,l_glaq053,
                           l_glaq027,l_glaq028,l_glaq029,l_glaq030,l_glaq031,l_glaq032,l_glaq033,l_glaq034,
                           l_glaq035,l_glaq036,l_glaq037,l_glaq038
            IF NOT cl_null(l_glaq020) THEN LET l_tmp.glaq020 = l_glaq020 END IF
            IF NOT cl_null(l_glaq021) THEN LET l_tmp.glaq021 = l_glaq021 END IF
            IF NOT cl_null(l_glaq022) THEN LET l_tmp.glaq022 = l_glaq022 END IF
            IF NOT cl_null(l_glaq023) THEN LET l_tmp.glaq023 = l_glaq023 END IF
            IF NOT cl_null(l_glaq024) THEN LET l_tmp.glaq024 = l_glaq024 END IF
            IF NOT cl_null(l_glaq051) THEN LET l_tmp.glaq051 = l_glaq051 END IF
            IF NOT cl_null(l_glaq052) THEN LET l_tmp.glaq052 = l_glaq052 END IF
            IF NOT cl_null(l_glaq053) THEN LET l_tmp.glaq053 = l_glaq053 END IF
            IF NOT cl_null(l_glaq027) THEN LET l_tmp.glaq027 = l_glaq027 END IF
            IF NOT cl_null(l_glaq028) THEN LET l_tmp.glaq028 = l_glaq028 END IF
            IF NOT cl_null(l_glaq029) THEN LET l_tmp.glaq029 = l_glaq029 END IF
            IF NOT cl_null(l_glaq030) THEN LET l_tmp.glaq030 = l_glaq030 END IF
            IF NOT cl_null(l_glaq031) THEN LET l_tmp.glaq031 = l_glaq031 END IF
            IF NOT cl_null(l_glaq032) THEN LET l_tmp.glaq032 = l_glaq032 END IF
            IF NOT cl_null(l_glaq033) THEN LET l_tmp.glaq032 = l_glaq033 END IF
            IF NOT cl_null(l_glaq034) THEN LET l_tmp.glaq032 = l_glaq034 END IF
            IF NOT cl_null(l_glaq035) THEN LET l_tmp.glaq032 = l_glaq035 END IF
            IF NOT cl_null(l_glaq036) THEN LET l_tmp.glaq032 = l_glaq036 END IF
            IF NOT cl_null(l_glaq037) THEN LET l_tmp.glaq032 = l_glaq037 END IF
            IF NOT cl_null(l_glaq038) THEN LET l_tmp.glaq032 = l_glaq038 END IF

            #现金变动码预设值
            CALL s_voucher_glac016_get(l_glaa004,l_tmp.glaq002) RETURNING l_glac016
            IF cl_null(l_tmp.glgb055) AND l_glac016 = 'Y' THEN 
               CALL s_voucher_glad006_get(p_ld,l_tmp.glaq002,l_tmp.d,l_tmp.c) RETURNING l_tmp.glgb055
            END IF 

            #摘要值設定
            LET l_prog = g_prog
            IF cl_null(l_tmp.glaq001) THEN
               #                 2:摘要/账套/科目编号  /程序编号/目的字段/单据编号/单据项次1/单据项次2
               CALL s_account_item('2',p_ld,l_tmp.glaq002,l_prog,'glgb001',p_docno,l_tmp.seq,'') #160927-00008#1 mod 'xreq039'-->'glgb001'
               RETURNING l_memo
               IF NOT cl_null(l_memo) THEN
                  LET l_tmp.glaq001 = l_memo
               END IF
            END IF

            INSERT INTO s_vr_tmp02 VALUES(l_tmp.*)  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar1_tmp ——> s_vr_tmp02
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'insert s_vr_tmp02'  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar1_tmp ——> s_vr_tmp02
               LET g_errparam.popup = FALSE
               CALL cl_err()
               RETURN r_success
            END IF
         END FOREACH 
   END CASE
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 自动产生凭证 - BY 科目的管理设置做UPDATE
# Memo...........: #151008-00009#4
# Usage..........: CALL s_voucher_gen_ar_5_upd_tmp(p_ld)
#                  RETURNING r_success
# Input parameter: p_ld           帐套
# Return code....: r_success      成功否标识位
# Date & Author..: 160118 By Jessy
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_5_upd_tmp(p_ld)
DEFINE p_ld            LIKE glaa_t.glaald
DEFINE r_success       LIKE type_t.num5
DEFINE l_ld            LIKE glaa_t.glaald
DEFINE l_glaq002       LIKE glaq_t.glaq002
DEFINE l_docno         LIKE glaq_t.glaqdocno
DEFINE l_upd_field     LIKE type_t.chr1000
DEFINE l_sql           LIKE type_t.chr1000
DEFINE l_glad_r        RECORD 
       glad005         LIKE glad_t.glad005,  #数量/金额管理否
       glad007         LIKE glad_t.glad007,  #部门管理否
       glad008         LIKE glad_t.glad008,  #利润成本管理否
       glad009         LIKE glad_t.glad009,  #区域管理否
       glad010         LIKE glad_t.glad010,  #交易客商管理否
       glad011         LIKE glad_t.glad011,  #客群管理否
       glad012         LIKE glad_t.glad012,  #产品类别管理否
       glad013         LIKE glad_t.glad013,  #人员管理否
       glad015         LIKE glad_t.glad015,  #专案管理否
       glad016         LIKE glad_t.glad016,  #WBS管理否
       glad017         LIKE glad_t.glad017,  #自由核算项1管理否
       glad018         LIKE glad_t.glad018,  #自由核算项2管理否
       glad019         LIKE glad_t.glad019,  #自由核算项3管理否
       glad020         LIKE glad_t.glad020,  #自由核算项4管理否
       glad021         LIKE glad_t.glad021,  #自由核算项5管理否
       glad022         LIKE glad_t.glad022,  #自由核算项6管理否
       glad023         LIKE glad_t.glad023,  #自由核算项7管理否
       glad024         LIKE glad_t.glad024,  #自由核算项8管理否
       glad025         LIKE glad_t.glad025,  #自由核算项9管理否
       glad026         LIKE glad_t.glad026,  #自由核算项10管理否   
       glad027         LIKE glad_t.glad027,  #账款客商管理否 
       glad031         LIKE glad_t.glad031,  #經營方式管理否
       glad032         LIKE glad_t.glad032,  #渠道管理否
       glad033         LIKE glad_t.glad033   #品牌管理否
                       END RECORD
   WHENEVER ERROR CONTINUE
   LET r_success = FALSE   
   
   FOREACH s_voucher_gen_ar_5_cs3 INTO l_docno,l_glaq002
       IF SQLCA.sqlcode THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code = SQLCA.sqlcode
          LET g_errparam.extend = 'foreach s_voucher_gen_ar_5_cs3'
          LET g_errparam.popup = TRUE
          CALL cl_err()

          RETURN r_success
       END IF  
       
       INITIALIZE l_glad_r.* TO NULL
       
       EXECUTE s_voucher_gen_ar_5_p4 USING l_glaq002 INTO l_glad_r.*

       LET l_upd_field = NULL
       IF l_glad_r.glad005 = 'N' OR cl_null(l_glad_r.glad005) THEN  #数量/金额不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq007 = ' ',qty = 0,glaq009 = 0"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq007 = ' ',glaq008 = 0,glaq009 = 0"
          END IF
       END IF
       IF l_glad_r.glad007 = 'N' OR cl_null(l_glad_r.glad007) THEN  #部门不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq018 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq018 = ' '"
          END IF
       END IF
       IF l_glad_r.glad008 = 'N' OR cl_null(l_glad_r.glad008) THEN  #利润成本不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq019 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq019 = ' '"
          END IF       
       END IF       

       IF l_glad_r.glad009 = 'N' OR cl_null(l_glad_r.glad009) THEN  #区域不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq020 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq020 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad010 = 'N' OR cl_null(l_glad_r.glad010) THEN  #交易客商不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq021 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq021 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad027 = 'N' OR cl_null(l_glad_r.glad027) THEN  #账款客商不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq022 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq022 = ' '"
          END IF       
       END IF
       IF l_glad_r.glad011 = 'N' OR cl_null(l_glad_r.glad011) THEN  #客群不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq023 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq023 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad012 = 'N' OR cl_null(l_glad_r.glad012) THEN  #产品类别不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq024 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq024 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad013 = 'N' OR cl_null(l_glad_r.glad013) THEN  #人员不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq025 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq025 = ' '"
          END IF       
       END IF             
       IF l_glad_r.glad015 = 'N' OR cl_null(l_glad_r.glad015) THEN  #专案不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq027 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq027 = ' '"
          END IF       
       END IF        
       IF l_glad_r.glad016 = 'N' OR cl_null(l_glad_r.glad016) THEN  #WBS不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq028 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq028 = ' '"
          END IF       
       END IF
       IF l_glad_r.glad031 = 'N' OR cl_null(l_glad_r.glad031) THEN  #經營方式不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq051 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq051 = ' '"
          END IF
       END IF
       IF l_glad_r.glad032 = 'N' OR cl_null(l_glad_r.glad032) THEN  #渠道不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq052 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq052 = ' '"
          END IF
       END IF
       IF l_glad_r.glad033 = 'N' OR cl_null(l_glad_r.glad033) THEN  #品牌不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq053 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq053 = ' '"
          END IF
       END IF
       IF l_glad_r.glad017 = 'N' OR cl_null(l_glad_r.glad017) THEN  #自由核算项1不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq029 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq029 = ' '"
          END IF       
       END IF        
       IF l_glad_r.glad018 = 'N' OR cl_null(l_glad_r.glad018) THEN  #自由核算项2不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq030 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq030 = ' '"
          END IF       
       END IF        
       IF l_glad_r.glad019 = 'N' OR cl_null(l_glad_r.glad019) THEN  #自由核算项3不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq031 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq031 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad020 = 'N' OR cl_null(l_glad_r.glad020) THEN  #自由核算项4不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq032 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq032 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad021 = 'N' OR cl_null(l_glad_r.glad021) THEN  #自由核算项5不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq033 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq033 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad022 = 'N' OR cl_null(l_glad_r.glad022) THEN  #自由核算项6不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq034 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq034 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad023 = 'N' OR cl_null(l_glad_r.glad023) THEN  #自由核算项7不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq035 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq035 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad024 = 'N' OR cl_null(l_glad_r.glad024) THEN  #自由核算项8不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq036 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq036 = ' '"
          END IF       
       END IF 
       IF l_glad_r.glad025 = 'N' OR cl_null(l_glad_r.glad025) THEN  #自由核算项9不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq037 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq037 = ' '"
          END IF       
       END IF        
       IF l_glad_r.glad026 = 'N' OR cl_null(l_glad_r.glad026) THEN  #自由核算项10不管理
          IF cl_null(l_upd_field) THEN
             LET l_upd_field = "glaq038 = ' '"
          ELSE
             LET l_upd_field = l_upd_field CLIPPED,",glaq038 = ' '"
          END IF       
       END IF   
       
       IF NOT cl_null(l_upd_field) THEN
          LET l_sql = "UPDATE s_vr_tmp02 SET ",l_upd_field,  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar1_tmp ——> s_vr_tmp02
                      " WHERE glaqld  = '",p_ld CLIPPED,"'",
                      "   AND glaq002 = '",l_glaq002,"'"
          PREPARE s_voucher_gen_ar_5_upd_tmp_p1 FROM l_sql
          IF SQLCA.sqlcode THEN
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = SQLCA.sqlcode
             LET g_errparam.extend = 's_voucher_gen_ar_5_upd_tmp_p1'
             LET g_errparam.popup = TRUE
             CALL cl_err()

             RETURN r_success
          END IF
          EXECUTE s_voucher_gen_ar_5_upd_tmp_p1
          IF SQLCA.sqlcode THEN
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = SQLCA.sqlcode
             LET g_errparam.extend = 'execute s_voucher_gen_ar_5_upd_tmp_p1'
             LET g_errparam.popup = TRUE
             CALL cl_err()
             RETURN r_success
          END IF
       END IF
   END FOREACH
   
   LET r_success = TRUE
   RETURN r_success   
END FUNCTION

################################################################################
# Descriptions...: 明細資料彙總
# Memo...........: #151008-00009#4
# Usage..........: CALLs_voucher_gen_ar_5_ins_group_tmp(p_ld,p_sum_type)
#                  RETURNING l_success
# Input parameter: p_ld           帐套
#                : p_sum_type     汇总方式 
# Return code....: r_success      成功否标识位
# Date & Author..: 160118 By Jessy
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_5_ins_group_tmp(p_ld,p_sum_type)
DEFINE p_ld            LIKE glaa_t.glaald
DEFINE p_sum_type      LIKE type_t.chr1
DEFINE p_wc            LIKE type_t.chr1000
DEFINE r_success       LIKE type_t.num5
#161128-00061#7---add---begin-----------
#DEFINE l_xrca          RECORD LIKE xrca_t.*
DEFINE l_xrca RECORD  #應收憑單單頭
       xrcaent LIKE xrca_t.xrcaent, #企業編號
       xrcaownid LIKE xrca_t.xrcaownid, #資料所有者
       xrcaowndp LIKE xrca_t.xrcaowndp, #資料所屬部門
       xrcacrtid LIKE xrca_t.xrcacrtid, #資料建立者
       xrcacrtdp LIKE xrca_t.xrcacrtdp, #資料建立部門
       xrcacrtdt LIKE xrca_t.xrcacrtdt, #資料創建日
       xrcamodid LIKE xrca_t.xrcamodid, #資料修改者
       xrcamoddt LIKE xrca_t.xrcamoddt, #最近修改日
       xrcacnfid LIKE xrca_t.xrcacnfid, #資料確認者
       xrcacnfdt LIKE xrca_t.xrcacnfdt, #資料確認日
       xrcapstid LIKE xrca_t.xrcapstid, #資料過帳者
       xrcapstdt LIKE xrca_t.xrcapstdt, #資料過帳日
       xrcastus LIKE xrca_t.xrcastus, #狀態碼
       xrcacomp LIKE xrca_t.xrcacomp, #法人
       xrcald LIKE xrca_t.xrcald, #帳套
       xrcadocno LIKE xrca_t.xrcadocno, #應收帳款單號碼
       xrcadocdt LIKE xrca_t.xrcadocdt, #帳款日期
       xrca001 LIKE xrca_t.xrca001, #帳款單性質
       xrcasite LIKE xrca_t.xrcasite, #帳務中心
       xrca003 LIKE xrca_t.xrca003, #帳務人員
       xrca004 LIKE xrca_t.xrca004, #帳款客戶編號
       xrca005 LIKE xrca_t.xrca005, #收款客戶
       xrca006 LIKE xrca_t.xrca006, #客戶分類
       xrca007 LIKE xrca_t.xrca007, #帳款類別
       xrca008 LIKE xrca_t.xrca008, #收款條件編號
       xrca009 LIKE xrca_t.xrca009, #應收款日/應扣抵日
       xrca010 LIKE xrca_t.xrca010, #容許票據到期日
       xrca011 LIKE xrca_t.xrca011, #稅別
       xrca012 LIKE xrca_t.xrca012, #稅率
       xrca013 LIKE xrca_t.xrca013, #含稅否
       xrca014 LIKE xrca_t.xrca014, #人員編號
       xrca015 LIKE xrca_t.xrca015, #部門編號
       xrca016 LIKE xrca_t.xrca016, #來源作業類型
       xrca017 LIKE xrca_t.xrca017, #產生方式
       xrca018 LIKE xrca_t.xrca018, #來源參考單號
       xrca019 LIKE xrca_t.xrca019, #系統產生對應單號(待抵帳款-預收)
       xrca020 LIKE xrca_t.xrca020, #信用狀申請流程否
       xrca021 LIKE xrca_t.xrca021, #商業發票號碼(IV no.)
       xrca022 LIKE xrca_t.xrca022, #出口報單號碼
       xrca023 LIKE xrca_t.xrca023, #發票客戶編號
       xrca024 LIKE xrca_t.xrca024, #發票客戶統一編號
       xrca025 LIKE xrca_t.xrca025, #發票客戶全名
       xrca026 LIKE xrca_t.xrca026, #發票客戶地址
       xrca028 LIKE xrca_t.xrca028, #發票類型
       xrca029 LIKE xrca_t.xrca029, #發票匯率
       xrca030 LIKE xrca_t.xrca030, #發票應開未稅金額
       xrca031 LIKE xrca_t.xrca031, #發票應開稅額
       xrca032 LIKE xrca_t.xrca032, #發票應開含稅金額
       xrca033 LIKE xrca_t.xrca033, #專案編號
       xrca034 LIKE xrca_t.xrca034, #責任中心
       xrca035 LIKE xrca_t.xrca035, #應收(借方)科目編號
       xrca036 LIKE xrca_t.xrca036, #收入(貸方)科目編號
       xrca037 LIKE xrca_t.xrca037, #分錄傳票產生否
       xrca038 LIKE xrca_t.xrca038, #拋轉傳票號碼
       xrca039 LIKE xrca_t.xrca039, #會計檢核附件份數
       xrca040 LIKE xrca_t.xrca040, #留置否
       xrca041 LIKE xrca_t.xrca041, #留置理由碼
       xrca042 LIKE xrca_t.xrca042, #留置設定日期
       xrca043 LIKE xrca_t.xrca043, #留置解除日期
       xrca044 LIKE xrca_t.xrca044, #留置原幣金額
       xrca045 LIKE xrca_t.xrca045, #留置說明
       xrca046 LIKE xrca_t.xrca046, #關係人否
       xrca047 LIKE xrca_t.xrca047, #多角序號
       xrca048 LIKE xrca_t.xrca048, #集團代收/代付單號
       xrca049 LIKE xrca_t.xrca049, #來源營運中心編號
       xrca050 LIKE xrca_t.xrca050, #交易原始單據份數
       xrca051 LIKE xrca_t.xrca051, #作廢理由碼
       xrca052 LIKE xrca_t.xrca052, #列印次數
       xrca053 LIKE xrca_t.xrca053, #備註
       xrca054 LIKE xrca_t.xrca054, #多帳期設定
       xrca055 LIKE xrca_t.xrca055, #繳款優惠條件
       xrca056 LIKE xrca_t.xrca056, #會計檢核附件狀態
       xrca057 LIKE xrca_t.xrca057, #交易對象識別碼
       xrca058 LIKE xrca_t.xrca058, #銷售分類
       xrca059 LIKE xrca_t.xrca059, #預算編號
       xrca060 LIKE xrca_t.xrca060, #發票開立原則
       xrca061 LIKE xrca_t.xrca061, #預計開立發票日期
       xrca062 LIKE xrca_t.xrca062, #多角性質
       xrca063 LIKE xrca_t.xrca063, #整帳批序號
       xrca064 LIKE xrca_t.xrca064, #訂金序次
       xrca065 LIKE xrca_t.xrca065, #發票編號
       xrca066 LIKE xrca_t.xrca066, #發票號碼
       xrca100 LIKE xrca_t.xrca100, #交易原幣別
       xrca101 LIKE xrca_t.xrca101, #原幣匯率
       xrca103 LIKE xrca_t.xrca103, #原幣未稅金額
       xrca104 LIKE xrca_t.xrca104, #原幣稅額
       xrca106 LIKE xrca_t.xrca106, #原幣直接折抵合計金額
       xrca107 LIKE xrca_t.xrca107, #原幣直接沖帳(調整)合計金額
       xrca108 LIKE xrca_t.xrca108, #原幣應收金額
       xrca113 LIKE xrca_t.xrca113, #本幣未稅金額
       xrca114 LIKE xrca_t.xrca114, #本幣稅額
       xrca116 LIKE xrca_t.xrca116, #本幣直接沖帳(調整)合計金額
       xrca117 LIKE xrca_t.xrca117, #本幣直接沖帳(調整)合計金額
       xrca118 LIKE xrca_t.xrca118, #本幣應收金額
       xrca120 LIKE xrca_t.xrca120, #本位幣二幣別
       xrca121 LIKE xrca_t.xrca121, #本位幣二匯率
       xrca123 LIKE xrca_t.xrca123, #本位幣二未稅金額
       xrca124 LIKE xrca_t.xrca124, #本位幣二稅額
       xrca126 LIKE xrca_t.xrca126, #本位幣二直接折抵合計金額
       xrca127 LIKE xrca_t.xrca127, #本位幣二直接沖帳(調整)合計金額
       xrca128 LIKE xrca_t.xrca128, #本位幣二應收金額
       xrca130 LIKE xrca_t.xrca130, #本位幣三幣別
       xrca131 LIKE xrca_t.xrca131, #本位幣三匯率
       xrca133 LIKE xrca_t.xrca133, #本位幣三未稅金額
       xrca134 LIKE xrca_t.xrca134, #本位幣三稅額
       xrca136 LIKE xrca_t.xrca136, #本位幣三直接折抵合計金額
       xrca137 LIKE xrca_t.xrca137, #本位幣三直接沖帳(調整)合計金額
       xrca138 LIKE xrca_t.xrca138, #本位幣三應收金額
       xrcaud001 LIKE xrca_t.xrcaud001, #自定義欄位(文字)001
       xrcaud002 LIKE xrca_t.xrcaud002, #自定義欄位(文字)002
       xrcaud003 LIKE xrca_t.xrcaud003, #自定義欄位(文字)003
       xrcaud004 LIKE xrca_t.xrcaud004, #自定義欄位(文字)004
       xrcaud005 LIKE xrca_t.xrcaud005, #自定義欄位(文字)005
       xrcaud006 LIKE xrca_t.xrcaud006, #自定義欄位(文字)006
       xrcaud007 LIKE xrca_t.xrcaud007, #自定義欄位(文字)007
       xrcaud008 LIKE xrca_t.xrcaud008, #自定義欄位(文字)008
       xrcaud009 LIKE xrca_t.xrcaud009, #自定義欄位(文字)009
       xrcaud010 LIKE xrca_t.xrcaud010, #自定義欄位(文字)010
       xrcaud011 LIKE xrca_t.xrcaud011, #自定義欄位(數字)011
       xrcaud012 LIKE xrca_t.xrcaud012, #自定義欄位(數字)012
       xrcaud013 LIKE xrca_t.xrcaud013, #自定義欄位(數字)013
       xrcaud014 LIKE xrca_t.xrcaud014, #自定義欄位(數字)014
       xrcaud015 LIKE xrca_t.xrcaud015, #自定義欄位(數字)015
       xrcaud016 LIKE xrca_t.xrcaud016, #自定義欄位(數字)016
       xrcaud017 LIKE xrca_t.xrcaud017, #自定義欄位(數字)017
       xrcaud018 LIKE xrca_t.xrcaud018, #自定義欄位(數字)018
       xrcaud019 LIKE xrca_t.xrcaud019, #自定義欄位(數字)019
       xrcaud020 LIKE xrca_t.xrcaud020, #自定義欄位(數字)020
       xrcaud021 LIKE xrca_t.xrcaud021, #自定義欄位(日期時間)021
       xrcaud022 LIKE xrca_t.xrcaud022, #自定義欄位(日期時間)022
       xrcaud023 LIKE xrca_t.xrcaud023, #自定義欄位(日期時間)023
       xrcaud024 LIKE xrca_t.xrcaud024, #自定義欄位(日期時間)024
       xrcaud025 LIKE xrca_t.xrcaud025, #自定義欄位(日期時間)025
       xrcaud026 LIKE xrca_t.xrcaud026, #自定義欄位(日期時間)026
       xrcaud027 LIKE xrca_t.xrcaud027, #自定義欄位(日期時間)027
       xrcaud028 LIKE xrca_t.xrcaud028, #自定義欄位(日期時間)028
       xrcaud029 LIKE xrca_t.xrcaud029, #自定義欄位(日期時間)029
       xrcaud030 LIKE xrca_t.xrcaud030  #自定義欄位(日期時間)030
       END RECORD

   #161128-00061#7---add--end-------------
DEFINE l_success       LIKE type_t.num5
DEFINE l_ac            LIKE type_t.num5
DEFINE l_docno         LIKE glaq_t.glaqdocno
DEFINE l_glaq002       LIKE glaq_t.glaq002
DEFINE l_field         LIKE type_t.chr1000
DEFINE l_field1        LIKE type_t.chr1000
DEFINE l_field2        LIKE type_t.chr1000
DEFINE l_field3        LIKE type_t.chr1000
DEFINE l_field4        LIKE type_t.chr1000
DEFINE l_field5        LIKE type_t.chr1000
DEFINE l_group_field   LIKE type_t.chr1000
DEFINE l_glad_r        RECORD
                       glad005   LIKE glad_t.glad005,  #数量/金额管理否
                       glad007   LIKE glad_t.glad007,  #部门管理否
                       glad008   LIKE glad_t.glad008,  #利润成本管理否
                       glad009   LIKE glad_t.glad009,  #区域管理否
                       glad010   LIKE glad_t.glad010,  #客商管理否
                       glad011   LIKE glad_t.glad011,  #客群管理否
                       glad012   LIKE glad_t.glad012,  #产品类别管理否
                       glad013   LIKE glad_t.glad013,  #人员管理否
                       glad014   LIKE glad_t.glad014,  #预算管理否
                       glad015   LIKE glad_t.glad015,  #专案管理否
                       glad016   LIKE glad_t.glad016,  #WBS管理否
                       glad017   LIKE glad_t.glad017,  #自由核算项1管理否
                       glad018   LIKE glad_t.glad018,  #自由核算项2管理否
                       glad019   LIKE glad_t.glad019,  #自由核算项3管理否
                       glad020   LIKE glad_t.glad020,  #自由核算项4管理否
                       glad021   LIKE glad_t.glad021,  #自由核算项5管理否
                       glad022   LIKE glad_t.glad022,  #自由核算项6管理否
                       glad023   LIKE glad_t.glad023,  #自由核算项7管理否
                       glad024   LIKE glad_t.glad024,  #自由核算项8管理否
                       glad025   LIKE glad_t.glad025,  #自由核算项9管理否
                       glad026   LIKE glad_t.glad026,  #自由核算项10管理否
                       glad031   LIKE glad_t.glad031,  #經營方式管理否
                       glad032   LIKE glad_t.glad032,  #渠道管理否
                       glad033   LIKE glad_t.glad033   #品牌管理否
                       END RECORD
DEFINE l_glgb055       LIKE glgb_t.glgb055
   
   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE
   
   #1.定义CURSOR
   CALL s_voucher_gen_ar_5_def_cursor(p_ld,'',p_sum_type,'','') RETURNING l_success  
   IF NOT l_success THEN
      RETURN r_success
   END IF
   
   LET l_ac = 1
   FOREACH s_voucher_gen_ar_5_cs3 INTO l_docno,l_glaq002
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach s_voucher_gen_ar_5_cs3'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      
      INITIALIZE l_glad_r TO NULL
      
      EXECUTE s_voucher_gen_ar_5_cs4 USING l_glaq002 INTO l_glad_r.*
      
      LET l_group_field = NULL
      
      LET l_group_field = ",glaq017"  #核算组织
      
      IF l_glad_r.glad007 = 'Y' THEN  #部门管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq018"
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq018"
         END IF
      END IF
      IF l_glad_r.glad008 = 'Y' THEN  #利润成本管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq019"
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq019"
         END IF
      END IF
      IF l_glad_r.glad009 = 'Y' THEN  #区域管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq020"
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq020 "
         END IF
      END IF
      IF l_glad_r.glad011 = 'Y' THEN  #客群管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq023 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq023 "
         END IF
      END IF
      IF l_glad_r.glad012 = 'Y' THEN  #产品类别管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq024 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq024 "
         END IF
      END IF
      IF l_glad_r.glad013 = 'Y' THEN  #人员管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq025 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq025"
         END IF
      END IF
      IF l_glad_r.glad015 = 'Y' THEN  #专案管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq027 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq027 "
         END IF
      END IF
      IF l_glad_r.glad016 = 'Y' THEN  #WBS管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq028 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq028 "
         END IF
      END IF
      IF l_glad_r.glad031 = 'Y' THEN  #經營方式管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq051 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq051 "
         END IF
      END IF
      IF l_glad_r.glad032 = 'Y' THEN  #經營方式管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq052 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq052 "
         END IF
      END IF
      IF l_glad_r.glad033 = 'Y' THEN  #經營方式管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq053 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq053 "
         END IF
      END IF
      IF l_glad_r.glad017 = 'Y' THEN  #自由核算项1
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq029 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq029 "
         END IF
      END IF
      IF l_glad_r.glad018 = 'Y' THEN  #自由核算项2
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq030 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq030 "
         END IF
      END IF
      IF l_glad_r.glad019 = 'Y' THEN  #自由核算项3
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq031 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq031 "
         END IF
      END IF
      IF l_glad_r.glad020 = 'Y' THEN  #自由核算项4
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq032 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq032 "
         END IF
      END IF
      IF l_glad_r.glad021 = 'Y' THEN  #自由核算项5
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq033 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq033 "
         END IF
      END IF
      IF l_glad_r.glad022 = 'Y' THEN  #自由核算项6
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq034 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq034 "
         END IF
      END IF
      IF l_glad_r.glad023 = 'Y' THEN  #自由核算项7
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq035 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq035 "
         END IF
      END IF
      IF l_glad_r.glad024 = 'Y' THEN  #自由核算项8
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq036 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq036 "
         END IF
      END IF
      IF l_glad_r.glad025 = 'Y' THEN  #自由核算项9
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq037 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq037 "
         END IF
      END IF
      IF l_glad_r.glad026 = 'Y' THEN  #自由核算项10
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq038 "
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq038 "
         END IF
      END IF
      IF l_glad_r.glad005 = 'Y' THEN  #数量/金额管理
         IF cl_null(l_group_field) THEN
            LET l_group_field = ",glaq007"
         ELSE
            LET l_group_field = l_group_field CLIPPED,",glaq007"
         END IF
      END IF
      
      LET l_field = NULL
      LET l_field1 = NULL
      LET l_field2 = NULL
      LET l_field3 = NULL
      LET l_field4 = NULL
      LET l_field5 = NULL
      
      LET l_field = "glaq017"    #核算组织
      
      IF l_glad_r.glad007 = 'Y' THEN  #部门管理
         IF cl_null(l_field) THEN
            LET l_field = "glaq018"
         ELSE
            LET l_field = l_field CLIPPED,",glaq018"
         END IF
      ELSE
         IF cl_null(l_field) THEN
            LET l_field = "''"
         ELSE
            LET l_field = l_field CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad008 = 'Y' THEN  #利润成本管理
         IF cl_null(l_field) THEN
            LET l_field = "glaq019"
         ELSE
            LET l_field = l_field CLIPPED,",glaq019"
         END IF
      ELSE
         IF cl_null(l_field) THEN
            LET l_field = "''"
         ELSE
            LET l_field = l_field CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad009 = 'Y' THEN  #区域管理
         IF cl_null(l_field) THEN
            LET l_field = "glaq020"
         ELSE
            LET l_field = l_field CLIPPED,",glaq020 "
         END IF
      ELSE
         IF cl_null(l_field) THEN
            LET l_field = "''"
         ELSE
            LET l_field = l_field CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad011 = 'Y' THEN  #客群管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq023 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq023 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad012 = 'Y' THEN  #产品类别管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq024 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq024 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad013 = 'Y' THEN  #人员管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq025 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq025"
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad015 = 'Y' THEN  #专案管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq027 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq027 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad016 = 'Y' THEN  #WBS管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq028 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq028 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad031 = 'Y' THEN  #經營方式管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq051 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq051 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad032 = 'Y' THEN  #渠道管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq052 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq052 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad033 = 'Y' THEN  #品牌管理
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq053 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq053 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad017 = 'Y' THEN  #自由核算项1
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq029 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq029 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad018 = 'Y' THEN  #自由核算项2
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq030 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq030 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad019 = 'Y' THEN  #自由核算项3
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq031 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq031 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad020 = 'Y' THEN  #自由核算项4
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq032 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq032 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad021 = 'Y' THEN  #自由核算项5
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq033 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq033 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad022 = 'Y' THEN  #自由核算项6
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq034 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq034 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad023 = 'Y' THEN  #自由核算项7
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq035 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq035 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad024 = 'Y' THEN  #自由核算项8
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq036 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq036 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad025 = 'Y' THEN  #自由核算项9
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq037 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq037 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad026 = 'Y' THEN  #自由核算项10
         IF cl_null(l_field3) THEN
            LET l_field3 = "glaq038 "
         ELSE
            LET l_field3 = l_field3 CLIPPED,",glaq038 "
         END IF
      ELSE
         IF cl_null(l_field3) THEN
            LET l_field3 = "''"
         ELSE
            LET l_field3 = l_field3 CLIPPED,",''"
         END IF
      END IF
      IF l_glad_r.glad005 = 'Y' THEN  #数量/金额管理
         IF cl_null(l_field1) THEN
            LET l_field1 = "glaq007"
         ELSE
            LET l_field1 = l_field1 CLIPPED,",glaq007"
         END IF
         IF cl_null(l_field2) THEN
            LET l_field2 = "SUM(qty)"
         ELSE
            LET l_field2 = l_field2 CLIPPED,",SUM(qty)"
         END IF
      ELSE
         IF cl_null(l_field1) THEN
            LET l_field1 = "''"
         ELSE
            LET l_field1 = l_field1 CLIPPED,",''"
         END IF
         IF cl_null(l_field2) THEN
            LET l_field2 = "''"
         ELSE
            LET l_field2 = l_field2 CLIPPED,",''"
         END IF
      END IF
      IF NOT cl_null(l_glaq002) THEN
         LET l_field4 = " glaq002 = '",l_glaq002,"'"
      ELSE
         LET l_field4 = " glaq002 IS NULL"
      END IF
      IF p_sum_type = '1' THEN
         LET g_sql = "SELECT docno,docdt,'',glaqent,glaqcomp,'',glaq001,glaq002,glaq005,",
                     "       glaq006,",l_field1 CLIPPED,",",
                     "       '','','','','','','',",l_field CLIPPED,",",
                     "       '','',",l_field3 CLIPPED,",", 
                     "       SUM(d),SUM(c),",l_field2 CLIPPED,",",
                     "       SUM(glaq010),glaq039,SUM(glaq040),SUM(glaq041),",
                     "       glaq042,SUM(glaq043),SUM(glaq044),'','','',glgb055",
                     "  FROM s_vr_tmp02 ",  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar1_tmp ——> s_vr_tmp02
                     " WHERE docno = '",l_docno,"'",
                     "   AND ",l_field4,
                     " GROUP BY docno,docdt,glaqent,glaqcomp,glaq001,glaq002,glaq005,glaq006,glaq039,glaq042",l_group_field,",glgb055"
      END IF
      PREPARE s_voucher_gen_ar_p1 FROM g_sql
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_ar_p1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      DECLARE s_voucher_gen_ar_cs1 CURSOR FOR s_voucher_gen_ar_p1
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_ar_cs1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF
      
      FOREACH s_voucher_gen_ar_cs1 INTO g_glaq3_d[l_ac].*
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = 'foreach s_voucher_gen_ar_cs1'
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN r_success
         END IF
         INSERT INTO s_vr_tmp03 VALUES(g_glaq3_d[l_ac].*)  #160727-00019#35   16/08/11 By 08734 临时表长度超过15码的减少到15码以下 s_voucher_ar1_gro ——> s_vr_tmp03
         LET l_ac = l_ac + 1
      END FOREACH
      CALL g_glaq3_d.deleteElement(l_ac)
   
   END FOREACH
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 自动生成凭证 - 产生凭证单头
# Memo...........: #151008-00009#4
# Usage..........: CALL s_voucher_gen_ar_5_ins_glap(p_slip,p_date,p_ld,p_source)
#                       RETURNING r_success,r_start_no,r_end_no
# Input parameter: p_slip         凭证单别
#                : p_date         傳票日期
#                : p_ld           帳套
#                : p_source       來源
# Return code....: r_success      成功否标识位
#                : r_start_no     生成的起始凭证单号
#                : r_end_no       生成的截止凭证单号
# Date & Author..: 160118 By Jessy
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_5_ins_glap(p_slip,p_date,p_ld,p_source)
DEFINE p_slip           LIKE ooba_t.ooba002
DEFINE p_ld             LIKE glaa_t.glaald
DEFINE p_sum_type       LIKE type_t.chr1
DEFINE p_source         LIKE type_t.chr10
DEFINE p_date           LIKE glap_t.glapdocdt
DEFINE r_success        LIKE type_t.num5
DEFINE r_start_no       LIKE glap_t.glapdocno
DEFINE r_end_no         LIKE glap_t.glapdocno
 #161128-00061#7---add---begin-----------
   #DEFINE l_glap          RECORD LIKE glap_t.*
   DEFINE l_glap RECORD  #傳票憑證單頭檔
       glapent LIKE glap_t.glapent, #企業編號
       glapld LIKE glap_t.glapld, #帳套
       glapcomp LIKE glap_t.glapcomp, #法人
       glapdocno LIKE glap_t.glapdocno, #單號
       glapdocdt LIKE glap_t.glapdocdt, #單據日期
       glap001 LIKE glap_t.glap001, #傳票性質
       glap002 LIKE glap_t.glap002, #會計年度
       glap003 LIKE glap_t.glap003, #會計季別
       glap004 LIKE glap_t.glap004, #會計期別
       glap005 LIKE glap_t.glap005, #會計周別
       glap006 LIKE glap_t.glap006, #收支科目
       glap007 LIKE glap_t.glap007, #來源碼
       glap008 LIKE glap_t.glap008, #帳款類型
       glap009 LIKE glap_t.glap009, #總號
       glap010 LIKE glap_t.glap010, #借方總金額
       glap011 LIKE glap_t.glap011, #貸方總金額
       glap012 LIKE glap_t.glap012, #列印次數
       glap013 LIKE glap_t.glap013, #附件張數
       glap014 LIKE glap_t.glap014, #外幣憑證否
       glap015 LIKE glap_t.glap015, #原傳票編號
       glap016 LIKE glap_t.glap016, #來源帳套編號
       glap017 LIKE glap_t.glap017, #來源傳票編號
       glapownid LIKE glap_t.glapownid, #資料所有者
       glapowndp LIKE glap_t.glapowndp, #資料所屬部門
       glapcrtid LIKE glap_t.glapcrtid, #資料建立者
       glapcrtdp LIKE glap_t.glapcrtdp, #資料建立部門
       glapcrtdt LIKE glap_t.glapcrtdt, #資料創建日
       glapmodid LIKE glap_t.glapmodid, #資料修改者
       glapmoddt LIKE glap_t.glapmoddt, #最近修改日
       glapcnfid LIKE glap_t.glapcnfid, #資料確認者
       glapcnfdt LIKE glap_t.glapcnfdt, #資料確認日
       glappstid LIKE glap_t.glappstid, #資料過帳者
       glappstdt LIKE glap_t.glappstdt, #資料過帳日
       glapstus LIKE glap_t.glapstus, #狀態碼
       glapud001 LIKE glap_t.glapud001, #自定義欄位(文字)001
       glapud002 LIKE glap_t.glapud002, #自定義欄位(文字)002
       glapud003 LIKE glap_t.glapud003, #自定義欄位(文字)003
       glapud004 LIKE glap_t.glapud004, #自定義欄位(文字)004
       glapud005 LIKE glap_t.glapud005, #自定義欄位(文字)005
       glapud006 LIKE glap_t.glapud006, #自定義欄位(文字)006
       glapud007 LIKE glap_t.glapud007, #自定義欄位(文字)007
       glapud008 LIKE glap_t.glapud008, #自定義欄位(文字)008
       glapud009 LIKE glap_t.glapud009, #自定義欄位(文字)009
       glapud010 LIKE glap_t.glapud010, #自定義欄位(文字)010
       glapud011 LIKE glap_t.glapud011, #自定義欄位(數字)011
       glapud012 LIKE glap_t.glapud012, #自定義欄位(數字)012
       glapud013 LIKE glap_t.glapud013, #自定義欄位(數字)013
       glapud014 LIKE glap_t.glapud014, #自定義欄位(數字)014
       glapud015 LIKE glap_t.glapud015, #自定義欄位(數字)015
       glapud016 LIKE glap_t.glapud016, #自定義欄位(數字)016
       glapud017 LIKE glap_t.glapud017, #自定義欄位(數字)017
       glapud018 LIKE glap_t.glapud018, #自定義欄位(數字)018
       glapud019 LIKE glap_t.glapud019, #自定義欄位(數字)019
       glapud020 LIKE glap_t.glapud020, #自定義欄位(數字)020
       glapud021 LIKE glap_t.glapud021, #自定義欄位(日期時間)021
       glapud022 LIKE glap_t.glapud022, #自定義欄位(日期時間)022
       glapud023 LIKE glap_t.glapud023, #自定義欄位(日期時間)023
       glapud024 LIKE glap_t.glapud024, #自定義欄位(日期時間)024
       glapud025 LIKE glap_t.glapud025, #自定義欄位(日期時間)025
       glapud026 LIKE glap_t.glapud026, #自定義欄位(日期時間)026
       glapud027 LIKE glap_t.glapud027, #自定義欄位(日期時間)027
       glapud028 LIKE glap_t.glapud028, #自定義欄位(日期時間)028
       glapud029 LIKE glap_t.glapud029, #自定義欄位(日期時間)029
       glapud030 LIKE glap_t.glapud030  #自定義欄位(日期時間)030
       END RECORD

   #161128-00061#7---add---end-----------
DEFINE l_glaqent        LIKE glaq_t.glaqent
DEFINE l_glaqld         LIKE glaq_t.glaqld
DEFINE l_glaqcomp       LIKE glaq_t.glaqcomp
DEFINE l_docno          LIKE glap_t.glapdocno
DEFINE l_docdt          LIKE glap_t.glapdocdt
DEFINE l_glaq021        LIKE glaq_t.glaq021
DEFINE l_success        LIKE type_t.num5
DEFINE l_ooef008        LIKE ooef_t.ooef008
DEFINE l_ooef010        LIKE ooef_t.ooef010
DEFINE l_glaa001        LIKE glaa_t.glaa001
DEFINE l_xreq100        LIKE xreq_t.xreq100  #幣別 
DEFINE l_sql            STRING
DEFINE l_cnt            LIKE type_t.num5
DEFINE l_date           LIKE glap_t.glapdocdt
DEFINE l_prog           LIKE type_t.chr10
DEFINE l_glca002        LIKE glca_t.glca002
DEFINE l_glaq003        LIKE glaq_t.glaq003  #借方金額
DEFINE l_glaq004        LIKE glaq_t.glaq004  #貸方金額
DEFINE l_glaa024        LIKE glaa_t.glaa024
DEFINE l_glaa100        LIKE glaa_t.glaa100
DEFINE l_glaa102        LIKE glaa_t.glaa102
DEFINE l_glap007        LIKE glap_t.glap007 
   
   WHENEVER ERROR CONTINUE
   LET r_success  = FALSE
   LET r_start_no = NULL
   LET r_end_no   = NULL
   

   LET l_prog = 'aglt310'
   LET l_glap007 = 'AR'
   
   #1.定义CURSOR
   CALL s_voucher_gen_ar_5_def_cursor(p_ld,'','','',p_source) RETURNING l_success 
   IF NOT l_success THEN
      RETURN r_success,r_start_no,r_end_no  
   END IF

   SELECT glaa100,glaa024,glaa102 INTO l_glaa100,l_glaa024,l_glaa102 FROM glaa_t WHERE glaaent = g_enterprise AND glaald = p_ld
   
   IF l_glaa100 = 'Y' THEN
      #161207-00051#1--mark--str--lujh
      #DELETE FROM s_fin_tmp  #160727-00019#31  2016/08/10  By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
      #CALL s_fin_continue_no_ins(p_ld,l_glaa024,p_slip,p_date,'3') RETURNING g_sub_success,g_errno
      #161207-00051#1--mark--str--lujh 
       
      DELETE FROM s_fin_tmp  #160727-00019#31  2016/08/10  By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
      IF NOT cl_null(p_date) THEN   #彙總類型是3的 p_date必傳
         CALL s_fin_continue_no_ins(p_ld,l_glaa024,p_slip,p_date,'3') RETURNING g_sub_success,g_errno
      ELSE
         LET l_sql = " SELECT DISTINCT docdt FROM s_vr_tmp02  "   #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar1_tmp ——> s_vr_tmp02
         PREPARE continue_no_ar_pb1 FROM l_sql
         DECLARE continue_no_ar_cs1 CURSOR FOR continue_no_ar_pb1
         FOREACH continue_no_ar_cs1 INTO l_date
            CALL s_fin_continue_no_ins(p_ld,l_glaa024,p_slip,l_date,'3') RETURNING g_sub_success,g_errno
         END FOREACH
      END IF
   END IF
   LET l_sql = " SELECT docno FROM s_fin_tmp WHERE isuse = 'N' ORDER BY docno"  #160727-00019#31  2016/08/10  By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
   PREPARE continue_no_ar_pb2 FROM l_sql
   DECLARE continue_no_ar_cs2 CURSOR FOR continue_no_ar_pb2
   
   #若p_date不为空时,则表示凭证日期均为p_date
   IF NOT cl_null(p_date) THEN
      UPDATE s_vr_tmp02 SET docdt = p_date  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar1_tmp ——> s_vr_tmp02
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'update docdt'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success,r_start_no,r_end_no  
      END IF
   END IF
  
   #會計科目不可為空
   #LET l_sql = "SELECT COUNT(*) FROM s_vr_tmp02 ",  #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar1_tmp ——> s_vr_tmp02 #170615-00061#25 mark
   LET l_sql = "SELECT COUNT(1) FROM s_vr_tmp02 ",   #170615-00061#25 add
               " WHERE glaq002 IS NULL"
   PREPARE chk_glaq002_p1 FROM l_sql
   EXECUTE chk_glaq002_p1 INTO l_cnt
   IF l_cnt > 0 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code   = 'axr-00068'
      LET g_errparam.extend = ''
      CALL cl_err()
      RETURN r_success,r_start_no,r_end_no
   END IF
   
   SELECT SUM(CASE WHEN c IS NULL THEN 0 ELSE c END),
          SUM(CASE WHEN d IS NULL THEN 0 ELSE d END)
     INTO l_glaq003,l_glaq004
     FROM s_vr_tmp02   #160727-00019#35   16/08/11 By 08734    临时表长度超过15码的减少到15码以下 s_voucher_ar1_tmp ——> s_vr_tmp02
   #借貸金額
   IF cl_null(l_glaq003) THEN LET l_glaq003 = 0  END IF
   IF cl_null(l_glaq004) THEN LET l_glaq004 = 0  END IF
   IF NOT (l_glaq003 > 0) THEN   #借方金額不可為0或為負數
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code   = 'aap-00076'
      LET g_errparam.extend = ''
      CALL cl_err()
      RETURN r_success,r_start_no,r_end_no
   END IF
   IF NOT (l_glaq004 > 0) THEN   #貸方金額不可為0或為負數
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code   = 'aap-00076'
      LET g_errparam.extend = ''
      CALL cl_err()
      RETURN r_success,r_start_no,r_end_no
   END IF
   IF l_glaq003 <> l_glaq004 THEN   #依據借貸不平衡時,若為 1.不能拋 2.拋過去由總帳修改
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code   = 'agl-00250'
      LET g_errparam.extend = ''
      CALL cl_err()
      IF l_glaa102 = '1' THEN 
         RETURN r_success,r_start_no,r_end_no
      END IF
   END IF
   
   FOREACH s_voucher_gen_ar_5_cs5 INTO l_glaqcomp,l_docno,l_docdt
      IF SQLCA.sqlcode THEN  
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_ar_5_cs5'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success,r_start_no,r_end_no
      END IF
      
      INITIALIZE l_glap.* TO NULL
      SELECT ooef008,ooef010 INTO l_ooef008,l_ooef010 FROM ooef_t
       WHERE ooefent = g_enterprise
         AND ooef001 = l_glaqcomp
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'sel ooef'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         LET r_start_no = NULL
         LET r_end_no   = NULL
         RETURN r_success,r_start_no,r_end_no
      END IF
      
      #帳套主幣別
      SELECT glaa001 INTO l_glaa001 
        FROM glaa_t
       WHERE glaaent = g_enterprise
         AND glaald = p_ld
      
      #原幣幣別
      IF p_source = 'axrt470' THEN
         SELECT DISTINCT xreq100 INTO l_xreq100  
           FROM xreq_t 
          WHERE xreqent = g_enterprise  AND xreqdocno = l_docno  AND xreqld = p_ld
      END IF

      #自动编号
      #凭证日期没有值,按单据日期来
      IF cl_null(p_date) THEN 
         LET l_glap.glapdocdt = l_docdt     # 單據日期
      ELSE
         LET l_glap.glapdocdt = p_date      # 單據日期
      END IF
      #SELECT count(*) INTO l_cnt #170615-00061#25 mark
      SELECT count(1) INTO l_cnt  #170615-00061#25 add
        FROM s_fin_tmp  #160727-00019#31  2016/08/10  By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
       WHERE isuse = 'N'
      IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
      IF l_cnt > 0 THEN
         FOREACH continue_no_fm_cs2 INTO l_glap.glapdocno
            UPDATE s_fin_tmp  #160727-00019#31  2016/08/10  By 08734    临时表长度超过15码的减少到15码以下 s_fin_tmp_conti_no ——> s_fin_tmp
               SET isuse = 'Y'
             WHERE docno = l_glap.glapdocno
            #檢查是否號碼已被使用
            #SELECT count(*) INTO l_cnt        #170615-00061#25 mark
            SELECT count(glapdocno) INTO l_cnt #170615-00061#25 add
              FROM glap_t
             WHERE glapent = g_enterprise AND glapld = p_ld
               AND glapdocno=l_glap.glapdocno
            IF l_cnt = 0 THEN
               EXIT FOREACH
            END IF
         END FOREACH
         #假設整個單號都已被取用還是透過s_aooi200_fin_gen_docno取單號
         IF l_cnt > 0 THEN
            CALL s_aooi200_fin_gen_docno(p_ld,'','',p_slip,l_glap.glapdocdt,l_prog) RETURNING g_sub_success,l_glap.glapdocno
         END IF
      ELSE
         CALL s_aooi200_fin_gen_docno(p_ld,'','',p_slip,l_glap.glapdocdt,l_prog) RETURNING g_sub_success,l_glap.glapdocno
      END IF      
      
      #处理起始单号,截止单号
      IF cl_null(r_start_no) THEN LET r_start_no = l_glap.glapdocno END IF
      LET r_end_no   = l_glap.glapdocno 
      
      LET l_glap.glapent   =  g_enterprise  # 企業代碼
      LET l_glap.glapld    =  p_ld          # 帳別
      LET l_glap.glapcomp  =  l_glaqcomp    # 法人
      LET l_glap.glapdocdt =  l_docdt       # 單據日期
      LET l_glap.glap001   = '1'            # 傳票性質
      
      # 會計年度/會計期別/會計季別/會計周別
      SELECT oogc015,oogc006,oogc007,oogc008 INTO l_glap.glap002,l_glap.glap004,l_glap.glap003,l_glap.glap005
        FROM oogc_t
       WHERE oogcent = g_enterprise
         AND oogc001 = l_ooef008
         AND oogc002 = l_ooef010
         AND oogc003 = l_glap.glapdocdt
      
      LET l_glap.glap006   =  ''         # 收支科目
      LET l_glap.glap007   =  l_glap007  # 來源碼  
      #帳款類型
      CASE p_source
         WHEN 'axrt470'
            LET l_glap.glap008  = 'R70'
         OTHERWISE
            LET l_glap.glap008  = p_source
      END CASE
      LET l_glap.glap009   =  0          # 總號
      LET l_glap.glap010   =  0          # 借方總金額
      LET l_glap.glap011   =  0          # 貸方總金額
      LET l_glap.glap012   =  0          # 列印次數
      IF l_glaa001 = l_xreq100 THEN    #幣別 
         LET l_glap.glap014   =  'N'        # 外幣憑證否
      ELSE
         LET l_glap.glap014   =  'Y'        # 外幣憑證否
      END IF
      LET l_glap.glap015   =  ''         # 原傳票編號
      LET l_glap.glap016   =  ''         # 來源帳別編號
      LET l_glap.glap017   =  ''         # 來源傳票編號
      LET l_glap.glapownid =  g_user     # 資料所有者
      LET l_glap.glapowndp =  g_dept     # 資料所屬部門
      LET l_glap.glapcrtid =  g_user     # 資料建立者
      LET l_glap.glapcrtdp =  g_dept     # 資料建立部門
      LET l_glap.glapcrtdt =  cl_get_current()  # 資料創建日
      LET l_glap.glapmodid =  ''         # 資料修改者
      LET l_glap.glapmoddt =  ''         # 最近修改日
      LET l_glap.glapcnfid =  ''         # 資料確認者
      LET l_glap.glapcnfdt =  ''         # 資料確認日
      LET l_glap.glappstid =  ''         # 資料過帳者
      LET l_glap.glappstdt =  ''         # 資料過帳日
      LET l_glap.glapstus  =  'N'        # 狀態碼

      #161128-00061#7---add---begin-----------
      #INSERT INTO glap_t VALUES(l_glap.*)
      INSERT INTO glap_t (glapent,glapld,glapcomp,glapdocno,glapdocdt,glap001,glap002,glap003,glap004,
                          glap005,glap006,glap007,glap008,glap009,glap010,glap011,glap012,glap013,glap014,
                          glap015,glap016,glap017,glapownid,glapowndp,glapcrtid,glapcrtdp,glapcrtdt,
                          glapmodid,glapmoddt,glapcnfid,glapcnfdt,glappstid,glappstdt,glapstus,
                          glapud001,glapud002,glapud003,glapud004,glapud005,glapud006,glapud007,glapud008,
                          glapud009,glapud010,glapud011,glapud012,glapud013,glapud014,glapud015,glapud016,
                          glapud017,glapud018,glapud019,glapud020,glapud021,glapud022,glapud023,glapud024,
                          glapud025,glapud026,glapud027,glapud028,glapud029,glapud030)
       VALUES(l_glap.glapent,l_glap.glapld,l_glap.glapcomp,l_glap.glapdocno,l_glap.glapdocdt,l_glap.glap001,l_glap.glap002,l_glap.glap003,l_glap.glap004,
              l_glap.glap005,l_glap.glap006,l_glap.glap007,l_glap.glap008,l_glap.glap009,l_glap.glap010,l_glap.glap011,l_glap.glap012,l_glap.glap013,l_glap.glap014,
              l_glap.glap015,l_glap.glap016,l_glap.glap017,l_glap.glapownid,l_glap.glapowndp,l_glap.glapcrtid,l_glap.glapcrtdp,l_glap.glapcrtdt,
              l_glap.glapmodid,l_glap.glapmoddt,l_glap.glapcnfid,l_glap.glapcnfdt,l_glap.glappstid,l_glap.glappstdt,l_glap.glapstus,
              l_glap.glapud001,l_glap.glapud002,l_glap.glapud003,l_glap.glapud004,l_glap.glapud005,l_glap.glapud006,l_glap.glapud007,l_glap.glapud008,
              l_glap.glapud009,l_glap.glapud010,l_glap.glapud011,l_glap.glapud012,l_glap.glapud013,l_glap.glapud014,l_glap.glapud015,l_glap.glapud016,
              l_glap.glapud017,l_glap.glapud018,l_glap.glapud019,l_glap.glapud020,l_glap.glapud021,l_glap.glapud022,l_glap.glapud023,l_glap.glapud024,
              l_glap.glapud025,l_glap.glapud026,l_glap.glapud027,l_glap.glapud028,l_glap.glapud029,l_glap.glapud030)
      #161128-00061#7---add---end-----------
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'ins glap'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         LET r_start_no = NULL
         LET r_end_no   = NULL
         RETURN r_success,r_start_no,r_end_no         
      END IF
      
      #产生凭证单身
      CALL s_voucher_gen_ar_5_ins_glaq(l_glap.glapdocno,p_ld,l_glaqcomp,l_docno,l_docdt) 
           RETURNING l_success 
      IF NOT l_success THEN
         LET r_start_no = NULL
         LET r_end_no   = NULL
         RETURN r_success,r_start_no,r_end_no           
      END IF
  
   END FOREACH
   
   LET r_success = TRUE
   RETURN r_success,r_start_no,r_end_no
END FUNCTION

################################################################################
# Descriptions...: 自动生成凭证 - 产生凭证單身
# Memo...........: #151008-00009#4
# Usage..........: CALL s_voucher_gen_ar_5_ins_glaq(p_glapdocno,p_glaqld,p_glaqcomp,p_docno,p_docdt)
# Input parameter: p_glapdocno    凭证单号
#                : p_glaqent      企业编号
#                : p_glaqld       帐套
#                : p_glaqcomp     公司编号
#                : p_docno        来源单号
#                : p_docdt        凭证日期
# Return code....: r_success      成功否标识位
# Date & Author..: 160118 By Jessy
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_gen_ar_5_ins_glaq(p_glapdocno,p_glaqld,p_glaqcomp,p_docno,p_docdt)
DEFINE p_sum_type          LIKE type_t.chr1
DEFINE p_glapdocno         LIKE glap_t.glapdocno
DEFINE p_glaqent           LIKE glaq_t.glaqent
DEFINE p_glaqld            LIKE glaq_t.glaqld
DEFINE p_glaqcomp          LIKE glaq_t.glaqcomp
DEFINE p_docno             LIKE glaq_t.glaqdocno
DEFINE p_docdt             LIKE glap_t.glapdocdt
DEFINE p_glaq021           LIKE glaq_t.glaq021
DEFINE r_success           LIKE type_t.num5
DEFINE l_value             LIKE type_t.chr50
#161128-00061#7---add---begin-----------
   #DEFINE l_glaq              RECORD LIKE glaq_t.*
   DEFINE l_glaq RECORD  #傳票憑證單身檔
       glaqent LIKE glaq_t.glaqent, #企業編號
       glaqcomp LIKE glaq_t.glaqcomp, #法人
       glaqld LIKE glaq_t.glaqld, #帳套
       glaqdocno LIKE glaq_t.glaqdocno, #單號
       glaqseq LIKE glaq_t.glaqseq, #項次
       glaq001 LIKE glaq_t.glaq001, #摘要
       glaq002 LIKE glaq_t.glaq002, #科目編號
       glaq003 LIKE glaq_t.glaq003, #借方金額
       glaq004 LIKE glaq_t.glaq004, #貸方金額
       glaq005 LIKE glaq_t.glaq005, #交易幣別
       glaq006 LIKE glaq_t.glaq006, #匯率
       glaq007 LIKE glaq_t.glaq007, #計價單位
       glaq008 LIKE glaq_t.glaq008, #數量
       glaq009 LIKE glaq_t.glaq009, #單價
       glaq010 LIKE glaq_t.glaq010, #原幣金額
       glaq011 LIKE glaq_t.glaq011, #票據編碼
       glaq012 LIKE glaq_t.glaq012, #票據日期
       glaq013 LIKE glaq_t.glaq013, #申請人
       glaq014 LIKE glaq_t.glaq014, #銀行帳號
       glaq015 LIKE glaq_t.glaq015, #款別編號
       glaq016 LIKE glaq_t.glaq016, #收支專案
       glaq017 LIKE glaq_t.glaq017, #營運據點
       glaq018 LIKE glaq_t.glaq018, #部門
       glaq019 LIKE glaq_t.glaq019, #利潤/成本中心
       glaq020 LIKE glaq_t.glaq020, #區域
       glaq021 LIKE glaq_t.glaq021, #收付款客商
       glaq022 LIKE glaq_t.glaq022, #帳款客戶
       glaq023 LIKE glaq_t.glaq023, #客群
       glaq024 LIKE glaq_t.glaq024, #產品類別
       glaq025 LIKE glaq_t.glaq025, #人員
       glaq026 LIKE glaq_t.glaq026, #no use
       glaq027 LIKE glaq_t.glaq027, #專案編號
       glaq028 LIKE glaq_t.glaq028, #WBS
       glaq029 LIKE glaq_t.glaq029, #自由核算項一
       glaq030 LIKE glaq_t.glaq030, #自由核算項二
       glaq031 LIKE glaq_t.glaq031, #自由核算項三
       glaq032 LIKE glaq_t.glaq032, #自由核算項四
       glaq033 LIKE glaq_t.glaq033, #自由核算項五
       glaq034 LIKE glaq_t.glaq034, #自由核算項六
       glaq035 LIKE glaq_t.glaq035, #自由核算項七
       glaq036 LIKE glaq_t.glaq036, #自由核算項八
       glaq037 LIKE glaq_t.glaq037, #自由核算項九
       glaq038 LIKE glaq_t.glaq038, #自由核算項十
       glaq039 LIKE glaq_t.glaq039, #匯率(本位幣二)
       glaq040 LIKE glaq_t.glaq040, #借方金額(本位幣二)
       glaq041 LIKE glaq_t.glaq041, #貸方金額(本位幣二)
       glaq042 LIKE glaq_t.glaq042, #匯率(本位幣三)
       glaq043 LIKE glaq_t.glaq043, #借方金額(本位幣三)
       glaq044 LIKE glaq_t.glaq044, #貸方金額(本位幣三)
       glaq051 LIKE glaq_t.glaq051, #經營方式
       glaq052 LIKE glaq_t.glaq052, #通路
       glaq053 LIKE glaq_t.glaq053, #品牌
       glaqud001 LIKE glaq_t.glaqud001, #自定義欄位(文字)001
       glaqud002 LIKE glaq_t.glaqud002, #自定義欄位(文字)002
       glaqud003 LIKE glaq_t.glaqud003, #自定義欄位(文字)003
       glaqud004 LIKE glaq_t.glaqud004, #自定義欄位(文字)004
       glaqud005 LIKE glaq_t.glaqud005, #自定義欄位(文字)005
       glaqud006 LIKE glaq_t.glaqud006, #自定義欄位(文字)006
       glaqud007 LIKE glaq_t.glaqud007, #自定義欄位(文字)007
       glaqud008 LIKE glaq_t.glaqud008, #自定義欄位(文字)008
       glaqud009 LIKE glaq_t.glaqud009, #自定義欄位(文字)009
       glaqud010 LIKE glaq_t.glaqud010, #自定義欄位(文字)010
       glaqud011 LIKE glaq_t.glaqud011, #自定義欄位(數字)011
       glaqud012 LIKE glaq_t.glaqud012, #自定義欄位(數字)012
       glaqud013 LIKE glaq_t.glaqud013, #自定義欄位(數字)013
       glaqud014 LIKE glaq_t.glaqud014, #自定義欄位(數字)014
       glaqud015 LIKE glaq_t.glaqud015, #自定義欄位(數字)015
       glaqud016 LIKE glaq_t.glaqud016, #自定義欄位(數字)016
       glaqud017 LIKE glaq_t.glaqud017, #自定義欄位(數字)017
       glaqud018 LIKE glaq_t.glaqud018, #自定義欄位(數字)018
       glaqud019 LIKE glaq_t.glaqud019, #自定義欄位(數字)019
       glaqud020 LIKE glaq_t.glaqud020, #自定義欄位(數字)020
       glaqud021 LIKE glaq_t.glaqud021, #自定義欄位(日期時間)021
       glaqud022 LIKE glaq_t.glaqud022, #自定義欄位(日期時間)022
       glaqud023 LIKE glaq_t.glaqud023, #自定義欄位(日期時間)023
       glaqud024 LIKE glaq_t.glaqud024, #自定義欄位(日期時間)024
       glaqud025 LIKE glaq_t.glaqud025, #自定義欄位(日期時間)025
       glaqud026 LIKE glaq_t.glaqud026, #自定義欄位(日期時間)026
       glaqud027 LIKE glaq_t.glaqud027, #自定義欄位(日期時間)027
       glaqud028 LIKE glaq_t.glaqud028, #自定義欄位(日期時間)028
       glaqud029 LIKE glaq_t.glaqud029, #自定義欄位(日期時間)029
       glaqud030 LIKE glaq_t.glaqud030  #自定義欄位(日期時間)030
       END RECORD
   #161128-00061#7---add---end-----------
DEFINE l_xrca039           LIKE xrca_t.xrca039
DEFINE l_last_xrcadocno    LIKE xrca_t.xrcadocno
DEFINE l_foreign           LIKE type_t.chr1
DEFINE l_glaa001           LIKE glaa_t.glaa001
DEFINE l_glap010           LIKE glap_t.glap010
DEFINE l_glap011           LIKE glap_t.glap011
DEFINE l_glad_r            RECORD 
       glad005             LIKE glad_t.glad005,  #数量/金额管理否
       glad007             LIKE glad_t.glad007,  #部门管理否
       glad008             LIKE glad_t.glad008,  #利润成本管理否
       glad009             LIKE glad_t.glad009,  #区域管理否
       glad010             LIKE glad_t.glad010,  #交易客商管理否
       glad011             LIKE glad_t.glad011,  #客群管理否
       glad012             LIKE glad_t.glad012,  #产品类别管理否
       glad013             LIKE glad_t.glad013,  #人员管理否
       glad015             LIKE glad_t.glad015,  #专案管理否
       glad016             LIKE glad_t.glad016,  #WBS管理否
       glad017             LIKE glad_t.glad017,  #自由核算项1管理否
       glad018             LIKE glad_t.glad018,  #自由核算项2管理否
       glad019             LIKE glad_t.glad019,  #自由核算项3管理否
       glad020             LIKE glad_t.glad020,  #自由核算项4管理否
       glad021             LIKE glad_t.glad021,  #自由核算项5管理否
       glad022             LIKE glad_t.glad022,  #自由核算项6管理否
       glad023             LIKE glad_t.glad023,  #自由核算项7管理否
       glad024             LIKE glad_t.glad024,  #自由核算项8管理否
       glad025             LIKE glad_t.glad025,  #自由核算项9管理否
       glad026             LIKE glad_t.glad026,  #自由核算项10管理否    
       glad027             LIKE glad_t.glad027,  #账款客商管理否
       glad031             LIKE glad_t.glad031,  #經營方式管理否
       glad032             LIKE glad_t.glad032,  #渠道管理否
       glad033             LIKE glad_t.glad033   #品牌管理否
                           END RECORD
DEFINE l_tmp               RECORD 
       docno               LIKE glaq_t.glaqdocno,
       docdt               LIKE glap_t.glapdocdt,
       sw                  LIKE type_t.chr1,       #1.借  2.贷
       glaqent             LIKE glaq_t.glaqent,  
       glaqcomp            LIKE glaq_t.glaqcomp, 
       glaqld              LIKE glaq_t.glaqld,   
       glaq001             LIKE glaq_t.glaq001,  
       glaq002             LIKE glaq_t.glaq002,  
       glaq005             LIKE glaq_t.glaq005,  
       glaq006             LIKE glaq_t.glaq006,  
       glaq007             LIKE glaq_t.glaq007,  
       glaq009             LIKE glaq_t.glaq009,
       glaq010             LIKE glaq_t.glaq010,                              
       glaq011             LIKE glaq_t.glaq011,  
       glaq012             LIKE glaq_t.glaq012,  
       glaq013             LIKE glaq_t.glaq013,  
       glaq014             LIKE glaq_t.glaq014,  
       glaq015             LIKE glaq_t.glaq015,  
       glaq016             LIKE glaq_t.glaq016,  
       glaq017             LIKE glaq_t.glaq017,  
       glaq018             LIKE glaq_t.glaq018,  
       glaq019             LIKE glaq_t.glaq019,  
       glaq020             LIKE glaq_t.glaq020,  
       glaq021             LIKE glaq_t.glaq021,  
       glaq022             LIKE glaq_t.glaq022,  
       glaq023             LIKE glaq_t.glaq023,  
       glaq024             LIKE glaq_t.glaq024,  
       glaq025             LIKE glaq_t.glaq025,  
       glaq027             LIKE glaq_t.glaq027,  
       glaq028             LIKE glaq_t.glaq028, 
       glaq051             LIKE glaq_t.glaq051,  #經營方式
       glaq052             LIKE glaq_t.glaq052,  #渠道 
       glaq053             LIKE glaq_t.glaq053,  #品牌
       glaq029             LIKE glaq_t.glaq029,  
       glaq030             LIKE glaq_t.glaq030,  
       glaq031             LIKE glaq_t.glaq031,  
       glaq032             LIKE glaq_t.glaq032,  
       glaq033             LIKE glaq_t.glaq033,  
       glaq034             LIKE glaq_t.glaq034,  
       glaq035             LIKE glaq_t.glaq035,  
       glaq036             LIKE glaq_t.glaq036,  
       glaq037             LIKE glaq_t.glaq037,  
       glaq038             LIKE glaq_t.glaq038,   
       d                   LIKE glaq_t.glaq003,  
       c                   LIKE glaq_t.glaq004,  
       qty                 LIKE glaq_t.glaq008,  
       sum                 LIKE glaq_t.glaq010,
       glaq039             LIKE glaq_t.glaq039,
       glaq040             LIKE glaq_t.glaq040,
       glaq041             LIKE glaq_t.glaq041,
       glaq042             LIKE glaq_t.glaq042,
       glaq043             LIKE glaq_t.glaq043,
       glaq044             LIKE glaq_t.glaq044,
       seq                 LIKE glaq_t.glaqseq,
       source              LIKE type_t.chr100,
       glaqseq             LIKE glaq_t.glaqseq,
       glgb055             LIKE glgb_t.glgb055  #現金變動碼 
                           END RECORD
                              
   WHENEVER ERROR CONTINUE
   LET r_success = FALSE
   
   SELECT glaa001 INTO l_glaa001 FROM glaa_t WHERE glaaent = g_enterprise AND glaald = p_glaqld
   
   LET l_xrca039 = 0  #附件张数
   LET l_foreign = 'N' #外币凭证否
   
   INITIALIZE l_tmp.* TO NULL
   LET l_last_xrcadocno = NULL
   FOREACH s_voucher_gen_ar_5_cs6 INTO l_tmp.*
      IF SQLCA.sqlcode THEN  
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 's_voucher_gen_ar_5_cs6'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      END IF   
      INITIALIZE l_glaq.* TO NULL
      
      #汇总 附件张数 & update 来源单据的"抛转凭证单号"
      IF cl_null(l_last_xrcadocno) OR l_last_xrcadocno <> l_tmp.docno THEN
         EXECUTE s_voucher_gen_ar_5_p7 USING p_glapdocno,l_tmp.docno    
         IF SQLCA.sqlcode THEN  
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = 's_voucher_gen_ar_5_p7'
            LET g_errparam.popup = TRUE
            CALL cl_err()

            RETURN r_success
         END IF         
      END IF
      IF l_foreign = 'N' THEN
         IF l_tmp.glaq005 <> l_glaa001 THEN
            LET l_foreign = 'Y'
         END IF
      END IF
      
      LET l_glaq.glaqent   = l_tmp.glaqent    #企業代碼
      LET l_glaq.glaqcomp  = l_tmp.glaqcomp   #法人
      LET l_glaq.glaqld    = p_glaqld         #帳別
      LET l_glaq.glaqdocno = p_glapdocno      #單號
      #项次
      SELECT MAX(glaqseq) + 1 INTO l_glaq.glaqseq
        FROM glaq_t
       WHERE glaqent   = l_glaq.glaqent
         AND glaqld    = l_glaq.glaqld
         AND glaqdocno = l_glaq.glaqdocno
      IF cl_null(l_glaq.glaqseq) THEN
         LET l_glaq.glaqseq = 1
      END IF
      LET l_glaq.glaq001   = l_tmp.glaq001    #摘要
      LET l_glaq.glaq002   = l_tmp.glaq002    #科目編號
      LET l_glaq.glaq003   = l_tmp.d          #借方金額
      LET l_glaq.glaq004   = l_tmp.c          #貸方金額
      LET l_glaq.glaq005   = l_tmp.glaq005    #交易幣別
      LET l_glaq.glaq006   = l_tmp.glaq006    #匯率
      LET l_glaq.glaq007   = l_tmp.glaq007    #計價單位
      LET l_glaq.glaq008   = l_tmp.qty        #數量
      LET l_glaq.glaq009   = l_tmp.glaq009    #單價
      LET l_glaq.glaq010   = l_tmp.sum        #原幣金額
      LET l_glaq.glaq011   = l_tmp.glaq011    #票據編碼
      LET l_glaq.glaq012   = l_tmp.glaq012    #票據日期
      LET l_glaq.glaq013   = l_tmp.glaq013    #申請人
      LET l_glaq.glaq014   = l_tmp.glaq014    #銀行帳號
      LET l_glaq.glaq015   = l_tmp.glaq015    #結算方式
      LET l_glaq.glaq016   = l_tmp.glaq016    #收支項目
      LET l_glaq.glaq017   = l_tmp.glaq017    #營運據點
      LET l_glaq.glaq018   = l_tmp.glaq018    #部門
      LET l_glaq.glaq019   = l_tmp.glaq019    #利潤/成本中心
      LET l_glaq.glaq020   = l_tmp.glaq020    #區域
      LET l_glaq.glaq021   = l_tmp.glaq021    #交易客商      
      LET l_glaq.glaq022   = l_tmp.glaq022    #账款客商      
      LET l_glaq.glaq023   = l_tmp.glaq023    #客群
      LET l_glaq.glaq024   = l_tmp.glaq024    #產品類別
      LET l_glaq.glaq025   = l_tmp.glaq025    #人員
      LET l_glaq.glaq027   = l_tmp.glaq027    #專案編號
      LET l_glaq.glaq028   = l_tmp.glaq028    #WBS
      LET l_glaq.glaq029   = l_tmp.glaq029    #自由核算項一
      LET l_glaq.glaq030   = l_tmp.glaq030    #自由核算項二
      LET l_glaq.glaq031   = l_tmp.glaq031    #自由核算項三
      LET l_glaq.glaq032   = l_tmp.glaq032    #自由核算項四
      LET l_glaq.glaq033   = l_tmp.glaq033    #自由核算項五
      LET l_glaq.glaq034   = l_tmp.glaq034    #自由核算項六
      LET l_glaq.glaq035   = l_tmp.glaq035    #自由核算項七
      LET l_glaq.glaq036   = l_tmp.glaq036    #自由核算項八
      LET l_glaq.glaq037   = l_tmp.glaq037    #自由核算項九
      LET l_glaq.glaq038   = l_tmp.glaq038    #自由核算項十
      
      LET l_glaq.glaq039   = l_tmp.glaq039
      LET l_glaq.glaq040   = l_tmp.glaq040
      LET l_glaq.glaq041   = l_tmp.glaq041
      LET l_glaq.glaq042   = l_tmp.glaq042
      LET l_glaq.glaq043   = l_tmp.glaq043
      LET l_glaq.glaq044   = l_tmp.glaq044
      LET l_glaq.glaq051   = l_tmp.glaq051   #經營方式
      LET l_glaq.glaq052   = l_tmp.glaq052   #渠道
      LET l_glaq.glaq053   = l_tmp.glaq053   #品牌

      #170322-00036#1 add s--- 
      #核算项如果没值,给个空格 
      IF l_glaq.glaq018 IS NULL THEN LET l_glaq.glaq018 = ' ' END IF
      IF l_glaq.glaq019 IS NULL THEN LET l_glaq.glaq019 = ' ' END IF
      IF l_glaq.glaq020 IS NULL THEN LET l_glaq.glaq020 = ' ' END IF
      IF l_glaq.glaq021 IS NULL THEN LET l_glaq.glaq021 = ' ' END IF
      IF l_glaq.glaq022 IS NULL THEN LET l_glaq.glaq022 = ' ' END IF
      IF l_glaq.glaq023 IS NULL THEN LET l_glaq.glaq023 = ' ' END IF
      IF l_glaq.glaq024 IS NULL THEN LET l_glaq.glaq024 = ' ' END IF
      IF l_glaq.glaq025 IS NULL THEN LET l_glaq.glaq025 = ' ' END IF
      IF l_glaq.glaq027 IS NULL THEN LET l_glaq.glaq027 = ' ' END IF
      IF l_glaq.glaq028 IS NULL THEN LET l_glaq.glaq028 = ' ' END IF
      IF l_glaq.glaq051 IS NULL THEN LET l_glaq.glaq051 = ' ' END IF
      IF l_glaq.glaq052 IS NULL THEN LET l_glaq.glaq052 = ' ' END IF
      IF l_glaq.glaq053 IS NULL THEN LET l_glaq.glaq053 = ' ' END IF
      IF l_glaq.glaq029 IS NULL THEN LET l_glaq.glaq029 = ' ' END IF
      IF l_glaq.glaq030 IS NULL THEN LET l_glaq.glaq030 = ' ' END IF
      IF l_glaq.glaq031 IS NULL THEN LET l_glaq.glaq031 = ' ' END IF
      IF l_glaq.glaq032 IS NULL THEN LET l_glaq.glaq032 = ' ' END IF
      IF l_glaq.glaq033 IS NULL THEN LET l_glaq.glaq033 = ' ' END IF
      IF l_glaq.glaq034 IS NULL THEN LET l_glaq.glaq034 = ' ' END IF
      IF l_glaq.glaq035 IS NULL THEN LET l_glaq.glaq035 = ' ' END IF
      IF l_glaq.glaq036 IS NULL THEN LET l_glaq.glaq036 = ' ' END IF
      IF l_glaq.glaq037 IS NULL THEN LET l_glaq.glaq037 = ' ' END IF
      IF l_glaq.glaq038 IS NULL THEN LET l_glaq.glaq038 = ' ' END IF
      #170322-00036#1 add e--- 
      
      #161128-00061#7---add---begin-----------
      #INSERT INTO glaq_t VALUES(l_glaq.*)
      INSERT INTO glaq_t (glaqent,glaqcomp,glaqld,glaqdocno,glaqseq,glaq001,glaq002,glaq003,glaq004,glaq005,
                          glaq006,glaq007,glaq008,glaq009,glaq010,glaq011,glaq012,glaq013,glaq014,glaq015,
                          glaq016,glaq017,glaq018,glaq019,glaq020,glaq021,glaq022,glaq023,glaq024,glaq025,
                          glaq026,glaq027,glaq028,glaq029,glaq030,glaq031,glaq032,glaq033,glaq034,glaq035,
                          glaq036,glaq037,glaq038,glaq039,glaq040,glaq041,glaq042,glaq043,glaq044,glaq051,
                          glaq052,glaq053,glaqud001,glaqud002,glaqud003,glaqud004,glaqud005,glaqud006,
                          glaqud007,glaqud008,glaqud009,glaqud010,glaqud011,glaqud012,glaqud013,glaqud014,
                          glaqud015,glaqud016,glaqud017,glaqud018,glaqud019,glaqud020,glaqud021,glaqud022,
                          glaqud023,glaqud024,glaqud025,glaqud026,glaqud027,glaqud028,glaqud029,glaqud030)
       VALUES(l_glaq.glaqent,l_glaq.glaqcomp,l_glaq.glaqld,l_glaq.glaqdocno,l_glaq.glaqseq,l_glaq.glaq001,l_glaq.glaq002,l_glaq.glaq003,l_glaq.glaq004,l_glaq.glaq005,
              l_glaq.glaq006,l_glaq.glaq007,l_glaq.glaq008,l_glaq.glaq009,l_glaq.glaq010,l_glaq.glaq011,l_glaq.glaq012,l_glaq.glaq013,l_glaq.glaq014,l_glaq.glaq015,
              l_glaq.glaq016,l_glaq.glaq017,l_glaq.glaq018,l_glaq.glaq019,l_glaq.glaq020,l_glaq.glaq021,l_glaq.glaq022,l_glaq.glaq023,l_glaq.glaq024,l_glaq.glaq025,
              l_glaq.glaq026,l_glaq.glaq027,l_glaq.glaq028,l_glaq.glaq029,l_glaq.glaq030,l_glaq.glaq031,l_glaq.glaq032,l_glaq.glaq033,l_glaq.glaq034,l_glaq.glaq035,
              l_glaq.glaq036,l_glaq.glaq037,l_glaq.glaq038,l_glaq.glaq039,l_glaq.glaq040,l_glaq.glaq041,l_glaq.glaq042,l_glaq.glaq043,l_glaq.glaq044,l_glaq.glaq051,
              l_glaq.glaq052,l_glaq.glaq053,l_glaq.glaqud001,l_glaq.glaqud002,l_glaq.glaqud003,l_glaq.glaqud004,l_glaq.glaqud005,l_glaq.glaqud006,
              l_glaq.glaqud007,l_glaq.glaqud008,l_glaq.glaqud009,l_glaq.glaqud010,l_glaq.glaqud011,l_glaq.glaqud012,l_glaq.glaqud013,l_glaq.glaqud014,
              l_glaq.glaqud015,l_glaq.glaqud016,l_glaq.glaqud017,l_glaq.glaqud018,l_glaq.glaqud019,l_glaq.glaqud020,l_glaq.glaqud021,l_glaq.glaqud022,
              l_glaq.glaqud023,l_glaq.glaqud024,l_glaq.glaqud025,l_glaq.glaqud026,l_glaq.glaqud027,l_glaq.glaqud028,l_glaq.glaqud029,l_glaq.glaqud030)
      #161128-00061#7---add---end-----------
      IF SQLCA.sqlcode THEN      
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'ins glaq'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF
   END FOREACH
   
   #一笔凭证处理完毕后,对凭证单头进行更行
   #总借/贷
   SELECT SUM(glaq003),SUM(glaq004) INTO l_glap010,l_glap011
     FROM glaq_t
    WHERE glaqent   = g_enterprise
      AND glaqld    = p_glaqld
      AND glaqdocno = p_glapdocno
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'sel glaq'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   IF cl_null(l_glap010) THEN LET l_glap010 = 0 END IF
   IF cl_null(l_glap011) THEN LET l_glap011 = 0 END IF
   
   UPDATE glap_t SET glap010 = l_glap010,glap011 = l_glap011,glap014 = l_foreign
    WHERE glapent   = g_enterprise
      AND glapld    = p_glaqld
      AND glapdocno = p_glapdocno
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'upd glap_t'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 返回抓取agli060中维护的核算项值的sql语句
# Memo...........: #160729-00009#1 add
# Usage..........: CALL s_voucher_get_glak_sql(p_glakld,p_glak001,p_glak003)
#                  RETURNING r_sql
# Input parameter: p_glakld       账套
#                : p_glak001      核算项类型
#                : p_glak003      科目编号
# Return code....: r_sql          抓取核算项值的sql语句
# Date & Author..: 2016/09/28 By 02599
# Modify.........: #161221-00054#1 傳入的p_glak003改傳入多個p_wc
################################################################################
PUBLIC FUNCTION s_voucher_get_glak_sql(p_glakld,p_glak001,p_wc)
   DEFINE p_glakld        LIKE glak_t.glakld
   DEFINE p_glak001       LIKE glak_t.glak001
   #DEFINE p_glak003       LIKE glak_t.glak003 #161221-00054#1 mark
   DEFINE p_wc            STRING               #161221-00054#1
   DEFINE l_sql           STRING               #161221-00054#1
   DEFINE r_sql           STRING
   DEFINE l_glak002       LIKE glak_t.glak002
   
   LET r_sql = ' 1=1'
   #170816-00007#130 by 09773 mod(S)
   #(1).传入参数为空，返回' 1=1'
   #IF cl_null(p_glakld) OR cl_null(p_glak001) OR cl_null(p_glak003) THEN #161221-00054#1 mark
#   IF cl_null(p_glakld) OR cl_null(p_glak001) OR cl_null(p_wc) THEN       #161221-00054#1
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.extend = ''
#      LET g_errparam.code   = 'sub-00110'
#      LET g_errparam.popup  = TRUE 
#      CALL cl_err()
#      RETURN r_sql
#   END IF
   #170816-00007#130 by 09773 mod(E)
   
   #170816-00007#130 by 09773 add(S)
   #修改錯誤訊息報錯內容
   LET g_msg = ''
   LET g_colname_1 = ''
   LET g_comment_1 = ''
   IF cl_null(p_glakld) THEN
      CALL s_azzi902_get_gzzd("aapi511","lbl_glabld") RETURNING g_colname_1,g_comment_1  #賬套 
      LET g_msg = g_colname_1   
   END IF
   IF cl_null(p_glak001) THEN
      LET g_colname_1 = ''
      LET g_comment_1 = ''    
      CALL s_azzi902_get_gzzd("aglq850","lbl_fix_type") RETURNING g_colname_1,g_comment_1   #核算項類型
      IF g_msg IS NULL THEN   
         LET g_msg = g_colname_1   
      ELSE   
         LET g_msg = g_msg,",",g_colname_1
      END IF        
   END IF
   IF cl_null(p_wc) THEN
      LET g_colname_1 = ''
      LET g_comment_1 = ''    
      CALL s_azzi902_get_gzzd("abgq054","lbl_l_bgbc007") RETURNING g_colname_1,g_comment_1   #科目編號
      IF g_msg IS NULL THEN   
         LET g_msg = g_colname_1   
      ELSE   
         LET g_msg = g_msg,",",g_colname_1
      END IF        
   END IF
   IF NOT cl_null(g_msg) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = ''
      LET g_errparam.code = 'sub-00788'  #%1傳入值為空(錯誤)
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_msg 
      CALL cl_err()
      RETURN r_sql
   END IF   
   #170816-00007#130 by 09773 add(S)
   
   #(2)判断agli060中是否维护核算项资料,如果维护,组合抓取核算项值的sql语句,如果没有维护,返回' 1=1'
   LET l_glak002=''
   #161221-00054#1 mark ------
   #SELECT DISTINCT glak002 INTO l_glak002 FROM glak_t
   # WHERE glakent=g_enterprise AND glakld=p_glakld
   #   AND glak001=p_glak001 AND glak003=p_glak003
   #161221-00054#1 mark end---
   #161221-00054#1 add ------
   LET l_sql = "SELECT DISTINCT glak002 ",
               "  FROM glak_t",
               " WHERE glakent = ",g_enterprise,
               "   AND glakld = '",p_glakld,"'",
               "   AND glak001 = '",p_glak001,"'",
               "   AND glak003 IN ",p_wc
   PREPARE glak_pb1 FROM l_sql
   EXECUTE glak_pb1 INTO l_glak002
   #161221-00054#1 add end---
   IF sqlca.sqlcode=100 THEN
      RETURN r_sql
   END IF
   
   #正向（允许）
   IF l_glak002='1' THEN
      LET r_sql = " IN "
   END IF
   #反向（拒绝）
   IF l_glak002='2' THEN
      LET r_sql = " NOT IN "
   END IF
   LET r_sql = r_sql," (SELECT glak004 FROM glak_t ",
                     "   WHERE glakent=",g_enterprise," AND glakld='",p_glakld,"'",
                    #"     AND glak001='",p_glak001,"' AND glak003='",p_glak003,"'", #161221-00054#1 mark
                     "     AND glak001='",p_glak001,"' AND glak003 IN ",p_wc,        #161221-00054#1
                     " )"
   CASE p_glak001
      WHEN '01' #營運據點
         LET r_sql=" ooef001 ",r_sql
      WHEN '02' #部門管理
         LET r_sql=" ooeg001 ",r_sql
      WHEN '03' #利潤成本管理
         LET r_sql=" ooeg001 ",r_sql
      WHEN '04' #區域管理
         LET r_sql=" oocq002 ",r_sql
      WHEN '05' #收付款客商
         LET r_sql=" pmaa001 ",r_sql
      WHEN '06' #帳款客商
         LET r_sql=" pmaa001 ",r_sql
      WHEN '07' #客群管理
         LET r_sql=" oocq002 ",r_sql
      WHEN '08' #產品類別管理
         LET r_sql=" rtax001 ",r_sql
      WHEN '09' #經營方式管理
         LET r_sql=" gzcb002 ",r_sql
      WHEN '10' #通路管理
         LET r_sql=" oojd001 ",r_sql
      WHEN '11' #品牌管理
         LET r_sql=" oocq002 ",r_sql
      WHEN '12' #人員管理
         LET r_sql=" ooag001 ",r_sql
      WHEN '13' #專案管理
         #LET r_sql=" pjba001 ",r_sql #170330-00057#3 mark
         LET r_sql=" pjab001 ",r_sql  #170330-00057#3 add
      WHEN '14' #WBS管理
         LET r_sql=" pjbb002 ",r_sql
   END CASE
   
   RETURN r_sql
END FUNCTION

################################################################################
# Descriptions...: 检核核算项值是否满足agli060限制条件
# Memo...........: #160729-00009#1 add
# Usage..........: CALL s_voucher_hsx_glak_chk(p_glakld,p_glak001,p_glak003,p_glak004)
#                  RETURNING r_success
# Input parameter: p_glakld       账套
#                : p_glak001      核算项类型
#                : p_glak003      科目
#                : p_glak004      核算项值
# Return code....: r_success      检查结果TRUE/FALSE
# Date & Author..: 2016/09/28 By 02599
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_hsx_glak_chk(p_glakld,p_glak001,p_glak003,p_glak004)
   DEFINE p_glakld        LIKE glak_t.glakld
   DEFINE p_glak001       LIKE glak_t.glak001
   DEFINE p_glak003       LIKE glak_t.glak003
   DEFINE p_glak004       LIKE glak_t.glak004
   DEFINE r_success       LIKE type_t.num5
   DEFINE l_glak002       LIKE glak_t.glak002
   DEFINE l_cnt           LIKE type_t.num5
   
   #核算项开窗检核增加agli060相关联判断，当agli060中有维护核算项资料时，
   #如果是正向(允许)，核算项只可以抓取agli060中维护的值；如果是反向(拒绝)，核算项不可以抓取agli060中维护的值；
   #如果没有维护agli060中的值，就按照原逻辑      
   LET r_success=TRUE
   LET g_errno=''
   LET l_glak002 = ''
   SELECT DISTINCT glak002 INTO l_glak002 FROM glak_t
    WHERE glakent=g_enterprise AND glakld=p_glakld
      AND glak001=p_glak001 AND glak003=p_glak003
   IF NOT cl_null(l_glak002) THEN
      LET l_cnt = 0
      #SELECT COUNT(*) INTO l_cnt FROM glak_t     #170615-00061#25 mark
      SELECT COUNT(glakld) INTO l_cnt FROM glak_t #170615-00061#25 add
       WHERE glakent=g_enterprise AND glakld=p_glakld
         AND glak001=p_glak001 AND glak003=p_glak003
         AND glak004=p_glak004
      IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
      #正向（允许）
      IF l_glak002='1' THEN
         #正向(允许)，核算项只可以抓取agli060中维护的值
         IF l_cnt = 0 THEN
            CASE p_glak001
               WHEN '01' #營運據點
                  LET g_errno='agl-00507'
               WHEN '02' #部門管理
                  LET g_errno='agl-00509'
               WHEN '03' #利潤成本管理
                  LET g_errno='agl-00511'
               WHEN '04' #區域管理
                  LET g_errno='agl-00513'
               WHEN '05' #收付款客商
                  LET g_errno='agl-00515'
               WHEN '06' #帳款客商
                  LET g_errno='agl-00517'
               WHEN '07' #客群管理
                  LET g_errno='agl-00519'
               WHEN '08' #產品類別管理
                  LET g_errno='agl-00521'
               WHEN '09' #經營方式管理
                  LET g_errno='agl-00523'
               WHEN '10' #通路管理
                  LET g_errno='agl-00525'
               WHEN '11' #品牌管理
                  LET g_errno='agl-00527'
               WHEN '12' #人員管理
                  LET g_errno='agl-00529'
               WHEN '13' #專案管理
                  LET g_errno='agl-00531'
               WHEN '14' #WBS管理
                  LET g_errno='agl-00533'
            END CASE            
         END IF
      ELSE
         #反向(拒绝)，核算项不可以抓取agli060中维护的值
         IF l_cnt > 0 THEN
            CASE p_glak001
               WHEN '01' #營運據點
                  LET g_errno='agl-00508'
               WHEN '02' #部門管理
                  LET g_errno='agl-00510'
               WHEN '03' #利潤成本管理
                  LET g_errno='agl-00512'
               WHEN '04' #區域管理
                  LET g_errno='agl-00514'
               WHEN '05' #收付款客商
                  LET g_errno='agl-00516'
               WHEN '06' #帳款客商
                  LET g_errno='agl-00518'
               WHEN '07' #客群管理
                  LET g_errno='agl-00520'
               WHEN '08' #產品類別管理
                  LET g_errno='agl-00522'
               WHEN '09' #經營方式管理
                  LET g_errno='agl-00524'
               WHEN '10' #通路管理
                  LET g_errno='agl-00526'
               WHEN '11' #品牌管理
                  LET g_errno='agl-00528'
               WHEN '12' #人員管理
                  LET g_errno='agl-00530'
               WHEN '13' #專案管理
                  LET g_errno='agl-00532'
               WHEN '14' #WBS管理
                  LET g_errno='agl-00534'
            END CASE
         END IF
      END IF
   END IF
   
   IF NOT cl_null(g_errno) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = g_errno
      LET g_errparam.extend = p_glak004
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = p_glak003 #161221-00054#1
      #170613-00041#1--add--str--lujh
      IF NOT cl_null(g_seq) AND g_seq <> 0 THEN 
         LET g_errparam.coll_vals[1] = g_seq
      END IF
      #170613-00041#1--add--end--lujh
      CALL cl_err()
      LET r_success=FALSE
   END IF
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 对14个固定核算项进行检核是否满足agli060的设限条件
# Memo...........: #160729-00009#1 add
# Usage..........: CALL s_voucher_all_hsx_chk(p_ld,p_account,p_hsx)
#                  RETURNING r_success
# Input parameter: p_ld           账套
#                : p_account      科目
#                : p_hsx          14个固定核算项组成的数组
# Return code....: r_success      检查结果TRUE/FALSE
# Date & Author..: 2016/9/28 By 02599
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_all_hsx_chk(p_ld,p_account,p_hsx)
   DEFINE p_ld          LIKE glaa_t.glaald
   DEFINE p_account     LIKE glac_t.glac002
   DEFINE p_hsx         DYNAMIC ARRAY OF VARCHAR(30)
   DEFINE r_success     LIKE type_t.num5
   DEFINE l_success     LIKE type_t.num5
   DEFINE l_i           LIKE type_t.num5
   DEFINE l_glak001     LIKE glak_t.glak001
   
   LET r_success = TRUE
   FOR l_i =1 TO 14
     IF NOT cl_null(p_hsx[l_i]) THEN
        IF l_i < 10 THEN
           LET l_glak001='0',l_i USING '<<<<'
        ELSE
           LET l_glak001=l_i USING '<<<<'
        END IF
        CALL s_voucher_hsx_glak_chk(p_ld,l_glak001,p_account,p_hsx[l_i]) RETURNING l_success
        IF l_success = FALSE THEN
           LET r_success =  FALSE
        END IF
     END IF
   END FOR
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_voucher_gen_hsx_chk(p_sys,p_type,p_cate,p_ld)
#                  RETURNING l_success
# Input parameter: p_sys          模组别
#                : p_type         来源类型
#                : p_cate         类别    SCC:8035
#                : p_ld           账套
# Return code....: l_success      成功与否标示
# Date & Author..: 20170613 By lujh
# Modify.........: #170613-00041#1 add lujh
################################################################################
PUBLIC FUNCTION s_voucher_gen_hsx_chk(p_sys,p_type,p_cate,p_ld)
   DEFINE p_sys           LIKE type_t.chr10
   DEFINE p_type          LIKE type_t.chr10
   DEFINE p_cate          LIKE type_t.chr10
   DEFINE p_ld            LIKE glaa_t.glaald
   DEFINE l_sql           STRING
   DEFINE l_hsx           DYNAMIC ARRAY OF VARCHAR(30)
   DEFINE l_tmp           RECORD 
                          glaq002             LIKE glaq_t.glaq002,
                          glaq017             LIKE glaq_t.glaq017,
                          glaq018             LIKE glaq_t.glaq018,
                          glaq019             LIKE glaq_t.glaq019,
                          glaq020             LIKE glaq_t.glaq020,
                          glaq021             LIKE glaq_t.glaq021,
                          glaq022             LIKE glaq_t.glaq022,
                          glaq023             LIKE glaq_t.glaq023,
                          glaq024             LIKE glaq_t.glaq024,
                          glaq051             LIKE glaq_t.glaq051,
                          glaq052             LIKE glaq_t.glaq052,
                          glaq053             LIKE glaq_t.glaq053,
                          glaq025             LIKE glaq_t.glaq025,
                          glaq027             LIKE glaq_t.glaq027,
                          glaq028             LIKE glaq_t.glaq028,
                          seq                 LIKE type_t.num10
                          END RECORD 
   DEFINE l_success       LIKE type_t.num5
   DEFINE r_success       LIKE type_t.num5
   
   WHENEVER ERROR CONTINUE
   
   LET r_success = TRUE
   
   IF p_sys = 'NM' THEN 
      IF p_cate = 'N10' OR p_cate = 'N20' OR p_cate = 'N30' THEN   #s_vr_tmp06
         LET l_sql = "SELECT DISTINCT glaq002,glaq017,glaq018,glaq019,glaq020,",
                     "                glaq021,glaq022,glaq023,glaq024,glaq051,",
                     "                glaq052,glaq053,glaq025,glaq027,glaq028,",
                     "                seq ",
                     "  FROM s_vr_tmp06,glak_t ",
                     " WHERE glakent = ",g_enterprise,
                     "   AND glakld = '",p_ld,"'",
                     "   AND glakent = glaqent ",
                     "   AND glakld = glaqld ",
                     "   AND glak003 = glaq002 "
                     
         PREPARE s_voucher_gen_hsx_chk_pre FROM l_sql
         DECLARE s_voucher_gen_hsx_chk_cs CURSOR FOR s_voucher_gen_hsx_chk_pre     
                     
         FOREACH s_voucher_gen_hsx_chk_cs INTO l_tmp.*            
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'foreach s_voucher_gen_hsx_chk_cs'
               LET g_errparam.popup = TRUE
               CALL cl_err()
            END IF   

            LET g_seq = l_tmp.seq
                     
            LET l_hsx[1] = l_tmp.glaq017
            LET l_hsx[2] = l_tmp.glaq018
            LET l_hsx[3] = l_tmp.glaq019
            LET l_hsx[4] = l_tmp.glaq020
            LET l_hsx[5] = l_tmp.glaq021
            LET l_hsx[6] = l_tmp.glaq022
            LET l_hsx[7] = l_tmp.glaq023
            LET l_hsx[8] = l_tmp.glaq024
            LET l_hsx[9] = l_tmp.glaq051
            LET l_hsx[10]= l_tmp.glaq052
            LET l_hsx[11]= l_tmp.glaq053
            LET l_hsx[12]= l_tmp.glaq025
            LET l_hsx[13]= l_tmp.glaq027
            LET l_hsx[14]= l_tmp.glaq028  

            LET g_coll_title[1] = cl_getmsg('lib-00153',g_dlang)
                     
            CALL s_voucher_all_hsx_chk(p_ld,l_tmp.glaq002,l_hsx) RETURNING l_success         
           
            IF l_success = FALSE THEN 
               LET r_success = FALSE
            END IF
         END FOREACH             
      END IF
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: aglt370百分比检核：当科目+核算项不存在于‘金额来源科目’中，科目对应单身的百分比之和要等于100
# Memo...........: #170620-00058#1 add
# Usage..........: CALL s_voucher_glam_sum_chk(p_glalld,p_glaldocno)
#                  RETURNING r_success
# Input parameter: p_glalld       账套
#                : p_glaldocno    单号
# Return code....: r_success      检核结果TRUE/FALSE
# Date & Author..: 2017/06/23 By 02599
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_glam_sum_chk(p_glalld,p_glaldocno)
DEFINE p_glalld             LIKE glal_t.glalld
DEFINE p_glaldocno          LIKE glal_t.glaldocno
DEFINE r_success            LIKE type_t.num5
DEFINE l_glam003            LIKE glam_t.glam003
DEFINE l_glam004            LIKE glam_t.glam004
DEFINE l_sum                LIKE glam_t.glam003
DEFINE l_glam044            LIKE glam_t.glam044
DEFINE l_glam045            LIKE glam_t.glam045
DEFINE l_glam047            LIKE glam_t.glam047
DEFINE l_glam048            LIKE glam_t.glam048
DEFINE l_glaa015            LIKE glaa_t.glaa015
DEFINE l_glaa019            LIKE glaa_t.glaa019
DEFINE l_sql                STRING

   LET r_success = TRUE
   
   LET l_sql="SELECT SUM(glam003),SUM(glam004),SUM(glam044),SUM(glam045),SUM(glam047),SUM(glam048) ",
             "  FROM glam_t",
             " WHERE glament=",g_enterprise,
             "   AND glamld='",p_glalld,"'",
             "   AND glamdocno='",p_glaldocno,"'",
             "   AND NOT EXISTS(SELECT 1 FROM glan_t ",
             "                   WHERE glanent=glament AND glanld=glamld ",
             "                     AND glandocno=glamdocno",
             "                     AND glan001=glam002 AND glan003=glam007 ",
             "                     AND glan004=glam008 AND glan005=glam009 ",
             "                     AND glan006=glam010 AND glan007=glam011 ",
             "                     AND glan008=glam012 AND glan009=glam013 ",
             "                     AND glan010=glam014 AND glan011=glam015 ",
             "                     AND glan013=glam017 AND glan014=glam018 ",
             "                     AND glan051=glam051 AND glan052=glam052 ",
             "                     AND glan053=glam053 ",
             "                     AND glanent=",g_enterprise,
             "                     AND glanld='",p_glalld,"'",
             "                     AND glandocno='",p_glaldocno,"'",
             "                  ) "
   PREPARE s_voucher_glam_sum01_pr FROM l_sql
   EXECUTE s_voucher_glam_sum01_pr INTO l_glam003,l_glam004,l_glam044,l_glam045,l_glam047,l_glam048
   
   IF l_glam003 > l_glam004 THEN
      LET l_sum=l_glam003 - l_glam004
   ELSE
      LET l_sum=l_glam004 - l_glam003
   END IF
   IF l_sum <> 100 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = p_glaldocno
      LET g_errparam.code   = 'afa-00006'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      LET r_success = FALSE
   END IF
   
   SELECT glaa015,glaa019
     INTO l_glaa015,l_glaa019
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald = p_glalld
   #启用本位币二
   IF l_glaa015 = 'Y' THEN
      IF l_glam044 > l_glam045 THEN
         LET l_sum=l_glam044 - l_glam045
      ELSE
         LET l_sum=l_glam045 - l_glam044
      END IF
      IF l_sum <> 100 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = p_glaldocno
         LET g_errparam.code   = 'anm-00414'
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         LET r_success = FALSE
      END IF
   END IF
   
   #启用本位币三
   IF l_glaa019 = 'Y' THEN
      IF l_glam047 > l_glam048 THEN
         LET l_sum=l_glam047 - l_glam048
      ELSE
         LET l_sum=l_glam048 - l_glam047
      END IF
      IF l_sum <> 100 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = p_glaldocno
         LET g_errparam.code   = 'anm-00415'
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         LET r_success = FALSE
      END IF
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 判断借方金额，贷方金额，原币金额可否为负
# Memo...........:
# Usage..........: CALL s_voucher_enable_negative(p_type,p_glapld,p_glapdocno,p_glaq002)
#                  RETURNING r_success,r_enable
# Input parameter: p_type         类型 1.借方金额 2.贷方金额 3.原币金额
#                : p_glapld       账套
#                : p_glapdocno    单号
#                : p_glaq002      科目  
# Return code....: r_success      成功与否
#                : r_enable       是否允许为负，1.允许 2.不允许
# Date & Author..: 20170808 By geza
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_enable_negative(p_type,p_glapld,p_glapdocno,p_glaq002)
   DEFINE p_type              LIKE type_t.chr10
   DEFINE p_glapld            LIKE glap_t.glapld 
   DEFINE p_glapdocno         LIKE glap_t.glapdocno 
   DEFINE p_glaq002           LIKE glaq_t.glaq002
   DEFINE r_success           LIKE type_t.num5
   DEFINE r_enable            LIKE type_t.chr10
   DEFINE l_success           LIKE type_t.num5
   DEFINE l_slip              LIKE oobx_t.oobx001
   DEFINE l_red               LIKE type_t.chr10
   DEFINE l_glaa004           LIKE glaa_t.glaa004
   DEFINE l_glac008           LIKE glac_t.glac008
   DEFINE l_glad002           LIKE glad_t.glad002  
   DEFINE l_glaa024           LIKE glaa_t.glaa024
   DEFINE l_oobx003           LIKE oobx_t.oobx003
   DEFINE l_oobx003_new       LIKE oobx_t.oobx003
   WHENEVER ERROR CONTINUE
   LET r_success = TRUE
   LET r_enable = NULL
   
#   #判断传入参数是否为空
#   IF p_glapld IS NULL THEN
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.code = 'sub-00743'
#      LET g_errparam.extend = ''
#      LET g_errparam.popup = TRUE
#      CALL cl_err()
#   
#      LET r_success =FALSE
#      LET r_enable = NULL 
#      RETURN r_success,r_enable
#   END IF
#
#   #判断传入参数是否为空
#   IF p_glaq002 IS NULL THEN
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.code = 'sub-00036'
#      LET g_errparam.extend = ''
#      LET g_errparam.popup = TRUE
#      CALL cl_err()
#   
#      LET r_success =FALSE
#      LET r_enable = NULL 
#      RETURN r_success,r_enable
#   END IF
#

   #截取单别    
   CALL s_aooi200_fin_get_slip(p_glapdocno) RETURNING l_success,l_slip
   IF l_success = FALSE THEN
      LET r_success =FALSE
      LET r_enable = NULL 
      RETURN r_success,r_enable
   ELSE
      #獲取單據別對應參數：紅字傳票否
      CALL s_fin_get_doc_para(p_glapld,'',l_slip,'D-FIN-1002') RETURNING l_red  
   END IF 
   #抓取会计科目参照表
   LET l_glaa004 = ''
   LET l_glaa024 = ''
   SELECT glaa004,glaa024 INTO l_glaa004,l_glaa024
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald = p_glapld
   #截取单别性质前3码   
   LET l_oobx003 = ''
   LET l_oobx003_new = ''
   SELECT oobx003 INTO l_oobx003
     FROM oobx_t
    WHERE oobxent = g_enterprise
      AND oobx001 = l_slip  
   LET l_oobx003_new = l_oobx003[1,3]   
   #抓取agli021的正常余额形态
   LET l_glac008 = ''
   SELECT glac008 INTO l_glac008
     FROM glac_t
    WHERE glacent = g_enterprise
      AND glac002 = p_glaq002
      AND glac001 = l_glaa004
      
   #抓取agli031按余额类型生成分录
   LET l_glad002 = ''
   SELECT glad002 INTO l_glad002
     FROM glad_t
    WHERE gladent = g_enterprise
      AND gladld  = p_glapld
      AND glad001 = p_glaq002
   
   #如果单据是性质是agl那么加上单别参数,如果不是就不加上单别红字凭证参数
   IF l_oobx003_new = 'agl' THEN
      #1.根据单别参数加上agli031按余额类型生成分录和agli021的正常余额形态来判断借方和贷方金额是否可以为负
      CASE p_type
           WHEN '1'  #1.借方金额 
              IF l_red = 'Y' AND l_glad002 = 'Y' AND l_glac008 = '1' THEN
                 LET r_enable = '1'
              ELSE
                 LET r_enable = '2'
              END IF
           WHEN '2'  #2.贷方金额帳
              IF l_red = 'Y' AND l_glad002 = 'Y' AND l_glac008 = '2' THEN
                 LET r_enable = '1'
              ELSE
                 LET r_enable = '2'
              END IF
           WHEN '3'  #3.原币金额
              IF l_red = 'Y' AND l_glad002 = 'Y' THEN
                 LET r_enable = '1'
              ELSE
                 LET r_enable = '2'
              END IF
      END CASE
   ELSE
      #1.根据agli031按余额类型生成分录和agli021的正常余额形态来判断借方和贷方金额是否可以为负
      CASE p_type
           WHEN '1'  #1.借方金额 
              IF l_glad002 = 'Y' AND l_glac008 = '1' THEN
                 LET r_enable = '1'
              ELSE
                 LET r_enable = '2'
              END IF
           WHEN '2'  #2.贷方金额帳
              IF l_glad002 = 'Y' AND l_glac008 = '2' THEN
                 LET r_enable = '1'
              ELSE
                 LET r_enable = '2'
              END IF
           WHEN '3'  #3.原币金额
              IF l_glad002 = 'Y' THEN
                 LET r_enable = '1'
              ELSE
                 LET r_enable = '2'
              END IF
      END CASE
   END IF
   RETURN r_success,r_enable
END FUNCTION

################################################################################
# Descriptions...: 
# Memo...........:
# Usage..........: CALL s_voucher_ins_tmp(p_type)
# Modify.........:
################################################################################
PUBLIC FUNCTION s_voucher_ins_tmp(p_type)
   DEFINE p_type           LIKE type_t.chr1
   DEFINE l_sql            STRING
   DEFINE l_c              LIKE glaq_t.glaq004
   DEFINE l_glaq010        LIKE glaq_t.glaq010
   DEFINE l_glaq041        LIKE glaq_t.glaq041
   DEFINE l_glaq044        LIKE glaq_t.glaq044
   DEFINE l_tmp            RECORD 
                           docno    LIKE glaq_t.glaqdocno,
                           docdt    LIKE glap_t.glapdocdt,
                           sw       LIKE type_t.chr1,     
                           glaqent  LIKE glaq_t.glaqent,  
                           glaqcomp LIKE glaq_t.glaqcomp, 
                           glaqld   LIKE glaq_t.glaqld,   
                           glaq001  LIKE glaq_t.glaq001,  
                           glaq002  LIKE glaq_t.glaq002,  
                           glaq005  LIKE glaq_t.glaq005,  
                           glaq006  LIKE glaq_t.glaq006,  
                           glaq007  LIKE glaq_t.glaq007,  
                           glaq009  LIKE glaq_t.glaq009,  
                           #glaq010  LIKE glaq_t.glaq010,  #原幣金額
                           glaq011  LIKE glaq_t.glaq011,  
                           glaq012  LIKE glaq_t.glaq012,  
                           glaq013  LIKE glaq_t.glaq013,  
                           glaq014  LIKE glaq_t.glaq014,  
                           glaq015  LIKE glaq_t.glaq015,  
                           glaq016  LIKE glaq_t.glaq016,  
                           glaq017  LIKE glaq_t.glaq017,  
                           glaq018  LIKE glaq_t.glaq018,  
                           glaq019  LIKE glaq_t.glaq019,  
                           glaq020  LIKE glaq_t.glaq020,  
                           glaq021  LIKE glaq_t.glaq021,  
                           glaq022  LIKE glaq_t.glaq022,  
                           glaq023  LIKE glaq_t.glaq023,  
                           glaq024  LIKE glaq_t.glaq024,  
                           glaq025  LIKE glaq_t.glaq025,  
                           glaq027  LIKE glaq_t.glaq027,  
                           glaq028  LIKE glaq_t.glaq028,  
                           glaq051  LIKE glaq_t.glaq051,  #經營方式
                           glaq052  LIKE glaq_t.glaq052,  #渠道
                           glaq053  LIKE glaq_t.glaq053,  #品牌
                           glaq029  LIKE glaq_t.glaq029,  
                           glaq030  LIKE glaq_t.glaq030,  
                           glaq031  LIKE glaq_t.glaq031,  
                           glaq032  LIKE glaq_t.glaq032,  
                           glaq033  LIKE glaq_t.glaq033,  
                           glaq034  LIKE glaq_t.glaq034,  
                           glaq035  LIKE glaq_t.glaq035,  
                           glaq036  LIKE glaq_t.glaq036,  
                           glaq037  LIKE glaq_t.glaq037,  
                           glaq038  LIKE glaq_t.glaq038,
                           glbc004  LIKE glbc_t.glbc004,  #现金变动码                           
                           d        LIKE glaq_t.glaq003,  
                           c        LIKE glaq_t.glaq004,  
                           qty      LIKE glaq_t.glaq008,  
                           sum      LIKE glaq_t.glaq010,
                           glaq039  LIKE glaq_t.glaq039,
                           glaq040  LIKE glaq_t.glaq040,
                           glaq041  LIKE glaq_t.glaq041,
                           glaq042  LIKE glaq_t.glaq042,
                           glaq043  LIKE glaq_t.glaq043,
                           glaq044  LIKE glaq_t.glaq044,
                           seq      LIKE glaq_t.glaqseq,
                           source   LIKE type_t.chr100,
                           glaqseq  LIKE glaq_t.glaqseq,
                           xrca039  LIKE xrca_t.xrca039,
                           b_glaq021 LIKE glaq_t.glaq021,
                           b_glaq022 LIKE glaq_t.glaq022,                           
                           red      LIKE type_t.chr1                          
                           END RECORD
   
         
        DELETE FROM s_vr_tmp051
 
        IF p_type ='1' THEN 
           LET l_sql = "SELECT docno,'','',glaqent,glaqcomp,",
                       "       '',glaq001,glaq002,glaq005,glaq006,",
                       "       glaq007,glaq009,glaq011,glaq012,",
                       "       glaq013,glaq014,glaq015,glaq016,glaq017,",
                       "       glaq018,glaq019,glaq020,glaq021,glaq022,",
                       "       glaq023,glaq024,glaq025,glaq027,",
                       "       glaq028,glaq051,glaq052,glaq053,glaq029,",
                       "       glaq030,glaq031,glaq032,glaq033,glaq034,",
                       "       glaq035,glaq036,glaq037,glaq038,glbc004,SUM(d),",
                       "       SUM(c),qty,SUM(sum),glaq039,SUM(glaq040),SUM(glaq041),",
                       "       glaq042,SUM(glaq043),SUM(glaq044),'','','','','','','' ",
                       "       ,CASE WHEN d>0 THEN 1 ELSE 2 END ",
                       "  FROM s_vr_tmp05",
                       " GROUP BY CASE WHEN d>0 THEN 1 ELSE 2 END,docno,glaqent,glaqcomp,glaq001,glaq002,glaq005, glaq006,glaq007,glaq009,glaq011,",
                       "          glaq012,glaq013,glaq014,glaq015,glaq016,  glaq017,glaq018,glaq019,glaq020,glaq021,",
                       "          glaq022,glaq023,glaq024,glaq025,  glaq027,glaq028,glaq051,glaq052,glaq053,",
                       "          glaq029,glaq030,glaq031,glaq032,glaq033,  glaq034,glaq035,glaq036,glaq037,glaq038,glbc004,qty,",
                       "          glaq039,glaq042" 
        END IF   
        IF p_type ='2' THEN 
           LET l_sql = "SELECT '',docdt,'',glaqent,glaqcomp,",
                       "       '',glaq001,glaq002,glaq005,glaq006,",
                       "       glaq007,glaq009,glaq011,glaq012,",
                       "       glaq013,glaq014,glaq015,glaq016,glaq017,",
                       "       glaq018,glaq019,glaq020,glaq021,glaq022,",
                       "       glaq023,glaq024,glaq025,glaq027,",
                       "       glaq028,glaq051,glaq052,glaq053,glaq029,",
                       "       glaq030,glaq031,glaq032,glaq033,glaq034,",
                       "       glaq035,glaq036,glaq037,glaq038,glbc004,SUM(d),",
                       "       SUM(c),qty,SUM(sum),glaq039,SUM(glaq040),SUM(glaq041),",
                       "       glaq042,SUM(glaq043),SUM(glaq044),'','','','','','','' ",
                       "       ,CASE WHEN d>0 THEN 1 ELSE 2 END ",
                       "  FROM s_vr_tmp05",
                       " GROUP BY CASE WHEN d>0 THEN 1 ELSE 2 END,docdt,glaqent,glaqcomp,glaq001,glaq002,glaq005, glaq006,glaq007,glaq009,glaq011,",
                       "          glaq012,glaq013,glaq014,glaq015,glaq016,  glaq017,glaq018,glaq019,glaq020,glaq021,",
                       "          glaq022,glaq023,glaq024,glaq025,  glaq027,glaq028,glaq051,glaq052,glaq053,",
                       "          glaq029,glaq030,glaq031,glaq032,glaq033,  glaq034,glaq035,glaq036,glaq037,glaq038,glbc004,qty,",
                       "          glaq039,glaq042" 
        END IF    
        IF p_type ='3' THEN 
           LET l_sql = "SELECT '','','',glaqent,glaqcomp,",
                       "       '',glaq001,glaq002,glaq005,glaq006,",
                       "       glaq007,glaq009,glaq011,glaq012,",
                       "       glaq013,glaq014,glaq015,glaq016,glaq017,",
                       "       glaq018,glaq019,glaq020,glaq021,glaq022,",
                       "       glaq023,glaq024,glaq025,glaq027,",
                       "       glaq028,glaq051,glaq052,glaq053,glaq029,",
                       "       glaq030,glaq031,glaq032,glaq033,glaq034,",
                       "       glaq035,glaq036,glaq037,glaq038,glbc004,SUM(d),",
                       "       SUM(c),qty,SUM(sum),glaq039,SUM(glaq040),SUM(glaq041),",
                       "       glaq042,SUM(glaq043),SUM(glaq044),'','','','',b_glaq021,'','' ",
                       "       ,CASE WHEN d>0 THEN 1 ELSE 2 END ",
                       "  FROM s_vr_tmp05",
                       " GROUP BY CASE WHEN d>0 THEN 1 ELSE 2 END,glaqent,glaqcomp,glaq001,glaq002,glaq005, glaq006,glaq007,glaq009,glaq011,",
                       "          glaq012,glaq013,glaq014,glaq015,glaq016,  glaq017,glaq018,glaq019,glaq020,glaq021,",
                       "          glaq022,glaq023,glaq024,glaq025,glaq027,glaq028,glaq051,glaq052,glaq053,",
                       "          glaq029,glaq030,glaq031,glaq032,glaq033,  glaq034,glaq035,glaq036,glaq037,glaq038,glbc004,qty,",
                       "          glaq039,glaq042,b_glaq021" 
        END IF  
        IF p_type ='4' THEN 
           LET l_sql = "SELECT '',docdt,'',glaqent,glaqcomp,",
                       "       '',glaq001,glaq002,glaq005,glaq006,",
                       "       glaq007,glaq009,glaq011,glaq012,",
                       "       glaq013,glaq014,glaq015,glaq016,glaq017,",
                       "       glaq018,glaq019,glaq020,glaq021,glaq022,",
                       "       glaq023,glaq024,glaq025,glaq027,",
                       "       glaq028,glaq051,glaq052,glaq053,glaq029,",
                       "       glaq030,glaq031,glaq032,glaq033,glaq034,",
                       "       glaq035,glaq036,glaq037,glaq038,glbc004,SUM(d),",
                       "       SUM(c),qty,SUM(sum),glaq039,SUM(glaq040),SUM(glaq041),",
                       "       glaq042,SUM(glaq043),SUM(glaq044),'','','','',b_glaq021,'','' ",
                       "       ,CASE WHEN d>0 THEN 1 ELSE 2 END ",
                       "  FROM s_vr_tmp05",
                       " GROUP BY CASE WHEN d>0 THEN 1 ELSE 2 END,docdt,glaqent,glaqcomp,glaq001,glaq002,glaq005, glaq006,glaq007,glaq009,glaq011,",
                       "          glaq012,glaq013,glaq014,glaq015,glaq016,  glaq017,glaq018,glaq019,glaq020,glaq021,",
                       "          glaq022,glaq023,glaq024,glaq025,glaq027,glaq028,glaq051,glaq052,glaq053,",
                       "          glaq029,glaq030,glaq031,glaq032,glaq033,  glaq034,glaq035,glaq036,glaq037,glaq038,glbc004,qty,",
                       "          glaq039,glaq042,b_glaq021" 
        END IF   
        IF p_type ='5' THEN 
           LET l_sql = "SELECT '','','',glaqent,glaqcomp,",
                       "       '',glaq001,glaq002,glaq005,glaq006,",
                       "       glaq007,glaq009,glaq011,glaq012,",
                       "       glaq013,glaq014,glaq015,glaq016,glaq017,",
                       "       glaq018,glaq019,glaq020,glaq021,glaq022,",
                       "       glaq023,glaq024,glaq025,glaq027,",
                       "       glaq028,glaq051,glaq052,glaq053,glaq029,",
                       "       glaq030,glaq031,glaq032,glaq033,glaq034,",
                       "       glaq035,glaq036,glaq037,glaq038,glbc004,SUM(d),",
                       "       SUM(c),qty,SUM(sum),glaq039,SUM(glaq040),SUM(glaq041),",
                       "       glaq042,SUM(glaq043),SUM(glaq044),'','','','','','','' ",
                       "       ,CASE WHEN d>0 THEN 1 ELSE 2 END ",
                       "  FROM s_vr_tmp05",
                       " GROUP BY CASE WHEN d>0 THEN 1 ELSE 2 END,glaqent,glaqcomp,glaq001,glaq002,glaq005, glaq006,glaq007,glaq009,glaq011,",
                       "          glaq012,glaq013,glaq014,glaq015,glaq016,  glaq017,glaq018,glaq019,glaq020,glaq021,",
                       "          glaq022,glaq023,glaq024,glaq025,glaq027,glaq028,glaq051,glaq052,glaq053,",
                       "          glaq029,glaq030,glaq031,glaq032,glaq033,  glaq034,glaq035,glaq036,glaq037,glaq038,glbc004,qty,",
                       "          glaq039,glaq042" 
        END IF           
        PREPARE s_voucher_tmp_p FROM l_sql
        DECLARE s_voucher_tmp_c CURSOR FOR s_voucher_tmp_p

        FOREACH s_voucher_tmp_c INTO l_tmp.* 

            IF l_tmp.d = 0 AND l_tmp.c = 0 THEN
               CONTINUE FOREACH
            END IF
 
            
            #借貸都有金額則拆兩筆
            IF l_tmp.d != 0 AND l_tmp.c != 0 THEN
               LET l_c = l_tmp.c
               LET l_glaq041 = l_tmp.glaq041
               LET l_glaq044 = l_tmp.glaq044
               
               #借   
               LET l_tmp.c = 0
               LET l_tmp.glaq041 = 0
               LET l_tmp.glaq044 = 0
               LET l_tmp.sw = 1
               LET l_tmp.sum = l_tmp.d
               INSERT INTO s_vr_tmp051 VALUES(l_tmp.*)  
               #貸 
               LET l_tmp.d = 0
               LET l_tmp.glaq040 = 0
               LET l_tmp.glaq043 = 0
               LET l_tmp.c = l_c
               LET l_tmp.glaq041 = l_glaq041
               LET l_tmp.glaq044 = l_glaq044
               LET l_tmp.sw = 2
               LET l_tmp.sum = l_tmp.c
               INSERT INTO s_vr_tmp051 VALUES(l_tmp.*)              
            ELSE
               IF l_tmp.d = 0 THEN
                  LET l_tmp.sw = 2
               ELSE
                  LET l_tmp.sw = 1
               END IF
               INSERT INTO s_vr_tmp051 VALUES(l_tmp.*)  
            END IF
        END FOREACH   
END FUNCTION

 
{</section>}
 
